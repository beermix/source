diff --git a/AUTHORS b/AUTHORS
index 85309db39..e6df1dcc8 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -43,6 +43,9 @@ Alexander Serkov <serkov@ukrpost.net>
 Alessandro Rubini <rubini@ipvvis.unipv.it>
 	Mouse support.
 
+Aleš Janda <ales.janda@kyblsoft.cz>
+	Shadows of dialog windows and menus.
+
 Alexander Dong <ado@software-ag.de>
 	OS/2 port.
 
diff --git a/build-glib2.sh b/build-glib2.sh
index c1aebb3d6..6e20893e0 100755
--- a/build-glib2.sh
+++ b/build-glib2.sh
@@ -30,8 +30,8 @@
 : ${GETTEXT_VERSION=0.17}
 
 GLIB_DIR="glib-$GLIB_VERSION"
-GLIB_TARBALL="glib-$GLIB_VERSION.tar.gz"
-GLIB_URL="ftp://ftp.gnome.org/pub/gnome/sources/glib/2.30/$GLIB_TARBALL"
+GLIB_TARBALL="glib-$GLIB_VERSION.tar.bz2"
+GLIB_URL="https://download.gnome.org/sources/glib/2.30/$GLIB_TARBALL"
 
 PKGC_DIR="pkg-config-$PKGC_VERSION"
 PKGC_TARBALL="pkg-config-$PKGC_VERSION.tar.gz"
diff --git a/configure.ac b/configure.ac
index 98717e682..4f542b567 100644
--- a/configure.ac
+++ b/configure.ac
@@ -625,7 +625,9 @@ src/vfs/extfs/helpers/ucab
 src/vfs/extfs/helpers/uha
 src/vfs/extfs/helpers/ulha
 src/vfs/extfs/helpers/ulib
+src/vfs/extfs/helpers/unar
 src/vfs/extfs/helpers/urar
+src/vfs/extfs/helpers/uwim
 src/vfs/extfs/helpers/uzip
 src/vfs/extfs/helpers/uzoo
 
diff --git a/doc/FAQ b/doc/FAQ
index ae456f986..4b7b23ed0 100644
--- a/doc/FAQ
+++ b/doc/FAQ
@@ -152,12 +152,12 @@ Frequently Asked Questions
    You need a POSIX (Unix compatible) operating system.  If you are
    running Windows, use Cygwin.
 
-   To compile any edition you need to have glib 2.x  installed.
-   It's available at ftp://ftp.gtk.org/pub/gtk/.
+   To compile any edition you need to have glib >= 2.30  installed.
+   It's available at https://download.gnome.org/sources/glib/.
 
    If you want to use mouse on the Linux console you need the gpm daemon
-   from ftp://ftp.systemy.it/pub/develop/.  You need nothing extra to
-   use mouse on xterm.
+   from https://www.nico.schottelius.org/software/gpm/.  You need nothing
+   extra to use mouse on xterm.
 
    If you do not want to use the S-Lang library you could try using
    ncurses version 4.1 and above.
@@ -294,10 +294,11 @@ f2 Keyboard
 
 2.8 How do I change the key bindings?
 
-   There is no generic way to reconfigure the key bindings.  You can use
-   the "Learn Keys" dialog to assign keys to some actions listed in that
-   dialog.  However, most actions cannot be redefined to use different
-   keys.
+   Key binding con be reconfigure via keymap files: /etc/mc/mc.keymap
+   and ~/.config/mc/mc.keymap.
+
+   You can use the "Learn Keys" dialog to assign keys to some actions
+   listed in that dialog.
 
 
 3 Mouse
@@ -314,11 +315,6 @@ f2 Keyboard
 
    Hold down shift key while using mouse to cut and paste.
 
-3.3 How do I get the extension dependent pop-up menu to pop up?
-
-   It was developed for the GNOME edition.  The text-mode edition
-   doesn't support this feature yet.
-
 
 4 Display
 
@@ -340,9 +336,8 @@ f2 Keyboard
 4.2 Why don't line drawing characters work?
 
    Since version 4.0.13 there's the command line option -a to force use
-   of charaters +, |, - for line drawing (only available when compiled
-   with S-Lang).  Use the -a option if any of the suggestions below
-   doesn't help.
+   of charaters +, |, - for line drawing.  Use the -a option if any
+   of the suggestions below doesn't help.
 
    In general, there are three cases:
      * Lines are shown as ASCII characters like this
@@ -421,8 +416,6 @@ f2 Keyboard
 
 4.4 I have problems with entering/viewing national characters!
 
-   Upgrade to version 4.0.12 or newer.
-
    From the Options - Display Bits dialog select Full 8 bits or ISO
    8859-1.  In addition, select 8 bit input from the same dialog.
 
@@ -514,7 +507,7 @@ f2 Keyboard
    Thomas Dickey maintains his more advanced version of xterm at
    ftp://dickey.his.com/xterm/
 
-   rxvt has its own site http://www.rxvt.org/ - get the latest version
+   rxvt has its own site http://www.rxvt.net/ - get the latest version
    there.
 
 4.8 I got colors working with MC but the other programs don't work at
@@ -613,6 +606,36 @@ MC?
    Only few terminals support screen saving.  It's xterm, rxvt and other
    xterm-like terminals and virtual terminals on Linux and FreeBSD.
 
+6.8 Why I see lot of strange 'cd "printf ' lines into my .history file?
+
+  Add
+
+    export HISTCONTROL="ignoreboth"
+
+  into your ~/.profile file (.bash_profile) for avoid this.
+
+6.9 I have a problem with Screen which makes using Midnight Commander
+problematic. I use Ctrl-O to disable panels. Output of previous commands,
+just a clear, screen is blanked.
+
+  Update GNU Screen to the last version. This bug was fixed in
+
+   commit ad56f746c6243d45124485d198d577bdbb78071c
+   Author: Sadrul Habib Chowdhury <sadrul@users.sourceforge.net>
+   Date:   Sun Nov 29 23:34:25 2009 -0500
+
+       Fix using alternate screen buffers in some cases.
+
+       Screen would reset the 'main' screen buffer if an app tries to
+       switch to an alternate buffer while it is already using one (in
+       other words, sends multiple 'smcup' without an 'rmcup'). This should
+       fix debian #558724
+
+  (see http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=558724)
+
+  or do not rewrite TERM (mustbe TERM=screen) andrun mc as follow:
+
+   echo -e '\e[?1000h' && mc -x
 
 7 Virtual file systems
 
@@ -622,7 +645,7 @@ MC?
    press enter.  If you use mouse just double-click on the tar file.
 
    The recognized suffixes for tar archives are .tar, .tar.gz and .tgz.
-   You can also enter a tar archive by typing "cd filename#utar" where
+   You can also enter a tar archive by typing "cd filename/utar://" where
    filename is the name of the archive.  In this case, the suffix is not
    important.
 
@@ -773,7 +796,7 @@ indenting increases with each line!
    http://www.midnight-commander.org/wiki/McDevelopers
 
    This page lists everbody who has provided a patch or
-   has written code for the midnight-commander in the past:
+   has written code for the Midnight Commander in the past:
    http://www.midnight-commander.org/wiki/McContributors
 
 10.2 Do I dare to use a development version?
@@ -793,7 +816,7 @@ indenting increases with each line!
    You might first want to get the newest development version to see if
    the bug is fixed or the feature is added already.
 
-   If this is not the case, feel free to add a ticket in our ticket-system,
+   If this is not the case, feel free to add a ticket in our ticket system,
    which is located here: http://www.midnight-commander.org/newticket
 
    If you want to send an email instead write your report to mc-devel@gnome.org 
diff --git a/doc/INSTALL b/doc/INSTALL
index fe694e310..564862c33 100644
--- a/doc/INSTALL
+++ b/doc/INSTALL
@@ -20,7 +20,7 @@ Build requirements for GNU Midnight Commander
 - gettext >= 0.18.1
 - libssh2 >= 1.2.5 is required only for sftp vfs (1.2.7 if you need ssh-agent support)
 - libaspell to support spell checking in the internal editor
-- ext2fs >= 1.42.4 to suport ext{2,3,4}fs extended attributes
+- ext2fs >= 1.42.4 to support ext{2,3,4}fs extended attributes
 
 
 Installation instructions for GNU Midnight Commander
diff --git a/doc/NEWS b/doc/NEWS
index c0d32cef0..dec62b2d8 100644
--- a/doc/NEWS
+++ b/doc/NEWS
@@ -2,61 +2,61 @@ Version 4.8.25
 
 - Core
 
-  * Minimal version of GLib is 2.30.0
-  * Avoid subshell warning for standalone mcedit/mcview/mcdiffview run from mc (#4056)
-  * Implement chattr command (change ext{2,3,4}fs extended attributes). Default shortcut is "C-x e" (#3847)
-  * Implement a WGroup widget -- a base class for widgets which contain other widgets (#2919, #4075)
-  * Implement key bindings for radiobuttons (#212)
+    * Minimal version of GLib is 2.30.0
+    * Avoid subshell warning for standalone mcedit/mcview/mcdiffview run from mc (#4056)
+    * Implement chattr command (change ext{2,3,4}fs extended attributes). Default shortcut is "C-x e" (#3847)
+    * Implement a WGroup widget -- a base class for widgets which contain other widgets (#2919, #4075)
+    * Implement key bindings for radiobuttons (#212)
 
 - VFS
 
-  * RPM VFS improvements:
-    * Support weak dependency tags: ENHANCES, SUGGESTS, RECOMMENDS, SUPPLEMENTS (#4091)
+    * RPM VFS improvements:
+        - Support weak dependency tags: ENHANCES, SUGGESTS, RECOMMENDS, SUPPLEMENTS (#4091)
 
 - Editor
 
-  * Improvements of syntax highlighting:
-    * php (#4060)
-    * tcl: add shebangs with wish and tclsh (#4062)
-    * Cobol (#1987)
-    * Verilog/SystemVerilog (#4087)
-  * New syntax highlighting:
-    * Kotlin (#4088)
-    * ino (Arduino IDE and a number of other IDEs) (#4098)
+    * Improvements of syntax highlighting:
+        - php (#4060)
+        - tcl: add shebangs with wish and tclsh (#4062)
+        - Cobol (#1987)
+        - Verilog/SystemVerilog (#4087)
+    * New syntax highlighting:
+        - Kotlin (#4088)
+        - ino (Arduino IDE and a number of other IDEs) (#4098)
 
 - Misc
 
-  * Code cleanup (#4050, #4085)
-  * Add support for opus audio (#4061)
-  * mc-wrapper: don't cd to the same directory (#3355)
-  * Improve archive support: more binaries to view archive content (#4086)
-    * lha: jlha, lhasa
-    * arj: 7za
-    * cab: 7za
-    * zip; 7z
-    * zipx: 7za
-    * iso: 7za
-  * Clean up in video.sh handler (#4045)
-    * RealPlayer is a proprietary application which can't be installed in most distros and has long been abandoned.
-    * gtv hasn't been developed since 2003.
-    * xanim barely plays anything.
-  * Various fixups and updates of man page
+    * Code cleanup (#4050, #4085)
+    * Add support for opus audio (#4061)
+    * mc-wrapper: don't cd to the same directory (#3355)
+    * Improve archive support: more binaries to view archive content (#4086)
+        - lha: jlha, lhasa
+        - arj: 7za
+        - cab: 7za
+        - zip; 7z
+        - zipx: 7za
+        - iso: 7za
+    * Clean up in video.sh handler (#4045)
+        - RealPlayer is a proprietary application which can't be installed in most distros and has long been abandoned.
+        - gtv hasn't been developed since 2003.
+        - xanim barely plays anything.
+    * Various fixups and updates of man page
 
 - Fixes
 
-  * FTBFS on OSes w/o O_CLOEXEC (#4052)
-  * FTBFS with glib2 >= 2.63.3 (#4053)
-  * Undefined "__linux__" macro on non-Linux systems (#4058)
-  * Mouse is not handled with ncurses-6 (#3964)
-  * Mouse is not handled with S-Lang on some old terminal emulators (#4063)
-  * Terminal size is always 80x24 in subshell on Solaris 11.4 SPARC (#4099)
-  * Double clicking on empty area of file panel executes last item (#3722)
-  * Garbage in input line history (#4064)
-  * Speed of file copy is not displayed for single file (#4081)
-  * mcedit: blank screen with invisible error (#4057)
-  * mcedit: broken syntax highlighting for shell scripts (#4054)
-  * VFS: broken browsing of .deb packages (#4055)
-  * mc.lib installed twice (#4070)
+    * FTBFS on OSes w/o O_CLOEXEC (#4052)
+    * FTBFS with glib2 >= 2.63.3 (#4053)
+    * Undefined "__linux__" macro on non-Linux systems (#4058)
+    * Mouse is not handled with ncurses-6 (#3954)
+    * Mouse is not handled with S-Lang on some old terminal emulators (#4063)
+    * Terminal size is always 80x24 in subshell on Solaris 11.4 SPARC (#4099)
+    * Double clicking on empty area of file panel executes last item (#3722)
+    * Garbage in input line history (#4064)
+    * Speed of file copy is not displayed for single file (#4081)
+    * mcedit: blank screen with invisible error (#4057)
+    * mcedit: broken syntax highlighting for shell scripts (#4054)
+    * VFS: broken browsing of .deb packages (#4055)
+    * mc.lib installed twice (#4070)
 
 
 Version 4.8.24
diff --git a/doc/man/mc.1.in b/doc/man/mc.1.in
index cc4c6c68b..cdd1f687b 100644
--- a/doc/man/mc.1.in
+++ b/doc/man/mc.1.in
@@ -2113,13 +2113,17 @@ overwriting files, execution by pressing enter, quitting the program,
 directory hotlist entries deletion and history cleanup.
 .\"NODE "    Appearance"
 .SH "    Appearance"
-In this dialog you can select the skin to be used.
+In this dialog you can select the skin to be used and enable shadow
+for dialogs and drop down menus.
 .PP
 See the
 .\"LINK2"
 Skins
 .\"Skins"
 section for technical details about the skin definition files.
+.PP
+.I Shadows.
+If this option is enabled, all dialogs and drop down menus will have a shadow.
 .\"NODE "    Display bits"
 .SH "    Display bits"
 This is used to configure the range of visible characters on the
diff --git a/doc/man/ru/mc.1.in b/doc/man/ru/mc.1.in
index ea9c898be..f029b5f3e 100644
--- a/doc/man/ru/mc.1.in
+++ b/doc/man/ru/mc.1.in
@@ -2411,12 +2411,17 @@ Commander, выделены цветом, определённым ключев
 на подтверждение.
 .\"NODE "    Appearance"
 .SH "    Оформление"
-Используя это диалоговое окно, вы можете выбрать скин.
+Используя это диалоговое окно, вы можете выбрать скин и разрещить отрисовку
+теней у диалоговых окон и выпадающих меню.
 .PP
 Для получения более подробной информации о скинах обратитесь к разделу
 .\"LINK2"
 Внешний вид\&.
 .\"Skins"
+.PP
+.I Тени.
+Если эта опция включена, все диалоговые окна и выпадающие меню будут иметь
+тени.
 .\"NODE "    Display bits"
 .SH "    Биты символов..."
 Этот пункт меню используется для задания диапазона отображаемых на
diff --git a/lib/Makefile.am b/lib/Makefile.am
index 455f9ddf7..95e4bbf05 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -42,8 +42,7 @@ libmc_la_SOURCES = \
 	serialize.c serialize.h \
 	shell.c shell.h \
 	stat-size.h \
-	timefmt.c timefmt.h \
-	timer.c timer.h
+	timefmt.c timefmt.h
 
 if USE_MAINTAINER_MODE
 libmc_la_SOURCES += logging.c logging.h
diff --git a/lib/glibcompat.c b/lib/glibcompat.c
index 2bea6034d..8f121ab5f 100644
--- a/lib/glibcompat.c
+++ b/lib/glibcompat.c
@@ -160,3 +160,29 @@ g_queue_clear_full (GQueue * queue, GDestroyNotify free_func)
 #endif /* ! GLIB_CHECK_VERSION (2, 60, 0) */
 
 /* --------------------------------------------------------------------------------------------- */
+
+/**
+ * mc_g_string_copy:
+ * @dest: (not nullable): the destination #GString. Its current contents are destroyed
+ * @src: (not nullable): the source #GString
+ * @return: @dest
+ *
+ * Copies the bytes from a #GString into a #GString, destroying any previous contents.
+ * It is rather like the standard strcpy() function, except that you do not have to worry about
+ * having enough space to copy the string.
+ *
+ * There is no such API in GLib2.
+ */
+GString *
+mc_g_string_copy (GString * dest, const GString * src)
+{
+    g_return_val_if_fail (src != NULL, NULL);
+    g_return_val_if_fail (dest != NULL, NULL);
+
+    g_string_set_size (dest, 0);
+    g_string_append_len (dest, src->str, src->len);
+
+    return dest;
+}
+
+/* --------------------------------------------------------------------------------------------- */
diff --git a/lib/glibcompat.h b/lib/glibcompat.h
index 5456da1a0..af6049926 100644
--- a/lib/glibcompat.h
+++ b/lib/glibcompat.h
@@ -24,6 +24,9 @@ void g_queue_free_full (GQueue * queue, GDestroyNotify free_func);
 void g_queue_clear_full (GQueue * queue, GDestroyNotify free_func);
 #endif /* ! GLIB_CHECK_VERSION (2, 60, 0) */
 
+/* There is no such API in GLib2 */
+GString *mc_g_string_copy (GString * dest, const GString * src);
+
 /*** inline functions ****************************************************************************/
 
 #endif /* MC_GLIBCOMPAT_H */
diff --git a/lib/global.c b/lib/global.c
index 137bfbdd3..5dea86987 100644
--- a/lib/global.c
+++ b/lib/global.c
@@ -31,7 +31,6 @@
 #include <config.h>
 
 #include "global.h"
-#include "lib/timer.h"
 
 /* *INDENT-OFF* */
 #ifdef ENABLE_SUBSHELL
@@ -51,7 +50,6 @@
 mc_global_t mc_global = {
     .mc_run_mode = MC_RUN_FULL,
     .run_from_parent_mc = FALSE,
-    .timer = NULL,
     .midnight_shutdown = FALSE,
 
     .sysconfig_dir = NULL,
@@ -85,6 +83,7 @@ mc_global_t mc_global = {
     .tty =
     {
         .skin = NULL,
+        .shadows = TRUE,
         .setup_color_string = NULL,
         .term_color_string = NULL,
         .color_terminal_string = NULL,
diff --git a/lib/global.h b/lib/global.h
index 846c724c6..c60063faa 100644
--- a/lib/global.h
+++ b/lib/global.h
@@ -148,8 +148,6 @@
 
 #define DEFAULT_CHARSET "ASCII"
 
-#include "lib/timer.h"          /* mc_timer_t */
-
 /*** enums ***************************************************************************************/
 
 /* run mode and params */
@@ -167,8 +165,6 @@ typedef struct
 {
     mc_run_mode_t mc_run_mode;
     gboolean run_from_parent_mc;
-    /* global timer */
-    mc_timer_t *timer;
     /* Used so that widgets know if they are being destroyed or shut down */
     gboolean midnight_shutdown;
 
@@ -230,6 +226,8 @@ typedef struct
     {
         /* Use the specified skin */
         char *skin;
+        /* Dialog window and frop down menu have a shadow */
+        gboolean shadows;
 
         char *setup_color_string;
         char *term_color_string;
diff --git a/lib/keybind.c b/lib/keybind.c
index cd4a35db4..abd44d3e2 100644
--- a/lib/keybind.c
+++ b/lib/keybind.c
@@ -7,7 +7,7 @@
    Written by:
    Vitja Makarov, 2005
    Ilia Maslakov <il.smind@gmail.com>, 2009, 2012
-   Andrew Borodin <aborodin@vmail.ru>, 2009, 2010, 2011, 2012
+   Andrew Borodin <aborodin@vmail.ru>, 2009-2020
 
    This file is part of the Midnight Commander.
 
@@ -40,333 +40,336 @@
 
 /*** file scope macro definitions ****************************************************************/
 
+#define ADD_KEYMAP_NAME(name) \
+    { #name, CK_##name }
+
 /*** file scope type declarations ****************************************************************/
 
 /*** file scope variables ************************************************************************/
 
 static name_keymap_t command_names[] = {
     /* common */
-    {"InsertChar", CK_InsertChar},
-    {"Enter", CK_Enter},
-    {"ChangePanel", CK_ChangePanel},
-    {"Up", CK_Up},
-    {"Down", CK_Down},
-    {"Left", CK_Left},
-    {"Right", CK_Right},
-    {"LeftQuick", CK_LeftQuick},
-    {"RightQuick", CK_RightQuick},
-    {"Home", CK_Home},
-    {"End", CK_End},
-    {"PageUp", CK_PageUp},
-    {"PageDown", CK_PageDown},
-    {"HalfPageUp", CK_HalfPageUp},
-    {"HalfPageDown", CK_HalfPageDown},
-    {"Top", CK_Top},
-    {"Bottom", CK_Bottom},
-    {"TopOnScreen", CK_TopOnScreen},
-    {"MiddleOnScreen", CK_MiddleOnScreen},
-    {"BottomOnScreen", CK_BottomOnScreen},
-    {"WordLeft", CK_WordLeft},
-    {"WordRight", CK_WordRight},
-    {"Copy", CK_Copy},
-    {"Move", CK_Move},
-    {"Delete", CK_Delete},
-    {"MakeDir", CK_MakeDir},
-    {"ChangeMode", CK_ChangeMode},
-    {"ChangeOwn", CK_ChangeOwn},
-    {"ChangeOwnAdvanced", CK_ChangeOwnAdvanced},
+    ADD_KEYMAP_NAME (InsertChar),
+    ADD_KEYMAP_NAME (Enter),
+    ADD_KEYMAP_NAME (ChangePanel),
+    ADD_KEYMAP_NAME (Up),
+    ADD_KEYMAP_NAME (Down),
+    ADD_KEYMAP_NAME (Left),
+    ADD_KEYMAP_NAME (Right),
+    ADD_KEYMAP_NAME (LeftQuick),
+    ADD_KEYMAP_NAME (RightQuick),
+    ADD_KEYMAP_NAME (Home),
+    ADD_KEYMAP_NAME (End),
+    ADD_KEYMAP_NAME (PageUp),
+    ADD_KEYMAP_NAME (PageDown),
+    ADD_KEYMAP_NAME (HalfPageUp),
+    ADD_KEYMAP_NAME (HalfPageDown),
+    ADD_KEYMAP_NAME (Top),
+    ADD_KEYMAP_NAME (Bottom),
+    ADD_KEYMAP_NAME (TopOnScreen),
+    ADD_KEYMAP_NAME (MiddleOnScreen),
+    ADD_KEYMAP_NAME (BottomOnScreen),
+    ADD_KEYMAP_NAME (WordLeft),
+    ADD_KEYMAP_NAME (WordRight),
+    ADD_KEYMAP_NAME (Copy),
+    ADD_KEYMAP_NAME (Move),
+    ADD_KEYMAP_NAME (Delete),
+    ADD_KEYMAP_NAME (MakeDir),
+    ADD_KEYMAP_NAME (ChangeMode),
+    ADD_KEYMAP_NAME (ChangeOwn),
+    ADD_KEYMAP_NAME (ChangeOwnAdvanced),
 #ifdef ENABLE_EXT2FS_ATTR
-    {"ChangeAttributes", CK_ChangeAttributes},
+    ADD_KEYMAP_NAME (ChangeAttributes),
 #endif
-    {"Remove", CK_Remove},
-    {"BackSpace", CK_BackSpace},
-    {"Redo", CK_Redo},
-    {"Clear", CK_Clear},
-    {"Menu", CK_Menu},
-    {"MenuLastSelected", CK_MenuLastSelected},
-    {"UserMenu", CK_UserMenu},
-    {"EditUserMenu", CK_EditUserMenu},
-    {"Search", CK_Search},
-    {"SearchContinue", CK_SearchContinue},
-    {"Replace", CK_Replace},
-    {"ReplaceContinue", CK_ReplaceContinue},
-    {"Help", CK_Help},
-    {"Shell", CK_Shell},
-    {"Edit", CK_Edit},
-    {"EditNew", CK_EditNew},
+    ADD_KEYMAP_NAME (Remove),
+    ADD_KEYMAP_NAME (BackSpace),
+    ADD_KEYMAP_NAME (Redo),
+    ADD_KEYMAP_NAME (Clear),
+    ADD_KEYMAP_NAME (Menu),
+    ADD_KEYMAP_NAME (MenuLastSelected),
+    ADD_KEYMAP_NAME (UserMenu),
+    ADD_KEYMAP_NAME (EditUserMenu),
+    ADD_KEYMAP_NAME (Search),
+    ADD_KEYMAP_NAME (SearchContinue),
+    ADD_KEYMAP_NAME (Replace),
+    ADD_KEYMAP_NAME (ReplaceContinue),
+    ADD_KEYMAP_NAME (Help),
+    ADD_KEYMAP_NAME (Shell),
+    ADD_KEYMAP_NAME (Edit),
+    ADD_KEYMAP_NAME (EditNew),
 #ifdef HAVE_CHARSET
-    {"SelectCodepage", CK_SelectCodepage},
+    ADD_KEYMAP_NAME (SelectCodepage),
 #endif
-    {"EditorViewerHistory", CK_EditorViewerHistory},
-    {"History", CK_History},
-    {"HistoryNext", CK_HistoryNext},
-    {"HistoryPrev", CK_HistoryPrev},
-    {"Complete", CK_Complete},
-    {"Save", CK_Save},
-    {"SaveAs", CK_SaveAs},
-    {"Goto", CK_Goto},
-    {"Reread", CK_Reread},
-    {"Refresh", CK_Refresh},
-    {"Suspend", CK_Suspend},
-    {"Swap", CK_Swap},
-    {"HotList", CK_HotList},
-    {"SelectInvert", CK_SelectInvert},
-    {"ScreenList", CK_ScreenList},
-    {"ScreenNext", CK_ScreenNext},
-    {"ScreenPrev", CK_ScreenPrev},
-    {"FileNext", CK_FileNext},
-    {"FilePrev", CK_FilePrev},
-    {"DeleteToHome", CK_DeleteToHome},
-    {"DeleteToEnd", CK_DeleteToEnd},
-    {"DeleteToWordBegin", CK_DeleteToWordBegin},
-    {"DeleteToWordEnd", CK_DeleteToWordEnd},
-    {"Cut", CK_Cut},
-    {"Store", CK_Store},
-    {"Paste", CK_Paste},
-    {"Mark", CK_Mark},
-    {"MarkLeft", CK_MarkLeft},
-    {"MarkRight", CK_MarkRight},
-    {"MarkUp", CK_MarkUp},
-    {"MarkDown", CK_MarkDown},
-    {"MarkToWordBegin", CK_MarkToWordBegin},
-    {"MarkToWordEnd", CK_MarkToWordEnd},
-    {"MarkToHome", CK_MarkToHome},
-    {"MarkToEnd", CK_MarkToEnd},
-    {"ToggleNavigation", CK_ToggleNavigation},
-    {"Sort", CK_Sort},
-    {"Options", CK_Options},
-    {"LearnKeys", CK_LearnKeys},
-    {"Bookmark", CK_Bookmark},
-    {"Quit", CK_Quit},
-    {"QuitQuiet", CK_QuitQuiet},
-    {"ExtendedKeyMap", CK_ExtendedKeyMap},
+    ADD_KEYMAP_NAME (EditorViewerHistory),
+    ADD_KEYMAP_NAME (History),
+    ADD_KEYMAP_NAME (HistoryNext),
+    ADD_KEYMAP_NAME (HistoryPrev),
+    ADD_KEYMAP_NAME (Complete),
+    ADD_KEYMAP_NAME (Save),
+    ADD_KEYMAP_NAME (SaveAs),
+    ADD_KEYMAP_NAME (Goto),
+    ADD_KEYMAP_NAME (Reread),
+    ADD_KEYMAP_NAME (Refresh),
+    ADD_KEYMAP_NAME (Suspend),
+    ADD_KEYMAP_NAME (Swap),
+    ADD_KEYMAP_NAME (HotList),
+    ADD_KEYMAP_NAME (SelectInvert),
+    ADD_KEYMAP_NAME (ScreenList),
+    ADD_KEYMAP_NAME (ScreenNext),
+    ADD_KEYMAP_NAME (ScreenPrev),
+    ADD_KEYMAP_NAME (FileNext),
+    ADD_KEYMAP_NAME (FilePrev),
+    ADD_KEYMAP_NAME (DeleteToHome),
+    ADD_KEYMAP_NAME (DeleteToEnd),
+    ADD_KEYMAP_NAME (DeleteToWordBegin),
+    ADD_KEYMAP_NAME (DeleteToWordEnd),
+    ADD_KEYMAP_NAME (Cut),
+    ADD_KEYMAP_NAME (Store),
+    ADD_KEYMAP_NAME (Paste),
+    ADD_KEYMAP_NAME (Mark),
+    ADD_KEYMAP_NAME (MarkLeft),
+    ADD_KEYMAP_NAME (MarkRight),
+    ADD_KEYMAP_NAME (MarkUp),
+    ADD_KEYMAP_NAME (MarkDown),
+    ADD_KEYMAP_NAME (MarkToWordBegin),
+    ADD_KEYMAP_NAME (MarkToWordEnd),
+    ADD_KEYMAP_NAME (MarkToHome),
+    ADD_KEYMAP_NAME (MarkToEnd),
+    ADD_KEYMAP_NAME (ToggleNavigation),
+    ADD_KEYMAP_NAME (Sort),
+    ADD_KEYMAP_NAME (Options),
+    ADD_KEYMAP_NAME (LearnKeys),
+    ADD_KEYMAP_NAME (Bookmark),
+    ADD_KEYMAP_NAME (Quit),
+    ADD_KEYMAP_NAME (QuitQuiet),
+    ADD_KEYMAP_NAME (ExtendedKeyMap),
 
     /* main commands */
 #ifdef USE_INTERNAL_EDIT
-    {"EditForceInternal", CK_EditForceInternal},
+    ADD_KEYMAP_NAME (EditForceInternal),
 #endif
-    {"View", CK_View},
-    {"ViewRaw", CK_ViewRaw},
-    {"ViewFile", CK_ViewFile},
-    {"ViewFiltered", CK_ViewFiltered},
-    {"Find", CK_Find},
-    {"DirSize", CK_DirSize},
-    {"CompareDirs", CK_CompareDirs},
+    ADD_KEYMAP_NAME (View),
+    ADD_KEYMAP_NAME (ViewRaw),
+    ADD_KEYMAP_NAME (ViewFile),
+    ADD_KEYMAP_NAME (ViewFiltered),
+    ADD_KEYMAP_NAME (Find),
+    ADD_KEYMAP_NAME (DirSize),
+    ADD_KEYMAP_NAME (CompareDirs),
 #ifdef USE_DIFF_VIEW
-    {"CompareFiles", CK_CompareFiles},
+    ADD_KEYMAP_NAME (CompareFiles),
 #endif
-    {"OptionsVfs", CK_OptionsVfs},
-    {"OptionsConfirm", CK_OptionsConfirm},
-    {"OptionsDisplayBits", CK_OptionsDisplayBits},
-    {"EditExtensionsFile", CK_EditExtensionsFile},
-    {"EditFileHighlightFile", CK_EditFileHighlightFile},
-    {"LinkSymbolicEdit", CK_LinkSymbolicEdit},
-    {"ExternalPanelize", CK_ExternalPanelize},
-    {"Filter", CK_Filter},
+    ADD_KEYMAP_NAME (OptionsVfs),
+    ADD_KEYMAP_NAME (OptionsConfirm),
+    ADD_KEYMAP_NAME (OptionsDisplayBits),
+    ADD_KEYMAP_NAME (EditExtensionsFile),
+    ADD_KEYMAP_NAME (EditFileHighlightFile),
+    ADD_KEYMAP_NAME (LinkSymbolicEdit),
+    ADD_KEYMAP_NAME (ExternalPanelize),
+    ADD_KEYMAP_NAME (Filter),
 #ifdef ENABLE_VFS_FISH
-    {"ConnectFish", CK_ConnectFish},
+    ADD_KEYMAP_NAME (ConnectFish),
 #endif
 #ifdef ENABLE_VFS_FTP
-    {"ConnectFtp", CK_ConnectFtp},
+    ADD_KEYMAP_NAME (ConnectFtp),
 #endif
 #ifdef ENABLE_VFS_SFTP
-    {"ConnectSftp", CK_ConnectSftp},
+    ADD_KEYMAP_NAME (ConnectSftp),
 #endif
 #ifdef ENABLE_VFS_SMB
-    {"ConnectSmb", CK_ConnectSmb},
+    ADD_KEYMAP_NAME (ConnectSmb),
 #endif
-    {"PanelInfo", CK_PanelInfo},
+    ADD_KEYMAP_NAME (PanelInfo),
 #ifdef ENABLE_BACKGROUND
-    {"Jobs", CK_Jobs},
+    ADD_KEYMAP_NAME (Jobs),
 #endif
-    {"OptionsLayout", CK_OptionsLayout},
-    {"OptionsAppearance", CK_OptionsAppearance},
-    {"Link", CK_Link},
-    {"SetupListingFormat", CK_SetupListingFormat},
-    {"PanelListing", CK_PanelListing},
+    ADD_KEYMAP_NAME (OptionsLayout),
+    ADD_KEYMAP_NAME (OptionsAppearance),
+    ADD_KEYMAP_NAME (Link),
+    ADD_KEYMAP_NAME (SetupListingFormat),
+    ADD_KEYMAP_NAME (PanelListing),
 #ifdef LISTMODE_EDITOR
-    {"ListMode", CK_ListMode}.
+    ADD_KEYMAP_NAME (ListMode),
 #endif
-    {"OptionsPanel", CK_OptionsPanel},
-    {"CdQuick", CK_CdQuick},
-    {"PanelQuickView", CK_PanelQuickView},
-    {"LinkSymbolicRelative", CK_LinkSymbolicRelative},
-    {"VfsList", CK_VfsList},
-    {"SaveSetup", CK_SaveSetup},
-    {"LinkSymbolic", CK_LinkSymbolic},
-    {"PanelTree", CK_PanelTree},
-    {"Tree", CK_Tree},
+    ADD_KEYMAP_NAME (OptionsPanel),
+    ADD_KEYMAP_NAME (CdQuick),
+    ADD_KEYMAP_NAME (PanelQuickView),
+    ADD_KEYMAP_NAME (LinkSymbolicRelative),
+    ADD_KEYMAP_NAME (VfsList),
+    ADD_KEYMAP_NAME (SaveSetup),
+    ADD_KEYMAP_NAME (LinkSymbolic),
+    ADD_KEYMAP_NAME (PanelTree),
+    ADD_KEYMAP_NAME (Tree),
 #ifdef ENABLE_VFS_UNDELFS
-    {"Undelete", CK_Undelete},
+    ADD_KEYMAP_NAME (Undelete),
 #endif
-    {"PutCurrentLink", CK_PutCurrentLink},
-    {"PutOtherLink", CK_PutOtherLink},
-    {"HotListAdd", CK_HotListAdd},
-    {"ShowHidden", CK_ShowHidden},
-    {"SplitVertHoriz", CK_SplitVertHoriz},
-    {"SplitEqual", CK_SplitEqual},
-    {"SplitMore", CK_SplitMore},
-    {"SplitLess", CK_SplitLess},
-    {"PutCurrentPath", CK_PutCurrentPath},
-    {"PutOtherPath", CK_PutOtherPath},
-    {"PutCurrentSelected", CK_PutCurrentSelected},
-    {"PutCurrentFullSelected", CK_PutCurrentFullSelected},
-    {"PutCurrentTagged", CK_PutCurrentTagged},
-    {"PutOtherTagged", CK_PutOtherTagged},
-    {"Select", CK_Select},
-    {"Unselect", CK_Unselect},
+    ADD_KEYMAP_NAME (PutCurrentLink),
+    ADD_KEYMAP_NAME (PutOtherLink),
+    ADD_KEYMAP_NAME (HotListAdd),
+    ADD_KEYMAP_NAME (ShowHidden),
+    ADD_KEYMAP_NAME (SplitVertHoriz),
+    ADD_KEYMAP_NAME (SplitEqual),
+    ADD_KEYMAP_NAME (SplitMore),
+    ADD_KEYMAP_NAME (SplitLess),
+    ADD_KEYMAP_NAME (PutCurrentPath),
+    ADD_KEYMAP_NAME (PutOtherPath),
+    ADD_KEYMAP_NAME (PutCurrentSelected),
+    ADD_KEYMAP_NAME (PutCurrentFullSelected),
+    ADD_KEYMAP_NAME (PutCurrentTagged),
+    ADD_KEYMAP_NAME (PutOtherTagged),
+    ADD_KEYMAP_NAME (Select),
+    ADD_KEYMAP_NAME (Unselect),
 
     /* panel */
-    {"SelectExt", CK_SelectExt},
-    {"ScrollLeft", CK_ScrollLeft},
-    {"ScrollRight", CK_ScrollRight},
-    {"PanelOtherCd", CK_PanelOtherCd},
-    {"PanelOtherCdLink", CK_PanelOtherCdLink},
-    {"CopySingle", CK_CopySingle},
-    {"MoveSingle", CK_MoveSingle},
-    {"DeleteSingle", CK_DeleteSingle},
-    {"CdParent", CK_CdParent},
-    {"CdChild", CK_CdChild},
-    {"Panelize", CK_Panelize},
-    {"PanelOtherSync", CK_PanelOtherSync},
-    {"SortNext", CK_SortNext},
-    {"SortPrev", CK_SortPrev},
-    {"SortReverse", CK_SortReverse},
-    {"SortByName", CK_SortByName},
-    {"SortByExt", CK_SortByExt},
-    {"SortBySize", CK_SortBySize},
-    {"SortByMTime", CK_SortByMTime},
-    {"CdParentSmart", CK_CdParentSmart},
-    {"CycleListingFormat", CK_CycleListingFormat},
+    ADD_KEYMAP_NAME (SelectExt),
+    ADD_KEYMAP_NAME (ScrollLeft),
+    ADD_KEYMAP_NAME (ScrollRight),
+    ADD_KEYMAP_NAME (PanelOtherCd),
+    ADD_KEYMAP_NAME (PanelOtherCdLink),
+    ADD_KEYMAP_NAME (CopySingle),
+    ADD_KEYMAP_NAME (MoveSingle),
+    ADD_KEYMAP_NAME (DeleteSingle),
+    ADD_KEYMAP_NAME (CdParent),
+    ADD_KEYMAP_NAME (CdChild),
+    ADD_KEYMAP_NAME (Panelize),
+    ADD_KEYMAP_NAME (PanelOtherSync),
+    ADD_KEYMAP_NAME (SortNext),
+    ADD_KEYMAP_NAME (SortPrev),
+    ADD_KEYMAP_NAME (SortReverse),
+    ADD_KEYMAP_NAME (SortByName),
+    ADD_KEYMAP_NAME (SortByExt),
+    ADD_KEYMAP_NAME (SortBySize),
+    ADD_KEYMAP_NAME (SortByMTime),
+    ADD_KEYMAP_NAME (CdParentSmart),
+    ADD_KEYMAP_NAME (CycleListingFormat),
 
     /* dialog */
-    {"Ok", CK_Ok},
-    {"Cancel", CK_Cancel},
+    ADD_KEYMAP_NAME (Ok),
+    ADD_KEYMAP_NAME (Cancel),
 
     /* input line */
-    {"Yank", CK_Yank},
+    ADD_KEYMAP_NAME (Yank),
 
     /* help */
-    {"Index", CK_Index},
-    {"Back", CK_Back},
-    {"LinkNext", CK_LinkNext},
-    {"LinkPrev", CK_LinkPrev},
-    {"NodeNext", CK_NodeNext},
-    {"NodePrev", CK_NodePrev},
+    ADD_KEYMAP_NAME (Index),
+    ADD_KEYMAP_NAME (Back),
+    ADD_KEYMAP_NAME (LinkNext),
+    ADD_KEYMAP_NAME (LinkPrev),
+    ADD_KEYMAP_NAME (NodeNext),
+    ADD_KEYMAP_NAME (NodePrev),
 
     /* tree */
-    {"Forget", CK_Forget},
+    ADD_KEYMAP_NAME (Forget),
 
 #if defined (USE_INTERNAL_EDIT) || defined (USE_DIFF_VIEW)
-    {"ShowNumbers", CK_ShowNumbers},
+    ADD_KEYMAP_NAME (ShowNumbers),
 #endif
 
     /* chattr dialog */
-    {"MarkAndDown", CK_MarkAndDown},
+    ADD_KEYMAP_NAME (MarkAndDown),
 
 #ifdef USE_INTERNAL_EDIT
-    {"Close", CK_Close},
-    {"Tab", CK_Tab},
-    {"Undo", CK_Undo},
-    {"ScrollUp", CK_ScrollUp},
-    {"ScrollDown", CK_ScrollDown},
-    {"Return", CK_Return},
-    {"ParagraphUp", CK_ParagraphUp},
-    {"ParagraphDown", CK_ParagraphDown},
-    {"EditFile", CK_EditFile},
-    {"MarkWord", CK_MarkWord},
-    {"MarkLine", CK_MarkLine},
-    {"MarkAll", CK_MarkAll},
-    {"Unmark", CK_Unmark},
-    {"MarkColumn", CK_MarkColumn},
-    {"BlockSave", CK_BlockSave},
-    {"InsertFile", CK_InsertFile},
-    {"InsertOverwrite", CK_InsertOverwrite},
-    {"Date", CK_Date},
-    {"DeleteLine", CK_DeleteLine},
-    {"EditMail", CK_Mail},
-    {"ParagraphFormat", CK_ParagraphFormat},
-    {"MatchBracket", CK_MatchBracket},
-    {"ExternalCommand", CK_ExternalCommand},
-    {"MacroStartRecord", CK_MacroStartRecord},
-    {"MacroStopRecord", CK_MacroStopRecord},
-    {"MacroStartStopRecord", CK_MacroStartStopRecord},
-    {"MacroDelete", CK_MacroDelete},
-    {"RepeatStartStopRecord", CK_RepeatStartStopRecord},
+    ADD_KEYMAP_NAME (Close),
+    ADD_KEYMAP_NAME (Tab),
+    ADD_KEYMAP_NAME (Undo),
+    ADD_KEYMAP_NAME (ScrollUp),
+    ADD_KEYMAP_NAME (ScrollDown),
+    ADD_KEYMAP_NAME (Return),
+    ADD_KEYMAP_NAME (ParagraphUp),
+    ADD_KEYMAP_NAME (ParagraphDown),
+    ADD_KEYMAP_NAME (EditFile),
+    ADD_KEYMAP_NAME (MarkWord),
+    ADD_KEYMAP_NAME (MarkLine),
+    ADD_KEYMAP_NAME (MarkAll),
+    ADD_KEYMAP_NAME (Unmark),
+    ADD_KEYMAP_NAME (MarkColumn),
+    ADD_KEYMAP_NAME (BlockSave),
+    ADD_KEYMAP_NAME (InsertFile),
+    ADD_KEYMAP_NAME (InsertOverwrite),
+    ADD_KEYMAP_NAME (Date),
+    ADD_KEYMAP_NAME (DeleteLine),
+    ADD_KEYMAP_NAME (EditMail),
+    ADD_KEYMAP_NAME (ParagraphFormat),
+    ADD_KEYMAP_NAME (MatchBracket),
+    ADD_KEYMAP_NAME (ExternalCommand),
+    ADD_KEYMAP_NAME (MacroStartRecord),
+    ADD_KEYMAP_NAME (MacroStopRecord),
+    ADD_KEYMAP_NAME (MacroStartStopRecord),
+    ADD_KEYMAP_NAME (MacroDelete),
+    ADD_KEYMAP_NAME (RepeatStartStopRecord),
 #ifdef HAVE_ASPELL
-    {"SpellCheck", CK_SpellCheck},
-    {"SpellCheckCurrentWord", CK_SpellCheckCurrentWord},
-    {"SpellCheckSelectLang", CK_SpellCheckSelectLang},
+    ADD_KEYMAP_NAME (SpellCheck),
+    ADD_KEYMAP_NAME (SpellCheckCurrentWord),
+    ADD_KEYMAP_NAME (SpellCheckSelectLang),
 #endif /* HAVE_ASPELL */
-    {"BookmarkFlush", CK_BookmarkFlush},
-    {"BookmarkNext", CK_BookmarkNext},
-    {"BookmarkPrev", CK_BookmarkPrev},
-    {"MarkPageUp", CK_MarkPageUp},
-    {"MarkPageDown", CK_MarkPageDown},
-    {"MarkToFileBegin", CK_MarkToFileBegin},
-    {"MarkToFileEnd", CK_MarkToFileEnd},
-    {"MarkToPageBegin", CK_MarkToPageBegin},
-    {"MarkToPageEnd", CK_MarkToPageEnd},
-    {"MarkScrollUp", CK_MarkScrollUp},
-    {"MarkScrollDown", CK_MarkScrollDown},
-    {"MarkParagraphUp", CK_MarkParagraphUp},
-    {"MarkParagraphDown", CK_MarkParagraphDown},
-    {"MarkColumnPageUp", CK_MarkColumnPageUp},
-    {"MarkColumnPageDown", CK_MarkColumnPageDown},
-    {"MarkColumnLeft", CK_MarkColumnLeft},
-    {"MarkColumnRight", CK_MarkColumnRight},
-    {"MarkColumnUp", CK_MarkColumnUp},
-    {"MarkColumnDown", CK_MarkColumnDown},
-    {"MarkColumnScrollUp", CK_MarkColumnScrollUp},
-    {"MarkColumnScrollDown", CK_MarkColumnScrollDown},
-    {"MarkColumnParagraphUp", CK_MarkColumnParagraphUp},
-    {"MarkColumnParagraphDown", CK_MarkColumnParagraphDown},
-    {"BlockShiftLeft", CK_BlockShiftLeft},
-    {"BlockShiftRight", CK_BlockShiftRight},
-    {"InsertLiteral", CK_InsertLiteral},
-    {"ShowTabTws", CK_ShowTabTws},
-    {"SyntaxOnOff", CK_SyntaxOnOff},
-    {"SyntaxChoose", CK_SyntaxChoose},
-    {"ShowMargin", CK_ShowMargin},
-    {"OptionsSaveMode", CK_OptionsSaveMode},
-    {"About", CK_About},
+    ADD_KEYMAP_NAME (BookmarkFlush),
+    ADD_KEYMAP_NAME (BookmarkNext),
+    ADD_KEYMAP_NAME (BookmarkPrev),
+    ADD_KEYMAP_NAME (MarkPageUp),
+    ADD_KEYMAP_NAME (MarkPageDown),
+    ADD_KEYMAP_NAME (MarkToFileBegin),
+    ADD_KEYMAP_NAME (MarkToFileEnd),
+    ADD_KEYMAP_NAME (MarkToPageBegin),
+    ADD_KEYMAP_NAME (MarkToPageEnd),
+    ADD_KEYMAP_NAME (MarkScrollUp),
+    ADD_KEYMAP_NAME (MarkScrollDown),
+    ADD_KEYMAP_NAME (MarkParagraphUp),
+    ADD_KEYMAP_NAME (MarkParagraphDown),
+    ADD_KEYMAP_NAME (MarkColumnPageUp),
+    ADD_KEYMAP_NAME (MarkColumnPageDown),
+    ADD_KEYMAP_NAME (MarkColumnLeft),
+    ADD_KEYMAP_NAME (MarkColumnRight),
+    ADD_KEYMAP_NAME (MarkColumnUp),
+    ADD_KEYMAP_NAME (MarkColumnDown),
+    ADD_KEYMAP_NAME (MarkColumnScrollUp),
+    ADD_KEYMAP_NAME (MarkColumnScrollDown),
+    ADD_KEYMAP_NAME (MarkColumnParagraphUp),
+    ADD_KEYMAP_NAME (MarkColumnParagraphDown),
+    ADD_KEYMAP_NAME (BlockShiftLeft),
+    ADD_KEYMAP_NAME (BlockShiftRight),
+    ADD_KEYMAP_NAME (InsertLiteral),
+    ADD_KEYMAP_NAME (ShowTabTws),
+    ADD_KEYMAP_NAME (SyntaxOnOff),
+    ADD_KEYMAP_NAME (SyntaxChoose),
+    ADD_KEYMAP_NAME (ShowMargin),
+    ADD_KEYMAP_NAME (OptionsSaveMode),
+    ADD_KEYMAP_NAME (About),
     /* An action to run external script from macro */
     {"ExecuteScript", CK_PipeBlock (0)},
-    {"WindowMove", CK_WindowMove},
-    {"WindowResize", CK_WindowResize},
-    {"WindowFullscreen", CK_WindowFullscreen},
-    {"WindowList", CK_WindowList},
-    {"WindowNext", CK_WindowNext},
-    {"WindowPrev", CK_WindowPrev},
+    ADD_KEYMAP_NAME (WindowMove),
+    ADD_KEYMAP_NAME (WindowResize),
+    ADD_KEYMAP_NAME (WindowFullscreen),
+    ADD_KEYMAP_NAME (WindowList),
+    ADD_KEYMAP_NAME (WindowNext),
+    ADD_KEYMAP_NAME (WindowPrev),
 #endif /* USE_INTERNAL_EDIT */
 
     /* viewer */
-    {"WrapMode", CK_WrapMode},
-    {"HexEditMode", CK_HexEditMode},
-    {"HexMode", CK_HexMode},
-    {"MagicMode", CK_MagicMode},
-    {"NroffMode", CK_NroffMode},
-    {"BookmarkGoto", CK_BookmarkGoto},
-    {"Ruler", CK_Ruler},
-    {"SearchForward", CK_SearchForward},
-    {"SearchBackward", CK_SearchBackward},
-    {"SearchForwardContinue", CK_SearchForwardContinue},
-    {"SearchBackwardContinue", CK_SearchBackwardContinue},
-    {"SearchOppositeContinue", CK_SearchOppositeContinue},
+    ADD_KEYMAP_NAME (WrapMode),
+    ADD_KEYMAP_NAME (HexEditMode),
+    ADD_KEYMAP_NAME (HexMode),
+    ADD_KEYMAP_NAME (MagicMode),
+    ADD_KEYMAP_NAME (NroffMode),
+    ADD_KEYMAP_NAME (BookmarkGoto),
+    ADD_KEYMAP_NAME (Ruler),
+    ADD_KEYMAP_NAME (SearchForward),
+    ADD_KEYMAP_NAME (SearchBackward),
+    ADD_KEYMAP_NAME (SearchForwardContinue),
+    ADD_KEYMAP_NAME (SearchBackwardContinue),
+    ADD_KEYMAP_NAME (SearchOppositeContinue),
 
 #ifdef USE_DIFF_VIEW
     /* diff viewer */
-    {"ShowSymbols", CK_ShowSymbols},
-    {"SplitFull", CK_SplitFull},
-    {"Tab2", CK_Tab2},
-    {"Tab3", CK_Tab3},
-    {"Tab4", CK_Tab4},
-    {"Tab8", CK_Tab8},
-    {"HunkNext", CK_HunkNext},
-    {"HunkPrev", CK_HunkPrev},
-    {"EditOther", CK_EditOther},
-    {"Merge", CK_Merge},
-    {"MergeOther", CK_MergeOther},
+    ADD_KEYMAP_NAME (ShowSymbols),
+    ADD_KEYMAP_NAME (SplitFull),
+    ADD_KEYMAP_NAME (Tab2),
+    ADD_KEYMAP_NAME (Tab3),
+    ADD_KEYMAP_NAME (Tab4),
+    ADD_KEYMAP_NAME (Tab8),
+    ADD_KEYMAP_NAME (HunkNext),
+    ADD_KEYMAP_NAME (HunkPrev),
+    ADD_KEYMAP_NAME (EditOther),
+    ADD_KEYMAP_NAME (Merge),
+    ADD_KEYMAP_NAME (MergeOther),
 #endif /* USE_DIFF_VIEW */
 
     {NULL, CK_IgnoreKey}
diff --git a/lib/keybind.h b/lib/keybind.h
index 53ad1c39f..af019df09 100644
--- a/lib/keybind.h
+++ b/lib/keybind.h
@@ -9,8 +9,8 @@
 /*** typedefs(not structures) and defined constants **********************************************/
 
 /* keymap sections */
-#define KEYMAP_SECTION_MAIN "main"
-#define KEYMAP_SECTION_MAIN_EXT "main:xmap"
+#define KEYMAP_SECTION_FILEMANAGER "filemanager"
+#define KEYMAP_SECTION_FILEMANAGER_EXT "filemanager:xmap"
 #define KEYMAP_SECTION_PANEL "panel"
 #define KEYMAP_SECTION_DIALOG "dialog"
 #define KEYMAP_SECTION_MENU "menu"
@@ -316,7 +316,7 @@ enum
     CK_InsertLiteral,
     CK_ExternalCommand,
     CK_Date,
-    CK_Mail,
+    CK_EditMail,
 
     /* viewer */
     CK_WrapMode = 600L,
diff --git a/lib/shell.h b/lib/shell.h
index 9afcd900e..7ba82dc07 100644
--- a/lib/shell.h
+++ b/lib/shell.h
@@ -1,4 +1,4 @@
-/** \file timer.h
+/** \file shell.h
  *  \brief Header: shell structure
  */
 
diff --git a/lib/skin.h b/lib/skin.h
index 747a504ec..155a8db9c 100644
--- a/lib/skin.h
+++ b/lib/skin.h
@@ -22,92 +22,93 @@
 #define REVERSE_COLOR             mc_skin_color__cache[6]
 #define COMMAND_MARK_COLOR        mc_skin_color__cache[7]
 #define HEADER_COLOR              mc_skin_color__cache[8]
+#define SHADOW_COLOR              mc_skin_color__cache[9]
 
 /* Dialog colors */
-#define COLOR_NORMAL              mc_skin_color__cache[9]
-#define COLOR_FOCUS               mc_skin_color__cache[10]
-#define COLOR_HOT_NORMAL          mc_skin_color__cache[11]
-#define COLOR_HOT_FOCUS           mc_skin_color__cache[12]
-#define COLOR_TITLE               mc_skin_color__cache[13]
+#define COLOR_NORMAL              mc_skin_color__cache[10]
+#define COLOR_FOCUS               mc_skin_color__cache[11]
+#define COLOR_HOT_NORMAL          mc_skin_color__cache[12]
+#define COLOR_HOT_FOCUS           mc_skin_color__cache[13]
+#define COLOR_TITLE               mc_skin_color__cache[14]
 
 /* Error dialog colors */
-#define ERROR_COLOR               mc_skin_color__cache[14]
-#define ERROR_FOCUS               mc_skin_color__cache[15]
-#define ERROR_HOT_NORMAL          mc_skin_color__cache[16]
-#define ERROR_HOT_FOCUS           mc_skin_color__cache[17]
-#define ERROR_TITLE               mc_skin_color__cache[18]
+#define ERROR_COLOR               mc_skin_color__cache[15]
+#define ERROR_FOCUS               mc_skin_color__cache[16]
+#define ERROR_HOT_NORMAL          mc_skin_color__cache[17]
+#define ERROR_HOT_FOCUS           mc_skin_color__cache[18]
+#define ERROR_TITLE               mc_skin_color__cache[19]
 
 /* Menu colors */
-#define MENU_ENTRY_COLOR          mc_skin_color__cache[19]
-#define MENU_SELECTED_COLOR       mc_skin_color__cache[20]
-#define MENU_HOT_COLOR            mc_skin_color__cache[21]
-#define MENU_HOTSEL_COLOR         mc_skin_color__cache[22]
-#define MENU_INACTIVE_COLOR       mc_skin_color__cache[23]
+#define MENU_ENTRY_COLOR          mc_skin_color__cache[20]
+#define MENU_SELECTED_COLOR       mc_skin_color__cache[21]
+#define MENU_HOT_COLOR            mc_skin_color__cache[22]
+#define MENU_HOTSEL_COLOR         mc_skin_color__cache[23]
+#define MENU_INACTIVE_COLOR       mc_skin_color__cache[24]
 
 /* Popup menu colors */
-#define PMENU_ENTRY_COLOR         mc_skin_color__cache[24]
-#define PMENU_SELECTED_COLOR      mc_skin_color__cache[25]
-#define PMENU_HOT_COLOR           mc_skin_color__cache[26]      /* unused: not implemented yet */
-#define PMENU_HOTSEL_COLOR        mc_skin_color__cache[27]      /* unused: not implemented yet */
-#define PMENU_TITLE_COLOR         mc_skin_color__cache[28]
+#define PMENU_ENTRY_COLOR         mc_skin_color__cache[25]
+#define PMENU_SELECTED_COLOR      mc_skin_color__cache[26]
+#define PMENU_HOT_COLOR           mc_skin_color__cache[27]      /* unused: not implemented yet */
+#define PMENU_HOTSEL_COLOR        mc_skin_color__cache[28]      /* unused: not implemented yet */
+#define PMENU_TITLE_COLOR         mc_skin_color__cache[29]
 
-#define BUTTONBAR_HOTKEY_COLOR    mc_skin_color__cache[29]
-#define BUTTONBAR_BUTTON_COLOR    mc_skin_color__cache[30]
+#define BUTTONBAR_HOTKEY_COLOR    mc_skin_color__cache[30]
+#define BUTTONBAR_BUTTON_COLOR    mc_skin_color__cache[31]
 
-#define STATUSBAR_COLOR           mc_skin_color__cache[31]
+#define STATUSBAR_COLOR           mc_skin_color__cache[32]
 
 /*
  * This should be selectable independently. Default has to be black background
  * foreground does not matter at all.
  */
-#define GAUGE_COLOR               mc_skin_color__cache[32]
-#define INPUT_COLOR               mc_skin_color__cache[33]
-#define INPUT_UNCHANGED_COLOR     mc_skin_color__cache[34]
-#define INPUT_MARK_COLOR          mc_skin_color__cache[35]
-#define INPUT_HISTORY_COLOR       mc_skin_color__cache[36]
-#define COMMAND_HISTORY_COLOR     mc_skin_color__cache[37]
-
-#define HELP_NORMAL_COLOR         mc_skin_color__cache[38]
-#define HELP_ITALIC_COLOR         mc_skin_color__cache[39]
-#define HELP_BOLD_COLOR           mc_skin_color__cache[40]
-#define HELP_LINK_COLOR           mc_skin_color__cache[41]
-#define HELP_SLINK_COLOR          mc_skin_color__cache[42]
-#define HELP_TITLE_COLOR          mc_skin_color__cache[43]
-
-
-#define VIEW_NORMAL_COLOR         mc_skin_color__cache[44]
-#define VIEW_BOLD_COLOR           mc_skin_color__cache[45]
-#define VIEW_UNDERLINED_COLOR     mc_skin_color__cache[46]
-#define VIEW_SELECTED_COLOR       mc_skin_color__cache[47]
+#define GAUGE_COLOR               mc_skin_color__cache[33]
+#define INPUT_COLOR               mc_skin_color__cache[34]
+#define INPUT_UNCHANGED_COLOR     mc_skin_color__cache[35]
+#define INPUT_MARK_COLOR          mc_skin_color__cache[36]
+#define INPUT_HISTORY_COLOR       mc_skin_color__cache[37]
+#define COMMAND_HISTORY_COLOR     mc_skin_color__cache[38]
+
+#define HELP_NORMAL_COLOR         mc_skin_color__cache[39]
+#define HELP_ITALIC_COLOR         mc_skin_color__cache[40]
+#define HELP_BOLD_COLOR           mc_skin_color__cache[41]
+#define HELP_LINK_COLOR           mc_skin_color__cache[42]
+#define HELP_SLINK_COLOR          mc_skin_color__cache[43]
+#define HELP_TITLE_COLOR          mc_skin_color__cache[44]
+
+
+#define VIEW_NORMAL_COLOR         mc_skin_color__cache[45]
+#define VIEW_BOLD_COLOR           mc_skin_color__cache[46]
+#define VIEW_UNDERLINED_COLOR     mc_skin_color__cache[47]
+#define VIEW_SELECTED_COLOR       mc_skin_color__cache[48]
 
 /*
  * editor colors - only 4 for normal, search->found, select, and whitespace
  * respectively
  * Last is defined to view color.
  */
-#define EDITOR_NORMAL_COLOR       mc_skin_color__cache[48]
-#define EDITOR_BOLD_COLOR         mc_skin_color__cache[49]
-#define EDITOR_MARKED_COLOR       mc_skin_color__cache[50]
-#define EDITOR_WHITESPACE_COLOR   mc_skin_color__cache[51]
-#define EDITOR_RIGHT_MARGIN_COLOR mc_skin_color__cache[52]
-#define EDITOR_BACKGROUND         mc_skin_color__cache[53]
-#define EDITOR_FRAME              mc_skin_color__cache[54]
-#define EDITOR_FRAME_ACTIVE       mc_skin_color__cache[55]
-#define EDITOR_FRAME_DRAG         mc_skin_color__cache[56]
+#define EDITOR_NORMAL_COLOR       mc_skin_color__cache[49]
+#define EDITOR_BOLD_COLOR         mc_skin_color__cache[50]
+#define EDITOR_MARKED_COLOR       mc_skin_color__cache[51]
+#define EDITOR_WHITESPACE_COLOR   mc_skin_color__cache[52]
+#define EDITOR_RIGHT_MARGIN_COLOR mc_skin_color__cache[53]
+#define EDITOR_BACKGROUND         mc_skin_color__cache[54]
+#define EDITOR_FRAME              mc_skin_color__cache[55]
+#define EDITOR_FRAME_ACTIVE       mc_skin_color__cache[56]
+#define EDITOR_FRAME_DRAG         mc_skin_color__cache[57]
 /* color of left 8 char status per line */
-#define LINE_STATE_COLOR          mc_skin_color__cache[57]
-#define BOOK_MARK_COLOR           mc_skin_color__cache[58]
-#define BOOK_MARK_FOUND_COLOR     mc_skin_color__cache[59]
+#define LINE_STATE_COLOR          mc_skin_color__cache[58]
+#define BOOK_MARK_COLOR           mc_skin_color__cache[59]
+#define BOOK_MARK_FOUND_COLOR     mc_skin_color__cache[60]
 
 /* Diff colors */
-#define DFF_ADD_COLOR             mc_skin_color__cache[60]
-#define DFF_CHG_COLOR             mc_skin_color__cache[61]
-#define DFF_CHH_COLOR             mc_skin_color__cache[62]
-#define DFF_CHD_COLOR             mc_skin_color__cache[63]
-#define DFF_DEL_COLOR             mc_skin_color__cache[64]
-#define DFF_ERROR_COLOR           mc_skin_color__cache[65]
-
-#define MC_SKIN_COLOR_CACHE_COUNT 66
+#define DFF_ADD_COLOR             mc_skin_color__cache[61]
+#define DFF_CHG_COLOR             mc_skin_color__cache[62]
+#define DFF_CHH_COLOR             mc_skin_color__cache[63]
+#define DFF_CHD_COLOR             mc_skin_color__cache[64]
+#define DFF_DEL_COLOR             mc_skin_color__cache[65]
+#define DFF_ERROR_COLOR           mc_skin_color__cache[66]
+
+#define MC_SKIN_COLOR_CACHE_COUNT 67
 
 /*** enums ***************************************************************************************/
 
diff --git a/lib/skin/colors.c b/lib/skin/colors.c
index b8d944a41..27e18bdda 100644
--- a/lib/skin/colors.c
+++ b/lib/skin/colors.c
@@ -249,6 +249,7 @@ mc_skin_color_cache_init (void)
     REVERSE_COLOR = mc_skin_color_get ("core", "reverse");
     HEADER_COLOR = mc_skin_color_get ("core", "header");
     COMMAND_MARK_COLOR = mc_skin_color_get ("core", "commandlinemark");
+    SHADOW_COLOR = mc_skin_color_get ("core", "shadow");
 
     COLOR_NORMAL = mc_skin_color_get ("dialog", "_default_");
     COLOR_FOCUS = mc_skin_color_get ("dialog", "dfocus");
diff --git a/lib/stat-size.h b/lib/stat-size.h
index 8930bb5c5..cc8ec121a 100644
--- a/lib/stat-size.h
+++ b/lib/stat-size.h
@@ -81,12 +81,6 @@
   /* HP-UX counts st_blocks in 1024-byte units.
      This loses when mixing HP-UX and BSD file systems with NFS.  */
 #define ST_NBLOCKSIZE 1024
-#else /* !hpux */
-#if defined _CRAY
-#define ST_NBLOCKS(statbuf) \
-  (S_ISREG ((statbuf).st_mode) || S_ISDIR ((statbuf).st_mode) \
-   ? (statbuf).st_blocks * ST_BLKSIZE (statbuf) / ST_NBLOCKSIZE : 0)
-#endif
 #endif
 #endif
 
diff --git a/lib/strutil/strutilutf8.c b/lib/strutil/strutilutf8.c
index efec6be54..5ac0015e6 100644
--- a/lib/strutil/strutilutf8.c
+++ b/lib/strutil/strutilutf8.c
@@ -70,7 +70,7 @@ str_unichar_iscombiningmark (gunichar uni)
     GUnicodeType type;
 
     type = g_unichar_type (uni);
-    return (type == G_UNICODE_COMBINING_MARK)
+    return (type == G_UNICODE_SPACING_MARK)
         || (type == G_UNICODE_ENCLOSING_MARK) || (type == G_UNICODE_NON_SPACING_MARK);
 }
 
diff --git a/lib/strutil/xstrtol.c b/lib/strutil/xstrtol.c
index 070b3e6bb..cead495a8 100644
--- a/lib/strutil/xstrtol.c
+++ b/lib/strutil/xstrtol.c
@@ -176,6 +176,7 @@ xstrtoumax (const char *s, char **ptr, int base, uintmax_t * val, const char *va
                     break;
                 }
             }
+            break;
         default:
             break;
         }
diff --git a/lib/timer.c b/lib/timer.c
deleted file mode 100644
index 25e4af6ec..000000000
--- a/lib/timer.c
+++ /dev/null
@@ -1,114 +0,0 @@
-/*
-   Simple timer for the Midnight Commander.
-
-   Copyright (C) 2013-2020
-   Free Software Foundation, Inc.
-
-   Written by:
-   Andrew Borodin 2013
-
-   This file is part of the Midnight Commander.
-
-   The Midnight Commander is free software: you can redistribute it
-   and/or modify it under the terms of the GNU General Public License as
-   published by the Free Software Foundation, either version 3 of the License,
-   or (at your option) any later version.
-
-   The Midnight Commander is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program.  If not, see <http://www.gnu.org/licenses/>.
- */
-
-/** \file
- *  \brief Source: simple timer
- */
-
-#include <config.h>
-
-#include <sys/time.h>
-
-#include "lib/global.h"
-#include "lib/timer.h"
-
-/*** global variables ****************************************************************************/
-
-/**
- * mc_timer_t:
- *
- * Opaque datatype that records a start time.
- * #mc_timer_t records a start time, and counts microseconds elapsed since
- * that time.
- **/
-struct mc_timer_t
-{
-    guint64 start;
-};
-
-/*** file scope macro definitions ****************************************************************/
-
-/*** file scope type declarations ****************************************************************/
-
-/*** file scope variables ************************************************************************/
-
-/*** file scope functions ************************************************************************/
-
-/* --------------------------------------------------------------------------------------------- */
-/*** public functions ****************************************************************************/
-/* --------------------------------------------------------------------------------------------- */
-
-/**
- * Creates a new timer, and starts timing.
- *
- * @return: a new #mc_timer_t.
- **/
-mc_timer_t *
-mc_timer_new (void)
-{
-    mc_timer_t *timer;
-    struct timeval tv;
-
-    timer = g_new (mc_timer_t, 1);
-    gettimeofday (&tv, NULL);
-    timer->start = (guint64) tv.tv_sec * G_USEC_PER_SEC + (guint64) tv.tv_usec;
-
-    return timer;
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
-/**
- * Destroys a timer, freeing associated resources.
- *
- * @timer: an #mc_timer_t to destroy.
- **/
-void
-mc_timer_destroy (mc_timer_t * timer)
-{
-    g_free (timer);
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
-/**
- * Obtains the time since the timer was started.
- *
- * @timer: an #mc_timer_t.
- *
- * @return: microseconds elapsed, the time since the timer was started
- *
- **/
-guint64
-mc_timer_elapsed (const mc_timer_t * timer)
-{
-    struct timeval tv;
-
-    gettimeofday (&tv, NULL);
-
-    return ((guint64) tv.tv_sec * G_USEC_PER_SEC + (guint64) tv.tv_usec - timer->start);
-}
-
-/* --------------------------------------------------------------------------------------------- */
diff --git a/lib/timer.h b/lib/timer.h
deleted file mode 100644
index 4cc823260..000000000
--- a/lib/timer.h
+++ /dev/null
@@ -1,27 +0,0 @@
-/** \file timer.h
- *  \brief Header: simple timer
- */
-
-#ifndef MC_TIMER_H
-#define MC_TIMER_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-struct mc_timer_t;
-typedef struct mc_timer_t mc_timer_t;
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-mc_timer_t *mc_timer_new (void);
-void mc_timer_destroy (mc_timer_t * timer);
-guint64 mc_timer_elapsed (const mc_timer_t * timer);
-
-/*** inline functions **************************************************/
-
-#endif /* MC_TIMER_H */
diff --git a/lib/tty/tty-internal.h b/lib/tty/tty-internal.h
index 662b0bcaf..77546cd5f 100644
--- a/lib/tty/tty-internal.h
+++ b/lib/tty/tty-internal.h
@@ -42,6 +42,8 @@ char *mc_tty_normalize_from_utf8 (const char *);
 void tty_init_xterm_support (gboolean is_xterm);
 int tty_lowlevel_getch (void);
 
+void tty_colorize_area (int y, int x, int rows, int cols, int color);
+
 /*** inline functions ****************************************************************************/
 
 #endif /* MC_TTY_INTERNAL_H */
diff --git a/lib/tty/tty-ncurses.c b/lib/tty/tty-ncurses.c
index 4383d1e74..03235cd5b 100644
--- a/lib/tty/tty-ncurses.c
+++ b/lib/tty/tty-ncurses.c
@@ -48,6 +48,7 @@
 
 #include "tty-internal.h"       /* mc_tty_normalize_from_utf8() */
 #include "tty.h"
+#include "color.h"              /* tty_setcolor */
 #include "color-internal.h"
 #include "key.h"
 #include "mouse.h"
@@ -119,6 +120,44 @@ sigwinch_handler (int dummy)
     (void) n;
 }
 
+/* --------------------------------------------------------------------------------------------- */
+
+/**
+ * Get visible part of area.
+ *
+ * @returns TRUE if any part of area is in screen bounds, FALSE otherwise.
+ */
+static gboolean
+tty_clip (int *y, int *x, int *rows, int *cols)
+{
+    if (*y < 0)
+    {
+        *rows += *y;
+
+        if (*rows <= 0)
+            return FALSE;
+
+        *y = 0;
+    }
+
+    if (*x < 0)
+    {
+        *cols += *x;
+
+        if (*cols <= 0)
+            return FALSE;
+
+        *x = 0;
+    }
+
+    if (*y + *rows > LINES)
+        *rows = LINES - *y;
+    if (*x + *cols > COLS)
+        *cols = COLS - *x;
+
+    return TRUE;
+}
+
 /* --------------------------------------------------------------------------------------------- */
 /*** public functions ****************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -494,30 +533,8 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 {
     int i;
 
-    if (y < 0)
-    {
-        rows += y;
-
-        if (rows <= 0)
-            return;
-
-        y = 0;
-    }
-
-    if (x < 0)
-    {
-        cols += x;
-
-        if (cols <= 0)
-            return;
-
-        x = 0;
-    }
-
-    if (y + rows > LINES)
-        rows = LINES - y;
-    if (x + cols > COLS)
-        cols = COLS - x;
+    if (!tty_clip (&y, &x, &rows, &cols))
+        return;
 
     for (i = 0; i < rows; i++)
     {
@@ -533,6 +550,38 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_colorize_area (int y, int x, int rows, int cols, int color)
+{
+    cchar_t *ctext;
+    wchar_t wch[10];            /* TODO not sure if the length is correct */
+    attr_t attrs;
+    short color_pair;
+
+    if (!use_colors || !tty_clip (&y, &x, &rows, &cols))
+        return;
+
+    tty_setcolor (color);
+    ctext = g_malloc (sizeof (cchar_t) * (cols + 1));
+
+    for (int row = 0; row < rows; row++)
+    {
+        mvin_wchnstr (y + row, x, ctext, cols);
+
+        for (int col = 0; col < cols; col++)
+        {
+            getcchar (&ctext[col], wch, &attrs, &color_pair, NULL);
+            setcchar (&ctext[col], wch, attrs, color, NULL);
+        }
+
+        mvadd_wchnstr (y + row, x, ctext, cols);
+    }
+
+    g_free (ctext);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_set_alt_charset (gboolean alt_charset)
 {
diff --git a/lib/tty/tty-slang.c b/lib/tty/tty-slang.c
index 0d8e89ff7..6bf22a90d 100644
--- a/lib/tty/tty-slang.c
+++ b/lib/tty/tty-slang.c
@@ -622,6 +622,15 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_colorize_area (int y, int x, int rows, int cols, int color)
+{
+    if (use_colors)
+        SLsmg_set_color_in_region (color, y, x, rows, cols);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_set_alt_charset (gboolean alt_charset)
 {
diff --git a/lib/tty/tty.c b/lib/tty/tty.c
index a3929b011..874acc1b4 100644
--- a/lib/tty/tty.c
+++ b/lib/tty/tty.c
@@ -56,6 +56,7 @@
 
 #include "tty.h"
 #include "tty-internal.h"
+#include "color.h"              /* tty_set_normal_attrs() */
 #include "mouse.h"              /* use_mouse_p */
 #include "win.h"
 
@@ -264,6 +265,17 @@ tty_draw_box (int y, int x, int ys, int xs, gboolean single)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_draw_box_shadow (int y, int x, int rows, int cols, int shadow_color)
+{
+    /* draw right shadow */
+    tty_colorize_area (y + 1, x + cols, rows - 1, 2, shadow_color);
+    /* draw bottom shadow */
+    tty_colorize_area (y + rows, x + 2, 1, cols, shadow_color);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 char *
 mc_tty_normalize_from_utf8 (const char *str)
 {
@@ -312,6 +324,17 @@ tty_resize (int fd)
 
 /* --------------------------------------------------------------------------------------------- */
 
+/** Clear screen */
+void
+tty_clear_screen (void)
+{
+    tty_set_normal_attrs ();
+    tty_fill_region (0, 0, LINES, COLS, ' ');
+    tty_refresh ();
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_init_xterm_support (gboolean is_xterm)
 {
diff --git a/lib/tty/tty.h b/lib/tty/tty.h
index fb1d94da8..4eba8f58f 100644
--- a/lib/tty/tty.h
+++ b/lib/tty/tty.h
@@ -126,12 +126,16 @@ extern void tty_print_one_hline (gboolean single);
 extern void tty_draw_hline (int y, int x, int ch, int len);
 extern void tty_draw_vline (int y, int x, int ch, int len);
 extern void tty_draw_box (int y, int x, int rows, int cols, gboolean single);
+extern void tty_draw_box_shadow (int y, int x, int rows, int cols, int shadow_color);
 extern void tty_fill_region (int y, int x, int rows, int cols, unsigned char ch);
 
 extern int tty_resize (int fd);
 extern void tty_refresh (void);
 extern void tty_change_screen_size (void);
 
+/* Clear screen */
+extern void tty_clear_screen (void);
+
 extern int mc_tty_normalize_lines_char (const char *);
 
 extern void tty_enter_ca_mode (void);
diff --git a/lib/util.c b/lib/util.c
index 1a9bfd16f..fe678bda5 100644
--- a/lib/util.c
+++ b/lib/util.c
@@ -51,7 +51,6 @@
 #include "lib/vfs/vfs.h"
 #include "lib/strutil.h"
 #include "lib/util.h"
-#include "lib/timer.h"
 
 /*** global variables ****************************************************************************/
 
@@ -664,7 +663,7 @@ x_basename (const char *s)
     {
         /* avoid trailing PATH_SEP, if present */
         if (!IS_PATH_SEP (s[strlen (s) - 1]))
-            return (path_sep != NULL) ? path_sep + 1 : s;
+            return path_sep + 1;
 
         while (--path_sep > s && !IS_PATH_SEP (*path_sep))
             ;
@@ -783,6 +782,7 @@ strip_ctrl_codes (char *s)
                             r = new_r + 1;
                             goto osc_out;
                         }
+                        break;
                     default:
                         break;
                     }
@@ -1513,16 +1513,16 @@ mc_replace_error (GError ** dest, int code, const char *format, ...)
  * and if it has then updates the timestamp.
  *
  * @param timestamp the last timestamp in microseconds, updated if the given time elapsed
- * @param deleay amount of time in microseconds
+ * @param delay amount of time in microseconds
 
  * @return TRUE if clock skew detected, FALSE otherwise
  */
 gboolean
-mc_time_elapsed (guint64 * timestamp, guint64 delay)
+mc_time_elapsed (gint64 * timestamp, gint64 delay)
 {
-    guint64 now;
+    gint64 now;
 
-    now = mc_timer_elapsed (mc_global.timer);
+    now = g_get_real_time ();
 
     if (now >= *timestamp && now < *timestamp + delay)
         return FALSE;
diff --git a/lib/util.h b/lib/util.h
index 46ac1f0b4..efe386bee 100644
--- a/lib/util.h
+++ b/lib/util.h
@@ -38,6 +38,22 @@
 #define MC_PIPE_ERROR_CREATE_PIPE_STREAM -4
 #define MC_PIPE_ERROR_READ -5
 
+/* gnulib efa15594e17fc20827dba66414fb391e99905394
+
+ *_GL_CMP (n1, n2) performs a three-valued comparison on n1 vs. n2.
+ *  It returns
+ *    1  if n1 > n2
+ *    0  if n1 == n2
+ *    -1 if n1 < n2
+ *  The native code   (n1 > n2 ? 1 : n1 < n2 ? -1 : 0)  produces a conditional
+ *  jump with nearly all GCC versions up to GCC 10.
+ *  This variant      (n1 < n2 ? -1 : n1 > n2)  produces a conditional with many
+ *  GCC versions up to GCC 9.
+ *  The better code  (n1 > n2) - (n1 < n2)  from Hacker's Delight para 2-9
+ *  avoids conditional jumps in all GCC versions >= 3.4.
+ */
+#define _GL_CMP(n1, n2) (((n1) > (n2)) - ((n1) < (n2)))
+
 /*** enums ***************************************************************************************/
 
 /* Pathname canonicalization */
@@ -256,7 +272,7 @@ void mc_propagate_error (GError ** dest, int code, const char *format, ...) G_GN
 void mc_replace_error (GError ** dest, int code, const char *format, ...) G_GNUC_PRINTF (3, 4);
 /* *INDENT-ON* */
 
-gboolean mc_time_elapsed (guint64 * timestamp, guint64 delay);
+gboolean mc_time_elapsed (gint64 * timestamp, gint64 delay);
 
 /*** inline functions **************************************************/
 
diff --git a/lib/utilunix.c b/lib/utilunix.c
index bbcf86b78..d1dc91734 100644
--- a/lib/utilunix.c
+++ b/lib/utilunix.c
@@ -715,11 +715,14 @@ tilde_expand (const char *directory)
 void
 open_error_pipe (void)
 {
+    int error_fd = -1;
+
     if (pipe (error_pipe) < 0)
         message (D_NORMAL, _("Warning"), _("Pipe failed"));
 
     old_error = dup (STDERR_FILENO);
-    if (old_error < 0 || close (STDERR_FILENO) != 0 || dup (error_pipe[1]) != STDERR_FILENO)
+    if (old_error < 0 || close (STDERR_FILENO) != 0
+        || (error_fd = dup (error_pipe[1])) != STDERR_FILENO)
     {
         message (D_NORMAL, _("Warning"), _("Dup failed"));
 
@@ -749,6 +752,8 @@ open_error_pipe (void)
             }
         }
     }
+    if (error_fd >= 0)
+        close (error_fd);
     /* we never write there */
     close (error_pipe[1]);
     error_pipe[1] = -1;
diff --git a/lib/vfs/direntry.c b/lib/vfs/direntry.c
index 87e71a660..d2211ea5b 100644
--- a/lib/vfs/direntry.c
+++ b/lib/vfs/direntry.c
@@ -70,7 +70,6 @@
 
 #include "lib/tty/tty.h"        /* enable/disable interrupt key */
 #include "lib/util.h"           /* custom_canonicalize_pathname() */
-#include "lib/timer.h"
 #if 0
 #include "lib/widget.h"         /* message() */
 #endif
@@ -453,10 +452,10 @@ vfs_s_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 vfs_s_readdir (void *data)
 {
-    static union vfs_dirent dir;
+    struct vfs_dirent *dir = NULL;
     struct dirhandle *info = (struct dirhandle *) data;
     const char *name;
 
@@ -465,13 +464,13 @@ vfs_s_readdir (void *data)
 
     name = VFS_ENTRY (info->cur->data)->name;
     if (name != NULL)
-        g_strlcpy (dir.dent.d_name, name, MC_MAXPATHLEN);
+        dir = vfs_dirent_init (NULL, name, 0);
     else
         vfs_die ("Null in structure-cannot happen");
 
     info->cur = g_list_next (info->cur);
 
-    return (void *) &dir;
+    return dir;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -863,7 +862,7 @@ vfs_s_free (vfsid id)
 static gboolean
 vfs_s_dir_uptodate (struct vfs_class *me, struct vfs_s_inode *ino)
 {
-    guint64 tim;
+    gint64 tim;
 
     if (me->flush)
     {
@@ -871,7 +870,7 @@ vfs_s_dir_uptodate (struct vfs_class *me, struct vfs_s_inode *ino)
         return 0;
     }
 
-    tim = mc_timer_elapsed (mc_global.timer);
+    tim = g_get_real_time ();
 
     return (tim < ino->timestamp);
 }
diff --git a/lib/vfs/gc.c b/lib/vfs/gc.c
index 5090aaacb..d0bad1f91 100644
--- a/lib/vfs/gc.c
+++ b/lib/vfs/gc.c
@@ -44,7 +44,6 @@
 #include "lib/global.h"
 #include "lib/event.h"
 #include "lib/util.h"           /* MC_PTR_FREE */
-#include "lib/timer.h"
 
 #include "vfs.h"
 #include "utilvfs.h"
@@ -98,7 +97,7 @@ struct vfs_stamping
 {
     struct vfs_class *v;
     vfsid id;
-    guint64 time;
+    gint64 time;
 };
 
 /*** file scope variables ************************************************************************/
@@ -130,7 +129,7 @@ vfs_addstamp (struct vfs_class *v, vfsid id)
         stamp = g_new (struct vfs_stamping, 1);
         stamp->v = v;
         stamp->id = id;
-        stamp->time = mc_timer_elapsed (mc_global.timer);
+        stamp->time = g_get_real_time ();
 
         stamps = g_slist_append (stamps, stamp);
     }
@@ -153,7 +152,7 @@ vfs_stamp (struct vfs_class *v, vfsid id)
     stamp = g_slist_find_custom (stamps, &what, vfs_stamp_compare);
     if (stamp != NULL && stamp->data != NULL)
     {
-        VFS_STAMPING (stamp->data)->time = mc_timer_elapsed (mc_global.timer);
+        VFS_STAMPING (stamp->data)->time = g_get_real_time ();
         ret = TRUE;
     }
 
@@ -239,7 +238,7 @@ void
 vfs_expire (gboolean now)
 {
     static gboolean locked = FALSE;
-    guint64 curr_time, exp_time;
+    gint64 curr_time, exp_time;
     GSList *stamp;
 
     /* Avoid recursive invocation, e.g. when one of the free functions
@@ -248,7 +247,7 @@ vfs_expire (gboolean now)
         return;
     locked = TRUE;
 
-    curr_time = mc_timer_elapsed (mc_global.timer);
+    curr_time = g_get_real_time ();
     exp_time = curr_time - vfs_timeout * G_USEC_PER_SEC;
 
     if (now)
diff --git a/lib/vfs/interface.c b/lib/vfs/interface.c
index ca29653a2..6c4d9fde0 100644
--- a/lib/vfs/interface.c
+++ b/lib/vfs/interface.c
@@ -62,12 +62,10 @@
 /* TODO: move it to separate private .h */
 extern GString *vfs_str_buffer;
 extern vfs_class *current_vfs;
-extern struct dirent *mc_readdir_result;
+extern struct vfs_dirent *mc_readdir_result;
 
 /*** global variables ****************************************************************************/
 
-struct dirent *mc_readdir_result = NULL;
-
 /*** file scope macro definitions ****************************************************************/
 
 /*** file scope type declarations ****************************************************************/
@@ -458,30 +456,15 @@ mc_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-struct dirent *
+struct vfs_dirent *
 mc_readdir (DIR * dirp)
 {
     int handle;
     struct vfs_class *vfs;
     void *fsinfo = NULL;
-    struct dirent *entry = NULL;
+    struct vfs_dirent *entry = NULL;
     vfs_path_element_t *vfs_path_element;
 
-    if (mc_readdir_result == NULL)
-    {
-        /* We can't just allocate struct dirent as (see man dirent.h)
-         * struct dirent has VERY nonnaive semantics of allocating
-         * d_name in it. Moreover, linux's glibc-2.9 allocates dirents _less_,
-         * than 'sizeof (struct dirent)' making full bitwise (sizeof dirent) copy
-         * heap corrupter. So, allocate longliving dirent with at least
-         * (MAXNAMLEN + 1) for d_name in it.
-         * Strictly saying resulting dirent is unusable as we don't adjust internal
-         * structures, holding dirent size. But we don't use it in libc infrastructure.
-         * TODO: to make simpler homemade dirent-alike structure.
-         */
-        mc_readdir_result = (struct dirent *) g_malloc (sizeof (struct dirent) + MAXNAMLEN + 1);
-    }
-
     if (dirp == NULL)
     {
         errno = EFAULT;
@@ -507,8 +490,8 @@ mc_readdir (DIR * dirp)
 #else
         g_string_assign (vfs_str_buffer, entry->d_name);
 #endif
-        mc_readdir_result->d_ino = entry->d_ino;
-        g_strlcpy (mc_readdir_result->d_name, vfs_str_buffer->str, MAXNAMLEN + 1);
+        vfs_dirent_assign (mc_readdir_result, vfs_str_buffer->str, entry->d_ino);
+        vfs_dirent_free (entry);
     }
     if (entry == NULL)
         errno = vfs->readdir ? vfs_ferrno (vfs) : E_NOTSUPP;
diff --git a/lib/vfs/vfs.c b/lib/vfs/vfs.c
index 0b948846c..b21cd866e 100644
--- a/lib/vfs/vfs.c
+++ b/lib/vfs/vfs.c
@@ -69,13 +69,14 @@
 #include "gc.h"
 
 /* TODO: move it to the separate .h */
-extern struct dirent *mc_readdir_result;
+extern struct vfs_dirent *mc_readdir_result;
 extern GPtrArray *vfs__classes_list;
 extern GString *vfs_str_buffer;
 extern vfs_class *current_vfs;
 
 /*** global variables ****************************************************************************/
 
+struct vfs_dirent *mc_readdir_result = NULL;
 GPtrArray *vfs__classes_list = NULL;
 GString *vfs_str_buffer = NULL;
 vfs_class *current_vfs = NULL;
@@ -469,6 +470,7 @@ vfs_init (void)
 
     vfs_str_buffer = g_string_new ("");
 
+    mc_readdir_result = vfs_dirent_init (NULL, "", -1);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -518,10 +520,70 @@ vfs_shut (void)
     vfs_str_buffer = NULL;
     current_vfs = NULL;
     vfs_free_handle_list = -1;
-    MC_PTR_FREE (mc_readdir_result);
+    vfs_dirent_free (mc_readdir_result);
+    mc_readdir_result = NULL;
 }
 
 /* --------------------------------------------------------------------------------------------- */
+/**
+  * Init or create vfs_dirent structure
+  *
+  * @d vfs_dirent structure to init. If NULL, new structure is created.
+  * @fname file name
+  * @ino file inode number
+  *
+  * @return pointer to d if d isn't NULL, or pointer to newly created structure.
+  */
+
+struct vfs_dirent *
+vfs_dirent_init (struct vfs_dirent *d, const char *fname, ino_t ino)
+{
+    struct vfs_dirent *ret = d;
+
+    if (ret == NULL)
+        ret = g_new0 (struct vfs_dirent, 1);
+
+    if (ret->d_name_str == NULL)
+        ret->d_name_str = g_string_sized_new (MC_MAXFILENAMELEN);
+
+    vfs_dirent_assign (ret, fname, ino);
+
+    return ret;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+/**
+  * Assign members of vfs_dirent structure
+  *
+  * @d vfs_dirent structure for assignment
+  * @fname file name
+  * @ino file inode number
+  */
+
+void
+vfs_dirent_assign (struct vfs_dirent *d, const char *fname, ino_t ino)
+{
+    g_string_assign (d->d_name_str, fname);
+    d->d_name = d->d_name_str->str;
+    d->d_ino = ino;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+/**
+  * Destroy vfs_dirent structure
+  *
+  * @d vfs_dirent structure to destroy.
+  */
+
+void
+vfs_dirent_free (struct vfs_dirent *d)
+{
+    g_string_free (d->d_name_str, TRUE);
+    g_free (d);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 /**
  * These ones grab information from the VFS
  *  and handles them to an upper layer
diff --git a/lib/vfs/vfs.h b/lib/vfs/vfs.h
index a1d4bf949..2b0e6fb4c 100644
--- a/lib/vfs/vfs.h
+++ b/lib/vfs/vfs.h
@@ -9,7 +9,7 @@
 
 #include <sys/types.h>
 #include <sys/stat.h>
-#include <dirent.h>
+#include <dirent.h>             /* DIR */
 #ifdef HAVE_UTIMENSAT
 #include <sys/time.h>
 #elif defined (HAVE_UTIME_H)
@@ -20,7 +20,6 @@
 #include <stddef.h>
 
 #include "lib/global.h"
-#include "lib/fs.h"             /* MC_MAXPATHLEN */
 
 #include "path.h"
 
@@ -172,7 +171,7 @@ typedef struct vfs_class
     ssize_t (*write) (void *vfs_info, const char *buf, size_t count);
 
     void *(*opendir) (const vfs_path_t * vpath);
-    void *(*readdir) (void *vfs_info);
+    struct vfs_dirent *(*readdir) (void *vfs_info);
     int (*closedir) (void *vfs_info);
 
     int (*stat) (const vfs_path_t * vpath, struct stat * buf);
@@ -211,13 +210,17 @@ typedef struct vfs_class
 } vfs_class;
 
 /*
- * This union is used to ensure that there is enough space for the
- * filename (d_name) when the dirent structure is created.
+ * This struct is used instead of standard dirent to hold file name of any length
+ * (not limited to NAME_MAX).
  */
-union vfs_dirent
+struct vfs_dirent
 {
-    struct dirent dent;
-    char _extra_buffer[offsetof (struct dirent, d_name) + MC_MAXPATHLEN + 1];
+    /* private */
+    GString *d_name_str;
+
+    /* public */
+    ino_t d_ino;
+    char *d_name;               /* Alias of d_name_str->str */
 };
 
 /*** global variables defined in .c file *********************************************************/
@@ -278,6 +281,10 @@ void vfs_stamp_path (const vfs_path_t * path);
 
 void vfs_release_path (const vfs_path_t * vpath);
 
+struct vfs_dirent *vfs_dirent_init (struct vfs_dirent *d, const char *fname, ino_t ino);
+void vfs_dirent_assign (struct vfs_dirent *d, const char *fname, ino_t ino);
+void vfs_dirent_free (struct vfs_dirent *d);
+
 void vfs_fill_names (fill_names_f);
 
 /* *INDENT-OFF* */
@@ -309,7 +316,7 @@ int mc_readlink (const vfs_path_t * vpath, char *buf, size_t bufsiz);
 int mc_close (int handle);
 off_t mc_lseek (int fd, off_t offset, int whence);
 DIR *mc_opendir (const vfs_path_t * vpath);
-struct dirent *mc_readdir (DIR * dirp);
+struct vfs_dirent *mc_readdir (DIR * dirp);
 int mc_closedir (DIR * dir);
 int mc_stat (const vfs_path_t * vpath, struct stat *buf);
 int mc_mknod (const vfs_path_t * vpath, mode_t mode, dev_t dev);
diff --git a/lib/vfs/xdirentry.h b/lib/vfs/xdirentry.h
index 7b6410e74..56ce843a3 100644
--- a/lib/vfs/xdirentry.h
+++ b/lib/vfs/xdirentry.h
@@ -91,7 +91,7 @@ struct vfs_s_inode
     struct stat st;             /* Parameters of this inode */
     char *linkname;             /* Symlink's contents */
     char *localname;            /* Filename of local file, if we have one */
-    guint64 timestamp;          /* Subclass specific */
+    gint64 timestamp;           /* Subclass specific */
     off_t data_offset;          /* Subclass specific */
 };
 
diff --git a/lib/widget/dialog-switch.c b/lib/widget/dialog-switch.c
index 62ab23ce0..93868b19d 100644
--- a/lib/widget/dialog-switch.c
+++ b/lib/widget/dialog-switch.c
@@ -312,16 +312,6 @@ dialog_switch_shutdown (void)
 
 /* --------------------------------------------------------------------------------------------- */
 
-void
-clr_scr (void)
-{
-    tty_set_normal_attrs ();
-    tty_fill_region (0, 0, LINES, COLS, ' ');
-    tty_refresh ();
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
 void
 repaint_screen (void)
 {
diff --git a/lib/widget/dialog-switch.h b/lib/widget/dialog-switch.h
index dd5a1633b..4f814fa6d 100644
--- a/lib/widget/dialog-switch.h
+++ b/lib/widget/dialog-switch.h
@@ -28,8 +28,6 @@ int dialog_switch_process_pending (void);
 void dialog_switch_got_winch (void);
 void dialog_switch_shutdown (void);
 
-/* Clear screen */
-void clr_scr (void);
 void repaint_screen (void);
 void mc_refresh (void);
 void dialog_change_screen_size (void);
diff --git a/lib/widget/dialog.c b/lib/widget/dialog.c
index 57813750c..b8a08f029 100644
--- a/lib/widget/dialog.c
+++ b/lib/widget/dialog.c
@@ -121,7 +121,7 @@ refresh_cmd (void)
     mc_refresh ();
 #else
     /* Use this if the refreshes fail */
-    clr_scr ();
+    tty_clear_screen ();
     repaint_screen ();
 #endif /* HAVE_SLANG */
 }
@@ -206,6 +206,8 @@ dlg_handle_key (WDialog * h, int d_key)
     long command;
 
     command = widget_lookup_key (WIDGET (h), d_key);
+    if (command == CK_IgnoreKey)
+        command = keybind_lookup_keymap_command (dialog_map, d_key);
     if (command != CK_IgnoreKey)
         return dlg_execute_cmd (h, command);
 
diff --git a/lib/widget/dialog.h b/lib/widget/dialog.h
index 27dacaa7c..1d08b8e1a 100644
--- a/lib/widget/dialog.h
+++ b/lib/widget/dialog.h
@@ -13,6 +13,7 @@
 
 #include "lib/global.h"
 #include "lib/hook.h"           /* hook_t */
+#include "lib/keybind.h"        /* global_keymap_t */
 
 /*** typedefs(not structures) and defined constants **********************************************/
 
diff --git a/lib/widget/frame.c b/lib/widget/frame.c
index 1f4f14d8a..5d5a5acdf 100644
--- a/lib/widget/frame.c
+++ b/lib/widget/frame.c
@@ -76,6 +76,9 @@ frame_draw (const WFrame * f)
 
     colors = widget_get_colors (w);
 
+    if (mc_global.tty.shadows)
+        tty_draw_box_shadow (w->y, w->x, w->lines, w->cols, SHADOW_COLOR);
+
     tty_setcolor (colors[FRAME_COLOR_NORMAL]);
     tty_fill_region (w->y, w->x, w->lines, w->cols, ' ');
     tty_draw_box (w->y + d, w->x + d, w->lines - 2 * d, w->cols - 2 * d, f->single);
diff --git a/lib/widget/input.c b/lib/widget/input.c
index b5cec7e6b..471715c25 100644
--- a/lib/widget/input.c
+++ b/lib/widget/input.c
@@ -941,12 +941,12 @@ input_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
     {
     case MSG_MOUSE_DOWN:
         widget_select (w);
-        in->first = FALSE;
 
         if (event->x >= w->cols - HISTORY_BUTTON_WIDTH && should_show_history_button (in))
             do_show_hist (in);
         else
         {
+            in->first = FALSE;
             input_mark_cmd (in, FALSE);
             input_set_point (in, input_screen_to_point (in, event->x));
             /* save point for the possible following MSG_MOUSE_DRAG action */
@@ -1146,18 +1146,22 @@ input_handle_char (WInput * in, int key)
             port_region_marked_for_delete (in);
         input_complete_free (in);
         v = insert_char (in, key);
+        input_update (in, TRUE);
     }
     else
     {
+        gboolean keep_first;
+
         if (command != CK_Complete)
             input_complete_free (in);
         input_execute_cmd (in, command);
         v = MSG_HANDLED;
-        if (in->first)
-            input_update (in, TRUE);    /* needed to clear in->first */
+        /* if in->first == TRUE and history or completion window was cancelled,
+           keep "first" state */
+        keep_first = in->first && (command == CK_History || command == CK_Complete);
+        input_update (in, !keep_first);
     }
 
-    input_update (in, TRUE);
     return v;
 }
 
@@ -1244,6 +1248,9 @@ input_update (WInput * in, gboolean clear_first)
     if (w->owner == NULL || !widget_get_state (WIDGET (w->owner), WST_ACTIVE))
         return;
 
+    if (clear_first)
+        in->first = FALSE;
+
     if (should_show_history_button (in))
         has_history = HISTORY_BUTTON_WIDTH;
 
@@ -1325,9 +1332,6 @@ input_update (WInput * in, gboolean clear_first)
                 str_cnext_char (&cp);
         }
     }
-
-    if (clear_first)
-        in->first = FALSE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/lib/widget/input_complete.c b/lib/widget/input_complete.c
index 59a994d62..c23fe6063 100644
--- a/lib/widget/input_complete.c
+++ b/lib/widget/input_complete.c
@@ -139,7 +139,7 @@ filename_completion_function (const char *text, int state, input_complete_t flag
     static vfs_path_t *dirname_vpath = NULL;
 
     gboolean isdir = TRUE, isexec = FALSE;
-    struct dirent *entry = NULL;
+    struct vfs_dirent *entry = NULL;
 
     SHOW_C_CTX ("filename_completion_function");
 
diff --git a/lib/widget/menu.c b/lib/widget/menu.c
index ca2ff472a..271832e9d 100644
--- a/lib/widget/menu.c
+++ b/lib/widget/menu.c
@@ -187,6 +187,10 @@ menubar_draw_drop (const WMenuBar * menubar)
     if (column + menu->max_entry_len + 5 > (gsize) w->cols)
         column = w->cols - menu->max_entry_len - 5;
 
+    if (mc_global.tty.shadows)
+        tty_draw_box_shadow (w->y + 1, w->x + column, count + 2, menu->max_entry_len + 5,
+                             SHADOW_COLOR);
+
     tty_setcolor (MENU_ENTRY_COLOR);
     tty_draw_box (w->y + 1, w->x + column, count + 2, menu->max_entry_len + 5, FALSE);
 
diff --git a/lib/widget/widget-common.c b/lib/widget/widget-common.c
index 405269ff9..e2fcd1222 100644
--- a/lib/widget/widget-common.c
+++ b/lib/widget/widget-common.c
@@ -798,13 +798,9 @@ mouse_get_local (const Gpm_Event * global, const Widget * w)
 {
     Gpm_Event local;
 
+    memset (&local, 0, sizeof (local));
+
     local.buttons = global->buttons;
-#ifdef HAVE_LIBGPM
-    local.clicks = 0;
-    local.margin = 0;
-    local.modifiers = 0;
-    local.vc = 0;
-#endif
     local.x = global->x - w->x;
     local.y = global->y - w->y;
     local.type = global->type;
diff --git a/lib/widget/wtools.c b/lib/widget/wtools.c
index 00cc50df7..5c5dc4487 100644
--- a/lib/widget/wtools.c
+++ b/lib/widget/wtools.c
@@ -583,17 +583,17 @@ void
 status_msg_init (status_msg_t * sm, const char *title, double delay, status_msg_cb init_cb,
                  status_msg_update_cb update_cb, status_msg_cb deinit_cb)
 {
-    guint64 start;
+    gint64 start;
 
     /* repaint screen to remove previous finished dialog */
     mc_refresh ();
 
-    start = mc_timer_elapsed (mc_global.timer);
+    start = g_get_real_time ();
 
     sm->dlg = dlg_create (TRUE, 0, 0, 7, MIN (MAX (40, COLS / 2), COLS), WPOS_CENTER, FALSE,
                           dialog_colors, NULL, NULL, NULL, title);
     sm->start = start;
-    sm->delay = (guint64) (delay * G_USEC_PER_SEC);
+    sm->delay = (gint64) (delay * G_USEC_PER_SEC);
     sm->block = FALSE;
 
     sm->init = init_cb;
@@ -658,7 +658,7 @@ status_msg_common_update (status_msg_t * sm)
         /* dialog is not shown yet */
 
         /* do not change sm->start */
-        guint64 start = sm->start;
+        gint64 start = sm->start;
 
         if (mc_time_elapsed (&start, sm->delay))
             dlg_init (sm->dlg);
diff --git a/lib/widget/wtools.h b/lib/widget/wtools.h
index 3dbaef15f..cd0bc3253 100644
--- a/lib/widget/wtools.h
+++ b/lib/widget/wtools.h
@@ -5,8 +5,6 @@
 #ifndef MC__WTOOLS_H
 #define MC__WTOOLS_H
 
-#include "lib/timer.h"
-
 /*** typedefs(not structures) and defined constants **********************************************/
 
 /* Pass this as def_text to request a password */
@@ -42,8 +40,8 @@ enum
 struct status_msg_t
 {
     WDialog *dlg;               /* pointer to status message dialog */
-    guint64 start;              /* start time in microseconds */
-    guint64 delay;              /* delay before raise the 'dlg' in microseconds */
+    gint64 start;               /* start time in microseconds */
+    gint64 delay;               /* delay before raise the 'dlg' in microseconds */
     gboolean block;             /* how to get event using tty_get_event() */
 
     status_msg_cb init;         /* callback to init derived classes */
diff --git a/m4.include/gnulib/fsusage.m4 b/m4.include/gnulib/fsusage.m4
index 6c104fc5a..c15cfca4d 100644
--- a/m4.include/gnulib/fsusage.m4
+++ b/m4.include/gnulib/fsusage.m4
@@ -1,7 +1,7 @@
-# serial 34
+# serial 35
 # Obtaining file system usage information.
 
-# Copyright (C) 1997-1998, 2000-2001, 2003-2017 Free Software Foundation, Inc.
+# Copyright (C) 1997-1998, 2000-2001, 2003-2020 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -36,7 +36,6 @@ AC_DEFUN([gl_FILE_SYSTEM_USAGE],
   dnl Mac OS X >= 10.5 (32-bit mode).
   AC_REQUIRE([AC_SYS_LARGEFILE])
 
-  AC_MSG_CHECKING([how to get file system space usage])
   ac_fsusage_space=no
 
   # Perform only the link test since it seems there are no variants of the
diff --git a/m4.include/gnulib/mountlist.m4 b/m4.include/gnulib/mountlist.m4
index a95c1f4bd..2705c60a9 100644
--- a/m4.include/gnulib/mountlist.m4
+++ b/m4.include/gnulib/mountlist.m4
@@ -1,4 +1,4 @@
-# serial 13
+# serial 14
 dnl Copyright (C) 2002-2006, 2009-2019 Free Software Foundation, Inc.
 dnl This file is free software; the Free Software Foundation
 dnl gives unlimited permission to copy and/or distribute it,
@@ -244,7 +244,7 @@ extern
 "C"
 #endif
 int getmntinfo (struct statfs **, int);
-              ]], [])],
+              ]], [[]])],
            [fu_cv_sys_mounted_getmntinfo2=no],
            [fu_cv_sys_mounted_getmntinfo2=yes])
         ])
diff --git a/m4.include/gnulib/stat-size.m4 b/m4.include/gnulib/stat-size.m4
index 86d409864..95f482873 100644
--- a/m4.include/gnulib/stat-size.m4
+++ b/m4.include/gnulib/stat-size.m4
@@ -1,6 +1,6 @@
 #serial 1
 
-# Copyright (C) 2011-2016 Free Software Foundation, Inc.
+# Copyright (C) 2011-2020 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -9,6 +9,6 @@
 AC_DEFUN([gl_STAT_SIZE],
 [
   # Don't call AC_STRUCT_ST_BLOCKS because it causes bugs.  Details at
-  # http://lists.gnu.org/archive/html/bug-gnulib/2011-06/msg00051.html
+  # https://lists.gnu.org/r/bug-gnulib/2011-06/msg00051.html
   AC_CHECK_HEADERS_ONCE([sys/param.h])
 ])
diff --git a/misc/ext.d/archive.sh b/misc/ext.d/archive.sh
index afe8a0609..840fd4717 100755
--- a/misc/ext.d/archive.sh
+++ b/misc/ext.d/archive.sh
@@ -146,6 +146,9 @@ do_view_action() {
     zoo)
         zoo l "${MC_EXT_FILENAME}"
         ;;
+    wim)
+        wimlib-imagex info "${MC_EXT_FILENAME}" 2> /dev/null
+        ;;
     *)
         ;;
     esac
diff --git a/misc/ext.d/doc.sh.in b/misc/ext.d/doc.sh.in
index 871773c3a..72deae7dd 100644
--- a/misc/ext.d/doc.sh.in
+++ b/misc/ext.d/doc.sh.in
@@ -25,9 +25,9 @@ staroffice_console() {
 }
 
 get_ooffice_executable() {
-    if loffice >/dev/null 2>&1; then
+    if which loffice >/dev/null 2>&1; then
         echo "loffice"
-    elif ooffice >/dev/null 2>&1; then
+    elif which ooffice >/dev/null 2>&1; then
         echo "ooffice"
     else
         echo -n
@@ -52,28 +52,28 @@ do_view_action() {
         fi
         ;;
     msdoc)
-        if wvHtml >/dev/null 2>&1; then
+        if which wvHtml >/dev/null 2>&1; then
             tmp=`mktemp -d ${TMPDIR:-/tmp}/%p.XXXXXX`
             wvHtml "${MC_EXT_FILENAME}" --targetdir="$tmp" page.html
             elinks -dump "$tmp/page.html"
             rm -rf "$tmp"
-        elif antiword >/dev/null 2>&1; then
+        elif which antiword >/dev/null 2>&1; then
             antiword -t "${MC_EXT_FILENAME}"
-        elif catdoc >/dev/null 2>&1; then
+        elif which catdoc >/dev/null 2>&1; then
             catdoc -w "${MC_EXT_FILENAME}"
-        elif word2x >/dev/null 2>&1; then
+        elif which word2x >/dev/null 2>&1; then
             word2x -f text "${MC_EXT_FILENAME}" -
         else
             strings "${MC_EXT_FILENAME}"
         fi
         ;;
     msxls)
-        if xlhtml >/dev/null 2>&1; then
+        if which xlhtml >/dev/null 2>&1; then
             tmp=`mktemp -d ${TMPDIR:-/tmp}/%p.XXXXXX`
             xlhtml -a "${MC_EXT_FILENAME}" > "$tmp/page.html"
             elinks -dump "$tmp/page.html"
             rm -rf "$tmp"
-        elif xls2csv >/dev/null 2>&1; then
+        elif which xls2csv >/dev/null 2>&1; then
             xls2csv "${MC_EXT_FILENAME}"
         else
             strings "${MC_EXT_FILENAME}"
diff --git a/misc/ext.d/image.sh b/misc/ext.d/image.sh
index 583c09ecf..04307e01b 100755
--- a/misc/ext.d/image.sh
+++ b/misc/ext.d/image.sh
@@ -45,7 +45,7 @@ do_open_action() {
             else
                 (gqview "${MC_EXT_FILENAME}" &)
             fi
-        elif see >/dev/null 2>&1; then
+        elif which see >/dev/null 2>&1; then
             (see "${MC_EXT_FILENAME}" &)
         else
             (zgv "${MC_EXT_FILENAME}" &)
diff --git a/misc/ext.d/misc.sh.in b/misc/ext.d/misc.sh.in
index f4b0bd47b..32a5f3f8d 100644
--- a/misc/ext.d/misc.sh.in
+++ b/misc/ext.d/misc.sh.in
@@ -71,7 +71,7 @@ do_open_action() {
         sqlite3 "${MC_EXT_FILENAME}"
         ;;
     glade)
-        if glade-3 --version >/dev/null 2>&1; then
+        if which glade-3 >/dev/null 2>&1; then
             (glade-3 "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             (glade-2 "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
diff --git a/misc/ext.d/sound.sh b/misc/ext.d/sound.sh
index 760aaf1dd..c92b868ab 100755
--- a/misc/ext.d/sound.sh
+++ b/misc/ext.d/sound.sh
@@ -38,7 +38,7 @@ do_open_action() {
     case "${filetype}" in
     common)
         if [ -n "$DISPLAY" ]; then
-            (xmms  "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious  "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             play "${MC_EXT_FILENAME}"
         fi
@@ -52,21 +52,21 @@ do_open_action() {
         ;;
     mp3)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             mpg123 "${MC_EXT_FILENAME}"
         fi
         ;;
     ogg)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             ogg123 "${MC_EXT_FILENAME}"
         fi
         ;;
     opus)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             play "${MC_EXT_FILENAME}"
         fi
@@ -79,7 +79,7 @@ do_open_action() {
         ;;
     playlist)
         if [ -n "$DISPLAY" ]; then
-            (xmms -p "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious -p "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             mplayer -vo null -playlist "${MC_EXT_FILENAME}"
         fi
diff --git a/misc/ext.d/video.sh b/misc/ext.d/video.sh
index 979a50acc..9cba21020 100755
--- a/misc/ext.d/video.sh
+++ b/misc/ext.d/video.sh
@@ -13,7 +13,7 @@ do_view_action() {
 
     case "${filetype}" in
     *)
-        if mplayer >/dev/null 2>&1; then
+        if which mplayer >/dev/null 2>&1; then
             mplayer -identify -vo null -ao null -frames 0 "${MC_EXT_FILENAME}" 2>&1 | \
                 sed -n 's/^ID_//p'
         elif which mpv_identify.sh >/dev/null 2>&1; then
@@ -28,9 +28,9 @@ do_view_action() {
 do_open_action() {
     filetype=$1
 
-    if mpv >/dev/null 2>&1; then
+    if which mpv >/dev/null 2>&1; then
         PLAYER=mpv
-    elif mplayer >/dev/null 2>&1; then
+    elif which mplayer >/dev/null 2>&1; then
         PLAYER=mplayer
     else
         echo "Please install either mplayer or mpv to play this file"
diff --git a/misc/filehighlight.ini b/misc/filehighlight.ini
index ecf6ab87d..c4716a5c0 100644
--- a/misc/filehighlight.ini
+++ b/misc/filehighlight.ini
@@ -31,10 +31,10 @@
     extensions=7z;Z;ace;apk;arc;arj;ark;bz2;cab;cpio;deb;gz;lha;lz;lz4;lzh;lzma;rar;rpm;tar;tbz;tbz2;tgz;tlz;txz;tzst;xz;zip;zoo;zst
 
 [doc]
-    extensions=chm;css;ctl;diz;doc;docm;docx;dtd;htm;html;letter;lsm;mail;man;me;msg;nroff;odp;ods;odt;pdf;po;ppt;pptm;pptx;ps;rtf;sgml;shtml;tex;text;txt;xls;xlsm;xlsx;xml;xsd;xslt
+    extensions=chm;css;ctl;diz;doc;docm;docx;dtd;fodg;fodp;fods;fodt;htm;html;letter;lsm;mail;man;me;msg;nroff;odg;odp;ods;odt;pdf;po;ppt;pptm;pptx;ps;rtf;sgml;shtml;tex;text;txt;xls;xlsm;xlsx;xml;xsd;xslt
 
 [source]
-    extensions=ada;asm;awk;bash;c;caml;cc;cgi;cpp;cxx;diff;erl;go;h;hh;hi;hpp;hs;inc;jasm;jav;java;js;m4;mak;mjs;ml;mli;mll;mlp;mly;pas;patch;php;phps;pl;pm;prg;py;rb;s;sas;sh;sl;st;tcl;tk;xq
+    extensions=ada;asm;awk;bash;c;caml;cc;cgi;cpp;cxx;diff;erl;go;h;hh;hi;hpp;hs;inc;jasm;jav;java;js;m4;mak;mjs;ml;mli;mll;mlp;mly;pas;patch;php;phps;pl;pm;prg;py;rb;s;sas;sh;sl;st;swift;tcl;tk;xq
 
 [media]
     extensions=3gp;aac;ac3;ape;asf;avi;dts;flac;flv;it;m3u;m4a;m4v;med;mid;midi;mkv;mod;mol;mov;mp2;mp3;mp4;mpeg;mpg;mpl;ogg;ogv;opus;s3m;ts;umx;vob;wav;webm;wma;wmv;xm
diff --git a/misc/mc.default.keymap b/misc/mc.default.keymap
index d05e97e65..2931ddd0a 100644
--- a/misc/mc.default.keymap
+++ b/misc/mc.default.keymap
@@ -1,5 +1,5 @@
-[main]
-ChangePanel = tab
+[filemanager]
+ChangePanel = tab; ctrl-i
 Help = f1
 UserMenu = f2
 View = f3
@@ -57,7 +57,7 @@ ScreenList = alt-prime
 EditorViewerHistory = alt-shift-e
 ExtendedKeyMap = ctrl-x
 
-[main:xmap]
+[filemanager:xmap]
 ChangeMode = c
 ChangeOwn = o
 ChangeAttributes = e
diff --git a/misc/mc.emacs.keymap b/misc/mc.emacs.keymap
index 70935cd47..7cc305db7 100644
--- a/misc/mc.emacs.keymap
+++ b/misc/mc.emacs.keymap
@@ -1,5 +1,5 @@
-[main]
-ChangePanel = tab
+[filemanager]
+ChangePanel = tab; ctrl-i
 Help = f1
 UserMenu = f2
 View = f3
@@ -57,7 +57,7 @@ ScreenList = alt-prime
 EditorViewerHistory = alt-shift-e
 ExtendedKeyMap = ctrl-x
 
-[main:xmap]
+[filemanager:xmap]
 ChangeMode = c
 ChangeOwn = o
 ChangeAttributes = e
diff --git a/misc/mc.ext.in b/misc/mc.ext.in
index c938d0504..e9b475cde 100644
--- a/misc/mc.ext.in
+++ b/misc/mc.ext.in
@@ -176,6 +176,11 @@ type/^LHa\ .*archive
 	Open=%cd %p/ulha://
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lha
 
+# PAK
+type/^PAK\ .*archive
+	Open=%cd %p/unar://
+	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view pak
+
 # arj
 regex/i/\.a(rj|[0-9][0-9])$
 	Open=%cd %p/uarj://
@@ -361,16 +366,6 @@ shell/.info
 shell/i/.3gp
 	Include=video
 
-# Manual page
-regex/(([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])|\.man)$
-	Open=@EXTHELPERSDIR@/text.sh open man %var{PAGER:more}
-	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man %var{PAGER:more}
-
-# Perl pod page
-shell/.pod
-	Open=@EXTHELPERSDIR@/text.sh open pod %var{PAGER:more}
-	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view pod %var{PAGER:more}
-
 # Troff with me macros.
 # Exception - "read.me" is not a nroff file.
 shell/read.me
@@ -387,18 +382,28 @@ shell/.ms
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view nroff.ms %var{PAGER:more}
 
 # Manual page - compressed
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.g?[Zz]$
+type/^(ASCII )?troff.*gzip compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.gz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.gz %var{PAGER:more}
 
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.bz$
+type/^(ASCII )?troff.*bzip compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.bz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.bz %var{PAGER:more}
 
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.bz2$
+type/^(ASCII )?troff.*bzip2 compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.bz2 %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.bz2 %var{PAGER:more}
 
+# Manual page
+type/^(ASCII )?troff
+	Open=@EXTHELPERSDIR@/text.sh open man %var{PAGER:more}
+	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man %var{PAGER:more}
+
+# Perl pod page
+shell/.pod
+	Open=@EXTHELPERSDIR@/text.sh open pod %var{PAGER:more}
+	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view pod %var{PAGER:more}
+
 regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.lz$
 	Open=@EXTHELPERSDIR@/text.sh open man.lz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.lz %var{PAGER:more}
@@ -590,7 +595,7 @@ shell/.sdw
 	Open=@EXTHELPERSDIR@/doc.sh open ooffice
 
 # StarOffice 6 and OpenOffice.org formats
-regex/i/\.(odt|ott|sxw|stw|ods|ots|sxc|stc|odp|otp|sxi|sti|odg|otg|sxd|std|odb|odf|sxm|odm|sxg)$
+regex/i/\.(odt|fodt|ott|sxw|stw|ods|fods|ots|sxc|stc|odp|fodp|otp|sxi|sti|odg|fodg|otg|sxd|std|odb|odf|sxm|odm|sxg)$
 	Open=@EXTHELPERSDIR@/doc.sh open ooffice
 	View=%view{ascii} @EXTHELPERSDIR@/doc.sh view odt
 
@@ -671,10 +676,6 @@ regex/i/\.(epub|mobi)$
 shell/.class
 	View=%view{ascii} @EXTHELPERSDIR@/misc.sh view javaclass
 
-# Makefile
-regex/^[Mm]akefile$
-	Open=make -f %f %{Enter parameters}
-
 # Imakefile
 shell/Imakefile
 	Open=xmkmf -a
@@ -683,6 +684,10 @@ shell/Imakefile
 regex/^Makefile\.(PL|pl)$
 	Open=%var{PERL:perl} %f
 
+# Makefile
+regex/[Mm]akefile
+	Open=make -f %f %{Enter parameters}
+
 # sqlite3.db
 type/^SQLite 3.x database
 	Open=@EXTHELPERSDIR@/misc.sh open sqlite
@@ -761,38 +766,27 @@ shell/i/.zoo
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view zoo
 
 # gzip
-type/^gzip
+type/\(gzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view gz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
 
-regex/\.(gz|Z)$
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
-
 # bzip2
-type/^bzip2
+type/\(bzip2 compressed
 	Open=@EXTHELPERSDIR@/archive.sh view bzip2 %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bz2
 
-regex/\.bz2?$
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bz2
-
 # bzip
-type/^bzip
+type/\(bzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view bzip %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bzip
 
 # compress
-type/^compress
+type/\(compress'd
 	Open=@EXTHELPERSDIR@/archive.sh view gz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
 
 # lz
-regex/\.lz$
-	Open=@EXTHELPERSDIR@/archive.sh view lz %var{PAGER:more}
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz
-
-# lz
-type/^LZIP
+type/\(lzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view lz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz
 
@@ -802,17 +796,17 @@ regex/\.lz4$
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz4
 
 # lzma
-regex/\.lzma$
+type/\(LZMA compressed
 	Open=@EXTHELPERSDIR@/archive.sh view lzma %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lzma
 
 # xz
-regex/\.xz$
+type/\(XZ compressed
 	Open=@EXTHELPERSDIR@/archive.sh view xz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view xz
 
 # zstd
-regex/\.zst$
+type/\(Zstandard compressed
 	Open=@EXTHELPERSDIR@/archive.sh view zst %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view zst
 
@@ -820,6 +814,10 @@ regex/\.zst$
 type/^Parity\ Archive\ Volume\ Set
 	Open=@EXTHELPERSDIR@/archive.sh open par2
 
+# WIM
+shell/i/\.wim
+	Open=%cd %p/uwim://
+	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view wim
 
 ### Includes
 # includes should be at end of bindings
diff --git a/misc/mc.lib b/misc/mc.lib
index d84a7b5a6..bf8be065c 100644
--- a/misc/mc.lib
+++ b/misc/mc.lib
@@ -116,6 +116,9 @@ alt-shift-left=\\e[1\;4D
 alt-shift-up=\\e[1\;4A
 alt-shift-down=\\e[1\;4B
 
+[terminal:alacritty]
+copy=xterm
+
 [terminal:gnome]
 copy=xterm
 
@@ -137,6 +140,12 @@ copy=xterm
 [terminal:screen-256color]
 copy=xterm
 
+[terminal:tmux]
+copy=xterm
+
+[terminal:tmux-256color]
+copy=xterm
+
 [terminal:ibmpc3]
 f11=\\e[Y
 f12=\\e[Z
diff --git a/misc/skins/dark.ini b/misc/skins/dark.ini
index 58d6f8351..0cfeb8ecf 100644
--- a/misc/skins/dark.ini
+++ b/misc/skins/dark.ini
@@ -39,6 +39,7 @@
     header = yellow;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/darkfar.ini b/misc/skins/darkfar.ini
index e0e1a5879..c6dcf68f2 100644
--- a/misc/skins/darkfar.ini
+++ b/misc/skins/darkfar.ini
@@ -39,6 +39,7 @@
     header = yellow;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/default.ini b/misc/skins/default.ini
index afc060ade..145eb998b 100644
--- a/misc/skins/default.ini
+++ b/misc/skins/default.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/double-lines.ini b/misc/skins/double-lines.ini
index cad1e2807..7f35df0bc 100644
--- a/misc/skins/double-lines.ini
+++ b/misc/skins/double-lines.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/featured-plus.ini b/misc/skins/featured-plus.ini
index be7dde7a6..a0dc07028 100644
--- a/misc/skins/featured-plus.ini
+++ b/misc/skins/featured-plus.ini
@@ -41,6 +41,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/featured.ini b/misc/skins/featured.ini
index b37671899..43ce2f293 100644
--- a/misc/skins/featured.ini
+++ b/misc/skins/featured.ini
@@ -41,6 +41,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/gotar.ini b/misc/skins/gotar.ini
index b9b8aa093..3b81867fc 100644
--- a/misc/skins/gotar.ini
+++ b/misc/skins/gotar.ini
@@ -36,6 +36,7 @@
     header = brightred;
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/gray-green-purple256.ini b/misc/skins/gray-green-purple256.ini
index 4a15b798c..3ae534cae 100644
--- a/misc/skins/gray-green-purple256.ini
+++ b/misc/skins/gray-green-purple256.ini
@@ -45,6 +45,7 @@
     reverse =
     commandlinemark = ;main1
     header = main2
+    shadow = black;gray12
 
 [dialog]
     _default_ = black;bgdarker
diff --git a/misc/skins/gray-orange-blue256.ini b/misc/skins/gray-orange-blue256.ini
index cddd27b5f..fa491f014 100644
--- a/misc/skins/gray-orange-blue256.ini
+++ b/misc/skins/gray-orange-blue256.ini
@@ -45,6 +45,7 @@
     reverse =
     commandlinemark = ;main1
     header = main2
+    shadow = black;gray12
 
 [dialog]
     _default_ = black;bgdarker
diff --git a/misc/skins/julia256.ini b/misc/skins/julia256.ini
index bf04dd9e6..a61701cfd 100644
--- a/misc/skins/julia256.ini
+++ b/misc/skins/julia256.ini
@@ -42,6 +42,7 @@
     header = yellow;color237
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/mc46.ini b/misc/skins/mc46.ini
index 0b1f099d7..f971310ed 100644
--- a/misc/skins/mc46.ini
+++ b/misc/skins/mc46.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/modarcon16-defbg.ini b/misc/skins/modarcon16-defbg.ini
index 12391af2f..c004f6363 100644
--- a/misc/skins/modarcon16-defbg.ini
+++ b/misc/skins/modarcon16-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16.ini b/misc/skins/modarcon16.ini
index f0fe8d9e8..4fdd43e3c 100644
--- a/misc/skins/modarcon16.ini
+++ b/misc/skins/modarcon16.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
@@ -144,7 +145,7 @@
     _default_ = color7;color0
     editbold = color15;;bold
     editmarked = color11;color2;bold
-    editwhitespace = color12;color4
+    editwhitespace = color2;color0
     editlinestate = color2;color0
     bookmark = color0;color7
     bookmarkfound = color0;color7
diff --git a/misc/skins/modarcon16root-defbg.ini b/misc/skins/modarcon16root-defbg.ini
index f00351b36..b74700489 100644
--- a/misc/skins/modarcon16root-defbg.ini
+++ b/misc/skins/modarcon16root-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16root.ini b/misc/skins/modarcon16root.ini
index f76c8d6c9..d9afd5a3d 100644
--- a/misc/skins/modarcon16root.ini
+++ b/misc/skins/modarcon16root.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarin256-defbg.ini b/misc/skins/modarin256-defbg.ini
index dcc6f265a..f12d33623 100644
--- a/misc/skins/modarin256-defbg.ini
+++ b/misc/skins/modarin256-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256.ini b/misc/skins/modarin256.ini
index fa2bf2e93..8d1872aa7 100644
--- a/misc/skins/modarin256.ini
+++ b/misc/skins/modarin256.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256root-defbg.ini b/misc/skins/modarin256root-defbg.ini
index dcf7a29b4..48a4e9927 100644
--- a/misc/skins/modarin256root-defbg.ini
+++ b/misc/skins/modarin256root-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256root.ini b/misc/skins/modarin256root.ini
index 9bb4feefe..0a361ed24 100644
--- a/misc/skins/modarin256root.ini
+++ b/misc/skins/modarin256root.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/nicedark.ini b/misc/skins/nicedark.ini
index fb2c076a5..0b5ee0107 100644
--- a/misc/skins/nicedark.ini
+++ b/misc/skins/nicedark.ini
@@ -39,6 +39,7 @@
     header = lightgray;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = lightgray;black
diff --git a/misc/skins/sand256.ini b/misc/skins/sand256.ini
index f60ad44ab..94b1b77ca 100644
--- a/misc/skins/sand256.ini
+++ b/misc/skins/sand256.ini
@@ -94,6 +94,7 @@
     reverse = ;rgb452
     commandlinemark = white;gray
     header = red;;italic
+    shadow = black;rgb221
 
 [dialog]
     _default_ = black;rgb553
diff --git a/misc/skins/seasons-autumn16M.ini b/misc/skins/seasons-autumn16M.ini
index 182e2219b..bc8dc65ea 100644
--- a/misc/skins/seasons-autumn16M.ini
+++ b/misc/skins/seasons-autumn16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #69880c
     Input = #b5c400
     PaleFg = #555
+    ShadowFg = #7f7f55
+    ShadowBg = #4c1002
     Error = #840000
     ErrorFocus = #b00
     Top = #ff9909
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-spring16M.ini b/misc/skins/seasons-spring16M.ini
index de5906e2b..2c44a243b 100644
--- a/misc/skins/seasons-spring16M.ini
+++ b/misc/skins/seasons-spring16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #b3de85
     Input = Main
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #797f73
     Error = #c62b41
     ErrorFocus = #e16d7e
     Top = #f699a6
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-summer16M.ini b/misc/skins/seasons-summer16M.ini
index a8a01caa3..e9c686dc1 100644
--- a/misc/skins/seasons-summer16M.ini
+++ b/misc/skins/seasons-summer16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #f864f6
     Input = #d7ffad
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #7f7659
     Error = #d40707
     ErrorFocus = #db7b7b
     Top = #46cef3
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-winter16M.ini b/misc/skins/seasons-winter16M.ini
index bebc50c79..2724b2f09 100644
--- a/misc/skins/seasons-winter16M.ini
+++ b/misc/skins/seasons-winter16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #afbad8
     Input = Main
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #727176
     Error = #3c4766
     ErrorFocus = #586896
     Top = #6b99d7
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/xoria256.ini b/misc/skins/xoria256.ini
index 771f39ca4..d0e6b8a9b 100644
--- a/misc/skins/xoria256.ini
+++ b/misc/skins/xoria256.ini
@@ -82,6 +82,8 @@
     #commandhistory =
     #commandlinemark = black;lightgray
 
+    shadow = color239;black
+
 [dialog]
     _default_ = black;color250
     dhotnormal = color88;;
diff --git a/misc/skins/yadt256-defbg.ini b/misc/skins/yadt256-defbg.ini
index 8eec14c14..5de0aef57 100644
--- a/misc/skins/yadt256-defbg.ini
+++ b/misc/skins/yadt256-defbg.ini
@@ -48,6 +48,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color239;black
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/yadt256.ini b/misc/skins/yadt256.ini
index 639576214..8fd2c70b7 100644
--- a/misc/skins/yadt256.ini
+++ b/misc/skins/yadt256.ini
@@ -47,6 +47,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color239;black
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/syntax/Makefile.am b/misc/syntax/Makefile.am
index 15a3ed465..eabf665f4 100644
--- a/misc/syntax/Makefile.am
+++ b/misc/syntax/Makefile.am
@@ -81,6 +81,7 @@ SYNTAXFILES =			\
 	spec.syntax		\
 	sql.syntax		\
 	strace.syntax 		\
+	swift.syntax		\
 	swig.syntax		\
 	syntax.syntax		\
 	tcl.syntax		\
diff --git a/misc/syntax/Syntax.in b/misc/syntax/Syntax.in
index 397bec473..eefe91d72 100644
--- a/misc/syntax/Syntax.in
+++ b/misc/syntax/Syntax.in
@@ -299,7 +299,7 @@ file ..\*\\.proto$ Protobuf\sFile
 include protobuf.syntax
 
 file ..\*\\.(?i:yab)$ Yabasic\s(Yet\sAnother\sBASIC)
-include markdown.syntax
+include yabasic.syntax
 
 file ..\*\\.(?i:cbl|cob)$ Cobol\sProgram
 include cobol.syntax
@@ -307,5 +307,8 @@ include cobol.syntax
 file ..\*\\.kt$ Kotliin\sSource
 include kotlin.syntax
 
+file ..\*\\.swift$ Swift\sProgram
+include swift.syntax
+
 file .\* unknown
 include unknown.syntax
diff --git a/misc/syntax/swift.syntax b/misc/syntax/swift.syntax
new file mode 100644
index 000000000..cd9c72136
diff --git a/po/az.po b/po/az.po
index 490720732..32b24837e 100644
Binary files a/po/az.po and b/po/az.po differ
diff --git a/po/be.po b/po/be.po
index 5caead6f9..f8700bfc3 100644
Binary files a/po/be.po and b/po/be.po differ
diff --git a/po/bg.po b/po/bg.po
index f53593b9a..f587feac9 100644
Binary files a/po/bg.po and b/po/bg.po differ
diff --git a/po/ca.po b/po/ca.po
index f4594cc7d..b3e2833c2 100644
Binary files a/po/ca.po and b/po/ca.po differ
diff --git a/po/cs.po b/po/cs.po
index 443f0e8de..7b647037d 100644
Binary files a/po/cs.po and b/po/cs.po differ
diff --git a/po/da.po b/po/da.po
index 5774841fb..0086500b5 100644
Binary files a/po/da.po and b/po/da.po differ
diff --git a/po/de.po b/po/de.po
index 5990299ce..6206431af 100644
Binary files a/po/de.po and b/po/de.po differ
diff --git a/po/de_CH.po b/po/de_CH.po
index d04d2fa07..5b395e7dc 100644
Binary files a/po/de_CH.po and b/po/de_CH.po differ
diff --git a/po/el.po b/po/el.po
index 09de13eaa..ed54c2fbf 100644
Binary files a/po/el.po and b/po/el.po differ
diff --git a/po/en_GB.po b/po/en_GB.po
index 16bb703ac..2b2f06dd5 100644
Binary files a/po/en_GB.po and b/po/en_GB.po differ
diff --git a/po/eo.po b/po/eo.po
index df7962b7b..9dd8cb71d 100644
Binary files a/po/eo.po and b/po/eo.po differ
diff --git a/po/es.po b/po/es.po
index dd5eec0c5..cd3669983 100644
Binary files a/po/es.po and b/po/es.po differ
diff --git a/po/et.po b/po/et.po
index 7a7873ea7..aca389914 100644
Binary files a/po/et.po and b/po/et.po differ
diff --git a/po/eu.po b/po/eu.po
index be19154cc..5a55cd63c 100644
Binary files a/po/eu.po and b/po/eu.po differ
diff --git a/po/fa.po b/po/fa.po
index 3cf9e6c9a..55281df54 100644
Binary files a/po/fa.po and b/po/fa.po differ
diff --git a/po/fi.po b/po/fi.po
index d41406ced..dbd00044e 100644
Binary files a/po/fi.po and b/po/fi.po differ
diff --git a/po/fr.po b/po/fr.po
index 7ad080aba..d282aa6ab 100644
Binary files a/po/fr.po and b/po/fr.po differ
diff --git a/po/fr_CA.po b/po/fr_CA.po
index 173fc056b..5734d5ae9 100644
Binary files a/po/fr_CA.po and b/po/fr_CA.po differ
diff --git a/po/gl.po b/po/gl.po
index e1d6e5125..182006324 100644
Binary files a/po/gl.po and b/po/gl.po differ
diff --git a/po/hr.po b/po/hr.po
index cc06e1e58..23513079a 100644
Binary files a/po/hr.po and b/po/hr.po differ
diff --git a/po/hu.po b/po/hu.po
index 294dbc8df..886380c40 100644
Binary files a/po/hu.po and b/po/hu.po differ
diff --git a/po/ia.po b/po/ia.po
index caff6eafe..809a91dab 100644
Binary files a/po/ia.po and b/po/ia.po differ
diff --git a/po/id.po b/po/id.po
index f304aecf0..7297c6bdd 100644
Binary files a/po/id.po and b/po/id.po differ
diff --git a/po/it.po b/po/it.po
index 31a6b6dbe..67f252283 100644
Binary files a/po/it.po and b/po/it.po differ
diff --git a/po/ja.po b/po/ja.po
index 3851fec33..972efc00e 100644
Binary files a/po/ja.po and b/po/ja.po differ
diff --git a/po/ka.po b/po/ka.po
index fcf44a3f8..e4f1617f5 100644
Binary files a/po/ka.po and b/po/ka.po differ
diff --git a/po/kk.po b/po/kk.po
index fec193056..76e3a33bb 100644
Binary files a/po/kk.po and b/po/kk.po differ
diff --git a/po/ko.po b/po/ko.po
index 8e3c03db5..e348ec220 100644
Binary files a/po/ko.po and b/po/ko.po differ
diff --git a/po/lt.po b/po/lt.po
index 0a192b3a5..a8a97738e 100644
Binary files a/po/lt.po and b/po/lt.po differ
diff --git a/po/lv.po b/po/lv.po
index e9bae1db9..bfecf968c 100644
Binary files a/po/lv.po and b/po/lv.po differ
diff --git a/po/mc.pot b/po/mc.pot
index 6113bb2bc..213da9965 100644
--- a/po/mc.pot
+++ b/po/mc.pot
@@ -21,7 +21,7 @@ msgstr ""
 msgid "Warning: cannot load codepages list"
 msgstr ""
 
-#: lib/charsets.c:220 src/filemanager/boxes.c:354
+#: lib/charsets.c:220 src/filemanager/boxes.c:388
 msgid "7-bit ASCII"
 msgstr ""
 
@@ -144,7 +144,7 @@ msgstr ""
 msgid "Invalid token number %d"
 msgstr ""
 
-#: lib/search/regex.c:339 lib/search/regex.c:834 src/filemanager/ext.c:744
+#: lib/search/regex.c:339 lib/search/regex.c:834 src/filemanager/ext.c:746
 msgid "Regular expression error"
 msgstr ""
 
@@ -152,7 +152,7 @@ msgstr ""
 msgid "No&rmal"
 msgstr ""
 
-#: lib/search/search.c:54 src/filemanager/find.c:589
+#: lib/search/search.c:54 src/filemanager/find.c:587
 msgid "Re&gular expression"
 msgstr ""
 
@@ -587,11 +587,11 @@ msgstr ""
 msgid "Shift"
 msgstr ""
 
-#: lib/tty/tty.c:105
+#: lib/tty/tty.c:106
 msgid "The TERM environment variable is unset!\n"
 msgstr ""
 
-#: lib/tty/tty.c:194
+#: lib/tty/tty.c:195
 msgid "Cannot check SIGWINCH pipe"
 msgstr ""
 
@@ -623,31 +623,31 @@ msgid ""
 "Check the TERM environment variable.\n"
 msgstr ""
 
-#: lib/util.c:350
+#: lib/util.c:349
 msgid "B"
 msgstr ""
 
-#: lib/util.c:355
+#: lib/util.c:354
 msgid "kB"
 msgstr ""
 
-#: lib/util.c:355
+#: lib/util.c:354
 msgid "KiB"
 msgstr ""
 
-#: lib/util.c:360
+#: lib/util.c:359
 msgid "MB"
 msgstr ""
 
-#: lib/util.c:360
+#: lib/util.c:359
 msgid "MiB"
 msgstr ""
 
-#: lib/util.c:365
+#: lib/util.c:364
 msgid "GB"
 msgstr ""
 
-#: lib/util.c:365
+#: lib/util.c:364
 msgid "GiB"
 msgstr ""
 
@@ -673,87 +673,87 @@ msgid ""
 "%s"
 msgstr ""
 
-#: lib/utilunix.c:719 lib/utilunix.c:724 lib/utilunix.c:781
+#: lib/utilunix.c:721 lib/utilunix.c:727 lib/utilunix.c:786
 #: src/editor/edit.c:358 src/editor/editcmd.c:231 src/editor/editcmd.c:254
-#: src/editor/editcmd.c:425 src/editor/editcmd.c:585 src/editor/editcmd.c:1705
-#: src/editor/editcmd.c:3451 src/editor/editcmd.c:3480
+#: src/editor/editcmd.c:425 src/editor/editcmd.c:585 src/editor/editcmd.c:1706
+#: src/editor/editcmd.c:3452 src/editor/editcmd.c:3481
 #: src/editor/editcmd_dialogs.c:474 src/execute.c:135
-#: src/filemanager/file.c:2401 src/filemanager/panel.c:4509 src/help.c:362
-#: src/main.c:414 src/main.c:458 src/subshell/common.c:1219
+#: src/filemanager/file.c:2390 src/filemanager/panel.c:4510 src/help.c:362
+#: src/main.c:410 src/main.c:454 src/subshell/common.c:1602
 #: src/viewer/actions_cmd.c:461
 msgid "Warning"
 msgstr ""
 
-#: lib/utilunix.c:719 src/filemanager/ext.c:726
+#: lib/utilunix.c:721 src/filemanager/ext.c:728
 msgid "Pipe failed"
 msgstr ""
 
-#: lib/utilunix.c:724
+#: lib/utilunix.c:727
 msgid "Dup failed"
 msgstr ""
 
-#: lib/utilunix.c:789
+#: lib/utilunix.c:794
 msgid "Error dup'ing old error pipe"
 msgstr ""
 
-#: lib/vfs/direntry.c:272
+#: lib/vfs/direntry.c:271
 #, c-format
 msgid "Directory cache expired for %s"
 msgstr ""
 
-#: lib/vfs/direntry.c:710
+#: lib/vfs/direntry.c:709
 #, c-format
 msgid "%s: %s: %s %3d%% (%lld) bytes transferred"
 msgstr ""
 
-#: lib/vfs/direntry.c:713
+#: lib/vfs/direntry.c:712
 #, c-format
 msgid "%s: %s: %s %lld bytes transferred"
 msgstr ""
 
-#: lib/vfs/direntry.c:1376
+#: lib/vfs/direntry.c:1375
 msgid "Starting linear transfer..."
 msgstr ""
 
-#: lib/vfs/direntry.c:1476
+#: lib/vfs/direntry.c:1475
 msgid "Getting file"
 msgstr ""
 
-#: lib/vfs/interface.c:175
+#: lib/vfs/interface.c:173
 msgid "Changes to file lost"
 msgstr ""
 
-#: lib/vfs/interface.c:857
+#: lib/vfs/interface.c:840
 #, c-format
 msgid "%s is not a directory\n"
 msgstr ""
 
-#: lib/vfs/interface.c:859
+#: lib/vfs/interface.c:842
 #, c-format
 msgid "Directory %s is not owned by you\n"
 msgstr ""
 
-#: lib/vfs/interface.c:861
+#: lib/vfs/interface.c:844
 #, c-format
 msgid "Cannot set correct permissions for directory %s\n"
 msgstr ""
 
-#: lib/vfs/interface.c:866
+#: lib/vfs/interface.c:849
 #, c-format
 msgid "Cannot create temporary directory %s: %s\n"
 msgstr ""
 
-#: lib/vfs/interface.c:900
+#: lib/vfs/interface.c:883
 #, c-format
 msgid "Temporary files will be created in %s\n"
 msgstr ""
 
-#: lib/vfs/interface.c:906
+#: lib/vfs/interface.c:889
 #, c-format
 msgid "Temporary files will not be created\n"
 msgstr ""
 
-#: lib/vfs/interface.c:911 src/execute.c:337
+#: lib/vfs/interface.c:894 src/execute.c:337
 msgid "Press any key to continue..."
 msgstr ""
 
@@ -769,7 +769,7 @@ msgstr ""
 msgid "Internal error:"
 msgstr ""
 
-#: lib/vfs/utilvfs.c:365 src/filemanager/boxes.c:1309
+#: lib/vfs/utilvfs.c:365 src/filemanager/boxes.c:1350
 msgid "Password:"
 msgstr ""
 
@@ -791,51 +791,51 @@ msgid "Do you want clean this history?"
 msgstr ""
 
 #: lib/widget/listbox.c:320 src/diffviewer/ydiff.c:3089 src/editor/edit.c:358
-#: src/editor/editcmd.c:233 src/editor/editcmd.c:256 src/editor/editcmd.c:2861
-#: src/editor/editcmd.c:2867 src/filemanager/cmd.c:139
-#: src/filemanager/file.c:968 src/filemanager/file.c:1965
-#: src/filemanager/filegui.c:458 src/filemanager/hotlist.c:1158
-#: src/filemanager/hotlist.c:1175 src/filemanager/midnight.c:1069
-#: src/filemanager/midnight.c:1077 src/filemanager/panel.c:2823
-#: src/filemanager/tree.c:834 src/subshell/common.c:1221
+#: src/editor/editcmd.c:233 src/editor/editcmd.c:256 src/editor/editcmd.c:2862
+#: src/editor/editcmd.c:2868 src/filemanager/cmd.c:140
+#: src/filemanager/file.c:959 src/filemanager/file.c:1956
+#: src/filemanager/filegui.c:458 src/filemanager/filemanager.c:1062
+#: src/filemanager/filemanager.c:1070 src/filemanager/hotlist.c:1159
+#: src/filemanager/hotlist.c:1176 src/filemanager/panel.c:2819
+#: src/filemanager/tree.c:829 src/subshell/common.c:1604
 #: src/viewer/actions_cmd.c:661 src/viewer/actions_cmd.c:667
 #: src/viewer/search.c:398
 msgid "&Yes"
 msgstr ""
 
 #: lib/widget/listbox.c:320 src/diffviewer/ydiff.c:3089 src/editor/edit.c:358
-#: src/editor/editcmd.c:233 src/editor/editcmd.c:2861 src/editor/editcmd.c:2867
-#: src/filemanager/cmd.c:139 src/filemanager/file.c:968
-#: src/filemanager/file.c:1965 src/filemanager/filegui.c:460
-#: src/filemanager/hotlist.c:1158 src/filemanager/hotlist.c:1175
-#: src/filemanager/midnight.c:1069 src/filemanager/midnight.c:1077
-#: src/filemanager/panel.c:2823 src/filemanager/tree.c:834
-#: src/subshell/common.c:1221 src/viewer/actions_cmd.c:661
+#: src/editor/editcmd.c:233 src/editor/editcmd.c:2862 src/editor/editcmd.c:2868
+#: src/filemanager/cmd.c:140 src/filemanager/file.c:959
+#: src/filemanager/file.c:1956 src/filemanager/filegui.c:460
+#: src/filemanager/filemanager.c:1062 src/filemanager/filemanager.c:1070
+#: src/filemanager/hotlist.c:1159 src/filemanager/hotlist.c:1176
+#: src/filemanager/panel.c:2819 src/filemanager/tree.c:829
+#: src/subshell/common.c:1604 src/viewer/actions_cmd.c:661
 #: src/viewer/actions_cmd.c:667 src/viewer/search.c:399
 msgid "&No"
 msgstr ""
 
-#: lib/widget/quick.h:215 src/editor/editcmd.c:2728
+#: lib/widget/quick.h:215 src/editor/editcmd.c:2729
 #: src/editor/editcmd_dialogs.c:121 src/editor/editwidget.c:151
-#: src/filemanager/boxes.c:1230 src/filemanager/filegui.c:1357
-#: src/filemanager/find.c:597 src/filemanager/layout.c:508 src/main.c:417
+#: src/filemanager/boxes.c:1271 src/filemanager/filegui.c:1357
+#: src/filemanager/find.c:595 src/filemanager/layout.c:508 src/main.c:413
 msgid "&OK"
 msgstr ""
 
 #: lib/widget/quick.h:216 src/editor/editcmd.c:233 src/editor/editcmd.c:256
-#: src/editor/editcmd.c:427 src/editor/editcmd.c:587 src/editor/editcmd.c:1706
-#: src/editor/editcmd.c:2047 src/editor/editcmd.c:2861
-#: src/editor/editcmd.c:3454 src/editor/editcmd.c:3483
+#: src/editor/editcmd.c:427 src/editor/editcmd.c:587 src/editor/editcmd.c:1707
+#: src/editor/editcmd.c:2048 src/editor/editcmd.c:2862
+#: src/editor/editcmd.c:3455 src/editor/editcmd.c:3484
 #: src/editor/editcmd_dialogs.c:123 src/editor/editcmd_dialogs.c:282
 #: src/editor/editcmd_dialogs.c:476 src/editor/spell_dialogs.c:100
-#: src/filemanager/achown.c:89 src/filemanager/achown.c:861
-#: src/filemanager/achown.c:896 src/filemanager/chattr.c:231
-#: src/filemanager/chattr.c:1100 src/filemanager/chmod.c:117
-#: src/filemanager/chmod.c:440 src/filemanager/chown.c:88
-#: src/filemanager/chown.c:312 src/filemanager/cmd.c:1147
-#: src/filemanager/filegui.c:1361 src/filemanager/find.c:597
-#: src/filemanager/hotlist.c:182 src/filemanager/hotlist.c:1014
-#: src/filemanager/hotlist.c:1076 src/filemanager/layout.c:509
+#: src/filemanager/achown.c:87 src/filemanager/achown.c:860
+#: src/filemanager/achown.c:895 src/filemanager/chattr.c:234
+#: src/filemanager/chattr.c:1105 src/filemanager/chmod.c:115
+#: src/filemanager/chmod.c:438 src/filemanager/chown.c:87
+#: src/filemanager/chown.c:311 src/filemanager/cmd.c:1146
+#: src/filemanager/filegui.c:1361 src/filemanager/find.c:595
+#: src/filemanager/hotlist.c:183 src/filemanager/hotlist.c:1015
+#: src/filemanager/hotlist.c:1077 src/filemanager/layout.c:509
 #: src/filemanager/panelize.c:143 src/learn.c:258 src/viewer/hex.c:431
 msgid "&Cancel"
 msgstr ""
@@ -847,7 +847,7 @@ msgstr ""
 #: lib/widget/wtools.c:288 lib/widget/wtools.c:417 src/editor/edit.c:193
 #: src/editor/edit.c:214 src/editor/edit.c:370 src/editor/edit.c:1977
 #: src/editor/edit.c:1987 src/editor/editcmd.c:318 src/editor/editcmd.c:328
-#: src/editor/editcmd.c:371 src/editor/editcmd.c:2965 src/editor/spell.c:315
+#: src/editor/editcmd.c:371 src/editor/editcmd.c:2966 src/editor/spell.c:315
 #: src/editor/spell.c:551 src/editor/spell.c:559
 #: tests/src/execute__common.c:145
 #: tests/src/execute__execute_with_vfs_arg.c:154
@@ -859,9 +859,9 @@ msgstr ""
 msgid "%s (%d)"
 msgstr ""
 
-#: lib/widget/wtools.c:696 src/filemanager/file.c:847
-#: src/filemanager/file.c:921 src/filemanager/file.c:923
-#: src/filemanager/file.c:969 src/filemanager/file.c:3108
+#: lib/widget/wtools.c:696 src/filemanager/file.c:838
+#: src/filemanager/file.c:912 src/filemanager/file.c:914
+#: src/filemanager/file.c:960 src/filemanager/file.c:3077
 #: src/filemanager/filegui.c:255 src/filemanager/filegui.c:482
 msgid "&Abort"
 msgstr ""
@@ -1047,12 +1047,12 @@ msgid ""
 "as tickets at www.midnight-commander.org\n"
 msgstr ""
 
-#: src/args.c:430 src/filemanager/midnight.c:1769 src/textconf.c:141
+#: src/args.c:430 src/filemanager/filemanager.c:1762 src/textconf.c:141
 #, c-format
 msgid "GNU Midnight Commander %s\n"
 msgstr ""
 
-#: src/args.c:683 src/filemanager/boxes.c:647
+#: src/args.c:683 src/filemanager/boxes.c:688
 msgid "Main options"
 msgstr ""
 
@@ -1080,7 +1080,7 @@ msgstr ""
 msgid "Reading failed"
 msgstr ""
 
-#: src/background.c:219 src/filemanager/file.c:844 src/filemanager/file.c:916
+#: src/background.c:219 src/filemanager/file.c:835 src/filemanager/file.c:907
 msgid "Background process error"
 msgstr ""
 
@@ -1110,8 +1110,8 @@ msgid "Enter search string:"
 msgstr ""
 
 #: src/diffviewer/search.c:92 src/editor/editcmd_dialogs.c:112
-#: src/editor/editcmd_dialogs.c:209 src/filemanager/boxes.c:640
-#: src/filemanager/boxes.c:845 src/filemanager/find.c:583
+#: src/editor/editcmd_dialogs.c:209 src/filemanager/boxes.c:681
+#: src/filemanager/boxes.c:886 src/filemanager/find.c:581
 #: src/viewer/dialogs.c:97
 msgid "Cas&e sensitive"
 msgstr ""
@@ -1122,13 +1122,13 @@ msgid "&Backwards"
 msgstr ""
 
 #: src/diffviewer/search.c:94 src/editor/editcmd_dialogs.c:115
-#: src/editor/editcmd_dialogs.c:212 src/filemanager/find.c:594
+#: src/editor/editcmd_dialogs.c:212 src/filemanager/find.c:592
 #: src/viewer/dialogs.c:99
 msgid "&Whole words"
 msgstr ""
 
 #: src/diffviewer/search.c:96 src/editor/editcmd_dialogs.c:117
-#: src/editor/editcmd_dialogs.c:214 src/filemanager/find.c:581
+#: src/editor/editcmd_dialogs.c:214 src/filemanager/find.c:579
 #: src/viewer/dialogs.c:101
 msgid "&All charsets"
 msgstr ""
@@ -1136,7 +1136,7 @@ msgstr ""
 #: src/diffviewer/search.c:106 src/diffviewer/search.c:229
 #: src/diffviewer/search.c:242 src/diffviewer/search.c:275
 #: src/editor/editcmd.c:960 src/editor/editcmd.c:986 src/editor/editcmd.c:1015
-#: src/editor/editcmd.c:2612 src/editor/editcmd.c:2623
+#: src/editor/editcmd.c:2613 src/editor/editcmd.c:2624
 #: src/editor/editcmd_dialogs.c:130 src/viewer/dialogs.c:111
 #: src/viewer/search.c:350 src/viewer/search.c:410 src/viewer/search.c:430
 #: src/viewer/search.c:432
@@ -1225,13 +1225,13 @@ msgstr ""
 msgid "Goto line (right)"
 msgstr ""
 
-#: src/diffviewer/ydiff.c:2934 src/editor/editcmd.c:3048
+#: src/diffviewer/ydiff.c:2934 src/editor/editcmd.c:3049
 msgid "Enter line:"
 msgstr ""
 
 #: src/diffviewer/ydiff.c:2973 src/editor/editwidget.c:660
-#: src/filemanager/midnight.c:1656 src/filemanager/tree.c:1177 src/help.c:1165
-#: src/viewer/display.c:87
+#: src/filemanager/filemanager.c:1649 src/filemanager/tree.c:1172
+#: src/help.c:1165 src/viewer/display.c:87
 msgid "ButtonBar|Help"
 msgstr ""
 
@@ -1240,7 +1240,7 @@ msgstr ""
 msgid "ButtonBar|Save"
 msgstr ""
 
-#: src/diffviewer/ydiff.c:2975 src/filemanager/midnight.c:1659
+#: src/diffviewer/ydiff.c:2975 src/filemanager/filemanager.c:1652
 #: src/viewer/display.c:94
 msgid "ButtonBar|Edit"
 msgstr ""
@@ -1259,12 +1259,12 @@ msgid "ButtonBar|Options"
 msgstr ""
 
 #: src/diffviewer/ydiff.c:2979 src/editor/editwidget.c:669
-#: src/filemanager/midnight.c:1665 src/help.c:1174 src/viewer/display.c:118
+#: src/filemanager/filemanager.c:1658 src/help.c:1174 src/viewer/display.c:118
 #: src/viewer/display.c:121
 msgid "ButtonBar|Quit"
 msgstr ""
 
-#: src/diffviewer/ydiff.c:3086 src/editor/editcmd.c:2867
+#: src/diffviewer/ydiff.c:3086 src/editor/editcmd.c:2868
 #: src/viewer/actions_cmd.c:659 src/viewer/actions_cmd.c:665
 msgid "Quit"
 msgstr ""
@@ -1290,7 +1290,7 @@ msgid "\"%s\" is a directory"
 msgstr ""
 
 #: src/diffviewer/ydiff.c:3576 src/diffviewer/ydiff.c:3593
-#: src/filemanager/file.c:1772 src/viewer/mcviewer.c:349
+#: src/filemanager/file.c:1763 src/viewer/mcviewer.c:349
 #, c-format
 msgid ""
 "Cannot stat \"%s\"\n"
@@ -1372,7 +1372,7 @@ msgstr ""
 msgid "Searching %s: %3d%%"
 msgstr ""
 
-#: src/editor/editcmd.c:131 src/filemanager/find.c:1344 src/viewer/search.c:85
+#: src/editor/editcmd.c:131 src/filemanager/find.c:1327 src/viewer/search.c:85
 #, c-format
 msgid "Searching %s"
 msgstr ""
@@ -1404,8 +1404,8 @@ msgstr ""
 msgid "The file you are saving does not end with a newline."
 msgstr ""
 
-#: src/editor/editcmd.c:427 src/editor/editcmd.c:587 src/editor/editcmd.c:3453
-#: src/editor/editcmd.c:3482 src/editor/editcmd_dialogs.c:476
+#: src/editor/editcmd.c:427 src/editor/editcmd.c:587 src/editor/editcmd.c:3454
+#: src/editor/editcmd.c:3483 src/editor/editcmd_dialogs.c:476
 msgid "C&ontinue"
 msgstr ""
 
@@ -1425,8 +1425,8 @@ msgstr ""
 msgid "&Macintosh format (CR)"
 msgstr ""
 
-#: src/editor/editcmd.c:448 src/editor/editcmd.c:2069 src/editor/editcmd.c:3089
-#: src/editor/editcmd.c:3120 src/filemanager/cmd.c:750
+#: src/editor/editcmd.c:448 src/editor/editcmd.c:2070 src/editor/editcmd.c:3090
+#: src/editor/editcmd.c:3121 src/filemanager/cmd.c:751
 msgid "Enter file name:"
 msgstr ""
 
@@ -1438,264 +1438,264 @@ msgstr ""
 msgid "Save As"
 msgstr ""
 
-#: src/editor/editcmd.c:1250
+#: src/editor/editcmd.c:1251
 msgid "Collect completions"
 msgstr ""
 
-#: src/editor/editcmd.c:1605
+#: src/editor/editcmd.c:1606
 msgid "&Quick save"
 msgstr ""
 
-#: src/editor/editcmd.c:1606
+#: src/editor/editcmd.c:1607
 msgid "&Safe save"
 msgstr ""
 
-#: src/editor/editcmd.c:1607
+#: src/editor/editcmd.c:1608
 msgid "&Do backups with following extension:"
 msgstr ""
 
-#: src/editor/editcmd.c:1626
+#: src/editor/editcmd.c:1627
 msgid "Check &POSIX new line"
 msgstr ""
 
-#: src/editor/editcmd.c:1634
+#: src/editor/editcmd.c:1635
 msgid "Edit Save Mode"
 msgstr ""
 
-#: src/editor/editcmd.c:1688 src/editor/editcmd.c:1747
+#: src/editor/editcmd.c:1689 src/editor/editcmd.c:1748
 msgid "Save as"
 msgstr ""
 
-#: src/editor/editcmd.c:1690
+#: src/editor/editcmd.c:1691
 msgid "Cannot save: destination is not a regular file"
 msgstr ""
 
-#: src/editor/editcmd.c:1706
+#: src/editor/editcmd.c:1707
 msgid "A file already exists with this name"
 msgstr ""
 
-#: src/editor/editcmd.c:1706
+#: src/editor/editcmd.c:1707
 msgid "&Overwrite"
 msgstr ""
 
-#: src/editor/editcmd.c:1747 src/editor/editcmd.c:3099
+#: src/editor/editcmd.c:1748 src/editor/editcmd.c:3100
 msgid "Cannot save file"
 msgstr ""
 
-#: src/editor/editcmd.c:1772 src/editor/editcmd.c:1775
+#: src/editor/editcmd.c:1773 src/editor/editcmd.c:1776
 msgid "Delete macro"
 msgstr ""
 
-#: src/editor/editcmd.c:1772
+#: src/editor/editcmd.c:1773
 msgid "Press macro hotkey:"
 msgstr ""
 
-#: src/editor/editcmd.c:1775
+#: src/editor/editcmd.c:1776
 msgid "Macro not deleted"
 msgstr ""
 
-#: src/editor/editcmd.c:1830
+#: src/editor/editcmd.c:1831
 msgid "Save macro"
 msgstr ""
 
-#: src/editor/editcmd.c:1830
+#: src/editor/editcmd.c:1831
 msgid "Press the macro's new hotkey:"
 msgstr ""
 
-#: src/editor/editcmd.c:1905
+#: src/editor/editcmd.c:1906
 msgid "Repeat last commands"
 msgstr ""
 
-#: src/editor/editcmd.c:1905
+#: src/editor/editcmd.c:1906
 msgid "Repeat times:"
 msgstr ""
 
-#: src/editor/editcmd.c:2045
+#: src/editor/editcmd.c:2046
 #, c-format
 msgid "Confirm save file: \"%s\""
 msgstr ""
 
-#: src/editor/editcmd.c:2047 src/viewer/hex.c:419 src/viewer/hex.c:431
+#: src/editor/editcmd.c:2048 src/viewer/hex.c:419 src/viewer/hex.c:431
 msgid "Save file"
 msgstr ""
 
-#: src/editor/editcmd.c:2047 src/editor/editmenu.c:78 src/learn.c:192
+#: src/editor/editcmd.c:2048 src/editor/editmenu.c:78 src/learn.c:192
 #: src/learn.c:257
 msgid "&Save"
 msgstr ""
 
-#: src/editor/editcmd.c:2069
+#: src/editor/editcmd.c:2070
 msgid "Load"
 msgstr ""
 
-#: src/editor/editcmd.c:2131
+#: src/editor/editcmd.c:2132
 msgid "Syntax file edit"
 msgstr ""
 
-#: src/editor/editcmd.c:2132
+#: src/editor/editcmd.c:2133
 msgid "Which syntax file you want to edit?"
 msgstr ""
 
-#: src/editor/editcmd.c:2133 src/editor/editcmd.c:2179
-#: src/filemanager/cmd.c:950 src/filemanager/cmd.c:991
-#: src/filemanager/cmd.c:1049
+#: src/editor/editcmd.c:2134 src/editor/editcmd.c:2180
+#: src/filemanager/cmd.c:951 src/filemanager/cmd.c:992
+#: src/filemanager/cmd.c:1050
 msgid "&User"
 msgstr ""
 
-#: src/editor/editcmd.c:2133 src/editor/editcmd.c:2179
+#: src/editor/editcmd.c:2134 src/editor/editcmd.c:2180
 msgid "&System wide"
 msgstr ""
 
-#: src/editor/editcmd.c:2177 src/filemanager/cmd.c:989
+#: src/editor/editcmd.c:2178 src/filemanager/cmd.c:990
 msgid "Menu edit"
 msgstr ""
 
-#: src/editor/editcmd.c:2178 src/filemanager/cmd.c:990
+#: src/editor/editcmd.c:2179 src/filemanager/cmd.c:991
 msgid "Which menu file do you want to edit?"
 msgstr ""
 
-#: src/editor/editcmd.c:2179 src/filemanager/cmd.c:991
+#: src/editor/editcmd.c:2180 src/filemanager/cmd.c:992
 msgid "&Local"
 msgstr ""
 
-#: src/editor/editcmd.c:2688 src/editor/editcmd.c:2728
-#: src/editor/editcmd.c:2740 src/editor/editcmd_dialogs.c:224
+#: src/editor/editcmd.c:2689 src/editor/editcmd.c:2729
+#: src/editor/editcmd.c:2741 src/editor/editcmd_dialogs.c:224
 msgid "Replace"
 msgstr ""
 
-#: src/editor/editcmd.c:2740
+#: src/editor/editcmd.c:2741
 #, c-format
 msgid "%ld replacements made"
 msgstr ""
 
-#: src/editor/editcmd.c:2842 src/editor/editwidget.c:369
+#: src/editor/editcmd.c:2843 src/editor/editwidget.c:369
 msgid "[NoName]"
 msgstr ""
 
-#: src/editor/editcmd.c:2860
+#: src/editor/editcmd.c:2861
 #, c-format
 msgid ""
 "File %s was modified.\n"
 "Save before close?"
 msgstr ""
 
-#: src/editor/editcmd.c:2861
+#: src/editor/editcmd.c:2862
 msgid "Close file"
 msgstr ""
 
-#: src/editor/editcmd.c:2865
+#: src/editor/editcmd.c:2866
 #, c-format
 msgid ""
 "Midnight Commander is being shut down.\n"
 "Save modified file %s?"
 msgstr ""
 
-#: src/editor/editcmd.c:2965
+#: src/editor/editcmd.c:2966
 msgid "This function is not implemented"
 msgstr ""
 
-#: src/editor/editcmd.c:2980
+#: src/editor/editcmd.c:2981
 msgid "Copy to clipboard"
 msgstr ""
 
-#: src/editor/editcmd.c:2980 src/editor/editcmd.c:3004
+#: src/editor/editcmd.c:2981 src/editor/editcmd.c:3005
 msgid "Unable to save to file"
 msgstr ""
 
-#: src/editor/editcmd.c:3004
+#: src/editor/editcmd.c:3005
 msgid "Cut to clipboard"
 msgstr ""
 
-#: src/editor/editcmd.c:3048
+#: src/editor/editcmd.c:3049
 msgid "Goto line"
 msgstr ""
 
-#: src/editor/editcmd.c:3089 src/editor/editcmd.c:3099
+#: src/editor/editcmd.c:3090 src/editor/editcmd.c:3100
 msgid "Save block"
 msgstr ""
 
-#: src/editor/editcmd.c:3120 src/editor/editcmd.c:3135
+#: src/editor/editcmd.c:3121 src/editor/editcmd.c:3136
 msgid "Insert file"
 msgstr ""
 
-#: src/editor/editcmd.c:3135
+#: src/editor/editcmd.c:3136
 msgid "Cannot insert file"
 msgstr ""
 
-#: src/editor/editcmd.c:3156
+#: src/editor/editcmd.c:3157
 msgid "Sort block"
 msgstr ""
 
-#: src/editor/editcmd.c:3156
+#: src/editor/editcmd.c:3157
 msgid "You must first highlight a block of text"
 msgstr ""
 
-#: src/editor/editcmd.c:3164
+#: src/editor/editcmd.c:3165
 msgid "Run sort"
 msgstr ""
 
-#: src/editor/editcmd.c:3165
+#: src/editor/editcmd.c:3166
 msgid "Enter sort options (see manpage) separated by whitespace:"
 msgstr ""
 
-#: src/editor/editcmd.c:3185 src/editor/editcmd.c:3192
+#: src/editor/editcmd.c:3186 src/editor/editcmd.c:3193
 msgid "Sort"
 msgstr ""
 
-#: src/editor/editcmd.c:3185
+#: src/editor/editcmd.c:3186
 msgid "Cannot execute sort command"
 msgstr ""
 
-#: src/editor/editcmd.c:3191
+#: src/editor/editcmd.c:3192
 #, c-format
 msgid "Sort returned non-zero: %s"
 msgstr ""
 
-#: src/editor/editcmd.c:3228
+#: src/editor/editcmd.c:3229
 msgid "Paste output of external command"
 msgstr ""
 
-#: src/editor/editcmd.c:3229
+#: src/editor/editcmd.c:3230
 msgid "Enter shell command(s):"
 msgstr ""
 
-#: src/editor/editcmd.c:3246
+#: src/editor/editcmd.c:3247
 msgid "External command"
 msgstr ""
 
-#: src/editor/editcmd.c:3246
+#: src/editor/editcmd.c:3247
 msgid "Cannot execute command"
 msgstr ""
 
-#: src/editor/editcmd.c:3291
+#: src/editor/editcmd.c:3292
 msgid "mail -s <subject> -c <cc> <to>"
 msgstr ""
 
-#: src/editor/editcmd.c:3292
+#: src/editor/editcmd.c:3293
 msgid "To"
 msgstr ""
 
-#: src/editor/editcmd.c:3295
+#: src/editor/editcmd.c:3296
 msgid "Subject"
 msgstr ""
 
-#: src/editor/editcmd.c:3298
+#: src/editor/editcmd.c:3299
 msgid "Copies to"
 msgstr ""
 
-#: src/editor/editcmd.c:3308
+#: src/editor/editcmd.c:3309
 msgid "Mail"
 msgstr ""
 
-#: src/editor/editcmd.c:3412
+#: src/editor/editcmd.c:3413
 msgid "Insert literal"
 msgstr ""
 
-#: src/editor/editcmd.c:3413
+#: src/editor/editcmd.c:3414
 msgid "Press any key:"
 msgstr ""
 
-#: src/editor/editcmd.c:3452 src/editor/editcmd.c:3481
+#: src/editor/editcmd.c:3453 src/editor/editcmd.c:3482
 #: src/editor/editcmd_dialogs.c:475
 msgid ""
 "Current text was modified without a file save.\n"
@@ -1722,14 +1722,14 @@ msgstr ""
 msgid "&Replace"
 msgstr ""
 
-#: src/editor/editcmd_dialogs.c:280 src/filemanager/file.c:968
+#: src/editor/editcmd_dialogs.c:280 src/filemanager/file.c:959
 #: src/filemanager/filegui.c:471
 msgid "A&ll"
 msgstr ""
 
 #: src/editor/editcmd_dialogs.c:281 src/editor/spell_dialogs.c:98
-#: src/filemanager/file.c:847 src/filemanager/file.c:920
-#: src/filemanager/file.c:923 src/filemanager/file.c:3109
+#: src/filemanager/file.c:838 src/filemanager/file.c:911
+#: src/filemanager/file.c:914 src/filemanager/file.c:3078
 #: src/filemanager/filegui.c:252
 msgid "&Skip"
 msgstr ""
@@ -1782,7 +1782,7 @@ msgstr ""
 msgid "A&bout..."
 msgstr ""
 
-#: src/editor/editmenu.c:88 src/filemanager/find.c:192 src/main.c:417
+#: src/editor/editmenu.c:88 src/filemanager/find.c:190 src/main.c:413
 msgid "&Quit"
 msgstr ""
 
@@ -1822,8 +1822,8 @@ msgstr ""
 msgid "Mo&ve"
 msgstr ""
 
-#: src/editor/editmenu.c:113 src/filemanager/file.c:2702
-#: src/filemanager/midnight.c:261
+#: src/editor/editmenu.c:113 src/filemanager/file.c:2676
+#: src/filemanager/filemanager.c:254
 msgid "&Delete"
 msgstr ""
 
@@ -1963,7 +1963,7 @@ msgstr ""
 msgid "&External formatter"
 msgstr ""
 
-#: src/editor/editmenu.c:231 src/filemanager/hotlist.c:194
+#: src/editor/editmenu.c:231 src/filemanager/hotlist.c:195
 msgid "&Move"
 msgstr ""
 
@@ -1995,7 +1995,7 @@ msgstr ""
 msgid "Save &mode..."
 msgstr ""
 
-#: src/editor/editmenu.c:252 src/filemanager/midnight.c:351
+#: src/editor/editmenu.c:252 src/filemanager/filemanager.c:344
 msgid "Learn &keys..."
 msgstr ""
 
@@ -2011,15 +2011,15 @@ msgstr ""
 msgid "&Menu file"
 msgstr ""
 
-#: src/editor/editmenu.c:259 src/filemanager/midnight.c:356
+#: src/editor/editmenu.c:259 src/filemanager/filemanager.c:349
 msgid "&Save setup"
 msgstr ""
 
-#: src/editor/editmenu.c:283 src/filemanager/midnight.c:368
+#: src/editor/editmenu.c:283 src/filemanager/filemanager.c:361
 msgid "&File"
 msgstr ""
 
-#: src/editor/editmenu.c:285 src/filemanager/midnight.c:244
+#: src/editor/editmenu.c:285 src/filemanager/filemanager.c:237
 msgid "&Edit"
 msgstr ""
 
@@ -2027,7 +2027,7 @@ msgstr ""
 msgid "&Search"
 msgstr ""
 
-#: src/editor/editmenu.c:290 src/filemanager/midnight.c:370
+#: src/editor/editmenu.c:290 src/filemanager/filemanager.c:363
 msgid "&Command"
 msgstr ""
 
@@ -2039,7 +2039,7 @@ msgstr ""
 msgid "&Window"
 msgstr ""
 
-#: src/editor/editmenu.c:297 src/filemanager/midnight.c:372
+#: src/editor/editmenu.c:297 src/filemanager/filemanager.c:365
 msgid "&Options"
 msgstr ""
 
@@ -2079,7 +2079,7 @@ msgstr ""
 msgid "Tab spacing:"
 msgstr ""
 
-#: src/editor/editoptions.c:164 src/filemanager/boxes.c:537
+#: src/editor/editoptions.c:164 src/filemanager/boxes.c:571
 #: src/filemanager/layout.c:501
 msgid "Other options"
 msgstr ""
@@ -2162,8 +2162,8 @@ msgstr ""
 msgid "ButtonBar|Replac"
 msgstr ""
 
-#: src/editor/editwidget.c:664 src/filemanager/midnight.c:1660
-#: src/filemanager/tree.c:1182
+#: src/editor/editwidget.c:664 src/filemanager/filemanager.c:1653
+#: src/filemanager/tree.c:1177
 msgid "ButtonBar|Copy"
 msgstr ""
 
@@ -2171,11 +2171,11 @@ msgstr ""
 msgid "ButtonBar|Move"
 msgstr ""
 
-#: src/editor/editwidget.c:667 src/filemanager/midnight.c:1663
+#: src/editor/editwidget.c:667 src/filemanager/filemanager.c:1656
 msgid "ButtonBar|Delete"
 msgstr ""
 
-#: src/editor/editwidget.c:668 src/filemanager/midnight.c:1664
+#: src/editor/editwidget.c:668 src/filemanager/filemanager.c:1657
 msgid "ButtonBar|PullDn"
 msgstr ""
 
@@ -2299,11 +2299,11 @@ msgstr ""
 msgid "Select language"
 msgstr ""
 
-#: src/editor/syntax.c:1499 src/editor/syntax.c:1505
+#: src/editor/syntax.c:1496 src/editor/syntax.c:1502
 msgid "Load syntax file"
 msgstr ""
 
-#: src/editor/syntax.c:1500 src/help.c:1101 src/usermenu.c:955
+#: src/editor/syntax.c:1497 src/help.c:1101 src/usermenu.c:955
 #: src/usermenu.c:995
 #, c-format
 msgid ""
@@ -2311,7 +2311,7 @@ msgid ""
 "%s"
 msgstr ""
 
-#: src/editor/syntax.c:1506
+#: src/editor/syntax.c:1503
 #, c-format
 msgid "Error in file %s on line %d"
 msgstr ""
@@ -2324,12 +2324,12 @@ msgid ""
 "extra access permissions with the \"su\" command?"
 msgstr ""
 
-#: src/execute.c:196 src/filemanager/ext.c:660
+#: src/execute.c:196 src/filemanager/ext.c:662
 #, c-format
 msgid "Cannot fetch a local copy of %s"
 msgstr ""
 
-#: src/execute.c:437 src/filemanager/command.c:281
+#: src/execute.c:437 src/filemanager/command.c:123
 msgid "The shell is already running a command"
 msgstr ""
 
@@ -2343,307 +2343,311 @@ msgstr ""
 msgid "Type 'exit' to return to the Midnight Commander"
 msgstr ""
 
-#: src/filemanager/achown.c:86 src/filemanager/chattr.c:226
-#: src/filemanager/chmod.c:112 src/filemanager/chown.c:84
+#: src/filemanager/achown.c:84 src/filemanager/chattr.c:229
+#: src/filemanager/chmod.c:110 src/filemanager/chown.c:83
 msgid "Set &all"
 msgstr ""
 
-#: src/filemanager/achown.c:87
+#: src/filemanager/achown.c:85
 msgid "S&kip"
 msgstr ""
 
-#: src/filemanager/achown.c:88 src/filemanager/chattr.c:230
-#: src/filemanager/chmod.c:116 src/filemanager/chown.c:87
+#: src/filemanager/achown.c:86 src/filemanager/chattr.c:233
+#: src/filemanager/chmod.c:114 src/filemanager/chown.c:86
 msgid "&Set"
 msgstr ""
 
-#: src/filemanager/achown.c:287 src/filemanager/achown.c:294
-#: src/filemanager/achown.c:545
+#: src/filemanager/achown.c:285 src/filemanager/achown.c:292
+#: src/filemanager/achown.c:544
 msgid "owner"
 msgstr ""
 
-#: src/filemanager/achown.c:289 src/filemanager/achown.c:296
-#: src/filemanager/achown.c:550
+#: src/filemanager/achown.c:287 src/filemanager/achown.c:294
+#: src/filemanager/achown.c:549
 msgid "group"
 msgstr ""
 
-#: src/filemanager/achown.c:291
+#: src/filemanager/achown.c:289
 msgid "other"
 msgstr ""
 
-#: src/filemanager/achown.c:299
+#: src/filemanager/achown.c:297
 msgid "Flag"
 msgstr ""
 
-#: src/filemanager/achown.c:309
+#: src/filemanager/achown.c:307
 #, c-format
 msgid "Permissions (octal): %o"
 msgstr ""
 
-#: src/filemanager/achown.c:751
+#: src/filemanager/achown.c:750
 msgid "Chown advanced command"
 msgstr ""
 
-#: src/filemanager/achown.c:858 src/filemanager/achown.c:1053
-#: src/filemanager/chmod.c:436 src/filemanager/chmod.c:583
+#: src/filemanager/achown.c:857 src/filemanager/achown.c:1052
+#: src/filemanager/chmod.c:434 src/filemanager/chmod.c:581
 #, c-format
 msgid ""
 "Cannot chmod \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/achown.c:860 src/filemanager/achown.c:895
-#: src/filemanager/chattr.c:1099 src/filemanager/chmod.c:439
-#: src/filemanager/chown.c:311
+#: src/filemanager/achown.c:859 src/filemanager/achown.c:894
+#: src/filemanager/chattr.c:1104 src/filemanager/chmod.c:437
+#: src/filemanager/chown.c:310
 msgid "&Ignore"
 msgstr ""
 
-#: src/filemanager/achown.c:860 src/filemanager/achown.c:895
-#: src/filemanager/chattr.c:1099 src/filemanager/chmod.c:439
-#: src/filemanager/chown.c:311
+#: src/filemanager/achown.c:859 src/filemanager/achown.c:894
+#: src/filemanager/chattr.c:1104 src/filemanager/chmod.c:437
+#: src/filemanager/chown.c:310
 msgid "Ignore &all"
 msgstr ""
 
-#: src/filemanager/achown.c:860 src/filemanager/achown.c:895
-#: src/filemanager/chattr.c:1099 src/filemanager/chmod.c:439
-#: src/filemanager/chown.c:311 src/filemanager/file.c:920 src/viewer/hex.c:431
+#: src/filemanager/achown.c:859 src/filemanager/achown.c:894
+#: src/filemanager/chattr.c:1104 src/filemanager/chmod.c:437
+#: src/filemanager/chown.c:310 src/filemanager/file.c:911 src/viewer/hex.c:431
 msgid "&Retry"
 msgstr ""
 
-#: src/filemanager/achown.c:893 src/filemanager/achown.c:1059
-#: src/filemanager/chown.c:308 src/filemanager/chown.c:476
+#: src/filemanager/achown.c:892 src/filemanager/achown.c:1058
+#: src/filemanager/chown.c:307 src/filemanager/chown.c:475
 #, c-format
 msgid ""
 "Cannot chown \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/boxes.c:179
+#: src/filemanager/boxes.c:181
 msgid "< Default >"
 msgstr ""
 
-#: src/filemanager/boxes.c:225
+#: src/filemanager/boxes.c:227
 msgid "Skins"
 msgstr ""
 
-#: src/filemanager/boxes.c:349 src/filemanager/boxes.c:965
+#: src/filemanager/boxes.c:383 src/filemanager/boxes.c:1006
 #: src/selcodepage.c:101
 msgid "Other 8 bit"
 msgstr ""
 
-#: src/filemanager/boxes.c:434
+#: src/filemanager/boxes.c:468
 msgid "Running"
 msgstr ""
 
-#: src/filemanager/boxes.c:435 src/filemanager/find.c:1609
+#: src/filemanager/boxes.c:469 src/filemanager/find.c:1592
 msgid "Stopped"
 msgstr ""
 
-#: src/filemanager/boxes.c:502
+#: src/filemanager/boxes.c:536
 msgid "&Never"
 msgstr ""
 
-#: src/filemanager/boxes.c:503
+#: src/filemanager/boxes.c:537
 msgid "On dum&b terminals"
 msgstr ""
 
-#: src/filemanager/boxes.c:504
+#: src/filemanager/boxes.c:538
 msgid "Alwa&ys"
 msgstr ""
 
-#: src/filemanager/boxes.c:518
+#: src/filemanager/boxes.c:552
 msgid "File operations"
 msgstr ""
 
-#: src/filemanager/boxes.c:519
+#: src/filemanager/boxes.c:553
 msgid "&Verbose operation"
 msgstr ""
 
-#: src/filemanager/boxes.c:520
+#: src/filemanager/boxes.c:554
 msgid "Compute tota&ls"
 msgstr ""
 
-#: src/filemanager/boxes.c:521
+#: src/filemanager/boxes.c:555
 msgid "Classic pro&gressbar"
 msgstr ""
 
-#: src/filemanager/boxes.c:522
+#: src/filemanager/boxes.c:556
 msgid "Mkdi&r autoname"
 msgstr ""
 
-#: src/filemanager/boxes.c:523
+#: src/filemanager/boxes.c:557
 msgid "&Preallocate space"
 msgstr ""
 
-#: src/filemanager/boxes.c:526
+#: src/filemanager/boxes.c:560
 msgid "Esc key mode"
 msgstr ""
 
-#: src/filemanager/boxes.c:527
+#: src/filemanager/boxes.c:561
 msgid "S&ingle press"
 msgstr ""
 
-#: src/filemanager/boxes.c:528
+#: src/filemanager/boxes.c:562
 msgid "Timeout:"
 msgstr ""
 
-#: src/filemanager/boxes.c:533
+#: src/filemanager/boxes.c:567
 msgid "Pause after run"
 msgstr ""
 
-#: src/filemanager/boxes.c:538
+#: src/filemanager/boxes.c:572
 msgid "Use internal edi&t"
 msgstr ""
 
-#: src/filemanager/boxes.c:539
+#: src/filemanager/boxes.c:573
 msgid "Use internal vie&w"
 msgstr ""
 
-#: src/filemanager/boxes.c:540
+#: src/filemanager/boxes.c:574
 msgid "A&sk new file name"
 msgstr ""
 
-#: src/filemanager/boxes.c:542
+#: src/filemanager/boxes.c:576
 msgid "Auto m&enus"
 msgstr ""
 
-#: src/filemanager/boxes.c:543
+#: src/filemanager/boxes.c:577
 msgid "&Drop down menus"
 msgstr ""
 
-#: src/filemanager/boxes.c:544
+#: src/filemanager/boxes.c:578
 msgid "S&hell patterns"
 msgstr ""
 
-#: src/filemanager/boxes.c:545
+#: src/filemanager/boxes.c:579
 msgid "Co&mplete: show all"
 msgstr ""
 
-#: src/filemanager/boxes.c:547
+#: src/filemanager/boxes.c:581
 msgid "Rotating d&ash"
 msgstr ""
 
-#: src/filemanager/boxes.c:548
+#: src/filemanager/boxes.c:582
 msgid "Cd follows lin&ks"
 msgstr ""
 
-#: src/filemanager/boxes.c:549
+#: src/filemanager/boxes.c:583
 msgid "Sa&fe delete"
 msgstr ""
 
-#: src/filemanager/boxes.c:550
+#: src/filemanager/boxes.c:584
 msgid "Safe overwrite"
 msgstr ""
 
-#: src/filemanager/boxes.c:551
+#: src/filemanager/boxes.c:585
 msgid "A&uto save setup"
 msgstr ""
 
-#: src/filemanager/boxes.c:563
+#: src/filemanager/boxes.c:597
 msgid "Configure options"
 msgstr ""
 
-#: src/filemanager/boxes.c:600
+#: src/filemanager/boxes.c:636
 msgid "Skin:"
 msgstr ""
 
-#: src/filemanager/boxes.c:612
+#: src/filemanager/boxes.c:642
+msgid "&Shadows"
+msgstr ""
+
+#: src/filemanager/boxes.c:650
 msgid "Appearance"
 msgstr ""
 
-#: src/filemanager/boxes.c:639
+#: src/filemanager/boxes.c:680
 msgid "Case &insensitive"
 msgstr ""
 
-#: src/filemanager/boxes.c:641
+#: src/filemanager/boxes.c:682
 msgid "Use panel sort mo&de"
 msgstr ""
 
-#: src/filemanager/boxes.c:648
+#: src/filemanager/boxes.c:689
 msgid "Show mi&ni-status"
 msgstr ""
 
-#: src/filemanager/boxes.c:649
+#: src/filemanager/boxes.c:690
 msgid "Use SI si&ze units"
 msgstr ""
 
-#: src/filemanager/boxes.c:650
+#: src/filemanager/boxes.c:691
 msgid "Mi&x all files"
 msgstr ""
 
-#: src/filemanager/boxes.c:651
+#: src/filemanager/boxes.c:692
 msgid "Show &backup files"
 msgstr ""
 
-#: src/filemanager/boxes.c:652
+#: src/filemanager/boxes.c:693
 msgid "Show &hidden files"
 msgstr ""
 
-#: src/filemanager/boxes.c:653
+#: src/filemanager/boxes.c:694
 msgid "&Fast dir reload"
 msgstr ""
 
-#: src/filemanager/boxes.c:654
+#: src/filemanager/boxes.c:695
 msgid "Ma&rk moves down"
 msgstr ""
 
-#: src/filemanager/boxes.c:655
+#: src/filemanager/boxes.c:696
 msgid "Re&verse files only"
 msgstr ""
 
-#: src/filemanager/boxes.c:657
+#: src/filemanager/boxes.c:698
 msgid "Simple s&wap"
 msgstr ""
 
-#: src/filemanager/boxes.c:658
+#: src/filemanager/boxes.c:699
 msgid "A&uto save panels setup"
 msgstr ""
 
-#: src/filemanager/boxes.c:665
+#: src/filemanager/boxes.c:706
 msgid "Navigation"
 msgstr ""
 
-#: src/filemanager/boxes.c:666
+#: src/filemanager/boxes.c:707
 msgid "L&ynx-like motion"
 msgstr ""
 
-#: src/filemanager/boxes.c:668
+#: src/filemanager/boxes.c:709
 msgid "Pa&ge scrolling"
 msgstr ""
 
-#: src/filemanager/boxes.c:669
+#: src/filemanager/boxes.c:710
 msgid "Center &scrolling"
 msgstr ""
 
-#: src/filemanager/boxes.c:670
+#: src/filemanager/boxes.c:711
 msgid "&Mouse page scrolling"
 msgstr ""
 
-#: src/filemanager/boxes.c:673
+#: src/filemanager/boxes.c:714
 msgid "File highlight"
 msgstr ""
 
-#: src/filemanager/boxes.c:674
+#: src/filemanager/boxes.c:715
 msgid "File &types"
 msgstr ""
 
-#: src/filemanager/boxes.c:675
+#: src/filemanager/boxes.c:716
 msgid "&Permissions"
 msgstr ""
 
-#: src/filemanager/boxes.c:677
+#: src/filemanager/boxes.c:718
 msgid "Quick search"
 msgstr ""
 
-#: src/filemanager/boxes.c:689
+#: src/filemanager/boxes.c:730
 msgid "Panel options"
 msgstr ""
 
-#: src/filemanager/boxes.c:701 src/filemanager/info.c:90
+#: src/filemanager/boxes.c:742 src/filemanager/info.c:90
 msgid "Information"
 msgstr ""
 
-#: src/filemanager/boxes.c:702
+#: src/filemanager/boxes.c:743
 msgid ""
 "Using the fast reload option may not reflect the exact\n"
 "directory contents. In this case you'll need to do a\n"
@@ -2651,657 +2655,661 @@ msgid ""
 "the details."
 msgstr ""
 
-#: src/filemanager/boxes.c:736
+#: src/filemanager/boxes.c:777
 msgid "&Full file list"
 msgstr ""
 
-#: src/filemanager/boxes.c:737
+#: src/filemanager/boxes.c:778
 msgid "&Brief file list:"
 msgstr ""
 
-#: src/filemanager/boxes.c:738
+#: src/filemanager/boxes.c:779
 msgid "&Long file list"
 msgstr ""
 
-#: src/filemanager/boxes.c:739
+#: src/filemanager/boxes.c:780
 msgid "&User defined:"
 msgstr ""
 
-#: src/filemanager/boxes.c:748
+#: src/filemanager/boxes.c:789
 msgid "columns"
 msgstr ""
 
-#: src/filemanager/boxes.c:755
+#: src/filemanager/boxes.c:796
 msgid "User &mini status"
 msgstr ""
 
-#: src/filemanager/boxes.c:765
+#: src/filemanager/boxes.c:806
 msgid "Listing format"
 msgstr ""
 
-#: src/filemanager/boxes.c:844
+#: src/filemanager/boxes.c:885
 msgid "Executable &first"
 msgstr ""
 
-#: src/filemanager/boxes.c:846
+#: src/filemanager/boxes.c:887
 msgid "&Reverse"
 msgstr ""
 
-#: src/filemanager/boxes.c:855
+#: src/filemanager/boxes.c:896
 msgid "Sort order"
 msgstr ""
 
 #. TRANSLATORS: no need to translate 'Confirmation', it's just a context prefix
-#: src/filemanager/boxes.c:879
+#: src/filemanager/boxes.c:920
 msgid "Confirmation|&Delete"
 msgstr ""
 
-#: src/filemanager/boxes.c:880
+#: src/filemanager/boxes.c:921
 msgid "Confirmation|O&verwrite"
 msgstr ""
 
-#: src/filemanager/boxes.c:881
+#: src/filemanager/boxes.c:922
 msgid "Confirmation|&Execute"
 msgstr ""
 
-#: src/filemanager/boxes.c:882
+#: src/filemanager/boxes.c:923
 msgid "Confirmation|E&xit"
 msgstr ""
 
-#: src/filemanager/boxes.c:883
+#: src/filemanager/boxes.c:924
 msgid "Confirmation|Di&rectory hotlist delete"
 msgstr ""
 
-#: src/filemanager/boxes.c:885
+#: src/filemanager/boxes.c:926
 msgid "Confirmation|&History cleanup"
 msgstr ""
 
-#: src/filemanager/boxes.c:894 src/filemanager/cmd.c:138
+#: src/filemanager/boxes.c:935 src/filemanager/cmd.c:139
 msgid "Confirmation"
 msgstr ""
 
-#: src/filemanager/boxes.c:911
+#: src/filemanager/boxes.c:952
 msgid "&UTF-8 output"
 msgstr ""
 
-#: src/filemanager/boxes.c:912
+#: src/filemanager/boxes.c:953
 msgid "&Full 8 bits output"
 msgstr ""
 
-#: src/filemanager/boxes.c:913
+#: src/filemanager/boxes.c:954
 msgid "&ISO 8859-1"
 msgstr ""
 
-#: src/filemanager/boxes.c:914
+#: src/filemanager/boxes.c:955
 msgid "7 &bits"
 msgstr ""
 
-#: src/filemanager/boxes.c:921 src/filemanager/boxes.c:979
+#: src/filemanager/boxes.c:962 src/filemanager/boxes.c:1020
 msgid "F&ull 8 bits input"
 msgstr ""
 
-#: src/filemanager/boxes.c:929 src/filemanager/boxes.c:987
+#: src/filemanager/boxes.c:970 src/filemanager/boxes.c:1028
 msgid "Display bits"
 msgstr ""
 
-#: src/filemanager/boxes.c:974
+#: src/filemanager/boxes.c:1015
 msgid "Input / display codepage:"
 msgstr ""
 
-#: src/filemanager/boxes.c:1037 src/filemanager/tree.c:1132
+#: src/filemanager/boxes.c:1078 src/filemanager/tree.c:1127
 msgid "Directory tree"
 msgstr ""
 
-#: src/filemanager/boxes.c:1087
+#: src/filemanager/boxes.c:1128
 msgid "Timeout for freeing VFSs (sec):"
 msgstr ""
 
-#: src/filemanager/boxes.c:1092
+#: src/filemanager/boxes.c:1133
 msgid "FTP anonymous password:"
 msgstr ""
 
-#: src/filemanager/boxes.c:1095
+#: src/filemanager/boxes.c:1136
 msgid "FTP directory cache timeout (sec):"
 msgstr ""
 
-#: src/filemanager/boxes.c:1098
+#: src/filemanager/boxes.c:1139
 msgid "&Always use ftp proxy:"
 msgstr ""
 
-#: src/filemanager/boxes.c:1102
+#: src/filemanager/boxes.c:1143
 msgid "&Use ~/.netrc"
 msgstr ""
 
-#: src/filemanager/boxes.c:1103
+#: src/filemanager/boxes.c:1144
 msgid "Use &passive mode"
 msgstr ""
 
-#: src/filemanager/boxes.c:1104
+#: src/filemanager/boxes.c:1145
 msgid "Use passive mode over pro&xy"
 msgstr ""
 
-#: src/filemanager/boxes.c:1114
+#: src/filemanager/boxes.c:1155
 msgid "Virtual File System Setting"
 msgstr ""
 
-#: src/filemanager/boxes.c:1163
+#: src/filemanager/boxes.c:1204
 msgid "cd"
 msgstr ""
 
-#: src/filemanager/boxes.c:1170
+#: src/filemanager/boxes.c:1211
 msgid "Quick cd"
 msgstr ""
 
-#: src/filemanager/boxes.c:1185
+#: src/filemanager/boxes.c:1226
 msgid "Existing filename (filename symlink will point to):"
 msgstr ""
 
-#: src/filemanager/boxes.c:1189
+#: src/filemanager/boxes.c:1230
 msgid "Symbolic link filename:"
 msgstr ""
 
-#: src/filemanager/boxes.c:1199
+#: src/filemanager/boxes.c:1240
 msgid "Symbolic link"
 msgstr ""
 
-#: src/filemanager/boxes.c:1227
+#: src/filemanager/boxes.c:1268
 msgid "&Stop"
 msgstr ""
 
-#: src/filemanager/boxes.c:1228
+#: src/filemanager/boxes.c:1269
 msgid "&Resume"
 msgstr ""
 
-#: src/filemanager/boxes.c:1229
+#: src/filemanager/boxes.c:1270
 msgid "&Kill"
 msgstr ""
 
-#: src/filemanager/boxes.c:1259
+#: src/filemanager/boxes.c:1300
 msgid "Background jobs"
 msgstr ""
 
-#: src/filemanager/boxes.c:1295
+#: src/filemanager/boxes.c:1336
 #, c-format
 msgid "Password for \\\\%s\\%s"
 msgstr ""
 
-#: src/filemanager/boxes.c:1305
+#: src/filemanager/boxes.c:1346
 msgid "Domain:"
 msgstr ""
 
-#: src/filemanager/boxes.c:1307
+#: src/filemanager/boxes.c:1348
 msgid "Username:"
 msgstr ""
 
-#: src/filemanager/boxes.c:1324
+#: src/filemanager/boxes.c:1365
 msgid "SMB authentication"
 msgstr ""
 
-#: src/filemanager/chattr.c:144
+#: src/filemanager/cd.c:287 src/filemanager/panel.c:3668
+#: src/filemanager/tree.c:596
+#, c-format
+msgid ""
+"Cannot chdir to \"%s\"\n"
+"%s"
+msgstr ""
+
+#: src/filemanager/chattr.c:141
 msgid "Secure deletion"
 msgstr ""
 
-#: src/filemanager/chattr.c:145
+#: src/filemanager/chattr.c:142
 msgid "Undelete"
 msgstr ""
 
-#: src/filemanager/chattr.c:146
+#: src/filemanager/chattr.c:143
 msgid "Synchronous updates"
 msgstr ""
 
-#: src/filemanager/chattr.c:147
+#: src/filemanager/chattr.c:144
 msgid "Synchronous directory updates"
 msgstr ""
 
-#: src/filemanager/chattr.c:148
+#: src/filemanager/chattr.c:145
 msgid "Immutable"
 msgstr ""
 
-#: src/filemanager/chattr.c:149
+#: src/filemanager/chattr.c:146
 msgid "Append only"
 msgstr ""
 
-#: src/filemanager/chattr.c:150
+#: src/filemanager/chattr.c:147
 msgid "No dump"
 msgstr ""
 
-#: src/filemanager/chattr.c:151
+#: src/filemanager/chattr.c:148
 msgid "No update atime"
 msgstr ""
 
-#: src/filemanager/chattr.c:152
+#: src/filemanager/chattr.c:149
 msgid "Compress"
 msgstr ""
 
-#: src/filemanager/chattr.c:156
+#: src/filemanager/chattr.c:153
 msgid "Compressed clusters"
 msgstr ""
 
-#: src/filemanager/chattr.c:161
+#: src/filemanager/chattr.c:158
 msgid "Compressed dirty file"
 msgstr ""
 
-#: src/filemanager/chattr.c:166
+#: src/filemanager/chattr.c:163
 msgid "Compression raw access"
 msgstr ""
 
-#: src/filemanager/chattr.c:169
+#: src/filemanager/chattr.c:166
 msgid "Encrypted inode"
 msgstr ""
 
-#: src/filemanager/chattr.c:171
+#: src/filemanager/chattr.c:168
 msgid "Journaled data"
 msgstr ""
 
-#: src/filemanager/chattr.c:172
+#: src/filemanager/chattr.c:169
 msgid "Indexed directory"
 msgstr ""
 
-#: src/filemanager/chattr.c:173
+#: src/filemanager/chattr.c:170
 msgid "No tail merging"
 msgstr ""
 
-#: src/filemanager/chattr.c:174
+#: src/filemanager/chattr.c:171
 msgid "Top of directory hierarchies"
 msgstr ""
 
-#: src/filemanager/chattr.c:175
+#: src/filemanager/chattr.c:172
 msgid "Inode uses extents"
 msgstr ""
 
-#: src/filemanager/chattr.c:179
+#: src/filemanager/chattr.c:176
 msgid "Huge_file"
 msgstr ""
 
-#: src/filemanager/chattr.c:181
+#: src/filemanager/chattr.c:178
 msgid "No COW"
 msgstr ""
 
-#: src/filemanager/chattr.c:185
-msgid "Casefolded file"
+#: src/filemanager/chattr.c:183
+msgid "Direct access for files"
 msgstr ""
 
 #: src/filemanager/chattr.c:188
+msgid "Casefolded file"
+msgstr ""
+
+#: src/filemanager/chattr.c:191
 msgid "Inode has inline data"
 msgstr ""
 
-#: src/filemanager/chattr.c:194
+#: src/filemanager/chattr.c:197
 msgid "Project hierarchy"
 msgstr ""
 
-#: src/filemanager/chattr.c:201
+#: src/filemanager/chattr.c:204
 msgid "Verity protected inode"
 msgstr ""
 
-#: src/filemanager/chattr.c:227 src/filemanager/chmod.c:113
+#: src/filemanager/chattr.c:230 src/filemanager/chmod.c:111
 msgid "&Marked all"
 msgstr ""
 
-#: src/filemanager/chattr.c:228 src/filemanager/chmod.c:114
+#: src/filemanager/chattr.c:231 src/filemanager/chmod.c:112
 msgid "S&et marked"
 msgstr ""
 
-#: src/filemanager/chattr.c:229 src/filemanager/chmod.c:115
+#: src/filemanager/chattr.c:232 src/filemanager/chmod.c:113
 msgid "C&lear marked"
 msgstr ""
 
-#: src/filemanager/chattr.c:978
+#: src/filemanager/chattr.c:983
 msgid "Chattr command"
 msgstr ""
 
-#: src/filemanager/chattr.c:1096 src/filemanager/chattr.c:1252
+#: src/filemanager/chattr.c:1101 src/filemanager/chattr.c:1257
 #, c-format
 msgid ""
 "Cannot chattr \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/chattr.c:1208
+#: src/filemanager/chattr.c:1213
 msgid "Cannot change attributes on non-local filesystems"
 msgstr ""
 
-#: src/filemanager/chattr.c:1227
+#: src/filemanager/chattr.c:1232
 #, c-format
 msgid ""
 "Cannot get flags of \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/chmod.c:76
+#: src/filemanager/chmod.c:74
 msgid "set &user ID on execution"
 msgstr ""
 
-#: src/filemanager/chmod.c:77
+#: src/filemanager/chmod.c:75
 msgid "set &group ID on execution"
 msgstr ""
 
-#: src/filemanager/chmod.c:78
+#: src/filemanager/chmod.c:76
 msgid "stick&y bit"
 msgstr ""
 
-#: src/filemanager/chmod.c:79
+#: src/filemanager/chmod.c:77
 msgid "&read by owner"
 msgstr ""
 
-#: src/filemanager/chmod.c:80
+#: src/filemanager/chmod.c:78
 msgid "&write by owner"
 msgstr ""
 
-#: src/filemanager/chmod.c:81
+#: src/filemanager/chmod.c:79
 msgid "e&xecute/search by owner"
 msgstr ""
 
-#: src/filemanager/chmod.c:82
+#: src/filemanager/chmod.c:80
 msgid "rea&d by group"
 msgstr ""
 
-#: src/filemanager/chmod.c:83
+#: src/filemanager/chmod.c:81
 msgid "write by grou&p"
 msgstr ""
 
-#: src/filemanager/chmod.c:84
+#: src/filemanager/chmod.c:82
 msgid "execu&te/search by group"
 msgstr ""
 
-#: src/filemanager/chmod.c:85
+#: src/filemanager/chmod.c:83
 msgid "read &by others"
 msgstr ""
 
-#: src/filemanager/chmod.c:86
+#: src/filemanager/chmod.c:84
 msgid "wr&ite by others"
 msgstr ""
 
-#: src/filemanager/chmod.c:87
+#: src/filemanager/chmod.c:85
 msgid "execute/searc&h by others"
 msgstr ""
 
-#: src/filemanager/chmod.c:94
+#: src/filemanager/chmod.c:92
 msgid "Name:"
 msgstr ""
 
-#: src/filemanager/chmod.c:95
+#: src/filemanager/chmod.c:93
 msgid "Permissions (octal):"
 msgstr ""
 
-#: src/filemanager/chmod.c:96
+#: src/filemanager/chmod.c:94
 msgid "Owner name:"
 msgstr ""
 
-#: src/filemanager/chmod.c:97
+#: src/filemanager/chmod.c:95
 msgid "Group name:"
 msgstr ""
 
-#: src/filemanager/chmod.c:337
+#: src/filemanager/chmod.c:335
 msgid "Chmod command"
 msgstr ""
 
-#: src/filemanager/chmod.c:343 src/filemanager/chown.c:167
+#: src/filemanager/chmod.c:341 src/filemanager/chown.c:166
 #: src/filemanager/panel.c:256
 msgid "Permission"
 msgstr ""
 
-#: src/filemanager/chmod.c:352 src/filemanager/chown.c:234
+#: src/filemanager/chmod.c:350 src/filemanager/chown.c:233
 msgid "File"
 msgstr ""
 
-#: src/filemanager/chown.c:85
+#: src/filemanager/chown.c:84
 msgid "Set &groups"
 msgstr ""
 
-#: src/filemanager/chown.c:86
+#: src/filemanager/chown.c:85
 msgid "Set &users"
 msgstr ""
 
-#: src/filemanager/chown.c:159
+#: src/filemanager/chown.c:158
 msgid "Name"
 msgstr ""
 
-#: src/filemanager/chown.c:161
+#: src/filemanager/chown.c:160
 msgid "Owner name"
 msgstr ""
 
-#: src/filemanager/chown.c:163 src/filemanager/chown.c:223
+#: src/filemanager/chown.c:162 src/filemanager/chown.c:222
 msgid "Group name"
 msgstr ""
 
-#: src/filemanager/chown.c:165
+#: src/filemanager/chown.c:164
 msgid "Size"
 msgstr ""
 
-#: src/filemanager/chown.c:206
+#: src/filemanager/chown.c:205
 msgid "Chown command"
 msgstr ""
 
-#: src/filemanager/chown.c:212
+#: src/filemanager/chown.c:211
 msgid "User name"
 msgstr ""
 
-#: src/filemanager/chown.c:216
+#: src/filemanager/chown.c:215
 msgid "<Unknown user>"
 msgstr ""
 
-#: src/filemanager/chown.c:227
+#: src/filemanager/chown.c:226
 msgid "<Unknown group>"
 msgstr ""
 
-#: src/filemanager/cmd.c:119
+#: src/filemanager/cmd.c:120
 msgid "Enter machine name (F1 for details):"
 msgstr ""
 
-#: src/filemanager/cmd.c:138
+#: src/filemanager/cmd.c:139
 msgid "Files tagged, want to cd?"
 msgstr ""
 
-#: src/filemanager/cmd.c:144 src/filemanager/cmd.c:1130
-#: src/filemanager/panel.c:2801 src/filemanager/panel.c:3378
+#: src/filemanager/cmd.c:145 src/filemanager/cmd.c:1129
+#: src/filemanager/panel.c:2797 src/filemanager/panel.c:3376
 msgid "Cannot change directory"
 msgstr ""
 
-#: src/filemanager/cmd.c:195
+#: src/filemanager/cmd.c:196
 msgid "Filter"
 msgstr ""
 
-#: src/filemanager/cmd.c:196
+#: src/filemanager/cmd.c:197
 msgid "Set expression for filtering filenames"
 msgstr ""
 
-#: src/filemanager/cmd.c:354
+#: src/filemanager/cmd.c:355
 #, c-format
 msgid "Link %s to:"
 msgstr ""
 
-#: src/filemanager/cmd.c:356
+#: src/filemanager/cmd.c:357
 msgid "Link"
 msgstr ""
 
-#: src/filemanager/cmd.c:365
+#: src/filemanager/cmd.c:366
 #, c-format
 msgid "link: %s"
 msgstr ""
 
-#: src/filemanager/cmd.c:404
+#: src/filemanager/cmd.c:405
 #, c-format
 msgid "symlink: %s"
 msgstr ""
 
-#: src/filemanager/cmd.c:464 src/filemanager/panel.c:4754
+#: src/filemanager/cmd.c:465 src/filemanager/panel.c:4755
 #, c-format
 msgid "Cannot chdir to \"%s\""
 msgstr ""
 
-#: src/filemanager/cmd.c:627
+#: src/filemanager/cmd.c:628
 msgid "View file"
 msgstr ""
 
-#: src/filemanager/cmd.c:627
+#: src/filemanager/cmd.c:628
 msgid "Filename:"
 msgstr ""
 
-#: src/filemanager/cmd.c:661
+#: src/filemanager/cmd.c:662
 msgid "Filtered view"
 msgstr ""
 
-#: src/filemanager/cmd.c:662
+#: src/filemanager/cmd.c:663
 msgid "Filter command and arguments:"
 msgstr ""
 
-#: src/filemanager/cmd.c:750
+#: src/filemanager/cmd.c:751
 msgid "Edit file"
 msgstr ""
 
-#: src/filemanager/cmd.c:842
+#: src/filemanager/cmd.c:843
 msgid "Create a new Directory"
 msgstr ""
 
-#: src/filemanager/cmd.c:843
+#: src/filemanager/cmd.c:844
 msgid "Enter directory name:"
 msgstr ""
 
-#: src/filemanager/cmd.c:948
+#: src/filemanager/cmd.c:949
 msgid "Extension file edit"
 msgstr ""
 
-#: src/filemanager/cmd.c:949
+#: src/filemanager/cmd.c:950
 msgid "Which extension file you want to edit?"
 msgstr ""
 
-#: src/filemanager/cmd.c:950 src/filemanager/cmd.c:991
-#: src/filemanager/cmd.c:1049
+#: src/filemanager/cmd.c:951 src/filemanager/cmd.c:992
+#: src/filemanager/cmd.c:1050
 msgid "&System Wide"
 msgstr ""
 
-#: src/filemanager/cmd.c:1047
+#: src/filemanager/cmd.c:1048
 msgid "Highlighting groups file edit"
 msgstr ""
 
-#: src/filemanager/cmd.c:1048
+#: src/filemanager/cmd.c:1049
 msgid "Which highlighting file you want to edit?"
 msgstr ""
 
-#: src/filemanager/cmd.c:1145
+#: src/filemanager/cmd.c:1144
 msgid "Compare directories"
 msgstr ""
 
-#: src/filemanager/cmd.c:1146
+#: src/filemanager/cmd.c:1145
 msgid "Select compare method:"
 msgstr ""
 
-#: src/filemanager/cmd.c:1147
+#: src/filemanager/cmd.c:1146
 msgid "&Quick"
 msgstr ""
 
-#: src/filemanager/cmd.c:1147
+#: src/filemanager/cmd.c:1146
 msgid "&Size only"
 msgstr ""
 
-#: src/filemanager/cmd.c:1147
+#: src/filemanager/cmd.c:1146
 msgid "&Thorough"
 msgstr ""
 
-#: src/filemanager/cmd.c:1161
+#: src/filemanager/cmd.c:1160
 msgid ""
 "Both panels should be in the listing mode\n"
 "to use this command"
 msgstr ""
 
-#: src/filemanager/cmd.c:1219
+#: src/filemanager/cmd.c:1218
 #, c-format
 msgid "'%s' is not a symbolic link"
 msgstr ""
 
-#: src/filemanager/cmd.c:1232
+#: src/filemanager/cmd.c:1231
 #, c-format
 msgid "Symlink '%s' points to:"
 msgstr ""
 
-#: src/filemanager/cmd.c:1234
+#: src/filemanager/cmd.c:1233
 msgid "Edit symlink"
 msgstr ""
 
-#: src/filemanager/cmd.c:1247
+#: src/filemanager/cmd.c:1246
 #, c-format
 msgid "edit symlink, unable to remove %s: %s"
 msgstr ""
 
-#: src/filemanager/cmd.c:1255
+#: src/filemanager/cmd.c:1254
 #, c-format
 msgid "edit symlink: %s"
 msgstr ""
 
-#: src/filemanager/cmd.c:1300
+#: src/filemanager/cmd.c:1299
 msgid "FTP to machine"
 msgstr ""
 
-#: src/filemanager/cmd.c:1311
+#: src/filemanager/cmd.c:1310
 msgid "SFTP to machine"
 msgstr ""
 
-#: src/filemanager/cmd.c:1323
+#: src/filemanager/cmd.c:1322
 msgid "Shell link to machine"
 msgstr ""
 
-#: src/filemanager/cmd.c:1335
+#: src/filemanager/cmd.c:1334
 msgid "SMB link to machine"
 msgstr ""
 
-#: src/filemanager/cmd.c:1346
+#: src/filemanager/cmd.c:1345
 msgid "Undelete files on an ext2 file system"
 msgstr ""
 
-#: src/filemanager/cmd.c:1347
+#: src/filemanager/cmd.c:1346
 msgid ""
 "Enter device (without /dev/) to undelete\n"
 "files on: (F1 for details)"
 msgstr ""
 
-#: src/filemanager/cmd.c:1415 src/filemanager/cmd.c:1450
-#: src/filemanager/file.c:760
+#: src/filemanager/cmd.c:1404 src/filemanager/cmd.c:1438
+#: src/filemanager/file.c:748
 msgid "Directory scanning"
 msgstr ""
 
-#: src/filemanager/cmd.c:1496 src/filemanager/cmd.c:1498
+#: src/filemanager/cmd.c:1484 src/filemanager/cmd.c:1486
 msgid "Setup"
 msgstr ""
 
-#: src/filemanager/cmd.c:1496
+#: src/filemanager/cmd.c:1484
 #, c-format
 msgid "Setup saved to %s"
 msgstr ""
 
-#: src/filemanager/cmd.c:1498
+#: src/filemanager/cmd.c:1486
 #, c-format
 msgid "Unable to save setup to %s"
 msgstr ""
 
-#: src/filemanager/command.c:273 src/usermenu.c:944
+#: src/filemanager/command.c:115 src/usermenu.c:944
 msgid "Cannot execute commands on non-local filesystems"
 msgstr ""
 
-#: src/filemanager/command.c:447 src/filemanager/panel.c:3670
-#: src/filemanager/tree.c:593
-#, c-format
-msgid ""
-"Cannot chdir to \"%s\"\n"
-"%s"
-msgstr ""
-
-#: src/filemanager/ext.c:245 src/usermenu.c:476
+#: src/filemanager/ext.c:247 src/usermenu.c:476
 msgid "Parameter"
 msgstr ""
 
-#: src/filemanager/ext.c:458 src/usermenu.c:446
+#: src/filemanager/ext.c:460 src/usermenu.c:446
 #, c-format
 msgid ""
 "Cannot create temporary command file\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/ext.c:842
+#: src/filemanager/ext.c:844
 #, c-format
 msgid " %s%s file error"
 msgstr ""
 
-#: src/filemanager/ext.c:844
+#: src/filemanager/ext.c:846
 #, c-format
 msgid ""
 "The format of the %smc.ext file has changed with version 3.0. It seems that "
@@ -3309,29 +3317,29 @@ msgid ""
 "Commander package."
 msgstr ""
 
-#: src/filemanager/ext.c:864
+#: src/filemanager/ext.c:866
 #, c-format
 msgid "%s file error"
 msgstr ""
 
-#: src/filemanager/ext.c:866
+#: src/filemanager/ext.c:868
 #, c-format
 msgid ""
 "The format of the %s file has changed with version 3.0. You may either want "
 "to copy it from %smc.ext or use that file as an example of how to write it."
 msgstr ""
 
-#: src/filemanager/file.c:95 src/filemanager/file.c:2701
-#: src/filemanager/tree.c:724
+#: src/filemanager/file.c:95 src/filemanager/file.c:2675
+#: src/filemanager/tree.c:719
 msgid "DialogTitle|Copy"
 msgstr ""
 
-#: src/filemanager/file.c:96 src/filemanager/tree.c:764
+#: src/filemanager/file.c:96 src/filemanager/tree.c:759
 msgid "DialogTitle|Move"
 msgstr ""
 
-#: src/filemanager/file.c:97 src/filemanager/hotlist.c:1157
-#: src/filemanager/hotlist.c:1174 src/filemanager/tree.c:834
+#: src/filemanager/file.c:97 src/filemanager/hotlist.c:1158
+#: src/filemanager/hotlist.c:1175 src/filemanager/tree.c:829
 msgid "DialogTitle|Delete"
 msgstr ""
 
@@ -3418,7 +3426,7 @@ msgid ""
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:886
+#: src/filemanager/file.c:877
 #, c-format
 msgid ""
 "\"%s\"\n"
@@ -3427,7 +3435,7 @@ msgid ""
 "are the same directory"
 msgstr ""
 
-#: src/filemanager/file.c:888
+#: src/filemanager/file.c:879
 #, c-format
 msgid ""
 "\"%s\"\n"
@@ -3436,18 +3444,18 @@ msgid ""
 "are the same file"
 msgstr ""
 
-#: src/filemanager/file.c:920 src/filemanager/file.c:923
+#: src/filemanager/file.c:911 src/filemanager/file.c:914
 msgid "Ski&p all"
 msgstr ""
 
-#: src/filemanager/file.c:960
+#: src/filemanager/file.c:951
 #, c-format
 msgid ""
 "Directory \"%s\" not empty.\n"
 "Delete it recursively?"
 msgstr ""
 
-#: src/filemanager/file.c:961
+#: src/filemanager/file.c:952
 #, c-format
 msgid ""
 "Background process:\n"
@@ -3455,232 +3463,232 @@ msgid ""
 "Delete it recursively?"
 msgstr ""
 
-#: src/filemanager/file.c:969 src/filemanager/filegui.c:475
+#: src/filemanager/file.c:960 src/filemanager/filegui.c:475
 msgid "Non&e"
 msgstr ""
 
-#: src/filemanager/file.c:1168
+#: src/filemanager/file.c:1159
 #, c-format
 msgid ""
 "Cannot remove file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1226
+#: src/filemanager/file.c:1217
 #, c-format
 msgid ""
 "Cannot stat file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1242
+#: src/filemanager/file.c:1233
 #, c-format
 msgid "Cannot overwrite directory \"%s\""
 msgstr ""
 
-#: src/filemanager/file.c:1288
+#: src/filemanager/file.c:1279
 #, c-format
 msgid ""
 "Cannot move file \"%s\" to \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1394
+#: src/filemanager/file.c:1385
 #, c-format
 msgid ""
 "Cannot remove directory \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1636 src/filemanager/file.c:2254
+#: src/filemanager/file.c:1627 src/filemanager/file.c:2245
 #, c-format
 msgid ""
 "Cannot overwrite directory \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1638
+#: src/filemanager/file.c:1629
 #, c-format
 msgid ""
 "Cannot overwrite file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1659
+#: src/filemanager/file.c:1650
 #, c-format
 msgid ""
 "Cannot move directory \"%s\" to \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:1761
+#: src/filemanager/file.c:1752
 msgid "Cannot operate on \"..\"!"
 msgstr ""
 
-#: src/filemanager/file.c:2273
+#: src/filemanager/file.c:2264
 #, c-format
 msgid ""
 "Cannot stat source file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2338
+#: src/filemanager/file.c:2329
 #, c-format
 msgid ""
 "Cannot create special file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2350 src/filemanager/file.c:2712
+#: src/filemanager/file.c:2341 src/filemanager/file.c:2686
 #, c-format
 msgid ""
 "Cannot chown target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2365 src/filemanager/file.c:2733
+#: src/filemanager/file.c:2356 src/filemanager/file.c:2702
 #, c-format
 msgid ""
 "Cannot chmod target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2386
+#: src/filemanager/file.c:2377
 #, c-format
 msgid ""
 "Cannot open source file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2401
+#: src/filemanager/file.c:2390
 msgid "Reget failed, about to overwrite file"
 msgstr ""
 
-#: src/filemanager/file.c:2413
+#: src/filemanager/file.c:2401
 #, c-format
 msgid ""
 "Cannot fstat source file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2451
+#: src/filemanager/file.c:2434
 #, c-format
 msgid ""
 "Cannot create target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2481
+#: src/filemanager/file.c:2465
 #, c-format
 msgid ""
 "Cannot fstat target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2502
+#: src/filemanager/file.c:2486
 #, c-format
 msgid ""
 "Cannot preallocate space for target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2559
+#: src/filemanager/file.c:2544
 #, c-format
 msgid ""
 "Cannot read source file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2604
+#: src/filemanager/file.c:2583
 #, c-format
 msgid ""
 "Cannot write target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2639
+#: src/filemanager/file.c:2618
 msgid "(stalled)"
 msgstr ""
 
-#: src/filemanager/file.c:2677
+#: src/filemanager/file.c:2651
 #, c-format
 msgid ""
 "Cannot close source file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2689
+#: src/filemanager/file.c:2663
 #, c-format
 msgid ""
 "Cannot close target file \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2701
+#: src/filemanager/file.c:2675
 msgid "Incomplete file was retrieved. Keep it?"
 msgstr ""
 
-#: src/filemanager/file.c:2702
+#: src/filemanager/file.c:2676
 msgid "&Keep"
 msgstr ""
 
-#: src/filemanager/file.c:2798
+#: src/filemanager/file.c:2767
 #, c-format
 msgid ""
 "Cannot stat source directory \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2842
+#: src/filemanager/file.c:2811
 #, c-format
 msgid ""
 "Source \"%s\" is not a directory\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2854
+#: src/filemanager/file.c:2823
 #, c-format
 msgid ""
 "Cannot copy cyclic symbolic link\n"
 "\"%s\""
 msgstr ""
 
-#: src/filemanager/file.c:2893 src/filemanager/file.c:3379
-#: src/filemanager/tree.c:781
+#: src/filemanager/file.c:2862 src/filemanager/file.c:3348
+#: src/filemanager/tree.c:776
 #, c-format
 msgid ""
 "Destination \"%s\" must be a directory\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2926
+#: src/filemanager/file.c:2895
 #, c-format
 msgid ""
 "Cannot create target directory \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:2950
+#: src/filemanager/file.c:2919
 #, c-format
 msgid ""
 "Cannot chown target directory \"%s\"\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/file.c:3150
+#: src/filemanager/file.c:3119
 #, c-format
 msgid "Directories: %zu, total size: %s"
 msgstr ""
 
-#: src/filemanager/file.c:3295
+#: src/filemanager/file.c:3264
 msgid "Sorry, I could not put the job in background"
 msgstr ""
 
-#: src/filemanager/filegui.c:253 src/filemanager/find.c:190
+#: src/filemanager/filegui.c:253 src/filemanager/find.c:188
 msgid "S&uspend"
 msgstr ""
 
-#: src/filemanager/filegui.c:254 src/filemanager/find.c:191
+#: src/filemanager/filegui.c:254 src/filemanager/find.c:189
 msgid "Con&tinue"
 msgstr ""
 
@@ -3721,7 +3729,7 @@ msgstr ""
 msgid "Overwrite this file?"
 msgstr ""
 
-#: src/filemanager/filegui.c:462 src/filemanager/hotlist.c:190
+#: src/filemanager/filegui.c:462 src/filemanager/hotlist.c:191
 msgid "A&ppend"
 msgstr ""
 
@@ -3809,8 +3817,8 @@ msgstr ""
 msgid "Deleting"
 msgstr ""
 
-#: src/filemanager/filegui.c:1344 src/filemanager/find.c:579
-#: src/filemanager/panel.c:2536
+#: src/filemanager/filegui.c:1344 src/filemanager/find.c:577
+#: src/filemanager/panel.c:2540
 msgid "&Using shell patterns"
 msgstr ""
 
@@ -3843,689 +3851,689 @@ msgstr ""
 msgid "Invalid source pattern '%s'"
 msgstr ""
 
-#: src/filemanager/find.c:188
-msgid "&Chdir"
+#: src/filemanager/filemanager.c:194
+msgid "File listin&g"
 msgstr ""
 
-#: src/filemanager/find.c:189
-msgid "&Again"
+#: src/filemanager/filemanager.c:195
+msgid "&Quick view"
 msgstr ""
 
-#: src/filemanager/find.c:194 src/filemanager/panelize.c:140
-msgid "Pane&lize"
+#: src/filemanager/filemanager.c:196
+msgid "&Info"
 msgstr ""
 
-#: src/filemanager/find.c:195
-msgid "&View - F3"
+#: src/filemanager/filemanager.c:197 src/filemanager/find.c:595
+msgid "&Tree"
 msgstr ""
 
-#: src/filemanager/find.c:196
-msgid "&Edit - F4"
+#: src/filemanager/filemanager.c:201
+msgid "&Listing format..."
 msgstr ""
 
-#: src/filemanager/find.c:371
-#, c-format
-msgid "Found: %lu"
+#: src/filemanager/filemanager.c:202
+msgid "&Sort order..."
 msgstr ""
 
-#: src/filemanager/find.c:504 src/filemanager/find.c:514
-msgid "Malformed regular expression"
+#: src/filemanager/filemanager.c:203
+msgid "&Filter..."
 msgstr ""
 
-#: src/filemanager/find.c:577
-msgid "File name:"
+#: src/filemanager/filemanager.c:205
+msgid "&Encoding..."
 msgstr ""
 
-#: src/filemanager/find.c:578
-msgid "&Find recursively"
+#: src/filemanager/filemanager.c:209
+msgid "FT&P link..."
 msgstr ""
 
-#: src/filemanager/find.c:584
-msgid "S&kip hidden"
+#: src/filemanager/filemanager.c:212
+msgid "S&hell link..."
 msgstr ""
 
-#: src/filemanager/find.c:587
-msgid "Content:"
+#: src/filemanager/filemanager.c:215
+msgid "S&FTP link..."
 msgstr ""
 
-#: src/filemanager/find.c:588
-msgid "Sea&rch for content"
+#: src/filemanager/filemanager.c:218
+msgid "SM&B link..."
 msgstr ""
 
-#: src/filemanager/find.c:590
-msgid "Case sens&itive"
+#: src/filemanager/filemanager.c:220
+msgid "Paneli&ze"
 msgstr ""
 
-#: src/filemanager/find.c:592
-msgid "A&ll charsets"
+#: src/filemanager/filemanager.c:222
+msgid "&Rescan"
 msgstr ""
 
-#: src/filemanager/find.c:595
-msgid "Fir&st hit"
+#: src/filemanager/filemanager.c:234
+msgid "&View"
 msgstr ""
 
-#: src/filemanager/find.c:597 src/filemanager/midnight.c:204
-msgid "&Tree"
+#: src/filemanager/filemanager.c:235
+msgid "Vie&w file..."
 msgstr ""
 
-#: src/filemanager/find.c:671
-msgid "Find File"
+#: src/filemanager/filemanager.c:236
+msgid "&Filtered view"
 msgstr ""
 
-#: src/filemanager/find.c:679
-msgid "Start at:"
+#: src/filemanager/filemanager.c:238
+msgid "&Copy"
 msgstr ""
 
-#: src/filemanager/find.c:688
-msgid "Ena&ble ignore directories:"
+#: src/filemanager/filemanager.c:239
+msgid "C&hmod"
 msgstr ""
 
-#: src/filemanager/find.c:1031 src/filemanager/find.c:1125
-#, c-format
-msgid "Grepping in %s"
+#: src/filemanager/filemanager.c:240
+msgid "&Link"
 msgstr ""
 
-#: src/filemanager/find.c:1307
-msgid "Finished"
+#: src/filemanager/filemanager.c:241
+msgid "&Symlink"
 msgstr ""
 
-#: src/filemanager/find.c:1313
-#, c-format
-msgid "Finished (ignored %zu directory)"
-msgid_plural "Finished (ignored %zu directories)"
-msgstr[0] ""
-msgstr[1] ""
+#: src/filemanager/filemanager.c:244
+msgid "Relative symlin&k"
+msgstr ""
 
-#: src/filemanager/find.c:1509
-#, c-format
-msgid "Find File: \"%s\". Content: \"%s\""
+#: src/filemanager/filemanager.c:245
+msgid "Edit s&ymlink"
 msgstr ""
 
-#: src/filemanager/find.c:1512
-#, c-format
-msgid "Find File: \"%s\""
+#: src/filemanager/filemanager.c:246
+msgid "Ch&own"
 msgstr ""
 
-#: src/filemanager/find.c:1609 src/filemanager/find.c:1691
-msgid "Searching"
+#: src/filemanager/filemanager.c:248
+msgid "&Advanced chown"
 msgstr ""
 
-#: src/filemanager/hotlist.c:170
-msgid "Change &to"
+#: src/filemanager/filemanager.c:250
+msgid "Cha&ttr"
 msgstr ""
 
-#: src/filemanager/hotlist.c:173
-msgid "&Free VFSs now"
+#: src/filemanager/filemanager.c:252
+msgid "&Rename/Move"
 msgstr ""
 
-#: src/filemanager/hotlist.c:175
-msgid "&Refresh"
+#: src/filemanager/filemanager.c:253
+msgid "&Mkdir"
 msgstr ""
 
-#: src/filemanager/hotlist.c:178
-msgid "&Add current"
+#: src/filemanager/filemanager.c:255
+msgid "&Quick cd"
 msgstr ""
 
-#: src/filemanager/hotlist.c:180
-msgid "&Up"
+#: src/filemanager/filemanager.c:257
+msgid "Select &group"
 msgstr ""
 
-#: src/filemanager/hotlist.c:184
-msgid "New &group"
+#: src/filemanager/filemanager.c:258
+msgid "U&nselect group"
 msgstr ""
 
-#: src/filemanager/hotlist.c:186
-msgid "New &entry"
+#: src/filemanager/filemanager.c:259
+msgid "&Invert selection"
 msgstr ""
 
-#: src/filemanager/hotlist.c:188 src/filemanager/hotlist.c:1013
-#: src/filemanager/hotlist.c:1075
-msgid "&Insert"
+#: src/filemanager/filemanager.c:261
+msgid "E&xit"
 msgstr ""
 
-#: src/filemanager/hotlist.c:192 src/filemanager/panelize.c:141
-msgid "&Remove"
+#: src/filemanager/filemanager.c:277
+msgid "&User menu"
 msgstr ""
 
-#: src/filemanager/hotlist.c:250
-msgid "Subgroup - press ENTER to see list"
+#: src/filemanager/filemanager.c:278
+msgid "&Directory tree"
 msgstr ""
 
-#: src/filemanager/hotlist.c:769
-msgid "Active VFS directories"
+#: src/filemanager/filemanager.c:279
+msgid "&Find file"
 msgstr ""
 
-#: src/filemanager/hotlist.c:776
-msgid "Directory hotlist"
+#: src/filemanager/filemanager.c:280
+msgid "S&wap panels"
 msgstr ""
 
-#: src/filemanager/hotlist.c:786 src/filemanager/hotlist.c:1469
-msgid "Top level group"
+#: src/filemanager/filemanager.c:281
+msgid "Switch &panels on/off"
 msgstr ""
 
-#: src/filemanager/hotlist.c:811
-msgid "Directory path"
+#: src/filemanager/filemanager.c:283
+msgid "&Compare directories"
 msgstr ""
 
-#: src/filemanager/hotlist.c:848
-#, c-format
-msgid "Moving %s"
+#: src/filemanager/filemanager.c:285
+msgid "C&ompare files"
 msgstr ""
 
-#: src/filemanager/hotlist.c:858
-msgid "Directory label"
+#: src/filemanager/filemanager.c:288
+msgid "E&xternal panelize"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1012 src/filemanager/hotlist.c:1074
-msgid "&Append"
+#: src/filemanager/filemanager.c:289
+msgid "Show directory s&izes"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1043
-msgid "New hotlist entry"
+#: src/filemanager/filemanager.c:291
+msgid "Command &history"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1043
-msgid "Directory label:"
+#: src/filemanager/filemanager.c:294
+msgid "Viewed/edited files hi&story"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1044
-msgid "Directory path:"
+#: src/filemanager/filemanager.c:296
+msgid "Di&rectory hotlist"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1102
-msgid "New hotlist group"
+#: src/filemanager/filemanager.c:298
+msgid "&Active VFS list"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1102
-msgid "Name of new group:"
+#: src/filemanager/filemanager.c:301
+msgid "&Background jobs"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1155
-#, c-format
-msgid "Are you sure you want to remove entry \"%s\"?"
+#: src/filemanager/filemanager.c:303
+msgid "Screen lis&t"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1172
-#, c-format
-msgid ""
-"Group \"%s\" is not empty.\n"
-"Remove it?"
+#: src/filemanager/filemanager.c:308
+msgid "&Undelete files (ext2fs only)"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1492
-msgid "Hotlist Load"
+#: src/filemanager/filemanager.c:311
+msgid "&Listing format edit"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1494
-#, c-format
-msgid ""
-"MC was unable to write %s file,\n"
-"your old hotlist entries were not deleted"
+#: src/filemanager/filemanager.c:318
+msgid "Edit &extension file"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1600
-#, c-format
-msgid "Label for \"%s\":"
+#: src/filemanager/filemanager.c:319
+msgid "Edit &menu file"
 msgstr ""
 
-#: src/filemanager/hotlist.c:1612
-msgid "Add to hotlist"
+#: src/filemanager/filemanager.c:322
+msgid "Edit hi&ghlighting group file"
 msgstr ""
 
-#: src/filemanager/info.c:128
-#, c-format
-msgid "Midnight Commander %s"
+#: src/filemanager/filemanager.c:335
+msgid "&Configuration..."
 msgstr ""
 
-#: src/filemanager/info.c:150
-#, c-format
-msgid "File: %s"
+#: src/filemanager/filemanager.c:336
+msgid "&Layout..."
 msgstr ""
 
-#: src/filemanager/info.c:168
-msgid "No node information"
+#: src/filemanager/filemanager.c:337
+msgid "&Panel options..."
 msgstr ""
 
-#: src/filemanager/info.c:170 src/filemanager/info.c:172
-#: src/filemanager/info.c:175
-msgid "Free nodes:"
+#: src/filemanager/filemanager.c:339
+msgid "C&onfirmation..."
 msgstr ""
 
-#: src/filemanager/info.c:183
-msgid "No space information"
+#: src/filemanager/filemanager.c:341
+msgid "&Appearance..."
 msgstr ""
 
-#: src/filemanager/info.c:190
-#, c-format
-msgid "Free space: %s/%s (%d%%)"
+#: src/filemanager/filemanager.c:343
+msgid "&Display bits..."
 msgstr ""
 
-#: src/filemanager/info.c:197
-#, c-format
-msgid "Type:       %s"
+#: src/filemanager/filemanager.c:346
+msgid "&Virtual FS..."
 msgstr ""
 
-#: src/filemanager/info.c:198
-msgid "non-local vfs"
+#: src/filemanager/filemanager.c:448
+msgid "Panels:"
 msgstr ""
 
-#: src/filemanager/info.c:204
+#: src/filemanager/filemanager.c:1059
 #, c-format
-msgid "Device:     %s"
-msgstr ""
+msgid "You have %zu opened screen. Quit anyway?"
+msgid_plural "You have %zu opened screens. Quit anyway?"
+msgstr[0] ""
+msgstr[1] ""
 
-#: src/filemanager/info.c:211
-#, c-format
-msgid "Filesystem: %s"
+#: src/filemanager/filemanager.c:1062 src/filemanager/filemanager.c:1068
+#: src/filemanager/panel.c:2818
+msgid "The Midnight Commander"
 msgstr ""
 
-#: src/filemanager/info.c:218
-#, c-format
-msgid "Accessed:   %s"
+#: src/filemanager/filemanager.c:1069
+msgid "Do you really want to quit the Midnight Commander?"
 msgstr ""
 
-#: src/filemanager/info.c:224
-#, c-format
-msgid "Modified:   %s"
+#: src/filemanager/filemanager.c:1636
+msgid "&Above"
 msgstr ""
 
-#. TRANSLATORS: Time of last status change as in stat(2) man.
-#: src/filemanager/info.c:233
-#, c-format
-msgid "Changed:    %s"
+#: src/filemanager/filemanager.c:1636
+msgid "&Left"
 msgstr ""
 
-#: src/filemanager/info.c:241
-#, c-format
-msgid "Dev. type: major %lu, minor %lu"
+#: src/filemanager/filemanager.c:1637
+msgid "&Below"
 msgstr ""
 
-#: src/filemanager/info.c:248
-#, c-format
-msgid "Size:       %s"
+#: src/filemanager/filemanager.c:1637
+msgid "&Right"
 msgstr ""
 
-#: src/filemanager/info.c:250
-#, c-format
-msgid " (%lu block)"
-msgid_plural " (%lu blocks)"
-msgstr[0] ""
-msgstr[1] ""
-
-#: src/filemanager/info.c:257
-#, c-format
-msgid "Owner:      %s/%s"
+#: src/filemanager/filemanager.c:1650
+msgid "ButtonBar|Menu"
 msgstr ""
 
-#: src/filemanager/info.c:261
-#, c-format
-msgid "Links:      %d"
+#: src/filemanager/filemanager.c:1651 src/viewer/display.c:92
+msgid "ButtonBar|View"
 msgstr ""
 
-#: src/filemanager/info.c:267 src/filemanager/info.c:283
-msgid "Attributes: not supported"
+#: src/filemanager/filemanager.c:1654 src/filemanager/tree.c:1178
+msgid "ButtonBar|RenMov"
 msgstr ""
 
-#: src/filemanager/info.c:276
-#, c-format
-msgid "Attributes: %s"
+#: src/filemanager/filemanager.c:1655 src/filemanager/tree.c:1181
+msgid "ButtonBar|Mkdir"
 msgstr ""
 
-#: src/filemanager/info.c:278
-msgid "Attributes: unavailable"
+#: src/filemanager/find.c:186
+msgid "&Chdir"
 msgstr ""
 
-#: src/filemanager/info.c:288
-#, c-format
-msgid "Mode:       %s (%04o)"
+#: src/filemanager/find.c:187
+msgid "&Again"
 msgstr ""
 
-#: src/filemanager/info.c:293
-#, c-format
-msgid "Location:   %Xh:%Xh"
+#: src/filemanager/find.c:192 src/filemanager/panelize.c:140
+msgid "Pane&lize"
 msgstr ""
 
-#: src/filemanager/layout.c:173
-msgid "&Equal split"
+#: src/filemanager/find.c:193
+msgid "&View - F3"
 msgstr ""
 
-#: src/filemanager/layout.c:174
-msgid "&Menubar visible"
+#: src/filemanager/find.c:194
+msgid "&Edit - F4"
 msgstr ""
 
-#: src/filemanager/layout.c:175
-msgid "Command &prompt"
+#: src/filemanager/find.c:369
+#, c-format
+msgid "Found: %lu"
 msgstr ""
 
-#: src/filemanager/layout.c:176
-msgid "&Keybar visible"
+#: src/filemanager/find.c:502 src/filemanager/find.c:512
+msgid "Malformed regular expression"
 msgstr ""
 
-#: src/filemanager/layout.c:177
-msgid "H&intbar visible"
+#: src/filemanager/find.c:575
+msgid "File name:"
 msgstr ""
 
-#: src/filemanager/layout.c:178
-msgid "&XTerm window title"
+#: src/filemanager/find.c:576
+msgid "&Find recursively"
 msgstr ""
 
-#: src/filemanager/layout.c:179
-msgid "&Show free space"
+#: src/filemanager/find.c:582
+msgid "S&kip hidden"
 msgstr ""
 
-#: src/filemanager/layout.c:499
-msgid "Panel split"
+#: src/filemanager/find.c:585
+msgid "Content:"
 msgstr ""
 
-#: src/filemanager/layout.c:500
-msgid "Console output"
+#: src/filemanager/find.c:586
+msgid "Sea&rch for content"
 msgstr ""
 
-#: src/filemanager/layout.c:504
-msgid "&Vertical"
+#: src/filemanager/find.c:588
+msgid "Case sens&itive"
 msgstr ""
 
-#: src/filemanager/layout.c:505
-msgid "&Horizontal"
+#: src/filemanager/find.c:590
+msgid "A&ll charsets"
 msgstr ""
 
-#: src/filemanager/layout.c:511
-msgid "Output lines:"
+#: src/filemanager/find.c:593
+msgid "Fir&st hit"
 msgstr ""
 
-#: src/filemanager/layout.c:560
-msgid "Layout"
+#: src/filemanager/find.c:669
+msgid "Find File"
 msgstr ""
 
-#: src/filemanager/midnight.c:201
-msgid "File listin&g"
+#: src/filemanager/find.c:677
+msgid "Start at:"
 msgstr ""
 
-#: src/filemanager/midnight.c:202
-msgid "&Quick view"
+#: src/filemanager/find.c:686
+msgid "Ena&ble ignore directories:"
 msgstr ""
 
-#: src/filemanager/midnight.c:203
-msgid "&Info"
+#: src/filemanager/find.c:1014 src/filemanager/find.c:1108
+#, c-format
+msgid "Grepping in %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:208
-msgid "&Listing format..."
+#: src/filemanager/find.c:1290
+msgid "Finished"
 msgstr ""
 
-#: src/filemanager/midnight.c:209
-msgid "&Sort order..."
-msgstr ""
+#: src/filemanager/find.c:1296
+#, c-format
+msgid "Finished (ignored %zu directory)"
+msgid_plural "Finished (ignored %zu directories)"
+msgstr[0] ""
+msgstr[1] ""
 
-#: src/filemanager/midnight.c:210
-msgid "&Filter..."
+#: src/filemanager/find.c:1492
+#, c-format
+msgid "Find File: \"%s\". Content: \"%s\""
 msgstr ""
 
-#: src/filemanager/midnight.c:212
-msgid "&Encoding..."
+#: src/filemanager/find.c:1495
+#, c-format
+msgid "Find File: \"%s\""
 msgstr ""
 
-#: src/filemanager/midnight.c:216
-msgid "FT&P link..."
+#: src/filemanager/find.c:1592 src/filemanager/find.c:1674
+msgid "Searching"
 msgstr ""
 
-#: src/filemanager/midnight.c:219
-msgid "S&hell link..."
+#: src/filemanager/hotlist.c:171
+msgid "Change &to"
 msgstr ""
 
-#: src/filemanager/midnight.c:222
-msgid "S&FTP link..."
+#: src/filemanager/hotlist.c:174
+msgid "&Free VFSs now"
 msgstr ""
 
-#: src/filemanager/midnight.c:225
-msgid "SM&B link..."
+#: src/filemanager/hotlist.c:176
+msgid "&Refresh"
 msgstr ""
 
-#: src/filemanager/midnight.c:227
-msgid "Paneli&ze"
+#: src/filemanager/hotlist.c:179
+msgid "&Add current"
 msgstr ""
 
-#: src/filemanager/midnight.c:229
-msgid "&Rescan"
+#: src/filemanager/hotlist.c:181
+msgid "&Up"
 msgstr ""
 
-#: src/filemanager/midnight.c:241
-msgid "&View"
+#: src/filemanager/hotlist.c:185
+msgid "New &group"
 msgstr ""
 
-#: src/filemanager/midnight.c:242
-msgid "Vie&w file..."
+#: src/filemanager/hotlist.c:187
+msgid "New &entry"
 msgstr ""
 
-#: src/filemanager/midnight.c:243
-msgid "&Filtered view"
+#: src/filemanager/hotlist.c:189 src/filemanager/hotlist.c:1014
+#: src/filemanager/hotlist.c:1076
+msgid "&Insert"
 msgstr ""
 
-#: src/filemanager/midnight.c:245
-msgid "&Copy"
+#: src/filemanager/hotlist.c:193 src/filemanager/panelize.c:141
+msgid "&Remove"
 msgstr ""
 
-#: src/filemanager/midnight.c:246
-msgid "C&hmod"
+#: src/filemanager/hotlist.c:251
+msgid "Subgroup - press ENTER to see list"
 msgstr ""
 
-#: src/filemanager/midnight.c:247
-msgid "&Link"
+#: src/filemanager/hotlist.c:770
+msgid "Active VFS directories"
 msgstr ""
 
-#: src/filemanager/midnight.c:248
-msgid "&Symlink"
+#: src/filemanager/hotlist.c:777
+msgid "Directory hotlist"
 msgstr ""
 
-#: src/filemanager/midnight.c:251
-msgid "Relative symlin&k"
+#: src/filemanager/hotlist.c:787 src/filemanager/hotlist.c:1470
+msgid "Top level group"
 msgstr ""
 
-#: src/filemanager/midnight.c:252
-msgid "Edit s&ymlink"
+#: src/filemanager/hotlist.c:812
+msgid "Directory path"
 msgstr ""
 
-#: src/filemanager/midnight.c:253
-msgid "Ch&own"
+#: src/filemanager/hotlist.c:849
+#, c-format
+msgid "Moving %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:255
-msgid "&Advanced chown"
+#: src/filemanager/hotlist.c:859
+msgid "Directory label"
 msgstr ""
 
-#: src/filemanager/midnight.c:257
-msgid "Cha&ttr"
+#: src/filemanager/hotlist.c:1013 src/filemanager/hotlist.c:1075
+msgid "&Append"
 msgstr ""
 
-#: src/filemanager/midnight.c:259
-msgid "&Rename/Move"
+#: src/filemanager/hotlist.c:1044
+msgid "New hotlist entry"
 msgstr ""
 
-#: src/filemanager/midnight.c:260
-msgid "&Mkdir"
+#: src/filemanager/hotlist.c:1044
+msgid "Directory label:"
 msgstr ""
 
-#: src/filemanager/midnight.c:262
-msgid "&Quick cd"
+#: src/filemanager/hotlist.c:1045
+msgid "Directory path:"
 msgstr ""
 
-#: src/filemanager/midnight.c:264
-msgid "Select &group"
+#: src/filemanager/hotlist.c:1103
+msgid "New hotlist group"
 msgstr ""
 
-#: src/filemanager/midnight.c:265
-msgid "U&nselect group"
+#: src/filemanager/hotlist.c:1103
+msgid "Name of new group:"
 msgstr ""
 
-#: src/filemanager/midnight.c:266
-msgid "&Invert selection"
+#: src/filemanager/hotlist.c:1156
+#, c-format
+msgid "Are you sure you want to remove entry \"%s\"?"
 msgstr ""
 
-#: src/filemanager/midnight.c:268
-msgid "E&xit"
+#: src/filemanager/hotlist.c:1173
+#, c-format
+msgid ""
+"Group \"%s\" is not empty.\n"
+"Remove it?"
 msgstr ""
 
-#: src/filemanager/midnight.c:284
-msgid "&User menu"
+#: src/filemanager/hotlist.c:1493
+msgid "Hotlist Load"
 msgstr ""
 
-#: src/filemanager/midnight.c:285
-msgid "&Directory tree"
+#: src/filemanager/hotlist.c:1495
+#, c-format
+msgid ""
+"MC was unable to write %s file,\n"
+"your old hotlist entries were not deleted"
 msgstr ""
 
-#: src/filemanager/midnight.c:286
-msgid "&Find file"
+#: src/filemanager/hotlist.c:1601
+#, c-format
+msgid "Label for \"%s\":"
 msgstr ""
 
-#: src/filemanager/midnight.c:287
-msgid "S&wap panels"
+#: src/filemanager/hotlist.c:1616
+msgid "Add to hotlist"
 msgstr ""
 
-#: src/filemanager/midnight.c:288
-msgid "Switch &panels on/off"
+#: src/filemanager/info.c:128
+#, c-format
+msgid "Midnight Commander %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:290
-msgid "&Compare directories"
+#: src/filemanager/info.c:150
+#, c-format
+msgid "File: %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:292
-msgid "C&ompare files"
+#: src/filemanager/info.c:168
+msgid "No node information"
 msgstr ""
 
-#: src/filemanager/midnight.c:295
-msgid "E&xternal panelize"
+#: src/filemanager/info.c:170 src/filemanager/info.c:172
+#: src/filemanager/info.c:175
+msgid "Free nodes:"
 msgstr ""
 
-#: src/filemanager/midnight.c:296
-msgid "Show directory s&izes"
+#: src/filemanager/info.c:183
+msgid "No space information"
 msgstr ""
 
-#: src/filemanager/midnight.c:298
-msgid "Command &history"
+#: src/filemanager/info.c:190
+#, c-format
+msgid "Free space: %s/%s (%d%%)"
 msgstr ""
 
-#: src/filemanager/midnight.c:301
-msgid "Viewed/edited files hi&story"
+#: src/filemanager/info.c:197
+#, c-format
+msgid "Type:       %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:303
-msgid "Di&rectory hotlist"
+#: src/filemanager/info.c:198
+msgid "non-local vfs"
 msgstr ""
 
-#: src/filemanager/midnight.c:305
-msgid "&Active VFS list"
+#: src/filemanager/info.c:204
+#, c-format
+msgid "Device:     %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:308
-msgid "&Background jobs"
+#: src/filemanager/info.c:211
+#, c-format
+msgid "Filesystem: %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:310
-msgid "Screen lis&t"
+#: src/filemanager/info.c:218
+#, c-format
+msgid "Accessed:   %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:315
-msgid "&Undelete files (ext2fs only)"
+#: src/filemanager/info.c:224
+#, c-format
+msgid "Modified:   %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:318
-msgid "&Listing format edit"
+#. TRANSLATORS: Time of last status change as in stat(2) man.
+#: src/filemanager/info.c:233
+#, c-format
+msgid "Changed:    %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:325
-msgid "Edit &extension file"
+#: src/filemanager/info.c:241
+#, c-format
+msgid "Dev. type: major %lu, minor %lu"
 msgstr ""
 
-#: src/filemanager/midnight.c:326
-msgid "Edit &menu file"
+#: src/filemanager/info.c:248
+#, c-format
+msgid "Size:       %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:329
-msgid "Edit hi&ghlighting group file"
+#: src/filemanager/info.c:250
+#, c-format
+msgid " (%lu block)"
+msgid_plural " (%lu blocks)"
+msgstr[0] ""
+msgstr[1] ""
+
+#: src/filemanager/info.c:257
+#, c-format
+msgid "Owner:      %s/%s"
 msgstr ""
 
-#: src/filemanager/midnight.c:342
-msgid "&Configuration..."
+#: src/filemanager/info.c:261
+#, c-format
+msgid "Links:      %d"
 msgstr ""
 
-#: src/filemanager/midnight.c:343
-msgid "&Layout..."
+#: src/filemanager/info.c:267 src/filemanager/info.c:283
+msgid "Attributes: not supported"
 msgstr ""
 
-#: src/filemanager/midnight.c:344
-msgid "&Panel options..."
+#: src/filemanager/info.c:276
+#, c-format
+msgid "Attributes: %s"
 msgstr ""
 
-#: src/filemanager/midnight.c:346
-msgid "C&onfirmation..."
+#: src/filemanager/info.c:278
+msgid "Attributes: unavailable"
 msgstr ""
 
-#: src/filemanager/midnight.c:348
-msgid "&Appearance..."
+#: src/filemanager/info.c:288
+#, c-format
+msgid "Mode:       %s (%04o)"
 msgstr ""
 
-#: src/filemanager/midnight.c:350
-msgid "&Display bits..."
+#: src/filemanager/info.c:293
+#, c-format
+msgid "Location:   %Xh:%Xh"
 msgstr ""
 
-#: src/filemanager/midnight.c:353
-msgid "&Virtual FS..."
+#: src/filemanager/layout.c:173
+msgid "&Equal split"
 msgstr ""
 
-#: src/filemanager/midnight.c:455
-msgid "Panels:"
+#: src/filemanager/layout.c:174
+msgid "&Menubar visible"
 msgstr ""
 
-#: src/filemanager/midnight.c:1066
-#, c-format
-msgid "You have %zu opened screen. Quit anyway?"
-msgid_plural "You have %zu opened screens. Quit anyway?"
-msgstr[0] ""
-msgstr[1] ""
+#: src/filemanager/layout.c:175
+msgid "Command &prompt"
+msgstr ""
 
-#: src/filemanager/midnight.c:1069 src/filemanager/midnight.c:1075
-#: src/filemanager/panel.c:2822
-msgid "The Midnight Commander"
+#: src/filemanager/layout.c:176
+msgid "&Keybar visible"
 msgstr ""
 
-#: src/filemanager/midnight.c:1076
-msgid "Do you really want to quit the Midnight Commander?"
+#: src/filemanager/layout.c:177
+msgid "H&intbar visible"
 msgstr ""
 
-#: src/filemanager/midnight.c:1643
-msgid "&Above"
+#: src/filemanager/layout.c:178
+msgid "&XTerm window title"
 msgstr ""
 
-#: src/filemanager/midnight.c:1643
-msgid "&Left"
+#: src/filemanager/layout.c:179
+msgid "&Show free space"
 msgstr ""
 
-#: src/filemanager/midnight.c:1644
-msgid "&Below"
+#: src/filemanager/layout.c:499
+msgid "Panel split"
 msgstr ""
 
-#: src/filemanager/midnight.c:1644
-msgid "&Right"
+#: src/filemanager/layout.c:500
+msgid "Console output"
 msgstr ""
 
-#: src/filemanager/midnight.c:1657
-msgid "ButtonBar|Menu"
+#: src/filemanager/layout.c:504
+msgid "&Vertical"
 msgstr ""
 
-#: src/filemanager/midnight.c:1658 src/viewer/display.c:92
-msgid "ButtonBar|View"
+#: src/filemanager/layout.c:505
+msgid "&Horizontal"
 msgstr ""
 
-#: src/filemanager/midnight.c:1661 src/filemanager/tree.c:1183
-msgid "ButtonBar|RenMov"
+#: src/filemanager/layout.c:511
+msgid "Output lines:"
 msgstr ""
 
-#: src/filemanager/midnight.c:1662 src/filemanager/tree.c:1186
-msgid "ButtonBar|Mkdir"
+#: src/filemanager/layout.c:560
+msgid "Layout"
 msgstr ""
 
-#: src/filemanager/mountlist.c:900
+#: src/filemanager/mountlist.c:908
 msgid "Memory exhausted!"
 msgstr ""
 
@@ -4647,67 +4655,67 @@ msgstr ""
 msgid "Group"
 msgstr ""
 
-#: src/filemanager/panel.c:498
+#: src/filemanager/panel.c:500
 msgid "[dev]"
 msgstr ""
 
-#: src/filemanager/panel.c:511 src/filemanager/panel.c:1030
+#: src/filemanager/panel.c:513 src/filemanager/panel.c:1032
 msgid "UP--DIR"
 msgstr ""
 
-#: src/filemanager/panel.c:530
+#: src/filemanager/panel.c:532
 msgid "SYMLINK"
 msgstr ""
 
-#: src/filemanager/panel.c:533
+#: src/filemanager/panel.c:535
 msgid "SUB-DIR"
 msgstr ""
 
-#: src/filemanager/panel.c:1022
+#: src/filemanager/panel.c:1024
 msgid "<readlink failed>"
 msgstr ""
 
-#: src/filemanager/panel.c:1087
+#: src/filemanager/panel.c:1089
 #, c-format
 msgid "%s in %d file"
 msgid_plural "%s in %d files"
 msgstr[0] ""
 msgstr[1] ""
 
-#: src/filemanager/panel.c:1290
+#: src/filemanager/panel.c:1292
 msgid "Panelize"
 msgstr ""
 
-#: src/filemanager/panel.c:1805
+#: src/filemanager/panel.c:1810
 msgid "Unknown tag on display format:"
 msgstr ""
 
-#: src/filemanager/panel.c:2535
+#: src/filemanager/panel.c:2539
 msgid "&Files only"
 msgstr ""
 
-#: src/filemanager/panel.c:2538
+#: src/filemanager/panel.c:2542
 msgid "&Case sensitive"
 msgstr ""
 
-#: src/filemanager/panel.c:2593
+#: src/filemanager/panel.c:2597
 msgid "Select"
 msgstr ""
 
-#: src/filemanager/panel.c:2601
+#: src/filemanager/panel.c:2605
 msgid "Unselect"
 msgstr ""
 
-#: src/filemanager/panel.c:2822
+#: src/filemanager/panel.c:2818
 msgid "Do you really want to execute?"
 msgstr ""
 
-#: src/filemanager/panel.c:3286 src/filemanager/panel.c:4408
-#: src/filemanager/panel.c:4456 src/viewer/actions_cmd.c:332
+#: src/filemanager/panel.c:3284 src/filemanager/panel.c:4409
+#: src/filemanager/panel.c:4457 src/viewer/actions_cmd.c:332
 msgid "Cannot read directory contents"
 msgstr ""
 
-#: src/filemanager/panel.c:4510
+#: src/filemanager/panel.c:4511
 msgid "User supplied format looks invalid, reverting to default."
 msgstr ""
 
@@ -4771,45 +4779,45 @@ msgid ""
 "%s\n"
 msgstr ""
 
-#: src/filemanager/tree.c:722
+#: src/filemanager/tree.c:717
 #, c-format
 msgid "Copy \"%s\" directory to:"
 msgstr ""
 
-#: src/filemanager/tree.c:761
+#: src/filemanager/tree.c:756
 #, c-format
 msgid "Move \"%s\" directory to:"
 msgstr ""
 
-#: src/filemanager/tree.c:774
+#: src/filemanager/tree.c:769
 #, c-format
 msgid ""
 "Cannot stat the destination\n"
 "%s"
 msgstr ""
 
-#: src/filemanager/tree.c:832
+#: src/filemanager/tree.c:827
 #, c-format
 msgid "Delete %s?"
 msgstr ""
 
-#: src/filemanager/tree.c:989 src/filemanager/tree.c:1180
+#: src/filemanager/tree.c:984 src/filemanager/tree.c:1175
 msgid "ButtonBar|Static"
 msgstr ""
 
-#: src/filemanager/tree.c:989 src/filemanager/tree.c:1181
+#: src/filemanager/tree.c:984 src/filemanager/tree.c:1176
 msgid "ButtonBar|Dynamc"
 msgstr ""
 
-#: src/filemanager/tree.c:1178
+#: src/filemanager/tree.c:1173
 msgid "ButtonBar|Rescan"
 msgstr ""
 
-#: src/filemanager/tree.c:1179
+#: src/filemanager/tree.c:1174
 msgid "ButtonBar|Forget"
 msgstr ""
 
-#: src/filemanager/tree.c:1190
+#: src/filemanager/tree.c:1185
 msgid "ButtonBar|Rmdir"
 msgstr ""
 
@@ -4903,25 +4911,25 @@ msgid ""
 "key, or click with the mouse to define it. Move around with Tab."
 msgstr ""
 
-#: src/main.c:275
+#: src/main.c:272
 #, c-format
 msgid ""
 "Failed to run:\n"
 "%s\n"
 msgstr ""
 
-#: src/main.c:289
+#: src/main.c:285
 msgid "Home directory path is not absolute"
 msgstr ""
 
-#: src/main.c:415
+#: src/main.c:411
 msgid ""
 "GNU Midnight Commander\n"
 "is already running on this terminal.\n"
 "Subshell support will be disabled."
 msgstr ""
 
-#: src/main.c:555
+#: src/main.c:551
 #, c-format
 msgid ""
 "\n"
@@ -4945,23 +4953,23 @@ msgstr ""
 msgid "%b %e %H:%M"
 msgstr ""
 
-#: src/setup.c:1289
+#: src/setup.c:1290
 #, c-format
 msgid ""
 "Cannot save file %s:\n"
 "%s"
 msgstr ""
 
-#: src/subshell/common.c:1031
+#: src/subshell/common.c:1331
 #, c-format
 msgid "Cannot open named pipe %s\n"
 msgstr ""
 
-#: src/subshell/common.c:1220
+#: src/subshell/common.c:1603
 msgid "The shell is still active. Quit anyway?"
 msgstr ""
 
-#: src/subshell/common.c:1320
+#: src/subshell/common.c:1722
 #, c-format
 msgid "Warning: Cannot change to %s.\n"
 msgstr ""
@@ -5164,241 +5172,241 @@ msgstr ""
 msgid "%s contains duplicate entries! Skipping!"
 msgstr ""
 
-#: src/vfs/cpio/cpio.c:577 src/vfs/cpio/cpio.c:643 src/vfs/cpio/cpio.c:649
-#: src/vfs/cpio/cpio.c:718 src/vfs/cpio/cpio.c:728
+#: src/vfs/cpio/cpio.c:577 src/vfs/cpio/cpio.c:644 src/vfs/cpio/cpio.c:650
+#: src/vfs/cpio/cpio.c:719 src/vfs/cpio/cpio.c:729
 #, c-format
 msgid ""
 "Corrupted cpio header encountered in\n"
 "%s"
 msgstr ""
 
-#: src/vfs/cpio/cpio.c:792
+#: src/vfs/cpio/cpio.c:793
 #, c-format
 msgid ""
 "Unexpected end of file\n"
 "%s"
 msgstr ""
 
-#: src/vfs/extfs/extfs.c:628
+#: src/vfs/extfs/extfs.c:649
 #, c-format
 msgid ""
 "Cannot open %s archive\n"
 "%s"
 msgstr ""
 
-#: src/vfs/extfs/extfs.c:633 src/vfs/extfs/extfs.c:638
+#: src/vfs/extfs/extfs.c:654 src/vfs/extfs/extfs.c:659
 msgid "Inconsistent extfs archive"
 msgstr ""
 
-#: src/vfs/extfs/extfs.c:1418
+#: src/vfs/extfs/extfs.c:1442
 #, c-format
 msgid "Warning: cannot open %s directory\n"
 msgstr ""
 
-#: src/vfs/fish/fish.c:384
+#: src/vfs/fish/fish.c:383
 #, c-format
 msgid "fish: Disconnecting from %s"
 msgstr ""
 
-#: src/vfs/fish/fish.c:560
+#: src/vfs/fish/fish.c:559
 msgid "fish: Waiting for initial line..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:570
+#: src/vfs/fish/fish.c:569
 msgid "Sorry, we cannot do password authenticated connections for now."
 msgstr ""
 
-#: src/vfs/fish/fish.c:578
+#: src/vfs/fish/fish.c:577
 #, c-format
 msgid "fish: Password is required for %s"
 msgstr ""
 
-#: src/vfs/fish/fish.c:586
+#: src/vfs/fish/fish.c:585
 msgid "fish: Sending password..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:623
+#: src/vfs/fish/fish.c:622
 msgid "fish: Sending initial line..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:634
+#: src/vfs/fish/fish.c:633
 msgid "fish: Handshaking version..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:645
+#: src/vfs/fish/fish.c:644
 msgid "fish: Getting host info..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:767
+#: src/vfs/fish/fish.c:766
 #, c-format
 msgid "fish: Reading directory %s..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:951 src/vfs/ftpfs/ftpfs.c:1859
+#: src/vfs/fish/fish.c:952 src/vfs/ftpfs/ftpfs.c:1858
 #: src/vfs/undelfs/undelfs.c:392
 #, c-format
 msgid "%s: done."
 msgstr ""
 
-#: src/vfs/fish/fish.c:958 src/vfs/ftpfs/ftpfs.c:1806
+#: src/vfs/fish/fish.c:959 src/vfs/ftpfs/ftpfs.c:1805
 #: src/vfs/undelfs/undelfs.c:395
 #, c-format
 msgid "%s: failure"
 msgstr ""
 
-#: src/vfs/fish/fish.c:1016
+#: src/vfs/fish/fish.c:1017
 #, c-format
 msgid "fish: store %s: sending command..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:1040
+#: src/vfs/fish/fish.c:1041
 msgid "fish: Local read failed, sending zeros"
 msgstr ""
 
-#: src/vfs/fish/fish.c:1059
+#: src/vfs/fish/fish.c:1060
 msgid "fish: storing file"
 msgstr ""
 
-#: src/vfs/fish/fish.c:1129
+#: src/vfs/fish/fish.c:1130
 msgid "Aborting transfer..."
 msgstr ""
 
-#: src/vfs/fish/fish.c:1145
+#: src/vfs/fish/fish.c:1146
 msgid "Error reported after abort."
 msgstr ""
 
-#: src/vfs/fish/fish.c:1147
+#: src/vfs/fish/fish.c:1148
 msgid "Aborted transfer would be successful."
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:591
+#: src/vfs/ftpfs/ftpfs.c:590
 #, c-format
 msgid "ftpfs: Disconnecting from %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:643
+#: src/vfs/ftpfs/ftpfs.c:642
 #, c-format
 msgid "FTP: Password required for %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:686
+#: src/vfs/ftpfs/ftpfs.c:685
 msgid "ftpfs: sending login name"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:691
+#: src/vfs/ftpfs/ftpfs.c:690
 msgid "ftpfs: sending user password"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:697
+#: src/vfs/ftpfs/ftpfs.c:696
 #, c-format
 msgid "FTP: Account required for user %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:699
+#: src/vfs/ftpfs/ftpfs.c:698
 msgid "Account:"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:704
+#: src/vfs/ftpfs/ftpfs.c:703
 msgid "ftpfs: sending user account"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:714
+#: src/vfs/ftpfs/ftpfs.c:713
 msgid "ftpfs: logged in"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:727
+#: src/vfs/ftpfs/ftpfs.c:726
 #, c-format
 msgid "ftpfs: Login incorrect for user %s "
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:858
+#: src/vfs/ftpfs/ftpfs.c:857
 msgid "ftpfs: Invalid host name."
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:904 src/vfs/ftpfs/ftpfs.c:920
+#: src/vfs/ftpfs/ftpfs.c:903 src/vfs/ftpfs/ftpfs.c:919
 #, c-format
 msgid "ftpfs: %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:927
+#: src/vfs/ftpfs/ftpfs.c:926
 #, c-format
 msgid "ftpfs: making connection to %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:937
+#: src/vfs/ftpfs/ftpfs.c:936
 msgid "ftpfs: connection interrupted by user"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:939
+#: src/vfs/ftpfs/ftpfs.c:938
 #, c-format
 msgid "ftpfs: connection to server failed: %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:994
+#: src/vfs/ftpfs/ftpfs.c:993
 #, c-format
 msgid "Waiting to retry... %d (Control-G to cancel)"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1306
+#: src/vfs/ftpfs/ftpfs.c:1305
 msgid "ftpfs: invalid address family"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1314
+#: src/vfs/ftpfs/ftpfs.c:1313
 #, c-format
 msgid "ftpfs: could not create socket: %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1349
+#: src/vfs/ftpfs/ftpfs.c:1348
 msgid "ftpfs: could not setup passive mode"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1469
+#: src/vfs/ftpfs/ftpfs.c:1468
 msgid "ftpfs: aborting transfer."
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1473
+#: src/vfs/ftpfs/ftpfs.c:1472
 #, c-format
 msgid "ftpfs: abort error: %s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1481
+#: src/vfs/ftpfs/ftpfs.c:1480
 msgid "ftpfs: abort failed"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1624 src/vfs/ftpfs/ftpfs.c:1747
+#: src/vfs/ftpfs/ftpfs.c:1623 src/vfs/ftpfs/ftpfs.c:1746
 msgid "ftpfs: CWD failed."
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1633 src/vfs/ftpfs/ftpfs.c:1641
+#: src/vfs/ftpfs/ftpfs.c:1632 src/vfs/ftpfs/ftpfs.c:1640
 msgid "ftpfs: couldn't resolve symlink"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1715
+#: src/vfs/ftpfs/ftpfs.c:1714
 msgid "Resolving symlink..."
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1739
+#: src/vfs/ftpfs/ftpfs.c:1738
 #, c-format
 msgid "ftpfs: Reading FTP directory %s... %s%s"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1742
+#: src/vfs/ftpfs/ftpfs.c:1741
 msgid "(strict rfc959)"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1742
+#: src/vfs/ftpfs/ftpfs.c:1741
 msgid "(chdir first)"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1783
+#: src/vfs/ftpfs/ftpfs.c:1782
 msgid "ftpfs: failed; nowhere to fallback to"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:1948
+#: src/vfs/ftpfs/ftpfs.c:1947
 msgid "ftpfs: storing file"
 msgstr ""
 
-#: src/vfs/ftpfs/ftpfs.c:2452
+#: src/vfs/ftpfs/ftpfs.c:2451
 msgid ""
 "~/.netrc file has incorrect mode\n"
 "Remove password or correct mode"
@@ -5500,31 +5508,31 @@ msgstr ""
 msgid "reconnect to %s failed"
 msgstr ""
 
-#: src/vfs/smbfs/smbfs.c:1320
+#: src/vfs/smbfs/smbfs.c:1321
 msgid "Authentication failed"
 msgstr ""
 
-#: src/vfs/smbfs/smbfs.c:1909
+#: src/vfs/smbfs/smbfs.c:1910
 #, c-format
 msgid "Error %s creating directory %s"
 msgstr ""
 
-#: src/vfs/smbfs/smbfs.c:1938
+#: src/vfs/smbfs/smbfs.c:1939
 #, c-format
 msgid "Error %s removing directory %s"
 msgstr ""
 
-#: src/vfs/smbfs/smbfs.c:2068
+#: src/vfs/smbfs/smbfs.c:2069
 #, c-format
 msgid "%s opening remote file %s"
 msgstr ""
 
-#: src/vfs/smbfs/smbfs.c:2148
+#: src/vfs/smbfs/smbfs.c:2149
 #, c-format
 msgid "%s removing remote file %s"
 msgstr ""
 
-#: src/vfs/smbfs/smbfs.c:2185
+#: src/vfs/smbfs/smbfs.c:2186
 #, c-format
 msgid "%s renaming files\n"
 msgstr ""
@@ -5545,7 +5553,7 @@ msgstr ""
 msgid "Unexpected EOF on archive file"
 msgstr ""
 
-#: src/vfs/tar/tar.c:878
+#: src/vfs/tar/tar.c:880
 #, c-format
 msgid ""
 "%s\n"
@@ -5620,24 +5628,24 @@ msgid ""
 "%s"
 msgstr ""
 
-#: src/vfs/undelfs/undelfs.c:411
+#: src/vfs/undelfs/undelfs.c:410
 msgid "vfs_info is not fs!"
 msgstr ""
 
-#: src/vfs/undelfs/undelfs.c:457 src/vfs/undelfs/undelfs.c:681
+#: src/vfs/undelfs/undelfs.c:461 src/vfs/undelfs/undelfs.c:685
 msgid "You have to chdir to extract files first"
 msgstr ""
 
-#: src/vfs/undelfs/undelfs.c:603
+#: src/vfs/undelfs/undelfs.c:607
 msgid "while iterating over blocks"
 msgstr ""
 
-#: src/vfs/undelfs/undelfs.c:725
+#: src/vfs/undelfs/undelfs.c:729
 #, c-format
 msgid "Cannot open file \"%s\""
 msgstr ""
 
-#: src/vfs/undelfs/undelfs.c:819
+#: src/vfs/undelfs/undelfs.c:823
 msgid "Ext2lib error"
 msgstr ""
 
diff --git a/po/mn.po b/po/mn.po
index 3beb255e4..3281502cc 100644
Binary files a/po/mn.po and b/po/mn.po differ
diff --git a/po/nb.po b/po/nb.po
index 802496cfc..34ef8bfda 100644
Binary files a/po/nb.po and b/po/nb.po differ
diff --git a/po/nl.po b/po/nl.po
index 16b3cba65..e915f5655 100644
Binary files a/po/nl.po and b/po/nl.po differ
diff --git a/po/pl.po b/po/pl.po
index 5b2cbcc55..429b629a0 100644
Binary files a/po/pl.po and b/po/pl.po differ
diff --git a/po/pt.po b/po/pt.po
index d2e89a140..de6844961 100644
Binary files a/po/pt.po and b/po/pt.po differ
diff --git a/po/pt_BR.po b/po/pt_BR.po
index 0865d1bc5..ff89ef053 100644
Binary files a/po/pt_BR.po and b/po/pt_BR.po differ
diff --git a/po/ro.po b/po/ro.po
index 5645759e4..8a4b51bcd 100644
Binary files a/po/ro.po and b/po/ro.po differ
diff --git a/po/ru.po b/po/ru.po
index eb02890ae..128fd1ec2 100644
Binary files a/po/ru.po and b/po/ru.po differ
diff --git a/po/sk.po b/po/sk.po
index db504290e..8914527bc 100644
Binary files a/po/sk.po and b/po/sk.po differ
diff --git a/po/sl.po b/po/sl.po
index c0febc728..44b9aad1c 100644
Binary files a/po/sl.po and b/po/sl.po differ
diff --git a/po/sr.po b/po/sr.po
index f336df473..5ec992561 100644
Binary files a/po/sr.po and b/po/sr.po differ
diff --git a/po/sv.po b/po/sv.po
index 98d11bfd1..1a50cb616 100644
Binary files a/po/sv.po and b/po/sv.po differ
diff --git a/po/szl.po b/po/szl.po
index a0657eb8c..ac19585bd 100644
Binary files a/po/szl.po and b/po/szl.po differ
diff --git a/po/ta.po b/po/ta.po
index 83fbae83a..83ba4382d 100644
Binary files a/po/ta.po and b/po/ta.po differ
diff --git a/po/te.po b/po/te.po
index 60bcdefba..53e9acb49 100644
Binary files a/po/te.po and b/po/te.po differ
diff --git a/po/tr.po b/po/tr.po
index 75450cf39..59d7d0ab7 100644
Binary files a/po/tr.po and b/po/tr.po differ
diff --git a/po/uk.po b/po/uk.po
index cfc7a53dc..716b9c78d 100644
Binary files a/po/uk.po and b/po/uk.po differ
diff --git a/po/vi.po b/po/vi.po
index 6e3c2e7b6..73c565662 100644
Binary files a/po/vi.po and b/po/vi.po differ
diff --git a/po/wa.po b/po/wa.po
index 2465c567a..a93693f6f 100644
Binary files a/po/wa.po and b/po/wa.po differ
diff --git a/po/zh_CN.po b/po/zh_CN.po
index 175f5de7f..601b55e1e 100644
Binary files a/po/zh_CN.po and b/po/zh_CN.po differ
diff --git a/po/zh_TW.po b/po/zh_TW.po
index ec91cea78..410680bea 100644
Binary files a/po/zh_TW.po and b/po/zh_TW.po differ
diff --git a/src/background.c b/src/background.c
index 8774c0cd7..4dd176193 100644
--- a/src/background.c
+++ b/src/background.c
@@ -525,7 +525,12 @@ do_background (file_op_context_t * ctx, char *info)
         return (-1);
 
     if (pipe (back_comm) == -1)
+    {
+        (void) close (comm[0]);
+        (void) close (comm[1]);
+
         return (-1);
+    }
 
     pid = fork ();
     if (pid == -1)
@@ -565,6 +570,7 @@ do_background (file_op_context_t * ctx, char *info)
                 ;
             while (dup2 (nullfd, STDERR_FILENO) == -1 && errno == EINTR)
                 ;
+            close (nullfd);
         }
 
         return 0;
diff --git a/src/clipboard.c b/src/clipboard.c
index 4e0b60c0b..c277ae66b 100644
--- a/src/clipboard.c
+++ b/src/clipboard.c
@@ -71,14 +71,13 @@ clipboard_file_to_ext_clip (const gchar * event_group_name, const gchar * event_
                             gpointer init_data, gpointer data)
 {
     char *tmp, *cmd;
-    const char *d = getenv ("DISPLAY");
 
     (void) event_group_name;
     (void) event_name;
     (void) init_data;
     (void) data;
 
-    if (d == NULL || clipboard_store_path == NULL || clipboard_store_path[0] == '\0')
+    if (clipboard_store_path == NULL || clipboard_store_path[0] == '\0')
         return TRUE;
 
     tmp = mc_config_get_full_path (EDIT_HOME_CLIP_FILE);
@@ -101,14 +100,13 @@ clipboard_file_from_ext_clip (const gchar * event_group_name, const gchar * even
 {
     mc_pipe_t *p;
     int file = -1;
-    const char *d = getenv ("DISPLAY");
 
     (void) event_group_name;
     (void) event_name;
     (void) init_data;
     (void) data;
 
-    if (d == NULL || clipboard_paste_path == NULL || clipboard_paste_path[0] == '\0')
+    if (clipboard_paste_path == NULL || clipboard_paste_path[0] == '\0')
         return TRUE;
 
     p = mc_popen (clipboard_paste_path, NULL);
diff --git a/src/cons.handler.c b/src/cons.handler.c
index 79297c2a7..51009fd53 100644
--- a/src/cons.handler.c
+++ b/src/cons.handler.c
@@ -191,6 +191,8 @@ handle_console_linux (console_action_t action)
             /* Bind the pipe 0 to the standard input */
             do
             {
+                gboolean ok;
+
                 if (dup2 (pipefd1[0], STDIN_FILENO) == -1)
                     break;
                 status = close (pipefd1[0]);
@@ -201,9 +203,13 @@ handle_console_linux (console_action_t action)
                 status = close (pipefd2[1]);
                 /* Bind standard error to /dev/null */
                 status = open ("/dev/null", O_WRONLY);
-                if (dup2 (status, STDERR_FILENO) == -1)
+                if (status == -1)
                     break;
+                ok = dup2 (status, STDERR_FILENO) != -1;
                 status = close (status);
+                if (!ok)
+                    break;
+
                 if (tty_name != NULL)
                 {
                     char *mc_conssaver;
diff --git a/src/editor/edit.c b/src/editor/edit.c
index c77608084..edda1f832 100644
--- a/src/editor/edit.c
+++ b/src/editor/edit.c
@@ -3426,6 +3426,7 @@ edit_execute_cmd (WEdit * edit, long command, int char_for_insertion)
             edit->column_highlight = 0;
             edit_mark_cmd (edit, TRUE);
         }
+        break;
     default:
         break;
     }
@@ -3454,6 +3455,7 @@ edit_execute_cmd (WEdit * edit, long command, int char_for_insertion)
     case CK_MarkLeft:
     case CK_MarkRight:
         edit->force |= REDRAW_CHAR_ONLY;
+        break;
     default:
         break;
     }
@@ -3910,7 +3912,7 @@ edit_execute_cmd (WEdit * edit, long command, int char_for_insertion)
     case CK_ExternalCommand:
         edit_ext_cmd (edit);
         break;
-    case CK_Mail:
+    case CK_EditMail:
         edit_mail_dialog (edit);
         break;
 #ifdef HAVE_CHARSET
@@ -3998,6 +4000,7 @@ edit_execute_cmd (WEdit * edit, long command, int char_for_insertion)
         case CK_DeleteToEnd:
             format_paragraph (edit, FALSE);
             edit->force |= REDRAW_PAGE;
+            break;
         default:
             break;
         }
diff --git a/src/editor/editcmd.c b/src/editor/editcmd.c
index e2b904604..c9a6a3681 100644
--- a/src/editor/editcmd.c
+++ b/src/editor/editcmd.c
@@ -1121,7 +1121,8 @@ pipe_mail (const edit_buffer_t * buf, char *to, char *subject, char *cc)
         off_t i;
 
         for (i = 0; i < buf->size; i++)
-            fputc (edit_buffer_get_byte (buf, i), p);
+            if (fputc (edit_buffer_get_byte (buf, i), p) < 0)
+                break;
         pclose (p);
     }
 }
@@ -1531,7 +1532,7 @@ edit_complete_word_insert_recoded_completion (WEdit * edit, char *completion, gs
 void
 edit_refresh_cmd (void)
 {
-    clr_scr ();
+    tty_clear_screen ();
     repaint_screen ();
     tty_keypad (TRUE);
 }
@@ -3538,7 +3539,7 @@ edit_get_match_keyword_cmd (WEdit * edit)
         path = ptr;
         g_free (tagfile);
         tagfile = mc_build_filename (path, TAGS_NAME, (char *) NULL);
-        if (exist_file (tagfile))
+        if (tagfile != NULL && exist_file (tagfile))
             break;
     }
     while (strcmp (path, PATH_SEP_STR) != 0);
@@ -3630,7 +3631,7 @@ edit_suggest_current_word (WEdit * edit)
                     edit_insert (edit, *new_word);
                 g_free (cp_word);
             }
-            else if (retval == B_ADD_WORD && match_word != NULL)
+            else if (retval == B_ADD_WORD)
                 aspell_add_to_dict (match_word->str, (int) word_len);
         }
 
diff --git a/src/editor/editdraw.c b/src/editor/editdraw.c
index 564e18d6c..248128b68 100644
--- a/src/editor/editdraw.c
+++ b/src/editor/editdraw.c
@@ -1093,7 +1093,7 @@ edit_scroll_screen_over_cursor (WEdit * edit)
     {
         int n;
 
-        n = l_extreme + t_extreme;
+        n = l_extreme + r_extreme;
         if (n == 0)
             n = 1;
         l_extreme = (l_extreme * (w->cols - 1)) / n;
diff --git a/src/editor/editmenu.c b/src/editor/editmenu.c
index ca42a74a4..489893849 100644
--- a/src/editor/editmenu.c
+++ b/src/editor/editmenu.c
@@ -190,7 +190,7 @@ create_command_menu (void)
         entries = g_list_prepend (entries, menu_separator_create ());
     }
 #endif /* HAVE_ASPELL */
-    entries = g_list_prepend (entries, menu_entry_create (_("&Mail..."), CK_Mail));
+    entries = g_list_prepend (entries, menu_entry_create (_("&Mail..."), CK_EditMail));
 
 
     return g_list_reverse (entries);
diff --git a/src/editor/syntax.c b/src/editor/syntax.c
index 93aa7512c..f7c7b1fb0 100644
--- a/src/editor/syntax.c
+++ b/src/editor/syntax.c
@@ -1287,9 +1287,6 @@ edit_read_syntax_file (WEdit * edit, GPtrArray * pnames, const char *syntax_file
         /* Looking for 'include ...' lines before first 'file ...' ones */
         if (!found && strcmp (args[0], "include") == 0)
         {
-            if (g != NULL)
-                continue;
-
             if (args[1] == NULL || (g = open_include_file (args[1])) == NULL)
             {
                 result = line;
diff --git a/src/execute.c b/src/execute.c
index d9b306e67..dd0977cea 100644
--- a/src/execute.c
+++ b/src/execute.c
@@ -45,7 +45,7 @@
 #include "lib/strutil.h"        /* str_replace_all_substrings() */
 #include "lib/widget.h"
 
-#include "filemanager/midnight.h"
+#include "filemanager/filemanager.h"
 #include "filemanager/layout.h" /* use_dash() */
 #include "consaver/cons.saver.h"
 #ifdef ENABLE_SUBSHELL
@@ -99,7 +99,7 @@ static void
 edition_pre_exec (void)
 {
     if (clear_before_exec)
-        clr_scr ();
+        tty_clear_screen ();
     else
     {
         if (!(mc_global.tty.console_flag != '\0' || mc_global.tty.xterm_flag))
@@ -131,7 +131,7 @@ edition_pre_exec (void)
 static void
 do_possible_cd (const vfs_path_t * new_dir_vpath)
 {
-    if (!do_cd (new_dir_vpath, cd_exact))
+    if (!panel_cd (current_panel, new_dir_vpath, cd_exact))
         message (D_ERROR, _("Warning"), "%s",
                  _("The Commander can't change to the directory that\n"
                    "the subshell claims you are in. Perhaps you have\n"
@@ -470,7 +470,7 @@ toggle_subshell (void)
     disable_mouse ();
     disable_bracketed_paste ();
     if (clear_before_exec)
-        clr_scr ();
+        tty_clear_screen ();
     if (mc_global.tty.alternate_plus_minus)
         numeric_keypad_mode ();
 #ifndef HAVE_SLANG
@@ -551,7 +551,6 @@ toggle_subshell (void)
     {
         if (mc_global.mc_run_mode == MC_RUN_FULL)
         {
-            do_load_prompt ();
             if (new_dir_vpath != NULL)
                 do_possible_cd (new_dir_vpath);
         }
diff --git a/src/filemanager/Makefile.am b/src/filemanager/Makefile.am
index 71f9fc2f2..2b6db6a7b 100644
--- a/src/filemanager/Makefile.am
+++ b/src/filemanager/Makefile.am
@@ -2,16 +2,18 @@
 noinst_LTLIBRARIES = libmcfilemanager.la
 
 libmcfilemanager_la_SOURCES = \
-	achown.c achown.h \
+	achown.c \
 	boxes.c boxes.h \
-	chmod.c chmod.h \
-	chown.c chown.h \
+	cd.c cd.h \
+	chmod.c \
+	chown.c \
 	cmd.c cmd.h \
 	command.c command.h \
 	dir.c dir.h \
 	ext.c ext.h \
 	file.c file.h \
 	filegui.c filegui.h \
+	filemanager.h filemanager.c \
 	filenot.c filenot.h \
 	fileopctx.c fileopctx.h \
 	find.c \
@@ -19,7 +21,6 @@ libmcfilemanager_la_SOURCES = \
 	info.c info.h \
 	ioblksize.h \
 	layout.c layout.h \
-	midnight.h midnight.c \
 	mountlist.c mountlist.h \
 	panelize.c panelize.h \
 	panel.c panel.h \
@@ -33,7 +34,7 @@ AM_CPPFLAGS = -I$(top_srcdir) $(GLIB_CFLAGS) $(PCRE_CPPFLAGS)
 
 if ENABLE_EXT2FS_ATTR
 libmcfilemanager_la_SOURCES += \
-	chattr.c chattr.h
+	chattr.c
 
 AM_CPPFLAGS += @EXT2FS_CFLAGS@ @E2P_CFLAGS@
 endif
diff --git a/src/filemanager/achown.c b/src/filemanager/achown.c
index 813c5dbd5..568453ba4 100644
--- a/src/filemanager/achown.c
+++ b/src/filemanager/achown.c
@@ -45,9 +45,7 @@
 #include "lib/util.h"
 #include "lib/widget.h"
 
-#include "midnight.h"           /* current_panel */
-
-#include "achown.h"
+#include "cmd.h"                /* advanced_chown_cmd() */
 
 /*** global variables ****************************************************************************/
 
@@ -279,7 +277,7 @@ print_flags (const WDialog * h)
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-advanced_chown_refresh (WDialog * h)
+advanced_chown_refresh (const WDialog * h)
 {
     tty_setcolor (COLOR_NORMAL);
 
@@ -494,6 +492,7 @@ chl_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *dat
                 h->ret_value = parm;
                 dlg_stop (h);
             }
+            break;
         default:
             break;
         }
@@ -728,7 +727,7 @@ advanced_chown_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm
 /* --------------------------------------------------------------------------------------------- */
 
 static WDialog *
-advanced_chown_dlg_create (void)
+advanced_chown_dlg_create (WPanel * panel)
 {
     gboolean single_set;
     WDialog *ch_dlg;
@@ -742,7 +741,7 @@ advanced_chown_dlg_create (void)
     flag_pos = 0;
     x_toggle = 070;
 
-    single_set = (current_panel->marked < 2);
+    single_set = (panel->marked < 2);
     if (!single_set)
         lines += 2;
 
@@ -831,12 +830,12 @@ advanced_chown_done (gboolean need_update)
 /* --------------------------------------------------------------------------------------------- */
 
 static const char *
-next_file (void)
+next_file (const WPanel * panel)
 {
-    while (!current_panel->dir.list[current_file].f.marked)
+    while (!panel->dir.list[current_file].f.marked)
         current_file++;
 
-    return current_panel->dir.list[current_file].fname;
+    return panel->dir.list[current_file].fname;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -925,13 +924,13 @@ try_advanced_chown (const vfs_path_t * p, mode_t m, uid_t u, gid_t g)
 /* --------------------------------------------------------------------------------------------- */
 
 static gboolean
-do_advanced_chown (const vfs_path_t * p, mode_t m, uid_t u, gid_t g)
+do_advanced_chown (WPanel * panel, const vfs_path_t * p, mode_t m, uid_t u, gid_t g)
 {
     gboolean ret;
 
     ret = try_advanced_chown (p, m, u, g);
 
-    do_file_mark (current_panel, current_file, 0);
+    do_file_mark (panel, current_file, 0);
 
     return ret;
 }
@@ -939,30 +938,30 @@ do_advanced_chown (const vfs_path_t * p, mode_t m, uid_t u, gid_t g)
  /* --------------------------------------------------------------------------------------------- */
 
 static void
-apply_advanced_chowns (vfs_path_t * vpath, struct stat *sf)
+apply_advanced_chowns (WPanel * panel, vfs_path_t * vpath, struct stat *sf)
 {
     gid_t a_gid = sf->st_gid;
     uid_t a_uid = sf->st_uid;
     gboolean ok;
 
-    if (!do_advanced_chown
-        (vpath, get_mode (), (ch_flags[9] == '+') ? a_uid : (uid_t) (-1),
-         (ch_flags[10] == '+') ? a_gid : (gid_t) (-1)))
+    if (!do_advanced_chown (panel, vpath, get_mode (),
+                            (ch_flags[9] == '+') ? a_uid : (uid_t) (-1),
+                            (ch_flags[10] == '+') ? a_gid : (gid_t) (-1)))
         return;
 
     do
     {
         const char *fname;
 
-        fname = next_file ();
+        fname = next_file (panel);
         vpath = vfs_path_from_str (fname);
         ok = (mc_stat (vpath, sf) == 0);
 
         if (!ok)
         {
             /* if current file was deleted outside mc -- try next file */
-            /* decrease current_panel->marked */
-            do_file_mark (current_panel, current_file, 0);
+            /* decrease panel->marked */
+            do_file_mark (panel, current_file, 0);
 
             /* try next file */
             ok = TRUE;
@@ -971,14 +970,14 @@ apply_advanced_chowns (vfs_path_t * vpath, struct stat *sf)
         {
             ch_cmode = sf->st_mode;
 
-            ok = do_advanced_chown (vpath, get_mode (),
+            ok = do_advanced_chown (panel, vpath, get_mode (),
                                     (ch_flags[9] == '+') ? a_uid : (uid_t) (-1),
                                     (ch_flags[10] == '+') ? a_gid : (gid_t) (-1));
         }
 
         vfs_path_free (vpath);
     }
-    while (ok && current_panel->marked != 0);
+    while (ok && panel->marked != 0);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -986,7 +985,7 @@ apply_advanced_chowns (vfs_path_t * vpath, struct stat *sf)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-advanced_chown_cmd (void)
+advanced_chown_cmd (WPanel * panel)
 {
     gboolean need_update;
     gboolean end_chown;
@@ -994,7 +993,7 @@ advanced_chown_cmd (void)
     /* Number of files at startup */
     int files_on_begin;
 
-    files_on_begin = MAX (1, current_panel->marked);
+    files_on_begin = MAX (1, panel->marked);
 
     advanced_chown_init ();
 
@@ -1014,10 +1013,10 @@ advanced_chown_cmd (void)
         need_update = FALSE;
         end_chown = FALSE;
 
-        if (current_panel->marked != 0)
-            fname = next_file ();       /* next marked file */
+        if (panel->marked != 0)
+            fname = next_file (panel);  /* next marked file */
         else
-            fname = selection (current_panel)->fname;   /* single file */
+            fname = selection (panel)->fname;   /* single file */
 
         vpath = vfs_path_from_str (fname);
 
@@ -1029,9 +1028,9 @@ advanced_chown_cmd (void)
 
         ch_cmode = sf_stat.st_mode;
 
-        ch_dlg = advanced_chown_dlg_create ();
+        ch_dlg = advanced_chown_dlg_create (panel);
 
-        file_idx = files_on_begin == 1 ? 1 : (files_on_begin - current_panel->marked + 1);
+        file_idx = files_on_begin == 1 ? 1 : (files_on_begin - panel->marked + 1);
         label_set_textv (l_filename, "%s (%d/%d)",
                          str_fit_to_term (fname, WIDGET (ch_dlg)->cols - 20, J_LEFT_FIT),
                          file_idx, files_on_begin);
@@ -1046,7 +1045,7 @@ advanced_chown_cmd (void)
             break;
 
         case B_ENTER:
-            if (current_panel->marked <= 1)
+            if (panel->marked <= 1)
             {
                 /* single or last file */
                 if (mc_chmod (vpath, get_mode ()) == -1)
@@ -1074,7 +1073,7 @@ advanced_chown_cmd (void)
             break;
 
         case B_SETALL:
-            apply_advanced_chowns (vpath, &sf_stat);
+            apply_advanced_chowns (panel, vpath, &sf_stat);
             need_update = TRUE;
             end_chown = TRUE;
             break;
@@ -1084,9 +1083,9 @@ advanced_chown_cmd (void)
             break;
         }
 
-        if (current_panel->marked != 0 && result != B_CANCEL)
+        if (panel->marked != 0 && result != B_CANCEL)
         {
-            do_file_mark (current_panel, current_file, 0);
+            do_file_mark (panel, current_file, 0);
             need_update = TRUE;
         }
 
@@ -1094,7 +1093,7 @@ advanced_chown_cmd (void)
 
         dlg_destroy (ch_dlg);
     }
-    while (current_panel->marked != 0 && !end_chown);
+    while (panel->marked != 0 && !end_chown);
 
     advanced_chown_done (need_update);
 }
diff --git a/src/filemanager/achown.h b/src/filemanager/achown.h
deleted file mode 100644
index 61def7b68..000000000
--- a/src/filemanager/achown.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file achown.h
- *  \brief Header: Contains functions for advanced chowning
- */
-
-#ifndef MC__ACHOWN_H
-#define MC__ACHOWN_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void advanced_chown_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__ACHOWN_H */
diff --git a/src/filemanager/boxes.c b/src/filemanager/boxes.c
index e6a9abe1a..ed16d04dd 100644
--- a/src/filemanager/boxes.c
+++ b/src/filemanager/boxes.c
@@ -42,6 +42,7 @@
 #include "lib/global.h"
 
 #include "lib/tty/tty.h"
+#include "lib/tty/color.h"      /* tty_use_colors() */
 #include "lib/tty/key.h"        /* XCTRL and ALT macros  */
 #include "lib/skin.h"           /* INPUT_COLOR */
 #include "lib/mcconfig.h"       /* Load/save user formats */
@@ -72,10 +73,9 @@
 
 #include "command.h"            /* For cmdline */
 #include "dir.h"
-#include "panel.h"              /* LIST_FORMATS */
 #include "tree.h"
 #include "layout.h"             /* for get_nth_panel_name proto */
-#include "midnight.h"           /* current_panel */
+#include "filemanager.h"
 
 #include "boxes.h"
 
@@ -102,7 +102,7 @@ static const int panel_list_user_idx = 3;
 
 static char **status_format;
 static unsigned long panel_list_formats_id, panel_user_format_id, panel_brief_cols_id;
-static unsigned long mini_user_status_id, mini_user_format_id;
+static unsigned long user_mini_status_id, mini_user_format_id;
 
 #ifdef HAVE_CHARSET
 static int new_display_codepage;
@@ -119,6 +119,8 @@ static gchar *current_skin_name;
 static WListbox *bg_list = NULL;
 #endif /* ENABLE_BACKGROUND */
 
+static unsigned long shadows_id;
+
 /* --------------------------------------------------------------------------------------------- */
 /*** file scope functions ************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -272,6 +274,38 @@ sel_skin_button (WButton * button, int action)
 
 /* --------------------------------------------------------------------------------------------- */
 
+static cb_ret_t
+appearance_box_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *data)
+{
+    switch (msg)
+    {
+    case MSG_INIT:
+        if (!tty_use_colors ())
+        {
+            Widget *shadow;
+
+            shadow = widget_find_by_id (w, shadows_id);
+            CHECK (shadow)->state = FALSE;
+            widget_disable (shadow, TRUE);
+        }
+        return MSG_HANDLED;
+
+    case MSG_NOTIFY:
+        if (sender != NULL && sender->id == shadows_id)
+        {
+            mc_global.tty.shadows = CHECK (sender)->state;
+            repaint_screen ();
+            return MSG_HANDLED;
+        }
+        return MSG_NOT_HANDLED;
+
+    default:
+        return dlg_default_callback (w, sender, msg, parm, data);
+    }
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 static cb_ret_t
 panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *data)
 {
@@ -285,7 +319,7 @@ panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm,
 
             in1 = INPUT (widget_find_by_id (w, panel_user_format_id));
             in2 = INPUT (widget_find_by_id (w, panel_brief_cols_id));
-            ch = CHECK (widget_find_by_id (w, mini_user_status_id));
+            ch = CHECK (widget_find_by_id (w, user_mini_status_id));
             in3 = INPUT (widget_find_by_id (w, mini_user_format_id));
 
             if (!ch->state)
@@ -298,7 +332,7 @@ panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm,
             return MSG_HANDLED;
         }
 
-        if (sender != NULL && sender->id == mini_user_status_id)
+        if (sender != NULL && sender->id == user_mini_status_id)
         {
             WInput *in;
 
@@ -590,6 +624,8 @@ configure_box (void)
 void
 appearance_box (void)
 {
+    gboolean shadows = mc_global.tty.shadows;
+
     current_skin_name = g_strdup (mc_skin__default.name);
     skin_names = mc_skin_list ();
 
@@ -602,6 +638,8 @@ appearance_box (void)
                 QUICK_BUTTON (str_fit_to_term (skin_name_to_label (current_skin_name), 20, J_LEFT_FIT),
                               B_USER, sel_skin_button, NULL),
             QUICK_STOP_COLUMNS,
+            QUICK_SEPARATOR (TRUE),
+            QUICK_CHECKBOX (N_("&Shadows"), &mc_global.tty.shadows, &shadows_id),
             QUICK_BUTTONS_OK_CANCEL,
             QUICK_END
             /* *INDENT-ON* */
@@ -610,14 +648,17 @@ appearance_box (void)
         quick_dialog_t qdlg = {
             -1, -1, 54,
             N_("Appearance"), "[Appearance]",
-            quick_widgets, dlg_default_callback, NULL
+            quick_widgets, appearance_box_callback, NULL
         };
 
         if (quick_dialog (&qdlg) == B_ENTER)
             mc_config_set_string (mc_global.main_config, CONFIG_APP_SECTION, "skin",
                                   current_skin_name);
         else
+        {
             skin_apply (NULL);
+            mc_global.tty.shadows = shadows;
+        }
     }
 
     g_free (current_skin_name);
@@ -725,7 +766,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
     }
 
     {
-        gboolean mini_user_status;
+        gboolean user_mini_status;
         char panel_brief_cols_in[BUF_TINY];
         char *panel_brief_cols_out = NULL;
         char *panel_user_format = NULL;
@@ -752,7 +793,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
             QUICK_INPUT (panel->user_format, "user-fmt-input", &panel_user_format,
                          &panel_user_format_id, FALSE, FALSE, INPUT_COMPLETE_NONE),
             QUICK_SEPARATOR (TRUE),
-            QUICK_CHECKBOX (N_("User &mini status"), &mini_user_status, &mini_user_status_id),
+            QUICK_CHECKBOX (N_("User &mini status"), &user_mini_status, &user_mini_status_id),
             QUICK_INPUT (panel->user_status_format[panel->list_format], "mini_input",
                          &mini_user_format, &mini_user_format_id, FALSE, FALSE, INPUT_COMPLETE_NONE),
             QUICK_BUTTONS_OK_CANCEL,
@@ -766,7 +807,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
             quick_widgets, panel_listing_callback, NULL
         };
 
-        mini_user_status = panel->user_mini_status;
+        user_mini_status = panel->user_mini_status;
         result = panel->list_format;
         status_format = panel->user_status_format;
 
@@ -778,7 +819,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
         if ((int) panel->list_format != panel_list_user_idx)
             quick_widgets[6].state = WST_DISABLED;
 
-        if (!mini_user_status)
+        if (!user_mini_status)
             quick_widgets[9].state = WST_DISABLED;
 
         if (quick_dialog (&qdlg) == B_CANCEL)
@@ -790,7 +831,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
 
             *userp = panel_user_format;
             *minip = mini_user_format;
-            *use_msformat = mini_user_status;
+            *use_msformat = user_mini_status;
 
             cols = strtol (panel_brief_cols_out, &error, 10);
             if (*error == '\0')
@@ -1154,9 +1195,9 @@ configure_vfs_box (void)
 /* --------------------------------------------------------------------------------------------- */
 
 char *
-cd_box (void)
+cd_box (const WPanel * panel)
 {
-    const Widget *w = CONST_WIDGET (current_panel);
+    const Widget *w = CONST_WIDGET (panel);
     char *my_str;
 
     quick_widget_t quick_widgets[] = {
diff --git a/src/filemanager/boxes.h b/src/filemanager/boxes.h
index 4d6acc3a8..6cb115e53 100644
--- a/src/filemanager/boxes.h
+++ b/src/filemanager/boxes.h
@@ -28,7 +28,7 @@ void confirm_box (void);
 void display_bits_box (void);
 void configure_vfs_box (void);
 void jobs_box (void);
-char *cd_box (void);
+char *cd_box (const WPanel * panel);
 void symlink_box (const vfs_path_t * existing_vpath, const vfs_path_t * new_vpath,
                   char **ret_existing, char **ret_new);
 char *tree_box (const char *current_dir);
diff --git a/src/filemanager/cd.c b/src/filemanager/cd.c
new file mode 100644
index 000000000..1e2932ef7
diff --git a/src/filemanager/chmod.h b/src/filemanager/cd.h
similarity index 81%
rename from src/filemanager/chmod.h
rename to src/filemanager/cd.h
index 7b6d833d5..a63278a32 100644
--- a/src/filemanager/chmod.h
+++ b/src/filemanager/cd.h
@@ -1,9 +1,9 @@
-/** \file chmod.h
- *  \brief Header: chmod command
+/** \file cd.h
+ *  \brief Header: cd function
  */
 
-#ifndef MC__CHMOD_H
-#define MC__CHMOD_H
+#ifndef MC__CD_H
+#define MC__CD_H
 
 /*** typedefs(not structures) and defined constants **********************************************/
 
@@ -15,7 +15,8 @@
 
 /*** declarations of public functions ************************************************************/
 
-void chmod_cmd (void);
+void cd_to (const char *path);
 
 /*** inline functions ****************************************************************************/
-#endif /* MC__CHMOD_H */
+
+#endif /* MC__CD_H */
diff --git a/src/filemanager/chattr.c b/src/filemanager/chattr.c
index d68612211..a8afaa33d 100644
--- a/src/filemanager/chattr.c
+++ b/src/filemanager/chattr.c
@@ -48,10 +48,7 @@
 
 #include "src/keybind-defaults.h"       /* chattr_map */
 
-#include "midnight.h"           /* current_panel */
-#include "panel.h"              /* do_file_mark() */
-
-#include "chattr.h"
+#include "cmd.h"                /* chattr_cmd(), chattr_get_as_str() */
 
 /*** global variables ****************************************************************************/
 
@@ -122,7 +119,7 @@ struct WChattrBoxes
  * EXT4_EOFBLOCKS_FL        0x00400000 was here, unused
  * FS_NOCOW_FL              0x00800000 -- Do not cow file
  * EXT4_SNAPFILE_FL         0x01000000 -- Inode is a snapshot
- *                          0x02000000 -- unused yet
+ * FS_DAX_FL                0x02000000 -- Inode is DAX
  * EXT4_SNAPFILE_DELETED_FL 0x04000000 -- Snapshot is being deleted
  * EXT4_SNAPFILE_SHRUNK_FL  0x08000000 -- Snapshot shrink has completed
  * EXT4_INLINE_DATA_FL      0x10000000 -- Inode has inline data
@@ -179,6 +176,12 @@ static struct
     { EXT4_HUGE_FILE_FL,    'h', N_("Huge_file"),                     FALSE, FALSE },
 #endif
     { FS_NOCOW_FL,          'C', N_("No COW"),                        FALSE, FALSE },
+#ifdef FS_DAX_FL
+    /* added in v1.45.7
+       TODO: clarify version after ext2fsprogs release
+       ext2fsprogs 1dd48bc23c3776df76459aff0c7723fff850ea45 2020-07-28 */
+    { FS_DAX_FL,            'x', N_("Direct access for files"),       FALSE, FALSE },
+#endif
 #ifdef EXT4_CASEFOLD_FL
     /* added in v1.45.0
        ext2fsprogs 1378bb6515e98a27f0f5c220381d49d20544204e 2018-12-01 */
@@ -865,6 +868,8 @@ chattrboxes_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
         break;
 
     default:
+        /* return MOU_UNHANDLED */
+        event->result.abort = TRUE;
         break;
     }
 }
@@ -938,7 +943,7 @@ chattr_init (void)
 /* --------------------------------------------------------------------------------------------- */
 
 static WDialog *
-chattr_dlg_create (const char *fname, unsigned long attr)
+chattr_dlg_create (WPanel * panel, const char *fname, unsigned long attr)
 {
     const Widget *mw = CONST_WIDGET (midnight_dlg);
     gboolean single_set;
@@ -958,7 +963,7 @@ chattr_dlg_create (const char *fname, unsigned long attr)
 
     cols = check_attr_width + cb_scrollbar_width;
 
-    single_set = (current_panel->marked < 2);
+    single_set = (panel->marked < 2);
 
     lines = 5 + checkboxes_lines + 4;
     if (!single_set)
@@ -1073,12 +1078,12 @@ chattr_done (gboolean need_update)
 /* --------------------------------------------------------------------------------------------- */
 
 static const char *
-next_file (void)
+next_file (const WPanel * panel)
 {
-    while (!current_panel->dir.list[current_file].f.marked)
+    while (!panel->dir.list[current_file].f.marked)
         current_file++;
 
-    return current_panel->dir.list[current_file].fname;
+    return panel->dir.list[current_file].fname;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1128,7 +1133,7 @@ try_chattr (const char *p, unsigned long m)
 /* --------------------------------------------------------------------------------------------- */
 
 static gboolean
-do_chattr (const vfs_path_t * p, unsigned long m)
+do_chattr (WPanel * panel, const vfs_path_t * p, unsigned long m)
 {
     gboolean ret;
 
@@ -1137,7 +1142,7 @@ do_chattr (const vfs_path_t * p, unsigned long m)
 
     ret = try_chattr (vfs_path_as_str (p), m);
 
-    do_file_mark (current_panel, current_file, 0);
+    do_file_mark (panel, current_file, 0);
 
     return ret;
 }
@@ -1145,25 +1150,25 @@ do_chattr (const vfs_path_t * p, unsigned long m)
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-chattr_apply_mask (vfs_path_t * vpath, unsigned long m)
+chattr_apply_mask (WPanel * panel, vfs_path_t * vpath, unsigned long m)
 {
     gboolean ok;
 
-    if (!do_chattr (vpath, m))
+    if (!do_chattr (panel, vpath, m))
         return;
 
     do
     {
         const char *fname;
 
-        fname = next_file ();
+        fname = next_file (panel);
         ok = (fgetflags (fname, &m) == 0);
 
         if (!ok)
         {
             /* if current file was deleted outside mc -- try next file */
-            /* decrease current_panel->marked */
-            do_file_mark (current_panel, current_file, 0);
+            /* decrease panel->marked */
+            do_file_mark (panel, current_file, 0);
 
             /* try next file */
             ok = TRUE;
@@ -1172,11 +1177,11 @@ chattr_apply_mask (vfs_path_t * vpath, unsigned long m)
         {
             vpath = vfs_path_from_str (fname);
             flags = m;
-            ok = do_chattr (vpath, m);
+            ok = do_chattr (panel, vpath, m);
             vfs_path_free (vpath);
         }
     }
-    while (ok && current_panel->marked != 0);
+    while (ok && panel->marked != 0);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1184,7 +1189,7 @@ chattr_apply_mask (vfs_path_t * vpath, unsigned long m)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-chattr_cmd (void)
+chattr_cmd (WPanel * panel)
 {
     gboolean need_update = FALSE;
     gboolean end_chattr = FALSE;
@@ -1214,10 +1219,10 @@ chattr_cmd (void)
         need_update = FALSE;
         end_chattr = FALSE;
 
-        if (current_panel->marked != 0)
-            fname = next_file ();       /* next marked file */
+        if (panel->marked != 0)
+            fname = next_file (panel);  /* next marked file */
         else
-            fname = selection (current_panel)->fname;   /* single file */
+            fname = selection (panel)->fname;   /* single file */
 
         vpath = vfs_path_from_str (fname);
         fname2 = vfs_path_as_str (vpath);
@@ -1232,7 +1237,7 @@ chattr_cmd (void)
 
         flags_changed = FALSE;
 
-        ch_dlg = chattr_dlg_create (fname, flags);
+        ch_dlg = chattr_dlg_create (panel, fname, flags);
         result = dlg_run (ch_dlg);
         dlg_destroy (ch_dlg);
 
@@ -1245,7 +1250,7 @@ chattr_cmd (void)
         case B_ENTER:
             if (flags_changed)
             {
-                if (current_panel->marked <= 1)
+                if (panel->marked <= 1)
                 {
                     /* single or last file */
                     if (fsetflags (fname2, flags) == -1 && !ignore_all)
@@ -1278,7 +1283,7 @@ chattr_cmd (void)
                         and_mask &= ~check_attr[i].flags;
                 }
 
-            chattr_apply_mask (vpath, flags);
+            chattr_apply_mask (panel, vpath, flags);
             need_update = TRUE;
             end_chattr = TRUE;
             break;
@@ -1291,7 +1296,7 @@ chattr_cmd (void)
                 if (chattr_is_modifiable (i) && check_attr[i].selected)
                     or_mask |= check_attr[i].flags;
 
-            chattr_apply_mask (vpath, flags);
+            chattr_apply_mask (panel, vpath, flags);
             need_update = TRUE;
             end_chattr = TRUE;
             break;
@@ -1304,7 +1309,7 @@ chattr_cmd (void)
                 if (chattr_is_modifiable (i) && check_attr[i].selected)
                     and_mask &= ~check_attr[i].flags;
 
-            chattr_apply_mask (vpath, flags);
+            chattr_apply_mask (panel, vpath, flags);
             need_update = TRUE;
             end_chattr = TRUE;
             break;
@@ -1313,16 +1318,16 @@ chattr_cmd (void)
             break;
         }
 
-        if (current_panel->marked != 0 && result != B_CANCEL)
+        if (panel->marked != 0 && result != B_CANCEL)
         {
-            do_file_mark (current_panel, current_file, 0);
+            do_file_mark (panel, current_file, 0);
             need_update = TRUE;
         }
 
         vfs_path_free (vpath);
 
     }
-    while (current_panel->marked != 0 && !end_chattr);
+    while (panel->marked != 0 && !end_chattr);
 
     chattr_done (need_update);
 }
diff --git a/src/filemanager/chattr.h b/src/filemanager/chattr.h
deleted file mode 100644
index b6eaa2374..000000000
--- a/src/filemanager/chattr.h
+++ /dev/null
@@ -1,23 +0,0 @@
-/** \file chattr.h
- *  \brief Header: chattr command
- */
-
-#ifndef MC__CHATTR_H
-#define MC__CHATTR_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chattr_cmd (void);
-const char *chattr_get_as_str (unsigned long attr);
-
-/*** inline functions ****************************************************************************/
-
-#endif /* MC__CHATTR_H */
diff --git a/src/filemanager/chmod.c b/src/filemanager/chmod.c
index 5a56563ec..a8b04406b 100644
--- a/src/filemanager/chmod.c
+++ b/src/filemanager/chmod.c
@@ -40,9 +40,7 @@
 #include "lib/util.h"
 #include "lib/widget.h"
 
-#include "midnight.h"           /* current_panel */
-
-#include "chmod.h"
+#include "cmd.h"                /* chmod_cmd() */
 
 /*** global variables ****************************************************************************/
 
@@ -302,7 +300,7 @@ chmod_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
 /* --------------------------------------------------------------------------------------------- */
 
 static WDialog *
-chmod_dlg_create (const char *fname, const struct stat *sf_stat)
+chmod_dlg_create (WPanel * panel, const char *fname, const struct stat *sf_stat)
 {
     gboolean single_set;
     WDialog *ch_dlg;
@@ -316,7 +314,7 @@ chmod_dlg_create (const char *fname, const struct stat *sf_stat)
 
     mode_change = FALSE;
 
-    single_set = (current_panel->marked < 2);
+    single_set = (panel->marked < 2);
     perm_gb_len = check_perm_len + 2;
     file_gb_len = file_info_labels_len + 2;
     cols = str_term_width1 (fname) + 2 + 1;
@@ -413,12 +411,12 @@ chmod_done (gboolean need_update)
 /* --------------------------------------------------------------------------------------------- */
 
 static const char *
-next_file (void)
+next_file (const WPanel * panel)
 {
-    while (!current_panel->dir.list[current_file].f.marked)
+    while (!panel->dir.list[current_file].f.marked)
         current_file++;
 
-    return current_panel->dir.list[current_file].fname;
+    return panel->dir.list[current_file].fname;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -468,7 +466,7 @@ try_chmod (const vfs_path_t * p, mode_t m)
 /* --------------------------------------------------------------------------------------------- */
 
 static gboolean
-do_chmod (const vfs_path_t * p, struct stat *sf)
+do_chmod (WPanel * panel, const vfs_path_t * p, struct stat *sf)
 {
     gboolean ret;
 
@@ -477,7 +475,7 @@ do_chmod (const vfs_path_t * p, struct stat *sf)
 
     ret = try_chmod (p, sf->st_mode);
 
-    do_file_mark (current_panel, current_file, 0);
+    do_file_mark (panel, current_file, 0);
 
     return ret;
 }
@@ -485,26 +483,26 @@ do_chmod (const vfs_path_t * p, struct stat *sf)
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-apply_mask (vfs_path_t * vpath, struct stat *sf)
+apply_mask (WPanel * panel, vfs_path_t * vpath, struct stat *sf)
 {
     gboolean ok;
 
-    if (!do_chmod (vpath, sf))
+    if (!do_chmod (panel, vpath, sf))
         return;
 
     do
     {
         const char *fname;
 
-        fname = next_file ();
+        fname = next_file (panel);
         vpath = vfs_path_from_str (fname);
         ok = (mc_stat (vpath, sf) == 0);
 
         if (!ok)
         {
             /* if current file was deleted outside mc -- try next file */
-            /* decrease current_panel->marked */
-            do_file_mark (current_panel, current_file, 0);
+            /* decrease panel->marked */
+            do_file_mark (panel, current_file, 0);
 
             /* try next file */
             ok = TRUE;
@@ -513,12 +511,12 @@ apply_mask (vfs_path_t * vpath, struct stat *sf)
         {
             ch_mode = sf->st_mode;
 
-            ok = do_chmod (vpath, sf);
+            ok = do_chmod (panel, vpath, sf);
         }
 
         vfs_path_free (vpath);
     }
-    while (ok && current_panel->marked != 0);
+    while (ok && panel->marked != 0);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -526,7 +524,7 @@ apply_mask (vfs_path_t * vpath, struct stat *sf)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-chmod_cmd (void)
+chmod_cmd (WPanel * panel)
 {
     gboolean need_update;
     gboolean end_chmod;
@@ -549,10 +547,10 @@ chmod_cmd (void)
         need_update = FALSE;
         end_chmod = FALSE;
 
-        if (current_panel->marked != 0)
-            fname = next_file ();       /* next marked file */
+        if (panel->marked != 0)
+            fname = next_file (panel);  /* next marked file */
         else
-            fname = selection (current_panel)->fname;   /* single file */
+            fname = selection (panel)->fname;   /* single file */
 
         vpath = vfs_path_from_str (fname);
 
@@ -564,7 +562,7 @@ chmod_cmd (void)
 
         ch_mode = sf_stat.st_mode;
 
-        ch_dlg = chmod_dlg_create (fname, &sf_stat);
+        ch_dlg = chmod_dlg_create (panel, fname, &sf_stat);
         result = dlg_run (ch_dlg);
 
         switch (result)
@@ -576,7 +574,7 @@ chmod_cmd (void)
         case B_ENTER:
             if (mode_change)
             {
-                if (current_panel->marked <= 1)
+                if (panel->marked <= 1)
                 {
                     /* single or last file */
                     if (mc_chmod (vpath, ch_mode) == -1 && !ignore_all)
@@ -609,7 +607,7 @@ chmod_cmd (void)
                         and_mask &= ~check_perm[i].mode;
                 }
 
-            apply_mask (vpath, &sf_stat);
+            apply_mask (panel, vpath, &sf_stat);
             need_update = TRUE;
             end_chmod = TRUE;
             break;
@@ -622,7 +620,7 @@ chmod_cmd (void)
                 if (check_perm[i].selected)
                     or_mask |= check_perm[i].mode;
 
-            apply_mask (vpath, &sf_stat);
+            apply_mask (panel, vpath, &sf_stat);
             need_update = TRUE;
             end_chmod = TRUE;
             break;
@@ -635,7 +633,7 @@ chmod_cmd (void)
                 if (check_perm[i].selected)
                     and_mask &= ~check_perm[i].mode;
 
-            apply_mask (vpath, &sf_stat);
+            apply_mask (panel, vpath, &sf_stat);
             need_update = TRUE;
             end_chmod = TRUE;
             break;
@@ -644,9 +642,9 @@ chmod_cmd (void)
             break;
         }
 
-        if (current_panel->marked != 0 && result != B_CANCEL)
+        if (panel->marked != 0 && result != B_CANCEL)
         {
-            do_file_mark (current_panel, current_file, 0);
+            do_file_mark (panel, current_file, 0);
             need_update = TRUE;
         }
 
@@ -654,7 +652,7 @@ chmod_cmd (void)
 
         dlg_destroy (ch_dlg);
     }
-    while (current_panel->marked != 0 && !end_chmod);
+    while (panel->marked != 0 && !end_chmod);
 
     chmod_done (need_update);
 }
diff --git a/src/filemanager/chown.c b/src/filemanager/chown.c
index 6ea428cd5..9ee633834 100644
--- a/src/filemanager/chown.c
+++ b/src/filemanager/chown.c
@@ -45,9 +45,8 @@
 #include "lib/widget.h"
 
 #include "src/setup.h"          /* panels_options */
-#include "midnight.h"           /* current_panel */
 
-#include "chown.h"
+#include "cmd.h"                /* chown_cmd() */
 
 /*** global variables ****************************************************************************/
 
@@ -187,7 +186,7 @@ chown_bg_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
 /* --------------------------------------------------------------------------------------------- */
 
 static WDialog *
-chown_dlg_create (void)
+chown_dlg_create (WPanel * panel)
 {
     int single_set;
     WDialog *ch_dlg;
@@ -197,7 +196,7 @@ chown_dlg_create (void)
     struct passwd *l_pass;
     struct group *l_grp;
 
-    single_set = (current_panel->marked < 2) ? 3 : 0;
+    single_set = (panel->marked < 2) ? 3 : 0;
     lines = GH + 4 + (single_set != 0 ? 2 : 4);
     cols = GW * 3 + 2 + 6;
 
@@ -285,12 +284,12 @@ chown_done (gboolean need_update)
 /* --------------------------------------------------------------------------------------------- */
 
 static const char *
-next_file (void)
+next_file (const WPanel * panel)
 {
-    while (!current_panel->dir.list[current_file].f.marked)
+    while (!panel->dir.list[current_file].f.marked)
         current_file++;
 
-    return current_panel->dir.list[current_file].fname;
+    return panel->dir.list[current_file].fname;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -340,13 +339,13 @@ try_chown (const vfs_path_t * p, uid_t u, gid_t g)
 /* --------------------------------------------------------------------------------------------- */
 
 static gboolean
-do_chown (const vfs_path_t * p, uid_t u, gid_t g)
+do_chown (WPanel * panel, const vfs_path_t * p, uid_t u, gid_t g)
 {
     gboolean ret;
 
     ret = try_chown (p, u, g);
 
-    do_file_mark (current_panel, current_file, 0);
+    do_file_mark (panel, current_file, 0);
 
     return ret;
 }
@@ -354,11 +353,11 @@ do_chown (const vfs_path_t * p, uid_t u, gid_t g)
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-apply_chowns (vfs_path_t * vpath, uid_t u, gid_t g)
+apply_chowns (WPanel * panel, vfs_path_t * vpath, uid_t u, gid_t g)
 {
     gboolean ok;
 
-    if (!do_chown (vpath, u, g))
+    if (!do_chown (panel, vpath, u, g))
         return;
 
     do
@@ -366,25 +365,25 @@ apply_chowns (vfs_path_t * vpath, uid_t u, gid_t g)
         const char *fname;
         struct stat sf;
 
-        fname = next_file ();
+        fname = next_file (panel);
         vpath = vfs_path_from_str (fname);
         ok = (mc_stat (vpath, &sf) == 0);
 
         if (!ok)
         {
             /* if current file was deleted outside mc -- try next file */
-            /* decrease current_panel->marked */
-            do_file_mark (current_panel, current_file, 0);
+            /* decrease panel->marked */
+            do_file_mark (panel, current_file, 0);
 
             /* try next file */
             ok = TRUE;
         }
         else
-            ok = do_chown (vpath, u, g);
+            ok = do_chown (panel, vpath, u, g);
 
         vfs_path_free (vpath);
     }
-    while (ok && current_panel->marked != 0);
+    while (ok && panel->marked != 0);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -392,7 +391,7 @@ apply_chowns (vfs_path_t * vpath, uid_t u, gid_t g)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-chown_cmd (void)
+chown_cmd (WPanel * panel)
 {
     gboolean need_update;
     gboolean end_chown;
@@ -418,10 +417,10 @@ chown_cmd (void)
         need_update = FALSE;
         end_chown = FALSE;
 
-        if (current_panel->marked != 0)
-            fname = next_file ();       /* next marked file */
+        if (panel->marked != 0)
+            fname = next_file (panel);  /* next marked file */
         else
-            fname = selection (current_panel)->fname;   /* single file */
+            fname = selection (panel)->fname;   /* single file */
 
         vpath = vfs_path_from_str (fname);
 
@@ -431,7 +430,7 @@ chown_cmd (void)
             break;
         }
 
-        ch_dlg = chown_dlg_create ();
+        ch_dlg = chown_dlg_create (panel);
 
         /* select in listboxes */
         listbox_select_entry (l_user, listbox_search_text (l_user, get_owner (sf_stat.st_uid)));
@@ -469,7 +468,7 @@ chown_cmd (void)
                     new_user = user->pw_uid;
                 if (result == B_ENTER)
                 {
-                    if (current_panel->marked <= 1)
+                    if (panel->marked <= 1)
                     {
                         /* single or last file */
                         if (mc_chown (vpath, new_user, new_group) == -1)
@@ -486,7 +485,7 @@ chown_cmd (void)
                 }
                 else
                 {
-                    apply_chowns (vpath, new_user, new_group);
+                    apply_chowns (panel, vpath, new_user, new_group);
                     end_chown = TRUE;
                 }
 
@@ -504,7 +503,7 @@ chown_cmd (void)
                 if (user != NULL)
                 {
                     new_user = user->pw_uid;
-                    apply_chowns (vpath, new_user, new_group);
+                    apply_chowns (panel, vpath, new_user, new_group);
                     need_update = TRUE;
                     end_chown = TRUE;
                 }
@@ -521,7 +520,7 @@ chown_cmd (void)
                 if (grp != NULL)
                 {
                     new_group = grp->gr_gid;
-                    apply_chowns (vpath, new_user, new_group);
+                    apply_chowns (panel, vpath, new_user, new_group);
                     need_update = TRUE;
                     end_chown = TRUE;
                 }
@@ -532,9 +531,9 @@ chown_cmd (void)
             break;
         }
 
-        if (current_panel->marked != 0 && result != B_CANCEL)
+        if (panel->marked != 0 && result != B_CANCEL)
         {
-            do_file_mark (current_panel, current_file, 0);
+            do_file_mark (panel, current_file, 0);
             need_update = TRUE;
         }
 
@@ -542,7 +541,7 @@ chown_cmd (void)
 
         dlg_destroy (ch_dlg);
     }
-    while (current_panel->marked != 0 && !end_chown);
+    while (panel->marked != 0 && !end_chown);
 
     chown_done (need_update);
 }
diff --git a/src/filemanager/chown.h b/src/filemanager/chown.h
deleted file mode 100644
index ba86ec4d6..000000000
--- a/src/filemanager/chown.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file chown.h
- *  \brief Header: chown command
- */
-
-#ifndef MC__CHOWN_H
-#define MC__CHOWN_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chown_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__CHOWN_H */
diff --git a/src/filemanager/cmd.c b/src/filemanager/cmd.c
index 2b35f6783..05109cabb 100644
--- a/src/filemanager/cmd.c
+++ b/src/filemanager/cmd.c
@@ -85,12 +85,13 @@
 #include "hotlist.h"            /* hotlist_show() */
 #include "panel.h"              /* WPanel */
 #include "tree.h"               /* tree_chdir() */
-#include "midnight.h"           /* change_panel() */
+#include "filemanager.h"        /* change_panel() */
 #include "command.h"            /* cmdline */
 #include "layout.h"             /* get_current_type() */
 #include "ext.h"                /* regex_command() */
 #include "boxes.h"              /* cd_box() */
 #include "dir.h"
+#include "cd.h"                 /* cd_to() */
 
 #include "cmd.h"                /* Our definitions */
 
@@ -124,23 +125,23 @@ static const char *machine_str = N_("Enter machine name (F1 for details):");
 /* --------------------------------------------------------------------------------------------- */
 /**
  * Run viewer (internal or external) on the currently selected file.
- * If normal is TRUE, force internal viewer and raw mode (used for F13).
+ * If @plain_view is TRUE, force internal viewer and raw mode (used for F13).
  */
 static void
-do_view_cmd (gboolean normal)
+do_view_cmd (WPanel * panel, gboolean plain_view)
 {
     /* Directories are viewed by changing to them */
-    if (S_ISDIR (selection (current_panel)->st.st_mode) || link_isdir (selection (current_panel)))
+    if (S_ISDIR (selection (panel)->st.st_mode) || link_isdir (selection (panel)))
     {
         vfs_path_t *fname_vpath;
 
-        if (confirm_view_dir && (current_panel->marked != 0 || current_panel->dirs_marked != 0) &&
+        if (confirm_view_dir && (panel->marked != 0 || panel->dirs_marked != 0) &&
             query_dialog (_("Confirmation"), _("Files tagged, want to cd?"), D_NORMAL, 2,
                           _("&Yes"), _("&No")) != 0)
             return;
 
-        fname_vpath = vfs_path_from_str (selection (current_panel)->fname);
-        if (!do_cd (fname_vpath, cd_exact))
+        fname_vpath = vfs_path_from_str (selection (panel)->fname);
+        if (!panel_cd (panel, fname_vpath, cd_exact))
             message (D_ERROR, MSG_ERROR, _("Cannot change directory"));
         vfs_path_free (fname_vpath);
     }
@@ -149,9 +150,9 @@ do_view_cmd (gboolean normal)
         int file_idx;
         vfs_path_t *filename_vpath;
 
-        file_idx = current_panel->selected;
-        filename_vpath = vfs_path_from_str (current_panel->dir.list[file_idx].fname);
-        view_file (filename_vpath, normal, use_internal_view);
+        file_idx = panel->selected;
+        filename_vpath = vfs_path_from_str (panel->dir.list[file_idx].fname);
+        view_file (filename_vpath, plain_view, use_internal_view);
         vfs_path_free (filename_vpath);
     }
 
@@ -459,7 +460,7 @@ nice_cd (const char *text, const char *xtext, const char *help,
             create_panel (MENU_PANEL_IDX, view_listing);
 
         cd_vpath = vfs_path_from_str_flags (cd_path, VPF_NO_CANON);
-        if (!do_panel_cd (MENU_PANEL, cd_vpath, cd_parse_command))
+        if (!panel_do_cd (MENU_PANEL, cd_vpath, cd_parse_command))
         {
             message (D_ERROR, MSG_ERROR, _("Cannot chdir to \"%s\""), cd_path);
 
@@ -470,7 +471,7 @@ nice_cd (const char *text, const char *xtext, const char *help,
     }
     g_free (cd_path);
 
-    /* In case of passive panel, restore current VFS directory that was changed in do_panel_cd() */
+    /* In case of passive panel, restore current VFS directory that was changed in panel_do_cd() */
     if (MENU_PANEL != current_panel)
         (void) mc_chdir (current_panel->cwd_vpath);
 }
@@ -609,23 +610,23 @@ view_file (const vfs_path_t * filename_vpath, gboolean plain_view, gboolean inte
 /** Run user's preferred viewer on the currently selected file */
 
 void
-view_cmd (void)
+view_cmd (WPanel * panel)
 {
-    do_view_cmd (FALSE);
+    do_view_cmd (panel, FALSE);
 }
 
 /* --------------------------------------------------------------------------------------------- */
 /** Ask for file and run user's preferred viewer on it */
 
 void
-view_file_cmd (void)
+view_file_cmd (const WPanel * panel)
 {
     char *filename;
     vfs_path_t *vpath;
 
     filename =
         input_expand_dialog (_("View file"), _("Filename:"),
-                             MC_HISTORY_FM_VIEW_FILE, selection (current_panel)->fname,
+                             MC_HISTORY_FM_VIEW_FILE, selection (panel)->fname,
                              INPUT_COMPLETE_FILENAMES);
     if (filename == NULL)
         return;
@@ -639,21 +640,21 @@ view_file_cmd (void)
 /* --------------------------------------------------------------------------------------------- */
 /** Run plain internal viewer on the currently selected file */
 void
-view_raw_cmd (void)
+view_raw_cmd (WPanel * panel)
 {
-    do_view_cmd (TRUE);
+    do_view_cmd (panel, TRUE);
 }
 
 /* --------------------------------------------------------------------------------------------- */
 
 void
-view_filtered_cmd (void)
+view_filtered_cmd (const WPanel * panel)
 {
     char *command;
     const char *initial_command;
 
     if (input_is_empty (cmdline))
-        initial_command = selection (current_panel)->fname;
+        initial_command = selection (panel)->fname;
     else
         initial_command = cmdline->buffer;
 
@@ -711,11 +712,11 @@ edit_file_at_line (const vfs_path_t * what_vpath, gboolean internal, long start_
 /* --------------------------------------------------------------------------------------------- */
 
 void
-edit_cmd (void)
+edit_cmd (const WPanel * panel)
 {
     vfs_path_t *fname;
 
-    fname = vfs_path_from_str (selection (current_panel)->fname);
+    fname = vfs_path_from_str (selection (panel)->fname);
     if (regex_command (fname, "Edit") == 0)
         do_edit (fname);
     vfs_path_free (fname);
@@ -725,11 +726,11 @@ edit_cmd (void)
 
 #ifdef USE_INTERNAL_EDIT
 void
-edit_cmd_force_internal (void)
+edit_cmd_force_internal (const WPanel * panel)
 {
     vfs_path_t *fname;
 
-    fname = vfs_path_from_str (selection (current_panel)->fname);
+    fname = vfs_path_from_str (selection (panel)->fname);
     if (regex_command (fname, "Edit") == 0)
         edit_file_at_line (fname, TRUE, 1);
     vfs_path_free (fname);
@@ -770,11 +771,11 @@ edit_cmd_new (void)
 /** Invoked by F5.  Copy, default to the other panel.  */
 
 void
-copy_cmd (void)
+copy_cmd (WPanel * panel)
 {
     save_cwds_stat ();
 
-    if (panel_operate (current_panel, OP_COPY, FALSE))
+    if (panel_operate (panel, OP_COPY, FALSE))
     {
         update_panels (UP_OPTIMIZE, UP_KEEPSEL);
         repaint_screen ();
@@ -785,11 +786,11 @@ copy_cmd (void)
 /** Invoked by F6.  Move/rename, default to the other panel, ignore marks.  */
 
 void
-rename_cmd (void)
+rename_cmd (WPanel * panel)
 {
     save_cwds_stat ();
 
-    if (panel_operate (current_panel, OP_MOVE, FALSE))
+    if (panel_operate (panel, OP_MOVE, FALSE))
     {
         update_panels (UP_OPTIMIZE, UP_KEEPSEL);
         repaint_screen ();
@@ -800,11 +801,11 @@ rename_cmd (void)
 /** Invoked by F15.  Copy, default to the same panel, ignore marks.  */
 
 void
-copy_cmd_local (void)
+copy_cmd_local (WPanel * panel)
 {
     save_cwds_stat ();
 
-    if (panel_operate (current_panel, OP_COPY, TRUE))
+    if (panel_operate (panel, OP_COPY, TRUE))
     {
         update_panels (UP_OPTIMIZE, UP_KEEPSEL);
         repaint_screen ();
@@ -815,11 +816,11 @@ copy_cmd_local (void)
 /** Invoked by F16.  Move/rename, default to the same panel.  */
 
 void
-rename_cmd_local (void)
+rename_cmd_local (WPanel * panel)
 {
     save_cwds_stat ();
 
-    if (panel_operate (current_panel, OP_MOVE, TRUE))
+    if (panel_operate (panel, OP_MOVE, TRUE))
     {
         update_panels (UP_OPTIMIZE, UP_KEEPSEL);
         repaint_screen ();
@@ -829,14 +830,14 @@ rename_cmd_local (void)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-mkdir_cmd (void)
+mkdir_cmd (WPanel * panel)
 {
     char *dir;
     const char *name = "";
 
     /* If 'on' then automatically fills name with current selected item name */
-    if (auto_fill_mkdir_name && !DIR_IS_DOTDOT (selection (current_panel)->fname))
-        name = selection (current_panel)->fname;
+    if (auto_fill_mkdir_name && !DIR_IS_DOTDOT (selection (panel)->fname))
+        name = selection (panel)->fname;
 
     dir =
         input_expand_dialog (_("Create a new Directory"),
@@ -858,7 +859,7 @@ mkdir_cmd (void)
             if (dir[0] == '\\' && dir[1] == '~')
                 tmpdir = dir + 1;
 
-            absdir = vfs_path_append_new (current_panel->cwd_vpath, tmpdir, (char *) NULL);
+            absdir = vfs_path_append_new (panel->cwd_vpath, tmpdir, (char *) NULL);
         }
 
         save_cwds_stat ();
@@ -869,7 +870,7 @@ mkdir_cmd (void)
         {
             update_panels (UP_OPTIMIZE, dir);
             repaint_screen ();
-            select_item (current_panel);
+            select_item (panel);
         }
 
         vfs_path_free (absdir);
@@ -880,11 +881,11 @@ mkdir_cmd (void)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-delete_cmd (void)
+delete_cmd (WPanel * panel)
 {
     save_cwds_stat ();
 
-    if (panel_operate (current_panel, OP_DELETE, FALSE))
+    if (panel_operate (panel, OP_DELETE, FALSE))
     {
         update_panels (UP_OPTIMIZE, UP_KEEPSEL);
         repaint_screen ();
@@ -895,11 +896,11 @@ delete_cmd (void)
 /** Invoked by F18.  Remove selected file, regardless of marked files.  */
 
 void
-delete_cmd_local (void)
+delete_cmd_local (WPanel * panel)
 {
     save_cwds_stat ();
 
-    if (panel_operate (current_panel, OP_DELETE, TRUE))
+    if (panel_operate (panel, OP_DELETE, TRUE))
     {
         update_panels (UP_OPTIMIZE, UP_KEEPSEL);
         repaint_screen ();
@@ -1099,14 +1100,12 @@ hotlist_cmd (void)
     else
     {
         vfs_path_t *deprecated_vpath;
-        char *cmd;
+        const char *deprecated_path;
 
         deprecated_vpath = vfs_path_from_str_flags (target, VPF_USE_DEPRECATED_PARSER);
-        cmd = g_strconcat ("cd ", vfs_path_as_str (deprecated_vpath), (char *) NULL);
+        deprecated_path = vfs_path_as_str (deprecated_vpath);
+        cd_to (deprecated_path);
         vfs_path_free (deprecated_vpath);
-
-        do_cd_command (cmd);
-        g_free (cmd);
     }
 
     g_free (target);
@@ -1126,7 +1125,7 @@ vfs_list (void)
         return;
 
     target_vpath = vfs_path_from_str (target);
-    if (!do_cd (target_vpath, cd_exact))
+    if (!panel_cd (current_panel, target_vpath, cd_exact))
         message (D_ERROR, MSG_ERROR, _("Cannot change directory"));
     vfs_path_free (target_vpath);
     g_free (target);
@@ -1275,7 +1274,7 @@ help_cmd (void)
 {
     ev_help_t event_data = { NULL, NULL };
 
-    if (current_panel->searching)
+    if (current_panel->quick_search.active)
         event_data.node = "[Quick search]";
     else
         event_data.node = "[main]";
@@ -1352,19 +1351,13 @@ undelete_cmd (void)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-quick_cd_cmd (void)
+quick_cd_cmd (WPanel * panel)
 {
     char *p;
 
-    p = cd_box ();
+    p = cd_box (panel);
     if (p != NULL && *p != '\0')
-    {
-        char *q;
-
-        q = g_strconcat ("cd ", p, (char *) NULL);
-        do_cd_command (q);
-        g_free (q);
-    }
+        cd_to (p);
     g_free (p);
 }
 
@@ -1380,27 +1373,23 @@ quick_cd_cmd (void)
  */
 
 void
-smart_dirsize_cmd (void)
+smart_dirsize_cmd (WPanel * panel)
 {
-    WPanel *panel = current_panel;
-    file_entry_t *entry;
+    const file_entry_t *entry = &panel->dir.list[panel->selected];
 
-    entry = &(panel->dir.list[panel->selected]);
     if ((S_ISDIR (entry->st.st_mode) && DIR_IS_DOTDOT (entry->fname)) || panel->dirs_marked)
-        dirsizes_cmd ();
+        dirsizes_cmd (panel);
     else
-        single_dirsize_cmd ();
+        single_dirsize_cmd (panel);
 }
 
 /* --------------------------------------------------------------------------------------------- */
 
 void
-single_dirsize_cmd (void)
+single_dirsize_cmd (WPanel * panel)
 {
-    WPanel *panel = current_panel;
-    file_entry_t *entry;
+    file_entry_t *entry = &panel->dir.list[panel->selected];
 
-    entry = &(panel->dir.list[panel->selected]);
     if (S_ISDIR (entry->st.st_mode) && !DIR_IS_DOTDOT (entry->fname))
     {
         size_t dir_count = 0;
@@ -1415,7 +1404,7 @@ single_dirsize_cmd (void)
         status_msg_init (STATUS_MSG (&dsm), _("Directory scanning"), 0, dirsize_status_init_cb,
                          dirsize_status_update_cb, dirsize_status_deinit_cb);
 
-        if (compute_dir_size (p, &dsm, &dir_count, &count, &total, TRUE) == FILE_CONT)
+        if (compute_dir_size (p, &dsm, &dir_count, &count, &total, FALSE) == FILE_CONT)
         {
             entry->st.st_size = (off_t) total;
             entry->f.dir_size_computed = 1;
@@ -1431,18 +1420,17 @@ single_dirsize_cmd (void)
 
     recalculate_panel_summary (panel);
 
-    if (current_panel->sort_field->sort_routine == (GCompareFunc) sort_size)
+    if (panel->sort_field->sort_routine == (GCompareFunc) sort_size)
         panel_re_sort (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
 
 void
-dirsizes_cmd (void)
+dirsizes_cmd (WPanel * panel)
 {
-    WPanel *panel = current_panel;
     int i;
     dirsize_status_msg_t dsm;
 
@@ -1462,7 +1450,7 @@ dirsizes_cmd (void)
             gboolean ok;
 
             p = vfs_path_from_str (panel->dir.list[i].fname);
-            ok = compute_dir_size (p, &dsm, &dir_count, &count, &total, TRUE) != FILE_CONT;
+            ok = compute_dir_size (p, &dsm, &dir_count, &count, &total, FALSE) != FILE_CONT;
             vfs_path_free (p);
             if (ok)
                 break;
@@ -1475,10 +1463,10 @@ dirsizes_cmd (void)
 
     recalculate_panel_summary (panel);
 
-    if (current_panel->sort_field->sort_routine == (GCompareFunc) sort_size)
+    if (panel->sort_field->sort_routine == (GCompareFunc) sort_size)
         panel_re_sort (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1588,7 +1576,7 @@ void
 quick_view_cmd (void)
 {
     if (PANEL (get_panel_widget (MENU_PANEL_IDX)) == current_panel)
-        change_panel ();
+        (void) change_panel ();
     create_panel (MENU_PANEL_IDX, view_quick);
 }
 
diff --git a/src/filemanager/cmd.h b/src/filemanager/cmd.h
index 9c77084e0..e748d39ce 100644
--- a/src/filemanager/cmd.h
+++ b/src/filemanager/cmd.h
@@ -9,6 +9,8 @@
 
 #include "lib/global.h"
 
+#include "panel.h"
+
 /*** typedefs(not structures) and defined constants **********************************************/
 
 /*** enums ***************************************************************************************/
@@ -40,30 +42,30 @@ void smblink_cmd (void);
 #endif
 void undelete_cmd (void);
 void help_cmd (void);
-void smart_dirsize_cmd (void);
-void single_dirsize_cmd (void);
-void dirsizes_cmd (void);
+void smart_dirsize_cmd (WPanel * panel);
+void single_dirsize_cmd (WPanel * panel);
+void dirsizes_cmd (WPanel * panel);
 gboolean view_file_at_line (const vfs_path_t * filename_vpath, gboolean plain_view,
                             gboolean internal, long start_line, off_t search_start,
                             off_t search_end);
-gboolean view_file (const vfs_path_t * filename_vpath, gboolean normal, gboolean internal);
-void view_cmd (void);
-void view_file_cmd (void);
-void view_raw_cmd (void);
-void view_filtered_cmd (void);
+gboolean view_file (const vfs_path_t * filename_vpath, gboolean plain_view, gboolean internal);
+void view_cmd (WPanel * panel);
+void view_file_cmd (const WPanel * panel);
+void view_raw_cmd (WPanel * panel);
+void view_filtered_cmd (const WPanel * panel);
 void edit_file_at_line (const vfs_path_t * what_vpath, gboolean internal, long start_line);
-void edit_cmd (void);
+void edit_cmd (const WPanel * panel);
 void edit_cmd_new (void);
 #ifdef USE_INTERNAL_EDIT
-void edit_cmd_force_internal (void);
+void edit_cmd_force_internal (const WPanel * panel);
 #endif
-void copy_cmd (void);
-void copy_cmd_local (void);
-void rename_cmd (void);
-void rename_cmd_local (void);
-void mkdir_cmd (void);
-void delete_cmd (void);
-void delete_cmd_local (void);
+void copy_cmd (WPanel * panel);
+void copy_cmd_local (WPanel * panel);
+void rename_cmd (WPanel * panel);
+void rename_cmd_local (WPanel * panel);
+void mkdir_cmd (WPanel * panel);
+void delete_cmd (WPanel * panel);
+void delete_cmd_local (WPanel * panel);
 void filter_cmd (void);
 void reread_cmd (void);
 void vfs_list (void);
@@ -79,7 +81,7 @@ void panel_tree_cmd (void);
 void link_cmd (link_type_t link_type);
 void edit_symlink_cmd (void);
 void swap_cmd (void);
-void quick_cd_cmd (void);
+void quick_cd_cmd (WPanel * panel);
 void save_setup_cmd (void);
 void user_file_menu_cmd (void);
 void info_cmd (void);
@@ -91,8 +93,19 @@ void quick_view_cmd (void);
 #ifdef HAVE_CHARSET
 void encoding_cmd (void);
 #endif
+/* achown.c */
+void advanced_chown_cmd (WPanel * panel);
+/* chmod.c */
+void chmod_cmd (WPanel * panel);
+/* chown.c */
+void chown_cmd (WPanel * panel);
+#ifdef ENABLE_EXT2FS_ATTR
+/* chattr.c */
+void chattr_cmd (WPanel * panel);
+const char *chattr_get_as_str (unsigned long attr);
+#endif
 /* find.c */
-void find_cmd (void);
+void find_cmd (WPanel * panel);
 
 /*** inline functions ****************************************************************************/
 #endif /* MC__CMD_H */
diff --git a/src/filemanager/command.c b/src/filemanager/command.c
index cce18fbc9..800bec8bc 100644
--- a/src/filemanager/command.c
+++ b/src/filemanager/command.c
@@ -9,6 +9,7 @@
 
    Written by:
    Slava Zanko <slavazanko@gmail.com>, 2013
+   Andrew Borodin <aborodin@vmail.ru>, 2020
 
    This file is part of the Midnight Commander.
 
@@ -33,27 +34,23 @@
 #include <config.h>
 
 #include <stdlib.h>
-#include <errno.h>
 #include <string.h>
 
-#include "lib/global.h"         /* home_dir */
-#include "lib/tty/tty.h"
-#include "lib/vfs/vfs.h"
-#include "lib/strescape.h"
+#include "lib/global.h"
+#include "lib/vfs/vfs.h"        /* vfs_current_is_local() */
 #include "lib/skin.h"           /* DEFAULT_COLOR */
-#include "lib/util.h"
+#include "lib/util.h"           /* whitespace() */
 #include "lib/widget.h"
 
 #include "src/setup.h"          /* quit */
 #ifdef ENABLE_SUBSHELL
 #include "src/subshell/subshell.h"
 #endif
-#include "src/execute.h"        /* shell_execute */
-#include "src/usermenu.h"       /* expand_format */
+#include "src/execute.h"        /* shell_execute() */
+#include "src/usermenu.h"       /* expand_format() */
 
-#include "midnight.h"           /* current_panel */
-#include "layout.h"             /* command_prompt */
-#include "tree.h"               /* sync_tree() */
+#include "filemanager.h"        /* quiet_quit_cmd(), layout.h */
+#include "cd.h"                 /* cd_to() */
 
 #include "command.h"
 
@@ -64,8 +61,6 @@ WInput *cmdline;
 
 /*** file scope macro definitions ****************************************************************/
 
-#define CD_OPERAND_OFFSET 3
-
 /*** file scope type declarations ****************************************************************/
 
 /*** file scope variables ************************************************************************/
@@ -77,159 +72,6 @@ static input_colors_t command_colors;
 /*** file scope functions ************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
 
-/**
- * Expand the argument to "cd" and change directory.  First try tilde
- * expansion, then variable substitution.  If the CDPATH variable is set
- * (e.g. CDPATH=".:~:/usr"), try all the paths contained there.
- * We do not support such rare substitutions as ${var:-value} etc.
- * No quoting is implemented here, so ${VAR} and $VAR will be always
- * substituted.  Wildcards are not supported either.
- * Advanced users should be encouraged to use "\cd" instead of "cd" if
- * they want the behavior they are used to in the shell.
- *
- * @param _path string to examine
- * @return newly allocated string
- */
-
-static char *
-examine_cd (const char *_path)
-{
-    /* *INDENT-OFF* */
-    typedef enum
-    {
-        copy_sym,
-        subst_var
-    } state_t;
-    /* *INDENT-ON* */
-
-    state_t state = copy_sym;
-    GString *q;
-    char *path_tilde, *path;
-    char *p;
-
-    /* Tilde expansion */
-    path = strutils_shell_unescape (_path);
-    path_tilde = tilde_expand (path);
-    g_free (path);
-
-    q = g_string_sized_new (32);
-
-    /* Variable expansion */
-    for (p = path_tilde; *p != '\0';)
-    {
-        switch (state)
-        {
-        case copy_sym:
-            if (p[0] == '\\' && p[1] == '$')
-            {
-                g_string_append_c (q, '$');
-                p += 2;
-            }
-            else if (p[0] != '$' || p[1] == '[' || p[1] == '(')
-            {
-                g_string_append_c (q, *p);
-                p++;
-            }
-            else
-                state = subst_var;
-            break;
-
-        case subst_var:
-            {
-                char *s = NULL;
-                char c;
-                const char *t = NULL;
-
-                /* skip dollar */
-                p++;
-
-                if (p[0] == '{')
-                {
-                    p++;
-                    s = strchr (p, '}');
-                }
-                if (s == NULL)
-                    s = strchr (p, PATH_SEP);
-                if (s == NULL)
-                    s = strchr (p, '\0');
-                c = *s;
-                *s = '\0';
-                t = getenv (p);
-                *s = c;
-                if (t == NULL)
-                {
-                    g_string_append_c (q, '$');
-                    if (p[-1] != '$')
-                        g_string_append_c (q, '{');
-                }
-                else
-                {
-                    g_string_append (q, t);
-                    p = s;
-                    if (*s == '}')
-                        p++;
-                }
-
-                state = copy_sym;
-                break;
-            }
-
-        default:
-            break;
-        }
-    }
-
-    g_free (path_tilde);
-
-    return g_string_free (q, FALSE);
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
-/* CDPATH handling */
-static gboolean
-handle_cdpath (const char *path)
-{
-    gboolean result = FALSE;
-
-    /* CDPATH handling */
-    if (!IS_PATH_SEP (*path))
-    {
-        char *cdpath, *p;
-        char c;
-
-        cdpath = g_strdup (getenv ("CDPATH"));
-        p = cdpath;
-        c = (p == NULL) ? '\0' : ':';
-
-        while (!result && c == ':')
-        {
-            char *s;
-
-            s = strchr (p, ':');
-            if (s == NULL)
-                s = strchr (p, '\0');
-            c = *s;
-            *s = '\0';
-            if (*p != '\0')
-            {
-                vfs_path_t *r_vpath;
-
-                r_vpath = vfs_path_build_filename (p, path, (char *) NULL);
-                result = do_cd (r_vpath, cd_parse_command);
-                vfs_path_free (r_vpath);
-            }
-            *s = c;
-            p = s + 1;
-        }
-        g_free (cdpath);
-    }
-
-    return result;
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
 /** Handle Enter on the command line
  *
  * @param lc_cmdline string for handling
@@ -251,9 +93,9 @@ enter (WInput * lc_cmdline)
     if (*cmd == '\0')
         return MSG_HANDLED;
 
-    if (strncmp (cmd, "cd ", 3) == 0 || strcmp (cmd, "cd") == 0)
+    if (strncmp (cmd, "cd", 2) == 0 && (cmd[2] == '\0' || whitespace (cmd[2])))
     {
-        do_cd_command (cmd);
+        cd_to (cmd + 2);
         input_clean (lc_cmdline);
         return MSG_HANDLED;
     }
@@ -353,109 +195,6 @@ command_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
 /*** public functions ****************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
 
-/** Execute the cd command on the command line
- *
- * @param orig_cmd command for execution
- */
-
-void
-do_cd_command (char *orig_cmd)
-{
-    int len;
-    int operand_pos = CD_OPERAND_OFFSET;
-    const char *cmd;
-
-    /* Any final whitespace should be removed here
-       (to see why, try "cd fred "). */
-    /* NOTE: I think we should not remove the extra space,
-       that way, we can cd into hidden directories */
-    /* FIXME: what about interpreting quoted strings like the shell.
-       so one could type "cd <tab> M-a <enter>" and it would work. */
-    len = strlen (orig_cmd) - 1;
-    while (len >= 0 && whiteness (orig_cmd[len]))
-    {
-        orig_cmd[len] = '\0';
-        len--;
-    }
-
-    cmd = orig_cmd;
-    if (cmd[CD_OPERAND_OFFSET - 1] == '\0')
-        cmd = "cd ";            /* 0..2 => given text, 3 => \0 */
-
-    /* allow any amount of white space in front of the path operand */
-    while (whitespace (cmd[operand_pos]))
-        operand_pos++;
-
-    if (get_current_type () == view_tree)
-    {
-        vfs_path_t *new_vpath = NULL;
-
-        if (cmd[0] == '\0')
-        {
-            new_vpath = vfs_path_from_str (mc_config_get_home_dir ());
-            sync_tree (new_vpath);
-        }
-        else if (DIR_IS_DOTDOT (cmd + operand_pos))
-        {
-            if (vfs_path_elements_count (current_panel->cwd_vpath) != 1 ||
-                strlen (vfs_path_get_by_index (current_panel->cwd_vpath, 0)->path) > 1)
-            {
-                vfs_path_t *tmp_vpath = current_panel->cwd_vpath;
-
-                current_panel->cwd_vpath =
-                    vfs_path_vtokens_get (tmp_vpath, 0, vfs_path_tokens_count (tmp_vpath) - 1);
-                vfs_path_free (tmp_vpath);
-            }
-            sync_tree (current_panel->cwd_vpath);
-        }
-        else
-        {
-            if (IS_PATH_SEP (cmd[operand_pos]))
-                new_vpath = vfs_path_from_str (cmd + operand_pos);
-            else
-                new_vpath =
-                    vfs_path_append_new (current_panel->cwd_vpath, cmd + operand_pos,
-                                         (char *) NULL);
-
-            sync_tree (new_vpath);
-        }
-
-        vfs_path_free (new_vpath);
-    }
-    else
-    {
-        char *path;
-        vfs_path_t *q_vpath;
-        gboolean ok;
-
-        path = examine_cd (&cmd[operand_pos]);
-
-        if (*path == '\0')
-            q_vpath = vfs_path_from_str (mc_config_get_home_dir ());
-        else
-            q_vpath = vfs_path_from_str_flags (path, VPF_NO_CANON);
-
-        ok = do_cd (q_vpath, cd_parse_command);
-        if (!ok)
-            ok = handle_cdpath (path);
-
-        if (!ok)
-        {
-            char *d;
-
-            d = vfs_path_to_str_flags (q_vpath, 0, VPF_STRIP_PASSWORD);
-            message (D_ERROR, MSG_ERROR, _("Cannot chdir to \"%s\"\n%s"), d,
-                     unix_error_string (errno));
-            g_free (d);
-        }
-
-        vfs_path_free (q_vpath);
-        g_free (path);
-    }
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
 WInput *
 command_new (int y, int x, int cols)
 {
diff --git a/src/filemanager/command.h b/src/filemanager/command.h
index 759261419..9aacca4e5 100644
--- a/src/filemanager/command.h
+++ b/src/filemanager/command.h
@@ -21,7 +21,6 @@ extern WInput *cmdline;
 
 WInput *command_new (int y, int x, int len);
 void command_set_default_colors (void);
-void do_cd_command (char *cmd);
 void command_insert (WInput * in, const char *text, gboolean insert_extra_space);
 
 /*** inline functions ****************************************************************************/
diff --git a/src/filemanager/dir.c b/src/filemanager/dir.c
index 9eec072d9..e52473d5b 100644
--- a/src/filemanager/dir.c
+++ b/src/filemanager/dir.c
@@ -145,7 +145,7 @@ clean_sort_keys (dir_list * list, int start, int count)
  */
 
 static gboolean
-handle_dirent (struct dirent *dp, const char *fltr, struct stat *buf1, gboolean * link_to_dir,
+handle_dirent (struct vfs_dirent *dp, const char *fltr, struct stat *buf1, gboolean * link_to_dir,
                gboolean * stale_link)
 {
     vfs_path_t *vpath;
@@ -393,7 +393,7 @@ sort_time (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_mtime < b->st.st_mtime ? -1 : a->st.st_mtime > b->st.st_mtime;
+        int result = _GL_CMP (a->st.st_mtime, b->st.st_mtime);
 
         if (result != 0)
             return result * reverse;
@@ -414,7 +414,7 @@ sort_ctime (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_ctime < b->st.st_ctime ? -1 : a->st.st_ctime > b->st.st_ctime;
+        int result = _GL_CMP (a->st.st_ctime, b->st.st_ctime);
 
         if (result != 0)
             return result * reverse;
@@ -435,7 +435,7 @@ sort_atime (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_atime < b->st.st_atime ? -1 : a->st.st_atime > b->st.st_atime;
+        int result = _GL_CMP (a->st.st_atime, b->st.st_atime);
 
         if (result != 0)
             return result * reverse;
@@ -470,7 +470,7 @@ sort_size (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_size < b->st.st_size ? -1 : a->st.st_size > b->st.st_size;
+        int result = _GL_CMP (a->st.st_size, b->st.st_size);
 
         if (result != 0)
             return result * reverse;
@@ -624,7 +624,7 @@ dir_list_load (dir_list * list, const vfs_path_t * vpath, GCompareFunc sort,
                const dir_sort_options_t * sort_op, const char *fltr)
 {
     DIR *dirp;
-    struct dirent *dp;
+    struct vfs_dirent *dp;
     struct stat st;
     file_entry_t *fentry;
     const char *vpath_str;
@@ -697,7 +697,7 @@ dir_list_reload (dir_list * list, const vfs_path_t * vpath, GCompareFunc sort,
                  const dir_sort_options_t * sort_op, const char *fltr)
 {
     DIR *dirp;
-    struct dirent *dp;
+    struct vfs_dirent *dp;
     int i;
     struct stat st;
     int marked_cnt;
diff --git a/src/filemanager/ext.c b/src/filemanager/ext.c
index 8b00c0d9e..4e6f10c6c 100644
--- a/src/filemanager/ext.c
+++ b/src/filemanager/ext.c
@@ -62,7 +62,8 @@
 #include "src/selcodepage.h"    /* do_set_codepage */
 #endif
 
-#include "panel.h"              /* do_cd */
+#include "filemanager.h"        /* current_panel */
+#include "panel.h"              /* panel_cd */
 
 #include "ext.h"
 
@@ -71,9 +72,9 @@
 /*** file scope macro definitions ****************************************************************/
 
 #ifdef FILE_L
-#define FILE_CMD "file -L "
+#define FILE_CMD "file -L -z "
 #else
-#define FILE_CMD "file "
+#define FILE_CMD "file -z "
 #endif
 
 /*** file scope type declarations ****************************************************************/
@@ -175,7 +176,7 @@ exec_expand_format (char symbol, gboolean is_result_quoted)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static char *
+static GString *
 exec_get_export_variables (const vfs_path_t * filename_vpath)
 {
     char *text;
@@ -217,12 +218,13 @@ exec_get_export_variables (const vfs_path_t * filename_vpath)
             g_free (text);
         }
     }
-    return g_string_free (export_vars_string, FALSE);
+
+    return export_vars_string;
 }
 
 /* --------------------------------------------------------------------------------------------- */
 
-static char *
+static GString *
 exec_make_shell_string (const char *lc_data, const vfs_path_t * filename_vpath)
 {
     GString *shell_string;
@@ -345,7 +347,8 @@ exec_make_shell_string (const char *lc_data, const vfs_path_t * filename_vpath)
                 g_string_append_c (shell_string, *lc_data);
         }
     }                           /* for */
-    return g_string_free (shell_string, FALSE);
+
+    return shell_string;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -388,7 +391,7 @@ exec_extension_view (void *target, char *cmd, const vfs_path_t * filename_vpath,
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-exec_extension_cd (void)
+exec_extension_cd (WPanel * panel)
 {
     char *q;
     vfs_path_t *p_vpath;
@@ -403,7 +406,7 @@ exec_extension_cd (void)
     q[1] = 0;
 
     p_vpath = vfs_path_from_str_flags (pbuffer, VPF_NO_CANON);
-    do_cd (p_vpath, cd_parse_command);
+    panel_cd (panel, p_vpath, cd_parse_command);
     vfs_path_free (p_vpath);
 }
 
@@ -411,10 +414,10 @@ exec_extension_cd (void)
 /* --------------------------------------------------------------------------------------------- */
 
 static vfs_path_t *
-exec_extension (void *target, const vfs_path_t * filename_vpath, const char *lc_data,
-                int start_line)
+exec_extension (WPanel * panel, void *target, const vfs_path_t * filename_vpath,
+                const char *lc_data, int start_line)
 {
-    char *shell_string, *export_variables;
+    GString *shell_string, *export_variables;
     vfs_path_t *script_vpath = NULL;
     int cmd_file_fd;
     FILE *cmd_file;
@@ -433,14 +436,13 @@ exec_extension (void *target, const vfs_path_t * filename_vpath, const char *lc_
     do_local_copy = !vfs_file_is_local (filename_vpath);
 
     shell_string = exec_make_shell_string (lc_data, filename_vpath);
-
     if (shell_string == NULL)
         goto ret;
 
     if (is_cd)
     {
-        exec_extension_cd ();
-        g_free (shell_string);
+        exec_extension_cd (panel);
+        g_string_free (shell_string, TRUE);
         goto ret;
     }
 
@@ -465,12 +467,12 @@ exec_extension (void *target, const vfs_path_t * filename_vpath, const char *lc_
     export_variables = exec_get_export_variables (filename_vpath);
     if (export_variables != NULL)
     {
-        fprintf (cmd_file, "%s\n", export_variables);
-        g_free (export_variables);
+        fputs (export_variables->str, cmd_file);
+        g_string_free (export_variables, TRUE);
     }
 
-    fputs (shell_string, cmd_file);
-    g_free (shell_string);
+    fputs (shell_string->str, cmd_file);
+    g_string_free (shell_string, TRUE);
 
     /*
      * Make the script remove itself when it finishes.
@@ -1025,7 +1027,7 @@ regex_command_for (void *target, const vfs_path_t * filename_vpath, const char *
                         {
                             vfs_path_t *sv;
 
-                            sv = exec_extension (target, filename_vpath, r + 1,
+                            sv = exec_extension (current_panel, target, filename_vpath, r + 1,
                                                  view_at_line_number);
                             if (script_vpath != NULL)
                                 *script_vpath = sv;
diff --git a/src/filemanager/file.c b/src/filemanager/file.c
index 4c4b20c38..ce8c3f2ad 100644
--- a/src/filemanager/file.c
+++ b/src/filemanager/file.c
@@ -75,12 +75,12 @@
 #include "src/background.h"     /* do_background() */
 #endif
 
-/* Needed for current_panel, other_panel and WTree */
+/* Needed for other_panel and WTree */
 #include "dir.h"
 #include "filegui.h"
 #include "filenot.h"
 #include "tree.h"
-#include "midnight.h"           /* current_panel */
+#include "filemanager.h"        /* other_panel */
 #include "layout.h"             /* rotate_dash() */
 #include "ioblksize.h"          /* io_blksize() */
 
@@ -614,34 +614,19 @@ make_symlink (file_op_context_t * ctx, const char *src_path, const char *dst_pat
 static FileProgressStatus
 do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * dsm,
                      size_t * dir_count, size_t * ret_marked, uintmax_t * ret_total,
-                     gboolean compute_symlinks)
+                     mc_stat_fn stat_func)
 {
-    static guint64 timestamp = 0;
+    static gint64 timestamp = 0;
     /* update with 25 FPS rate */
-    static const guint64 delay = G_USEC_PER_SEC / 25;
+    static const gint64 delay = G_USEC_PER_SEC / 25;
 
     status_msg_t *sm = STATUS_MSG (dsm);
     int res;
     struct stat s;
     DIR *dir;
-    struct dirent *dirent;
+    struct vfs_dirent *dirent;
     FileProgressStatus ret = FILE_CONT;
 
-    if (!compute_symlinks)
-    {
-        res = mc_lstat (dirname_vpath, &s);
-        if (res != 0)
-            return ret;
-
-        /* don't scan symlink to directory */
-        if (S_ISLNK (s.st_mode))
-        {
-            (*ret_marked)++;
-            *ret_total += (uintmax_t) s.st_size;
-            return ret;
-        }
-    }
-
     (*dir_count)++;
 
     dir = mc_opendir (dirname_vpath);
@@ -657,13 +642,13 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
 
         tmp_vpath = vfs_path_append_new (dirname_vpath, dirent->d_name, (char *) NULL);
 
-        res = mc_lstat (tmp_vpath, &s);
+        res = stat_func (tmp_vpath, &s);
         if (res == 0)
         {
             if (S_ISDIR (s.st_mode))
                 ret =
                     do_compute_dir_size (tmp_vpath, dsm, dir_count, ret_marked, ret_total,
-                                         compute_symlinks);
+                                         stat_func);
             else
             {
                 ret = FILE_CONT;
@@ -700,27 +685,29 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
 
 static FileProgressStatus
 panel_compute_totals (const WPanel * panel, dirsize_status_msg_t * sm, size_t * ret_count,
-                      uintmax_t * ret_total, gboolean compute_symlinks)
+                      uintmax_t * ret_total, gboolean follow_symlinks)
 {
     int i;
     size_t dir_count = 0;
+    mc_stat_fn stat_func = follow_symlinks ? mc_stat : mc_lstat;
 
     for (i = 0; i < panel->dir.len; i++)
     {
-        struct stat *s;
+        const file_entry_t *fe = &panel->dir.list[i];
+        const struct stat *s;
 
-        if (!panel->dir.list[i].f.marked)
+        if (fe->f.marked == 0)
             continue;
 
-        s = &panel->dir.list[i].st;
+        s = &fe->st;
 
-        if (S_ISDIR (s->st_mode))
+        if (S_ISDIR (s->st_mode) || (follow_symlinks && link_isdir (fe) && fe->f.stale_link == 0))
         {
             vfs_path_t *p;
             FileProgressStatus status;
 
-            p = vfs_path_append_new (panel->cwd_vpath, panel->dir.list[i].fname, (char *) NULL);
-            status = compute_dir_size (p, sm, &dir_count, ret_count, ret_total, compute_symlinks);
+            p = vfs_path_append_new (panel->cwd_vpath, fe->fname, (char *) NULL);
+            status = do_compute_dir_size (p, sm, &dir_count, ret_count, ret_total, stat_func);
             vfs_path_free (p);
 
             if (status != FILE_CONT)
@@ -754,6 +741,7 @@ panel_operate_init_totals (const WPanel * panel, const vfs_path_t * source,
     if (verbose && compute_totals)
     {
         dirsize_status_msg_t dsm;
+        gboolean stale_link = FALSE;
 
         memset (&dsm, 0, sizeof (dsm));
         dsm.allow_skip = TRUE;
@@ -766,12 +754,15 @@ panel_operate_init_totals (const WPanel * panel, const vfs_path_t * source,
         if (source == NULL)
             status = panel_compute_totals (panel, &dsm, &ctx->progress_count, &ctx->progress_bytes,
                                            ctx->follow_links);
-        else if (S_ISDIR (source_stat->st_mode))
+        else if (S_ISDIR (source_stat->st_mode)
+                 || (ctx->follow_links
+                     && file_is_symlink_to_dir (source, (struct stat *) source_stat, &stale_link)
+                     && !stale_link))
         {
             size_t dir_count = 0;
 
-            status = compute_dir_size (source, &dsm, &dir_count, &ctx->progress_count,
-                                       &ctx->progress_bytes, ctx->follow_links);
+            status = do_compute_dir_size (source, &dsm, &dir_count, &ctx->progress_count,
+                                          &ctx->progress_bytes, ctx->stat_func);
         }
         else
         {
@@ -1412,7 +1403,7 @@ try_erase_dir (file_op_context_t * ctx, const char *dir)
 static FileProgressStatus
 recursive_erase (file_op_total_context_t * tctx, file_op_context_t * ctx, const vfs_path_t * vpath)
 {
-    struct dirent *next;
+    struct vfs_dirent *next;
     DIR *reading;
     const char *s;
     FileProgressStatus return_status = FILE_CONT;
@@ -1467,7 +1458,7 @@ static int
 check_dir_is_empty (const vfs_path_t * vpath)
 {
     DIR *dir;
-    struct dirent *d;
+    struct vfs_dirent *d;
     int i = 1;
 
     dir = mc_opendir (vpath);
@@ -2394,14 +2385,11 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
         goto ret_fast;
     }
 
-    if (ctx->do_reget != 0)
+    if (ctx->do_reget != 0 && mc_lseek (src_desc, ctx->do_reget, SEEK_SET) != ctx->do_reget)
     {
-        if (mc_lseek (src_desc, ctx->do_reget, SEEK_SET) != ctx->do_reget)
-        {
-            message (D_ERROR, _("Warning"), _("Reget failed, about to overwrite file"));
-            ctx->do_reget = 0;
-            ctx->do_append = FALSE;
-        }
+        message (D_ERROR, _("Warning"), _("Reget failed, about to overwrite file"));
+        ctx->do_reget = 0;
+        ctx->do_append = FALSE;
     }
 
     while (mc_fstat (src_desc, &src_stat) != 0)
@@ -2427,17 +2415,12 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
     file_size = src_stat.st_size;
 
     open_flags = O_WRONLY;
-    if (dst_exists)
-    {
-        if (ctx->do_append)
-            open_flags |= O_APPEND;
-        else
-            open_flags |= O_CREAT | O_TRUNC;
-    }
-    else
-    {
+    if (!dst_exists)
         open_flags |= O_CREAT | O_EXCL;
-    }
+    else if (ctx->do_append)
+        open_flags |= O_APPEND;
+    else
+        open_flags |= O_CREAT | O_TRUNC;
 
     while ((dest_desc = mc_open (dst_vpath, open_flags, src_mode)) < 0)
     {
@@ -2458,6 +2441,7 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
         }
         goto ret;
     }
+
     dst_status = DEST_SHORT;    /* file opened, but not fully copied */
 
     appending = ctx->do_append;
@@ -2550,6 +2534,7 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
         while (TRUE)
         {
             ssize_t n_read = -1, n_written;
+            gboolean force_update;
 
             /* src_read */
             if (mc_ctl (src_desc, VFS_CTL_IS_NOTREADY, 0) == 0)
@@ -2575,12 +2560,6 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
 
                 n_read_total += n_read;
 
-                /* Windows NT ftp servers report that files have no
-                 * permissions: -------, so if we happen to have actually
-                 * read something, we should fix the permissions.
-                 */
-                if ((src_mode & (S_IRWXU | S_IRWXG | S_IRWXO)) == 0)
-                    src_mode = S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH;
                 gettimeofday (&tv_last_input, NULL);
 
                 /* dst_write */
@@ -2632,28 +2611,23 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
                                                  tv_transfer_start, file_size, n_read_total);
                 tv_last_update = tv_current;
             }
+
             is_first_time = FALSE;
 
             if (update_secs > FILEOP_STALLING_INTERVAL)
-            {
                 stalled_msg = _("(stalled)");
-            }
-
-            {
-                gboolean force_update;
 
-                force_update =
-                    (tv_current.tv_sec - tctx->transfer_start.tv_sec) > FILEOP_UPDATE_INTERVAL;
+            force_update =
+                (tv_current.tv_sec - tctx->transfer_start.tv_sec) > FILEOP_UPDATE_INTERVAL;
 
-                if (verbose && ctx->dialog_type == FILEGUI_DIALOG_MULTI_ITEM)
-                {
-                    file_progress_show_count (ctx, tctx->progress_count, ctx->progress_count);
-                    file_progress_show_total (tctx, ctx, tctx->copied_bytes, force_update);
-                }
-
-                file_progress_show (ctx, n_read_total + ctx->do_reget, file_size, stalled_msg,
-                                    force_update);
+            if (verbose && ctx->dialog_type == FILEGUI_DIALOG_MULTI_ITEM)
+            {
+                file_progress_show_count (ctx, tctx->progress_count, ctx->progress_count);
+                file_progress_show_total (tctx, ctx, tctx->copied_bytes, force_update);
             }
+
+            file_progress_show (ctx, n_read_total + ctx->do_reget, file_size, stalled_msg,
+                                force_update);
             mc_refresh ();
 
             return_status = check_progress_buttons (ctx);
@@ -2702,56 +2676,51 @@ copy_file_file (file_op_total_context_t * tctx, file_op_context_t * ctx,
                           D_ERROR, 2, _("&Delete"), _("&Keep")) == 0)
             mc_unlink (dst_vpath);
     }
-    else if (dst_status == DEST_FULL)
+    else if (dst_status == DEST_FULL && !appending)
     {
         /* Copy has succeeded */
-        if (!appending && ctx->preserve_uidgid)
+
+        while (ctx->preserve_uidgid && mc_chown (dst_vpath, src_uid, src_gid) != 0
+               && !ctx->skip_all)
         {
-            while (mc_chown (dst_vpath, src_uid, src_gid) != 0 && !ctx->skip_all)
+            temp_status = file_error (TRUE, _("Cannot chown target file \"%s\"\n%s"), dst_path);
+            if (temp_status == FILE_RETRY)
+                continue;
+            if (temp_status == FILE_SKIPALL)
             {
-                temp_status = file_error (TRUE, _("Cannot chown target file \"%s\"\n%s"), dst_path);
-                if (temp_status == FILE_RETRY)
-                    continue;
-                if (temp_status == FILE_SKIPALL)
-                {
-                    ctx->skip_all = TRUE;
-                    return_status = FILE_CONT;
-                }
-                if (temp_status == FILE_SKIP)
-                    return_status = FILE_CONT;
-                break;
+                ctx->skip_all = TRUE;
+                return_status = FILE_CONT;
             }
+            if (temp_status == FILE_SKIP)
+                return_status = FILE_CONT;
+            break;
         }
 
-        if (!appending)
+        while (ctx->preserve && mc_chmod (dst_vpath, (src_mode & ctx->umask_kill)) != 0
+               && !ctx->skip_all)
         {
-            if (ctx->preserve)
-            {
-                while (mc_chmod (dst_vpath, (src_mode & ctx->umask_kill)) != 0 && !ctx->skip_all)
-                {
-                    temp_status =
-                        file_error (TRUE, _("Cannot chmod target file \"%s\"\n%s"), dst_path);
-                    if (temp_status == FILE_RETRY)
-                        continue;
-                    if (temp_status == FILE_SKIPALL)
-                    {
-                        ctx->skip_all = TRUE;
-                        return_status = FILE_CONT;
-                    }
-                    if (temp_status == FILE_SKIP)
-                        return_status = FILE_CONT;
-                    break;
-                }
-            }
-            else if (!dst_exists)
+            temp_status = file_error (TRUE, _("Cannot chmod target file \"%s\"\n%s"), dst_path);
+            if (temp_status == FILE_RETRY)
+                continue;
+            if (temp_status == FILE_SKIPALL)
             {
-                src_mode = umask (-1);
-                umask (src_mode);
-                src_mode = 0100666 & ~src_mode;
-                mc_chmod (dst_vpath, (src_mode & ctx->umask_kill));
+                ctx->skip_all = TRUE;
+                return_status = FILE_CONT;
             }
-            mc_utime (dst_vpath, &times);
+            if (temp_status == FILE_SKIP)
+                return_status = FILE_CONT;
+            break;
+        }
+
+        if (!ctx->preserve && !dst_exists)
+        {
+            src_mode = umask (-1);
+            umask (src_mode);
+            src_mode = 0100666 & ~src_mode;
+            mc_chmod (dst_vpath, (src_mode & ctx->umask_kill));
         }
+
+        mc_utime (dst_vpath, &times);
     }
 
     if (return_status == FILE_CONT)
@@ -2775,7 +2744,7 @@ FileProgressStatus
 copy_dir_dir (file_op_total_context_t * tctx, file_op_context_t * ctx, const char *s, const char *d,
               gboolean toplevel, gboolean move_over, gboolean do_delete, GSList * parent_dirs)
 {
-    struct dirent *next;
+    struct vfs_dirent *next;
     struct stat dst_stat, src_stat;
     DIR *reading;
     FileProgressStatus return_status = FILE_CONT;
@@ -3183,7 +3152,7 @@ dirsize_status_deinit_cb (status_msg_t * sm)
 
     /* schedule to update passive panel */
     if (get_other_type () == view_listing)
-        other_panel->dirty = 1;
+        other_panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -3196,10 +3165,10 @@ dirsize_status_deinit_cb (status_msg_t * sm)
 FileProgressStatus
 compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * sm,
                   size_t * ret_dir_count, size_t * ret_marked_count, uintmax_t * ret_total,
-                  gboolean compute_symlinks)
+                  gboolean follow_symlinks)
 {
     return do_compute_dir_size (dirname_vpath, sm, ret_dir_count, ret_marked_count, ret_total,
-                                compute_symlinks);
+                                follow_symlinks ? mc_stat : mc_lstat);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/file.h b/src/filemanager/file.h
index f54f5415c..ae12e1572 100644
--- a/src/filemanager/file.h
+++ b/src/filemanager/file.h
@@ -62,7 +62,7 @@ FileProgressStatus file_error (gboolean allow_retry, const char *format, const c
 /* return value is FILE_CONT or FILE_ABORT */
 FileProgressStatus compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * sm,
                                      size_t * ret_dir_count, size_t * ret_marked_count,
-                                     uintmax_t * ret_total, gboolean compute_symlinks);
+                                     uintmax_t * ret_total, gboolean follow_symlinks);
 
 void dirsize_status_init_cb (status_msg_t * sm);
 int dirsize_status_update_cb (status_msg_t * sm);
diff --git a/src/filemanager/filegui.c b/src/filemanager/filegui.c
index c43a2ae99..cd9845361 100644
--- a/src/filemanager/filegui.c
+++ b/src/filemanager/filegui.c
@@ -155,7 +155,7 @@ statfs (char const *filename, struct fs_info *buf)
 
 #include "src/setup.h"          /* verbose, safe_overwrite */
 
-#include "midnight.h"
+#include "filemanager.h"
 #include "fileopctx.h"          /* FILE_CONT */
 
 #include "filegui.h"
@@ -1158,9 +1158,9 @@ file_progress_show_target (file_op_context_t * ctx, const vfs_path_t * vpath)
 gboolean
 file_progress_show_deleting (file_op_context_t * ctx, const char *s, size_t * count)
 {
-    static guint64 timestamp = 0;
+    static gint64 timestamp = 0;
     /* update with 25 FPS rate */
-    static const guint64 delay = G_USEC_PER_SEC / 25;
+    static const gint64 delay = G_USEC_PER_SEC / 25;
 
     gboolean ret;
 
diff --git a/src/filemanager/midnight.c b/src/filemanager/filemanager.c
similarity index 96%
rename from src/filemanager/midnight.c
rename to src/filemanager/filemanager.c
index 9d68c0206..9ae295989 100644
--- a/src/filemanager/midnight.c
+++ b/src/filemanager/filemanager.c
@@ -8,7 +8,7 @@
    Miguel de Icaza, 1994, 1995, 1996, 1997
    Janne Kukonlehto, 1994, 1995
    Norbert Warmuth, 1997
-   Andrew Borodin <aborodin@vmail.ru>, 2009, 2010, 2012, 2013
+   Andrew Borodin <aborodin@vmail.ru>, 2009, 2010, 2012, 2013, 2020
    Slava Zanko <slavazanko@gmail.com>, 2013
 
    This file is part of the Midnight Commander.
@@ -27,7 +27,7 @@
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-/** \file main.c
+/** \file filemanager.c
  *  \brief Source: main dialog (file panels) of the Midnight Commander
  */
 
@@ -75,13 +75,6 @@
 #include "command.h"            /* cmdline */
 #include "dir.h"                /* dir_list_clean() */
 
-#include "chmod.h"
-#include "chown.h"
-#include "achown.h"
-#ifdef ENABLE_EXT2FS_ATTR
-#include "chattr.h"
-#endif
-
 #ifdef USE_INTERNAL_EDIT
 #include "src/editor/edit.h"
 #endif
@@ -93,7 +86,7 @@
 #include "src/consaver/cons.saver.h"    /* show_console_contents */
 #include "src/file_history.h"   /* show_file_history() */
 
-#include "midnight.h"
+#include "filemanager.h"
 
 /*** global variables ****************************************************************************/
 
@@ -161,7 +154,7 @@ treebox_cmd (void)
         vfs_path_t *sel_vdir;
 
         sel_vdir = vfs_path_from_str (sel_dir);
-        do_cd (sel_vdir, cd_exact);
+        panel_cd (current_panel, sel_vdir, cd_exact);
         vfs_path_free (sel_vdir);
         g_free (sel_dir);
     }
@@ -390,7 +383,7 @@ menu_cmd (void)
 {
     int selected;
 
-    if ((get_current_index () == 0) == (current_panel->active != 0))
+    if ((get_current_index () == 0) == current_panel->active)
         selected = 0;
     else
         selected = g_list_length (the_menubar->menu) - 1;
@@ -422,7 +415,7 @@ midnight_get_shortcut (long command)
     const char *ext_map;
     const char *shortcut = NULL;
 
-    shortcut = keybind_lookup_keymap_shortcut (main_map, command);
+    shortcut = keybind_lookup_keymap_shortcut (filemanager_map, command);
     if (shortcut != NULL)
         return g_strdup (shortcut);
 
@@ -430,9 +423,9 @@ midnight_get_shortcut (long command)
     if (shortcut != NULL)
         return g_strdup (shortcut);
 
-    ext_map = keybind_lookup_keymap_shortcut (main_map, CK_ExtendedKeyMap);
+    ext_map = keybind_lookup_keymap_shortcut (filemanager_map, CK_ExtendedKeyMap);
     if (ext_map != NULL)
-        shortcut = keybind_lookup_keymap_shortcut (main_x_map, command);
+        shortcut = keybind_lookup_keymap_shortcut (filemanager_x_map, command);
     if (shortcut != NULL)
         return g_strdup_printf ("%s %s", ext_map, shortcut);
 
@@ -916,8 +909,8 @@ create_file_manager (void)
     Widget *w = WIDGET (midnight_dlg);
     WGroup *g = GROUP (midnight_dlg);
 
-    w->keymap = main_map;
-    w->ext_keymap = main_x_map;
+    w->keymap = filemanager_map;
+    w->ext_keymap = filemanager_x_map;
 
     midnight_dlg->get_shortcut = midnight_get_shortcut;
     midnight_dlg->get_title = midnight_get_title;
@@ -1029,7 +1022,7 @@ show_editor_viewer_history (void)
 
         case CK_View:
             s_vpath = vfs_path_from_str (s);
-            view_file (s_vpath, use_internal_view, 0);
+            view_file (s_vpath, use_internal_view, FALSE);
             break;
 
         default:
@@ -1038,7 +1031,7 @@ show_editor_viewer_history (void)
 
                 d = g_path_get_dirname (s);
                 s_vpath = vfs_path_from_str (d);
-                do_cd (s_vpath, cd_exact);
+                panel_cd (current_panel, s_vpath, cd_exact);
                 try_to_select (current_panel, s);
                 g_free (d);
             }
@@ -1104,7 +1097,7 @@ quit_cmd (void)
 
 /**
  * Repaint the contents of the panels without frames.  To schedule panel
- * for repainting, set panel->dirty to 1.  There are many reasons why
+ * for repainting, set panel->dirty to TRUE.  There are many reasons why
  * the panels need to be repainted, and this is a costly operation, so
  * it's done once per event.
  */
@@ -1145,26 +1138,26 @@ midnight_execute_cmd (Widget * sender, long command)
     switch (command)
     {
     case CK_ChangePanel:
-        change_panel ();
+        (void) change_panel ();
         break;
     case CK_HotListAdd:
-        add2hotlist_cmd ();
+        add2hotlist_cmd (current_panel);
         break;
     case CK_SetupListingFormat:
         setup_listing_format_cmd ();
         break;
     case CK_ChangeMode:
-        chmod_cmd ();
+        chmod_cmd (current_panel);
         break;
     case CK_ChangeOwn:
-        chown_cmd ();
+        chown_cmd (current_panel);
         break;
     case CK_ChangeOwnAdvanced:
-        advanced_chown_cmd ();
+        advanced_chown_cmd (current_panel);
         break;
 #ifdef ENABLE_EXT2FS_ATTR
     case CK_ChangeAttributes:
-        chattr_cmd ();
+        chattr_cmd (current_panel);
         break;
 #endif
     case CK_CompareDirs:
@@ -1182,7 +1175,7 @@ midnight_execute_cmd (Widget * sender, long command)
         confirm_box ();
         break;
     case CK_Copy:
-        copy_cmd ();
+        copy_cmd (current_panel);
         break;
     case CK_PutCurrentPath:
         midnight_put_panel_path (current_panel);
@@ -1211,7 +1204,7 @@ midnight_execute_cmd (Widget * sender, long command)
         put_other_tagged ();
         break;
     case CK_Delete:
-        delete_cmd ();
+        delete_cmd (current_panel);
         break;
     case CK_ScreenList:
         dialog_switch_list ();
@@ -1225,11 +1218,11 @@ midnight_execute_cmd (Widget * sender, long command)
         display_bits_box ();
         break;
     case CK_Edit:
-        edit_cmd ();
+        edit_cmd (current_panel);
         break;
 #ifdef USE_INTERNAL_EDIT
     case CK_EditForceInternal:
-        edit_cmd_force_internal ();
+        edit_cmd_force_internal (current_panel);
         break;
 #endif
     case CK_EditExtensionsFile:
@@ -1251,10 +1244,10 @@ midnight_execute_cmd (Widget * sender, long command)
         filter_cmd ();
         break;
     case CK_ViewFiltered:
-        view_filtered_cmd ();
+        view_filtered_cmd (current_panel);
         break;
     case CK_Find:
-        find_cmd ();
+        find_cmd (current_panel);
         break;
 #ifdef ENABLE_VFS_FISH
     case CK_ConnectFish:
@@ -1324,7 +1317,7 @@ midnight_execute_cmd (Widget * sender, long command)
         menu_last_selected_cmd ();
         break;
     case CK_MakeDir:
-        mkdir_cmd ();
+        mkdir_cmd (current_panel);
         break;
     case CK_OptionsPanel:
         panel_options_box ();
@@ -1335,7 +1328,7 @@ midnight_execute_cmd (Widget * sender, long command)
         break;
 #endif
     case CK_CdQuick:
-        quick_cd_cmd ();
+        quick_cd_cmd (current_panel);
         break;
     case CK_HotList:
         hotlist_cmd ();
@@ -1356,7 +1349,7 @@ midnight_execute_cmd (Widget * sender, long command)
         link_cmd (LINK_SYMLINK_RELATIVE);
         break;
     case CK_Move:
-        rename_cmd ();
+        rename_cmd (current_panel);
         break;
     case CK_Reread:
         reread_cmd ();
@@ -1378,7 +1371,7 @@ midnight_execute_cmd (Widget * sender, long command)
         toggle_subshell ();
         break;
     case CK_DirSize:
-        smart_dirsize_cmd ();
+        smart_dirsize_cmd (current_panel);
         break;
     case CK_Sort:
         sort_cmd ();
@@ -1425,10 +1418,10 @@ midnight_execute_cmd (Widget * sender, long command)
         user_file_menu_cmd ();
         break;
     case CK_View:
-        view_cmd ();
+        view_cmd (current_panel);
         break;
     case CK_ViewFile:
-        view_file_cmd ();
+        view_file_cmd (current_panel);
         break;
     case CK_EditorViewerHistory:
         show_editor_viewer_history ();
@@ -1460,7 +1453,7 @@ is_cmdline_mute (void)
        it's activity. Thus, we can't use get_current_type() here.
        current_panel should point to actualy current active panel
        independently of it's type. */
-    return (current_panel->active == 0
+    return (!current_panel->active
             && (get_other_type () == view_quick || get_other_type () == view_tree));
 }
 
@@ -1558,7 +1551,7 @@ midnight_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
 
         if ((!mc_global.tty.alternate_plus_minus
              || !(mc_global.tty.console_flag != '\0' || mc_global.tty.xterm_flag)) && !quote
-            && !current_panel->searching)
+            && !current_panel->quick_search.active)
         {
             if (!only_leading_plus_minus)
             {
@@ -1594,9 +1587,9 @@ midnight_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
         return MSG_NOT_HANDLED;
 
     case MSG_HOTKEY_HANDLED:
-        if ((get_current_type () == view_listing) && current_panel->searching)
+        if ((get_current_type () == view_listing) && current_panel->quick_search.active)
         {
-            current_panel->dirty = 1;   /* FIXME: unneeded? */
+            current_panel->dirty = TRUE;        /* FIXME: unneeded? */
             send_message (current_panel, NULL, MSG_ACTION, CK_SearchStop, NULL);
         }
         return MSG_HANDLED;
@@ -1673,8 +1666,8 @@ midnight_set_buttonbar (WButtonBar * b)
 char *
 get_random_hint (gboolean force)
 {
-    static const guint64 update_period = 60 * G_USEC_PER_SEC;
-    static guint64 tv = 0;
+    static const gint64 update_period = 60 * G_USEC_PER_SEC;
+    static gint64 tv = 0;
 
     char *data, *result = NULL, *eop;
     size_t len, start;
@@ -1772,12 +1765,18 @@ load_hint (gboolean force)
 }
 
 /* --------------------------------------------------------------------------------------------- */
+/**
+  * Change current panel in the file manager.
+  *
+  * @return current_panel
+  */
 
-void
+WPanel *
 change_panel (void)
 {
     input_complete_free (cmdline);
     group_select_next_widget (GROUP (midnight_dlg));
+    return current_panel;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1863,7 +1862,7 @@ do_nc (void)
 #endif
 
     if ((quit & SUBSHELL_EXIT) == 0)
-        clr_scr ();
+        tty_clear_screen ();
 
     return ret;
 }
diff --git a/src/filemanager/midnight.h b/src/filemanager/filemanager.h
similarity index 87%
rename from src/filemanager/midnight.h
rename to src/filemanager/filemanager.h
index 01f640f65..ca607ce8d 100644
--- a/src/filemanager/midnight.h
+++ b/src/filemanager/filemanager.h
@@ -1,9 +1,9 @@
-/** \file midnight.h
- *  \brief Header: main dialog (file panel) for Midnight Commander
+/** \file filemanager.h
+ *  \brief Header: main dialog (file panels) for Midnight Commander
  */
 
-#ifndef MC__MIDNIGHT_H
-#define MC__MIDNIGHT_H
+#ifndef MC__FILEMANAGER_H
+#define MC__FILEMANAGER_H
 
 #include "lib/widget.h"
 
@@ -43,11 +43,11 @@ void update_menu (void);
 void midnight_set_buttonbar (WButtonBar * b);
 char *get_random_hint (gboolean force);
 void load_hint (gboolean force);
-void change_panel (void);
+WPanel *change_panel (void);
 void save_cwds_stat (void);
 gboolean quiet_quit_cmd (void);
 gboolean do_nc (void);
 
 /*** inline functions ****************************************************************************/
 
-#endif /* MC__MIDNIGHT_H */
+#endif /* MC__FILEMANAGER_H */
diff --git a/src/filemanager/find.c b/src/filemanager/find.c
index 490d8d2e2..1950cb2d5 100644
--- a/src/filemanager/find.c
+++ b/src/filemanager/find.c
@@ -36,7 +36,6 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/stat.h>
-#include <sys/time.h>
 
 #include "lib/global.h"
 
@@ -55,7 +54,6 @@
 
 #include "dir.h"
 #include "cmd.h"                /* find_cmd(), view_file_at_line() */
-#include "midnight.h"           /* current_panel */
 #include "boxes.h"
 #include "panelize.h"
 
@@ -155,7 +153,7 @@ static unsigned long matches;   /* Number of matches */
 static gboolean is_start = FALSE;       /* Status of the start/stop toggle button */
 static char *old_dir = NULL;
 
-static struct timeval last_refresh;
+static gint64 last_refresh;
 
 /* Where did we stop */
 static gboolean resuming;
@@ -558,7 +556,7 @@ find_parm_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, voi
  */
 
 static gboolean
-find_parameters (char **start_dir, ssize_t * start_dir_len,
+find_parameters (WPanel * panel, char **start_dir, ssize_t * start_dir_len,
                  char **ignore_dirs, char **pattern, char **content)
 {
     WGroup *g;
@@ -776,7 +774,7 @@ find_parameters (char **start_dir, ssize_t * start_dir_len,
 
             temp_dir = in_start->buffer;
             if (*temp_dir == '\0' || DIR_IS_DOT (temp_dir))
-                temp_dir = g_strdup (vfs_path_as_str (current_panel->cwd_vpath));
+                temp_dir = g_strdup (vfs_path_as_str (panel->cwd_vpath));
             else
                 temp_dir = g_strdup (temp_dir);
 
@@ -829,8 +827,8 @@ find_parameters (char **start_dir, ssize_t * start_dir_len,
 
             if (DIR_IS_DOT (s))
             {
-                *start_dir = g_strdup (vfs_path_as_str (current_panel->cwd_vpath));
-                /* FIXME: is current_panel->cwd_vpath canonicalized? */
+                *start_dir = g_strdup (vfs_path_as_str (panel->cwd_vpath));
+                /* FIXME: is panel->cwd_vpath canonicalized? */
                 /* relative paths will be used in panelization */
                 *start_dir_len = (ssize_t) strlen (*start_dir);
                 g_free (s);
@@ -844,9 +842,8 @@ find_parameters (char **start_dir, ssize_t * start_dir_len,
             {
                 /* relative paths will be used in panelization */
                 *start_dir =
-                    mc_build_filename (vfs_path_as_str (current_panel->cwd_vpath), s,
-                                       (char *) NULL);
-                *start_dir_len = (ssize_t) strlen (vfs_path_as_str (current_panel->cwd_vpath));
+                    mc_build_filename (vfs_path_as_str (panel->cwd_vpath), s, (char *) NULL);
+                *start_dir_len = (ssize_t) strlen (vfs_path_as_str (panel->cwd_vpath));
                 g_free (s);
             }
 
@@ -988,13 +985,11 @@ static gboolean
 search_content (WDialog * h, const char *directory, const char *filename)
 {
     struct stat s;
-    char buffer[BUF_4K];        /* raw input buffer */
+    char buffer[BUF_4K] = "";   /* raw input buffer */
     int file_fd;
     gboolean ret_val = FALSE;
     vfs_path_t *vpath;
-    struct timeval tv;
-    time_t seconds;
-    suseconds_t useconds;
+    gint64 tv;
     gboolean status_updated = FALSE;
 
     vpath = vfs_path_build_filename (directory, filename, (char *) NULL);
@@ -1012,21 +1007,9 @@ search_content (WDialog * h, const char *directory, const char *filename)
         return FALSE;
 
     /* get time elapsed from last refresh */
-    if (gettimeofday (&tv, NULL) == -1)
-    {
-        tv.tv_sec = 0;
-        tv.tv_usec = 0;
-        last_refresh = tv;
-    }
-    seconds = tv.tv_sec - last_refresh.tv_sec;
-    useconds = tv.tv_usec - last_refresh.tv_usec;
-    if (useconds < 0)
-    {
-        seconds--;
-        useconds += G_USEC_PER_SEC;
-    }
+    tv = g_get_real_time ();
 
-    if (s.st_size >= MIN_REFRESH_FILE_SIZE || seconds > 0 || useconds > MAX_REFRESH_INTERVAL)
+    if (s.st_size >= MIN_REFRESH_FILE_SIZE || (tv - last_refresh) > MAX_REFRESH_INTERVAL)
     {
         g_snprintf (buffer, sizeof (buffer), _("Grepping in %s"), filename);
         status_update (str_trunc (buffer, WIDGET (h)->cols - 8));
@@ -1262,7 +1245,7 @@ find_rotate_dash (const WDialog * h, gboolean show)
 static int
 do_search (WDialog * h)
 {
-    static struct dirent *dp = NULL;
+    static struct vfs_dirent *dp = NULL;
     static DIR *dirp = NULL;
     static char *directory = NULL;
     struct stat tmp_stat;
@@ -1764,7 +1747,7 @@ kill_gui (void)
 /* --------------------------------------------------------------------------------------------- */
 
 static int
-do_find (const char *start_dir, ssize_t start_dir_len, const char *ignore_dirs,
+do_find (WPanel * panel, const char *start_dir, ssize_t start_dir_len, const char *ignore_dirs,
          char **dirname, char **filename)
 {
     int return_value = 0;
@@ -1793,10 +1776,10 @@ do_find (const char *start_dir, ssize_t start_dir_len, const char *ignore_dirs,
         int i;
         struct stat st;
         GList *entry;
-        dir_list *list = &current_panel->dir;
+        dir_list *list = &panel->dir;
         char *name = NULL;
 
-        panel_clean_dir (current_panel);
+        panel_clean_dir (panel);
         dir_list_init (list);
 
         for (i = 0, entry = listbox_get_first_link (find_list); entry != NULL;
@@ -1862,9 +1845,9 @@ do_find (const char *start_dir, ssize_t start_dir_len, const char *ignore_dirs,
                 rotate_dash (TRUE);
         }
 
-        current_panel->is_panelized = TRUE;
-        panelize_absolutize_if_needed (current_panel);
-        panelize_save_panel (current_panel);
+        panel->is_panelized = TRUE;
+        panelize_absolutize_if_needed (panel);
+        panelize_save_panel (panel);
     }
 
     kill_gui ();
@@ -1880,7 +1863,7 @@ do_find (const char *start_dir, ssize_t start_dir_len, const char *ignore_dirs,
 /* --------------------------------------------------------------------------------------------- */
 
 void
-find_cmd (void)
+find_cmd (WPanel * panel)
 {
     char *start_dir = NULL, *ignore_dirs = NULL;
     ssize_t start_dir_len;
@@ -1888,7 +1871,7 @@ find_cmd (void)
     find_pattern = NULL;
     content_pattern = NULL;
 
-    while (find_parameters (&start_dir, &start_dir_len,
+    while (find_parameters (panel, &start_dir, &start_dir_len,
                             &ignore_dirs, &find_pattern, &content_pattern))
     {
         char *filename = NULL, *dirname = NULL;
@@ -1898,15 +1881,14 @@ find_cmd (void)
 
         if (find_pattern[0] != '\0')
         {
-            last_refresh.tv_sec = 0;
-            last_refresh.tv_usec = 0;
+            last_refresh = 0;
 
             is_start = FALSE;
 
             if (!content_is_empty && !str_is_valid_string (content_pattern))
                 MC_PTR_FREE (content_pattern);
 
-            v = do_find (start_dir, start_dir_len, ignore_dirs, &dirname, &filename);
+            v = do_find (panel, start_dir, start_dir_len, ignore_dirs, &dirname, &filename);
         }
 
         g_free (start_dir);
@@ -1920,10 +1902,10 @@ find_cmd (void)
                 vfs_path_t *dirname_vpath;
 
                 dirname_vpath = vfs_path_from_str (dirname);
-                do_cd (dirname_vpath, cd_exact);
+                panel_cd (panel, dirname_vpath, cd_exact);
                 vfs_path_free (dirname_vpath);
                 if (filename != NULL)
-                    try_to_select (current_panel,
+                    try_to_select (panel,
                                    filename + (content_pattern != NULL
                                                ? strchr (filename + 4, ':') - filename + 1 : 4));
             }
@@ -1932,7 +1914,7 @@ find_cmd (void)
                 vfs_path_t *filename_vpath;
 
                 filename_vpath = vfs_path_from_str (filename);
-                do_cd (filename_vpath, cd_exact);
+                panel_cd (panel, filename_vpath, cd_exact);
                 vfs_path_free (filename_vpath);
             }
         }
@@ -1946,8 +1928,8 @@ find_cmd (void)
 
         if (v == B_PANELIZE)
         {
-            panel_re_sort (current_panel);
-            try_to_select (current_panel, NULL);
+            panel_re_sort (panel);
+            try_to_select (panel, NULL);
             break;
         }
     }
diff --git a/src/filemanager/hotlist.c b/src/filemanager/hotlist.c
index 90df75bf6..4d63baed6 100644
--- a/src/filemanager/hotlist.c
+++ b/src/filemanager/hotlist.c
@@ -59,7 +59,6 @@
 #include "src/setup.h"          /* For profile_bname */
 #include "src/history.h"
 
-#include "midnight.h"           /* current_panel */
 #include "command.h"            /* cmdline */
 
 #include "hotlist.h"
@@ -151,6 +150,8 @@ struct hotlist
 
 /*** file scope variables ************************************************************************/
 
+static WPanel *our_panel;
+
 static gboolean hotlist_has_dot_dot = TRUE;
 
 static WDialog *hotlist_dlg, *movelist_dlg;
@@ -216,7 +217,7 @@ static int list_level = 0;
 
 static void init_movelist (struct hotlist *item);
 static void add_new_group_cmd (void);
-static void add_new_entry_cmd (void);
+static void add_new_entry_cmd (WPanel * panel);
 static void remove_from_hotlist (struct hotlist *entry);
 static void load_hotlist (void);
 static void add_dotdot_to_list (void);
@@ -287,6 +288,7 @@ fill_listbox (WListbox * list)
         case HL_TYPE_DOTDOT:
         case HL_TYPE_ENTRY:
             listbox_add_item (list, LISTBOX_APPEND_AT_END, 0, current->label, current, FALSE);
+            break;
         default:
             break;
         }
@@ -413,11 +415,11 @@ hotlist_run_cmd (int action)
         return 0;
 
     case B_ADD_CURRENT:
-        add2hotlist_cmd ();
+        add2hotlist_cmd (our_panel);
         return 0;
 
     case B_NEW_ENTRY:
-        add_new_entry_cmd ();
+        add_new_entry_cmd (our_panel);
         return 0;
 
     case B_ENTER:
@@ -444,7 +446,6 @@ hotlist_run_cmd (int action)
                 fill_listbox (list);
                 return 0;
             }
-            MC_FALLTHROUGH;     /* go up */
         }
         MC_FALLTHROUGH;         /* if list empty - just go up */
 
@@ -1032,13 +1033,13 @@ add_new_entry_input (const char *header, const char *text1, const char *text2,
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-add_new_entry_cmd (void)
+add_new_entry_cmd (WPanel * panel)
 {
     char *title, *url, *to_free;
     int ret;
 
     /* Take current directory as default value for input fields */
-    to_free = title = url = vfs_path_to_str_flags (current_panel->cwd_vpath, 0, VPF_STRIP_PASSWORD);
+    to_free = title = url = vfs_path_to_str_flags (panel->cwd_vpath, 0, VPF_STRIP_PASSWORD);
 
     ret = add_new_entry_input (_("New hotlist entry"), _("Directory label:"),
                                _("Directory path:"), "[Hotlist]", &title, &url);
@@ -1594,7 +1595,7 @@ add_dotdot_to_list (void)
 /* --------------------------------------------------------------------------------------------- */
 
 void
-add2hotlist_cmd (void)
+add2hotlist_cmd (WPanel * panel)
 {
     char *lc_prompt;
     const char *cp = N_("Label for \"%s\":");
@@ -1605,8 +1606,11 @@ add2hotlist_cmd (void)
     cp = _(cp);
 #endif
 
+    /* extra variable to use it in the button callback */
+    our_panel = panel;
+
     l = str_term_width1 (cp);
-    label_string = vfs_path_to_str_flags (current_panel->cwd_vpath, 0, VPF_STRIP_PASSWORD);
+    label_string = vfs_path_to_str_flags (panel->cwd_vpath, 0, VPF_STRIP_PASSWORD);
     lc_prompt = g_strdup_printf (cp, str_trunc (label_string, COLS - 2 * UX - (l + 8)));
     label =
         input_dialog (_("Add to hotlist"), lc_prompt, MC_HISTORY_HOTLIST_ADD, label_string,
diff --git a/src/filemanager/hotlist.h b/src/filemanager/hotlist.h
index 95ae541af..3781b91b9 100644
--- a/src/filemanager/hotlist.h
+++ b/src/filemanager/hotlist.h
@@ -7,6 +7,8 @@
 
 /*** typedefs(not structures) and defined constants **********************************************/
 
+#include "panel.h"
+
 /*** enums ***************************************************************************************/
 
 typedef enum
@@ -22,7 +24,7 @@ typedef enum
 
 /*** declarations of public functions ************************************************************/
 
-void add2hotlist_cmd (void);
+void add2hotlist_cmd (WPanel * panel);
 char *hotlist_show (hotlist_t list_type);
 gboolean save_hotlist (void);
 void done_hotlist (void);
diff --git a/src/filemanager/info.c b/src/filemanager/info.c
index be1c66817..fb0b6b759 100644
--- a/src/filemanager/info.c
+++ b/src/filemanager/info.c
@@ -50,11 +50,11 @@
 
 #include "src/setup.h"          /* panels_options */
 
-#include "midnight.h"           /* the_menubar */
+#include "filemanager.h"        /* the_menubar */
 #include "layout.h"
 #include "mountlist.h"
 #ifdef ENABLE_EXT2FS_ATTR
-#include "chattr.h"
+#include "cmd.h"                /* chattr_get_as_str() */
 #endif
 
 #include "info.h"
diff --git a/src/filemanager/layout.c b/src/filemanager/layout.c
index dfffa96f5..d7e9c20c9 100644
--- a/src/filemanager/layout.c
+++ b/src/filemanager/layout.c
@@ -60,7 +60,7 @@
 #endif
 
 #include "command.h"
-#include "midnight.h"
+#include "filemanager.h"
 #include "tree.h"
 /* Needed for the extern declarations of integer parameters */
 #include "dir.h"
@@ -1027,9 +1027,9 @@ set_hintbar (const char *str)
 void
 rotate_dash (gboolean show)
 {
-    static guint64 timestamp = 0;
+    static gint64 timestamp = 0;
     /* update with 10 FPS rate */
-    static const guint64 delay = G_USEC_PER_SEC / 10;
+    static const gint64 delay = G_USEC_PER_SEC / 10;
 
     const Widget *w = CONST_WIDGET (midnight_dlg);
 
@@ -1193,7 +1193,7 @@ create_panel (int num, panel_view_mode_t type)
 
     /* We use replace to keep the circular list of the dialog in the */
     /* same state.  Maybe we could just kill it and then replace it  */
-    if ((midnight_dlg != NULL) && (old_widget != NULL))
+    if (old_widget != NULL)
     {
         if (old_type == view_listing)
         {
@@ -1277,8 +1277,8 @@ swap_panels (void)
         panelswap (dir_stat);
 #undef panelswap
 
-        panel1->searching = FALSE;
-        panel2->searching = FALSE;
+        panel1->quick_search.active = FALSE;
+        panel2->quick_search.active = FALSE;
 
         if (current_panel == panel1)
             current_panel = panel2;
@@ -1309,18 +1309,18 @@ swap_panels (void)
 
         if (panels[0].type == view_listing)
         {
-            if (strcmp (panel1->panel_name, get_nth_panel_name (0)) == 0)
+            if (strcmp (panel1->name, get_nth_panel_name (0)) == 0)
             {
-                g_free (panel1->panel_name);
-                panel1->panel_name = g_strdup (get_nth_panel_name (1));
+                g_free (panel1->name);
+                panel1->name = g_strdup (get_nth_panel_name (1));
             }
         }
         if (panels[1].type == view_listing)
         {
-            if (strcmp (panel2->panel_name, get_nth_panel_name (1)) == 0)
+            if (strcmp (panel2->name, get_nth_panel_name (1)) == 0)
             {
-                g_free (panel2->panel_name);
-                panel2->panel_name = g_strdup (get_nth_panel_name (0));
+                g_free (panel2->name);
+                panel2->name = g_strdup (get_nth_panel_name (0));
             }
         }
 
@@ -1498,7 +1498,11 @@ load_prompt (int fd, void *unused)
     (void) fd;
     (void) unused;
 
-    do_load_prompt ();
+    if (should_read_new_subshell_prompt)
+        do_load_prompt ();
+    else
+        flush_subshell (0, QUIETLY);
+
     return 0;
 }
 #endif /* ENABLE_SUBSHELL */
diff --git a/src/filemanager/mountlist.c b/src/filemanager/mountlist.c
index ae83b329f..0c4722f53 100644
--- a/src/filemanager/mountlist.c
+++ b/src/filemanager/mountlist.c
@@ -257,8 +257,9 @@ me_remote (char const *fs_name, char const *fs_type)
 #ifndef ME_REMOTE
 /* A file system is 'remote' if its Fs_name contains a ':'
    or if (it is of type (smbfs or smb3 or cifs) and its Fs_name starts with '//')
-   or if it is of type (afs or auristorfs)
-   or Fs_name is equal to "-hosts" (used by autofs to mount remote fs).  */
+   or if it is of any other of the listed types
+   or Fs_name is equal to "-hosts" (used by autofs to mount remote fs).
+   "VM" file systems like prl_fs or vboxsf are not considered remote here. */
 #define ME_REMOTE(Fs_name, Fs_type) \
     (strchr (Fs_name, ':') != NULL \
      || ((Fs_name)[0] == '/' \
@@ -266,8 +267,15 @@ me_remote (char const *fs_name, char const *fs_type)
          && (strcmp (Fs_type, "smbfs") == 0 \
              || strcmp (Fs_type, "smb3") == 0 \
              || strcmp (Fs_type, "cifs") == 0)) \
+     || strcmp (Fs_type, "acfs") == 0 \
      || strcmp (Fs_type, "afs") == 0 \
+     || strcmp (Fs_type, "coda") == 0 \
      || strcmp (Fs_type, "auristorfs") == 0 \
+     || strcmp (Fs_type, "fhgfs") == 0 \
+     || strcmp (Fs_type, "gpfs") == 0 \
+     || strcmp (Fs_type, "ibrix") == 0 \
+     || strcmp (Fs_type, "ocfs2") == 0 \
+     || strcmp (Fs_type, "vxfs") == 0 \
      || strcmp ("-hosts", Fs_name) == 0)
 #endif
 
@@ -1430,14 +1438,9 @@ get_fs_usage (char const *file, char const *disk, struct fs_usage *fsp)
         /* Empirically, the block counts on most SVR3 and SVR3-derived
            systems seem to always be in terms of 512-byte blocks,
            no matter what value f_bsize has.  */
-#if defined _CRAY
-        fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_bsize);
-#else
         fsp->fsu_blocksize = 512;
 #endif
 
-#endif
-
 #if (defined STAT_STATVFS64 || defined STAT_STATFS3_OSF1 \
      || defined STAT_STATFS2_FRSIZE || defined STAT_STATFS2_BSIZE \
      || defined STAT_STATFS2_FSIZE || defined STAT_STATFS4)
diff --git a/src/filemanager/panel.c b/src/filemanager/panel.c
index b4535e968..cb7577423 100644
--- a/src/filemanager/panel.c
+++ b/src/filemanager/panel.c
@@ -74,7 +74,7 @@
 #include "layout.h"             /* Most layout variables are here */
 #include "cmd.h"
 #include "command.h"            /* cmdline */
-#include "midnight.h"
+#include "filemanager.h"
 #include "mountlist.h"          /* my_statfs */
 
 #include "panel.h"
@@ -370,6 +370,8 @@ static WPanel *mouse_mark_panel = NULL;
 static gboolean mouse_marking = FALSE;
 static int state_mark = 0;
 
+static GString *string_file_name_buffer;
+
 /* --------------------------------------------------------------------------------------------- */
 /*** file scope functions ************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -451,12 +453,12 @@ add_permission_string (const char *dest, int width, file_entry_t * fe, int attr,
 static const char *
 string_file_name (file_entry_t * fe, int len)
 {
-    static char buffer[MC_MAXPATHLEN * MB_LEN_MAX + 1];
-
     (void) len;
 
-    g_strlcpy (buffer, fe->fname, sizeof (buffer));
-    return buffer;
+    g_string_set_size (string_file_name_buffer, 0);
+    g_string_append_len (string_file_name_buffer, fe->fname, fe->fnamelen);
+
+    return string_file_name_buffer->str;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -990,11 +992,11 @@ display_mini_info (WPanel * panel)
 
     widget_gotoyx (w, panel_lines (panel) + 3, 1);
 
-    if (panel->searching)
+    if (panel->quick_search.active)
     {
         tty_setcolor (INPUT_COLOR);
         tty_print_char ('/');
-        tty_print_string (str_fit_to_term (panel->search_buffer, w->cols - 3, J_LEFT));
+        tty_print_string (str_fit_to_term (panel->quick_search.buffer->str, w->cols - 3, J_LEFT));
         return;
     }
 
@@ -1399,9 +1401,9 @@ panel_save_name (WPanel * panel)
 {
     /* If the program is shuting down */
     if ((mc_global.midnight_shutdown && auto_save_setup) || saving_setup)
-        return g_strdup (panel->panel_name);
+        return g_strdup (panel->name);
 
-    return g_strconcat ("Temporal:", panel->panel_name, (char *) NULL);
+    return g_strconcat ("Temporal:", panel->name, (char *) NULL);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1412,8 +1414,8 @@ directory_history_add (WPanel * panel, const vfs_path_t * vpath)
     char *tmp;
 
     tmp = vfs_path_to_str_flags (vpath, 0, VPF_STRIP_PASSWORD);
-    panel->dir_history = list_append_unique (panel->dir_history, tmp);
-    panel->dir_history_current = panel->dir_history;
+    panel->dir_history.list = list_append_unique (panel->dir_history.list, tmp);
+    panel->dir_history.current = panel->dir_history.list;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1432,9 +1434,9 @@ panel_load_history (const gchar * event_group_name, const gchar * event_name,
     if (ev->receiver == NULL || ev->receiver == WIDGET (p))
     {
         if (ev->cfg != NULL)
-            p->dir_history = mc_config_history_load (ev->cfg, p->hist_name);
+            p->dir_history.list = mc_config_history_load (ev->cfg, p->dir_history.name);
         else
-            p->dir_history = mc_config_history_get (p->hist_name);
+            p->dir_history.list = mc_config_history_get (p->dir_history.name);
 
         directory_history_add (p, p->cwd_vpath);
     }
@@ -1454,11 +1456,11 @@ panel_save_history (const gchar * event_group_name, const gchar * event_name,
     (void) event_group_name;
     (void) event_name;
 
-    if (p->dir_history != NULL)
+    if (p->dir_history.list != NULL)
     {
         ev_history_load_save_t *ev = (ev_history_load_save_t *) data;
 
-        mc_config_history_save (ev->cfg, p->hist_name, p->dir_history);
+        mc_config_history_save (ev->cfg, p->dir_history.name, p->dir_history.list);
     }
 
     return TRUE;
@@ -1483,13 +1485,13 @@ panel_destroy (WPanel * p)
     panel_clean_dir (p);
 
     /* clean history */
-    if (p->dir_history != NULL)
+    if (p->dir_history.list != NULL)
     {
         /* directory history is already saved before this moment */
-        p->dir_history = g_list_first (p->dir_history);
-        g_list_free_full (p->dir_history, g_free);
+        p->dir_history.list = g_list_first (p->dir_history.list);
+        g_list_free_full (p->dir_history.list, g_free);
     }
-    g_free (p->hist_name);
+    g_free (p->dir_history.name);
 
     g_slist_free_full (p->format, (GDestroyNotify) format_item_free);
     g_slist_free_full (p->status_format, (GDestroyNotify) format_item_free);
@@ -1499,7 +1501,10 @@ panel_destroy (WPanel * p)
         g_free (p->user_status_format[i]);
 
     g_free (p->dir.list);
-    g_free (p->panel_name);
+    g_free (p->name);
+
+    g_string_free (p->quick_search.buffer, TRUE);
+    g_string_free (p->quick_search.prev_buffer, TRUE);
 
     vfs_path_free (p->lwd_vpath);
     vfs_path_free (p->cwd_vpath);
@@ -1834,7 +1839,7 @@ use_display_format (WPanel * panel, const char *format, char **error, gboolean i
     if (*error != NULL)
         return NULL;
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     usable_columns = WIDGET (panel)->cols - 2;
     /* Status needn't to be split */
@@ -1974,12 +1979,12 @@ mini_status_format (WPanel * panel)
 /* --------------------------------------------------------------------------------------------- */
 
 static void
-cd_up_dir (void)
+cd_up_dir (WPanel * panel)
 {
     vfs_path_t *up_dir;
 
     up_dir = vfs_path_from_str ("..");
-    do_cd (up_dir, cd_exact);
+    panel_cd (panel, up_dir, cd_exact);
     vfs_path_free (up_dir);
 }
 
@@ -1987,23 +1992,22 @@ cd_up_dir (void)
 /** Used to emulate Lynx's entering leaving a directory with the arrow keys */
 
 static cb_ret_t
-maybe_cd (gboolean move_up_dir)
+maybe_cd (WPanel * panel, gboolean move_up_dir)
 {
     if (panels_options.navigate_with_arrows && input_is_empty (cmdline))
     {
         if (move_up_dir)
         {
-            cd_up_dir ();
+            cd_up_dir (panel);
             return MSG_HANDLED;
         }
 
-        if (S_ISDIR (selection (current_panel)->st.st_mode)
-            || link_isdir (selection (current_panel)))
+        if (S_ISDIR (selection (panel)->st.st_mode) || link_isdir (selection (panel)))
         {
             vfs_path_t *vpath;
 
-            vpath = vfs_path_from_str (selection (current_panel)->fname);
-            do_cd (vpath, cd_exact);
+            vpath = vfs_path_from_str (selection (panel)->fname);
+            panel_cd (panel, vpath, cd_exact);
             vfs_path_free (vpath);
             return MSG_HANDLED;
         }
@@ -2016,11 +2020,11 @@ maybe_cd (gboolean move_up_dir)
 
 /* if command line is empty then do 'cd ..' */
 static cb_ret_t
-force_maybe_cd (void)
+force_maybe_cd (WPanel * panel)
 {
     if (input_is_empty (cmdline))
     {
-        cd_up_dir ();
+        cd_up_dir (panel);
         return MSG_HANDLED;
     }
 
@@ -2039,7 +2043,7 @@ unselect_item (WPanel * panel)
 /** Select/unselect all the files like a current file by extension */
 
 static void
-panel_select_ext_cmd (void)
+panel_select_ext_cmd (WPanel * panel)
 {
     char *filename;
     gboolean do_select;
@@ -2047,11 +2051,11 @@ panel_select_ext_cmd (void)
     mc_search_t *search;
     int i;
 
-    filename = selection (current_panel)->fname;
+    filename = selection (panel)->fname;
     if (filename == NULL)
         return;
 
-    do_select = !selection (current_panel)->f.marked;
+    do_select = !selection (panel)->f.marked;
 
     cur_file_ext = strutils_regex_escape (extension (filename));
     if (cur_file_ext[0] != '\0')
@@ -2065,9 +2069,9 @@ panel_select_ext_cmd (void)
     search->search_type = MC_SEARCH_T_REGEX;
     search->is_case_sensitive = FALSE;
 
-    for (i = 0; i < current_panel->dir.len; i++)
+    for (i = 0; i < panel->dir.len; i++)
     {
-        file_entry_t *file_entry = &current_panel->dir.list[i];
+        file_entry_t *file_entry = &panel->dir.list[i];
 
         if (DIR_IS_DOTDOT (file_entry->fname) || S_ISDIR (file_entry->st.st_mode))
             continue;
@@ -2075,7 +2079,7 @@ panel_select_ext_cmd (void)
         if (!mc_search_run (search, file_entry->fname, 0, file_entry->fnamelen, NULL))
             continue;
 
-        do_file_mark (current_panel, i, do_select ? 1 : 0);
+        do_file_mark (panel, i, do_select ? 1 : 0);
     }
 
     mc_search_free (search);
@@ -2214,7 +2218,7 @@ move_left (WPanel * panel)
         return MSG_HANDLED;
     }
 
-    return maybe_cd (TRUE);     /* cd .. */
+    return maybe_cd (panel, TRUE);      /* cd .. */
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -2228,7 +2232,7 @@ move_right (WPanel * panel)
         return MSG_HANDLED;
     }
 
-    return maybe_cd (FALSE);    /* cd (selection) */
+    return maybe_cd (panel, FALSE);     /* cd (selection) */
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -2261,7 +2265,7 @@ static void
 goto_parent_dir (WPanel * panel)
 {
     if (!panel->is_panelized)
-        cd_up_dir ();
+        cd_up_dir (panel);
     else
     {
         char *fname = panel->dir.list[panel->selected].fname;
@@ -2288,7 +2292,7 @@ goto_parent_dir (WPanel * panel)
             g_free (dname);
         }
 
-        do_cd (dname_vpath, cd_exact);
+        panel_cd (panel, dname_vpath, cd_exact);
         try_to_select (panel, bname);
 
         vfs_path_free (dname_vpath);
@@ -2332,7 +2336,7 @@ goto_child_dir (WPanel * panel)
         vfs_path_t *vpath;
 
         vpath = vfs_path_from_str (selection (panel)->fname);
-        do_cd (vpath, cd_exact);
+        panel_cd (panel, vpath, cd_exact);
         vfs_path_free (vpath);
     }
 }
@@ -2626,7 +2630,6 @@ panel_select_invert_files (WPanel * panel)
 static void
 do_search (WPanel * panel, int c_code)
 {
-    size_t l;
     int i, sel;
     gboolean wrapped = FALSE;
     char *act;
@@ -2634,47 +2637,42 @@ do_search (WPanel * panel, int c_code)
     char *reg_exp, *esc_str;
     gboolean is_found = FALSE;
 
-    l = strlen (panel->search_buffer);
     if (c_code == KEY_BACKSPACE)
     {
-        if (l != 0)
+        if (panel->quick_search.buffer->len != 0)
         {
-            act = panel->search_buffer + l;
-            str_prev_noncomb_char (&act, panel->search_buffer);
-            act[0] = '\0';
+            act = panel->quick_search.buffer->str + panel->quick_search.buffer->len;
+            str_prev_noncomb_char (&act, panel->quick_search.buffer->str);
+            g_string_set_size (panel->quick_search.buffer, act - panel->quick_search.buffer->str);
         }
-        panel->search_chpoint = 0;
+        panel->quick_search.chpoint = 0;
     }
     else
     {
-        if (c_code != 0 && (gsize) panel->search_chpoint < sizeof (panel->search_char))
+        if (c_code != 0 && (gsize) panel->quick_search.chpoint < sizeof (panel->quick_search.ch))
         {
-            panel->search_char[panel->search_chpoint] = c_code;
-            panel->search_chpoint++;
+            panel->quick_search.ch[panel->quick_search.chpoint] = c_code;
+            panel->quick_search.chpoint++;
         }
 
-        if (panel->search_chpoint > 0)
+        if (panel->quick_search.chpoint > 0)
         {
-            switch (str_is_valid_char (panel->search_char, panel->search_chpoint))
+            switch (str_is_valid_char (panel->quick_search.ch, panel->quick_search.chpoint))
             {
             case -2:
                 return;
             case -1:
-                panel->search_chpoint = 0;
+                panel->quick_search.chpoint = 0;
                 return;
             default:
-                if (l + panel->search_chpoint < sizeof (panel->search_buffer))
-                {
-                    memcpy (panel->search_buffer + l, panel->search_char, panel->search_chpoint);
-                    l += panel->search_chpoint;
-                    panel->search_buffer[l] = '\0';
-                    panel->search_chpoint = 0;
-                }
+                g_string_append_len (panel->quick_search.buffer, panel->quick_search.ch,
+                                     panel->quick_search.chpoint);
+                panel->quick_search.chpoint = 0;
             }
         }
     }
 
-    reg_exp = g_strdup_printf ("%s*", panel->search_buffer);
+    reg_exp = g_strdup_printf ("%s*", panel->quick_search.buffer->str);
     esc_str = strutils_escape (reg_exp, -1, ",|\\{}[]", TRUE);
     search = mc_search_new (esc_str, NULL);
     search->search_type = MC_SEARCH_T_GLOB;
@@ -2720,9 +2718,9 @@ do_search (WPanel * panel, int c_code)
     }
     else if (c_code != KEY_BACKSPACE)
     {
-        act = panel->search_buffer + l;
-        str_prev_noncomb_char (&act, panel->search_buffer);
-        act[0] = '\0';
+        act = panel->quick_search.buffer->str + panel->quick_search.buffer->len;
+        str_prev_noncomb_char (&act, panel->quick_search.buffer->str);
+        g_string_set_size (panel->quick_search.buffer, act - panel->quick_search.buffer->str);
     }
     mc_search_free (search);
     g_free (reg_exp);
@@ -2737,7 +2735,7 @@ do_search (WPanel * panel, int c_code)
 static void
 start_search (WPanel * panel)
 {
-    if (panel->searching)
+    if (panel->quick_search.active)
     {
         if (panel->selected == panel->dir.len - 1)
             panel->selected = 0;
@@ -2746,18 +2744,17 @@ start_search (WPanel * panel)
 
         /* in case if there was no search string we need to recall
            previous string, with which we ended previous searching */
-        if (panel->search_buffer[0] == '\0')
-            g_strlcpy (panel->search_buffer, panel->prev_search_buffer,
-                       sizeof (panel->search_buffer));
+        if (panel->quick_search.buffer->len == 0)
+            mc_g_string_copy (panel->quick_search.buffer, panel->quick_search.prev_buffer);
 
         do_search (panel, 0);
     }
     else
     {
-        panel->searching = TRUE;
-        panel->search_buffer[0] = '\0';
-        panel->search_char[0] = '\0';
-        panel->search_chpoint = 0;
+        panel->quick_search.active = TRUE;
+        g_string_set_size (panel->quick_search.buffer, 0);
+        panel->quick_search.ch[0] = '\0';
+        panel->quick_search.chpoint = 0;
         display_mini_info (panel);
         mc_refresh ();
     }
@@ -2768,13 +2765,12 @@ start_search (WPanel * panel)
 static void
 stop_search (WPanel * panel)
 {
-    panel->searching = FALSE;
+    panel->quick_search.active = FALSE;
 
-    /* if user had overrdied search string, we need to store it
-       to the previous_search_buffer */
-    if (panel->search_buffer[0] != '\0')
-        g_strlcpy (panel->prev_search_buffer, panel->search_buffer,
-                   sizeof (panel->prev_search_buffer));
+    /* if user overrdied search string, we need to store it
+       to the quick_search.prev_buffer */
+    if (panel->quick_search.buffer->len != 0)
+        mc_g_string_copy (panel->quick_search.prev_buffer, panel->quick_search.buffer);
 
     display_mini_info (panel);
 }
@@ -2783,7 +2779,7 @@ stop_search (WPanel * panel)
 /** Return TRUE if the Enter key has been processed, FALSE otherwise */
 
 static gboolean
-do_enter_on_file_entry (file_entry_t * fe)
+do_enter_on_file_entry (WPanel * panel, file_entry_t * fe)
 {
     vfs_path_t *full_name_vpath;
     gboolean ok;
@@ -2797,13 +2793,13 @@ do_enter_on_file_entry (file_entry_t * fe)
         vfs_path_t *fname_vpath;
 
         fname_vpath = vfs_path_from_str (fe->fname);
-        if (!do_cd (fname_vpath, cd_exact))
+        if (!panel_cd (panel, fname_vpath, cd_exact))
             message (D_ERROR, MSG_ERROR, _("Cannot change directory"));
         vfs_path_free (fname_vpath);
         return TRUE;
     }
 
-    full_name_vpath = vfs_path_append_new (current_panel->cwd_vpath, fe->fname, (char *) NULL);
+    full_name_vpath = vfs_path_append_new (panel->cwd_vpath, fe->fname, (char *) NULL);
 
     /* Try associated command */
     ok = regex_command (full_name_vpath, "Open") != 0;
@@ -2812,7 +2808,7 @@ do_enter_on_file_entry (file_entry_t * fe)
         return TRUE;
 
     /* Check if the file is executable */
-    full_name_vpath = vfs_path_append_new (current_panel->cwd_vpath, fe->fname, (char *) NULL);
+    full_name_vpath = vfs_path_append_new (panel->cwd_vpath, fe->fname, (char *) NULL);
     ok = (is_exe (fe->st.st_mode) && if_link_is_exe (full_name_vpath, fe));
     vfs_path_free (full_name_vpath);
     if (!ok)
@@ -2857,7 +2853,7 @@ do_enter_on_file_entry (file_entry_t * fe)
 static inline gboolean
 do_enter (WPanel * panel)
 {
-    return do_enter_on_file_entry (selection (panel));
+    return do_enter_on_file_entry (panel, selection (panel));
 }
 
 
@@ -2880,6 +2876,7 @@ chdir_other_panel (WPanel * panel)
     const file_entry_t *entry = &panel->dir.list[panel->selected];
     vfs_path_t *new_dir_vpath;
     char *sel_entry = NULL;
+    WPanel *p;
 
     if (get_other_type () != view_listing)
         create_panel (get_other_index (), view_listing);
@@ -2892,13 +2889,13 @@ chdir_other_panel (WPanel * panel)
         sel_entry = strrchr (vfs_path_get_last_path_str (panel->cwd_vpath), PATH_SEP);
     }
 
-    change_panel ();
-    do_cd (new_dir_vpath, cd_exact);
+    p = change_panel ();
+    panel_cd (p, new_dir_vpath, cd_exact);
     vfs_path_free (new_dir_vpath);
 
     if (sel_entry)
-        try_to_select (current_panel, sel_entry);
-    change_panel ();
+        try_to_select (p, sel_entry);
+    (void) change_panel ();
 
     move_down (panel);
 }
@@ -2917,7 +2914,7 @@ panel_sync_other (const WPanel * panel)
     if (get_other_type () != view_listing)
         create_panel (get_other_index (), view_listing);
 
-    do_panel_cd (other_panel, current_panel->cwd_vpath, cd_exact);
+    panel_do_cd (other_panel, panel->cwd_vpath, cd_exact);
 
     /* try to select current filename on the other panel */
     if (!panel->is_panelized)
@@ -2935,6 +2932,7 @@ chdir_to_readlink (WPanel * panel)
     struct stat st;
     vfs_path_t *panel_fname_vpath;
     gboolean ok;
+    WPanel *cpanel;
 
     if (get_other_type () != view_listing)
         return;
@@ -2973,10 +2971,10 @@ chdir_to_readlink (WPanel * panel)
     else
         new_dir_vpath = vfs_path_append_new (panel->cwd_vpath, buffer, (char *) NULL);
 
-    change_panel ();
-    do_cd (new_dir_vpath, cd_exact);
+    cpanel = change_panel ();
+    panel_cd (cpanel, new_dir_vpath, cd_exact);
     vfs_path_free (new_dir_vpath);
-    change_panel ();
+    (void) change_panel ();
 
     move_down (panel);
 }
@@ -3248,7 +3246,7 @@ subshell_chdir (const vfs_path_t * vpath)
  */
 
 static gboolean
-_do_panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type)
+panel_do_cd_int (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type)
 {
     vfs_path_t *olddir_vpath;
 
@@ -3288,7 +3286,7 @@ _do_panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_
     try_to_select (panel, get_parent_dir_name (panel->cwd_vpath, olddir_vpath));
 
     load_hint (FALSE);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     update_xterm_title_path ();
 
     vfs_path_free (olddir_vpath);
@@ -3308,15 +3306,15 @@ directory_history_next (WPanel * panel)
         GList *next;
 
         ok = TRUE;
-        next = g_list_next (panel->dir_history_current);
+        next = g_list_next (panel->dir_history.current);
         if (next != NULL)
         {
             vfs_path_t *data_vpath;
 
             data_vpath = vfs_path_from_str ((char *) next->data);
-            ok = _do_panel_cd (panel, data_vpath, cd_exact);
+            ok = panel_do_cd_int (panel, data_vpath, cd_exact);
             vfs_path_free (data_vpath);
-            panel->dir_history_current = next;
+            panel->dir_history.current = next;
         }
         /* skip directories that present in history but absent in file system */
     }
@@ -3335,15 +3333,15 @@ directory_history_prev (WPanel * panel)
         GList *prev;
 
         ok = TRUE;
-        prev = g_list_previous (panel->dir_history_current);
+        prev = g_list_previous (panel->dir_history.current);
         if (prev != NULL)
         {
             vfs_path_t *data_vpath;
 
             data_vpath = vfs_path_from_str ((char *) prev->data);
-            ok = _do_panel_cd (panel, data_vpath, cd_exact);
+            ok = panel_do_cd_int (panel, data_vpath, cd_exact);
             vfs_path_free (data_vpath);
-            panel->dir_history_current = prev;
+            panel->dir_history.current = prev;
         }
         /* skip directories that present in history but absent in file system */
     }
@@ -3359,19 +3357,19 @@ directory_history_list (WPanel * panel)
     gboolean ok = FALSE;
     size_t pos;
 
-    pos = g_list_position (panel->dir_history_current, panel->dir_history);
+    pos = g_list_position (panel->dir_history.current, panel->dir_history.list);
 
-    history_descriptor_init (&hd, WIDGET (panel)->y, WIDGET (panel)->x, panel->dir_history,
+    history_descriptor_init (&hd, WIDGET (panel)->y, WIDGET (panel)->x, panel->dir_history.list,
                              (int) pos);
     history_show (&hd);
 
-    panel->dir_history = hd.list;
+    panel->dir_history.list = hd.list;
     if (hd.text != NULL)
     {
         vfs_path_t *s_vpath;
 
         s_vpath = vfs_path_from_str (hd.text);
-        ok = _do_panel_cd (panel, s_vpath, cd_exact);
+        ok = panel_do_cd_int (panel, s_vpath, cd_exact);
         if (ok)
             directory_history_add (panel, panel->cwd_vpath);
         else
@@ -3387,17 +3385,17 @@ directory_history_list (WPanel * panel)
 
         size_t i;
 
-        panel->dir_history_current = panel->dir_history;
+        panel->dir_history.current = panel->dir_history.list;
 
         for (i = 0; i <= pos; i++)
         {
             GList *prev;
 
-            prev = g_list_previous (panel->dir_history_current);
+            prev = g_list_previous (panel->dir_history.current);
             if (prev == NULL)
                 break;
 
-            panel->dir_history_current = prev;
+            panel->dir_history.current = prev;
         }
     }
 }
@@ -3441,22 +3439,22 @@ panel_execute_cmd (WPanel * panel, long command)
         chdir_to_readlink (panel);
         break;
     case CK_CopySingle:
-        copy_cmd_local ();
+        copy_cmd_local (panel);
         break;
     case CK_DeleteSingle:
-        delete_cmd_local ();
+        delete_cmd_local (panel);
         break;
     case CK_Enter:
         do_enter (panel);
         break;
     case CK_ViewRaw:
-        view_raw_cmd ();
+        view_raw_cmd (panel);
         break;
     case CK_EditNew:
         edit_cmd_new ();
         break;
     case CK_MoveSingle:
-        rename_cmd_local ();
+        rename_cmd_local (panel);
         break;
     case CK_SelectInvert:
         panel_select_invert_files (panel);
@@ -3465,7 +3463,7 @@ panel_execute_cmd (WPanel * panel, long command)
         panel_select_files (panel);
         break;
     case CK_SelectExt:
-        panel_select_ext_cmd ();
+        panel_select_ext_cmd (panel);
         break;
     case CK_Unselect:
         panel_unselect_files (panel);
@@ -3516,7 +3514,7 @@ panel_execute_cmd (WPanel * panel, long command)
         mark_file_right (panel);
         break;
     case CK_CdParentSmart:
-        res = force_maybe_cd ();
+        res = force_maybe_cd (panel);
         break;
     case CK_Up:
         move_up (panel);
@@ -3601,7 +3599,7 @@ panel_key (WPanel * panel, int key)
         return MSG_HANDLED;
     }
 
-    if (panel->searching && ((key >= ' ' && key <= 255) || key == KEY_BACKSPACE))
+    if (panel->quick_search.active && ((key >= ' ' && key <= 255) || key == KEY_BACKSPACE))
     {
         do_search (panel, key);
         return MSG_HANDLED;
@@ -3654,13 +3652,13 @@ panel_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
         paint_dir (panel);
         mini_info_separator (panel);
         display_mini_info (panel);
-        panel->dirty = 0;
+        panel->dirty = FALSE;
         return MSG_HANDLED;
 
     case MSG_FOCUS:
         state_mark = -1;
         current_panel = panel;
-        panel->active = 1;
+        panel->active = TRUE;
 
         if (mc_chdir (panel->cwd_vpath) != 0)
         {
@@ -3685,7 +3683,7 @@ panel_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
     case MSG_UNFOCUS:
         /* Janne: look at this for the multiple panel options */
         stop_search (panel);
-        panel->active = 0;
+        panel->active = FALSE;
         unselect_item (panel);
         return MSG_HANDLED;
 
@@ -3870,7 +3868,7 @@ panel_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
                 /* no other events on 1st line, return MOU_UNHANDLED */
                 event->result.abort = TRUE;
                 /* avoid extra panel redraw */
-                panel->dirty = 0;
+                panel->dirty = FALSE;
             }
             break;
         }
@@ -3883,7 +3881,7 @@ panel_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
         }
 
         if (!is_active)
-            change_panel ();
+            (void) change_panel ();
         MC_FALLTHROUGH;
 
     case MSG_MOUSE_DRAG:
@@ -4014,7 +4012,7 @@ update_one_panel_widget (WPanel * panel, panel_update_flags_t flags, const char
         panel_reload (panel);
 
     try_to_select (panel, current_file);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     if (free_pointer)
         g_free (my_current_file);
@@ -4043,7 +4041,7 @@ do_select (WPanel * panel, int i)
 {
     if (i != panel->selected)
     {
-        panel->dirty = 1;
+        panel->dirty = TRUE;
         panel->selected = i;
         panel->top_file = panel->selected - (WIDGET (panel)->lines - 2) / 2;
         if (panel->top_file < 0)
@@ -4235,9 +4233,9 @@ panel_clean_dir (WPanel * panel)
     panel->marked = 0;
     panel->dirs_marked = 0;
     panel->total = 0;
-    panel->searching = FALSE;
+    panel->quick_search.active = FALSE;
     panel->is_panelized = FALSE;
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     panel->content_shift = -1;
     panel->max_shift = -1;
 
@@ -4310,7 +4308,7 @@ panel_sized_empty_new (const char *panel_name, int y, int x, int lines, int cols
 
     panel->list_cols = 1;
     panel->brief_cols = 2;
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     panel->content_shift = -1;
     panel->max_shift = -1;
 
@@ -4326,15 +4324,18 @@ panel_sized_empty_new (const char *panel_name, int y, int x, int lines, int cols
 
     panel->frame_size = frame_half;
 
-    panel->panel_name = g_strdup (panel_name);
-    panel->hist_name = g_strconcat ("Dir Hist ", panel->panel_name, (char *) NULL);
+    panel->quick_search.buffer = g_string_sized_new (MC_MAXFILENAMELEN);
+    panel->quick_search.prev_buffer = g_string_sized_new (MC_MAXFILENAMELEN);
+
+    panel->name = g_strdup (panel_name);
+    panel->dir_history.name = g_strconcat ("Dir Hist ", panel->name, (char *) NULL);
     /* directories history will be get later */
 
-    section = g_strconcat ("Temporal:", panel->panel_name, (char *) NULL);
+    section = g_strconcat ("Temporal:", panel->name, (char *) NULL);
     if (!mc_config_has_group (mc_global.main_config, section))
     {
         g_free (section);
-        section = g_strdup (panel->panel_name);
+        section = g_strdup (panel->name);
     }
     panel_load_setup (panel, section);
     g_free (section);
@@ -4455,7 +4456,7 @@ panel_reload (WPanel * panel)
                           &panel->sort_info, panel->filter))
         message (D_ERROR, MSG_ERROR, _("Cannot read directory contents"));
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     if (panel->selected >= panel->dir.len)
         do_select (panel, panel->dir.len - 1);
 
@@ -4530,7 +4531,7 @@ select_item (WPanel * panel)
 {
     adjust_top_file (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     execute_hooks (select_file_hook);
 }
@@ -4627,11 +4628,11 @@ do_file_mark (WPanel * panel, int idx, int mark)
  * Record change in the directory history.
  */
 gboolean
-do_panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type)
+panel_do_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type)
 {
     gboolean r;
 
-    r = _do_panel_cd (panel, new_dir_vpath, cd_type);
+    r = panel_do_cd_int (panel, new_dir_vpath, cd_type);
     if (r)
         directory_history_add (panel, panel->cwd_vpath);
     return r;
@@ -4645,7 +4646,7 @@ file_mark (WPanel * panel, int lc_index, int val)
     if (panel->dir.list[lc_index].f.marked != val)
     {
         panel->dir.list[lc_index].f.marked = val;
-        panel->dirty = 1;
+        panel->dirty = TRUE;
     }
 }
 
@@ -4675,7 +4676,7 @@ panel_re_sort (WPanel * panel)
     g_free (filename);
     panel->top_file = panel->selected - panel_items (panel) / 2;
     select_item (panel);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -4731,7 +4732,7 @@ panel_change_encoding (WPanel * panel)
 
         g_free (init_translation_table (mc_global.display_codepage, mc_global.display_codepage));
         cd_path_vpath = remove_encoding_from_path (panel->cwd_vpath);
-        do_panel_cd (panel, cd_path_vpath, cd_parse_command);
+        panel_do_cd (panel, cd_path_vpath, cd_parse_command);
         show_dir (panel);
         vfs_path_free (cd_path_vpath);
         return;
@@ -4750,7 +4751,7 @@ panel_change_encoding (WPanel * panel)
     {
         vfs_path_change_encoding (panel->cwd_vpath, encoding);
 
-        if (!do_panel_cd (panel, panel->cwd_vpath, cd_parse_command))
+        if (!panel_do_cd (panel, panel->cwd_vpath, cd_parse_command))
             message (D_ERROR, MSG_ERROR, _("Cannot chdir to \"%s\""),
                      vfs_path_as_str (panel->cwd_vpath));
     }
@@ -4991,6 +4992,8 @@ panel_init (void)
     panel_filename_scroll_right_char =
         mc_skin_get ("widget-panel", "filename-scroll-right-char", "}");
 
+    string_file_name_buffer = g_string_sized_new (MC_MAXFILENAMELEN);
+
     mc_event_add (MCEVENT_GROUP_FILEMANAGER, "update_panels", event_update_panels, NULL, NULL);
     mc_event_add (MCEVENT_GROUP_FILEMANAGER, "panel_save_current_file_to_clip_file",
                   panel_save_current_file_to_clip_file, NULL, NULL);
@@ -5010,17 +5013,18 @@ panel_deinit (void)
     g_free (panel_history_show_list_char);
     g_free (panel_filename_scroll_left_char);
     g_free (panel_filename_scroll_right_char);
+    g_string_free (string_file_name_buffer, TRUE);
 }
 
 /* --------------------------------------------------------------------------------------------- */
 
 gboolean
-do_cd (const vfs_path_t * new_dir_vpath, enum cd_enum exact)
+panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum exact)
 {
     gboolean res;
     const vfs_path_t *_new_dir_vpath = new_dir_vpath;
 
-    if (current_panel->is_panelized)
+    if (panel->is_panelized)
     {
         size_t new_vpath_len;
 
@@ -5029,18 +5033,18 @@ do_cd (const vfs_path_t * new_dir_vpath, enum cd_enum exact)
             _new_dir_vpath = panelized_panel.root_vpath;
     }
 
-    res = do_panel_cd (current_panel, _new_dir_vpath, exact);
+    res = panel_do_cd (panel, _new_dir_vpath, exact);
 
 #ifdef HAVE_CHARSET
     if (res)
     {
         const vfs_path_element_t *path_element;
 
-        path_element = vfs_path_get_by_index (current_panel->cwd_vpath, -1);
+        path_element = vfs_path_get_by_index (panel->cwd_vpath, -1);
         if (path_element->encoding != NULL)
-            current_panel->codepage = get_codepage_index (path_element->encoding);
+            panel->codepage = get_codepage_index (path_element->encoding);
         else
-            current_panel->codepage = SELECT_CHARSET_NO_TRANSLATE;
+            panel->codepage = SELECT_CHARSET_NO_TRANSLATE;
     }
 #endif /* HAVE_CHARSET */
 
diff --git a/src/filemanager/panel.h b/src/filemanager/panel.h
index 1055ddf05..abfac30ac 100644
--- a/src/filemanager/panel.h
+++ b/src/filemanager/panel.h
@@ -90,51 +90,63 @@ typedef struct
 typedef struct
 {
     Widget widget;
+
+    char *name;                 /* The panel name */
+
+    panel_display_t frame_size; /* half or full frame */
+
+    gboolean active;            /* If panel is currently selected */
+    gboolean dirty;             /* Should we redisplay the panel? */
+    gboolean is_panelized;      /* Flag: special filelisting, can't reload */
+
+#ifdef HAVE_CHARSET
+    int codepage;               /* Panel codepage */
+#endif
+
     dir_list dir;               /* Directory contents */
+    struct stat dir_stat;       /* Stat of current dir: used by execute () */
 
-    list_format_t list_format;  /* listing type */
-    int active;                 /* If panel is currently selected */
     vfs_path_t *cwd_vpath;      /* Current Working Directory */
     vfs_path_t *lwd_vpath;      /* Last Working Directory */
-    GList *dir_history;         /* directory history */
-    GList *dir_history_current; /* pointer to the current history item */
-    char *hist_name;            /* directory history name for history file */
-    int marked;                 /* Count of marked files */
-    int dirs_marked;            /* Count of marked directories */
-    uintmax_t total;            /* Bytes in marked files */
-    int top_file;               /* The file showed on the top of the panel */
-    int selected;               /* Index to the selected file */
+
+    list_format_t list_format;  /* Listing type */
+    GSList *format;             /* Display format */
+    char *user_format;          /* User format */
     int list_cols;              /* Number of file list columns */
     int brief_cols;             /* Number of columns in case of list_brief format */
-    gboolean is_panelized;      /* Flag: special filelisting, can't reload */
-    panel_display_t frame_size; /* half or full frame */
-    char *filter;               /* File name filter */
-
     /* sort */
     dir_sort_options_t sort_info;
     const panel_field_t *sort_field;
 
-    int dirty;                  /* Should we redisplay the panel? */
+    int marked;                 /* Count of marked files */
+    int dirs_marked;            /* Count of marked directories */
+    uintmax_t total;            /* Bytes in marked files */
 
-    gboolean user_mini_status;  /* Is user_status_format used */
-    char *user_format;          /* User format */
-    char *user_status_format[LIST_FORMATS];     /* User format for status line */
+    int top_file;               /* The file showed on the top of the panel */
+    int selected;               /* Index to the selected file */
 
-    GSList *format;             /* Display format */
     GSList *status_format;      /* Mini status format */
+    gboolean user_mini_status;  /* Is user_status_format used */
+    char *user_status_format[LIST_FORMATS];     /* User format for status line */
 
-    char *panel_name;           /* The panel name */
-    struct stat dir_stat;       /* Stat of current dir: used by execute () */
+    char *filter;               /* File name filter */
 
-#ifdef HAVE_CHARSET
-    int codepage;               /* panel codepage */
-#endif
+    struct
+    {
+        char *name;             /* Directory history name for history file */
+        GList *list;            /* Directory history */
+        GList *current;         /* Pointer to the current history item */
+    } dir_history;
+
+    struct
+    {
+        gboolean active;
+        GString *buffer;
+        GString *prev_buffer;
+        char ch[MB_LEN_MAX];    /* Buffer for multi-byte character */
+        int chpoint;            /* Point after last characters in @ch */
+    } quick_search;
 
-    gboolean searching;
-    char search_buffer[MC_MAXFILENAMELEN];
-    char prev_search_buffer[MC_MAXFILENAMELEN];
-    char search_char[MB_LEN_MAX];       /*buffer for multibytes characters */
-    int search_chpoint;         /*point after last characters in search_char */
     int content_shift;          /* Number of characters of filename need to skip from left side. */
     int max_shift;              /* Max shift for visible part of current panel */
 } WPanel;
@@ -176,7 +188,8 @@ void recalculate_panel_summary (WPanel * panel);
 void file_mark (WPanel * panel, int idx, int val);
 void do_file_mark (WPanel * panel, int idx, int val);
 
-gboolean do_panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type);
+gboolean panel_do_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type);
+gboolean panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_type);
 
 gsize panel_get_num_of_sortable_fields (void);
 char **panel_get_sortable_fields (gsize *);
@@ -190,7 +203,6 @@ void panel_set_lwd (WPanel * panel, const vfs_path_t * vpath);
 
 void panel_init (void);
 void panel_deinit (void);
-gboolean do_cd (const vfs_path_t * new_dir_vpath, enum cd_enum cd_type);
 
 /* --------------------------------------------------------------------------------------------- */
 /*** inline functions ****************************************************************************/
diff --git a/src/filemanager/panelize.c b/src/filemanager/panelize.c
index 8c1af1ed8..1fd59c4f9 100644
--- a/src/filemanager/panelize.c
+++ b/src/filemanager/panelize.c
@@ -50,7 +50,7 @@
 #include "src/history.h"
 
 #include "dir.h"
-#include "midnight.h"           /* current_panel */
+#include "filemanager.h"        /* current_panel */
 #include "layout.h"             /* rotate_dash() */
 #include "panel.h"              /* WPanel */
 
diff --git a/src/filemanager/tree.c b/src/filemanager/tree.c
index 008bc0403..bad58ce50 100644
--- a/src/filemanager/tree.c
+++ b/src/filemanager/tree.c
@@ -60,7 +60,7 @@
 #include "src/history.h"
 
 #include "dir.h"
-#include "midnight.h"           /* the_menubar */
+#include "filemanager.h"        /* the_menubar */
 #include "file.h"               /* copy_dir_dir(), move_dir_dir(), erase_dir() */
 #include "layout.h"             /* command_prompt */
 #include "treestore.h"
@@ -92,7 +92,7 @@ struct WTree
     Widget widget;
     struct TreeStore *store;
     tree_entry *selected_ptr;   /* The selected directory */
-    char search_buffer[MC_MAXFILENAMELEN];      /* Current search string */
+    GString *search_buffer;     /* Current search string */
     tree_entry **tree_shown;    /* Entries currently on screen */
     gboolean is_panel;          /* panel or plain widget flag */
     gboolean searching;         /* Are we on searching mode? */
@@ -195,6 +195,7 @@ tree_destroy (WTree * tree)
     save_tree (tree);
 
     MC_PTR_FREE (tree->tree_shown);
+    g_string_free (tree->search_buffer, TRUE);
     tree->selected_ptr = NULL;
 }
 
@@ -239,7 +240,7 @@ tree_show_mini_info (WTree * tree, int tree_lines, int tree_cols)
         tty_draw_hline (w->y + line, w->x + 1, ' ', tree_cols);
         widget_gotoyx (w, line, 1);
         tty_print_char (PATH_SEP);
-        tty_print_string (str_fit_to_term (tree->search_buffer, tree_cols - 2, J_LEFT_FIT));
+        tty_print_string (str_fit_to_term (tree->search_buffer->str, tree_cols - 2, J_LEFT_FIT));
         tty_print_char (' ');
     }
     else
@@ -585,16 +586,18 @@ tree_chdir_sel (WTree * tree)
 {
     if (tree->is_panel)
     {
-        change_panel ();
+        WPanel *p;
 
-        if (do_cd (tree->selected_ptr->name, cd_exact))
-            select_item (current_panel);
+        p = change_panel ();
+
+        if (panel_cd (p, tree->selected_ptr->name, cd_exact))
+            select_item (p);
         else
             message (D_ERROR, MSG_ERROR, _("Cannot chdir to \"%s\"\n%s"),
                      vfs_path_as_str (tree->selected_ptr->name), unix_error_string (errno));
 
-        widget_draw (WIDGET (current_panel));
-        change_panel ();
+        widget_draw (WIDGET (p));
+        (void) change_panel ();
         show_tree (tree);
     }
     else
@@ -618,19 +621,15 @@ maybe_chdir (WTree * tree)
 /* --------------------------------------------------------------------------------------------- */
 /** Search tree for text */
 
-static int
-search_tree (WTree * tree, char *text)
+static gboolean
+search_tree (WTree * tree, const GString * text)
 {
-    tree_entry *current;
-    size_t len;
+    tree_entry *current = tree->selected_ptr;
     gboolean wrapped = FALSE;
     gboolean found = FALSE;
 
-    len = strlen (text);
-    current = tree->selected_ptr;
-
     while (!found && (!wrapped || current != tree->selected_ptr))
-        if (strncmp (current->subname, text, len) == 0)
+        if (strncmp (current->subname, text->str, text->len) == 0)
         {
             tree->selected_ptr = current;
             found = TRUE;
@@ -656,19 +655,15 @@ search_tree (WTree * tree, char *text)
 static void
 tree_do_search (WTree * tree, int key)
 {
-    size_t l;
+    /* TODO: support multi-byte characters, see do_search() in panel.c */
 
-    l = strlen (tree->search_buffer);
-    if ((l != 0) && (key == KEY_BACKSPACE))
-        tree->search_buffer[--l] = '\0';
-    else if (key && l < sizeof (tree->search_buffer) - 1)
-    {
-        tree->search_buffer[l] = key;
-        tree->search_buffer[++l] = '\0';
-    }
+    if (tree->search_buffer->len != 0 && key == KEY_BACKSPACE)
+        g_string_set_size (tree->search_buffer, tree->search_buffer->len - 1);
+    else if (key != 0)
+        g_string_append_c (tree->search_buffer, (gchar) key);
 
     if (!search_tree (tree, tree->search_buffer))
-        tree->search_buffer[--l] = '\0';
+        g_string_set_size (tree->search_buffer, tree->search_buffer->len - 1);
 
     show_tree (tree);
     maybe_chdir (tree);
@@ -970,7 +965,7 @@ tree_start_search (WTree * tree)
     else
     {
         tree->searching = TRUE;
-        tree->search_buffer[0] = '\0';
+        g_string_set_size (tree->search_buffer, 0);
     }
 }
 
@@ -1236,7 +1231,7 @@ tree_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
             event->result.abort = TRUE;
         }
         else if (!widget_get_state (w, WST_FOCUSED))
-            change_panel ();
+            (void) change_panel ();
         break;
 
     case MSG_MOUSE_CLICK:
@@ -1301,7 +1296,7 @@ tree_new (int y, int x, int lines, int cols, gboolean is_panel)
     tree->store = tree_store_get ();
     tree_store_add_entry_remove_hook (remove_callback, tree);
     tree->tree_shown = NULL;
-    tree->search_buffer[0] = '\0';
+    tree->search_buffer = g_string_sized_new (MC_MAXPATHLEN);
     tree->topdiff = w->lines / 2;
     tree->searching = FALSE;
 
diff --git a/src/filemanager/treestore.c b/src/filemanager/treestore.c
index 08354b217..0b34a5497 100644
--- a/src/filemanager/treestore.c
+++ b/src/filemanager/treestore.c
@@ -242,7 +242,7 @@ tree_store_load_from (const char *name)
             char *lc_name;
 
             /* Skip invalid records */
-            if ((buffer[0] != '0' && buffer[0] != '1'))
+            if (buffer[0] != '0' && buffer[0] != '1')
                 continue;
 
             if (buffer[1] != ':')
@@ -269,7 +269,7 @@ tree_store_load_from (const char *name)
                         vfs_path_t *vpath;
 
                         vpath = vfs_path_from_str (oldname);
-                        strcpy (oldname + common, different);
+                        g_strlcpy (oldname + common, different, sizeof (oldname) - (size_t) common);
                         if (vfs_file_is_local (vpath))
                         {
                             vfs_path_t *tmp_vpath;
@@ -294,7 +294,7 @@ tree_store_load_from (const char *name)
                     e->scanned = scanned;
                 }
                 vfs_path_free (vpath);
-                strcpy (oldname, lc_name);
+                g_strlcpy (oldname, lc_name, sizeof (oldname));
             }
             g_free (lc_name);
         }
@@ -909,7 +909,7 @@ tree_store_rescan (const vfs_path_t * vpath)
     dirp = mc_opendir (vpath);
     if (dirp != NULL)
     {
-        struct dirent *dp;
+        struct vfs_dirent *dp;
 
         for (dp = mc_readdir (dirp); dp != NULL; dp = mc_readdir (dirp))
             if (!DIR_IS_DOT (dp->d_name) && !DIR_IS_DOTDOT (dp->d_name))
diff --git a/src/keybind-defaults.c b/src/keybind-defaults.c
index 713a400da..7b87c2f5a 100644
--- a/src/keybind-defaults.c
+++ b/src/keybind-defaults.c
@@ -34,8 +34,8 @@
 
 /*** global variables ****************************************************************************/
 
-GArray *main_keymap = NULL;
-GArray *main_x_keymap = NULL;
+GArray *filemanager_keymap = NULL;
+GArray *filemanager_x_keymap = NULL;
 GArray *panel_keymap = NULL;
 GArray *dialog_keymap = NULL;
 GArray *menu_keymap = NULL;
@@ -57,8 +57,8 @@ GArray *viewer_hex_keymap = NULL;
 GArray *diff_keymap = NULL;
 #endif
 
-const global_keymap_t *main_map = NULL;
-const global_keymap_t *main_x_map = NULL;
+const global_keymap_t *filemanager_map = NULL;
+const global_keymap_t *filemanager_x_map = NULL;
 const global_keymap_t *panel_map = NULL;
 const global_keymap_t *tree_map = NULL;
 const global_keymap_t *help_map = NULL;
@@ -89,8 +89,8 @@ typedef struct global_keymap_ini_t
 /*** file scope variables ************************************************************************/
 
 /* midnight */
-static const global_keymap_ini_t default_main_keymap[] = {
-    {"ChangePanel", "tab"},
+static const global_keymap_ini_t default_filemanager_keymap[] = {
+    {"ChangePanel", "tab; ctrl-i"},
     {"Help", "f1"},
     {"UserMenu", "f2"},
     {"View", "f3"},
@@ -143,7 +143,7 @@ static const global_keymap_ini_t default_main_keymap[] = {
     {NULL, NULL}
 };
 
-static const global_keymap_ini_t default_main_x_keymap[] = {
+static const global_keymap_ini_t default_filemanager_x_keymap[] = {
     {"CompareDirs", "d"},
 #ifdef USE_DIFF_VIEW
     {"CompareFiles", "ctrl-d"},
@@ -641,8 +641,9 @@ create_default_keymap (void)
 
     keymap = mc_config_init (NULL, TRUE);
 
-    create_default_keymap_section (keymap, KEYMAP_SECTION_MAIN, default_main_keymap);
-    create_default_keymap_section (keymap, KEYMAP_SECTION_MAIN_EXT, default_main_x_keymap);
+    create_default_keymap_section (keymap, KEYMAP_SECTION_FILEMANAGER, default_filemanager_keymap);
+    create_default_keymap_section (keymap, KEYMAP_SECTION_FILEMANAGER_EXT,
+                                   default_filemanager_x_keymap);
     create_default_keymap_section (keymap, KEYMAP_SECTION_PANEL, default_panel_keymap);
     create_default_keymap_section (keymap, KEYMAP_SECTION_DIALOG, default_dialog_keymap);
     create_default_keymap_section (keymap, KEYMAP_SECTION_MENU, default_menu_keymap);
diff --git a/src/keybind-defaults.h b/src/keybind-defaults.h
index c474b7dcc..6a86001bc 100644
--- a/src/keybind-defaults.h
+++ b/src/keybind-defaults.h
@@ -13,8 +13,8 @@
 
 /*** global variables defined in .c file *********************************************************/
 
-extern GArray *main_keymap;
-extern GArray *main_x_keymap;
+extern GArray *filemanager_keymap;
+extern GArray *filemanager_x_keymap;
 extern GArray *panel_keymap;
 extern GArray *dialog_keymap;
 extern GArray *menu_keymap;
@@ -36,8 +36,8 @@ extern GArray *viewer_hex_keymap;
 extern GArray *diff_keymap;
 #endif
 
-extern const global_keymap_t *main_map;
-extern const global_keymap_t *main_x_map;
+extern const global_keymap_t *filemanager_map;
+extern const global_keymap_t *filemanager_x_map;
 extern const global_keymap_t *panel_map;
 extern const global_keymap_t *tree_map;
 extern const global_keymap_t *help_map;
diff --git a/src/main.c b/src/main.c
index 6db18b200..d691bcb2a 100644
--- a/src/main.c
+++ b/src/main.c
@@ -49,7 +49,6 @@
 #include "lib/tty/tty.h"
 #include "lib/tty/key.h"        /* For init_key() */
 #include "lib/tty/mouse.h"      /* init_mouse() */
-#include "lib/timer.h"
 #include "lib/skin.h"
 #include "lib/filehighlight.h"
 #include "lib/fileloc.h"
@@ -57,7 +56,7 @@
 #include "lib/util.h"
 #include "lib/vfs/vfs.h"        /* vfs_init(), vfs_shut() */
 
-#include "filemanager/midnight.h"       /* current_panel */
+#include "filemanager/filemanager.h"
 #include "filemanager/treestore.h"      /* tree_store_save */
 #include "filemanager/layout.h"
 #include "filemanager/ext.h"    /* flush_extension_file() */
@@ -255,8 +254,6 @@ main (int argc, char *argv[])
 
     mc_global.run_from_parent_mc = !check_sid ();
 
-    mc_global.timer = mc_timer_new ();
-
     /* We had LC_CTYPE before, LC_ALL includs LC_TYPE as well */
 #ifdef HAVE_SETLOCALE
     (void) setlocale (LC_ALL, "");
@@ -277,7 +274,6 @@ main (int argc, char *argv[])
       startup_exit_ok:
         mc_shell_deinit ();
         str_uninit_strings ();
-        mc_timer_destroy (mc_global.timer);
         return exit_code;
     }
 
@@ -557,8 +553,6 @@ main (int argc, char *argv[])
         exit_code = EXIT_FAILURE;
     }
 
-    mc_timer_destroy (mc_global.timer);
-
     (void) putchar ('\n');      /* Hack to make shell's prompt start at left of screen */
 
     return exit_code;
diff --git a/src/setup.c b/src/setup.c
index 37618a9cd..77c07649d 100644
--- a/src/setup.c
+++ b/src/setup.c
@@ -54,7 +54,7 @@
 #endif
 
 #include "filemanager/dir.h"
-#include "filemanager/midnight.h"
+#include "filemanager/filemanager.h"
 #include "filemanager/tree.h"   /* xtree_mode */
 #include "filemanager/hotlist.h"        /* load/save/done hotlist */
 #include "filemanager/panelize.h"       /* load/save/done panelize */
@@ -360,6 +360,7 @@ static const struct
 #endif /* USE_INTERNAL_EDIT */
     { "editor_ask_filename_before_edit", &editor_ask_filename_before_edit },
     { "nice_rotating_dash", &nice_rotating_dash },
+    { "shadows", &mc_global.tty.shadows },
     { "mcview_remember_file_position", &mcview_remember_file_position },
     { "auto_fill_mkdir_name", &auto_fill_mkdir_name },
     { "copymove_persistent_attr", &copymove_persistent_attr },
@@ -996,11 +997,11 @@ save_panel_types (void)
     type = get_panel_type (0);
     panel_save_type ("New Left Panel", type);
     if (type == view_listing)
-        panel_save_setup (left_panel, left_panel->panel_name);
+        panel_save_setup (left_panel, left_panel->name);
     type = get_panel_type (1);
     panel_save_type ("New Right Panel", type);
     if (type == view_listing)
-        panel_save_setup (right_panel, right_panel->panel_name);
+        panel_save_setup (right_panel, right_panel->name);
 
     {
         char *dirs;
@@ -1354,8 +1355,8 @@ load_keymap_defs (gboolean load_from_file)
     km##_keymap = g_array_new (TRUE, FALSE, sizeof (global_keymap_t)); \
     load_keymap_from_section (KEYMAP_SECTION_##s, km##_keymap, mc_global_keymap)
 
-        LOAD_KEYMAP (MAIN, main);
-        LOAD_KEYMAP (MAIN_EXT, main_x);
+        LOAD_KEYMAP (FILEMANAGER, filemanager);
+        LOAD_KEYMAP (FILEMANAGER_EXT, filemanager_x);
         LOAD_KEYMAP (PANEL, panel);
         LOAD_KEYMAP (DIALOG, dialog);
         LOAD_KEYMAP (MENU, menu);
@@ -1384,8 +1385,8 @@ load_keymap_defs (gboolean load_from_file)
 #define SET_MAP(m) \
     m##_map = (global_keymap_t *) m##_keymap->data
 
-    SET_MAP (main);
-    SET_MAP (main_x);
+    SET_MAP (filemanager);
+    SET_MAP (filemanager_x);
     SET_MAP (panel);
     SET_MAP (dialog);
     SET_MAP (menu);
@@ -1419,8 +1420,8 @@ free_keymap_defs (void)
     if (km##_keymap != NULL) \
         g_array_free (km##_keymap, TRUE)
 
-    FREE_KEYMAP (main);
-    FREE_KEYMAP (main_x);
+    FREE_KEYMAP (filemanager);
+    FREE_KEYMAP (filemanager_x);
     FREE_KEYMAP (panel);
     FREE_KEYMAP (dialog);
     FREE_KEYMAP (menu);
diff --git a/src/setup.h b/src/setup.h
index 7de0fe393..5a430a6c8 100644
--- a/src/setup.h
+++ b/src/setup.h
@@ -73,7 +73,7 @@ struct mc_fhl_struct;
 
 /*** global variables defined in .c file *********************************************************/
 
-/* global paremeters */
+/* global parameters */
 extern char *global_profile_name;
 extern gboolean confirm_delete;
 extern gboolean confirm_directory_hotlist_delete;
diff --git a/src/subshell/common.c b/src/subshell/common.c
index 06699233c..02ae85211 100644
--- a/src/subshell/common.c
+++ b/src/subshell/common.c
@@ -9,25 +9,26 @@
    Aliaksey Kandratsenka <alk@tut.by>
    Andreas Mohr <and@gmx.li>
    Andrew Borodin <aborodin@vmail.ru>
-   Andrew Borodin <borodin@borodin.zarya>
    Andrew V. Samoilov <sav@bcs.zp.ua>
    Chris Owen <chris@candu.co.uk>
    Claes Nästén <me@pekdon.net>
    Egmont Koblinger <egmont@gmail.com>
    Enrico Weigelt, metux IT service <weigelt@metux.de>
+   Eric Roberts <ericmrobertsdeveloper@gmail.com>
    Igor Urazov <z0rc3r@gmail.com>
    Ilia Maslakov <il.smind@gmail.com>
    Leonard den Ottolander <leonard@den.ottolander.nl>
    Miguel de Icaza <miguel@novell.com>
    Mikhail S. Pobolovets <styx.mp@gmail.com>
    Norbert Warmuth <nwarmuth@privat.circular.de>
+   Oswald Buddenhagen <oswald.buddenhagen@gmx.de>
    Patrick Winnertz <winnie@debian.org>
    Pavel Machek <pavel@suse.cz>
    Pavel Roskin <proski@gnu.org>
    Pavel Tsekov <ptsekov@gmx.net>
    Roland Illig <roland.illig@gmx.de>
    Sergei Trofimovich <slyfox@inbox.ru>
-   Slava Zanko <slavazanko@gmail.com>, 2013,2015.
+   Slava Zanko <slavazanko@gmail.com>
    Timur Bakeyev <mc@bat.ru>
    Vit Rosin <vit_r@list.ru>
 
@@ -105,6 +106,9 @@
 #include "lib/util.h"
 #include "lib/widget.h"
 
+#include "src/filemanager/layout.h"     /* setup_cmdline() */
+#include "src/filemanager/command.h"    /* cmdline */
+
 #include "subshell.h"
 #include "internal.h"
 
@@ -123,6 +127,10 @@ GString *subshell_prompt = NULL;
 /* We need to paint it after CONSOLE_RESTORE, see: load_prompt */
 gboolean update_subshell_prompt = FALSE;
 
+/* If set, then a command has just finished executing, and we need */
+/* to be on the lookout for a new prompt string from the subshell. */
+gboolean should_read_new_subshell_prompt;
+
 /*** file scope macro definitions ****************************************************************/
 
 #ifndef WEXITSTATUS
@@ -151,6 +159,14 @@ enum
     WRITE = 1
 };
 
+/* This is the keybinding that is sent to the shell, to make the shell send us the contents of
+ * the current command buffer. */
+#define SHELL_BUFFER_KEYBINDING "_"
+
+/* This is the keybinding that is sent to the shell, to make the shell send us the location of
+ * the cursor. */
+#define SHELL_CURSOR_KEYBINDING "+"
+
 /*** file scope variables ************************************************************************/
 
 /* tcsh closes all non-standard file descriptors, so we have to use a pipe */
@@ -169,6 +185,9 @@ static char pty_buffer[PTY_BUFFER_SIZE] = "\0";
 /* To pass CWD info from the subshell to MC */
 static int subshell_pipe[2];
 
+/* To pass command buffer info from the subshell to MC */
+static int command_buffer_pipe[2];
+
 /* The subshell's process ID */
 static pid_t subshell_pid = 1;
 
@@ -178,6 +197,17 @@ static char subshell_cwd[MC_MAXPATHLEN + 1];
 /* Flag to indicate whether the subshell is ready for next command */
 static int subshell_ready;
 
+/* Flag to indicate if the subshell supports the persistent buffer feature. */
+static gboolean use_persistent_buffer = FALSE;
+
+/* Flag to indicate if the contents of the subshell command line need to be cleared before */
+/* executing a command. This should only end up set to true if there is some sort of error. */
+/* This allows us to recover gracefully from an error. */
+static gboolean subshell_should_clear_command_line = FALSE;
+
+/* This is the local variable where the subshell prompt is stored while we are working on it. */
+static GString *subshell_prompt_temp_buffer = NULL;
+
 /* The following two flags can be changed by the SIGCHLD handler. This is */
 /* OK, because the 'int' type is updated atomically on all known machines */
 static volatile int subshell_alive, subshell_stopped;
@@ -353,7 +383,7 @@ init_subshell_child (const char *pty_name)
 
     /* Attach all our standard file descriptors to the pty */
 
-    /* This is done just before the fork, because stderr must still      */
+    /* This is done just before the exec, because stderr must still      */
     /* be connected to the real tty during the above error messages; */
     /* otherwise the user will never see them.                   */
 
@@ -362,6 +392,10 @@ init_subshell_child (const char *pty_name)
     dup2 (subshell_pty_slave, STDERR_FILENO);
 
     close (subshell_pipe[READ]);
+
+    if (use_persistent_buffer)
+        close (command_buffer_pipe[READ]);
+
     close (subshell_pty_slave); /* These may be FD_CLOEXEC, but just in case... */
     /* Close master side of pty.  This is important; apart from */
     /* freeing up the descriptor for use in the subshell, it also       */
@@ -468,6 +502,232 @@ synchronize (void)
     /* We can't do any better without modifying the shell(s) */
 }
 
+/* --------------------------------------------------------------------------------------------- */
+/* Get the contents of the current subshell command line buffer, and */
+/* transfer the contents to the panel command prompt. */
+
+static gboolean
+read_command_line_buffer (gboolean test_mode)
+{
+    char subshell_command_buffer[BUF_LARGE];
+    char subshell_cursor_buffer[BUF_SMALL];
+
+    fd_set read_set;
+    int i;
+    ssize_t bytes;
+    struct timeval subshell_prompt_timer = { 0, 0 };
+    int command_buffer_length;
+    int command_buffer_char_length;
+    int bash_version;
+    int cursor_position;
+    int maxfdp;
+    int rc;
+
+    if (!use_persistent_buffer)
+        return TRUE;
+
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+    maxfdp = command_buffer_pipe[READ];
+
+    /* First, flush the command buffer pipe. This pipe shouldn't be written
+     * to under normal circumstances, but if it somehow does get written
+     * to, we need to make sure to discard whatever data is there before
+     * we try to use it. */
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 0)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 1)
+        {
+            bytes = read (command_buffer_pipe[READ], subshell_command_buffer,
+                          sizeof (subshell_command_buffer));
+            (void) bytes;
+        }
+    }
+
+    /* get contents of command line buffer */
+    write_all (mc_global.tty.subshell_pty, ESC_STR SHELL_BUFFER_KEYBINDING,
+               sizeof (ESC_STR SHELL_CURSOR_KEYBINDING) - 1);
+
+    subshell_prompt_timer.tv_sec = 1;
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 1)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 0)
+            return FALSE;
+    }
+
+    bytes =
+        read (command_buffer_pipe[READ], subshell_command_buffer, sizeof (subshell_command_buffer));
+    if (bytes == 0 || bytes == sizeof (subshell_command_buffer))
+        return FALSE;
+
+    command_buffer_char_length = bytes - 1;
+    subshell_command_buffer[command_buffer_char_length] = '\0';
+    command_buffer_length = str_length (subshell_command_buffer);
+
+    /* get cursor position */
+    write_all (mc_global.tty.subshell_pty, ESC_STR SHELL_CURSOR_KEYBINDING,
+               sizeof (ESC_STR SHELL_CURSOR_KEYBINDING) - 1);
+
+    subshell_prompt_timer.tv_sec = 1;
+    subshell_prompt_timer.tv_usec = 0;
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 1)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 0)
+            return FALSE;
+    }
+
+    bytes =
+        read (command_buffer_pipe[READ], subshell_cursor_buffer, sizeof (subshell_cursor_buffer));
+    if (bytes == 0)
+        return FALSE;
+
+    subshell_cursor_buffer[bytes - 1] = '\0';
+    if (mc_global.shell->type == SHELL_BASH)
+    {
+        if (sscanf (subshell_cursor_buffer, "%d:%d", &bash_version, &cursor_position) != 2)
+            return FALSE;
+    }
+    else
+    {
+        if (sscanf (subshell_cursor_buffer, "%d", &cursor_position) != 1)
+            return FALSE;
+        bash_version = 1000;
+    }
+
+    if (test_mode)
+        return TRUE;
+
+    /* Substitute non-text characters in the command buffer, such as tab, or newline, as this
+     * could cause problems. */
+    for (i = 0; i < command_buffer_char_length; i++)
+        if ((unsigned char) subshell_command_buffer[i] < 32
+            || (unsigned char) subshell_command_buffer[i] == 127)
+            subshell_command_buffer[i] = ' ';
+
+    input_assign_text (cmdline, "");
+    input_insert (cmdline, subshell_command_buffer, FALSE);
+
+    if (bash_version < 5)       /* implies SHELL_BASH */
+    {
+        /* We need to do this because bash < v5 gives the cursor position in a utf-8 string based
+         * on the location in bytes, not in unicode characters. */
+        char *curr, *stop;
+
+        curr = subshell_command_buffer;
+        stop = curr + cursor_position;
+
+        for (cursor_position = 0; curr < stop; cursor_position++)
+            str_next_char_safe (&curr);
+    }
+    if (cursor_position > command_buffer_length)
+        cursor_position = command_buffer_length;
+    cmdline->point = cursor_position;
+    /* We send any remaining data to STDOUT before we finish. */
+    flush_subshell (0, VISIBLY);
+
+    /* Now we erase the current contents of the command line buffer */
+    if (mc_global.shell->type != SHELL_ZSH)
+    {
+        /* In zsh, we can just press c-u to clear the line, without needing to go to the end of
+         * the line first first. In all other shells, we must go to the end of the line first. */
+
+        /* If we are not at the end of the line, we go to the end. */
+        if (cursor_position != command_buffer_length)
+        {
+            write_all (mc_global.tty.subshell_pty, "\005", 1);
+            if (flush_subshell (1, VISIBLY) != 1)
+                return FALSE;
+        }
+    }
+
+    if (command_buffer_length > 0)
+    {
+        /* Now we clear the line. */
+        write_all (mc_global.tty.subshell_pty, "\025", 1);
+        if (flush_subshell (1, VISIBLY) != 1)
+            return FALSE;
+    }
+
+    return TRUE;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+clear_subshell_prompt_string (void)
+{
+    if (subshell_prompt_temp_buffer != NULL)
+        g_string_set_size (subshell_prompt_temp_buffer, 0);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+parse_subshell_prompt_string (const char *buffer, int bytes)
+{
+    int i;
+
+    if (mc_global.mc_run_mode != MC_RUN_FULL)
+        return;
+
+    /* First time through */
+    if (subshell_prompt == NULL)
+        subshell_prompt = g_string_sized_new (INITIAL_PROMPT_SIZE);
+    if (subshell_prompt_temp_buffer == NULL)
+        subshell_prompt_temp_buffer = g_string_sized_new (INITIAL_PROMPT_SIZE);
+
+    /* Extract the prompt from the shell output */
+    for (i = 0; i < bytes; i++)
+        if (buffer[i] == '\n' || buffer[i] == '\r')
+            g_string_set_size (subshell_prompt_temp_buffer, 0);
+        else if (buffer[i] != '\0')
+            g_string_append_c (subshell_prompt_temp_buffer, buffer[i]);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+set_prompt_string (void)
+{
+    if (mc_global.mc_run_mode != MC_RUN_FULL)
+        return;
+
+    if (subshell_prompt_temp_buffer->len != 0)
+        g_string_assign (subshell_prompt, subshell_prompt_temp_buffer->str);
+
+    setup_cmdline ();
+}
+
 /* --------------------------------------------------------------------------------------------- */
 /** Feed the subshell our keyboard input until it says it's finished */
 
@@ -481,6 +741,9 @@ feed_subshell (int how, gboolean fail_on_error)
     struct timeval wtime;       /* Maximum time we wait for the subshell */
     struct timeval *wptr;
 
+    should_read_new_subshell_prompt = FALSE;
+    subshell_should_clear_command_line = FALSE;
+
     /* we wait up to 10 seconds if fail_on_error, forever otherwise */
     wtime.tv_sec = 10;
     wtime.tv_usec = 0;
@@ -549,6 +812,9 @@ feed_subshell (int how, gboolean fail_on_error)
 
             if (how == VISIBLY)
                 write_all (STDOUT_FILENO, pty_buffer, bytes);
+
+            if (should_read_new_subshell_prompt)
+                parse_subshell_prompt_string (pty_buffer, bytes);
         }
 
         else if (FD_ISSET (subshell_pipe[READ], &read_set))
@@ -563,10 +829,12 @@ feed_subshell (int how, gboolean fail_on_error)
                 exit (EXIT_FAILURE);
             }
 
-            subshell_cwd[bytes - 1] = 0;        /* Squash the final '\n' */
+            subshell_cwd[bytes - 1] = '\0';     /* Squash the final '\n' */
 
             synchronize ();
 
+            clear_subshell_prompt_string ();
+            should_read_new_subshell_prompt = TRUE;
             subshell_ready = TRUE;
             if (subshell_state == RUNNING_COMMAND)
             {
@@ -578,6 +846,7 @@ feed_subshell (int how, gboolean fail_on_error)
         else if (FD_ISSET (STDIN_FILENO, &read_set))
             /* Read from stdin, write to the subshell */
         {
+            should_read_new_subshell_prompt = FALSE;
             bytes = read (STDIN_FILENO, pty_buffer, sizeof (pty_buffer));
             if (bytes <= 0)
             {
@@ -591,15 +860,33 @@ feed_subshell (int how, gboolean fail_on_error)
                 if (pty_buffer[i] == subshell_switch_key)
                 {
                     write_all (mc_global.tty.subshell_pty, pty_buffer, i);
+
                     if (subshell_ready)
+                    {
                         subshell_state = INACTIVE;
+                        set_prompt_string ();
+                        if (subshell_ready && !read_command_line_buffer (FALSE))
+                        {
+                            /* If we got here, some unforseen error must have occurred. */
+                            flush_subshell (0, VISIBLY);
+                            input_assign_text (cmdline, "");
+                            subshell_should_clear_command_line = TRUE;
+                        }
+                    }
+
                     return TRUE;
                 }
 
             write_all (mc_global.tty.subshell_pty, pty_buffer, bytes);
 
             if (pty_buffer[bytes - 1] == '\n' || pty_buffer[bytes - 1] == '\r')
+            {
+                /* We should only clear the command line if we are using a shell that works
+                 * with persistent command buffer, otherwise we get awkward results. */
+                if (use_persistent_buffer)
+                    input_assign_text (cmdline, "");
                 subshell_ready = FALSE;
+            }
         }
         else
             return FALSE;
@@ -784,8 +1071,13 @@ init_subshell_precmd (char *precmd, size_t buff_size)
     {
     case SHELL_BASH:
         g_snprintf (precmd, buff_size,
+                    " mc_print_command_buffer () { printf \"%%s\\\\n\" \"$READLINE_LINE\" >&%d; }\n"
+                    " bind -x '\"\\e" SHELL_BUFFER_KEYBINDING "\":\"mc_print_command_buffer\"'\n"
+                    " bind -x '\"\\e" SHELL_CURSOR_KEYBINDING
+                    "\":\"echo $BASH_VERSINFO:$READLINE_POINT >&%d\"'\n"
                     " PROMPT_COMMAND=${PROMPT_COMMAND:+$PROMPT_COMMAND\n}'pwd>&%d;kill -STOP $$'\n"
-                    "PS1='\\u@\\h:\\w\\$ '\n", subshell_pipe[WRITE]);
+                    "PS1='\\u@\\h:\\w\\$ '\n", command_buffer_pipe[WRITE],
+                    command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     case SHELL_ASH_BUSYBOX:
@@ -800,7 +1092,7 @@ init_subshell_precmd (char *precmd, size_t buff_size)
          *    "PS1='$(precmd)\\u@\\h:\\w\\$ '\n",
          *
          * C: This works if user calls "ash" command because in sub-subshell
-         *    PRECMD is unfedined, thus evaluated to empty string - no damage done.
+         *    PRECMD is undefined, thus evaluated to empty string - no damage done.
          *    Attention: BusyBox must be built with FEATURE_EDITING_FANCY_PROMPT to
          *    permit \u, \w, \h, \$ escape sequences. Unfortunately this cannot be guaranteed,
          *    especially on embedded systems where people try to save space, so let's use
@@ -844,25 +1136,33 @@ init_subshell_precmd (char *precmd, size_t buff_size)
 
     case SHELL_ZSH:
         g_snprintf (precmd, buff_size,
+                    " mc_print_command_buffer () { printf \"%%s\\\\n\" \"$BUFFER\" >&%d; }\n"
+                    " zle -N mc_print_command_buffer\n"
+                    " bindkey '^[" SHELL_BUFFER_KEYBINDING "' mc_print_command_buffer\n"
+                    " mc_print_cursor_position () { echo $CURSOR >&%d}\n"
+                    " zle -N mc_print_cursor_position\n"
+                    " bindkey '^[" SHELL_CURSOR_KEYBINDING "' mc_print_cursor_position\n"
                     " _mc_precmd(){ pwd>&%d;kill -STOP $$ }; precmd_functions+=(_mc_precmd)\n"
-                    "PS1='%%n@%%m:%%~%%# '\n", subshell_pipe[WRITE]);
+                    "PS1='%%n@%%m:%%~%%# '\n",
+                    command_buffer_pipe[WRITE], command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     case SHELL_TCSH:
         g_snprintf (precmd, buff_size,
                     "set echo_style=both; "
                     "set prompt='%%n@%%m:%%~%%# '; "
-                    "alias precmd 'echo $cwd:q >>%s; kill -STOP $$'\n", tcsh_fifo);
+                    "alias precmd 'echo -n;echo $cwd:q >>%s; kill -STOP $$'\n", tcsh_fifo);
         break;
-
     case SHELL_FISH:
         g_snprintf (precmd, buff_size,
-                    " if not functions -q fish_prompt_mc;"
+                    " bind \\e" SHELL_BUFFER_KEYBINDING " 'commandline >&%d';"
+                    "bind \\e" SHELL_CURSOR_KEYBINDING " 'commandline -C >&%d';"
+                    "if not functions -q fish_prompt_mc;"
                     "functions -e fish_right_prompt;"
                     "functions -c fish_prompt fish_prompt_mc; end;"
                     "function fish_prompt;"
                     "echo \"$PWD\">&%d; fish_prompt_mc; kill -STOP %%self; end\n",
-                    subshell_pipe[WRITE]);
+                    command_buffer_pipe[WRITE], command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     default:
@@ -1034,7 +1334,18 @@ init_subshell (void)
                 return;
             }
         }
-        else if (pipe (subshell_pipe))  /* subshell_type is BASH, ASH_BUSYBOX, DASH or ZSH */
+        else if (pipe (subshell_pipe) != 0)     /* subshell_type is BASH, ASH_BUSYBOX, DASH or ZSH */
+        {
+            perror (__FILE__ ": couldn't create pipe");
+            mc_global.tty.use_subshell = FALSE;
+            return;
+        }
+
+        if (mc_global.mc_run_mode == MC_RUN_FULL &&
+            (mc_global.shell->type == SHELL_BASH || mc_global.shell->type == SHELL_ZSH
+             || mc_global.shell->type == SHELL_FISH))
+            use_persistent_buffer = TRUE;
+        if (use_persistent_buffer && pipe (command_buffer_pipe) != 0)
         {
             perror (__FILE__ ": couldn't create pipe");
             mc_global.tty.use_subshell = FALSE;
@@ -1071,12 +1382,17 @@ init_subshell (void)
     subshell_state = RUNNING_COMMAND;
     tty_enable_interrupt_key ();
     if (!feed_subshell (QUIETLY, TRUE))
-    {
         mc_global.tty.use_subshell = FALSE;
-    }
     tty_disable_interrupt_key ();
     if (!subshell_alive)
         mc_global.tty.use_subshell = FALSE;     /* Subshell died instantly, so don't use it */
+
+    /* Try out the persistent command buffer feature. If it doesn't work the first time, we
+     * assume there must be something wrong with the shell, and we turn persistent buffer off
+     * for good. This will save the user the trouble of having to wait for the persistent
+     * buffer function to time out every time they try to close the subshell. */
+    if (use_persistent_buffer && !read_command_line_buffer (TRUE))
+        use_persistent_buffer = FALSE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1100,10 +1416,45 @@ invoke_subshell (const char *command, int how, vfs_path_t ** new_dir_vpath)
             /* FIXME: possibly take out this hack; the user can re-play it by hitting C-hyphen a few times! */
             if (subshell_ready && mc_global.mc_run_mode == MC_RUN_FULL)
                 write_all (mc_global.tty.subshell_pty, " \b", 2);       /* Hack to make prompt reappear */
+
+            if (use_persistent_buffer)
+            {
+                size_t i;
+                int pos;
+
+                /* Check to make sure there are no non text characters in the command buffer,
+                 * such as tab, or newline, as this could cause problems. */
+                for (i = 0; cmdline->buffer[i] != '\0'; i++)
+                    if ((unsigned char) cmdline->buffer[i] < 32
+                        || (unsigned char) cmdline->buffer[i] == 127)
+                        cmdline->buffer[i] = ' ';
+
+                /* Write the command buffer to the subshell. */
+                write_all (mc_global.tty.subshell_pty, cmdline->buffer, strlen (cmdline->buffer));
+
+                /* Put the cursor in the correct place in the subshell. */
+                pos = str_length (cmdline->buffer) - cmdline->point;
+                for (i = 0; i < (size_t) pos; i++)
+                    write_all (mc_global.tty.subshell_pty, ESC_STR "[D", 3);
+            }
         }
     }
     else                        /* MC has passed us a user command */
     {
+        /* Before we write to the command prompt, we need to clear whatever */
+        /* data is there, but only if we are using one of the shells that */
+        /* doesn't support keeping command buffer contents, OR if there was */
+        /* some sort of error. */
+        if (!use_persistent_buffer || subshell_should_clear_command_line)
+        {
+            write_all (mc_global.tty.subshell_pty, "\003", 1);
+            subshell_state = RUNNING_COMMAND;
+            /* We need to call feed_subshell here if we are using fish, because of a quirk
+             * in the behavioral of that particular shell. */
+            if (mc_global.shell->type != SHELL_FISH)
+                feed_subshell (QUIETLY, FALSE);
+        }
+
         if (how == QUIETLY)
             write_all (mc_global.tty.subshell_pty, " ", 1);
         /* FIXME: if command is long (>8KB ?) we go comma */
@@ -1131,6 +1482,50 @@ invoke_subshell (const char *command, int how, vfs_path_t ** new_dir_vpath)
     return subshell_get_mainloop_quit ();
 }
 
+/* --------------------------------------------------------------------------------------------- */
+
+gboolean
+flush_subshell (int max_wait_length, int how)
+{
+    int rc = 0;
+    ssize_t bytes = 0;
+    struct timeval timeleft = { 0, 0 };
+    gboolean return_value = FALSE;
+    fd_set tmp;
+
+    timeleft.tv_sec = max_wait_length;
+    FD_ZERO (&tmp);
+    FD_SET (mc_global.tty.subshell_pty, &tmp);
+
+    while (subshell_alive
+           && (rc = select (mc_global.tty.subshell_pty + 1, &tmp, NULL, NULL, &timeleft)) != 0)
+    {
+        /* Check for 'select' errors */
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+            {
+                if (tty_got_winch ())
+                    tty_change_screen_size ();
+
+                continue;
+            }
+
+            fprintf (stderr, "select (FD_SETSIZE, &tmp...): %s\r\n", unix_error_string (errno));
+            exit (EXIT_FAILURE);
+        }
+
+        return_value = TRUE;
+        timeleft.tv_sec = 0;
+        timeleft.tv_usec = 0;
+
+        bytes = read (mc_global.tty.subshell_pty, pty_buffer, sizeof (pty_buffer));
+        if (how == VISIBLY)
+            write_all (STDOUT_FILENO, pty_buffer, bytes);
+    }
+
+    return return_value;
+}
 
 /* --------------------------------------------------------------------------------------------- */
 
@@ -1140,24 +1535,16 @@ read_subshell_prompt (void)
     int rc = 0;
     ssize_t bytes = 0;
     struct timeval timeleft = { 0, 0 };
-    GString *p;
-    gboolean prompt_was_reset = FALSE;
+    gboolean should_reset_prompt = TRUE;
+    gboolean got_new_prompt = FALSE;
 
     fd_set tmp;
     FD_ZERO (&tmp);
     FD_SET (mc_global.tty.subshell_pty, &tmp);
 
-    /* First time through */
-    if (subshell_prompt == NULL)
-        subshell_prompt = g_string_sized_new (INITIAL_PROMPT_SIZE);
-
-    p = g_string_sized_new (INITIAL_PROMPT_SIZE);
-
     while (subshell_alive
            && (rc = select (mc_global.tty.subshell_pty + 1, &tmp, NULL, NULL, &timeleft)) != 0)
     {
-        ssize_t i;
-
         /* Check for 'select' errors */
         if (rc == -1)
         {
@@ -1174,22 +1561,18 @@ read_subshell_prompt (void)
         }
 
         bytes = read (mc_global.tty.subshell_pty, pty_buffer, sizeof (pty_buffer));
+        if (should_reset_prompt)
+        {
+            should_reset_prompt = FALSE;
+            clear_subshell_prompt_string ();
+        }
 
-        /* Extract the prompt from the shell output */
-        for (i = 0; i < bytes; i++)
-            if (pty_buffer[i] == '\n' || pty_buffer[i] == '\r')
-            {
-                g_string_set_size (p, 0);
-                prompt_was_reset = TRUE;
-            }
-            else if (pty_buffer[i] != '\0')
-                g_string_append_c (p, pty_buffer[i]);
+        parse_subshell_prompt_string (pty_buffer, bytes);
+        got_new_prompt = TRUE;
     }
 
-    if (p->len != 0 || prompt_was_reset)
-        g_string_assign (subshell_prompt, p->str);
-
-    g_string_free (p, TRUE);
+    if (got_new_prompt)
+        set_prompt_string ();
 
     return (rc != 0 || bytes != 0);
 }
@@ -1229,8 +1612,18 @@ exit_subshell (void)
                          tcsh_fifo, unix_error_string (errno));
         }
 
-        g_string_free (subshell_prompt, TRUE);
-        subshell_prompt = NULL;
+        if (subshell_prompt != NULL)
+        {
+            g_string_free (subshell_prompt, TRUE);
+            subshell_prompt = NULL;
+        }
+
+        if (subshell_prompt_temp_buffer != NULL)
+        {
+            g_string_free (subshell_prompt_temp_buffer, TRUE);
+            subshell_prompt_temp_buffer = NULL;
+        }
+
         pty_buffer[0] = '\0';
     }
 
@@ -1259,6 +1652,15 @@ do_subshell_chdir (const vfs_path_t * vpath, gboolean update_prompt)
         return;
     }
 
+    /* If we are using a shell that doesn't support persistent command buffer, we need to clear
+     * the command prompt before we send the cd command. */
+    if (!use_persistent_buffer || subshell_should_clear_command_line)
+    {
+        write_all (mc_global.tty.subshell_pty, "\003", 1);
+        subshell_state = RUNNING_COMMAND;
+        if (mc_global.shell->type != SHELL_FISH)
+            feed_subshell (QUIETLY, FALSE);
+    }
     /* The initial space keeps this out of the command history (in bash
        because we set "HISTCONTROL=ignorespace") */
     write_all (mc_global.tty.subshell_pty, " cd ", 4);
diff --git a/src/subshell/proxyfunc.c b/src/subshell/proxyfunc.c
index e3e00350b..5c315b248 100644
--- a/src/subshell/proxyfunc.c
+++ b/src/subshell/proxyfunc.c
@@ -34,7 +34,7 @@
 #include "lib/vfs/vfs.h"        /* vfs_get_raw_current_dir() */
 
 #include "src/setup.h"          /* quit */
-#include "src/filemanager/midnight.h"   /* current_panel */
+#include "src/filemanager/filemanager.h"        /* current_panel */
 #include "src/consaver/cons.saver.h"    /* handle_console() */
 
 #include "internal.h"
diff --git a/src/subshell/subshell.h b/src/subshell/subshell.h
index e0fdfb13e..bde19c469 100644
--- a/src/subshell/subshell.h
+++ b/src/subshell/subshell.h
@@ -36,10 +36,13 @@ extern GString *subshell_prompt;
 
 extern gboolean update_subshell_prompt;
 
+extern gboolean should_read_new_subshell_prompt;
+
 /*** declarations of public functions ************************************************************/
 
 void init_subshell (void);
 int invoke_subshell (const char *command, int how, vfs_path_t ** new_dir);
+gboolean flush_subshell (int max_wait_length, int how);
 gboolean read_subshell_prompt (void);
 void do_update_prompt (void);
 gboolean exit_subshell (void);
diff --git a/src/usermenu.c b/src/usermenu.c
index 698244220..1fecbeaac 100644
--- a/src/usermenu.c
+++ b/src/usermenu.c
@@ -54,7 +54,7 @@
 #include "src/history.h"
 
 #include "src/filemanager/dir.h"
-#include "src/filemanager/midnight.h"
+#include "src/filemanager/filemanager.h"
 #include "src/filemanager/layout.h"
 
 #include "usermenu.h"
diff --git a/src/vfs/cpio/cpio.c b/src/vfs/cpio/cpio.c
index 774fdf356..3e0320973 100644
--- a/src/vfs/cpio/cpio.c
+++ b/src/vfs/cpio/cpio.c
@@ -603,11 +603,12 @@ cpio_read_bin_head (struct vfs_class *me, struct vfs_s_super *super)
 #ifdef HAVE_STRUCT_STAT_ST_RDEV
     st.st_rdev = u.buf.c_rdev;
 #endif
-    st.st_size = (u.buf.c_filesizes[0] << 16) | u.buf.c_filesizes[1];
+    st.st_size = ((off_t) u.buf.c_filesizes[0] << 16) | u.buf.c_filesizes[1];
 #ifdef HAVE_STRUCT_STAT_ST_MTIM
     st.st_atim.tv_nsec = st.st_mtim.tv_nsec = st.st_ctim.tv_nsec = 0;
 #endif
-    st.st_atime = st.st_mtime = st.st_ctime = (u.buf.c_mtimes[0] << 16) | u.buf.c_mtimes[1];
+    st.st_atime = st.st_mtime = st.st_ctime =
+        ((time_t) u.buf.c_mtimes[0] << 16) | u.buf.c_mtimes[1];
 
     return cpio_create_entry (me, super, &st, name);
 }
diff --git a/src/vfs/extfs/extfs.c b/src/vfs/extfs/extfs.c
index 0fcef04ba..e963ae7d3 100644
--- a/src/vfs/extfs/extfs.c
+++ b/src/vfs/extfs/extfs.c
@@ -200,15 +200,14 @@ extfs_generate_entry (struct extfs_super_t *archive, const char *name, struct vf
     struct vfs_s_inode *inode;
     struct vfs_s_entry *entry;
 
+    memset (&st, 0, sizeof (st));
     st.st_ino = VFS_SUPER (archive)->ino_usage++;
     st.st_dev = archive->rdev;
     myumask = umask (022);
     umask (myumask);
     st.st_mode = mode & ~myumask;
-    st.st_rdev = 0;
     st.st_uid = getuid ();
     st.st_gid = getgid ();
-    st.st_size = 0;
     st.st_mtime = time (NULL);
     st.st_atime = st.st_mtime;
     st.st_ctime = st.st_mtime;
@@ -373,6 +372,26 @@ extfs_free_archive (struct vfs_class *me, struct vfs_s_super *psup)
 
 /* --------------------------------------------------------------------------------------------- */
 
+static inline char *
+extfs_skip_leading_dotslash (char *s)
+{
+    /* Skip leading "./" (if present).
+     * Some programs don't understand it:
+     *
+     * $ zip file.zip ./-file2.txt file1.txt
+     *   adding: -file2.txt (stored 0%)
+     *   adding: file1.txt (stored 0%)
+     * $ /usr/lib/mc/extfs.d/uzip copyout file.zip ./-file2.txt ./tmp-file2.txt
+     * caution: filename not matched:  ./-file2.txt
+     */
+    if (s[0] == '.' && s[1] == PATH_SEP)
+        s += 2;
+
+    return s;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 static FILE *
 extfs_open_archive (int fstype, const char *name, struct extfs_super_t **pparc)
 {
@@ -388,6 +407,8 @@ extfs_open_archive (int fstype, const char *name, struct extfs_super_t **pparc)
     vfs_path_t *local_name_vpath = NULL;
     vfs_path_t *name_vpath;
 
+    memset (&mystat, 0, sizeof (mystat));
+
     name_vpath = vfs_path_from_str (name);
     info = &g_array_index (extfs_plugins, extfs_plugin_info_t, fstype);
 
@@ -486,6 +507,7 @@ extfs_read_archive (FILE * extfsd, struct extfs_super_t *current_archive)
 
             if (*cfn != '\0')
             {
+                cfn = extfs_skip_leading_dotslash (cfn);
                 if (IS_PATH_SEP (*cfn))
                     cfn++;
                 p = strchr (cfn, '\0');
@@ -542,14 +564,13 @@ extfs_read_archive (FILE * extfsd, struct extfs_super_t *current_archive)
                 {
                     struct stat st;
 
+                    memset (&st, 0, sizeof (st));
                     st.st_ino = super->ino_usage++;
                     st.st_nlink = 1;
                     st.st_dev = current_archive->rdev;
                     st.st_mode = hstat.st_mode;
 #ifdef HAVE_STRUCT_STAT_ST_RDEV
                     st.st_rdev = hstat.st_rdev;
-#else
-                    st.st_rdev = 0;
 #endif
                     st.st_uid = hstat.st_uid;
                     st.st_gid = hstat.st_gid;
@@ -812,13 +833,16 @@ extfs_cmd (const char *str_extfs_cmd, const struct extfs_super_t *archive,
     quoted_file = name_quote (file, FALSE);
     g_free (file);
 
+    /* Skip leading "./" (if present) added in name_quote() */
+    file = extfs_skip_leading_dotslash (quoted_file);
+
     archive_name = extfs_get_archive_name (archive);
     quoted_archive_name = name_quote (archive_name, FALSE);
     g_free (archive_name);
     quoted_localname = name_quote (localname, FALSE);
     info = &g_array_index (extfs_plugins, extfs_plugin_info_t, archive->fstype);
     cmd = g_strconcat (info->path, info->prefix, str_extfs_cmd,
-                       quoted_archive_name, " ", quoted_file, " ", quoted_localname, (char *) NULL);
+                       quoted_archive_name, " ", file, " ", quoted_localname, (char *) NULL);
     g_free (quoted_file);
     g_free (quoted_localname);
     g_free (quoted_archive_name);
@@ -1023,20 +1047,20 @@ extfs_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 extfs_readdir (void *data)
 {
-    static union vfs_dirent dir;
+    struct vfs_dirent *dir;
     GList **info = (GList **) data;
 
     if (*info == NULL)
         return NULL;
 
-    g_strlcpy (dir.dent.d_name, VFS_ENTRY ((*info)->data)->name, MC_MAXPATHLEN);
+    dir = vfs_dirent_init (NULL, VFS_ENTRY ((*info)->data)->name, 0);   /* FIXME: inode */
 
     *info = g_list_next (*info);
 
-    return (void *) &dir;
+    return dir;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/extfs/helpers/Makefile.am b/src/vfs/extfs/helpers/Makefile.am
index ff8116d80..f1ea0acc3 100644
--- a/src/vfs/extfs/helpers/Makefile.am
+++ b/src/vfs/extfs/helpers/Makefile.am
@@ -31,7 +31,9 @@ EXTFS_IN    = 			\
 	uha.in			\
 	ulha.in			\
 	ulib.in			\
+	unar.in			\
 	urar.in			\
+	uwim.in			\
 	uzip.in			\
 	uzoo.in
 
@@ -60,7 +62,9 @@ EXTFS_OUT = 			\
 	uha			\
 	ulha			\
 	ulib			\
+	unar			\
 	urar			\
+	uwim			\
 	uzip			\
 	uzoo
 
diff --git a/src/vfs/extfs/helpers/README.extfs b/src/vfs/extfs/helpers/README.extfs
index 22ac8dfbb..ce7d0867c 100644
--- a/src/vfs/extfs/helpers/README.extfs
+++ b/src/vfs/extfs/helpers/README.extfs
@@ -73,3 +73,6 @@ patchsetfs - list of patches of current file
 
 # Gputils lib archives.
 ulib
+
+# PAK Archive
+unar
diff --git a/src/vfs/extfs/helpers/iso9660.in b/src/vfs/extfs/helpers/iso9660.in
index f9c6e50ef..f1124a5a1 100644
--- a/src/vfs/extfs/helpers/iso9660.in
+++ b/src/vfs/extfs/helpers/iso9660.in
@@ -43,7 +43,7 @@ xorriso_list() {
     r=$?
     test $r -gt 0 && return $r
 
-    echo "$lsl" | @GREP@ "^[-d]" | \
+    echo "$lsl" | grep "^[-d]" | \
     while read attr ln usr gr sz dt1 dt2 dt3 nm ; do
         len=$((${#nm} - 1))
         name=$(printf -- "$nm" | cut -c2-$len)  # remove quotes
@@ -97,11 +97,11 @@ test_iso () {
 
     CHARSET=$(locale charmap 2>/dev/null)
     if test -z "$CHARSET"; then
-        CHARSET=$(locale 2>/dev/null | @GREP@ LC_CTYPE | sed -n -e 's/.*\.\(.*\)"$/\1/p')
+        CHARSET=$(locale 2>/dev/null | grep LC_CTYPE | sed -n -e 's/.*\.\(.*\)"$/\1/p')
     fi
     if test -n "$CHARSET"; then
         CHARSET=$(echo "$CHARSET" | tr '[A-Z]' '[a-z]' | sed -e 's/^iso-/iso/')
-        isoinfo -j $CHARSET -i /dev/null 2>&1 | @GREP@ "Iconv not yet supported\|Unknown charset" >/dev/null && CHARSET=
+        isoinfo -j $CHARSET -i /dev/null 2>&1 | grep "Iconv not yet supported\|Unknown charset" >/dev/null && CHARSET=
     fi
     if test -n "$CHARSET"; then
         JOLIET_OPT="-j $CHARSET -J"
@@ -112,10 +112,10 @@ test_iso () {
 
     ISOINFO_D_I="$(isoinfo -d -i "$1" 2>/dev/null)"
 
-    echo "$ISOINFO_D_I" | @GREP@ "UCS level 1\|NO Joliet" > /dev/null || ISOINFO="$ISOINFO $JOLIET_OPT"
+    echo "$ISOINFO_D_I" | grep "UCS level 1\|NO Joliet" > /dev/null || ISOINFO="$ISOINFO $JOLIET_OPT"
 
-    if [ $(echo "$ISOINFO_D_I" | @GREP@ "Joliet with UCS level 3 found" | wc -l) = 1 \
-        -a $(echo "$ISOINFO_D_I" | @GREP@ "NO Rock Ridge" | wc -l) = 1 ] ; then
+    if [ $(echo "$ISOINFO_D_I" | grep "Joliet with UCS level 3 found" | wc -l) = 1 \
+        -a $(echo "$ISOINFO_D_I" | grep "NO Rock Ridge" | wc -l) = 1 ] ; then
         SEMICOLON="YES"
     fi
 }
diff --git a/src/vfs/extfs/helpers/unar.in b/src/vfs/extfs/helpers/unar.in
new file mode 100644
index 000000000..e81030733
diff --git a/src/vfs/extfs/helpers/urar.in b/src/vfs/extfs/helpers/urar.in
index 6742ac519..5453d3195 100644
--- a/src/vfs/extfs/helpers/urar.in
+++ b/src/vfs/extfs/helpers/urar.in
@@ -47,7 +47,7 @@ flag==1 {
     else
 	if (index($6, ".") != 0)
 	    $6="-rw-r--r--"
-    printf "%s 1 %s %s %d %02d/%02d/%02d %s %s\n", $6, uid, gid, $1, a[2], a[1], a[3], $5, str
+    printf "%s 1 %s %s %d %02d/%02d/%02d %s ./%s\n", $6, uid, gid, $1, a[2], a[1], a[3], $5, str
 }'
 }
 
@@ -105,7 +105,7 @@ mcrar5fs_list ()
         }
 
         ### and finally
-        printf ("%s 1 %s %s %d %02d/%02d/%02d %s %s\n",
+        printf ("%s 1 %s %s %d %02d/%02d/%02d %s ./%s\n",
                 attrs, uid, gid, size, date[2], date[3], date[1], time, name);
     }
 '
diff --git a/src/vfs/extfs/helpers/uwim.in b/src/vfs/extfs/helpers/uwim.in
new file mode 100644
index 000000000..bfaf22ee8
diff --git a/src/vfs/extfs/helpers/uzip.in b/src/vfs/extfs/helpers/uzip.in
index 22466db51..c468f3a9d 100644
--- a/src/vfs/extfs/helpers/uzip.in
+++ b/src/vfs/extfs/helpers/uzip.in
@@ -352,7 +352,7 @@ sub print_file {
 	if ($platform eq 'unx' && $filename =~ /\/$/ && $perms =~ /^\?(.*)$/) {
 		$perms = 'd'.$1;
 	}
-	printf "%-10s    1 %-8d %-8d %8s %s/%s/%s %s:%s:%s %s", $perms, $<,
+	printf "%-10s    1 %-8d %-8d %8s %s/%s/%s %s:%s:%s ./%s", $perms, $<,
 		$(, $realsize, $mon, $day, $year, $hours, $mins, $secs, $filename;
 	if ($platform eq 'unx' && $perms =~ /^l/) {
 		my $linkdest = &get_link_destination($filename);
diff --git a/src/vfs/fish/fish.c b/src/vfs/fish/fish.c
index 5cd279f95..313ad8a89 100644
--- a/src/vfs/fish/fish.c
+++ b/src/vfs/fish/fish.c
@@ -65,7 +65,6 @@
 #include "lib/fileloc.h"
 #include "lib/util.h"           /* my_exit() */
 #include "lib/mcconfig.h"
-#include "lib/timer.h"
 
 #include "src/execute.h"        /* pre_exec, post_exec */
 
@@ -489,7 +488,7 @@ fish_info (struct vfs_class *me, struct vfs_s_super *super)
         while (TRUE)
         {
             int res;
-            char buffer[BUF_8K];
+            char buffer[BUF_8K] = "";
 
             res = vfs_s_get_line_interruptible (me, buffer, sizeof (buffer), fish_super->sockr);
             if ((res == 0) || (res == EINTR))
@@ -766,7 +765,7 @@ fish_dir_load (struct vfs_class *me, struct vfs_s_inode *dir, char *remote_path)
 
     vfs_print_message (_("fish: Reading directory %s..."), remote_path);
 
-    dir->timestamp = mc_timer_elapsed (mc_global.timer) + fish_directory_timeout * G_USEC_PER_SEC;
+    dir->timestamp = g_get_real_time () + fish_directory_timeout * G_USEC_PER_SEC;
 
     quoted_path = strutils_shell_escape (remote_path);
     (void) fish_command_v (me, super, NONE, FISH_SUPER (super)->scr_ls, "FISH_FILENAME=%s;\n",
@@ -918,6 +917,7 @@ fish_dir_load (struct vfs_class *me, struct vfs_s_inode *dir, char *remote_path)
             {
                 struct tm tim;
 
+                memset (&tim, 0, sizeof (tim));
                 /* cppcheck-suppress invalidscanf */
                 if (sscanf (buffer + 1, "%d %d %d %d %d %d", &tim.tm_year, &tim.tm_mon,
                             &tim.tm_mday, &tim.tm_hour, &tim.tm_min, &tim.tm_sec) != 6)
@@ -939,6 +939,7 @@ fish_dir_load (struct vfs_class *me, struct vfs_s_inode *dir, char *remote_path)
                 ST.st_rdev = makedev (maj, min);
 #endif
             }
+            break;
         default:
             break;
         }
diff --git a/src/vfs/ftpfs/ftpfs.c b/src/vfs/ftpfs/ftpfs.c
index 8a841ac1a..4c02ba409 100644
--- a/src/vfs/ftpfs/ftpfs.c
+++ b/src/vfs/ftpfs/ftpfs.c
@@ -98,7 +98,6 @@ What to do with this?
 #include "lib/util.h"
 #include "lib/strutil.h"        /* str_move() */
 #include "lib/mcconfig.h"
-#include "lib/timer.h"
 
 #include "lib/tty/tty.h"        /* enable/disable interrupt key */
 #include "lib/widget.h"         /* message() */
@@ -1491,17 +1490,17 @@ ftpfs_linear_abort (struct vfs_class *me, vfs_file_handler_t * fh)
 
         if (select (dsock + 1, &mask, NULL, NULL, NULL) > 0)
         {
-            guint64 start_tim;
+            gint64 start_tim;
             char buf[BUF_8K];
 
-            start_tim = mc_timer_elapsed (mc_global.timer);
+            start_tim = g_get_real_time ();
 
             /* flush the remaining data */
             while (read (dsock, buf, sizeof (buf)) > 0)
             {
-                guint64 tim;
+                gint64 tim;
 
-                tim = mc_timer_elapsed (mc_global.timer);
+                tim = g_get_real_time ();
 
                 if (tim > start_tim + ABORT_TIMEOUT)
                 {
@@ -1748,7 +1747,7 @@ ftpfs_dir_load (struct vfs_class *me, struct vfs_s_inode *dir, char *remote_path
         return (-1);
     }
 
-    dir->timestamp = mc_timer_elapsed (mc_global.timer) + ftpfs_directory_timeout * G_USEC_PER_SEC;
+    dir->timestamp = g_get_real_time () + ftpfs_directory_timeout * G_USEC_PER_SEC;
 
     if (ftp_super->strict == RFC_STRICT)
         sock = ftpfs_open_data_connection (me, super, "LIST", 0, TYPE_ASCII, 0);
diff --git a/src/vfs/local/local.c b/src/vfs/local/local.c
index 717868ad4..ee7c2832d 100644
--- a/src/vfs/local/local.c
+++ b/src/vfs/local/local.c
@@ -87,13 +87,30 @@ static void *
 local_opendir (const vfs_path_t * vpath)
 {
     DIR **local_info;
-    DIR *dir;
+    DIR *dir = NULL;
     const vfs_path_element_t *path_element;
 
     path_element = vfs_path_get_by_index (vpath, -1);
-    dir = opendir (path_element->path);
-    if (dir == NULL)
-        return 0;
+
+    /* On Linux >= 5.1, MC sometimes shows empty directpries on mounted CIFS shares.
+     * Rereading directory restores the directory content.
+     *
+     * Reopen directory, if first readdir() returns NULL and errno == EINTR.
+     */
+    while (dir == NULL)
+    {
+        dir = opendir (path_element->path);
+        if (dir == NULL)
+            return NULL;
+
+        if (readdir (dir) == NULL && errno == EINTR)
+        {
+            closedir (dir);
+            dir = NULL;
+        }
+        else
+            rewinddir (dir);
+    }
 
     local_info = (DIR **) g_new (DIR *, 1);
     *local_info = dir;
@@ -103,10 +120,14 @@ local_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 local_readdir (void *data)
 {
-    return readdir (*(DIR **) data);
+    struct dirent *d;
+
+    d = readdir (*(DIR **) data);
+
+    return (d != NULL ? vfs_dirent_init (NULL, d->d_name, d->d_ino) : NULL);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/sftpfs/dir.c b/src/vfs/sftpfs/dir.c
index 67b7f29ee..63a397f39 100644
--- a/src/vfs/sftpfs/dir.c
+++ b/src/vfs/sftpfs/dir.c
@@ -115,13 +115,12 @@ sftpfs_opendir (const vfs_path_t * vpath, GError ** mcerror)
  * @return information about direntry if success, NULL otherwise
  */
 
-void *
+struct vfs_dirent *
 sftpfs_readdir (void *data, GError ** mcerror)
 {
     char mem[BUF_MEDIUM];
     LIBSSH2_SFTP_ATTRIBUTES attrs;
     sftpfs_dir_data_t *sftpfs_dir = (sftpfs_dir_data_t *) data;
-    static union vfs_dirent sftpfs_dirent;
     int rc;
 
     mc_return_val_if_error (mcerror, NULL);
@@ -137,11 +136,7 @@ sftpfs_readdir (void *data, GError ** mcerror)
     }
     while (rc == LIBSSH2_ERROR_EAGAIN);
 
-    if (rc == 0)
-        return NULL;
-
-    g_strlcpy (sftpfs_dirent.dent.d_name, mem, BUF_MEDIUM);
-    return &sftpfs_dirent;
+    return (rc != 0 ? vfs_dirent_init (NULL, mem, 0) : NULL);   /* FIXME: inode */
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/sftpfs/internal.h b/src/vfs/sftpfs/internal.h
index 84b9d523e..d2398c4ed 100644
--- a/src/vfs/sftpfs/internal.h
+++ b/src/vfs/sftpfs/internal.h
@@ -91,7 +91,7 @@ void sftpfs_close_connection (struct vfs_s_super *super, const char *shutdown_me
 vfs_file_handler_t *sftpfs_fh_new (struct vfs_s_inode *ino, gboolean changed);
 
 void *sftpfs_opendir (const vfs_path_t * vpath, GError ** mcerror);
-void *sftpfs_readdir (void *data, GError ** mcerror);
+struct vfs_dirent *sftpfs_readdir (void *data, GError ** mcerror);
 int sftpfs_closedir (void *data, GError ** mcerror);
 int sftpfs_mkdir (const vfs_path_t * vpath, mode_t mode, GError ** mcerror);
 int sftpfs_rmdir (const vfs_path_t * vpath, GError ** mcerror);
diff --git a/src/vfs/sftpfs/vfs_class.c b/src/vfs/sftpfs/vfs_class.c
index 712cc1936..66be5ed4d 100644
--- a/src/vfs/sftpfs/vfs_class.c
+++ b/src/vfs/sftpfs/vfs_class.c
@@ -188,11 +188,11 @@ sftpfs_cb_opendir (const vfs_path_t * vpath)
  * @return information about direntry if success, NULL otherwise
  */
 
-static void *
+static struct vfs_dirent *
 sftpfs_cb_readdir (void *data)
 {
     GError *mcerror = NULL;
-    union vfs_dirent *sftpfs_dirent;
+    struct vfs_dirent *sftpfs_dirent;
 
     if (tty_got_interrupt ())
     {
@@ -204,7 +204,7 @@ sftpfs_cb_readdir (void *data)
     if (!mc_error_message (&mcerror, NULL))
     {
         if (sftpfs_dirent != NULL)
-            vfs_print_message (_("sftp: (Ctrl-G break) Listing... %s"), sftpfs_dirent->dent.d_name);
+            vfs_print_message (_("sftp: (Ctrl-G break) Listing... %s"), sftpfs_dirent->d_name);
         else
             vfs_print_message ("%s", _("sftp: Listing done."));
     }
diff --git a/src/vfs/smbfs/helpers/include/includes.h b/src/vfs/smbfs/helpers/include/includes.h
index 9cce9309d..b7bb9bce6 100644
--- a/src/vfs/smbfs/helpers/include/includes.h
+++ b/src/vfs/smbfs/helpers/include/includes.h
@@ -189,7 +189,7 @@
 #include <sys/fs/s5param.h>
 #endif
 
-#if defined (HAVE_SYS_FILSYS_H) && !defined (_CRAY)
+#ifdef HAVE_SYS_FILSYS_H
 #include <sys/filsys.h>
 #endif
 
diff --git a/src/vfs/smbfs/smbfs.c b/src/vfs/smbfs/smbfs.c
index e91a18fbd..841e4c430 100644
--- a/src/vfs/smbfs/smbfs.c
+++ b/src/vfs/smbfs/smbfs.c
@@ -915,11 +915,10 @@ smbfs_free_dir (dir_entry * de)
 /* It's too slow to ask the server each time */
 /* It now also sends the complete lstat information for each file */
 
-static void *
+static struct vfs_dirent *
 smbfs_readdir (void *info)
 {
-    static union vfs_dirent smbfs_readdir_data;
-    static char *const dirent_dest = smbfs_readdir_data.dent.d_name;
+    struct vfs_dirent *dirent;
     opendir_info *smbfs_info = (opendir_info *) info;
 
     DEBUG (4, ("smbfs_readdir(%s)\n", smbfs_info->dirname));
@@ -937,10 +936,12 @@ smbfs_readdir (void *info)
 #endif
         return NULL;
     }
-    g_strlcpy (dirent_dest, smbfs_info->current->text, MC_MAXPATHLEN);
+
+    dirent = vfs_dirent_init (NULL, smbfs_info->current->text, 0);      /* FIXME: inode */
+
     smbfs_info->current = smbfs_info->current->next;
 
-    return &smbfs_readdir_data;
+    return dirent;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/tar/tar.c b/src/vfs/tar/tar.c
index 913a39520..efba8341c 100644
--- a/src/vfs/tar/tar.c
+++ b/src/vfs/tar/tar.c
@@ -796,7 +796,9 @@ tar_read_header (struct vfs_class *me, struct vfs_s_super *archive, int tard, si
             }
         }
 
+        memset (&st, 0, sizeof (st));
         tar_fill_stat (archive, &st, header, *h_size);
+
         if (S_ISDIR (st.st_mode))
         {
             entry = VFS_SUBCLASS (me)->find_entry (me, parent, p, LINK_NO_FOLLOW, FL_NONE);
diff --git a/src/vfs/undelfs/undelfs.c b/src/vfs/undelfs/undelfs.c
index 6e8a0685c..de1994363 100644
--- a/src/vfs/undelfs/undelfs.c
+++ b/src/vfs/undelfs/undelfs.c
@@ -400,11 +400,10 @@ undelfs_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 undelfs_readdir (void *vfs_info)
 {
-    static union vfs_dirent undelfs_readdir_data;
-    static char *const dirent_dest = undelfs_readdir_data.dent.d_name;
+    struct vfs_dirent *dirent;
 
     if (vfs_info != fs)
     {
@@ -414,13 +413,18 @@ undelfs_readdir (void *vfs_info)
     if (readdir_ptr == num_delarray)
         return NULL;
     if (readdir_ptr < 0)
-        strcpy (dirent_dest, readdir_ptr == -2 ? "." : "..");
+        dirent = vfs_dirent_init (NULL, readdir_ptr == -2 ? "." : "..", 0);     /* FIXME: inode */
     else
+    {
+        char dirent_dest[MC_MAXPATHLEN];
+
         g_snprintf (dirent_dest, MC_MAXPATHLEN, "%ld:%d",
                     (long) delarray[readdir_ptr].ino, delarray[readdir_ptr].num_blocks);
+        dirent = vfs_dirent_init (NULL, dirent_dest, 0);        /* FIXME: inode */
+    }
     readdir_ptr++;
 
-    return &undelfs_readdir_data;
+    return dirent;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/viewer/actions_cmd.c b/src/viewer/actions_cmd.c
index f5724ce20..a23196c92 100644
--- a/src/viewer/actions_cmd.c
+++ b/src/viewer/actions_cmd.c
@@ -61,7 +61,7 @@
 #include "lib/mcconfig.h"       /* mc_config_history_get() */
 
 #include "src/filemanager/layout.h"
-#include "src/filemanager/midnight.h"   /* current_panel */
+#include "src/filemanager/filemanager.h"        /* current_panel */
 #include "src/filemanager/ext.h"        /* regex_command_for() */
 
 #include "src/history.h"
diff --git a/src/viewer/ascii.c b/src/viewer/ascii.c
index 67b653434..e2a3ce934 100644
--- a/src/viewer/ascii.c
+++ b/src/viewer/ascii.c
@@ -162,12 +162,6 @@
 
 /*** file scope macro definitions ****************************************************************/
 
-#if GLIB_CHECK_VERSION (2, 30, 0)
-#define SPACING_MARK G_UNICODE_SPACING_MARK
-#else
-#define SPACING_MARK G_UNICODE_COMBINING_MARK
-#endif
-
 /* The Unicode standard recommends that lonely combining characters are printed over a dotted
  * circle. If the terminal is not UTF-8, this will be replaced by a dot anyway. */
 #define BASE_CHARACTER_FOR_LONELY_COMBINING 0x25CC      /* dotted circle */
@@ -266,7 +260,7 @@ mcview_is_spacing_mark (const WView * view, int c)
 {
 #ifdef HAVE_CHARSET
     if (view->utf8)
-        return g_unichar_type (c) == SPACING_MARK;
+        return g_unichar_type (c) == G_UNICODE_SPACING_MARK;
 #else
     (void) view;
     (void) c;
@@ -535,7 +529,7 @@ mcview_next_combining_char_sequence (WView * view, mcview_state_machine_t * stat
             return i;
         if (!mcview_ismark (view, cs[i]) || !mcview_isprint (view, cs[i]))
             return i;
-        if (g_unichar_type (cs[i]) == SPACING_MARK)
+        if (g_unichar_type (cs[i]) == G_UNICODE_SPACING_MARK)
         {
             /* Only allow as the first combining char. Stop processing in either case. */
             if (i == 1)
diff --git a/src/viewer/datasource.c b/src/viewer/datasource.c
index 1f97e8dd1..f63556bf5 100644
--- a/src/viewer/datasource.c
+++ b/src/viewer/datasource.c
@@ -354,6 +354,7 @@ mcview_close_datasource (WView * view)
         break;
     case DS_STRING:
         MC_PTR_FREE (view->ds_string_data);
+        break;
     default:
         break;
     }
diff --git a/src/viewer/growbuf.c b/src/viewer/growbuf.c
index c1292f255..7705fea21 100644
--- a/src/viewer/growbuf.c
+++ b/src/viewer/growbuf.c
@@ -205,15 +205,13 @@ mcview_growbuf_read_until (WView * view, off_t ofs)
                     g_free (err_msg);
                 }
 
-                if (view->ds_stdio_pipe != NULL)
-                {
-                    /* when switch from parse to raw mode and back,
-                     * do not close the already closed pipe after following loop:
-                     * mcview_growbuf_read_until() -> mcview_show_error() ->
-                     * MSG_DRAW -> mcview_display() -> mcview_get_byte() -> mcview_growbuf_read_until()
-                     */
-                    mcview_growbuf_done (view);
-                }
+                /* when switch from parse to raw mode and back,
+                 * do not close the already closed pipe after following loop:
+                 * mcview_growbuf_read_until() -> mcview_show_error() ->
+                 * MSG_DRAW -> mcview_display() -> mcview_get_byte() -> mcview_growbuf_read_until()
+                 */
+                mcview_growbuf_done (view);
+
                 mcview_display (view);
                 return;
             }
diff --git a/src/viewer/mcviewer.c b/src/viewer/mcviewer.c
index 027323f1c..615ba116d 100644
--- a/src/viewer/mcviewer.c
+++ b/src/viewer/mcviewer.c
@@ -44,7 +44,7 @@
 #include "lib/widget.h"
 
 #include "src/filemanager/layout.h"
-#include "src/filemanager/midnight.h"   /* the_menubar */
+#include "src/filemanager/filemanager.h"        /* the_menubar */
 
 #include "internal.h"
 
@@ -108,7 +108,7 @@ mcview_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
             if (!widget_get_state (w, WST_FOCUSED))
             {
                 /* Grab focus */
-                change_panel ();
+                (void) change_panel ();
             }
         }
         MC_FALLTHROUGH;
