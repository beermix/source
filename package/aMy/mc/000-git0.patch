diff --git a/AUTHORS b/AUTHORS
index 85309db39..e6df1dcc8 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -43,6 +43,9 @@ Alexander Serkov <serkov@ukrpost.net>
 Alessandro Rubini <rubini@ipvvis.unipv.it>
 	Mouse support.
 
+Aleš Janda <ales.janda@kyblsoft.cz>
+	Shadows of dialog windows and menus.
+
 Alexander Dong <ado@software-ag.de>
 	OS/2 port.
 
diff --git a/configure.ac b/configure.ac
index 98717e682..4f542b567 100644
--- a/configure.ac
+++ b/configure.ac
@@ -625,7 +625,9 @@ src/vfs/extfs/helpers/ucab
 src/vfs/extfs/helpers/uha
 src/vfs/extfs/helpers/ulha
 src/vfs/extfs/helpers/ulib
+src/vfs/extfs/helpers/unar
 src/vfs/extfs/helpers/urar
+src/vfs/extfs/helpers/uwim
 src/vfs/extfs/helpers/uzip
 src/vfs/extfs/helpers/uzoo
 
diff --git a/doc/INSTALL b/doc/INSTALL
index fe694e310..564862c33 100644
--- a/doc/INSTALL
+++ b/doc/INSTALL
@@ -20,7 +20,7 @@ Build requirements for GNU Midnight Commander
 - gettext >= 0.18.1
 - libssh2 >= 1.2.5 is required only for sftp vfs (1.2.7 if you need ssh-agent support)
 - libaspell to support spell checking in the internal editor
-- ext2fs >= 1.42.4 to suport ext{2,3,4}fs extended attributes
+- ext2fs >= 1.42.4 to support ext{2,3,4}fs extended attributes
 
 
 Installation instructions for GNU Midnight Commander
diff --git a/doc/NEWS b/doc/NEWS
index c0d32cef0..f3d2bd9ff 100644
--- a/doc/NEWS
+++ b/doc/NEWS
@@ -2,61 +2,61 @@ Version 4.8.25
 
 - Core
 
-  * Minimal version of GLib is 2.30.0
-  * Avoid subshell warning for standalone mcedit/mcview/mcdiffview run from mc (#4056)
-  * Implement chattr command (change ext{2,3,4}fs extended attributes). Default shortcut is "C-x e" (#3847)
-  * Implement a WGroup widget -- a base class for widgets which contain other widgets (#2919, #4075)
-  * Implement key bindings for radiobuttons (#212)
+    * Minimal version of GLib is 2.30.0
+    * Avoid subshell warning for standalone mcedit/mcview/mcdiffview run from mc (#4056)
+    * Implement chattr command (change ext{2,3,4}fs extended attributes). Default shortcut is "C-x e" (#3847)
+    * Implement a WGroup widget -- a base class for widgets which contain other widgets (#2919, #4075)
+    * Implement key bindings for radiobuttons (#212)
 
 - VFS
 
-  * RPM VFS improvements:
-    * Support weak dependency tags: ENHANCES, SUGGESTS, RECOMMENDS, SUPPLEMENTS (#4091)
+    * RPM VFS improvements:
+        - Support weak dependency tags: ENHANCES, SUGGESTS, RECOMMENDS, SUPPLEMENTS (#4091)
 
 - Editor
 
-  * Improvements of syntax highlighting:
-    * php (#4060)
-    * tcl: add shebangs with wish and tclsh (#4062)
-    * Cobol (#1987)
-    * Verilog/SystemVerilog (#4087)
-  * New syntax highlighting:
-    * Kotlin (#4088)
-    * ino (Arduino IDE and a number of other IDEs) (#4098)
+    * Improvements of syntax highlighting:
+        - php (#4060)
+        - tcl: add shebangs with wish and tclsh (#4062)
+        - Cobol (#1987)
+        - Verilog/SystemVerilog (#4087)
+    * New syntax highlighting:
+        - Kotlin (#4088)
+        - ino (Arduino IDE and a number of other IDEs) (#4098)
 
 - Misc
 
-  * Code cleanup (#4050, #4085)
-  * Add support for opus audio (#4061)
-  * mc-wrapper: don't cd to the same directory (#3355)
-  * Improve archive support: more binaries to view archive content (#4086)
-    * lha: jlha, lhasa
-    * arj: 7za
-    * cab: 7za
-    * zip; 7z
-    * zipx: 7za
-    * iso: 7za
-  * Clean up in video.sh handler (#4045)
-    * RealPlayer is a proprietary application which can't be installed in most distros and has long been abandoned.
-    * gtv hasn't been developed since 2003.
-    * xanim barely plays anything.
-  * Various fixups and updates of man page
+    * Code cleanup (#4050, #4085)
+    * Add support for opus audio (#4061)
+    * mc-wrapper: don't cd to the same directory (#3355)
+    * Improve archive support: more binaries to view archive content (#4086)
+        - lha: jlha, lhasa
+        - arj: 7za
+        - cab: 7za
+        - zip; 7z
+        - zipx: 7za
+        - iso: 7za
+    * Clean up in video.sh handler (#4045)
+        - RealPlayer is a proprietary application which can't be installed in most distros and has long been abandoned.
+        - gtv hasn't been developed since 2003.
+        - xanim barely plays anything.
+    * Various fixups and updates of man page
 
 - Fixes
 
-  * FTBFS on OSes w/o O_CLOEXEC (#4052)
-  * FTBFS with glib2 >= 2.63.3 (#4053)
-  * Undefined "__linux__" macro on non-Linux systems (#4058)
-  * Mouse is not handled with ncurses-6 (#3964)
-  * Mouse is not handled with S-Lang on some old terminal emulators (#4063)
-  * Terminal size is always 80x24 in subshell on Solaris 11.4 SPARC (#4099)
-  * Double clicking on empty area of file panel executes last item (#3722)
-  * Garbage in input line history (#4064)
-  * Speed of file copy is not displayed for single file (#4081)
-  * mcedit: blank screen with invisible error (#4057)
-  * mcedit: broken syntax highlighting for shell scripts (#4054)
-  * VFS: broken browsing of .deb packages (#4055)
-  * mc.lib installed twice (#4070)
+    * FTBFS on OSes w/o O_CLOEXEC (#4052)
+    * FTBFS with glib2 >= 2.63.3 (#4053)
+    * Undefined "__linux__" macro on non-Linux systems (#4058)
+    * Mouse is not handled with ncurses-6 (#3964)
+    * Mouse is not handled with S-Lang on some old terminal emulators (#4063)
+    * Terminal size is always 80x24 in subshell on Solaris 11.4 SPARC (#4099)
+    * Double clicking on empty area of file panel executes last item (#3722)
+    * Garbage in input line history (#4064)
+    * Speed of file copy is not displayed for single file (#4081)
+    * mcedit: blank screen with invisible error (#4057)
+    * mcedit: broken syntax highlighting for shell scripts (#4054)
+    * VFS: broken browsing of .deb packages (#4055)
+    * mc.lib installed twice (#4070)
 
 
 Version 4.8.24
diff --git a/doc/man/mc.1.in b/doc/man/mc.1.in
index cc4c6c68b..cdd1f687b 100644
--- a/doc/man/mc.1.in
+++ b/doc/man/mc.1.in
@@ -2113,13 +2113,17 @@ overwriting files, execution by pressing enter, quitting the program,
 directory hotlist entries deletion and history cleanup.
 .\"NODE "    Appearance"
 .SH "    Appearance"
-In this dialog you can select the skin to be used.
+In this dialog you can select the skin to be used and enable shadow
+for dialogs and drop down menus.
 .PP
 See the
 .\"LINK2"
 Skins
 .\"Skins"
 section for technical details about the skin definition files.
+.PP
+.I Shadows.
+If this option is enabled, all dialogs and drop down menus will have a shadow.
 .\"NODE "    Display bits"
 .SH "    Display bits"
 This is used to configure the range of visible characters on the
diff --git a/doc/man/ru/mc.1.in b/doc/man/ru/mc.1.in
index ea9c898be..f029b5f3e 100644
--- a/doc/man/ru/mc.1.in
+++ b/doc/man/ru/mc.1.in
@@ -2411,12 +2411,17 @@ Commander, выделены цветом, определённым ключев
 на подтверждение.
 .\"NODE "    Appearance"
 .SH "    Оформление"
-Используя это диалоговое окно, вы можете выбрать скин.
+Используя это диалоговое окно, вы можете выбрать скин и разрещить отрисовку
+теней у диалоговых окон и выпадающих меню.
 .PP
 Для получения более подробной информации о скинах обратитесь к разделу
 .\"LINK2"
 Внешний вид\&.
 .\"Skins"
+.PP
+.I Тени.
+Если эта опция включена, все диалоговые окна и выпадающие меню будут иметь
+тени.
 .\"NODE "    Display bits"
 .SH "    Биты символов..."
 Этот пункт меню используется для задания диапазона отображаемых на
diff --git a/lib/Makefile.am b/lib/Makefile.am
index 455f9ddf7..95e4bbf05 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -42,8 +42,7 @@ libmc_la_SOURCES = \
 	serialize.c serialize.h \
 	shell.c shell.h \
 	stat-size.h \
-	timefmt.c timefmt.h \
-	timer.c timer.h
+	timefmt.c timefmt.h
 
 if USE_MAINTAINER_MODE
 libmc_la_SOURCES += logging.c logging.h
diff --git a/lib/glibcompat.c b/lib/glibcompat.c
index 2bea6034d..8f121ab5f 100644
--- a/lib/glibcompat.c
+++ b/lib/glibcompat.c
@@ -160,3 +160,29 @@ g_queue_clear_full (GQueue * queue, GDestroyNotify free_func)
 #endif /* ! GLIB_CHECK_VERSION (2, 60, 0) */
 
 /* --------------------------------------------------------------------------------------------- */
+
+/**
+ * mc_g_string_copy:
+ * @dest: (not nullable): the destination #GString. Its current contents are destroyed
+ * @src: (not nullable): the source #GString
+ * @return: @dest
+ *
+ * Copies the bytes from a #GString into a #GString, destroying any previous contents.
+ * It is rather like the standard strcpy() function, except that you do not have to worry about
+ * having enough space to copy the string.
+ *
+ * There is no such API in GLib2.
+ */
+GString *
+mc_g_string_copy (GString * dest, const GString * src)
+{
+    g_return_val_if_fail (src != NULL, NULL);
+    g_return_val_if_fail (dest != NULL, NULL);
+
+    g_string_set_size (dest, 0);
+    g_string_append_len (dest, src->str, src->len);
+
+    return dest;
+}
+
+/* --------------------------------------------------------------------------------------------- */
diff --git a/lib/glibcompat.h b/lib/glibcompat.h
index 5456da1a0..af6049926 100644
--- a/lib/glibcompat.h
+++ b/lib/glibcompat.h
@@ -24,6 +24,9 @@ void g_queue_free_full (GQueue * queue, GDestroyNotify free_func);
 void g_queue_clear_full (GQueue * queue, GDestroyNotify free_func);
 #endif /* ! GLIB_CHECK_VERSION (2, 60, 0) */
 
+/* There is no such API in GLib2 */
+GString *mc_g_string_copy (GString * dest, const GString * src);
+
 /*** inline functions ****************************************************************************/
 
 #endif /* MC_GLIBCOMPAT_H */
diff --git a/lib/global.c b/lib/global.c
index 137bfbdd3..5dea86987 100644
--- a/lib/global.c
+++ b/lib/global.c
@@ -31,7 +31,6 @@
 #include <config.h>
 
 #include "global.h"
-#include "lib/timer.h"
 
 /* *INDENT-OFF* */
 #ifdef ENABLE_SUBSHELL
@@ -51,7 +50,6 @@
 mc_global_t mc_global = {
     .mc_run_mode = MC_RUN_FULL,
     .run_from_parent_mc = FALSE,
-    .timer = NULL,
     .midnight_shutdown = FALSE,
 
     .sysconfig_dir = NULL,
@@ -85,6 +83,7 @@ mc_global_t mc_global = {
     .tty =
     {
         .skin = NULL,
+        .shadows = TRUE,
         .setup_color_string = NULL,
         .term_color_string = NULL,
         .color_terminal_string = NULL,
diff --git a/lib/global.h b/lib/global.h
index 846c724c6..c60063faa 100644
--- a/lib/global.h
+++ b/lib/global.h
@@ -148,8 +148,6 @@
 
 #define DEFAULT_CHARSET "ASCII"
 
-#include "lib/timer.h"          /* mc_timer_t */
-
 /*** enums ***************************************************************************************/
 
 /* run mode and params */
@@ -167,8 +165,6 @@ typedef struct
 {
     mc_run_mode_t mc_run_mode;
     gboolean run_from_parent_mc;
-    /* global timer */
-    mc_timer_t *timer;
     /* Used so that widgets know if they are being destroyed or shut down */
     gboolean midnight_shutdown;
 
@@ -230,6 +226,8 @@ typedef struct
     {
         /* Use the specified skin */
         char *skin;
+        /* Dialog window and frop down menu have a shadow */
+        gboolean shadows;
 
         char *setup_color_string;
         char *term_color_string;
diff --git a/lib/keybind.c b/lib/keybind.c
index cd4a35db4..abd44d3e2 100644
--- a/lib/keybind.c
+++ b/lib/keybind.c
@@ -7,7 +7,7 @@
    Written by:
    Vitja Makarov, 2005
    Ilia Maslakov <il.smind@gmail.com>, 2009, 2012
-   Andrew Borodin <aborodin@vmail.ru>, 2009, 2010, 2011, 2012
+   Andrew Borodin <aborodin@vmail.ru>, 2009-2020
 
    This file is part of the Midnight Commander.
 
@@ -40,333 +40,336 @@
 
 /*** file scope macro definitions ****************************************************************/
 
+#define ADD_KEYMAP_NAME(name) \
+    { #name, CK_##name }
+
 /*** file scope type declarations ****************************************************************/
 
 /*** file scope variables ************************************************************************/
 
 static name_keymap_t command_names[] = {
     /* common */
-    {"InsertChar", CK_InsertChar},
-    {"Enter", CK_Enter},
-    {"ChangePanel", CK_ChangePanel},
-    {"Up", CK_Up},
-    {"Down", CK_Down},
-    {"Left", CK_Left},
-    {"Right", CK_Right},
-    {"LeftQuick", CK_LeftQuick},
-    {"RightQuick", CK_RightQuick},
-    {"Home", CK_Home},
-    {"End", CK_End},
-    {"PageUp", CK_PageUp},
-    {"PageDown", CK_PageDown},
-    {"HalfPageUp", CK_HalfPageUp},
-    {"HalfPageDown", CK_HalfPageDown},
-    {"Top", CK_Top},
-    {"Bottom", CK_Bottom},
-    {"TopOnScreen", CK_TopOnScreen},
-    {"MiddleOnScreen", CK_MiddleOnScreen},
-    {"BottomOnScreen", CK_BottomOnScreen},
-    {"WordLeft", CK_WordLeft},
-    {"WordRight", CK_WordRight},
-    {"Copy", CK_Copy},
-    {"Move", CK_Move},
-    {"Delete", CK_Delete},
-    {"MakeDir", CK_MakeDir},
-    {"ChangeMode", CK_ChangeMode},
-    {"ChangeOwn", CK_ChangeOwn},
-    {"ChangeOwnAdvanced", CK_ChangeOwnAdvanced},
+    ADD_KEYMAP_NAME (InsertChar),
+    ADD_KEYMAP_NAME (Enter),
+    ADD_KEYMAP_NAME (ChangePanel),
+    ADD_KEYMAP_NAME (Up),
+    ADD_KEYMAP_NAME (Down),
+    ADD_KEYMAP_NAME (Left),
+    ADD_KEYMAP_NAME (Right),
+    ADD_KEYMAP_NAME (LeftQuick),
+    ADD_KEYMAP_NAME (RightQuick),
+    ADD_KEYMAP_NAME (Home),
+    ADD_KEYMAP_NAME (End),
+    ADD_KEYMAP_NAME (PageUp),
+    ADD_KEYMAP_NAME (PageDown),
+    ADD_KEYMAP_NAME (HalfPageUp),
+    ADD_KEYMAP_NAME (HalfPageDown),
+    ADD_KEYMAP_NAME (Top),
+    ADD_KEYMAP_NAME (Bottom),
+    ADD_KEYMAP_NAME (TopOnScreen),
+    ADD_KEYMAP_NAME (MiddleOnScreen),
+    ADD_KEYMAP_NAME (BottomOnScreen),
+    ADD_KEYMAP_NAME (WordLeft),
+    ADD_KEYMAP_NAME (WordRight),
+    ADD_KEYMAP_NAME (Copy),
+    ADD_KEYMAP_NAME (Move),
+    ADD_KEYMAP_NAME (Delete),
+    ADD_KEYMAP_NAME (MakeDir),
+    ADD_KEYMAP_NAME (ChangeMode),
+    ADD_KEYMAP_NAME (ChangeOwn),
+    ADD_KEYMAP_NAME (ChangeOwnAdvanced),
 #ifdef ENABLE_EXT2FS_ATTR
-    {"ChangeAttributes", CK_ChangeAttributes},
+    ADD_KEYMAP_NAME (ChangeAttributes),
 #endif
-    {"Remove", CK_Remove},
-    {"BackSpace", CK_BackSpace},
-    {"Redo", CK_Redo},
-    {"Clear", CK_Clear},
-    {"Menu", CK_Menu},
-    {"MenuLastSelected", CK_MenuLastSelected},
-    {"UserMenu", CK_UserMenu},
-    {"EditUserMenu", CK_EditUserMenu},
-    {"Search", CK_Search},
-    {"SearchContinue", CK_SearchContinue},
-    {"Replace", CK_Replace},
-    {"ReplaceContinue", CK_ReplaceContinue},
-    {"Help", CK_Help},
-    {"Shell", CK_Shell},
-    {"Edit", CK_Edit},
-    {"EditNew", CK_EditNew},
+    ADD_KEYMAP_NAME (Remove),
+    ADD_KEYMAP_NAME (BackSpace),
+    ADD_KEYMAP_NAME (Redo),
+    ADD_KEYMAP_NAME (Clear),
+    ADD_KEYMAP_NAME (Menu),
+    ADD_KEYMAP_NAME (MenuLastSelected),
+    ADD_KEYMAP_NAME (UserMenu),
+    ADD_KEYMAP_NAME (EditUserMenu),
+    ADD_KEYMAP_NAME (Search),
+    ADD_KEYMAP_NAME (SearchContinue),
+    ADD_KEYMAP_NAME (Replace),
+    ADD_KEYMAP_NAME (ReplaceContinue),
+    ADD_KEYMAP_NAME (Help),
+    ADD_KEYMAP_NAME (Shell),
+    ADD_KEYMAP_NAME (Edit),
+    ADD_KEYMAP_NAME (EditNew),
 #ifdef HAVE_CHARSET
-    {"SelectCodepage", CK_SelectCodepage},
+    ADD_KEYMAP_NAME (SelectCodepage),
 #endif
-    {"EditorViewerHistory", CK_EditorViewerHistory},
-    {"History", CK_History},
-    {"HistoryNext", CK_HistoryNext},
-    {"HistoryPrev", CK_HistoryPrev},
-    {"Complete", CK_Complete},
-    {"Save", CK_Save},
-    {"SaveAs", CK_SaveAs},
-    {"Goto", CK_Goto},
-    {"Reread", CK_Reread},
-    {"Refresh", CK_Refresh},
-    {"Suspend", CK_Suspend},
-    {"Swap", CK_Swap},
-    {"HotList", CK_HotList},
-    {"SelectInvert", CK_SelectInvert},
-    {"ScreenList", CK_ScreenList},
-    {"ScreenNext", CK_ScreenNext},
-    {"ScreenPrev", CK_ScreenPrev},
-    {"FileNext", CK_FileNext},
-    {"FilePrev", CK_FilePrev},
-    {"DeleteToHome", CK_DeleteToHome},
-    {"DeleteToEnd", CK_DeleteToEnd},
-    {"DeleteToWordBegin", CK_DeleteToWordBegin},
-    {"DeleteToWordEnd", CK_DeleteToWordEnd},
-    {"Cut", CK_Cut},
-    {"Store", CK_Store},
-    {"Paste", CK_Paste},
-    {"Mark", CK_Mark},
-    {"MarkLeft", CK_MarkLeft},
-    {"MarkRight", CK_MarkRight},
-    {"MarkUp", CK_MarkUp},
-    {"MarkDown", CK_MarkDown},
-    {"MarkToWordBegin", CK_MarkToWordBegin},
-    {"MarkToWordEnd", CK_MarkToWordEnd},
-    {"MarkToHome", CK_MarkToHome},
-    {"MarkToEnd", CK_MarkToEnd},
-    {"ToggleNavigation", CK_ToggleNavigation},
-    {"Sort", CK_Sort},
-    {"Options", CK_Options},
-    {"LearnKeys", CK_LearnKeys},
-    {"Bookmark", CK_Bookmark},
-    {"Quit", CK_Quit},
-    {"QuitQuiet", CK_QuitQuiet},
-    {"ExtendedKeyMap", CK_ExtendedKeyMap},
+    ADD_KEYMAP_NAME (EditorViewerHistory),
+    ADD_KEYMAP_NAME (History),
+    ADD_KEYMAP_NAME (HistoryNext),
+    ADD_KEYMAP_NAME (HistoryPrev),
+    ADD_KEYMAP_NAME (Complete),
+    ADD_KEYMAP_NAME (Save),
+    ADD_KEYMAP_NAME (SaveAs),
+    ADD_KEYMAP_NAME (Goto),
+    ADD_KEYMAP_NAME (Reread),
+    ADD_KEYMAP_NAME (Refresh),
+    ADD_KEYMAP_NAME (Suspend),
+    ADD_KEYMAP_NAME (Swap),
+    ADD_KEYMAP_NAME (HotList),
+    ADD_KEYMAP_NAME (SelectInvert),
+    ADD_KEYMAP_NAME (ScreenList),
+    ADD_KEYMAP_NAME (ScreenNext),
+    ADD_KEYMAP_NAME (ScreenPrev),
+    ADD_KEYMAP_NAME (FileNext),
+    ADD_KEYMAP_NAME (FilePrev),
+    ADD_KEYMAP_NAME (DeleteToHome),
+    ADD_KEYMAP_NAME (DeleteToEnd),
+    ADD_KEYMAP_NAME (DeleteToWordBegin),
+    ADD_KEYMAP_NAME (DeleteToWordEnd),
+    ADD_KEYMAP_NAME (Cut),
+    ADD_KEYMAP_NAME (Store),
+    ADD_KEYMAP_NAME (Paste),
+    ADD_KEYMAP_NAME (Mark),
+    ADD_KEYMAP_NAME (MarkLeft),
+    ADD_KEYMAP_NAME (MarkRight),
+    ADD_KEYMAP_NAME (MarkUp),
+    ADD_KEYMAP_NAME (MarkDown),
+    ADD_KEYMAP_NAME (MarkToWordBegin),
+    ADD_KEYMAP_NAME (MarkToWordEnd),
+    ADD_KEYMAP_NAME (MarkToHome),
+    ADD_KEYMAP_NAME (MarkToEnd),
+    ADD_KEYMAP_NAME (ToggleNavigation),
+    ADD_KEYMAP_NAME (Sort),
+    ADD_KEYMAP_NAME (Options),
+    ADD_KEYMAP_NAME (LearnKeys),
+    ADD_KEYMAP_NAME (Bookmark),
+    ADD_KEYMAP_NAME (Quit),
+    ADD_KEYMAP_NAME (QuitQuiet),
+    ADD_KEYMAP_NAME (ExtendedKeyMap),
 
     /* main commands */
 #ifdef USE_INTERNAL_EDIT
-    {"EditForceInternal", CK_EditForceInternal},
+    ADD_KEYMAP_NAME (EditForceInternal),
 #endif
-    {"View", CK_View},
-    {"ViewRaw", CK_ViewRaw},
-    {"ViewFile", CK_ViewFile},
-    {"ViewFiltered", CK_ViewFiltered},
-    {"Find", CK_Find},
-    {"DirSize", CK_DirSize},
-    {"CompareDirs", CK_CompareDirs},
+    ADD_KEYMAP_NAME (View),
+    ADD_KEYMAP_NAME (ViewRaw),
+    ADD_KEYMAP_NAME (ViewFile),
+    ADD_KEYMAP_NAME (ViewFiltered),
+    ADD_KEYMAP_NAME (Find),
+    ADD_KEYMAP_NAME (DirSize),
+    ADD_KEYMAP_NAME (CompareDirs),
 #ifdef USE_DIFF_VIEW
-    {"CompareFiles", CK_CompareFiles},
+    ADD_KEYMAP_NAME (CompareFiles),
 #endif
-    {"OptionsVfs", CK_OptionsVfs},
-    {"OptionsConfirm", CK_OptionsConfirm},
-    {"OptionsDisplayBits", CK_OptionsDisplayBits},
-    {"EditExtensionsFile", CK_EditExtensionsFile},
-    {"EditFileHighlightFile", CK_EditFileHighlightFile},
-    {"LinkSymbolicEdit", CK_LinkSymbolicEdit},
-    {"ExternalPanelize", CK_ExternalPanelize},
-    {"Filter", CK_Filter},
+    ADD_KEYMAP_NAME (OptionsVfs),
+    ADD_KEYMAP_NAME (OptionsConfirm),
+    ADD_KEYMAP_NAME (OptionsDisplayBits),
+    ADD_KEYMAP_NAME (EditExtensionsFile),
+    ADD_KEYMAP_NAME (EditFileHighlightFile),
+    ADD_KEYMAP_NAME (LinkSymbolicEdit),
+    ADD_KEYMAP_NAME (ExternalPanelize),
+    ADD_KEYMAP_NAME (Filter),
 #ifdef ENABLE_VFS_FISH
-    {"ConnectFish", CK_ConnectFish},
+    ADD_KEYMAP_NAME (ConnectFish),
 #endif
 #ifdef ENABLE_VFS_FTP
-    {"ConnectFtp", CK_ConnectFtp},
+    ADD_KEYMAP_NAME (ConnectFtp),
 #endif
 #ifdef ENABLE_VFS_SFTP
-    {"ConnectSftp", CK_ConnectSftp},
+    ADD_KEYMAP_NAME (ConnectSftp),
 #endif
 #ifdef ENABLE_VFS_SMB
-    {"ConnectSmb", CK_ConnectSmb},
+    ADD_KEYMAP_NAME (ConnectSmb),
 #endif
-    {"PanelInfo", CK_PanelInfo},
+    ADD_KEYMAP_NAME (PanelInfo),
 #ifdef ENABLE_BACKGROUND
-    {"Jobs", CK_Jobs},
+    ADD_KEYMAP_NAME (Jobs),
 #endif
-    {"OptionsLayout", CK_OptionsLayout},
-    {"OptionsAppearance", CK_OptionsAppearance},
-    {"Link", CK_Link},
-    {"SetupListingFormat", CK_SetupListingFormat},
-    {"PanelListing", CK_PanelListing},
+    ADD_KEYMAP_NAME (OptionsLayout),
+    ADD_KEYMAP_NAME (OptionsAppearance),
+    ADD_KEYMAP_NAME (Link),
+    ADD_KEYMAP_NAME (SetupListingFormat),
+    ADD_KEYMAP_NAME (PanelListing),
 #ifdef LISTMODE_EDITOR
-    {"ListMode", CK_ListMode}.
+    ADD_KEYMAP_NAME (ListMode),
 #endif
-    {"OptionsPanel", CK_OptionsPanel},
-    {"CdQuick", CK_CdQuick},
-    {"PanelQuickView", CK_PanelQuickView},
-    {"LinkSymbolicRelative", CK_LinkSymbolicRelative},
-    {"VfsList", CK_VfsList},
-    {"SaveSetup", CK_SaveSetup},
-    {"LinkSymbolic", CK_LinkSymbolic},
-    {"PanelTree", CK_PanelTree},
-    {"Tree", CK_Tree},
+    ADD_KEYMAP_NAME (OptionsPanel),
+    ADD_KEYMAP_NAME (CdQuick),
+    ADD_KEYMAP_NAME (PanelQuickView),
+    ADD_KEYMAP_NAME (LinkSymbolicRelative),
+    ADD_KEYMAP_NAME (VfsList),
+    ADD_KEYMAP_NAME (SaveSetup),
+    ADD_KEYMAP_NAME (LinkSymbolic),
+    ADD_KEYMAP_NAME (PanelTree),
+    ADD_KEYMAP_NAME (Tree),
 #ifdef ENABLE_VFS_UNDELFS
-    {"Undelete", CK_Undelete},
+    ADD_KEYMAP_NAME (Undelete),
 #endif
-    {"PutCurrentLink", CK_PutCurrentLink},
-    {"PutOtherLink", CK_PutOtherLink},
-    {"HotListAdd", CK_HotListAdd},
-    {"ShowHidden", CK_ShowHidden},
-    {"SplitVertHoriz", CK_SplitVertHoriz},
-    {"SplitEqual", CK_SplitEqual},
-    {"SplitMore", CK_SplitMore},
-    {"SplitLess", CK_SplitLess},
-    {"PutCurrentPath", CK_PutCurrentPath},
-    {"PutOtherPath", CK_PutOtherPath},
-    {"PutCurrentSelected", CK_PutCurrentSelected},
-    {"PutCurrentFullSelected", CK_PutCurrentFullSelected},
-    {"PutCurrentTagged", CK_PutCurrentTagged},
-    {"PutOtherTagged", CK_PutOtherTagged},
-    {"Select", CK_Select},
-    {"Unselect", CK_Unselect},
+    ADD_KEYMAP_NAME (PutCurrentLink),
+    ADD_KEYMAP_NAME (PutOtherLink),
+    ADD_KEYMAP_NAME (HotListAdd),
+    ADD_KEYMAP_NAME (ShowHidden),
+    ADD_KEYMAP_NAME (SplitVertHoriz),
+    ADD_KEYMAP_NAME (SplitEqual),
+    ADD_KEYMAP_NAME (SplitMore),
+    ADD_KEYMAP_NAME (SplitLess),
+    ADD_KEYMAP_NAME (PutCurrentPath),
+    ADD_KEYMAP_NAME (PutOtherPath),
+    ADD_KEYMAP_NAME (PutCurrentSelected),
+    ADD_KEYMAP_NAME (PutCurrentFullSelected),
+    ADD_KEYMAP_NAME (PutCurrentTagged),
+    ADD_KEYMAP_NAME (PutOtherTagged),
+    ADD_KEYMAP_NAME (Select),
+    ADD_KEYMAP_NAME (Unselect),
 
     /* panel */
-    {"SelectExt", CK_SelectExt},
-    {"ScrollLeft", CK_ScrollLeft},
-    {"ScrollRight", CK_ScrollRight},
-    {"PanelOtherCd", CK_PanelOtherCd},
-    {"PanelOtherCdLink", CK_PanelOtherCdLink},
-    {"CopySingle", CK_CopySingle},
-    {"MoveSingle", CK_MoveSingle},
-    {"DeleteSingle", CK_DeleteSingle},
-    {"CdParent", CK_CdParent},
-    {"CdChild", CK_CdChild},
-    {"Panelize", CK_Panelize},
-    {"PanelOtherSync", CK_PanelOtherSync},
-    {"SortNext", CK_SortNext},
-    {"SortPrev", CK_SortPrev},
-    {"SortReverse", CK_SortReverse},
-    {"SortByName", CK_SortByName},
-    {"SortByExt", CK_SortByExt},
-    {"SortBySize", CK_SortBySize},
-    {"SortByMTime", CK_SortByMTime},
-    {"CdParentSmart", CK_CdParentSmart},
-    {"CycleListingFormat", CK_CycleListingFormat},
+    ADD_KEYMAP_NAME (SelectExt),
+    ADD_KEYMAP_NAME (ScrollLeft),
+    ADD_KEYMAP_NAME (ScrollRight),
+    ADD_KEYMAP_NAME (PanelOtherCd),
+    ADD_KEYMAP_NAME (PanelOtherCdLink),
+    ADD_KEYMAP_NAME (CopySingle),
+    ADD_KEYMAP_NAME (MoveSingle),
+    ADD_KEYMAP_NAME (DeleteSingle),
+    ADD_KEYMAP_NAME (CdParent),
+    ADD_KEYMAP_NAME (CdChild),
+    ADD_KEYMAP_NAME (Panelize),
+    ADD_KEYMAP_NAME (PanelOtherSync),
+    ADD_KEYMAP_NAME (SortNext),
+    ADD_KEYMAP_NAME (SortPrev),
+    ADD_KEYMAP_NAME (SortReverse),
+    ADD_KEYMAP_NAME (SortByName),
+    ADD_KEYMAP_NAME (SortByExt),
+    ADD_KEYMAP_NAME (SortBySize),
+    ADD_KEYMAP_NAME (SortByMTime),
+    ADD_KEYMAP_NAME (CdParentSmart),
+    ADD_KEYMAP_NAME (CycleListingFormat),
 
     /* dialog */
-    {"Ok", CK_Ok},
-    {"Cancel", CK_Cancel},
+    ADD_KEYMAP_NAME (Ok),
+    ADD_KEYMAP_NAME (Cancel),
 
     /* input line */
-    {"Yank", CK_Yank},
+    ADD_KEYMAP_NAME (Yank),
 
     /* help */
-    {"Index", CK_Index},
-    {"Back", CK_Back},
-    {"LinkNext", CK_LinkNext},
-    {"LinkPrev", CK_LinkPrev},
-    {"NodeNext", CK_NodeNext},
-    {"NodePrev", CK_NodePrev},
+    ADD_KEYMAP_NAME (Index),
+    ADD_KEYMAP_NAME (Back),
+    ADD_KEYMAP_NAME (LinkNext),
+    ADD_KEYMAP_NAME (LinkPrev),
+    ADD_KEYMAP_NAME (NodeNext),
+    ADD_KEYMAP_NAME (NodePrev),
 
     /* tree */
-    {"Forget", CK_Forget},
+    ADD_KEYMAP_NAME (Forget),
 
 #if defined (USE_INTERNAL_EDIT) || defined (USE_DIFF_VIEW)
-    {"ShowNumbers", CK_ShowNumbers},
+    ADD_KEYMAP_NAME (ShowNumbers),
 #endif
 
     /* chattr dialog */
-    {"MarkAndDown", CK_MarkAndDown},
+    ADD_KEYMAP_NAME (MarkAndDown),
 
 #ifdef USE_INTERNAL_EDIT
-    {"Close", CK_Close},
-    {"Tab", CK_Tab},
-    {"Undo", CK_Undo},
-    {"ScrollUp", CK_ScrollUp},
-    {"ScrollDown", CK_ScrollDown},
-    {"Return", CK_Return},
-    {"ParagraphUp", CK_ParagraphUp},
-    {"ParagraphDown", CK_ParagraphDown},
-    {"EditFile", CK_EditFile},
-    {"MarkWord", CK_MarkWord},
-    {"MarkLine", CK_MarkLine},
-    {"MarkAll", CK_MarkAll},
-    {"Unmark", CK_Unmark},
-    {"MarkColumn", CK_MarkColumn},
-    {"BlockSave", CK_BlockSave},
-    {"InsertFile", CK_InsertFile},
-    {"InsertOverwrite", CK_InsertOverwrite},
-    {"Date", CK_Date},
-    {"DeleteLine", CK_DeleteLine},
-    {"EditMail", CK_Mail},
-    {"ParagraphFormat", CK_ParagraphFormat},
-    {"MatchBracket", CK_MatchBracket},
-    {"ExternalCommand", CK_ExternalCommand},
-    {"MacroStartRecord", CK_MacroStartRecord},
-    {"MacroStopRecord", CK_MacroStopRecord},
-    {"MacroStartStopRecord", CK_MacroStartStopRecord},
-    {"MacroDelete", CK_MacroDelete},
-    {"RepeatStartStopRecord", CK_RepeatStartStopRecord},
+    ADD_KEYMAP_NAME (Close),
+    ADD_KEYMAP_NAME (Tab),
+    ADD_KEYMAP_NAME (Undo),
+    ADD_KEYMAP_NAME (ScrollUp),
+    ADD_KEYMAP_NAME (ScrollDown),
+    ADD_KEYMAP_NAME (Return),
+    ADD_KEYMAP_NAME (ParagraphUp),
+    ADD_KEYMAP_NAME (ParagraphDown),
+    ADD_KEYMAP_NAME (EditFile),
+    ADD_KEYMAP_NAME (MarkWord),
+    ADD_KEYMAP_NAME (MarkLine),
+    ADD_KEYMAP_NAME (MarkAll),
+    ADD_KEYMAP_NAME (Unmark),
+    ADD_KEYMAP_NAME (MarkColumn),
+    ADD_KEYMAP_NAME (BlockSave),
+    ADD_KEYMAP_NAME (InsertFile),
+    ADD_KEYMAP_NAME (InsertOverwrite),
+    ADD_KEYMAP_NAME (Date),
+    ADD_KEYMAP_NAME (DeleteLine),
+    ADD_KEYMAP_NAME (EditMail),
+    ADD_KEYMAP_NAME (ParagraphFormat),
+    ADD_KEYMAP_NAME (MatchBracket),
+    ADD_KEYMAP_NAME (ExternalCommand),
+    ADD_KEYMAP_NAME (MacroStartRecord),
+    ADD_KEYMAP_NAME (MacroStopRecord),
+    ADD_KEYMAP_NAME (MacroStartStopRecord),
+    ADD_KEYMAP_NAME (MacroDelete),
+    ADD_KEYMAP_NAME (RepeatStartStopRecord),
 #ifdef HAVE_ASPELL
-    {"SpellCheck", CK_SpellCheck},
-    {"SpellCheckCurrentWord", CK_SpellCheckCurrentWord},
-    {"SpellCheckSelectLang", CK_SpellCheckSelectLang},
+    ADD_KEYMAP_NAME (SpellCheck),
+    ADD_KEYMAP_NAME (SpellCheckCurrentWord),
+    ADD_KEYMAP_NAME (SpellCheckSelectLang),
 #endif /* HAVE_ASPELL */
-    {"BookmarkFlush", CK_BookmarkFlush},
-    {"BookmarkNext", CK_BookmarkNext},
-    {"BookmarkPrev", CK_BookmarkPrev},
-    {"MarkPageUp", CK_MarkPageUp},
-    {"MarkPageDown", CK_MarkPageDown},
-    {"MarkToFileBegin", CK_MarkToFileBegin},
-    {"MarkToFileEnd", CK_MarkToFileEnd},
-    {"MarkToPageBegin", CK_MarkToPageBegin},
-    {"MarkToPageEnd", CK_MarkToPageEnd},
-    {"MarkScrollUp", CK_MarkScrollUp},
-    {"MarkScrollDown", CK_MarkScrollDown},
-    {"MarkParagraphUp", CK_MarkParagraphUp},
-    {"MarkParagraphDown", CK_MarkParagraphDown},
-    {"MarkColumnPageUp", CK_MarkColumnPageUp},
-    {"MarkColumnPageDown", CK_MarkColumnPageDown},
-    {"MarkColumnLeft", CK_MarkColumnLeft},
-    {"MarkColumnRight", CK_MarkColumnRight},
-    {"MarkColumnUp", CK_MarkColumnUp},
-    {"MarkColumnDown", CK_MarkColumnDown},
-    {"MarkColumnScrollUp", CK_MarkColumnScrollUp},
-    {"MarkColumnScrollDown", CK_MarkColumnScrollDown},
-    {"MarkColumnParagraphUp", CK_MarkColumnParagraphUp},
-    {"MarkColumnParagraphDown", CK_MarkColumnParagraphDown},
-    {"BlockShiftLeft", CK_BlockShiftLeft},
-    {"BlockShiftRight", CK_BlockShiftRight},
-    {"InsertLiteral", CK_InsertLiteral},
-    {"ShowTabTws", CK_ShowTabTws},
-    {"SyntaxOnOff", CK_SyntaxOnOff},
-    {"SyntaxChoose", CK_SyntaxChoose},
-    {"ShowMargin", CK_ShowMargin},
-    {"OptionsSaveMode", CK_OptionsSaveMode},
-    {"About", CK_About},
+    ADD_KEYMAP_NAME (BookmarkFlush),
+    ADD_KEYMAP_NAME (BookmarkNext),
+    ADD_KEYMAP_NAME (BookmarkPrev),
+    ADD_KEYMAP_NAME (MarkPageUp),
+    ADD_KEYMAP_NAME (MarkPageDown),
+    ADD_KEYMAP_NAME (MarkToFileBegin),
+    ADD_KEYMAP_NAME (MarkToFileEnd),
+    ADD_KEYMAP_NAME (MarkToPageBegin),
+    ADD_KEYMAP_NAME (MarkToPageEnd),
+    ADD_KEYMAP_NAME (MarkScrollUp),
+    ADD_KEYMAP_NAME (MarkScrollDown),
+    ADD_KEYMAP_NAME (MarkParagraphUp),
+    ADD_KEYMAP_NAME (MarkParagraphDown),
+    ADD_KEYMAP_NAME (MarkColumnPageUp),
+    ADD_KEYMAP_NAME (MarkColumnPageDown),
+    ADD_KEYMAP_NAME (MarkColumnLeft),
+    ADD_KEYMAP_NAME (MarkColumnRight),
+    ADD_KEYMAP_NAME (MarkColumnUp),
+    ADD_KEYMAP_NAME (MarkColumnDown),
+    ADD_KEYMAP_NAME (MarkColumnScrollUp),
+    ADD_KEYMAP_NAME (MarkColumnScrollDown),
+    ADD_KEYMAP_NAME (MarkColumnParagraphUp),
+    ADD_KEYMAP_NAME (MarkColumnParagraphDown),
+    ADD_KEYMAP_NAME (BlockShiftLeft),
+    ADD_KEYMAP_NAME (BlockShiftRight),
+    ADD_KEYMAP_NAME (InsertLiteral),
+    ADD_KEYMAP_NAME (ShowTabTws),
+    ADD_KEYMAP_NAME (SyntaxOnOff),
+    ADD_KEYMAP_NAME (SyntaxChoose),
+    ADD_KEYMAP_NAME (ShowMargin),
+    ADD_KEYMAP_NAME (OptionsSaveMode),
+    ADD_KEYMAP_NAME (About),
     /* An action to run external script from macro */
     {"ExecuteScript", CK_PipeBlock (0)},
-    {"WindowMove", CK_WindowMove},
-    {"WindowResize", CK_WindowResize},
-    {"WindowFullscreen", CK_WindowFullscreen},
-    {"WindowList", CK_WindowList},
-    {"WindowNext", CK_WindowNext},
-    {"WindowPrev", CK_WindowPrev},
+    ADD_KEYMAP_NAME (WindowMove),
+    ADD_KEYMAP_NAME (WindowResize),
+    ADD_KEYMAP_NAME (WindowFullscreen),
+    ADD_KEYMAP_NAME (WindowList),
+    ADD_KEYMAP_NAME (WindowNext),
+    ADD_KEYMAP_NAME (WindowPrev),
 #endif /* USE_INTERNAL_EDIT */
 
     /* viewer */
-    {"WrapMode", CK_WrapMode},
-    {"HexEditMode", CK_HexEditMode},
-    {"HexMode", CK_HexMode},
-    {"MagicMode", CK_MagicMode},
-    {"NroffMode", CK_NroffMode},
-    {"BookmarkGoto", CK_BookmarkGoto},
-    {"Ruler", CK_Ruler},
-    {"SearchForward", CK_SearchForward},
-    {"SearchBackward", CK_SearchBackward},
-    {"SearchForwardContinue", CK_SearchForwardContinue},
-    {"SearchBackwardContinue", CK_SearchBackwardContinue},
-    {"SearchOppositeContinue", CK_SearchOppositeContinue},
+    ADD_KEYMAP_NAME (WrapMode),
+    ADD_KEYMAP_NAME (HexEditMode),
+    ADD_KEYMAP_NAME (HexMode),
+    ADD_KEYMAP_NAME (MagicMode),
+    ADD_KEYMAP_NAME (NroffMode),
+    ADD_KEYMAP_NAME (BookmarkGoto),
+    ADD_KEYMAP_NAME (Ruler),
+    ADD_KEYMAP_NAME (SearchForward),
+    ADD_KEYMAP_NAME (SearchBackward),
+    ADD_KEYMAP_NAME (SearchForwardContinue),
+    ADD_KEYMAP_NAME (SearchBackwardContinue),
+    ADD_KEYMAP_NAME (SearchOppositeContinue),
 
 #ifdef USE_DIFF_VIEW
     /* diff viewer */
-    {"ShowSymbols", CK_ShowSymbols},
-    {"SplitFull", CK_SplitFull},
-    {"Tab2", CK_Tab2},
-    {"Tab3", CK_Tab3},
-    {"Tab4", CK_Tab4},
-    {"Tab8", CK_Tab8},
-    {"HunkNext", CK_HunkNext},
-    {"HunkPrev", CK_HunkPrev},
-    {"EditOther", CK_EditOther},
-    {"Merge", CK_Merge},
-    {"MergeOther", CK_MergeOther},
+    ADD_KEYMAP_NAME (ShowSymbols),
+    ADD_KEYMAP_NAME (SplitFull),
+    ADD_KEYMAP_NAME (Tab2),
+    ADD_KEYMAP_NAME (Tab3),
+    ADD_KEYMAP_NAME (Tab4),
+    ADD_KEYMAP_NAME (Tab8),
+    ADD_KEYMAP_NAME (HunkNext),
+    ADD_KEYMAP_NAME (HunkPrev),
+    ADD_KEYMAP_NAME (EditOther),
+    ADD_KEYMAP_NAME (Merge),
+    ADD_KEYMAP_NAME (MergeOther),
 #endif /* USE_DIFF_VIEW */
 
     {NULL, CK_IgnoreKey}
diff --git a/lib/keybind.h b/lib/keybind.h
index 53ad1c39f..9638bd651 100644
--- a/lib/keybind.h
+++ b/lib/keybind.h
@@ -316,7 +316,7 @@ enum
     CK_InsertLiteral,
     CK_ExternalCommand,
     CK_Date,
-    CK_Mail,
+    CK_EditMail,
 
     /* viewer */
     CK_WrapMode = 600L,
diff --git a/lib/skin.h b/lib/skin.h
index 747a504ec..155a8db9c 100644
--- a/lib/skin.h
+++ b/lib/skin.h
@@ -22,92 +22,93 @@
 #define REVERSE_COLOR             mc_skin_color__cache[6]
 #define COMMAND_MARK_COLOR        mc_skin_color__cache[7]
 #define HEADER_COLOR              mc_skin_color__cache[8]
+#define SHADOW_COLOR              mc_skin_color__cache[9]
 
 /* Dialog colors */
-#define COLOR_NORMAL              mc_skin_color__cache[9]
-#define COLOR_FOCUS               mc_skin_color__cache[10]
-#define COLOR_HOT_NORMAL          mc_skin_color__cache[11]
-#define COLOR_HOT_FOCUS           mc_skin_color__cache[12]
-#define COLOR_TITLE               mc_skin_color__cache[13]
+#define COLOR_NORMAL              mc_skin_color__cache[10]
+#define COLOR_FOCUS               mc_skin_color__cache[11]
+#define COLOR_HOT_NORMAL          mc_skin_color__cache[12]
+#define COLOR_HOT_FOCUS           mc_skin_color__cache[13]
+#define COLOR_TITLE               mc_skin_color__cache[14]
 
 /* Error dialog colors */
-#define ERROR_COLOR               mc_skin_color__cache[14]
-#define ERROR_FOCUS               mc_skin_color__cache[15]
-#define ERROR_HOT_NORMAL          mc_skin_color__cache[16]
-#define ERROR_HOT_FOCUS           mc_skin_color__cache[17]
-#define ERROR_TITLE               mc_skin_color__cache[18]
+#define ERROR_COLOR               mc_skin_color__cache[15]
+#define ERROR_FOCUS               mc_skin_color__cache[16]
+#define ERROR_HOT_NORMAL          mc_skin_color__cache[17]
+#define ERROR_HOT_FOCUS           mc_skin_color__cache[18]
+#define ERROR_TITLE               mc_skin_color__cache[19]
 
 /* Menu colors */
-#define MENU_ENTRY_COLOR          mc_skin_color__cache[19]
-#define MENU_SELECTED_COLOR       mc_skin_color__cache[20]
-#define MENU_HOT_COLOR            mc_skin_color__cache[21]
-#define MENU_HOTSEL_COLOR         mc_skin_color__cache[22]
-#define MENU_INACTIVE_COLOR       mc_skin_color__cache[23]
+#define MENU_ENTRY_COLOR          mc_skin_color__cache[20]
+#define MENU_SELECTED_COLOR       mc_skin_color__cache[21]
+#define MENU_HOT_COLOR            mc_skin_color__cache[22]
+#define MENU_HOTSEL_COLOR         mc_skin_color__cache[23]
+#define MENU_INACTIVE_COLOR       mc_skin_color__cache[24]
 
 /* Popup menu colors */
-#define PMENU_ENTRY_COLOR         mc_skin_color__cache[24]
-#define PMENU_SELECTED_COLOR      mc_skin_color__cache[25]
-#define PMENU_HOT_COLOR           mc_skin_color__cache[26]      /* unused: not implemented yet */
-#define PMENU_HOTSEL_COLOR        mc_skin_color__cache[27]      /* unused: not implemented yet */
-#define PMENU_TITLE_COLOR         mc_skin_color__cache[28]
+#define PMENU_ENTRY_COLOR         mc_skin_color__cache[25]
+#define PMENU_SELECTED_COLOR      mc_skin_color__cache[26]
+#define PMENU_HOT_COLOR           mc_skin_color__cache[27]      /* unused: not implemented yet */
+#define PMENU_HOTSEL_COLOR        mc_skin_color__cache[28]      /* unused: not implemented yet */
+#define PMENU_TITLE_COLOR         mc_skin_color__cache[29]
 
-#define BUTTONBAR_HOTKEY_COLOR    mc_skin_color__cache[29]
-#define BUTTONBAR_BUTTON_COLOR    mc_skin_color__cache[30]
+#define BUTTONBAR_HOTKEY_COLOR    mc_skin_color__cache[30]
+#define BUTTONBAR_BUTTON_COLOR    mc_skin_color__cache[31]
 
-#define STATUSBAR_COLOR           mc_skin_color__cache[31]
+#define STATUSBAR_COLOR           mc_skin_color__cache[32]
 
 /*
  * This should be selectable independently. Default has to be black background
  * foreground does not matter at all.
  */
-#define GAUGE_COLOR               mc_skin_color__cache[32]
-#define INPUT_COLOR               mc_skin_color__cache[33]
-#define INPUT_UNCHANGED_COLOR     mc_skin_color__cache[34]
-#define INPUT_MARK_COLOR          mc_skin_color__cache[35]
-#define INPUT_HISTORY_COLOR       mc_skin_color__cache[36]
-#define COMMAND_HISTORY_COLOR     mc_skin_color__cache[37]
-
-#define HELP_NORMAL_COLOR         mc_skin_color__cache[38]
-#define HELP_ITALIC_COLOR         mc_skin_color__cache[39]
-#define HELP_BOLD_COLOR           mc_skin_color__cache[40]
-#define HELP_LINK_COLOR           mc_skin_color__cache[41]
-#define HELP_SLINK_COLOR          mc_skin_color__cache[42]
-#define HELP_TITLE_COLOR          mc_skin_color__cache[43]
-
-
-#define VIEW_NORMAL_COLOR         mc_skin_color__cache[44]
-#define VIEW_BOLD_COLOR           mc_skin_color__cache[45]
-#define VIEW_UNDERLINED_COLOR     mc_skin_color__cache[46]
-#define VIEW_SELECTED_COLOR       mc_skin_color__cache[47]
+#define GAUGE_COLOR               mc_skin_color__cache[33]
+#define INPUT_COLOR               mc_skin_color__cache[34]
+#define INPUT_UNCHANGED_COLOR     mc_skin_color__cache[35]
+#define INPUT_MARK_COLOR          mc_skin_color__cache[36]
+#define INPUT_HISTORY_COLOR       mc_skin_color__cache[37]
+#define COMMAND_HISTORY_COLOR     mc_skin_color__cache[38]
+
+#define HELP_NORMAL_COLOR         mc_skin_color__cache[39]
+#define HELP_ITALIC_COLOR         mc_skin_color__cache[40]
+#define HELP_BOLD_COLOR           mc_skin_color__cache[41]
+#define HELP_LINK_COLOR           mc_skin_color__cache[42]
+#define HELP_SLINK_COLOR          mc_skin_color__cache[43]
+#define HELP_TITLE_COLOR          mc_skin_color__cache[44]
+
+
+#define VIEW_NORMAL_COLOR         mc_skin_color__cache[45]
+#define VIEW_BOLD_COLOR           mc_skin_color__cache[46]
+#define VIEW_UNDERLINED_COLOR     mc_skin_color__cache[47]
+#define VIEW_SELECTED_COLOR       mc_skin_color__cache[48]
 
 /*
  * editor colors - only 4 for normal, search->found, select, and whitespace
  * respectively
  * Last is defined to view color.
  */
-#define EDITOR_NORMAL_COLOR       mc_skin_color__cache[48]
-#define EDITOR_BOLD_COLOR         mc_skin_color__cache[49]
-#define EDITOR_MARKED_COLOR       mc_skin_color__cache[50]
-#define EDITOR_WHITESPACE_COLOR   mc_skin_color__cache[51]
-#define EDITOR_RIGHT_MARGIN_COLOR mc_skin_color__cache[52]
-#define EDITOR_BACKGROUND         mc_skin_color__cache[53]
-#define EDITOR_FRAME              mc_skin_color__cache[54]
-#define EDITOR_FRAME_ACTIVE       mc_skin_color__cache[55]
-#define EDITOR_FRAME_DRAG         mc_skin_color__cache[56]
+#define EDITOR_NORMAL_COLOR       mc_skin_color__cache[49]
+#define EDITOR_BOLD_COLOR         mc_skin_color__cache[50]
+#define EDITOR_MARKED_COLOR       mc_skin_color__cache[51]
+#define EDITOR_WHITESPACE_COLOR   mc_skin_color__cache[52]
+#define EDITOR_RIGHT_MARGIN_COLOR mc_skin_color__cache[53]
+#define EDITOR_BACKGROUND         mc_skin_color__cache[54]
+#define EDITOR_FRAME              mc_skin_color__cache[55]
+#define EDITOR_FRAME_ACTIVE       mc_skin_color__cache[56]
+#define EDITOR_FRAME_DRAG         mc_skin_color__cache[57]
 /* color of left 8 char status per line */
-#define LINE_STATE_COLOR          mc_skin_color__cache[57]
-#define BOOK_MARK_COLOR           mc_skin_color__cache[58]
-#define BOOK_MARK_FOUND_COLOR     mc_skin_color__cache[59]
+#define LINE_STATE_COLOR          mc_skin_color__cache[58]
+#define BOOK_MARK_COLOR           mc_skin_color__cache[59]
+#define BOOK_MARK_FOUND_COLOR     mc_skin_color__cache[60]
 
 /* Diff colors */
-#define DFF_ADD_COLOR             mc_skin_color__cache[60]
-#define DFF_CHG_COLOR             mc_skin_color__cache[61]
-#define DFF_CHH_COLOR             mc_skin_color__cache[62]
-#define DFF_CHD_COLOR             mc_skin_color__cache[63]
-#define DFF_DEL_COLOR             mc_skin_color__cache[64]
-#define DFF_ERROR_COLOR           mc_skin_color__cache[65]
-
-#define MC_SKIN_COLOR_CACHE_COUNT 66
+#define DFF_ADD_COLOR             mc_skin_color__cache[61]
+#define DFF_CHG_COLOR             mc_skin_color__cache[62]
+#define DFF_CHH_COLOR             mc_skin_color__cache[63]
+#define DFF_CHD_COLOR             mc_skin_color__cache[64]
+#define DFF_DEL_COLOR             mc_skin_color__cache[65]
+#define DFF_ERROR_COLOR           mc_skin_color__cache[66]
+
+#define MC_SKIN_COLOR_CACHE_COUNT 67
 
 /*** enums ***************************************************************************************/
 
diff --git a/lib/skin/colors.c b/lib/skin/colors.c
index b8d944a41..27e18bdda 100644
--- a/lib/skin/colors.c
+++ b/lib/skin/colors.c
@@ -249,6 +249,7 @@ mc_skin_color_cache_init (void)
     REVERSE_COLOR = mc_skin_color_get ("core", "reverse");
     HEADER_COLOR = mc_skin_color_get ("core", "header");
     COMMAND_MARK_COLOR = mc_skin_color_get ("core", "commandlinemark");
+    SHADOW_COLOR = mc_skin_color_get ("core", "shadow");
 
     COLOR_NORMAL = mc_skin_color_get ("dialog", "_default_");
     COLOR_FOCUS = mc_skin_color_get ("dialog", "dfocus");
diff --git a/lib/stat-size.h b/lib/stat-size.h
index 8930bb5c5..cc8ec121a 100644
--- a/lib/stat-size.h
+++ b/lib/stat-size.h
@@ -81,12 +81,6 @@
   /* HP-UX counts st_blocks in 1024-byte units.
      This loses when mixing HP-UX and BSD file systems with NFS.  */
 #define ST_NBLOCKSIZE 1024
-#else /* !hpux */
-#if defined _CRAY
-#define ST_NBLOCKS(statbuf) \
-  (S_ISREG ((statbuf).st_mode) || S_ISDIR ((statbuf).st_mode) \
-   ? (statbuf).st_blocks * ST_BLKSIZE (statbuf) / ST_NBLOCKSIZE : 0)
-#endif
 #endif
 #endif
 
diff --git a/lib/strutil/strutilutf8.c b/lib/strutil/strutilutf8.c
index efec6be54..5ac0015e6 100644
--- a/lib/strutil/strutilutf8.c
+++ b/lib/strutil/strutilutf8.c
@@ -70,7 +70,7 @@ str_unichar_iscombiningmark (gunichar uni)
     GUnicodeType type;
 
     type = g_unichar_type (uni);
-    return (type == G_UNICODE_COMBINING_MARK)
+    return (type == G_UNICODE_SPACING_MARK)
         || (type == G_UNICODE_ENCLOSING_MARK) || (type == G_UNICODE_NON_SPACING_MARK);
 }
 
diff --git a/lib/timer.c b/lib/timer.c
deleted file mode 100644
index 25e4af6ec..000000000
--- a/lib/timer.c
+++ /dev/null
@@ -1,114 +0,0 @@
-/*
-   Simple timer for the Midnight Commander.
-
-   Copyright (C) 2013-2020
-   Free Software Foundation, Inc.
-
-   Written by:
-   Andrew Borodin 2013
-
-   This file is part of the Midnight Commander.
-
-   The Midnight Commander is free software: you can redistribute it
-   and/or modify it under the terms of the GNU General Public License as
-   published by the Free Software Foundation, either version 3 of the License,
-   or (at your option) any later version.
-
-   The Midnight Commander is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program.  If not, see <http://www.gnu.org/licenses/>.
- */
-
-/** \file
- *  \brief Source: simple timer
- */
-
-#include <config.h>
-
-#include <sys/time.h>
-
-#include "lib/global.h"
-#include "lib/timer.h"
-
-/*** global variables ****************************************************************************/
-
-/**
- * mc_timer_t:
- *
- * Opaque datatype that records a start time.
- * #mc_timer_t records a start time, and counts microseconds elapsed since
- * that time.
- **/
-struct mc_timer_t
-{
-    guint64 start;
-};
-
-/*** file scope macro definitions ****************************************************************/
-
-/*** file scope type declarations ****************************************************************/
-
-/*** file scope variables ************************************************************************/
-
-/*** file scope functions ************************************************************************/
-
-/* --------------------------------------------------------------------------------------------- */
-/*** public functions ****************************************************************************/
-/* --------------------------------------------------------------------------------------------- */
-
-/**
- * Creates a new timer, and starts timing.
- *
- * @return: a new #mc_timer_t.
- **/
-mc_timer_t *
-mc_timer_new (void)
-{
-    mc_timer_t *timer;
-    struct timeval tv;
-
-    timer = g_new (mc_timer_t, 1);
-    gettimeofday (&tv, NULL);
-    timer->start = (guint64) tv.tv_sec * G_USEC_PER_SEC + (guint64) tv.tv_usec;
-
-    return timer;
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
-/**
- * Destroys a timer, freeing associated resources.
- *
- * @timer: an #mc_timer_t to destroy.
- **/
-void
-mc_timer_destroy (mc_timer_t * timer)
-{
-    g_free (timer);
-}
-
-/* --------------------------------------------------------------------------------------------- */
-
-/**
- * Obtains the time since the timer was started.
- *
- * @timer: an #mc_timer_t.
- *
- * @return: microseconds elapsed, the time since the timer was started
- *
- **/
-guint64
-mc_timer_elapsed (const mc_timer_t * timer)
-{
-    struct timeval tv;
-
-    gettimeofday (&tv, NULL);
-
-    return ((guint64) tv.tv_sec * G_USEC_PER_SEC + (guint64) tv.tv_usec - timer->start);
-}
-
-/* --------------------------------------------------------------------------------------------- */
diff --git a/lib/timer.h b/lib/timer.h
deleted file mode 100644
index 4cc823260..000000000
--- a/lib/timer.h
+++ /dev/null
@@ -1,27 +0,0 @@
-/** \file timer.h
- *  \brief Header: simple timer
- */
-
-#ifndef MC_TIMER_H
-#define MC_TIMER_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-struct mc_timer_t;
-typedef struct mc_timer_t mc_timer_t;
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-mc_timer_t *mc_timer_new (void);
-void mc_timer_destroy (mc_timer_t * timer);
-guint64 mc_timer_elapsed (const mc_timer_t * timer);
-
-/*** inline functions **************************************************/
-
-#endif /* MC_TIMER_H */
diff --git a/lib/tty/tty-internal.h b/lib/tty/tty-internal.h
index 662b0bcaf..77546cd5f 100644
--- a/lib/tty/tty-internal.h
+++ b/lib/tty/tty-internal.h
@@ -42,6 +42,8 @@ char *mc_tty_normalize_from_utf8 (const char *);
 void tty_init_xterm_support (gboolean is_xterm);
 int tty_lowlevel_getch (void);
 
+void tty_colorize_area (int y, int x, int rows, int cols, int color);
+
 /*** inline functions ****************************************************************************/
 
 #endif /* MC_TTY_INTERNAL_H */
diff --git a/lib/tty/tty-ncurses.c b/lib/tty/tty-ncurses.c
index 4383d1e74..03235cd5b 100644
--- a/lib/tty/tty-ncurses.c
+++ b/lib/tty/tty-ncurses.c
@@ -48,6 +48,7 @@
 
 #include "tty-internal.h"       /* mc_tty_normalize_from_utf8() */
 #include "tty.h"
+#include "color.h"              /* tty_setcolor */
 #include "color-internal.h"
 #include "key.h"
 #include "mouse.h"
@@ -119,6 +120,44 @@ sigwinch_handler (int dummy)
     (void) n;
 }
 
+/* --------------------------------------------------------------------------------------------- */
+
+/**
+ * Get visible part of area.
+ *
+ * @returns TRUE if any part of area is in screen bounds, FALSE otherwise.
+ */
+static gboolean
+tty_clip (int *y, int *x, int *rows, int *cols)
+{
+    if (*y < 0)
+    {
+        *rows += *y;
+
+        if (*rows <= 0)
+            return FALSE;
+
+        *y = 0;
+    }
+
+    if (*x < 0)
+    {
+        *cols += *x;
+
+        if (*cols <= 0)
+            return FALSE;
+
+        *x = 0;
+    }
+
+    if (*y + *rows > LINES)
+        *rows = LINES - *y;
+    if (*x + *cols > COLS)
+        *cols = COLS - *x;
+
+    return TRUE;
+}
+
 /* --------------------------------------------------------------------------------------------- */
 /*** public functions ****************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -494,30 +533,8 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 {
     int i;
 
-    if (y < 0)
-    {
-        rows += y;
-
-        if (rows <= 0)
-            return;
-
-        y = 0;
-    }
-
-    if (x < 0)
-    {
-        cols += x;
-
-        if (cols <= 0)
-            return;
-
-        x = 0;
-    }
-
-    if (y + rows > LINES)
-        rows = LINES - y;
-    if (x + cols > COLS)
-        cols = COLS - x;
+    if (!tty_clip (&y, &x, &rows, &cols))
+        return;
 
     for (i = 0; i < rows; i++)
     {
@@ -533,6 +550,38 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_colorize_area (int y, int x, int rows, int cols, int color)
+{
+    cchar_t *ctext;
+    wchar_t wch[10];            /* TODO not sure if the length is correct */
+    attr_t attrs;
+    short color_pair;
+
+    if (!use_colors || !tty_clip (&y, &x, &rows, &cols))
+        return;
+
+    tty_setcolor (color);
+    ctext = g_malloc (sizeof (cchar_t) * (cols + 1));
+
+    for (int row = 0; row < rows; row++)
+    {
+        mvin_wchnstr (y + row, x, ctext, cols);
+
+        for (int col = 0; col < cols; col++)
+        {
+            getcchar (&ctext[col], wch, &attrs, &color_pair, NULL);
+            setcchar (&ctext[col], wch, attrs, color, NULL);
+        }
+
+        mvadd_wchnstr (y + row, x, ctext, cols);
+    }
+
+    g_free (ctext);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_set_alt_charset (gboolean alt_charset)
 {
diff --git a/lib/tty/tty-slang.c b/lib/tty/tty-slang.c
index 0d8e89ff7..6bf22a90d 100644
--- a/lib/tty/tty-slang.c
+++ b/lib/tty/tty-slang.c
@@ -622,6 +622,15 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_colorize_area (int y, int x, int rows, int cols, int color)
+{
+    if (use_colors)
+        SLsmg_set_color_in_region (color, y, x, rows, cols);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_set_alt_charset (gboolean alt_charset)
 {
diff --git a/lib/tty/tty.c b/lib/tty/tty.c
index a3929b011..d4a731343 100644
--- a/lib/tty/tty.c
+++ b/lib/tty/tty.c
@@ -264,6 +264,17 @@ tty_draw_box (int y, int x, int ys, int xs, gboolean single)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_draw_box_shadow (int y, int x, int rows, int cols, int shadow_color)
+{
+    /* draw right shadow */
+    tty_colorize_area (y + 1, x + cols, rows - 1, 2, shadow_color);
+    /* draw bottom shadow */
+    tty_colorize_area (y + rows, x + 2, 1, cols, shadow_color);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 char *
 mc_tty_normalize_from_utf8 (const char *str)
 {
diff --git a/lib/tty/tty.h b/lib/tty/tty.h
index fb1d94da8..5b9bf684f 100644
--- a/lib/tty/tty.h
+++ b/lib/tty/tty.h
@@ -126,6 +126,7 @@ extern void tty_print_one_hline (gboolean single);
 extern void tty_draw_hline (int y, int x, int ch, int len);
 extern void tty_draw_vline (int y, int x, int ch, int len);
 extern void tty_draw_box (int y, int x, int rows, int cols, gboolean single);
+extern void tty_draw_box_shadow (int y, int x, int rows, int cols, int shadow_color);
 extern void tty_fill_region (int y, int x, int rows, int cols, unsigned char ch);
 
 extern int tty_resize (int fd);
diff --git a/lib/util.c b/lib/util.c
index 1a9bfd16f..6c65a59b1 100644
--- a/lib/util.c
+++ b/lib/util.c
@@ -51,7 +51,6 @@
 #include "lib/vfs/vfs.h"
 #include "lib/strutil.h"
 #include "lib/util.h"
-#include "lib/timer.h"
 
 /*** global variables ****************************************************************************/
 
@@ -1518,11 +1517,11 @@ mc_replace_error (GError ** dest, int code, const char *format, ...)
  * @return TRUE if clock skew detected, FALSE otherwise
  */
 gboolean
-mc_time_elapsed (guint64 * timestamp, guint64 delay)
+mc_time_elapsed (gint64 * timestamp, gint64 delay)
 {
-    guint64 now;
+    gint64 now;
 
-    now = mc_timer_elapsed (mc_global.timer);
+    now = g_get_real_time ();
 
     if (now >= *timestamp && now < *timestamp + delay)
         return FALSE;
diff --git a/lib/util.h b/lib/util.h
index 46ac1f0b4..efe386bee 100644
--- a/lib/util.h
+++ b/lib/util.h
@@ -38,6 +38,22 @@
 #define MC_PIPE_ERROR_CREATE_PIPE_STREAM -4
 #define MC_PIPE_ERROR_READ -5
 
+/* gnulib efa15594e17fc20827dba66414fb391e99905394
+
+ *_GL_CMP (n1, n2) performs a three-valued comparison on n1 vs. n2.
+ *  It returns
+ *    1  if n1 > n2
+ *    0  if n1 == n2
+ *    -1 if n1 < n2
+ *  The native code   (n1 > n2 ? 1 : n1 < n2 ? -1 : 0)  produces a conditional
+ *  jump with nearly all GCC versions up to GCC 10.
+ *  This variant      (n1 < n2 ? -1 : n1 > n2)  produces a conditional with many
+ *  GCC versions up to GCC 9.
+ *  The better code  (n1 > n2) - (n1 < n2)  from Hacker's Delight para 2-9
+ *  avoids conditional jumps in all GCC versions >= 3.4.
+ */
+#define _GL_CMP(n1, n2) (((n1) > (n2)) - ((n1) < (n2)))
+
 /*** enums ***************************************************************************************/
 
 /* Pathname canonicalization */
@@ -256,7 +272,7 @@ void mc_propagate_error (GError ** dest, int code, const char *format, ...) G_GN
 void mc_replace_error (GError ** dest, int code, const char *format, ...) G_GNUC_PRINTF (3, 4);
 /* *INDENT-ON* */
 
-gboolean mc_time_elapsed (guint64 * timestamp, guint64 delay);
+gboolean mc_time_elapsed (gint64 * timestamp, gint64 delay);
 
 /*** inline functions **************************************************/
 
diff --git a/lib/vfs/direntry.c b/lib/vfs/direntry.c
index 87e71a660..d2211ea5b 100644
--- a/lib/vfs/direntry.c
+++ b/lib/vfs/direntry.c
@@ -70,7 +70,6 @@
 
 #include "lib/tty/tty.h"        /* enable/disable interrupt key */
 #include "lib/util.h"           /* custom_canonicalize_pathname() */
-#include "lib/timer.h"
 #if 0
 #include "lib/widget.h"         /* message() */
 #endif
@@ -453,10 +452,10 @@ vfs_s_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 vfs_s_readdir (void *data)
 {
-    static union vfs_dirent dir;
+    struct vfs_dirent *dir = NULL;
     struct dirhandle *info = (struct dirhandle *) data;
     const char *name;
 
@@ -465,13 +464,13 @@ vfs_s_readdir (void *data)
 
     name = VFS_ENTRY (info->cur->data)->name;
     if (name != NULL)
-        g_strlcpy (dir.dent.d_name, name, MC_MAXPATHLEN);
+        dir = vfs_dirent_init (NULL, name, 0);
     else
         vfs_die ("Null in structure-cannot happen");
 
     info->cur = g_list_next (info->cur);
 
-    return (void *) &dir;
+    return dir;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -863,7 +862,7 @@ vfs_s_free (vfsid id)
 static gboolean
 vfs_s_dir_uptodate (struct vfs_class *me, struct vfs_s_inode *ino)
 {
-    guint64 tim;
+    gint64 tim;
 
     if (me->flush)
     {
@@ -871,7 +870,7 @@ vfs_s_dir_uptodate (struct vfs_class *me, struct vfs_s_inode *ino)
         return 0;
     }
 
-    tim = mc_timer_elapsed (mc_global.timer);
+    tim = g_get_real_time ();
 
     return (tim < ino->timestamp);
 }
diff --git a/lib/vfs/gc.c b/lib/vfs/gc.c
index 5090aaacb..d0bad1f91 100644
--- a/lib/vfs/gc.c
+++ b/lib/vfs/gc.c
@@ -44,7 +44,6 @@
 #include "lib/global.h"
 #include "lib/event.h"
 #include "lib/util.h"           /* MC_PTR_FREE */
-#include "lib/timer.h"
 
 #include "vfs.h"
 #include "utilvfs.h"
@@ -98,7 +97,7 @@ struct vfs_stamping
 {
     struct vfs_class *v;
     vfsid id;
-    guint64 time;
+    gint64 time;
 };
 
 /*** file scope variables ************************************************************************/
@@ -130,7 +129,7 @@ vfs_addstamp (struct vfs_class *v, vfsid id)
         stamp = g_new (struct vfs_stamping, 1);
         stamp->v = v;
         stamp->id = id;
-        stamp->time = mc_timer_elapsed (mc_global.timer);
+        stamp->time = g_get_real_time ();
 
         stamps = g_slist_append (stamps, stamp);
     }
@@ -153,7 +152,7 @@ vfs_stamp (struct vfs_class *v, vfsid id)
     stamp = g_slist_find_custom (stamps, &what, vfs_stamp_compare);
     if (stamp != NULL && stamp->data != NULL)
     {
-        VFS_STAMPING (stamp->data)->time = mc_timer_elapsed (mc_global.timer);
+        VFS_STAMPING (stamp->data)->time = g_get_real_time ();
         ret = TRUE;
     }
 
@@ -239,7 +238,7 @@ void
 vfs_expire (gboolean now)
 {
     static gboolean locked = FALSE;
-    guint64 curr_time, exp_time;
+    gint64 curr_time, exp_time;
     GSList *stamp;
 
     /* Avoid recursive invocation, e.g. when one of the free functions
@@ -248,7 +247,7 @@ vfs_expire (gboolean now)
         return;
     locked = TRUE;
 
-    curr_time = mc_timer_elapsed (mc_global.timer);
+    curr_time = g_get_real_time ();
     exp_time = curr_time - vfs_timeout * G_USEC_PER_SEC;
 
     if (now)
diff --git a/lib/vfs/interface.c b/lib/vfs/interface.c
index ca29653a2..6c4d9fde0 100644
--- a/lib/vfs/interface.c
+++ b/lib/vfs/interface.c
@@ -62,12 +62,10 @@
 /* TODO: move it to separate private .h */
 extern GString *vfs_str_buffer;
 extern vfs_class *current_vfs;
-extern struct dirent *mc_readdir_result;
+extern struct vfs_dirent *mc_readdir_result;
 
 /*** global variables ****************************************************************************/
 
-struct dirent *mc_readdir_result = NULL;
-
 /*** file scope macro definitions ****************************************************************/
 
 /*** file scope type declarations ****************************************************************/
@@ -458,30 +456,15 @@ mc_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-struct dirent *
+struct vfs_dirent *
 mc_readdir (DIR * dirp)
 {
     int handle;
     struct vfs_class *vfs;
     void *fsinfo = NULL;
-    struct dirent *entry = NULL;
+    struct vfs_dirent *entry = NULL;
     vfs_path_element_t *vfs_path_element;
 
-    if (mc_readdir_result == NULL)
-    {
-        /* We can't just allocate struct dirent as (see man dirent.h)
-         * struct dirent has VERY nonnaive semantics of allocating
-         * d_name in it. Moreover, linux's glibc-2.9 allocates dirents _less_,
-         * than 'sizeof (struct dirent)' making full bitwise (sizeof dirent) copy
-         * heap corrupter. So, allocate longliving dirent with at least
-         * (MAXNAMLEN + 1) for d_name in it.
-         * Strictly saying resulting dirent is unusable as we don't adjust internal
-         * structures, holding dirent size. But we don't use it in libc infrastructure.
-         * TODO: to make simpler homemade dirent-alike structure.
-         */
-        mc_readdir_result = (struct dirent *) g_malloc (sizeof (struct dirent) + MAXNAMLEN + 1);
-    }
-
     if (dirp == NULL)
     {
         errno = EFAULT;
@@ -507,8 +490,8 @@ mc_readdir (DIR * dirp)
 #else
         g_string_assign (vfs_str_buffer, entry->d_name);
 #endif
-        mc_readdir_result->d_ino = entry->d_ino;
-        g_strlcpy (mc_readdir_result->d_name, vfs_str_buffer->str, MAXNAMLEN + 1);
+        vfs_dirent_assign (mc_readdir_result, vfs_str_buffer->str, entry->d_ino);
+        vfs_dirent_free (entry);
     }
     if (entry == NULL)
         errno = vfs->readdir ? vfs_ferrno (vfs) : E_NOTSUPP;
diff --git a/lib/vfs/vfs.c b/lib/vfs/vfs.c
index 0b948846c..b21cd866e 100644
--- a/lib/vfs/vfs.c
+++ b/lib/vfs/vfs.c
@@ -69,13 +69,14 @@
 #include "gc.h"
 
 /* TODO: move it to the separate .h */
-extern struct dirent *mc_readdir_result;
+extern struct vfs_dirent *mc_readdir_result;
 extern GPtrArray *vfs__classes_list;
 extern GString *vfs_str_buffer;
 extern vfs_class *current_vfs;
 
 /*** global variables ****************************************************************************/
 
+struct vfs_dirent *mc_readdir_result = NULL;
 GPtrArray *vfs__classes_list = NULL;
 GString *vfs_str_buffer = NULL;
 vfs_class *current_vfs = NULL;
@@ -469,6 +470,7 @@ vfs_init (void)
 
     vfs_str_buffer = g_string_new ("");
 
+    mc_readdir_result = vfs_dirent_init (NULL, "", -1);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -518,10 +520,70 @@ vfs_shut (void)
     vfs_str_buffer = NULL;
     current_vfs = NULL;
     vfs_free_handle_list = -1;
-    MC_PTR_FREE (mc_readdir_result);
+    vfs_dirent_free (mc_readdir_result);
+    mc_readdir_result = NULL;
 }
 
 /* --------------------------------------------------------------------------------------------- */
+/**
+  * Init or create vfs_dirent structure
+  *
+  * @d vfs_dirent structure to init. If NULL, new structure is created.
+  * @fname file name
+  * @ino file inode number
+  *
+  * @return pointer to d if d isn't NULL, or pointer to newly created structure.
+  */
+
+struct vfs_dirent *
+vfs_dirent_init (struct vfs_dirent *d, const char *fname, ino_t ino)
+{
+    struct vfs_dirent *ret = d;
+
+    if (ret == NULL)
+        ret = g_new0 (struct vfs_dirent, 1);
+
+    if (ret->d_name_str == NULL)
+        ret->d_name_str = g_string_sized_new (MC_MAXFILENAMELEN);
+
+    vfs_dirent_assign (ret, fname, ino);
+
+    return ret;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+/**
+  * Assign members of vfs_dirent structure
+  *
+  * @d vfs_dirent structure for assignment
+  * @fname file name
+  * @ino file inode number
+  */
+
+void
+vfs_dirent_assign (struct vfs_dirent *d, const char *fname, ino_t ino)
+{
+    g_string_assign (d->d_name_str, fname);
+    d->d_name = d->d_name_str->str;
+    d->d_ino = ino;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+/**
+  * Destroy vfs_dirent structure
+  *
+  * @d vfs_dirent structure to destroy.
+  */
+
+void
+vfs_dirent_free (struct vfs_dirent *d)
+{
+    g_string_free (d->d_name_str, TRUE);
+    g_free (d);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 /**
  * These ones grab information from the VFS
  *  and handles them to an upper layer
diff --git a/lib/vfs/vfs.h b/lib/vfs/vfs.h
index a1d4bf949..2b0e6fb4c 100644
--- a/lib/vfs/vfs.h
+++ b/lib/vfs/vfs.h
@@ -9,7 +9,7 @@
 
 #include <sys/types.h>
 #include <sys/stat.h>
-#include <dirent.h>
+#include <dirent.h>             /* DIR */
 #ifdef HAVE_UTIMENSAT
 #include <sys/time.h>
 #elif defined (HAVE_UTIME_H)
@@ -20,7 +20,6 @@
 #include <stddef.h>
 
 #include "lib/global.h"
-#include "lib/fs.h"             /* MC_MAXPATHLEN */
 
 #include "path.h"
 
@@ -172,7 +171,7 @@ typedef struct vfs_class
     ssize_t (*write) (void *vfs_info, const char *buf, size_t count);
 
     void *(*opendir) (const vfs_path_t * vpath);
-    void *(*readdir) (void *vfs_info);
+    struct vfs_dirent *(*readdir) (void *vfs_info);
     int (*closedir) (void *vfs_info);
 
     int (*stat) (const vfs_path_t * vpath, struct stat * buf);
@@ -211,13 +210,17 @@ typedef struct vfs_class
 } vfs_class;
 
 /*
- * This union is used to ensure that there is enough space for the
- * filename (d_name) when the dirent structure is created.
+ * This struct is used instead of standard dirent to hold file name of any length
+ * (not limited to NAME_MAX).
  */
-union vfs_dirent
+struct vfs_dirent
 {
-    struct dirent dent;
-    char _extra_buffer[offsetof (struct dirent, d_name) + MC_MAXPATHLEN + 1];
+    /* private */
+    GString *d_name_str;
+
+    /* public */
+    ino_t d_ino;
+    char *d_name;               /* Alias of d_name_str->str */
 };
 
 /*** global variables defined in .c file *********************************************************/
@@ -278,6 +281,10 @@ void vfs_stamp_path (const vfs_path_t * path);
 
 void vfs_release_path (const vfs_path_t * vpath);
 
+struct vfs_dirent *vfs_dirent_init (struct vfs_dirent *d, const char *fname, ino_t ino);
+void vfs_dirent_assign (struct vfs_dirent *d, const char *fname, ino_t ino);
+void vfs_dirent_free (struct vfs_dirent *d);
+
 void vfs_fill_names (fill_names_f);
 
 /* *INDENT-OFF* */
@@ -309,7 +316,7 @@ int mc_readlink (const vfs_path_t * vpath, char *buf, size_t bufsiz);
 int mc_close (int handle);
 off_t mc_lseek (int fd, off_t offset, int whence);
 DIR *mc_opendir (const vfs_path_t * vpath);
-struct dirent *mc_readdir (DIR * dirp);
+struct vfs_dirent *mc_readdir (DIR * dirp);
 int mc_closedir (DIR * dir);
 int mc_stat (const vfs_path_t * vpath, struct stat *buf);
 int mc_mknod (const vfs_path_t * vpath, mode_t mode, dev_t dev);
diff --git a/lib/vfs/xdirentry.h b/lib/vfs/xdirentry.h
index 7b6410e74..56ce843a3 100644
--- a/lib/vfs/xdirentry.h
+++ b/lib/vfs/xdirentry.h
@@ -91,7 +91,7 @@ struct vfs_s_inode
     struct stat st;             /* Parameters of this inode */
     char *linkname;             /* Symlink's contents */
     char *localname;            /* Filename of local file, if we have one */
-    guint64 timestamp;          /* Subclass specific */
+    gint64 timestamp;           /* Subclass specific */
     off_t data_offset;          /* Subclass specific */
 };
 
diff --git a/lib/widget/dialog.c b/lib/widget/dialog.c
index 57813750c..f984e03af 100644
--- a/lib/widget/dialog.c
+++ b/lib/widget/dialog.c
@@ -206,6 +206,8 @@ dlg_handle_key (WDialog * h, int d_key)
     long command;
 
     command = widget_lookup_key (WIDGET (h), d_key);
+    if (command == CK_IgnoreKey)
+        command = keybind_lookup_keymap_command (dialog_map, d_key);
     if (command != CK_IgnoreKey)
         return dlg_execute_cmd (h, command);
 
diff --git a/lib/widget/frame.c b/lib/widget/frame.c
index 1f4f14d8a..5d5a5acdf 100644
--- a/lib/widget/frame.c
+++ b/lib/widget/frame.c
@@ -76,6 +76,9 @@ frame_draw (const WFrame * f)
 
     colors = widget_get_colors (w);
 
+    if (mc_global.tty.shadows)
+        tty_draw_box_shadow (w->y, w->x, w->lines, w->cols, SHADOW_COLOR);
+
     tty_setcolor (colors[FRAME_COLOR_NORMAL]);
     tty_fill_region (w->y, w->x, w->lines, w->cols, ' ');
     tty_draw_box (w->y + d, w->x + d, w->lines - 2 * d, w->cols - 2 * d, f->single);
diff --git a/lib/widget/input_complete.c b/lib/widget/input_complete.c
index 59a994d62..c23fe6063 100644
--- a/lib/widget/input_complete.c
+++ b/lib/widget/input_complete.c
@@ -139,7 +139,7 @@ filename_completion_function (const char *text, int state, input_complete_t flag
     static vfs_path_t *dirname_vpath = NULL;
 
     gboolean isdir = TRUE, isexec = FALSE;
-    struct dirent *entry = NULL;
+    struct vfs_dirent *entry = NULL;
 
     SHOW_C_CTX ("filename_completion_function");
 
diff --git a/lib/widget/menu.c b/lib/widget/menu.c
index ca2ff472a..271832e9d 100644
--- a/lib/widget/menu.c
+++ b/lib/widget/menu.c
@@ -187,6 +187,10 @@ menubar_draw_drop (const WMenuBar * menubar)
     if (column + menu->max_entry_len + 5 > (gsize) w->cols)
         column = w->cols - menu->max_entry_len - 5;
 
+    if (mc_global.tty.shadows)
+        tty_draw_box_shadow (w->y + 1, w->x + column, count + 2, menu->max_entry_len + 5,
+                             SHADOW_COLOR);
+
     tty_setcolor (MENU_ENTRY_COLOR);
     tty_draw_box (w->y + 1, w->x + column, count + 2, menu->max_entry_len + 5, FALSE);
 
diff --git a/lib/widget/wtools.c b/lib/widget/wtools.c
index 00cc50df7..5c5dc4487 100644
--- a/lib/widget/wtools.c
+++ b/lib/widget/wtools.c
@@ -583,17 +583,17 @@ void
 status_msg_init (status_msg_t * sm, const char *title, double delay, status_msg_cb init_cb,
                  status_msg_update_cb update_cb, status_msg_cb deinit_cb)
 {
-    guint64 start;
+    gint64 start;
 
     /* repaint screen to remove previous finished dialog */
     mc_refresh ();
 
-    start = mc_timer_elapsed (mc_global.timer);
+    start = g_get_real_time ();
 
     sm->dlg = dlg_create (TRUE, 0, 0, 7, MIN (MAX (40, COLS / 2), COLS), WPOS_CENTER, FALSE,
                           dialog_colors, NULL, NULL, NULL, title);
     sm->start = start;
-    sm->delay = (guint64) (delay * G_USEC_PER_SEC);
+    sm->delay = (gint64) (delay * G_USEC_PER_SEC);
     sm->block = FALSE;
 
     sm->init = init_cb;
@@ -658,7 +658,7 @@ status_msg_common_update (status_msg_t * sm)
         /* dialog is not shown yet */
 
         /* do not change sm->start */
-        guint64 start = sm->start;
+        gint64 start = sm->start;
 
         if (mc_time_elapsed (&start, sm->delay))
             dlg_init (sm->dlg);
diff --git a/lib/widget/wtools.h b/lib/widget/wtools.h
index 3dbaef15f..cd0bc3253 100644
--- a/lib/widget/wtools.h
+++ b/lib/widget/wtools.h
@@ -5,8 +5,6 @@
 #ifndef MC__WTOOLS_H
 #define MC__WTOOLS_H
 
-#include "lib/timer.h"
-
 /*** typedefs(not structures) and defined constants **********************************************/
 
 /* Pass this as def_text to request a password */
@@ -42,8 +40,8 @@ enum
 struct status_msg_t
 {
     WDialog *dlg;               /* pointer to status message dialog */
-    guint64 start;              /* start time in microseconds */
-    guint64 delay;              /* delay before raise the 'dlg' in microseconds */
+    gint64 start;               /* start time in microseconds */
+    gint64 delay;               /* delay before raise the 'dlg' in microseconds */
     gboolean block;             /* how to get event using tty_get_event() */
 
     status_msg_cb init;         /* callback to init derived classes */
diff --git a/m4.include/gnulib/fsusage.m4 b/m4.include/gnulib/fsusage.m4
index 6c104fc5a..c15cfca4d 100644
--- a/m4.include/gnulib/fsusage.m4
+++ b/m4.include/gnulib/fsusage.m4
@@ -1,7 +1,7 @@
-# serial 34
+# serial 35
 # Obtaining file system usage information.
 
-# Copyright (C) 1997-1998, 2000-2001, 2003-2017 Free Software Foundation, Inc.
+# Copyright (C) 1997-1998, 2000-2001, 2003-2020 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -36,7 +36,6 @@ AC_DEFUN([gl_FILE_SYSTEM_USAGE],
   dnl Mac OS X >= 10.5 (32-bit mode).
   AC_REQUIRE([AC_SYS_LARGEFILE])
 
-  AC_MSG_CHECKING([how to get file system space usage])
   ac_fsusage_space=no
 
   # Perform only the link test since it seems there are no variants of the
diff --git a/m4.include/gnulib/mountlist.m4 b/m4.include/gnulib/mountlist.m4
index a95c1f4bd..2705c60a9 100644
--- a/m4.include/gnulib/mountlist.m4
+++ b/m4.include/gnulib/mountlist.m4
@@ -1,4 +1,4 @@
-# serial 13
+# serial 14
 dnl Copyright (C) 2002-2006, 2009-2019 Free Software Foundation, Inc.
 dnl This file is free software; the Free Software Foundation
 dnl gives unlimited permission to copy and/or distribute it,
@@ -244,7 +244,7 @@ extern
 "C"
 #endif
 int getmntinfo (struct statfs **, int);
-              ]], [])],
+              ]], [[]])],
            [fu_cv_sys_mounted_getmntinfo2=no],
            [fu_cv_sys_mounted_getmntinfo2=yes])
         ])
diff --git a/m4.include/gnulib/stat-size.m4 b/m4.include/gnulib/stat-size.m4
index 86d409864..95f482873 100644
--- a/m4.include/gnulib/stat-size.m4
+++ b/m4.include/gnulib/stat-size.m4
@@ -1,6 +1,6 @@
 #serial 1
 
-# Copyright (C) 2011-2016 Free Software Foundation, Inc.
+# Copyright (C) 2011-2020 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -9,6 +9,6 @@
 AC_DEFUN([gl_STAT_SIZE],
 [
   # Don't call AC_STRUCT_ST_BLOCKS because it causes bugs.  Details at
-  # http://lists.gnu.org/archive/html/bug-gnulib/2011-06/msg00051.html
+  # https://lists.gnu.org/r/bug-gnulib/2011-06/msg00051.html
   AC_CHECK_HEADERS_ONCE([sys/param.h])
 ])
diff --git a/misc/ext.d/archive.sh b/misc/ext.d/archive.sh
index afe8a0609..840fd4717 100755
--- a/misc/ext.d/archive.sh
+++ b/misc/ext.d/archive.sh
@@ -146,6 +146,9 @@ do_view_action() {
     zoo)
         zoo l "${MC_EXT_FILENAME}"
         ;;
+    wim)
+        wimlib-imagex info "${MC_EXT_FILENAME}" 2> /dev/null
+        ;;
     *)
         ;;
     esac
diff --git a/misc/ext.d/doc.sh.in b/misc/ext.d/doc.sh.in
index 871773c3a..72deae7dd 100644
--- a/misc/ext.d/doc.sh.in
+++ b/misc/ext.d/doc.sh.in
@@ -25,9 +25,9 @@ staroffice_console() {
 }
 
 get_ooffice_executable() {
-    if loffice >/dev/null 2>&1; then
+    if which loffice >/dev/null 2>&1; then
         echo "loffice"
-    elif ooffice >/dev/null 2>&1; then
+    elif which ooffice >/dev/null 2>&1; then
         echo "ooffice"
     else
         echo -n
@@ -52,28 +52,28 @@ do_view_action() {
         fi
         ;;
     msdoc)
-        if wvHtml >/dev/null 2>&1; then
+        if which wvHtml >/dev/null 2>&1; then
             tmp=`mktemp -d ${TMPDIR:-/tmp}/%p.XXXXXX`
             wvHtml "${MC_EXT_FILENAME}" --targetdir="$tmp" page.html
             elinks -dump "$tmp/page.html"
             rm -rf "$tmp"
-        elif antiword >/dev/null 2>&1; then
+        elif which antiword >/dev/null 2>&1; then
             antiword -t "${MC_EXT_FILENAME}"
-        elif catdoc >/dev/null 2>&1; then
+        elif which catdoc >/dev/null 2>&1; then
             catdoc -w "${MC_EXT_FILENAME}"
-        elif word2x >/dev/null 2>&1; then
+        elif which word2x >/dev/null 2>&1; then
             word2x -f text "${MC_EXT_FILENAME}" -
         else
             strings "${MC_EXT_FILENAME}"
         fi
         ;;
     msxls)
-        if xlhtml >/dev/null 2>&1; then
+        if which xlhtml >/dev/null 2>&1; then
             tmp=`mktemp -d ${TMPDIR:-/tmp}/%p.XXXXXX`
             xlhtml -a "${MC_EXT_FILENAME}" > "$tmp/page.html"
             elinks -dump "$tmp/page.html"
             rm -rf "$tmp"
-        elif xls2csv >/dev/null 2>&1; then
+        elif which xls2csv >/dev/null 2>&1; then
             xls2csv "${MC_EXT_FILENAME}"
         else
             strings "${MC_EXT_FILENAME}"
diff --git a/misc/ext.d/image.sh b/misc/ext.d/image.sh
index 583c09ecf..04307e01b 100755
--- a/misc/ext.d/image.sh
+++ b/misc/ext.d/image.sh
@@ -45,7 +45,7 @@ do_open_action() {
             else
                 (gqview "${MC_EXT_FILENAME}" &)
             fi
-        elif see >/dev/null 2>&1; then
+        elif which see >/dev/null 2>&1; then
             (see "${MC_EXT_FILENAME}" &)
         else
             (zgv "${MC_EXT_FILENAME}" &)
diff --git a/misc/ext.d/misc.sh.in b/misc/ext.d/misc.sh.in
index f4b0bd47b..32a5f3f8d 100644
--- a/misc/ext.d/misc.sh.in
+++ b/misc/ext.d/misc.sh.in
@@ -71,7 +71,7 @@ do_open_action() {
         sqlite3 "${MC_EXT_FILENAME}"
         ;;
     glade)
-        if glade-3 --version >/dev/null 2>&1; then
+        if which glade-3 >/dev/null 2>&1; then
             (glade-3 "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             (glade-2 "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
diff --git a/misc/ext.d/sound.sh b/misc/ext.d/sound.sh
index 760aaf1dd..c92b868ab 100755
--- a/misc/ext.d/sound.sh
+++ b/misc/ext.d/sound.sh
@@ -38,7 +38,7 @@ do_open_action() {
     case "${filetype}" in
     common)
         if [ -n "$DISPLAY" ]; then
-            (xmms  "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious  "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             play "${MC_EXT_FILENAME}"
         fi
@@ -52,21 +52,21 @@ do_open_action() {
         ;;
     mp3)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             mpg123 "${MC_EXT_FILENAME}"
         fi
         ;;
     ogg)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             ogg123 "${MC_EXT_FILENAME}"
         fi
         ;;
     opus)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             play "${MC_EXT_FILENAME}"
         fi
@@ -79,7 +79,7 @@ do_open_action() {
         ;;
     playlist)
         if [ -n "$DISPLAY" ]; then
-            (xmms -p "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious -p "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             mplayer -vo null -playlist "${MC_EXT_FILENAME}"
         fi
diff --git a/misc/ext.d/video.sh b/misc/ext.d/video.sh
index 979a50acc..9cba21020 100755
--- a/misc/ext.d/video.sh
+++ b/misc/ext.d/video.sh
@@ -13,7 +13,7 @@ do_view_action() {
 
     case "${filetype}" in
     *)
-        if mplayer >/dev/null 2>&1; then
+        if which mplayer >/dev/null 2>&1; then
             mplayer -identify -vo null -ao null -frames 0 "${MC_EXT_FILENAME}" 2>&1 | \
                 sed -n 's/^ID_//p'
         elif which mpv_identify.sh >/dev/null 2>&1; then
@@ -28,9 +28,9 @@ do_view_action() {
 do_open_action() {
     filetype=$1
 
-    if mpv >/dev/null 2>&1; then
+    if which mpv >/dev/null 2>&1; then
         PLAYER=mpv
-    elif mplayer >/dev/null 2>&1; then
+    elif which mplayer >/dev/null 2>&1; then
         PLAYER=mplayer
     else
         echo "Please install either mplayer or mpv to play this file"
diff --git a/misc/mc.default.keymap b/misc/mc.default.keymap
index d05e97e65..1bf68b2df 100644
--- a/misc/mc.default.keymap
+++ b/misc/mc.default.keymap
@@ -1,5 +1,5 @@
 [main]
-ChangePanel = tab
+ChangePanel = tab; ctrl-i
 Help = f1
 UserMenu = f2
 View = f3
diff --git a/misc/mc.emacs.keymap b/misc/mc.emacs.keymap
index 70935cd47..022de7698 100644
--- a/misc/mc.emacs.keymap
+++ b/misc/mc.emacs.keymap
@@ -1,5 +1,5 @@
 [main]
-ChangePanel = tab
+ChangePanel = tab; ctrl-i
 Help = f1
 UserMenu = f2
 View = f3
diff --git a/misc/mc.ext.in b/misc/mc.ext.in
index c938d0504..bedfb7c70 100644
--- a/misc/mc.ext.in
+++ b/misc/mc.ext.in
@@ -176,6 +176,11 @@ type/^LHa\ .*archive
 	Open=%cd %p/ulha://
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lha
 
+# PAK
+type/^PAK\ .*archive
+	Open=%cd %p/unar://
+	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view pak
+
 # arj
 regex/i/\.a(rj|[0-9][0-9])$
 	Open=%cd %p/uarj://
@@ -361,16 +366,6 @@ shell/.info
 shell/i/.3gp
 	Include=video
 
-# Manual page
-regex/(([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])|\.man)$
-	Open=@EXTHELPERSDIR@/text.sh open man %var{PAGER:more}
-	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man %var{PAGER:more}
-
-# Perl pod page
-shell/.pod
-	Open=@EXTHELPERSDIR@/text.sh open pod %var{PAGER:more}
-	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view pod %var{PAGER:more}
-
 # Troff with me macros.
 # Exception - "read.me" is not a nroff file.
 shell/read.me
@@ -387,18 +382,28 @@ shell/.ms
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view nroff.ms %var{PAGER:more}
 
 # Manual page - compressed
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.g?[Zz]$
+type/^(ASCII )?troff.*gzip compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.gz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.gz %var{PAGER:more}
 
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.bz$
+type/^(ASCII )?troff.*bzip compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.bz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.bz %var{PAGER:more}
 
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.bz2$
+type/^(ASCII )?troff.*bzip2 compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.bz2 %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.bz2 %var{PAGER:more}
 
+# Manual page
+type/^(ASCII )?troff
+	Open=@EXTHELPERSDIR@/text.sh open man %var{PAGER:more}
+	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man %var{PAGER:more}
+
+# Perl pod page
+shell/.pod
+	Open=@EXTHELPERSDIR@/text.sh open pod %var{PAGER:more}
+	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view pod %var{PAGER:more}
+
 regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.lz$
 	Open=@EXTHELPERSDIR@/text.sh open man.lz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.lz %var{PAGER:more}
@@ -671,10 +676,6 @@ regex/i/\.(epub|mobi)$
 shell/.class
 	View=%view{ascii} @EXTHELPERSDIR@/misc.sh view javaclass
 
-# Makefile
-regex/^[Mm]akefile$
-	Open=make -f %f %{Enter parameters}
-
 # Imakefile
 shell/Imakefile
 	Open=xmkmf -a
@@ -683,6 +684,10 @@ shell/Imakefile
 regex/^Makefile\.(PL|pl)$
 	Open=%var{PERL:perl} %f
 
+# Makefile
+regex/[Mm]akefile
+	Open=make -f %f %{Enter parameters}
+
 # sqlite3.db
 type/^SQLite 3.x database
 	Open=@EXTHELPERSDIR@/misc.sh open sqlite
@@ -761,38 +766,27 @@ shell/i/.zoo
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view zoo
 
 # gzip
-type/^gzip
+type/\(gzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view gz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
 
-regex/\.(gz|Z)$
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
-
 # bzip2
-type/^bzip2
+type/\(bzip2 compressed
 	Open=@EXTHELPERSDIR@/archive.sh view bzip2 %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bz2
 
-regex/\.bz2?$
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bz2
-
 # bzip
-type/^bzip
+type/\(bzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view bzip %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bzip
 
 # compress
-type/^compress
+type/\(compress'd
 	Open=@EXTHELPERSDIR@/archive.sh view gz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
 
 # lz
-regex/\.lz$
-	Open=@EXTHELPERSDIR@/archive.sh view lz %var{PAGER:more}
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz
-
-# lz
-type/^LZIP
+type/\(lzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view lz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz
 
@@ -802,17 +796,17 @@ regex/\.lz4$
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz4
 
 # lzma
-regex/\.lzma$
+type/\(LZMA compressed
 	Open=@EXTHELPERSDIR@/archive.sh view lzma %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lzma
 
 # xz
-regex/\.xz$
+type/\(XZ compressed
 	Open=@EXTHELPERSDIR@/archive.sh view xz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view xz
 
 # zstd
-regex/\.zst$
+type/\(Zstandard compressed
 	Open=@EXTHELPERSDIR@/archive.sh view zst %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view zst
 
@@ -820,6 +814,10 @@ regex/\.zst$
 type/^Parity\ Archive\ Volume\ Set
 	Open=@EXTHELPERSDIR@/archive.sh open par2
 
+# WIM
+shell/i/\.wim
+	Open=%cd %p/uwim://
+	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view wim
 
 ### Includes
 # includes should be at end of bindings
diff --git a/misc/skins/dark.ini b/misc/skins/dark.ini
index 58d6f8351..0cfeb8ecf 100644
--- a/misc/skins/dark.ini
+++ b/misc/skins/dark.ini
@@ -39,6 +39,7 @@
     header = yellow;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/darkfar.ini b/misc/skins/darkfar.ini
index e0e1a5879..c6dcf68f2 100644
--- a/misc/skins/darkfar.ini
+++ b/misc/skins/darkfar.ini
@@ -39,6 +39,7 @@
     header = yellow;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/default.ini b/misc/skins/default.ini
index afc060ade..145eb998b 100644
--- a/misc/skins/default.ini
+++ b/misc/skins/default.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/double-lines.ini b/misc/skins/double-lines.ini
index cad1e2807..7f35df0bc 100644
--- a/misc/skins/double-lines.ini
+++ b/misc/skins/double-lines.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/featured-plus.ini b/misc/skins/featured-plus.ini
index be7dde7a6..a0dc07028 100644
--- a/misc/skins/featured-plus.ini
+++ b/misc/skins/featured-plus.ini
@@ -41,6 +41,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/featured.ini b/misc/skins/featured.ini
index b37671899..43ce2f293 100644
--- a/misc/skins/featured.ini
+++ b/misc/skins/featured.ini
@@ -41,6 +41,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/gotar.ini b/misc/skins/gotar.ini
index b9b8aa093..3b81867fc 100644
--- a/misc/skins/gotar.ini
+++ b/misc/skins/gotar.ini
@@ -36,6 +36,7 @@
     header = brightred;
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/gray-green-purple256.ini b/misc/skins/gray-green-purple256.ini
index 4a15b798c..3ae534cae 100644
--- a/misc/skins/gray-green-purple256.ini
+++ b/misc/skins/gray-green-purple256.ini
@@ -45,6 +45,7 @@
     reverse =
     commandlinemark = ;main1
     header = main2
+    shadow = black;gray12
 
 [dialog]
     _default_ = black;bgdarker
diff --git a/misc/skins/gray-orange-blue256.ini b/misc/skins/gray-orange-blue256.ini
index cddd27b5f..fa491f014 100644
--- a/misc/skins/gray-orange-blue256.ini
+++ b/misc/skins/gray-orange-blue256.ini
@@ -45,6 +45,7 @@
     reverse =
     commandlinemark = ;main1
     header = main2
+    shadow = black;gray12
 
 [dialog]
     _default_ = black;bgdarker
diff --git a/misc/skins/julia256.ini b/misc/skins/julia256.ini
index bf04dd9e6..a61701cfd 100644
--- a/misc/skins/julia256.ini
+++ b/misc/skins/julia256.ini
@@ -42,6 +42,7 @@
     header = yellow;color237
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/mc46.ini b/misc/skins/mc46.ini
index 0b1f099d7..f971310ed 100644
--- a/misc/skins/mc46.ini
+++ b/misc/skins/mc46.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/modarcon16-defbg.ini b/misc/skins/modarcon16-defbg.ini
index 12391af2f..c004f6363 100644
--- a/misc/skins/modarcon16-defbg.ini
+++ b/misc/skins/modarcon16-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16.ini b/misc/skins/modarcon16.ini
index f0fe8d9e8..8cf81ab8b 100644
--- a/misc/skins/modarcon16.ini
+++ b/misc/skins/modarcon16.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16root-defbg.ini b/misc/skins/modarcon16root-defbg.ini
index f00351b36..b74700489 100644
--- a/misc/skins/modarcon16root-defbg.ini
+++ b/misc/skins/modarcon16root-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16root.ini b/misc/skins/modarcon16root.ini
index f76c8d6c9..d9afd5a3d 100644
--- a/misc/skins/modarcon16root.ini
+++ b/misc/skins/modarcon16root.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarin256-defbg.ini b/misc/skins/modarin256-defbg.ini
index dcc6f265a..f12d33623 100644
--- a/misc/skins/modarin256-defbg.ini
+++ b/misc/skins/modarin256-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256.ini b/misc/skins/modarin256.ini
index fa2bf2e93..8d1872aa7 100644
--- a/misc/skins/modarin256.ini
+++ b/misc/skins/modarin256.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256root-defbg.ini b/misc/skins/modarin256root-defbg.ini
index dcf7a29b4..48a4e9927 100644
--- a/misc/skins/modarin256root-defbg.ini
+++ b/misc/skins/modarin256root-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256root.ini b/misc/skins/modarin256root.ini
index 9bb4feefe..0a361ed24 100644
--- a/misc/skins/modarin256root.ini
+++ b/misc/skins/modarin256root.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/nicedark.ini b/misc/skins/nicedark.ini
index fb2c076a5..0b5ee0107 100644
--- a/misc/skins/nicedark.ini
+++ b/misc/skins/nicedark.ini
@@ -39,6 +39,7 @@
     header = lightgray;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = lightgray;black
diff --git a/misc/skins/sand256.ini b/misc/skins/sand256.ini
index f60ad44ab..94b1b77ca 100644
--- a/misc/skins/sand256.ini
+++ b/misc/skins/sand256.ini
@@ -94,6 +94,7 @@
     reverse = ;rgb452
     commandlinemark = white;gray
     header = red;;italic
+    shadow = black;rgb221
 
 [dialog]
     _default_ = black;rgb553
diff --git a/misc/skins/seasons-autumn16M.ini b/misc/skins/seasons-autumn16M.ini
index 182e2219b..bc8dc65ea 100644
--- a/misc/skins/seasons-autumn16M.ini
+++ b/misc/skins/seasons-autumn16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #69880c
     Input = #b5c400
     PaleFg = #555
+    ShadowFg = #7f7f55
+    ShadowBg = #4c1002
     Error = #840000
     ErrorFocus = #b00
     Top = #ff9909
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-spring16M.ini b/misc/skins/seasons-spring16M.ini
index de5906e2b..2c44a243b 100644
--- a/misc/skins/seasons-spring16M.ini
+++ b/misc/skins/seasons-spring16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #b3de85
     Input = Main
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #797f73
     Error = #c62b41
     ErrorFocus = #e16d7e
     Top = #f699a6
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-summer16M.ini b/misc/skins/seasons-summer16M.ini
index a8a01caa3..e9c686dc1 100644
--- a/misc/skins/seasons-summer16M.ini
+++ b/misc/skins/seasons-summer16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #f864f6
     Input = #d7ffad
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #7f7659
     Error = #d40707
     ErrorFocus = #db7b7b
     Top = #46cef3
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-winter16M.ini b/misc/skins/seasons-winter16M.ini
index bebc50c79..2724b2f09 100644
--- a/misc/skins/seasons-winter16M.ini
+++ b/misc/skins/seasons-winter16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #afbad8
     Input = Main
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #727176
     Error = #3c4766
     ErrorFocus = #586896
     Top = #6b99d7
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/xoria256.ini b/misc/skins/xoria256.ini
index 771f39ca4..d0e6b8a9b 100644
--- a/misc/skins/xoria256.ini
+++ b/misc/skins/xoria256.ini
@@ -82,6 +82,8 @@
     #commandhistory =
     #commandlinemark = black;lightgray
 
+    shadow = color239;black
+
 [dialog]
     _default_ = black;color250
     dhotnormal = color88;;
diff --git a/misc/skins/yadt256-defbg.ini b/misc/skins/yadt256-defbg.ini
index 8eec14c14..5de0aef57 100644
--- a/misc/skins/yadt256-defbg.ini
+++ b/misc/skins/yadt256-defbg.ini
@@ -48,6 +48,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color239;black
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/yadt256.ini b/misc/skins/yadt256.ini
index 639576214..8fd2c70b7 100644
--- a/misc/skins/yadt256.ini
+++ b/misc/skins/yadt256.ini
@@ -47,6 +47,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color239;black
 
 [dialog]
     _default_ = color252;color239
diff --git a/src/clipboard.c b/src/clipboard.c
index 4e0b60c0b..c277ae66b 100644
--- a/src/clipboard.c
+++ b/src/clipboard.c
@@ -71,14 +71,13 @@ clipboard_file_to_ext_clip (const gchar * event_group_name, const gchar * event_
                             gpointer init_data, gpointer data)
 {
     char *tmp, *cmd;
-    const char *d = getenv ("DISPLAY");
 
     (void) event_group_name;
     (void) event_name;
     (void) init_data;
     (void) data;
 
-    if (d == NULL || clipboard_store_path == NULL || clipboard_store_path[0] == '\0')
+    if (clipboard_store_path == NULL || clipboard_store_path[0] == '\0')
         return TRUE;
 
     tmp = mc_config_get_full_path (EDIT_HOME_CLIP_FILE);
@@ -101,14 +100,13 @@ clipboard_file_from_ext_clip (const gchar * event_group_name, const gchar * even
 {
     mc_pipe_t *p;
     int file = -1;
-    const char *d = getenv ("DISPLAY");
 
     (void) event_group_name;
     (void) event_name;
     (void) init_data;
     (void) data;
 
-    if (d == NULL || clipboard_paste_path == NULL || clipboard_paste_path[0] == '\0')
+    if (clipboard_paste_path == NULL || clipboard_paste_path[0] == '\0')
         return TRUE;
 
     p = mc_popen (clipboard_paste_path, NULL);
diff --git a/src/editor/edit.c b/src/editor/edit.c
index c77608084..e13be389a 100644
--- a/src/editor/edit.c
+++ b/src/editor/edit.c
@@ -3910,7 +3910,7 @@ edit_execute_cmd (WEdit * edit, long command, int char_for_insertion)
     case CK_ExternalCommand:
         edit_ext_cmd (edit);
         break;
-    case CK_Mail:
+    case CK_EditMail:
         edit_mail_dialog (edit);
         break;
 #ifdef HAVE_CHARSET
diff --git a/src/editor/editmenu.c b/src/editor/editmenu.c
index ca42a74a4..489893849 100644
--- a/src/editor/editmenu.c
+++ b/src/editor/editmenu.c
@@ -190,7 +190,7 @@ create_command_menu (void)
         entries = g_list_prepend (entries, menu_separator_create ());
     }
 #endif /* HAVE_ASPELL */
-    entries = g_list_prepend (entries, menu_entry_create (_("&Mail..."), CK_Mail));
+    entries = g_list_prepend (entries, menu_entry_create (_("&Mail..."), CK_EditMail));
 
 
     return g_list_reverse (entries);
diff --git a/src/execute.c b/src/execute.c
index d9b306e67..f35c53d94 100644
--- a/src/execute.c
+++ b/src/execute.c
@@ -551,7 +551,6 @@ toggle_subshell (void)
     {
         if (mc_global.mc_run_mode == MC_RUN_FULL)
         {
-            do_load_prompt ();
             if (new_dir_vpath != NULL)
                 do_possible_cd (new_dir_vpath);
         }
diff --git a/src/filemanager/Makefile.am b/src/filemanager/Makefile.am
index 71f9fc2f2..ba4a1be96 100644
--- a/src/filemanager/Makefile.am
+++ b/src/filemanager/Makefile.am
@@ -2,10 +2,10 @@
 noinst_LTLIBRARIES = libmcfilemanager.la
 
 libmcfilemanager_la_SOURCES = \
-	achown.c achown.h \
+	achown.c \
 	boxes.c boxes.h \
-	chmod.c chmod.h \
-	chown.c chown.h \
+	chmod.c \
+	chown.c \
 	cmd.c cmd.h \
 	command.c command.h \
 	dir.c dir.h \
@@ -33,7 +33,7 @@ AM_CPPFLAGS = -I$(top_srcdir) $(GLIB_CFLAGS) $(PCRE_CPPFLAGS)
 
 if ENABLE_EXT2FS_ATTR
 libmcfilemanager_la_SOURCES += \
-	chattr.c chattr.h
+	chattr.c
 
 AM_CPPFLAGS += @EXT2FS_CFLAGS@ @E2P_CFLAGS@
 endif
diff --git a/src/filemanager/achown.c b/src/filemanager/achown.c
index 813c5dbd5..7a9ba7a97 100644
--- a/src/filemanager/achown.c
+++ b/src/filemanager/achown.c
@@ -47,7 +47,7 @@
 
 #include "midnight.h"           /* current_panel */
 
-#include "achown.h"
+#include "cmd.h"                /* advanced_chown_cmd() */
 
 /*** global variables ****************************************************************************/
 
diff --git a/src/filemanager/achown.h b/src/filemanager/achown.h
deleted file mode 100644
index 61def7b68..000000000
--- a/src/filemanager/achown.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file achown.h
- *  \brief Header: Contains functions for advanced chowning
- */
-
-#ifndef MC__ACHOWN_H
-#define MC__ACHOWN_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void advanced_chown_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__ACHOWN_H */
diff --git a/src/filemanager/boxes.c b/src/filemanager/boxes.c
index e6a9abe1a..5b4d8c527 100644
--- a/src/filemanager/boxes.c
+++ b/src/filemanager/boxes.c
@@ -42,6 +42,7 @@
 #include "lib/global.h"
 
 #include "lib/tty/tty.h"
+#include "lib/tty/color.h"      /* tty_use_colors() */
 #include "lib/tty/key.h"        /* XCTRL and ALT macros  */
 #include "lib/skin.h"           /* INPUT_COLOR */
 #include "lib/mcconfig.h"       /* Load/save user formats */
@@ -102,7 +103,7 @@ static const int panel_list_user_idx = 3;
 
 static char **status_format;
 static unsigned long panel_list_formats_id, panel_user_format_id, panel_brief_cols_id;
-static unsigned long mini_user_status_id, mini_user_format_id;
+static unsigned long user_mini_status_id, mini_user_format_id;
 
 #ifdef HAVE_CHARSET
 static int new_display_codepage;
@@ -119,6 +120,8 @@ static gchar *current_skin_name;
 static WListbox *bg_list = NULL;
 #endif /* ENABLE_BACKGROUND */
 
+static unsigned long shadows_id;
+
 /* --------------------------------------------------------------------------------------------- */
 /*** file scope functions ************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -272,6 +275,38 @@ sel_skin_button (WButton * button, int action)
 
 /* --------------------------------------------------------------------------------------------- */
 
+static cb_ret_t
+appearance_box_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *data)
+{
+    switch (msg)
+    {
+    case MSG_INIT:
+        if (!tty_use_colors ())
+        {
+            Widget *shadow;
+
+            shadow = widget_find_by_id (w, shadows_id);
+            CHECK (shadow)->state = FALSE;
+            widget_disable (shadow, TRUE);
+        }
+        return MSG_HANDLED;
+
+    case MSG_NOTIFY:
+        if (sender != NULL && sender->id == shadows_id)
+        {
+            mc_global.tty.shadows = CHECK (sender)->state;
+            repaint_screen ();
+            return MSG_HANDLED;
+        }
+        return MSG_NOT_HANDLED;
+
+    default:
+        return dlg_default_callback (w, sender, msg, parm, data);
+    }
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 static cb_ret_t
 panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *data)
 {
@@ -285,7 +320,7 @@ panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm,
 
             in1 = INPUT (widget_find_by_id (w, panel_user_format_id));
             in2 = INPUT (widget_find_by_id (w, panel_brief_cols_id));
-            ch = CHECK (widget_find_by_id (w, mini_user_status_id));
+            ch = CHECK (widget_find_by_id (w, user_mini_status_id));
             in3 = INPUT (widget_find_by_id (w, mini_user_format_id));
 
             if (!ch->state)
@@ -298,7 +333,7 @@ panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm,
             return MSG_HANDLED;
         }
 
-        if (sender != NULL && sender->id == mini_user_status_id)
+        if (sender != NULL && sender->id == user_mini_status_id)
         {
             WInput *in;
 
@@ -590,6 +625,8 @@ configure_box (void)
 void
 appearance_box (void)
 {
+    gboolean shadows = mc_global.tty.shadows;
+
     current_skin_name = g_strdup (mc_skin__default.name);
     skin_names = mc_skin_list ();
 
@@ -602,6 +639,8 @@ appearance_box (void)
                 QUICK_BUTTON (str_fit_to_term (skin_name_to_label (current_skin_name), 20, J_LEFT_FIT),
                               B_USER, sel_skin_button, NULL),
             QUICK_STOP_COLUMNS,
+            QUICK_SEPARATOR (TRUE),
+            QUICK_CHECKBOX (N_("&Shadows"), &mc_global.tty.shadows, &shadows_id),
             QUICK_BUTTONS_OK_CANCEL,
             QUICK_END
             /* *INDENT-ON* */
@@ -610,14 +649,17 @@ appearance_box (void)
         quick_dialog_t qdlg = {
             -1, -1, 54,
             N_("Appearance"), "[Appearance]",
-            quick_widgets, dlg_default_callback, NULL
+            quick_widgets, appearance_box_callback, NULL
         };
 
         if (quick_dialog (&qdlg) == B_ENTER)
             mc_config_set_string (mc_global.main_config, CONFIG_APP_SECTION, "skin",
                                   current_skin_name);
         else
+        {
             skin_apply (NULL);
+            mc_global.tty.shadows = shadows;
+        }
     }
 
     g_free (current_skin_name);
@@ -725,7 +767,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
     }
 
     {
-        gboolean mini_user_status;
+        gboolean user_mini_status;
         char panel_brief_cols_in[BUF_TINY];
         char *panel_brief_cols_out = NULL;
         char *panel_user_format = NULL;
@@ -752,7 +794,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
             QUICK_INPUT (panel->user_format, "user-fmt-input", &panel_user_format,
                          &panel_user_format_id, FALSE, FALSE, INPUT_COMPLETE_NONE),
             QUICK_SEPARATOR (TRUE),
-            QUICK_CHECKBOX (N_("User &mini status"), &mini_user_status, &mini_user_status_id),
+            QUICK_CHECKBOX (N_("User &mini status"), &user_mini_status, &user_mini_status_id),
             QUICK_INPUT (panel->user_status_format[panel->list_format], "mini_input",
                          &mini_user_format, &mini_user_format_id, FALSE, FALSE, INPUT_COMPLETE_NONE),
             QUICK_BUTTONS_OK_CANCEL,
@@ -766,7 +808,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
             quick_widgets, panel_listing_callback, NULL
         };
 
-        mini_user_status = panel->user_mini_status;
+        user_mini_status = panel->user_mini_status;
         result = panel->list_format;
         status_format = panel->user_status_format;
 
@@ -778,7 +820,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
         if ((int) panel->list_format != panel_list_user_idx)
             quick_widgets[6].state = WST_DISABLED;
 
-        if (!mini_user_status)
+        if (!user_mini_status)
             quick_widgets[9].state = WST_DISABLED;
 
         if (quick_dialog (&qdlg) == B_CANCEL)
@@ -790,7 +832,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
 
             *userp = panel_user_format;
             *minip = mini_user_format;
-            *use_msformat = mini_user_status;
+            *use_msformat = user_mini_status;
 
             cols = strtol (panel_brief_cols_out, &error, 10);
             if (*error == '\0')
diff --git a/src/filemanager/chattr.c b/src/filemanager/chattr.c
index d68612211..334015ba0 100644
--- a/src/filemanager/chattr.c
+++ b/src/filemanager/chattr.c
@@ -51,7 +51,7 @@
 #include "midnight.h"           /* current_panel */
 #include "panel.h"              /* do_file_mark() */
 
-#include "chattr.h"
+#include "cmd.h"                /* chattr_cmd(), chattr_get_as_str() */
 
 /*** global variables ****************************************************************************/
 
@@ -122,7 +122,7 @@ struct WChattrBoxes
  * EXT4_EOFBLOCKS_FL        0x00400000 was here, unused
  * FS_NOCOW_FL              0x00800000 -- Do not cow file
  * EXT4_SNAPFILE_FL         0x01000000 -- Inode is a snapshot
- *                          0x02000000 -- unused yet
+ * FS_DAX_FL                0x02000000 -- Inode is DAX
  * EXT4_SNAPFILE_DELETED_FL 0x04000000 -- Snapshot is being deleted
  * EXT4_SNAPFILE_SHRUNK_FL  0x08000000 -- Snapshot shrink has completed
  * EXT4_INLINE_DATA_FL      0x10000000 -- Inode has inline data
@@ -179,6 +179,12 @@ static struct
     { EXT4_HUGE_FILE_FL,    'h', N_("Huge_file"),                     FALSE, FALSE },
 #endif
     { FS_NOCOW_FL,          'C', N_("No COW"),                        FALSE, FALSE },
+#ifdef FS_DAX_FL
+    /* added in v1.45.7
+       TODO: clarify version after ext2fsprogs release
+       ext2fsprogs 1dd48bc23c3776df76459aff0c7723fff850ea45 2020-07-28 */
+    { FS_DAX_FL,            'x', N_("Direct access for files"),       FALSE, FALSE },
+#endif
 #ifdef EXT4_CASEFOLD_FL
     /* added in v1.45.0
        ext2fsprogs 1378bb6515e98a27f0f5c220381d49d20544204e 2018-12-01 */
@@ -865,6 +871,8 @@ chattrboxes_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
         break;
 
     default:
+        /* return MOU_UNHANDLED */
+        event->result.abort = TRUE;
         break;
     }
 }
diff --git a/src/filemanager/chattr.h b/src/filemanager/chattr.h
deleted file mode 100644
index b6eaa2374..000000000
--- a/src/filemanager/chattr.h
+++ /dev/null
@@ -1,23 +0,0 @@
-/** \file chattr.h
- *  \brief Header: chattr command
- */
-
-#ifndef MC__CHATTR_H
-#define MC__CHATTR_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chattr_cmd (void);
-const char *chattr_get_as_str (unsigned long attr);
-
-/*** inline functions ****************************************************************************/
-
-#endif /* MC__CHATTR_H */
diff --git a/src/filemanager/chmod.c b/src/filemanager/chmod.c
index 5a56563ec..26fb846cd 100644
--- a/src/filemanager/chmod.c
+++ b/src/filemanager/chmod.c
@@ -42,7 +42,7 @@
 
 #include "midnight.h"           /* current_panel */
 
-#include "chmod.h"
+#include "cmd.h"                /* chmod_cmd() */
 
 /*** global variables ****************************************************************************/
 
diff --git a/src/filemanager/chmod.h b/src/filemanager/chmod.h
deleted file mode 100644
index 7b6d833d5..000000000
--- a/src/filemanager/chmod.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file chmod.h
- *  \brief Header: chmod command
- */
-
-#ifndef MC__CHMOD_H
-#define MC__CHMOD_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chmod_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__CHMOD_H */
diff --git a/src/filemanager/chown.c b/src/filemanager/chown.c
index 6ea428cd5..e7b104a06 100644
--- a/src/filemanager/chown.c
+++ b/src/filemanager/chown.c
@@ -47,7 +47,7 @@
 #include "src/setup.h"          /* panels_options */
 #include "midnight.h"           /* current_panel */
 
-#include "chown.h"
+#include "cmd.h"                /* chown_cmd() */
 
 /*** global variables ****************************************************************************/
 
diff --git a/src/filemanager/chown.h b/src/filemanager/chown.h
deleted file mode 100644
index ba86ec4d6..000000000
--- a/src/filemanager/chown.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file chown.h
- *  \brief Header: chown command
- */
-
-#ifndef MC__CHOWN_H
-#define MC__CHOWN_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chown_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__CHOWN_H */
diff --git a/src/filemanager/cmd.c b/src/filemanager/cmd.c
index 2b35f6783..7daf7b763 100644
--- a/src/filemanager/cmd.c
+++ b/src/filemanager/cmd.c
@@ -124,10 +124,10 @@ static const char *machine_str = N_("Enter machine name (F1 for details):");
 /* --------------------------------------------------------------------------------------------- */
 /**
  * Run viewer (internal or external) on the currently selected file.
- * If normal is TRUE, force internal viewer and raw mode (used for F13).
+ * If @plain_view is TRUE, force internal viewer and raw mode (used for F13).
  */
 static void
-do_view_cmd (gboolean normal)
+do_view_cmd (gboolean plain_view)
 {
     /* Directories are viewed by changing to them */
     if (S_ISDIR (selection (current_panel)->st.st_mode) || link_isdir (selection (current_panel)))
@@ -151,7 +151,7 @@ do_view_cmd (gboolean normal)
 
         file_idx = current_panel->selected;
         filename_vpath = vfs_path_from_str (current_panel->dir.list[file_idx].fname);
-        view_file (filename_vpath, normal, use_internal_view);
+        view_file (filename_vpath, plain_view, use_internal_view);
         vfs_path_free (filename_vpath);
     }
 
@@ -1275,7 +1275,7 @@ help_cmd (void)
 {
     ev_help_t event_data = { NULL, NULL };
 
-    if (current_panel->searching)
+    if (current_panel->quick_search.active)
         event_data.node = "[Quick search]";
     else
         event_data.node = "[main]";
@@ -1415,7 +1415,7 @@ single_dirsize_cmd (void)
         status_msg_init (STATUS_MSG (&dsm), _("Directory scanning"), 0, dirsize_status_init_cb,
                          dirsize_status_update_cb, dirsize_status_deinit_cb);
 
-        if (compute_dir_size (p, &dsm, &dir_count, &count, &total, TRUE) == FILE_CONT)
+        if (compute_dir_size (p, &dsm, &dir_count, &count, &total, FALSE) == FILE_CONT)
         {
             entry->st.st_size = (off_t) total;
             entry->f.dir_size_computed = 1;
@@ -1434,7 +1434,7 @@ single_dirsize_cmd (void)
     if (current_panel->sort_field->sort_routine == (GCompareFunc) sort_size)
         panel_re_sort (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1462,7 +1462,7 @@ dirsizes_cmd (void)
             gboolean ok;
 
             p = vfs_path_from_str (panel->dir.list[i].fname);
-            ok = compute_dir_size (p, &dsm, &dir_count, &count, &total, TRUE) != FILE_CONT;
+            ok = compute_dir_size (p, &dsm, &dir_count, &count, &total, FALSE) != FILE_CONT;
             vfs_path_free (p);
             if (ok)
                 break;
@@ -1478,7 +1478,7 @@ dirsizes_cmd (void)
     if (current_panel->sort_field->sort_routine == (GCompareFunc) sort_size)
         panel_re_sort (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/cmd.h b/src/filemanager/cmd.h
index 9c77084e0..becc4782d 100644
--- a/src/filemanager/cmd.h
+++ b/src/filemanager/cmd.h
@@ -46,7 +46,7 @@ void dirsizes_cmd (void);
 gboolean view_file_at_line (const vfs_path_t * filename_vpath, gboolean plain_view,
                             gboolean internal, long start_line, off_t search_start,
                             off_t search_end);
-gboolean view_file (const vfs_path_t * filename_vpath, gboolean normal, gboolean internal);
+gboolean view_file (const vfs_path_t * filename_vpath, gboolean plain_view, gboolean internal);
 void view_cmd (void);
 void view_file_cmd (void);
 void view_raw_cmd (void);
@@ -91,6 +91,17 @@ void quick_view_cmd (void);
 #ifdef HAVE_CHARSET
 void encoding_cmd (void);
 #endif
+/* achown.c */
+void advanced_chown_cmd (void);
+/* chmod.c */
+void chmod_cmd (void);
+/* chown.c */
+void chown_cmd (void);
+#ifdef ENABLE_EXT2FS_ATTR
+/* chattr.c */
+void chattr_cmd (void);
+const char *chattr_get_as_str (unsigned long attr);
+#endif
 /* find.c */
 void find_cmd (void);
 
diff --git a/src/filemanager/dir.c b/src/filemanager/dir.c
index 9eec072d9..e52473d5b 100644
--- a/src/filemanager/dir.c
+++ b/src/filemanager/dir.c
@@ -145,7 +145,7 @@ clean_sort_keys (dir_list * list, int start, int count)
  */
 
 static gboolean
-handle_dirent (struct dirent *dp, const char *fltr, struct stat *buf1, gboolean * link_to_dir,
+handle_dirent (struct vfs_dirent *dp, const char *fltr, struct stat *buf1, gboolean * link_to_dir,
                gboolean * stale_link)
 {
     vfs_path_t *vpath;
@@ -393,7 +393,7 @@ sort_time (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_mtime < b->st.st_mtime ? -1 : a->st.st_mtime > b->st.st_mtime;
+        int result = _GL_CMP (a->st.st_mtime, b->st.st_mtime);
 
         if (result != 0)
             return result * reverse;
@@ -414,7 +414,7 @@ sort_ctime (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_ctime < b->st.st_ctime ? -1 : a->st.st_ctime > b->st.st_ctime;
+        int result = _GL_CMP (a->st.st_ctime, b->st.st_ctime);
 
         if (result != 0)
             return result * reverse;
@@ -435,7 +435,7 @@ sort_atime (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_atime < b->st.st_atime ? -1 : a->st.st_atime > b->st.st_atime;
+        int result = _GL_CMP (a->st.st_atime, b->st.st_atime);
 
         if (result != 0)
             return result * reverse;
@@ -470,7 +470,7 @@ sort_size (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_size < b->st.st_size ? -1 : a->st.st_size > b->st.st_size;
+        int result = _GL_CMP (a->st.st_size, b->st.st_size);
 
         if (result != 0)
             return result * reverse;
@@ -624,7 +624,7 @@ dir_list_load (dir_list * list, const vfs_path_t * vpath, GCompareFunc sort,
                const dir_sort_options_t * sort_op, const char *fltr)
 {
     DIR *dirp;
-    struct dirent *dp;
+    struct vfs_dirent *dp;
     struct stat st;
     file_entry_t *fentry;
     const char *vpath_str;
@@ -697,7 +697,7 @@ dir_list_reload (dir_list * list, const vfs_path_t * vpath, GCompareFunc sort,
                  const dir_sort_options_t * sort_op, const char *fltr)
 {
     DIR *dirp;
-    struct dirent *dp;
+    struct vfs_dirent *dp;
     int i;
     struct stat st;
     int marked_cnt;
diff --git a/src/filemanager/ext.c b/src/filemanager/ext.c
index 8b00c0d9e..4e1520050 100644
--- a/src/filemanager/ext.c
+++ b/src/filemanager/ext.c
@@ -71,9 +71,9 @@
 /*** file scope macro definitions ****************************************************************/
 
 #ifdef FILE_L
-#define FILE_CMD "file -L "
+#define FILE_CMD "file -L -z "
 #else
-#define FILE_CMD "file "
+#define FILE_CMD "file -z "
 #endif
 
 /*** file scope type declarations ****************************************************************/
diff --git a/src/filemanager/file.c b/src/filemanager/file.c
index 4c4b20c38..0ea75e4ae 100644
--- a/src/filemanager/file.c
+++ b/src/filemanager/file.c
@@ -614,34 +614,19 @@ make_symlink (file_op_context_t * ctx, const char *src_path, const char *dst_pat
 static FileProgressStatus
 do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * dsm,
                      size_t * dir_count, size_t * ret_marked, uintmax_t * ret_total,
-                     gboolean compute_symlinks)
+                     mc_stat_fn stat_func)
 {
-    static guint64 timestamp = 0;
+    static gint64 timestamp = 0;
     /* update with 25 FPS rate */
-    static const guint64 delay = G_USEC_PER_SEC / 25;
+    static const gint64 delay = G_USEC_PER_SEC / 25;
 
     status_msg_t *sm = STATUS_MSG (dsm);
     int res;
     struct stat s;
     DIR *dir;
-    struct dirent *dirent;
+    struct vfs_dirent *dirent;
     FileProgressStatus ret = FILE_CONT;
 
-    if (!compute_symlinks)
-    {
-        res = mc_lstat (dirname_vpath, &s);
-        if (res != 0)
-            return ret;
-
-        /* don't scan symlink to directory */
-        if (S_ISLNK (s.st_mode))
-        {
-            (*ret_marked)++;
-            *ret_total += (uintmax_t) s.st_size;
-            return ret;
-        }
-    }
-
     (*dir_count)++;
 
     dir = mc_opendir (dirname_vpath);
@@ -657,13 +642,13 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
 
         tmp_vpath = vfs_path_append_new (dirname_vpath, dirent->d_name, (char *) NULL);
 
-        res = mc_lstat (tmp_vpath, &s);
+        res = stat_func (tmp_vpath, &s);
         if (res == 0)
         {
             if (S_ISDIR (s.st_mode))
                 ret =
                     do_compute_dir_size (tmp_vpath, dsm, dir_count, ret_marked, ret_total,
-                                         compute_symlinks);
+                                         stat_func);
             else
             {
                 ret = FILE_CONT;
@@ -700,27 +685,29 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
 
 static FileProgressStatus
 panel_compute_totals (const WPanel * panel, dirsize_status_msg_t * sm, size_t * ret_count,
-                      uintmax_t * ret_total, gboolean compute_symlinks)
+                      uintmax_t * ret_total, gboolean follow_symlinks)
 {
     int i;
     size_t dir_count = 0;
+    mc_stat_fn stat_func = follow_symlinks ? mc_stat : mc_lstat;
 
     for (i = 0; i < panel->dir.len; i++)
     {
-        struct stat *s;
+        const file_entry_t *fe = &panel->dir.list[i];
+        const struct stat *s;
 
-        if (!panel->dir.list[i].f.marked)
+        if (fe->f.marked == 0)
             continue;
 
-        s = &panel->dir.list[i].st;
+        s = &fe->st;
 
-        if (S_ISDIR (s->st_mode))
+        if (S_ISDIR (s->st_mode) || (follow_symlinks && link_isdir (fe) && fe->f.stale_link == 0))
         {
             vfs_path_t *p;
             FileProgressStatus status;
 
-            p = vfs_path_append_new (panel->cwd_vpath, panel->dir.list[i].fname, (char *) NULL);
-            status = compute_dir_size (p, sm, &dir_count, ret_count, ret_total, compute_symlinks);
+            p = vfs_path_append_new (panel->cwd_vpath, fe->fname, (char *) NULL);
+            status = do_compute_dir_size (p, sm, &dir_count, ret_count, ret_total, stat_func);
             vfs_path_free (p);
 
             if (status != FILE_CONT)
@@ -754,6 +741,7 @@ panel_operate_init_totals (const WPanel * panel, const vfs_path_t * source,
     if (verbose && compute_totals)
     {
         dirsize_status_msg_t dsm;
+        gboolean stale_link = FALSE;
 
         memset (&dsm, 0, sizeof (dsm));
         dsm.allow_skip = TRUE;
@@ -766,12 +754,15 @@ panel_operate_init_totals (const WPanel * panel, const vfs_path_t * source,
         if (source == NULL)
             status = panel_compute_totals (panel, &dsm, &ctx->progress_count, &ctx->progress_bytes,
                                            ctx->follow_links);
-        else if (S_ISDIR (source_stat->st_mode))
+        else if (S_ISDIR (source_stat->st_mode)
+                 || (ctx->follow_links
+                     && file_is_symlink_to_dir (source, (struct stat *) source_stat, &stale_link)
+                     && !stale_link))
         {
             size_t dir_count = 0;
 
-            status = compute_dir_size (source, &dsm, &dir_count, &ctx->progress_count,
-                                       &ctx->progress_bytes, ctx->follow_links);
+            status = do_compute_dir_size (source, &dsm, &dir_count, &ctx->progress_count,
+                                          &ctx->progress_bytes, ctx->stat_func);
         }
         else
         {
@@ -1412,7 +1403,7 @@ try_erase_dir (file_op_context_t * ctx, const char *dir)
 static FileProgressStatus
 recursive_erase (file_op_total_context_t * tctx, file_op_context_t * ctx, const vfs_path_t * vpath)
 {
-    struct dirent *next;
+    struct vfs_dirent *next;
     DIR *reading;
     const char *s;
     FileProgressStatus return_status = FILE_CONT;
@@ -1467,7 +1458,7 @@ static int
 check_dir_is_empty (const vfs_path_t * vpath)
 {
     DIR *dir;
-    struct dirent *d;
+    struct vfs_dirent *d;
     int i = 1;
 
     dir = mc_opendir (vpath);
@@ -2775,7 +2766,7 @@ FileProgressStatus
 copy_dir_dir (file_op_total_context_t * tctx, file_op_context_t * ctx, const char *s, const char *d,
               gboolean toplevel, gboolean move_over, gboolean do_delete, GSList * parent_dirs)
 {
-    struct dirent *next;
+    struct vfs_dirent *next;
     struct stat dst_stat, src_stat;
     DIR *reading;
     FileProgressStatus return_status = FILE_CONT;
@@ -3183,7 +3174,7 @@ dirsize_status_deinit_cb (status_msg_t * sm)
 
     /* schedule to update passive panel */
     if (get_other_type () == view_listing)
-        other_panel->dirty = 1;
+        other_panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -3196,10 +3187,10 @@ dirsize_status_deinit_cb (status_msg_t * sm)
 FileProgressStatus
 compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * sm,
                   size_t * ret_dir_count, size_t * ret_marked_count, uintmax_t * ret_total,
-                  gboolean compute_symlinks)
+                  gboolean follow_symlinks)
 {
     return do_compute_dir_size (dirname_vpath, sm, ret_dir_count, ret_marked_count, ret_total,
-                                compute_symlinks);
+                                follow_symlinks ? mc_stat : mc_lstat);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/file.h b/src/filemanager/file.h
index f54f5415c..ae12e1572 100644
--- a/src/filemanager/file.h
+++ b/src/filemanager/file.h
@@ -62,7 +62,7 @@ FileProgressStatus file_error (gboolean allow_retry, const char *format, const c
 /* return value is FILE_CONT or FILE_ABORT */
 FileProgressStatus compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * sm,
                                      size_t * ret_dir_count, size_t * ret_marked_count,
-                                     uintmax_t * ret_total, gboolean compute_symlinks);
+                                     uintmax_t * ret_total, gboolean follow_symlinks);
 
 void dirsize_status_init_cb (status_msg_t * sm);
 int dirsize_status_update_cb (status_msg_t * sm);
diff --git a/src/filemanager/filegui.c b/src/filemanager/filegui.c
index c43a2ae99..3af1c4315 100644
--- a/src/filemanager/filegui.c
+++ b/src/filemanager/filegui.c
@@ -1158,9 +1158,9 @@ file_progress_show_target (file_op_context_t * ctx, const vfs_path_t * vpath)
 gboolean
 file_progress_show_deleting (file_op_context_t * ctx, const char *s, size_t * count)
 {
-    static guint64 timestamp = 0;
+    static gint64 timestamp = 0;
     /* update with 25 FPS rate */
-    static const guint64 delay = G_USEC_PER_SEC / 25;
+    static const gint64 delay = G_USEC_PER_SEC / 25;
 
     gboolean ret;
 
diff --git a/src/filemanager/find.c b/src/filemanager/find.c
index 490d8d2e2..7b1c8a1dd 100644
--- a/src/filemanager/find.c
+++ b/src/filemanager/find.c
@@ -36,7 +36,6 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/stat.h>
-#include <sys/time.h>
 
 #include "lib/global.h"
 
@@ -155,7 +154,7 @@ static unsigned long matches;   /* Number of matches */
 static gboolean is_start = FALSE;       /* Status of the start/stop toggle button */
 static char *old_dir = NULL;
 
-static struct timeval last_refresh;
+static gint64 last_refresh;
 
 /* Where did we stop */
 static gboolean resuming;
@@ -992,9 +991,7 @@ search_content (WDialog * h, const char *directory, const char *filename)
     int file_fd;
     gboolean ret_val = FALSE;
     vfs_path_t *vpath;
-    struct timeval tv;
-    time_t seconds;
-    suseconds_t useconds;
+    gint64 tv;
     gboolean status_updated = FALSE;
 
     vpath = vfs_path_build_filename (directory, filename, (char *) NULL);
@@ -1012,21 +1009,9 @@ search_content (WDialog * h, const char *directory, const char *filename)
         return FALSE;
 
     /* get time elapsed from last refresh */
-    if (gettimeofday (&tv, NULL) == -1)
-    {
-        tv.tv_sec = 0;
-        tv.tv_usec = 0;
-        last_refresh = tv;
-    }
-    seconds = tv.tv_sec - last_refresh.tv_sec;
-    useconds = tv.tv_usec - last_refresh.tv_usec;
-    if (useconds < 0)
-    {
-        seconds--;
-        useconds += G_USEC_PER_SEC;
-    }
+    tv = g_get_real_time ();
 
-    if (s.st_size >= MIN_REFRESH_FILE_SIZE || seconds > 0 || useconds > MAX_REFRESH_INTERVAL)
+    if (s.st_size >= MIN_REFRESH_FILE_SIZE || (tv - last_refresh) > MAX_REFRESH_INTERVAL)
     {
         g_snprintf (buffer, sizeof (buffer), _("Grepping in %s"), filename);
         status_update (str_trunc (buffer, WIDGET (h)->cols - 8));
@@ -1262,7 +1247,7 @@ find_rotate_dash (const WDialog * h, gboolean show)
 static int
 do_search (WDialog * h)
 {
-    static struct dirent *dp = NULL;
+    static struct vfs_dirent *dp = NULL;
     static DIR *dirp = NULL;
     static char *directory = NULL;
     struct stat tmp_stat;
@@ -1898,8 +1883,7 @@ find_cmd (void)
 
         if (find_pattern[0] != '\0')
         {
-            last_refresh.tv_sec = 0;
-            last_refresh.tv_usec = 0;
+            last_refresh = 0;
 
             is_start = FALSE;
 
diff --git a/src/filemanager/info.c b/src/filemanager/info.c
index be1c66817..b981b85d0 100644
--- a/src/filemanager/info.c
+++ b/src/filemanager/info.c
@@ -54,7 +54,7 @@
 #include "layout.h"
 #include "mountlist.h"
 #ifdef ENABLE_EXT2FS_ATTR
-#include "chattr.h"
+#include "cmd.h"                /* chattr_get_as_str() */
 #endif
 
 #include "info.h"
diff --git a/src/filemanager/layout.c b/src/filemanager/layout.c
index dfffa96f5..007bda879 100644
--- a/src/filemanager/layout.c
+++ b/src/filemanager/layout.c
@@ -1027,9 +1027,9 @@ set_hintbar (const char *str)
 void
 rotate_dash (gboolean show)
 {
-    static guint64 timestamp = 0;
+    static gint64 timestamp = 0;
     /* update with 10 FPS rate */
-    static const guint64 delay = G_USEC_PER_SEC / 10;
+    static const gint64 delay = G_USEC_PER_SEC / 10;
 
     const Widget *w = CONST_WIDGET (midnight_dlg);
 
@@ -1277,8 +1277,8 @@ swap_panels (void)
         panelswap (dir_stat);
 #undef panelswap
 
-        panel1->searching = FALSE;
-        panel2->searching = FALSE;
+        panel1->quick_search.active = FALSE;
+        panel2->quick_search.active = FALSE;
 
         if (current_panel == panel1)
             current_panel = panel2;
@@ -1309,18 +1309,18 @@ swap_panels (void)
 
         if (panels[0].type == view_listing)
         {
-            if (strcmp (panel1->panel_name, get_nth_panel_name (0)) == 0)
+            if (strcmp (panel1->name, get_nth_panel_name (0)) == 0)
             {
-                g_free (panel1->panel_name);
-                panel1->panel_name = g_strdup (get_nth_panel_name (1));
+                g_free (panel1->name);
+                panel1->name = g_strdup (get_nth_panel_name (1));
             }
         }
         if (panels[1].type == view_listing)
         {
-            if (strcmp (panel2->panel_name, get_nth_panel_name (1)) == 0)
+            if (strcmp (panel2->name, get_nth_panel_name (1)) == 0)
             {
-                g_free (panel2->panel_name);
-                panel2->panel_name = g_strdup (get_nth_panel_name (0));
+                g_free (panel2->name);
+                panel2->name = g_strdup (get_nth_panel_name (0));
             }
         }
 
@@ -1498,7 +1498,11 @@ load_prompt (int fd, void *unused)
     (void) fd;
     (void) unused;
 
-    do_load_prompt ();
+    if (should_read_new_subshell_prompt)
+        do_load_prompt ();
+    else
+        flush_subshell (0, QUIETLY);
+
     return 0;
 }
 #endif /* ENABLE_SUBSHELL */
diff --git a/src/filemanager/midnight.c b/src/filemanager/midnight.c
index 9d68c0206..539a7d87d 100644
--- a/src/filemanager/midnight.c
+++ b/src/filemanager/midnight.c
@@ -75,13 +75,6 @@
 #include "command.h"            /* cmdline */
 #include "dir.h"                /* dir_list_clean() */
 
-#include "chmod.h"
-#include "chown.h"
-#include "achown.h"
-#ifdef ENABLE_EXT2FS_ATTR
-#include "chattr.h"
-#endif
-
 #ifdef USE_INTERNAL_EDIT
 #include "src/editor/edit.h"
 #endif
@@ -390,7 +383,7 @@ menu_cmd (void)
 {
     int selected;
 
-    if ((get_current_index () == 0) == (current_panel->active != 0))
+    if ((get_current_index () == 0) == current_panel->active)
         selected = 0;
     else
         selected = g_list_length (the_menubar->menu) - 1;
@@ -1029,7 +1022,7 @@ show_editor_viewer_history (void)
 
         case CK_View:
             s_vpath = vfs_path_from_str (s);
-            view_file (s_vpath, use_internal_view, 0);
+            view_file (s_vpath, use_internal_view, FALSE);
             break;
 
         default:
@@ -1104,7 +1097,7 @@ quit_cmd (void)
 
 /**
  * Repaint the contents of the panels without frames.  To schedule panel
- * for repainting, set panel->dirty to 1.  There are many reasons why
+ * for repainting, set panel->dirty to TRUE.  There are many reasons why
  * the panels need to be repainted, and this is a costly operation, so
  * it's done once per event.
  */
@@ -1460,7 +1453,7 @@ is_cmdline_mute (void)
        it's activity. Thus, we can't use get_current_type() here.
        current_panel should point to actualy current active panel
        independently of it's type. */
-    return (current_panel->active == 0
+    return (!current_panel->active
             && (get_other_type () == view_quick || get_other_type () == view_tree));
 }
 
@@ -1558,7 +1551,7 @@ midnight_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
 
         if ((!mc_global.tty.alternate_plus_minus
              || !(mc_global.tty.console_flag != '\0' || mc_global.tty.xterm_flag)) && !quote
-            && !current_panel->searching)
+            && !current_panel->quick_search.active)
         {
             if (!only_leading_plus_minus)
             {
@@ -1594,9 +1587,9 @@ midnight_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
         return MSG_NOT_HANDLED;
 
     case MSG_HOTKEY_HANDLED:
-        if ((get_current_type () == view_listing) && current_panel->searching)
+        if ((get_current_type () == view_listing) && current_panel->quick_search.active)
         {
-            current_panel->dirty = 1;   /* FIXME: unneeded? */
+            current_panel->dirty = TRUE;        /* FIXME: unneeded? */
             send_message (current_panel, NULL, MSG_ACTION, CK_SearchStop, NULL);
         }
         return MSG_HANDLED;
@@ -1673,8 +1666,8 @@ midnight_set_buttonbar (WButtonBar * b)
 char *
 get_random_hint (gboolean force)
 {
-    static const guint64 update_period = 60 * G_USEC_PER_SEC;
-    static guint64 tv = 0;
+    static const gint64 update_period = 60 * G_USEC_PER_SEC;
+    static gint64 tv = 0;
 
     char *data, *result = NULL, *eop;
     size_t len, start;
diff --git a/src/filemanager/mountlist.c b/src/filemanager/mountlist.c
index ae83b329f..cf0513070 100644
--- a/src/filemanager/mountlist.c
+++ b/src/filemanager/mountlist.c
@@ -1430,14 +1430,9 @@ get_fs_usage (char const *file, char const *disk, struct fs_usage *fsp)
         /* Empirically, the block counts on most SVR3 and SVR3-derived
            systems seem to always be in terms of 512-byte blocks,
            no matter what value f_bsize has.  */
-#if defined _CRAY
-        fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_bsize);
-#else
         fsp->fsu_blocksize = 512;
 #endif
 
-#endif
-
 #if (defined STAT_STATVFS64 || defined STAT_STATFS3_OSF1 \
      || defined STAT_STATFS2_FRSIZE || defined STAT_STATFS2_BSIZE \
      || defined STAT_STATFS2_FSIZE || defined STAT_STATFS4)
diff --git a/src/filemanager/panel.c b/src/filemanager/panel.c
index b4535e968..190f41e39 100644
--- a/src/filemanager/panel.c
+++ b/src/filemanager/panel.c
@@ -370,6 +370,8 @@ static WPanel *mouse_mark_panel = NULL;
 static gboolean mouse_marking = FALSE;
 static int state_mark = 0;
 
+static GString *string_file_name_buffer;
+
 /* --------------------------------------------------------------------------------------------- */
 /*** file scope functions ************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -451,12 +453,12 @@ add_permission_string (const char *dest, int width, file_entry_t * fe, int attr,
 static const char *
 string_file_name (file_entry_t * fe, int len)
 {
-    static char buffer[MC_MAXPATHLEN * MB_LEN_MAX + 1];
-
     (void) len;
 
-    g_strlcpy (buffer, fe->fname, sizeof (buffer));
-    return buffer;
+    g_string_set_size (string_file_name_buffer, 0);
+    g_string_append_len (string_file_name_buffer, fe->fname, fe->fnamelen);
+
+    return string_file_name_buffer->str;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -990,11 +992,11 @@ display_mini_info (WPanel * panel)
 
     widget_gotoyx (w, panel_lines (panel) + 3, 1);
 
-    if (panel->searching)
+    if (panel->quick_search.active)
     {
         tty_setcolor (INPUT_COLOR);
         tty_print_char ('/');
-        tty_print_string (str_fit_to_term (panel->search_buffer, w->cols - 3, J_LEFT));
+        tty_print_string (str_fit_to_term (panel->quick_search.buffer->str, w->cols - 3, J_LEFT));
         return;
     }
 
@@ -1399,9 +1401,9 @@ panel_save_name (WPanel * panel)
 {
     /* If the program is shuting down */
     if ((mc_global.midnight_shutdown && auto_save_setup) || saving_setup)
-        return g_strdup (panel->panel_name);
+        return g_strdup (panel->name);
 
-    return g_strconcat ("Temporal:", panel->panel_name, (char *) NULL);
+    return g_strconcat ("Temporal:", panel->name, (char *) NULL);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1412,8 +1414,8 @@ directory_history_add (WPanel * panel, const vfs_path_t * vpath)
     char *tmp;
 
     tmp = vfs_path_to_str_flags (vpath, 0, VPF_STRIP_PASSWORD);
-    panel->dir_history = list_append_unique (panel->dir_history, tmp);
-    panel->dir_history_current = panel->dir_history;
+    panel->dir_history.list = list_append_unique (panel->dir_history.list, tmp);
+    panel->dir_history.current = panel->dir_history.list;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1432,9 +1434,9 @@ panel_load_history (const gchar * event_group_name, const gchar * event_name,
     if (ev->receiver == NULL || ev->receiver == WIDGET (p))
     {
         if (ev->cfg != NULL)
-            p->dir_history = mc_config_history_load (ev->cfg, p->hist_name);
+            p->dir_history.list = mc_config_history_load (ev->cfg, p->dir_history.name);
         else
-            p->dir_history = mc_config_history_get (p->hist_name);
+            p->dir_history.list = mc_config_history_get (p->dir_history.name);
 
         directory_history_add (p, p->cwd_vpath);
     }
@@ -1454,11 +1456,11 @@ panel_save_history (const gchar * event_group_name, const gchar * event_name,
     (void) event_group_name;
     (void) event_name;
 
-    if (p->dir_history != NULL)
+    if (p->dir_history.list != NULL)
     {
         ev_history_load_save_t *ev = (ev_history_load_save_t *) data;
 
-        mc_config_history_save (ev->cfg, p->hist_name, p->dir_history);
+        mc_config_history_save (ev->cfg, p->dir_history.name, p->dir_history.list);
     }
 
     return TRUE;
@@ -1483,13 +1485,13 @@ panel_destroy (WPanel * p)
     panel_clean_dir (p);
 
     /* clean history */
-    if (p->dir_history != NULL)
+    if (p->dir_history.list != NULL)
     {
         /* directory history is already saved before this moment */
-        p->dir_history = g_list_first (p->dir_history);
-        g_list_free_full (p->dir_history, g_free);
+        p->dir_history.list = g_list_first (p->dir_history.list);
+        g_list_free_full (p->dir_history.list, g_free);
     }
-    g_free (p->hist_name);
+    g_free (p->dir_history.name);
 
     g_slist_free_full (p->format, (GDestroyNotify) format_item_free);
     g_slist_free_full (p->status_format, (GDestroyNotify) format_item_free);
@@ -1499,7 +1501,10 @@ panel_destroy (WPanel * p)
         g_free (p->user_status_format[i]);
 
     g_free (p->dir.list);
-    g_free (p->panel_name);
+    g_free (p->name);
+
+    g_string_free (p->quick_search.buffer, TRUE);
+    g_string_free (p->quick_search.prev_buffer, TRUE);
 
     vfs_path_free (p->lwd_vpath);
     vfs_path_free (p->cwd_vpath);
@@ -1834,7 +1839,7 @@ use_display_format (WPanel * panel, const char *format, char **error, gboolean i
     if (*error != NULL)
         return NULL;
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     usable_columns = WIDGET (panel)->cols - 2;
     /* Status needn't to be split */
@@ -2626,7 +2631,6 @@ panel_select_invert_files (WPanel * panel)
 static void
 do_search (WPanel * panel, int c_code)
 {
-    size_t l;
     int i, sel;
     gboolean wrapped = FALSE;
     char *act;
@@ -2634,47 +2638,42 @@ do_search (WPanel * panel, int c_code)
     char *reg_exp, *esc_str;
     gboolean is_found = FALSE;
 
-    l = strlen (panel->search_buffer);
     if (c_code == KEY_BACKSPACE)
     {
-        if (l != 0)
+        if (panel->quick_search.buffer->len != 0)
         {
-            act = panel->search_buffer + l;
-            str_prev_noncomb_char (&act, panel->search_buffer);
-            act[0] = '\0';
+            act = panel->quick_search.buffer->str + panel->quick_search.buffer->len;
+            str_prev_noncomb_char (&act, panel->quick_search.buffer->str);
+            g_string_set_size (panel->quick_search.buffer, act - panel->quick_search.buffer->str);
         }
-        panel->search_chpoint = 0;
+        panel->quick_search.chpoint = 0;
     }
     else
     {
-        if (c_code != 0 && (gsize) panel->search_chpoint < sizeof (panel->search_char))
+        if (c_code != 0 && (gsize) panel->quick_search.chpoint < sizeof (panel->quick_search.ch))
         {
-            panel->search_char[panel->search_chpoint] = c_code;
-            panel->search_chpoint++;
+            panel->quick_search.ch[panel->quick_search.chpoint] = c_code;
+            panel->quick_search.chpoint++;
         }
 
-        if (panel->search_chpoint > 0)
+        if (panel->quick_search.chpoint > 0)
         {
-            switch (str_is_valid_char (panel->search_char, panel->search_chpoint))
+            switch (str_is_valid_char (panel->quick_search.ch, panel->quick_search.chpoint))
             {
             case -2:
                 return;
             case -1:
-                panel->search_chpoint = 0;
+                panel->quick_search.chpoint = 0;
                 return;
             default:
-                if (l + panel->search_chpoint < sizeof (panel->search_buffer))
-                {
-                    memcpy (panel->search_buffer + l, panel->search_char, panel->search_chpoint);
-                    l += panel->search_chpoint;
-                    panel->search_buffer[l] = '\0';
-                    panel->search_chpoint = 0;
-                }
+                g_string_append_len (panel->quick_search.buffer, panel->quick_search.ch,
+                                     panel->quick_search.chpoint);
+                panel->quick_search.chpoint = 0;
             }
         }
     }
 
-    reg_exp = g_strdup_printf ("%s*", panel->search_buffer);
+    reg_exp = g_strdup_printf ("%s*", panel->quick_search.buffer->str);
     esc_str = strutils_escape (reg_exp, -1, ",|\\{}[]", TRUE);
     search = mc_search_new (esc_str, NULL);
     search->search_type = MC_SEARCH_T_GLOB;
@@ -2720,9 +2719,9 @@ do_search (WPanel * panel, int c_code)
     }
     else if (c_code != KEY_BACKSPACE)
     {
-        act = panel->search_buffer + l;
-        str_prev_noncomb_char (&act, panel->search_buffer);
-        act[0] = '\0';
+        act = panel->quick_search.buffer->str + panel->quick_search.buffer->len;
+        str_prev_noncomb_char (&act, panel->quick_search.buffer->str);
+        g_string_set_size (panel->quick_search.buffer, act - panel->quick_search.buffer->str);
     }
     mc_search_free (search);
     g_free (reg_exp);
@@ -2737,7 +2736,7 @@ do_search (WPanel * panel, int c_code)
 static void
 start_search (WPanel * panel)
 {
-    if (panel->searching)
+    if (panel->quick_search.active)
     {
         if (panel->selected == panel->dir.len - 1)
             panel->selected = 0;
@@ -2746,18 +2745,17 @@ start_search (WPanel * panel)
 
         /* in case if there was no search string we need to recall
            previous string, with which we ended previous searching */
-        if (panel->search_buffer[0] == '\0')
-            g_strlcpy (panel->search_buffer, panel->prev_search_buffer,
-                       sizeof (panel->search_buffer));
+        if (panel->quick_search.buffer->len == 0)
+            mc_g_string_copy (panel->quick_search.buffer, panel->quick_search.prev_buffer);
 
         do_search (panel, 0);
     }
     else
     {
-        panel->searching = TRUE;
-        panel->search_buffer[0] = '\0';
-        panel->search_char[0] = '\0';
-        panel->search_chpoint = 0;
+        panel->quick_search.active = TRUE;
+        g_string_set_size (panel->quick_search.buffer, 0);
+        panel->quick_search.ch[0] = '\0';
+        panel->quick_search.chpoint = 0;
         display_mini_info (panel);
         mc_refresh ();
     }
@@ -2768,13 +2766,12 @@ start_search (WPanel * panel)
 static void
 stop_search (WPanel * panel)
 {
-    panel->searching = FALSE;
+    panel->quick_search.active = FALSE;
 
-    /* if user had overrdied search string, we need to store it
-       to the previous_search_buffer */
-    if (panel->search_buffer[0] != '\0')
-        g_strlcpy (panel->prev_search_buffer, panel->search_buffer,
-                   sizeof (panel->prev_search_buffer));
+    /* if user overrdied search string, we need to store it
+       to the quick_search.prev_buffer */
+    if (panel->quick_search.buffer->len != 0)
+        mc_g_string_copy (panel->quick_search.prev_buffer, panel->quick_search.buffer);
 
     display_mini_info (panel);
 }
@@ -3288,7 +3285,7 @@ _do_panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_
     try_to_select (panel, get_parent_dir_name (panel->cwd_vpath, olddir_vpath));
 
     load_hint (FALSE);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     update_xterm_title_path ();
 
     vfs_path_free (olddir_vpath);
@@ -3308,7 +3305,7 @@ directory_history_next (WPanel * panel)
         GList *next;
 
         ok = TRUE;
-        next = g_list_next (panel->dir_history_current);
+        next = g_list_next (panel->dir_history.current);
         if (next != NULL)
         {
             vfs_path_t *data_vpath;
@@ -3316,7 +3313,7 @@ directory_history_next (WPanel * panel)
             data_vpath = vfs_path_from_str ((char *) next->data);
             ok = _do_panel_cd (panel, data_vpath, cd_exact);
             vfs_path_free (data_vpath);
-            panel->dir_history_current = next;
+            panel->dir_history.current = next;
         }
         /* skip directories that present in history but absent in file system */
     }
@@ -3335,7 +3332,7 @@ directory_history_prev (WPanel * panel)
         GList *prev;
 
         ok = TRUE;
-        prev = g_list_previous (panel->dir_history_current);
+        prev = g_list_previous (panel->dir_history.current);
         if (prev != NULL)
         {
             vfs_path_t *data_vpath;
@@ -3343,7 +3340,7 @@ directory_history_prev (WPanel * panel)
             data_vpath = vfs_path_from_str ((char *) prev->data);
             ok = _do_panel_cd (panel, data_vpath, cd_exact);
             vfs_path_free (data_vpath);
-            panel->dir_history_current = prev;
+            panel->dir_history.current = prev;
         }
         /* skip directories that present in history but absent in file system */
     }
@@ -3359,13 +3356,13 @@ directory_history_list (WPanel * panel)
     gboolean ok = FALSE;
     size_t pos;
 
-    pos = g_list_position (panel->dir_history_current, panel->dir_history);
+    pos = g_list_position (panel->dir_history.current, panel->dir_history.list);
 
-    history_descriptor_init (&hd, WIDGET (panel)->y, WIDGET (panel)->x, panel->dir_history,
+    history_descriptor_init (&hd, WIDGET (panel)->y, WIDGET (panel)->x, panel->dir_history.list,
                              (int) pos);
     history_show (&hd);
 
-    panel->dir_history = hd.list;
+    panel->dir_history.list = hd.list;
     if (hd.text != NULL)
     {
         vfs_path_t *s_vpath;
@@ -3387,17 +3384,17 @@ directory_history_list (WPanel * panel)
 
         size_t i;
 
-        panel->dir_history_current = panel->dir_history;
+        panel->dir_history.current = panel->dir_history.list;
 
         for (i = 0; i <= pos; i++)
         {
             GList *prev;
 
-            prev = g_list_previous (panel->dir_history_current);
+            prev = g_list_previous (panel->dir_history.current);
             if (prev == NULL)
                 break;
 
-            panel->dir_history_current = prev;
+            panel->dir_history.current = prev;
         }
     }
 }
@@ -3601,7 +3598,7 @@ panel_key (WPanel * panel, int key)
         return MSG_HANDLED;
     }
 
-    if (panel->searching && ((key >= ' ' && key <= 255) || key == KEY_BACKSPACE))
+    if (panel->quick_search.active && ((key >= ' ' && key <= 255) || key == KEY_BACKSPACE))
     {
         do_search (panel, key);
         return MSG_HANDLED;
@@ -3654,13 +3651,13 @@ panel_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
         paint_dir (panel);
         mini_info_separator (panel);
         display_mini_info (panel);
-        panel->dirty = 0;
+        panel->dirty = FALSE;
         return MSG_HANDLED;
 
     case MSG_FOCUS:
         state_mark = -1;
         current_panel = panel;
-        panel->active = 1;
+        panel->active = TRUE;
 
         if (mc_chdir (panel->cwd_vpath) != 0)
         {
@@ -3685,7 +3682,7 @@ panel_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
     case MSG_UNFOCUS:
         /* Janne: look at this for the multiple panel options */
         stop_search (panel);
-        panel->active = 0;
+        panel->active = FALSE;
         unselect_item (panel);
         return MSG_HANDLED;
 
@@ -3870,7 +3867,7 @@ panel_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
                 /* no other events on 1st line, return MOU_UNHANDLED */
                 event->result.abort = TRUE;
                 /* avoid extra panel redraw */
-                panel->dirty = 0;
+                panel->dirty = FALSE;
             }
             break;
         }
@@ -4014,7 +4011,7 @@ update_one_panel_widget (WPanel * panel, panel_update_flags_t flags, const char
         panel_reload (panel);
 
     try_to_select (panel, current_file);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     if (free_pointer)
         g_free (my_current_file);
@@ -4043,7 +4040,7 @@ do_select (WPanel * panel, int i)
 {
     if (i != panel->selected)
     {
-        panel->dirty = 1;
+        panel->dirty = TRUE;
         panel->selected = i;
         panel->top_file = panel->selected - (WIDGET (panel)->lines - 2) / 2;
         if (panel->top_file < 0)
@@ -4235,9 +4232,9 @@ panel_clean_dir (WPanel * panel)
     panel->marked = 0;
     panel->dirs_marked = 0;
     panel->total = 0;
-    panel->searching = FALSE;
+    panel->quick_search.active = FALSE;
     panel->is_panelized = FALSE;
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     panel->content_shift = -1;
     panel->max_shift = -1;
 
@@ -4310,7 +4307,7 @@ panel_sized_empty_new (const char *panel_name, int y, int x, int lines, int cols
 
     panel->list_cols = 1;
     panel->brief_cols = 2;
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     panel->content_shift = -1;
     panel->max_shift = -1;
 
@@ -4326,15 +4323,18 @@ panel_sized_empty_new (const char *panel_name, int y, int x, int lines, int cols
 
     panel->frame_size = frame_half;
 
-    panel->panel_name = g_strdup (panel_name);
-    panel->hist_name = g_strconcat ("Dir Hist ", panel->panel_name, (char *) NULL);
+    panel->quick_search.buffer = g_string_sized_new (MC_MAXFILENAMELEN);
+    panel->quick_search.prev_buffer = g_string_sized_new (MC_MAXFILENAMELEN);
+
+    panel->name = g_strdup (panel_name);
+    panel->dir_history.name = g_strconcat ("Dir Hist ", panel->name, (char *) NULL);
     /* directories history will be get later */
 
-    section = g_strconcat ("Temporal:", panel->panel_name, (char *) NULL);
+    section = g_strconcat ("Temporal:", panel->name, (char *) NULL);
     if (!mc_config_has_group (mc_global.main_config, section))
     {
         g_free (section);
-        section = g_strdup (panel->panel_name);
+        section = g_strdup (panel->name);
     }
     panel_load_setup (panel, section);
     g_free (section);
@@ -4455,7 +4455,7 @@ panel_reload (WPanel * panel)
                           &panel->sort_info, panel->filter))
         message (D_ERROR, MSG_ERROR, _("Cannot read directory contents"));
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     if (panel->selected >= panel->dir.len)
         do_select (panel, panel->dir.len - 1);
 
@@ -4530,7 +4530,7 @@ select_item (WPanel * panel)
 {
     adjust_top_file (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     execute_hooks (select_file_hook);
 }
@@ -4645,7 +4645,7 @@ file_mark (WPanel * panel, int lc_index, int val)
     if (panel->dir.list[lc_index].f.marked != val)
     {
         panel->dir.list[lc_index].f.marked = val;
-        panel->dirty = 1;
+        panel->dirty = TRUE;
     }
 }
 
@@ -4675,7 +4675,7 @@ panel_re_sort (WPanel * panel)
     g_free (filename);
     panel->top_file = panel->selected - panel_items (panel) / 2;
     select_item (panel);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -4991,6 +4991,8 @@ panel_init (void)
     panel_filename_scroll_right_char =
         mc_skin_get ("widget-panel", "filename-scroll-right-char", "}");
 
+    string_file_name_buffer = g_string_sized_new (MC_MAXFILENAMELEN);
+
     mc_event_add (MCEVENT_GROUP_FILEMANAGER, "update_panels", event_update_panels, NULL, NULL);
     mc_event_add (MCEVENT_GROUP_FILEMANAGER, "panel_save_current_file_to_clip_file",
                   panel_save_current_file_to_clip_file, NULL, NULL);
@@ -5010,6 +5012,7 @@ panel_deinit (void)
     g_free (panel_history_show_list_char);
     g_free (panel_filename_scroll_left_char);
     g_free (panel_filename_scroll_right_char);
+    g_string_free (string_file_name_buffer, TRUE);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/panel.h b/src/filemanager/panel.h
index 1055ddf05..46192cc22 100644
--- a/src/filemanager/panel.h
+++ b/src/filemanager/panel.h
@@ -90,51 +90,63 @@ typedef struct
 typedef struct
 {
     Widget widget;
+
+    char *name;                 /* The panel name */
+
+    panel_display_t frame_size; /* half or full frame */
+
+    gboolean active;            /* If panel is currently selected */
+    gboolean dirty;             /* Should we redisplay the panel? */
+    gboolean is_panelized;      /* Flag: special filelisting, can't reload */
+
+#ifdef HAVE_CHARSET
+    int codepage;               /* Panel codepage */
+#endif
+
     dir_list dir;               /* Directory contents */
+    struct stat dir_stat;       /* Stat of current dir: used by execute () */
 
-    list_format_t list_format;  /* listing type */
-    int active;                 /* If panel is currently selected */
     vfs_path_t *cwd_vpath;      /* Current Working Directory */
     vfs_path_t *lwd_vpath;      /* Last Working Directory */
-    GList *dir_history;         /* directory history */
-    GList *dir_history_current; /* pointer to the current history item */
-    char *hist_name;            /* directory history name for history file */
-    int marked;                 /* Count of marked files */
-    int dirs_marked;            /* Count of marked directories */
-    uintmax_t total;            /* Bytes in marked files */
-    int top_file;               /* The file showed on the top of the panel */
-    int selected;               /* Index to the selected file */
+
+    list_format_t list_format;  /* Listing type */
+    GSList *format;             /* Display format */
+    char *user_format;          /* User format */
     int list_cols;              /* Number of file list columns */
     int brief_cols;             /* Number of columns in case of list_brief format */
-    gboolean is_panelized;      /* Flag: special filelisting, can't reload */
-    panel_display_t frame_size; /* half or full frame */
-    char *filter;               /* File name filter */
-
     /* sort */
     dir_sort_options_t sort_info;
     const panel_field_t *sort_field;
 
-    int dirty;                  /* Should we redisplay the panel? */
+    int marked;                 /* Count of marked files */
+    int dirs_marked;            /* Count of marked directories */
+    uintmax_t total;            /* Bytes in marked files */
 
-    gboolean user_mini_status;  /* Is user_status_format used */
-    char *user_format;          /* User format */
-    char *user_status_format[LIST_FORMATS];     /* User format for status line */
+    int top_file;               /* The file showed on the top of the panel */
+    int selected;               /* Index to the selected file */
 
-    GSList *format;             /* Display format */
     GSList *status_format;      /* Mini status format */
+    gboolean user_mini_status;  /* Is user_status_format used */
+    char *user_status_format[LIST_FORMATS];     /* User format for status line */
 
-    char *panel_name;           /* The panel name */
-    struct stat dir_stat;       /* Stat of current dir: used by execute () */
+    char *filter;               /* File name filter */
 
-#ifdef HAVE_CHARSET
-    int codepage;               /* panel codepage */
-#endif
+    struct
+    {
+        char *name;             /* Directory history name for history file */
+        GList *list;            /* Directory history */
+        GList *current;         /* Pointer to the current history item */
+    } dir_history;
+
+    struct
+    {
+        gboolean active;
+        GString *buffer;
+        GString *prev_buffer;
+        char ch[MB_LEN_MAX];    /* Buffer for multi-byte character */
+        int chpoint;            /* Point after last characters in @ch */
+    } quick_search;
 
-    gboolean searching;
-    char search_buffer[MC_MAXFILENAMELEN];
-    char prev_search_buffer[MC_MAXFILENAMELEN];
-    char search_char[MB_LEN_MAX];       /*buffer for multibytes characters */
-    int search_chpoint;         /*point after last characters in search_char */
     int content_shift;          /* Number of characters of filename need to skip from left side. */
     int max_shift;              /* Max shift for visible part of current panel */
 } WPanel;
diff --git a/src/filemanager/tree.c b/src/filemanager/tree.c
index 008bc0403..e2edaab54 100644
--- a/src/filemanager/tree.c
+++ b/src/filemanager/tree.c
@@ -92,7 +92,7 @@ struct WTree
     Widget widget;
     struct TreeStore *store;
     tree_entry *selected_ptr;   /* The selected directory */
-    char search_buffer[MC_MAXFILENAMELEN];      /* Current search string */
+    GString *search_buffer;     /* Current search string */
     tree_entry **tree_shown;    /* Entries currently on screen */
     gboolean is_panel;          /* panel or plain widget flag */
     gboolean searching;         /* Are we on searching mode? */
@@ -195,6 +195,7 @@ tree_destroy (WTree * tree)
     save_tree (tree);
 
     MC_PTR_FREE (tree->tree_shown);
+    g_string_free (tree->search_buffer, TRUE);
     tree->selected_ptr = NULL;
 }
 
@@ -239,7 +240,7 @@ tree_show_mini_info (WTree * tree, int tree_lines, int tree_cols)
         tty_draw_hline (w->y + line, w->x + 1, ' ', tree_cols);
         widget_gotoyx (w, line, 1);
         tty_print_char (PATH_SEP);
-        tty_print_string (str_fit_to_term (tree->search_buffer, tree_cols - 2, J_LEFT_FIT));
+        tty_print_string (str_fit_to_term (tree->search_buffer->str, tree_cols - 2, J_LEFT_FIT));
         tty_print_char (' ');
     }
     else
@@ -618,19 +619,15 @@ maybe_chdir (WTree * tree)
 /* --------------------------------------------------------------------------------------------- */
 /** Search tree for text */
 
-static int
-search_tree (WTree * tree, char *text)
+static gboolean
+search_tree (WTree * tree, const GString * text)
 {
-    tree_entry *current;
-    size_t len;
+    tree_entry *current = tree->selected_ptr;
     gboolean wrapped = FALSE;
     gboolean found = FALSE;
 
-    len = strlen (text);
-    current = tree->selected_ptr;
-
     while (!found && (!wrapped || current != tree->selected_ptr))
-        if (strncmp (current->subname, text, len) == 0)
+        if (strncmp (current->subname, text->str, text->len) == 0)
         {
             tree->selected_ptr = current;
             found = TRUE;
@@ -656,19 +653,15 @@ search_tree (WTree * tree, char *text)
 static void
 tree_do_search (WTree * tree, int key)
 {
-    size_t l;
+    /* TODO: support multi-byte characters, see do_search() in panel.c */
 
-    l = strlen (tree->search_buffer);
-    if ((l != 0) && (key == KEY_BACKSPACE))
-        tree->search_buffer[--l] = '\0';
-    else if (key && l < sizeof (tree->search_buffer) - 1)
-    {
-        tree->search_buffer[l] = key;
-        tree->search_buffer[++l] = '\0';
-    }
+    if (tree->search_buffer->len != 0 && key == KEY_BACKSPACE)
+        g_string_set_size (tree->search_buffer, tree->search_buffer->len - 1);
+    else if (key != 0)
+        g_string_append_c (tree->search_buffer, (gchar) key);
 
     if (!search_tree (tree, tree->search_buffer))
-        tree->search_buffer[--l] = '\0';
+        g_string_set_size (tree->search_buffer, tree->search_buffer->len - 1);
 
     show_tree (tree);
     maybe_chdir (tree);
@@ -970,7 +963,7 @@ tree_start_search (WTree * tree)
     else
     {
         tree->searching = TRUE;
-        tree->search_buffer[0] = '\0';
+        g_string_set_size (tree->search_buffer, 0);
     }
 }
 
@@ -1301,7 +1294,7 @@ tree_new (int y, int x, int lines, int cols, gboolean is_panel)
     tree->store = tree_store_get ();
     tree_store_add_entry_remove_hook (remove_callback, tree);
     tree->tree_shown = NULL;
-    tree->search_buffer[0] = '\0';
+    tree->search_buffer = g_string_sized_new (MC_MAXPATHLEN);
     tree->topdiff = w->lines / 2;
     tree->searching = FALSE;
 
diff --git a/src/filemanager/treestore.c b/src/filemanager/treestore.c
index 08354b217..aafb523af 100644
--- a/src/filemanager/treestore.c
+++ b/src/filemanager/treestore.c
@@ -909,7 +909,7 @@ tree_store_rescan (const vfs_path_t * vpath)
     dirp = mc_opendir (vpath);
     if (dirp != NULL)
     {
-        struct dirent *dp;
+        struct vfs_dirent *dp;
 
         for (dp = mc_readdir (dirp); dp != NULL; dp = mc_readdir (dirp))
             if (!DIR_IS_DOT (dp->d_name) && !DIR_IS_DOTDOT (dp->d_name))
diff --git a/src/keybind-defaults.c b/src/keybind-defaults.c
index 713a400da..c423e6be4 100644
--- a/src/keybind-defaults.c
+++ b/src/keybind-defaults.c
@@ -90,7 +90,7 @@ typedef struct global_keymap_ini_t
 
 /* midnight */
 static const global_keymap_ini_t default_main_keymap[] = {
-    {"ChangePanel", "tab"},
+    {"ChangePanel", "tab; ctrl-i"},
     {"Help", "f1"},
     {"UserMenu", "f2"},
     {"View", "f3"},
diff --git a/src/main.c b/src/main.c
index 6db18b200..fb3426ffb 100644
--- a/src/main.c
+++ b/src/main.c
@@ -49,7 +49,6 @@
 #include "lib/tty/tty.h"
 #include "lib/tty/key.h"        /* For init_key() */
 #include "lib/tty/mouse.h"      /* init_mouse() */
-#include "lib/timer.h"
 #include "lib/skin.h"
 #include "lib/filehighlight.h"
 #include "lib/fileloc.h"
@@ -255,8 +254,6 @@ main (int argc, char *argv[])
 
     mc_global.run_from_parent_mc = !check_sid ();
 
-    mc_global.timer = mc_timer_new ();
-
     /* We had LC_CTYPE before, LC_ALL includs LC_TYPE as well */
 #ifdef HAVE_SETLOCALE
     (void) setlocale (LC_ALL, "");
@@ -277,7 +274,6 @@ main (int argc, char *argv[])
       startup_exit_ok:
         mc_shell_deinit ();
         str_uninit_strings ();
-        mc_timer_destroy (mc_global.timer);
         return exit_code;
     }
 
@@ -557,8 +553,6 @@ main (int argc, char *argv[])
         exit_code = EXIT_FAILURE;
     }
 
-    mc_timer_destroy (mc_global.timer);
-
     (void) putchar ('\n');      /* Hack to make shell's prompt start at left of screen */
 
     return exit_code;
diff --git a/src/setup.c b/src/setup.c
index 37618a9cd..97da20940 100644
--- a/src/setup.c
+++ b/src/setup.c
@@ -360,6 +360,7 @@ static const struct
 #endif /* USE_INTERNAL_EDIT */
     { "editor_ask_filename_before_edit", &editor_ask_filename_before_edit },
     { "nice_rotating_dash", &nice_rotating_dash },
+    { "shadows", &mc_global.tty.shadows },
     { "mcview_remember_file_position", &mcview_remember_file_position },
     { "auto_fill_mkdir_name", &auto_fill_mkdir_name },
     { "copymove_persistent_attr", &copymove_persistent_attr },
@@ -996,11 +997,11 @@ save_panel_types (void)
     type = get_panel_type (0);
     panel_save_type ("New Left Panel", type);
     if (type == view_listing)
-        panel_save_setup (left_panel, left_panel->panel_name);
+        panel_save_setup (left_panel, left_panel->name);
     type = get_panel_type (1);
     panel_save_type ("New Right Panel", type);
     if (type == view_listing)
-        panel_save_setup (right_panel, right_panel->panel_name);
+        panel_save_setup (right_panel, right_panel->name);
 
     {
         char *dirs;
diff --git a/src/setup.h b/src/setup.h
index 7de0fe393..5a430a6c8 100644
--- a/src/setup.h
+++ b/src/setup.h
@@ -73,7 +73,7 @@ struct mc_fhl_struct;
 
 /*** global variables defined in .c file *********************************************************/
 
-/* global paremeters */
+/* global parameters */
 extern char *global_profile_name;
 extern gboolean confirm_delete;
 extern gboolean confirm_directory_hotlist_delete;
diff --git a/src/subshell/common.c b/src/subshell/common.c
index 06699233c..02ae85211 100644
--- a/src/subshell/common.c
+++ b/src/subshell/common.c
@@ -9,25 +9,26 @@
    Aliaksey Kandratsenka <alk@tut.by>
    Andreas Mohr <and@gmx.li>
    Andrew Borodin <aborodin@vmail.ru>
-   Andrew Borodin <borodin@borodin.zarya>
    Andrew V. Samoilov <sav@bcs.zp.ua>
    Chris Owen <chris@candu.co.uk>
    Claes Nästén <me@pekdon.net>
    Egmont Koblinger <egmont@gmail.com>
    Enrico Weigelt, metux IT service <weigelt@metux.de>
+   Eric Roberts <ericmrobertsdeveloper@gmail.com>
    Igor Urazov <z0rc3r@gmail.com>
    Ilia Maslakov <il.smind@gmail.com>
    Leonard den Ottolander <leonard@den.ottolander.nl>
    Miguel de Icaza <miguel@novell.com>
    Mikhail S. Pobolovets <styx.mp@gmail.com>
    Norbert Warmuth <nwarmuth@privat.circular.de>
+   Oswald Buddenhagen <oswald.buddenhagen@gmx.de>
    Patrick Winnertz <winnie@debian.org>
    Pavel Machek <pavel@suse.cz>
    Pavel Roskin <proski@gnu.org>
    Pavel Tsekov <ptsekov@gmx.net>
    Roland Illig <roland.illig@gmx.de>
    Sergei Trofimovich <slyfox@inbox.ru>
-   Slava Zanko <slavazanko@gmail.com>, 2013,2015.
+   Slava Zanko <slavazanko@gmail.com>
    Timur Bakeyev <mc@bat.ru>
    Vit Rosin <vit_r@list.ru>
 
@@ -105,6 +106,9 @@
 #include "lib/util.h"
 #include "lib/widget.h"
 
+#include "src/filemanager/layout.h"     /* setup_cmdline() */
+#include "src/filemanager/command.h"    /* cmdline */
+
 #include "subshell.h"
 #include "internal.h"
 
@@ -123,6 +127,10 @@ GString *subshell_prompt = NULL;
 /* We need to paint it after CONSOLE_RESTORE, see: load_prompt */
 gboolean update_subshell_prompt = FALSE;
 
+/* If set, then a command has just finished executing, and we need */
+/* to be on the lookout for a new prompt string from the subshell. */
+gboolean should_read_new_subshell_prompt;
+
 /*** file scope macro definitions ****************************************************************/
 
 #ifndef WEXITSTATUS
@@ -151,6 +159,14 @@ enum
     WRITE = 1
 };
 
+/* This is the keybinding that is sent to the shell, to make the shell send us the contents of
+ * the current command buffer. */
+#define SHELL_BUFFER_KEYBINDING "_"
+
+/* This is the keybinding that is sent to the shell, to make the shell send us the location of
+ * the cursor. */
+#define SHELL_CURSOR_KEYBINDING "+"
+
 /*** file scope variables ************************************************************************/
 
 /* tcsh closes all non-standard file descriptors, so we have to use a pipe */
@@ -169,6 +185,9 @@ static char pty_buffer[PTY_BUFFER_SIZE] = "\0";
 /* To pass CWD info from the subshell to MC */
 static int subshell_pipe[2];
 
+/* To pass command buffer info from the subshell to MC */
+static int command_buffer_pipe[2];
+
 /* The subshell's process ID */
 static pid_t subshell_pid = 1;
 
@@ -178,6 +197,17 @@ static char subshell_cwd[MC_MAXPATHLEN + 1];
 /* Flag to indicate whether the subshell is ready for next command */
 static int subshell_ready;
 
+/* Flag to indicate if the subshell supports the persistent buffer feature. */
+static gboolean use_persistent_buffer = FALSE;
+
+/* Flag to indicate if the contents of the subshell command line need to be cleared before */
+/* executing a command. This should only end up set to true if there is some sort of error. */
+/* This allows us to recover gracefully from an error. */
+static gboolean subshell_should_clear_command_line = FALSE;
+
+/* This is the local variable where the subshell prompt is stored while we are working on it. */
+static GString *subshell_prompt_temp_buffer = NULL;
+
 /* The following two flags can be changed by the SIGCHLD handler. This is */
 /* OK, because the 'int' type is updated atomically on all known machines */
 static volatile int subshell_alive, subshell_stopped;
@@ -353,7 +383,7 @@ init_subshell_child (const char *pty_name)
 
     /* Attach all our standard file descriptors to the pty */
 
-    /* This is done just before the fork, because stderr must still      */
+    /* This is done just before the exec, because stderr must still      */
     /* be connected to the real tty during the above error messages; */
     /* otherwise the user will never see them.                   */
 
@@ -362,6 +392,10 @@ init_subshell_child (const char *pty_name)
     dup2 (subshell_pty_slave, STDERR_FILENO);
 
     close (subshell_pipe[READ]);
+
+    if (use_persistent_buffer)
+        close (command_buffer_pipe[READ]);
+
     close (subshell_pty_slave); /* These may be FD_CLOEXEC, but just in case... */
     /* Close master side of pty.  This is important; apart from */
     /* freeing up the descriptor for use in the subshell, it also       */
@@ -468,6 +502,232 @@ synchronize (void)
     /* We can't do any better without modifying the shell(s) */
 }
 
+/* --------------------------------------------------------------------------------------------- */
+/* Get the contents of the current subshell command line buffer, and */
+/* transfer the contents to the panel command prompt. */
+
+static gboolean
+read_command_line_buffer (gboolean test_mode)
+{
+    char subshell_command_buffer[BUF_LARGE];
+    char subshell_cursor_buffer[BUF_SMALL];
+
+    fd_set read_set;
+    int i;
+    ssize_t bytes;
+    struct timeval subshell_prompt_timer = { 0, 0 };
+    int command_buffer_length;
+    int command_buffer_char_length;
+    int bash_version;
+    int cursor_position;
+    int maxfdp;
+    int rc;
+
+    if (!use_persistent_buffer)
+        return TRUE;
+
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+    maxfdp = command_buffer_pipe[READ];
+
+    /* First, flush the command buffer pipe. This pipe shouldn't be written
+     * to under normal circumstances, but if it somehow does get written
+     * to, we need to make sure to discard whatever data is there before
+     * we try to use it. */
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 0)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 1)
+        {
+            bytes = read (command_buffer_pipe[READ], subshell_command_buffer,
+                          sizeof (subshell_command_buffer));
+            (void) bytes;
+        }
+    }
+
+    /* get contents of command line buffer */
+    write_all (mc_global.tty.subshell_pty, ESC_STR SHELL_BUFFER_KEYBINDING,
+               sizeof (ESC_STR SHELL_CURSOR_KEYBINDING) - 1);
+
+    subshell_prompt_timer.tv_sec = 1;
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 1)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 0)
+            return FALSE;
+    }
+
+    bytes =
+        read (command_buffer_pipe[READ], subshell_command_buffer, sizeof (subshell_command_buffer));
+    if (bytes == 0 || bytes == sizeof (subshell_command_buffer))
+        return FALSE;
+
+    command_buffer_char_length = bytes - 1;
+    subshell_command_buffer[command_buffer_char_length] = '\0';
+    command_buffer_length = str_length (subshell_command_buffer);
+
+    /* get cursor position */
+    write_all (mc_global.tty.subshell_pty, ESC_STR SHELL_CURSOR_KEYBINDING,
+               sizeof (ESC_STR SHELL_CURSOR_KEYBINDING) - 1);
+
+    subshell_prompt_timer.tv_sec = 1;
+    subshell_prompt_timer.tv_usec = 0;
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 1)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 0)
+            return FALSE;
+    }
+
+    bytes =
+        read (command_buffer_pipe[READ], subshell_cursor_buffer, sizeof (subshell_cursor_buffer));
+    if (bytes == 0)
+        return FALSE;
+
+    subshell_cursor_buffer[bytes - 1] = '\0';
+    if (mc_global.shell->type == SHELL_BASH)
+    {
+        if (sscanf (subshell_cursor_buffer, "%d:%d", &bash_version, &cursor_position) != 2)
+            return FALSE;
+    }
+    else
+    {
+        if (sscanf (subshell_cursor_buffer, "%d", &cursor_position) != 1)
+            return FALSE;
+        bash_version = 1000;
+    }
+
+    if (test_mode)
+        return TRUE;
+
+    /* Substitute non-text characters in the command buffer, such as tab, or newline, as this
+     * could cause problems. */
+    for (i = 0; i < command_buffer_char_length; i++)
+        if ((unsigned char) subshell_command_buffer[i] < 32
+            || (unsigned char) subshell_command_buffer[i] == 127)
+            subshell_command_buffer[i] = ' ';
+
+    input_assign_text (cmdline, "");
+    input_insert (cmdline, subshell_command_buffer, FALSE);
+
+    if (bash_version < 5)       /* implies SHELL_BASH */
+    {
+        /* We need to do this because bash < v5 gives the cursor position in a utf-8 string based
+         * on the location in bytes, not in unicode characters. */
+        char *curr, *stop;
+
+        curr = subshell_command_buffer;
+        stop = curr + cursor_position;
+
+        for (cursor_position = 0; curr < stop; cursor_position++)
+            str_next_char_safe (&curr);
+    }
+    if (cursor_position > command_buffer_length)
+        cursor_position = command_buffer_length;
+    cmdline->point = cursor_position;
+    /* We send any remaining data to STDOUT before we finish. */
+    flush_subshell (0, VISIBLY);
+
+    /* Now we erase the current contents of the command line buffer */
+    if (mc_global.shell->type != SHELL_ZSH)
+    {
+        /* In zsh, we can just press c-u to clear the line, without needing to go to the end of
+         * the line first first. In all other shells, we must go to the end of the line first. */
+
+        /* If we are not at the end of the line, we go to the end. */
+        if (cursor_position != command_buffer_length)
+        {
+            write_all (mc_global.tty.subshell_pty, "\005", 1);
+            if (flush_subshell (1, VISIBLY) != 1)
+                return FALSE;
+        }
+    }
+
+    if (command_buffer_length > 0)
+    {
+        /* Now we clear the line. */
+        write_all (mc_global.tty.subshell_pty, "\025", 1);
+        if (flush_subshell (1, VISIBLY) != 1)
+            return FALSE;
+    }
+
+    return TRUE;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+clear_subshell_prompt_string (void)
+{
+    if (subshell_prompt_temp_buffer != NULL)
+        g_string_set_size (subshell_prompt_temp_buffer, 0);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+parse_subshell_prompt_string (const char *buffer, int bytes)
+{
+    int i;
+
+    if (mc_global.mc_run_mode != MC_RUN_FULL)
+        return;
+
+    /* First time through */
+    if (subshell_prompt == NULL)
+        subshell_prompt = g_string_sized_new (INITIAL_PROMPT_SIZE);
+    if (subshell_prompt_temp_buffer == NULL)
+        subshell_prompt_temp_buffer = g_string_sized_new (INITIAL_PROMPT_SIZE);
+
+    /* Extract the prompt from the shell output */
+    for (i = 0; i < bytes; i++)
+        if (buffer[i] == '\n' || buffer[i] == '\r')
+            g_string_set_size (subshell_prompt_temp_buffer, 0);
+        else if (buffer[i] != '\0')
+            g_string_append_c (subshell_prompt_temp_buffer, buffer[i]);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+set_prompt_string (void)
+{
+    if (mc_global.mc_run_mode != MC_RUN_FULL)
+        return;
+
+    if (subshell_prompt_temp_buffer->len != 0)
+        g_string_assign (subshell_prompt, subshell_prompt_temp_buffer->str);
+
+    setup_cmdline ();
+}
+
 /* --------------------------------------------------------------------------------------------- */
 /** Feed the subshell our keyboard input until it says it's finished */
 
@@ -481,6 +741,9 @@ feed_subshell (int how, gboolean fail_on_error)
     struct timeval wtime;       /* Maximum time we wait for the subshell */
     struct timeval *wptr;
 
+    should_read_new_subshell_prompt = FALSE;
+    subshell_should_clear_command_line = FALSE;
+
     /* we wait up to 10 seconds if fail_on_error, forever otherwise */
     wtime.tv_sec = 10;
     wtime.tv_usec = 0;
@@ -549,6 +812,9 @@ feed_subshell (int how, gboolean fail_on_error)
 
             if (how == VISIBLY)
                 write_all (STDOUT_FILENO, pty_buffer, bytes);
+
+            if (should_read_new_subshell_prompt)
+                parse_subshell_prompt_string (pty_buffer, bytes);
         }
 
         else if (FD_ISSET (subshell_pipe[READ], &read_set))
@@ -563,10 +829,12 @@ feed_subshell (int how, gboolean fail_on_error)
                 exit (EXIT_FAILURE);
             }
 
-            subshell_cwd[bytes - 1] = 0;        /* Squash the final '\n' */
+            subshell_cwd[bytes - 1] = '\0';     /* Squash the final '\n' */
 
             synchronize ();
 
+            clear_subshell_prompt_string ();
+            should_read_new_subshell_prompt = TRUE;
             subshell_ready = TRUE;
             if (subshell_state == RUNNING_COMMAND)
             {
@@ -578,6 +846,7 @@ feed_subshell (int how, gboolean fail_on_error)
         else if (FD_ISSET (STDIN_FILENO, &read_set))
             /* Read from stdin, write to the subshell */
         {
+            should_read_new_subshell_prompt = FALSE;
             bytes = read (STDIN_FILENO, pty_buffer, sizeof (pty_buffer));
             if (bytes <= 0)
             {
@@ -591,15 +860,33 @@ feed_subshell (int how, gboolean fail_on_error)
                 if (pty_buffer[i] == subshell_switch_key)
                 {
                     write_all (mc_global.tty.subshell_pty, pty_buffer, i);
+
                     if (subshell_ready)
+                    {
                         subshell_state = INACTIVE;
+                        set_prompt_string ();
+                        if (subshell_ready && !read_command_line_buffer (FALSE))
+                        {
+                            /* If we got here, some unforseen error must have occurred. */
+                            flush_subshell (0, VISIBLY);
+                            input_assign_text (cmdline, "");
+                            subshell_should_clear_command_line = TRUE;
+                        }
+                    }
+
                     return TRUE;
                 }
 
             write_all (mc_global.tty.subshell_pty, pty_buffer, bytes);
 
             if (pty_buffer[bytes - 1] == '\n' || pty_buffer[bytes - 1] == '\r')
+            {
+                /* We should only clear the command line if we are using a shell that works
+                 * with persistent command buffer, otherwise we get awkward results. */
+                if (use_persistent_buffer)
+                    input_assign_text (cmdline, "");
                 subshell_ready = FALSE;
+            }
         }
         else
             return FALSE;
@@ -784,8 +1071,13 @@ init_subshell_precmd (char *precmd, size_t buff_size)
     {
     case SHELL_BASH:
         g_snprintf (precmd, buff_size,
+                    " mc_print_command_buffer () { printf \"%%s\\\\n\" \"$READLINE_LINE\" >&%d; }\n"
+                    " bind -x '\"\\e" SHELL_BUFFER_KEYBINDING "\":\"mc_print_command_buffer\"'\n"
+                    " bind -x '\"\\e" SHELL_CURSOR_KEYBINDING
+                    "\":\"echo $BASH_VERSINFO:$READLINE_POINT >&%d\"'\n"
                     " PROMPT_COMMAND=${PROMPT_COMMAND:+$PROMPT_COMMAND\n}'pwd>&%d;kill -STOP $$'\n"
-                    "PS1='\\u@\\h:\\w\\$ '\n", subshell_pipe[WRITE]);
+                    "PS1='\\u@\\h:\\w\\$ '\n", command_buffer_pipe[WRITE],
+                    command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     case SHELL_ASH_BUSYBOX:
@@ -800,7 +1092,7 @@ init_subshell_precmd (char *precmd, size_t buff_size)
          *    "PS1='$(precmd)\\u@\\h:\\w\\$ '\n",
          *
          * C: This works if user calls "ash" command because in sub-subshell
-         *    PRECMD is unfedined, thus evaluated to empty string - no damage done.
+         *    PRECMD is undefined, thus evaluated to empty string - no damage done.
          *    Attention: BusyBox must be built with FEATURE_EDITING_FANCY_PROMPT to
          *    permit \u, \w, \h, \$ escape sequences. Unfortunately this cannot be guaranteed,
          *    especially on embedded systems where people try to save space, so let's use
@@ -844,25 +1136,33 @@ init_subshell_precmd (char *precmd, size_t buff_size)
 
     case SHELL_ZSH:
         g_snprintf (precmd, buff_size,
+                    " mc_print_command_buffer () { printf \"%%s\\\\n\" \"$BUFFER\" >&%d; }\n"
+                    " zle -N mc_print_command_buffer\n"
+                    " bindkey '^[" SHELL_BUFFER_KEYBINDING "' mc_print_command_buffer\n"
+                    " mc_print_cursor_position () { echo $CURSOR >&%d}\n"
+                    " zle -N mc_print_cursor_position\n"
+                    " bindkey '^[" SHELL_CURSOR_KEYBINDING "' mc_print_cursor_position\n"
                     " _mc_precmd(){ pwd>&%d;kill -STOP $$ }; precmd_functions+=(_mc_precmd)\n"
-                    "PS1='%%n@%%m:%%~%%# '\n", subshell_pipe[WRITE]);
+                    "PS1='%%n@%%m:%%~%%# '\n",
+                    command_buffer_pipe[WRITE], command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     case SHELL_TCSH:
         g_snprintf (precmd, buff_size,
                     "set echo_style=both; "
                     "set prompt='%%n@%%m:%%~%%# '; "
-                    "alias precmd 'echo $cwd:q >>%s; kill -STOP $$'\n", tcsh_fifo);
+                    "alias precmd 'echo -n;echo $cwd:q >>%s; kill -STOP $$'\n", tcsh_fifo);
         break;
-
     case SHELL_FISH:
         g_snprintf (precmd, buff_size,
-                    " if not functions -q fish_prompt_mc;"
+                    " bind \\e" SHELL_BUFFER_KEYBINDING " 'commandline >&%d';"
+                    "bind \\e" SHELL_CURSOR_KEYBINDING " 'commandline -C >&%d';"
+                    "if not functions -q fish_prompt_mc;"
                     "functions -e fish_right_prompt;"
                     "functions -c fish_prompt fish_prompt_mc; end;"
                     "function fish_prompt;"
                     "echo \"$PWD\">&%d; fish_prompt_mc; kill -STOP %%self; end\n",
-                    subshell_pipe[WRITE]);
+                    command_buffer_pipe[WRITE], command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     default:
@@ -1034,7 +1334,18 @@ init_subshell (void)
                 return;
             }
         }
-        else if (pipe (subshell_pipe))  /* subshell_type is BASH, ASH_BUSYBOX, DASH or ZSH */
+        else if (pipe (subshell_pipe) != 0)     /* subshell_type is BASH, ASH_BUSYBOX, DASH or ZSH */
+        {
+            perror (__FILE__ ": couldn't create pipe");
+            mc_global.tty.use_subshell = FALSE;
+            return;
+        }
+
+        if (mc_global.mc_run_mode == MC_RUN_FULL &&
+            (mc_global.shell->type == SHELL_BASH || mc_global.shell->type == SHELL_ZSH
+             || mc_global.shell->type == SHELL_FISH))
+            use_persistent_buffer = TRUE;
+        if (use_persistent_buffer && pipe (command_buffer_pipe) != 0)
         {
             perror (__FILE__ ": couldn't create pipe");
             mc_global.tty.use_subshell = FALSE;
@@ -1071,12 +1382,17 @@ init_subshell (void)
     subshell_state = RUNNING_COMMAND;
     tty_enable_interrupt_key ();
     if (!feed_subshell (QUIETLY, TRUE))
-    {
         mc_global.tty.use_subshell = FALSE;
-    }
     tty_disable_interrupt_key ();
     if (!subshell_alive)
         mc_global.tty.use_subshell = FALSE;     /* Subshell died instantly, so don't use it */
+
+    /* Try out the persistent command buffer feature. If it doesn't work the first time, we
+     * assume there must be something wrong with the shell, and we turn persistent buffer off
+     * for good. This will save the user the trouble of having to wait for the persistent
+     * buffer function to time out every time they try to close the subshell. */
+    if (use_persistent_buffer && !read_command_line_buffer (TRUE))
+        use_persistent_buffer = FALSE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1100,10 +1416,45 @@ invoke_subshell (const char *command, int how, vfs_path_t ** new_dir_vpath)
             /* FIXME: possibly take out this hack; the user can re-play it by hitting C-hyphen a few times! */
             if (subshell_ready && mc_global.mc_run_mode == MC_RUN_FULL)
                 write_all (mc_global.tty.subshell_pty, " \b", 2);       /* Hack to make prompt reappear */
+
+            if (use_persistent_buffer)
+            {
+                size_t i;
+                int pos;
+
+                /* Check to make sure there are no non text characters in the command buffer,
+                 * such as tab, or newline, as this could cause problems. */
+                for (i = 0; cmdline->buffer[i] != '\0'; i++)
+                    if ((unsigned char) cmdline->buffer[i] < 32
+                        || (unsigned char) cmdline->buffer[i] == 127)
+                        cmdline->buffer[i] = ' ';
+
+                /* Write the command buffer to the subshell. */
+                write_all (mc_global.tty.subshell_pty, cmdline->buffer, strlen (cmdline->buffer));
+
+                /* Put the cursor in the correct place in the subshell. */
+                pos = str_length (cmdline->buffer) - cmdline->point;
+                for (i = 0; i < (size_t) pos; i++)
+                    write_all (mc_global.tty.subshell_pty, ESC_STR "[D", 3);
+            }
         }
     }
     else                        /* MC has passed us a user command */
     {
+        /* Before we write to the command prompt, we need to clear whatever */
+        /* data is there, but only if we are using one of the shells that */
+        /* doesn't support keeping command buffer contents, OR if there was */
+        /* some sort of error. */
+        if (!use_persistent_buffer || subshell_should_clear_command_line)
+        {
+            write_all (mc_global.tty.subshell_pty, "\003", 1);
+            subshell_state = RUNNING_COMMAND;
+            /* We need to call feed_subshell here if we are using fish, because of a quirk
+             * in the behavioral of that particular shell. */
+            if (mc_global.shell->type != SHELL_FISH)
+                feed_subshell (QUIETLY, FALSE);
+        }
+
         if (how == QUIETLY)
             write_all (mc_global.tty.subshell_pty, " ", 1);
         /* FIXME: if command is long (>8KB ?) we go comma */
@@ -1131,6 +1482,50 @@ invoke_subshell (const char *command, int how, vfs_path_t ** new_dir_vpath)
     return subshell_get_mainloop_quit ();
 }
 
+/* --------------------------------------------------------------------------------------------- */
+
+gboolean
+flush_subshell (int max_wait_length, int how)
+{
+    int rc = 0;
+    ssize_t bytes = 0;
+    struct timeval timeleft = { 0, 0 };
+    gboolean return_value = FALSE;
+    fd_set tmp;
+
+    timeleft.tv_sec = max_wait_length;
+    FD_ZERO (&tmp);
+    FD_SET (mc_global.tty.subshell_pty, &tmp);
+
+    while (subshell_alive
+           && (rc = select (mc_global.tty.subshell_pty + 1, &tmp, NULL, NULL, &timeleft)) != 0)
+    {
+        /* Check for 'select' errors */
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+            {
+                if (tty_got_winch ())
+                    tty_change_screen_size ();
+
+                continue;
+            }
+
+            fprintf (stderr, "select (FD_SETSIZE, &tmp...): %s\r\n", unix_error_string (errno));
+            exit (EXIT_FAILURE);
+        }
+
+        return_value = TRUE;
+        timeleft.tv_sec = 0;
+        timeleft.tv_usec = 0;
+
+        bytes = read (mc_global.tty.subshell_pty, pty_buffer, sizeof (pty_buffer));
+        if (how == VISIBLY)
+            write_all (STDOUT_FILENO, pty_buffer, bytes);
+    }
+
+    return return_value;
+}
 
 /* --------------------------------------------------------------------------------------------- */
 
@@ -1140,24 +1535,16 @@ read_subshell_prompt (void)
     int rc = 0;
     ssize_t bytes = 0;
     struct timeval timeleft = { 0, 0 };
-    GString *p;
-    gboolean prompt_was_reset = FALSE;
+    gboolean should_reset_prompt = TRUE;
+    gboolean got_new_prompt = FALSE;
 
     fd_set tmp;
     FD_ZERO (&tmp);
     FD_SET (mc_global.tty.subshell_pty, &tmp);
 
-    /* First time through */
-    if (subshell_prompt == NULL)
-        subshell_prompt = g_string_sized_new (INITIAL_PROMPT_SIZE);
-
-    p = g_string_sized_new (INITIAL_PROMPT_SIZE);
-
     while (subshell_alive
            && (rc = select (mc_global.tty.subshell_pty + 1, &tmp, NULL, NULL, &timeleft)) != 0)
     {
-        ssize_t i;
-
         /* Check for 'select' errors */
         if (rc == -1)
         {
@@ -1174,22 +1561,18 @@ read_subshell_prompt (void)
         }
 
         bytes = read (mc_global.tty.subshell_pty, pty_buffer, sizeof (pty_buffer));
+        if (should_reset_prompt)
+        {
+            should_reset_prompt = FALSE;
+            clear_subshell_prompt_string ();
+        }
 
-        /* Extract the prompt from the shell output */
-        for (i = 0; i < bytes; i++)
-            if (pty_buffer[i] == '\n' || pty_buffer[i] == '\r')
-            {
-                g_string_set_size (p, 0);
-                prompt_was_reset = TRUE;
-            }
-            else if (pty_buffer[i] != '\0')
-                g_string_append_c (p, pty_buffer[i]);
+        parse_subshell_prompt_string (pty_buffer, bytes);
+        got_new_prompt = TRUE;
     }
 
-    if (p->len != 0 || prompt_was_reset)
-        g_string_assign (subshell_prompt, p->str);
-
-    g_string_free (p, TRUE);
+    if (got_new_prompt)
+        set_prompt_string ();
 
     return (rc != 0 || bytes != 0);
 }
@@ -1229,8 +1612,18 @@ exit_subshell (void)
                          tcsh_fifo, unix_error_string (errno));
         }
 
-        g_string_free (subshell_prompt, TRUE);
-        subshell_prompt = NULL;
+        if (subshell_prompt != NULL)
+        {
+            g_string_free (subshell_prompt, TRUE);
+            subshell_prompt = NULL;
+        }
+
+        if (subshell_prompt_temp_buffer != NULL)
+        {
+            g_string_free (subshell_prompt_temp_buffer, TRUE);
+            subshell_prompt_temp_buffer = NULL;
+        }
+
         pty_buffer[0] = '\0';
     }
 
@@ -1259,6 +1652,15 @@ do_subshell_chdir (const vfs_path_t * vpath, gboolean update_prompt)
         return;
     }
 
+    /* If we are using a shell that doesn't support persistent command buffer, we need to clear
+     * the command prompt before we send the cd command. */
+    if (!use_persistent_buffer || subshell_should_clear_command_line)
+    {
+        write_all (mc_global.tty.subshell_pty, "\003", 1);
+        subshell_state = RUNNING_COMMAND;
+        if (mc_global.shell->type != SHELL_FISH)
+            feed_subshell (QUIETLY, FALSE);
+    }
     /* The initial space keeps this out of the command history (in bash
        because we set "HISTCONTROL=ignorespace") */
     write_all (mc_global.tty.subshell_pty, " cd ", 4);
diff --git a/src/subshell/subshell.h b/src/subshell/subshell.h
index e0fdfb13e..bde19c469 100644
--- a/src/subshell/subshell.h
+++ b/src/subshell/subshell.h
@@ -36,10 +36,13 @@ extern GString *subshell_prompt;
 
 extern gboolean update_subshell_prompt;
 
+extern gboolean should_read_new_subshell_prompt;
+
 /*** declarations of public functions ************************************************************/
 
 void init_subshell (void);
 int invoke_subshell (const char *command, int how, vfs_path_t ** new_dir);
+gboolean flush_subshell (int max_wait_length, int how);
 gboolean read_subshell_prompt (void);
 void do_update_prompt (void);
 gboolean exit_subshell (void);
diff --git a/src/vfs/extfs/extfs.c b/src/vfs/extfs/extfs.c
index 0fcef04ba..d4042865e 100644
--- a/src/vfs/extfs/extfs.c
+++ b/src/vfs/extfs/extfs.c
@@ -373,6 +373,26 @@ extfs_free_archive (struct vfs_class *me, struct vfs_s_super *psup)
 
 /* --------------------------------------------------------------------------------------------- */
 
+static inline char *
+extfs_skip_leading_dotslash (char *s)
+{
+    /* Skip leading "./" (if present).
+     * Some programs don't understand it:
+     *
+     * $ zip file.zip ./-file2.txt file1.txt
+     *   adding: -file2.txt (stored 0%)
+     *   adding: file1.txt (stored 0%)
+     * $ /usr/lib/mc/extfs.d/uzip copyout file.zip ./-file2.txt ./tmp-file2.txt
+     * caution: filename not matched:  ./-file2.txt
+     */
+    if (s[0] == '.' && s[1] == PATH_SEP)
+        s += 2;
+
+    return s;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 static FILE *
 extfs_open_archive (int fstype, const char *name, struct extfs_super_t **pparc)
 {
@@ -486,6 +506,7 @@ extfs_read_archive (FILE * extfsd, struct extfs_super_t *current_archive)
 
             if (*cfn != '\0')
             {
+                cfn = extfs_skip_leading_dotslash (cfn);
                 if (IS_PATH_SEP (*cfn))
                     cfn++;
                 p = strchr (cfn, '\0');
@@ -812,13 +833,16 @@ extfs_cmd (const char *str_extfs_cmd, const struct extfs_super_t *archive,
     quoted_file = name_quote (file, FALSE);
     g_free (file);
 
+    /* Skip leading "./" (if present) added in name_quote() */
+    file = extfs_skip_leading_dotslash (quoted_file);
+
     archive_name = extfs_get_archive_name (archive);
     quoted_archive_name = name_quote (archive_name, FALSE);
     g_free (archive_name);
     quoted_localname = name_quote (localname, FALSE);
     info = &g_array_index (extfs_plugins, extfs_plugin_info_t, archive->fstype);
     cmd = g_strconcat (info->path, info->prefix, str_extfs_cmd,
-                       quoted_archive_name, " ", quoted_file, " ", quoted_localname, (char *) NULL);
+                       quoted_archive_name, " ", file, " ", quoted_localname, (char *) NULL);
     g_free (quoted_file);
     g_free (quoted_localname);
     g_free (quoted_archive_name);
@@ -1023,20 +1047,20 @@ extfs_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 extfs_readdir (void *data)
 {
-    static union vfs_dirent dir;
+    struct vfs_dirent *dir;
     GList **info = (GList **) data;
 
     if (*info == NULL)
         return NULL;
 
-    g_strlcpy (dir.dent.d_name, VFS_ENTRY ((*info)->data)->name, MC_MAXPATHLEN);
+    dir = vfs_dirent_init (NULL, VFS_ENTRY ((*info)->data)->name, 0);   /* FIXME: inode */
 
     *info = g_list_next (*info);
 
-    return (void *) &dir;
+    return dir;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/extfs/helpers/Makefile.am b/src/vfs/extfs/helpers/Makefile.am
index ff8116d80..f1ea0acc3 100644
--- a/src/vfs/extfs/helpers/Makefile.am
+++ b/src/vfs/extfs/helpers/Makefile.am
@@ -31,7 +31,9 @@ EXTFS_IN    = 			\
 	uha.in			\
 	ulha.in			\
 	ulib.in			\
+	unar.in			\
 	urar.in			\
+	uwim.in			\
 	uzip.in			\
 	uzoo.in
 
@@ -60,7 +62,9 @@ EXTFS_OUT = 			\
 	uha			\
 	ulha			\
 	ulib			\
+	unar			\
 	urar			\
+	uwim			\
 	uzip			\
 	uzoo
 
diff --git a/src/vfs/extfs/helpers/README.extfs b/src/vfs/extfs/helpers/README.extfs
index 22ac8dfbb..ce7d0867c 100644
--- a/src/vfs/extfs/helpers/README.extfs
+++ b/src/vfs/extfs/helpers/README.extfs
@@ -73,3 +73,6 @@ patchsetfs - list of patches of current file
 
 # Gputils lib archives.
 ulib
+
+# PAK Archive
+unar
diff --git a/src/vfs/extfs/helpers/iso9660.in b/src/vfs/extfs/helpers/iso9660.in
index f9c6e50ef..f1124a5a1 100644
--- a/src/vfs/extfs/helpers/iso9660.in
+++ b/src/vfs/extfs/helpers/iso9660.in
@@ -43,7 +43,7 @@ xorriso_list() {
     r=$?
     test $r -gt 0 && return $r
 
-    echo "$lsl" | @GREP@ "^[-d]" | \
+    echo "$lsl" | grep "^[-d]" | \
     while read attr ln usr gr sz dt1 dt2 dt3 nm ; do
         len=$((${#nm} - 1))
         name=$(printf -- "$nm" | cut -c2-$len)  # remove quotes
@@ -97,11 +97,11 @@ test_iso () {
 
     CHARSET=$(locale charmap 2>/dev/null)
     if test -z "$CHARSET"; then
-        CHARSET=$(locale 2>/dev/null | @GREP@ LC_CTYPE | sed -n -e 's/.*\.\(.*\)"$/\1/p')
+        CHARSET=$(locale 2>/dev/null | grep LC_CTYPE | sed -n -e 's/.*\.\(.*\)"$/\1/p')
     fi
     if test -n "$CHARSET"; then
         CHARSET=$(echo "$CHARSET" | tr '[A-Z]' '[a-z]' | sed -e 's/^iso-/iso/')
-        isoinfo -j $CHARSET -i /dev/null 2>&1 | @GREP@ "Iconv not yet supported\|Unknown charset" >/dev/null && CHARSET=
+        isoinfo -j $CHARSET -i /dev/null 2>&1 | grep "Iconv not yet supported\|Unknown charset" >/dev/null && CHARSET=
     fi
     if test -n "$CHARSET"; then
         JOLIET_OPT="-j $CHARSET -J"
@@ -112,10 +112,10 @@ test_iso () {
 
     ISOINFO_D_I="$(isoinfo -d -i "$1" 2>/dev/null)"
 
-    echo "$ISOINFO_D_I" | @GREP@ "UCS level 1\|NO Joliet" > /dev/null || ISOINFO="$ISOINFO $JOLIET_OPT"
+    echo "$ISOINFO_D_I" | grep "UCS level 1\|NO Joliet" > /dev/null || ISOINFO="$ISOINFO $JOLIET_OPT"
 
-    if [ $(echo "$ISOINFO_D_I" | @GREP@ "Joliet with UCS level 3 found" | wc -l) = 1 \
-        -a $(echo "$ISOINFO_D_I" | @GREP@ "NO Rock Ridge" | wc -l) = 1 ] ; then
+    if [ $(echo "$ISOINFO_D_I" | grep "Joliet with UCS level 3 found" | wc -l) = 1 \
+        -a $(echo "$ISOINFO_D_I" | grep "NO Rock Ridge" | wc -l) = 1 ] ; then
         SEMICOLON="YES"
     fi
 }
diff --git a/src/vfs/extfs/helpers/unar.in b/src/vfs/extfs/helpers/unar.in
new file mode 100644
index 000000000..e81030733
diff --git a/src/vfs/extfs/helpers/urar.in b/src/vfs/extfs/helpers/urar.in
index 6742ac519..5453d3195 100644
--- a/src/vfs/extfs/helpers/urar.in
+++ b/src/vfs/extfs/helpers/urar.in
@@ -47,7 +47,7 @@ flag==1 {
     else
 	if (index($6, ".") != 0)
 	    $6="-rw-r--r--"
-    printf "%s 1 %s %s %d %02d/%02d/%02d %s %s\n", $6, uid, gid, $1, a[2], a[1], a[3], $5, str
+    printf "%s 1 %s %s %d %02d/%02d/%02d %s ./%s\n", $6, uid, gid, $1, a[2], a[1], a[3], $5, str
 }'
 }
 
@@ -105,7 +105,7 @@ mcrar5fs_list ()
         }
 
         ### and finally
-        printf ("%s 1 %s %s %d %02d/%02d/%02d %s %s\n",
+        printf ("%s 1 %s %s %d %02d/%02d/%02d %s ./%s\n",
                 attrs, uid, gid, size, date[2], date[3], date[1], time, name);
     }
 '
diff --git a/src/vfs/extfs/helpers/uwim.in b/src/vfs/extfs/helpers/uwim.in
new file mode 100644
index 000000000..bfaf22ee8
diff --git a/src/vfs/extfs/helpers/uzip.in b/src/vfs/extfs/helpers/uzip.in
index 22466db51..c468f3a9d 100644
--- a/src/vfs/extfs/helpers/uzip.in
+++ b/src/vfs/extfs/helpers/uzip.in
@@ -352,7 +352,7 @@ sub print_file {
 	if ($platform eq 'unx' && $filename =~ /\/$/ && $perms =~ /^\?(.*)$/) {
 		$perms = 'd'.$1;
 	}
-	printf "%-10s    1 %-8d %-8d %8s %s/%s/%s %s:%s:%s %s", $perms, $<,
+	printf "%-10s    1 %-8d %-8d %8s %s/%s/%s %s:%s:%s ./%s", $perms, $<,
 		$(, $realsize, $mon, $day, $year, $hours, $mins, $secs, $filename;
 	if ($platform eq 'unx' && $perms =~ /^l/) {
 		my $linkdest = &get_link_destination($filename);
diff --git a/src/vfs/fish/fish.c b/src/vfs/fish/fish.c
index 5cd279f95..8f8f59543 100644
--- a/src/vfs/fish/fish.c
+++ b/src/vfs/fish/fish.c
@@ -65,7 +65,6 @@
 #include "lib/fileloc.h"
 #include "lib/util.h"           /* my_exit() */
 #include "lib/mcconfig.h"
-#include "lib/timer.h"
 
 #include "src/execute.h"        /* pre_exec, post_exec */
 
@@ -766,7 +765,7 @@ fish_dir_load (struct vfs_class *me, struct vfs_s_inode *dir, char *remote_path)
 
     vfs_print_message (_("fish: Reading directory %s..."), remote_path);
 
-    dir->timestamp = mc_timer_elapsed (mc_global.timer) + fish_directory_timeout * G_USEC_PER_SEC;
+    dir->timestamp = g_get_real_time () + fish_directory_timeout * G_USEC_PER_SEC;
 
     quoted_path = strutils_shell_escape (remote_path);
     (void) fish_command_v (me, super, NONE, FISH_SUPER (super)->scr_ls, "FISH_FILENAME=%s;\n",
diff --git a/src/vfs/ftpfs/ftpfs.c b/src/vfs/ftpfs/ftpfs.c
index 8a841ac1a..4c02ba409 100644
--- a/src/vfs/ftpfs/ftpfs.c
+++ b/src/vfs/ftpfs/ftpfs.c
@@ -98,7 +98,6 @@ What to do with this?
 #include "lib/util.h"
 #include "lib/strutil.h"        /* str_move() */
 #include "lib/mcconfig.h"
-#include "lib/timer.h"
 
 #include "lib/tty/tty.h"        /* enable/disable interrupt key */
 #include "lib/widget.h"         /* message() */
@@ -1491,17 +1490,17 @@ ftpfs_linear_abort (struct vfs_class *me, vfs_file_handler_t * fh)
 
         if (select (dsock + 1, &mask, NULL, NULL, NULL) > 0)
         {
-            guint64 start_tim;
+            gint64 start_tim;
             char buf[BUF_8K];
 
-            start_tim = mc_timer_elapsed (mc_global.timer);
+            start_tim = g_get_real_time ();
 
             /* flush the remaining data */
             while (read (dsock, buf, sizeof (buf)) > 0)
             {
-                guint64 tim;
+                gint64 tim;
 
-                tim = mc_timer_elapsed (mc_global.timer);
+                tim = g_get_real_time ();
 
                 if (tim > start_tim + ABORT_TIMEOUT)
                 {
@@ -1748,7 +1747,7 @@ ftpfs_dir_load (struct vfs_class *me, struct vfs_s_inode *dir, char *remote_path
         return (-1);
     }
 
-    dir->timestamp = mc_timer_elapsed (mc_global.timer) + ftpfs_directory_timeout * G_USEC_PER_SEC;
+    dir->timestamp = g_get_real_time () + ftpfs_directory_timeout * G_USEC_PER_SEC;
 
     if (ftp_super->strict == RFC_STRICT)
         sock = ftpfs_open_data_connection (me, super, "LIST", 0, TYPE_ASCII, 0);
diff --git a/src/vfs/local/local.c b/src/vfs/local/local.c
index 717868ad4..cc9fd7a0d 100644
--- a/src/vfs/local/local.c
+++ b/src/vfs/local/local.c
@@ -103,10 +103,14 @@ local_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 local_readdir (void *data)
 {
-    return readdir (*(DIR **) data);
+    struct dirent *d;
+
+    d = readdir (*(DIR **) data);
+
+    return (d != NULL ? vfs_dirent_init (NULL, d->d_name, d->d_ino) : NULL);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/sftpfs/dir.c b/src/vfs/sftpfs/dir.c
index 67b7f29ee..63a397f39 100644
--- a/src/vfs/sftpfs/dir.c
+++ b/src/vfs/sftpfs/dir.c
@@ -115,13 +115,12 @@ sftpfs_opendir (const vfs_path_t * vpath, GError ** mcerror)
  * @return information about direntry if success, NULL otherwise
  */
 
-void *
+struct vfs_dirent *
 sftpfs_readdir (void *data, GError ** mcerror)
 {
     char mem[BUF_MEDIUM];
     LIBSSH2_SFTP_ATTRIBUTES attrs;
     sftpfs_dir_data_t *sftpfs_dir = (sftpfs_dir_data_t *) data;
-    static union vfs_dirent sftpfs_dirent;
     int rc;
 
     mc_return_val_if_error (mcerror, NULL);
@@ -137,11 +136,7 @@ sftpfs_readdir (void *data, GError ** mcerror)
     }
     while (rc == LIBSSH2_ERROR_EAGAIN);
 
-    if (rc == 0)
-        return NULL;
-
-    g_strlcpy (sftpfs_dirent.dent.d_name, mem, BUF_MEDIUM);
-    return &sftpfs_dirent;
+    return (rc != 0 ? vfs_dirent_init (NULL, mem, 0) : NULL);   /* FIXME: inode */
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/sftpfs/internal.h b/src/vfs/sftpfs/internal.h
index 84b9d523e..d2398c4ed 100644
--- a/src/vfs/sftpfs/internal.h
+++ b/src/vfs/sftpfs/internal.h
@@ -91,7 +91,7 @@ void sftpfs_close_connection (struct vfs_s_super *super, const char *shutdown_me
 vfs_file_handler_t *sftpfs_fh_new (struct vfs_s_inode *ino, gboolean changed);
 
 void *sftpfs_opendir (const vfs_path_t * vpath, GError ** mcerror);
-void *sftpfs_readdir (void *data, GError ** mcerror);
+struct vfs_dirent *sftpfs_readdir (void *data, GError ** mcerror);
 int sftpfs_closedir (void *data, GError ** mcerror);
 int sftpfs_mkdir (const vfs_path_t * vpath, mode_t mode, GError ** mcerror);
 int sftpfs_rmdir (const vfs_path_t * vpath, GError ** mcerror);
diff --git a/src/vfs/sftpfs/vfs_class.c b/src/vfs/sftpfs/vfs_class.c
index 712cc1936..66be5ed4d 100644
--- a/src/vfs/sftpfs/vfs_class.c
+++ b/src/vfs/sftpfs/vfs_class.c
@@ -188,11 +188,11 @@ sftpfs_cb_opendir (const vfs_path_t * vpath)
  * @return information about direntry if success, NULL otherwise
  */
 
-static void *
+static struct vfs_dirent *
 sftpfs_cb_readdir (void *data)
 {
     GError *mcerror = NULL;
-    union vfs_dirent *sftpfs_dirent;
+    struct vfs_dirent *sftpfs_dirent;
 
     if (tty_got_interrupt ())
     {
@@ -204,7 +204,7 @@ sftpfs_cb_readdir (void *data)
     if (!mc_error_message (&mcerror, NULL))
     {
         if (sftpfs_dirent != NULL)
-            vfs_print_message (_("sftp: (Ctrl-G break) Listing... %s"), sftpfs_dirent->dent.d_name);
+            vfs_print_message (_("sftp: (Ctrl-G break) Listing... %s"), sftpfs_dirent->d_name);
         else
             vfs_print_message ("%s", _("sftp: Listing done."));
     }
diff --git a/src/vfs/smbfs/helpers/include/includes.h b/src/vfs/smbfs/helpers/include/includes.h
index 9cce9309d..b7bb9bce6 100644
--- a/src/vfs/smbfs/helpers/include/includes.h
+++ b/src/vfs/smbfs/helpers/include/includes.h
@@ -189,7 +189,7 @@
 #include <sys/fs/s5param.h>
 #endif
 
-#if defined (HAVE_SYS_FILSYS_H) && !defined (_CRAY)
+#ifdef HAVE_SYS_FILSYS_H
 #include <sys/filsys.h>
 #endif
 
diff --git a/src/vfs/smbfs/smbfs.c b/src/vfs/smbfs/smbfs.c
index e91a18fbd..841e4c430 100644
--- a/src/vfs/smbfs/smbfs.c
+++ b/src/vfs/smbfs/smbfs.c
@@ -915,11 +915,10 @@ smbfs_free_dir (dir_entry * de)
 /* It's too slow to ask the server each time */
 /* It now also sends the complete lstat information for each file */
 
-static void *
+static struct vfs_dirent *
 smbfs_readdir (void *info)
 {
-    static union vfs_dirent smbfs_readdir_data;
-    static char *const dirent_dest = smbfs_readdir_data.dent.d_name;
+    struct vfs_dirent *dirent;
     opendir_info *smbfs_info = (opendir_info *) info;
 
     DEBUG (4, ("smbfs_readdir(%s)\n", smbfs_info->dirname));
@@ -937,10 +936,12 @@ smbfs_readdir (void *info)
 #endif
         return NULL;
     }
-    g_strlcpy (dirent_dest, smbfs_info->current->text, MC_MAXPATHLEN);
+
+    dirent = vfs_dirent_init (NULL, smbfs_info->current->text, 0);      /* FIXME: inode */
+
     smbfs_info->current = smbfs_info->current->next;
 
-    return &smbfs_readdir_data;
+    return dirent;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/vfs/undelfs/undelfs.c b/src/vfs/undelfs/undelfs.c
index 6e8a0685c..de1994363 100644
--- a/src/vfs/undelfs/undelfs.c
+++ b/src/vfs/undelfs/undelfs.c
@@ -400,11 +400,10 @@ undelfs_opendir (const vfs_path_t * vpath)
 
 /* --------------------------------------------------------------------------------------------- */
 
-static void *
+static struct vfs_dirent *
 undelfs_readdir (void *vfs_info)
 {
-    static union vfs_dirent undelfs_readdir_data;
-    static char *const dirent_dest = undelfs_readdir_data.dent.d_name;
+    struct vfs_dirent *dirent;
 
     if (vfs_info != fs)
     {
@@ -414,13 +413,18 @@ undelfs_readdir (void *vfs_info)
     if (readdir_ptr == num_delarray)
         return NULL;
     if (readdir_ptr < 0)
-        strcpy (dirent_dest, readdir_ptr == -2 ? "." : "..");
+        dirent = vfs_dirent_init (NULL, readdir_ptr == -2 ? "." : "..", 0);     /* FIXME: inode */
     else
+    {
+        char dirent_dest[MC_MAXPATHLEN];
+
         g_snprintf (dirent_dest, MC_MAXPATHLEN, "%ld:%d",
                     (long) delarray[readdir_ptr].ino, delarray[readdir_ptr].num_blocks);
+        dirent = vfs_dirent_init (NULL, dirent_dest, 0);        /* FIXME: inode */
+    }
     readdir_ptr++;
 
-    return &undelfs_readdir_data;
+    return dirent;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/viewer/ascii.c b/src/viewer/ascii.c
index 67b653434..e2a3ce934 100644
--- a/src/viewer/ascii.c
+++ b/src/viewer/ascii.c
@@ -162,12 +162,6 @@
 
 /*** file scope macro definitions ****************************************************************/
 
-#if GLIB_CHECK_VERSION (2, 30, 0)
-#define SPACING_MARK G_UNICODE_SPACING_MARK
-#else
-#define SPACING_MARK G_UNICODE_COMBINING_MARK
-#endif
-
 /* The Unicode standard recommends that lonely combining characters are printed over a dotted
  * circle. If the terminal is not UTF-8, this will be replaced by a dot anyway. */
 #define BASE_CHARACTER_FOR_LONELY_COMBINING 0x25CC      /* dotted circle */
@@ -266,7 +260,7 @@ mcview_is_spacing_mark (const WView * view, int c)
 {
 #ifdef HAVE_CHARSET
     if (view->utf8)
-        return g_unichar_type (c) == SPACING_MARK;
+        return g_unichar_type (c) == G_UNICODE_SPACING_MARK;
 #else
     (void) view;
     (void) c;
@@ -535,7 +529,7 @@ mcview_next_combining_char_sequence (WView * view, mcview_state_machine_t * stat
             return i;
         if (!mcview_ismark (view, cs[i]) || !mcview_isprint (view, cs[i]))
             return i;
-        if (g_unichar_type (cs[i]) == SPACING_MARK)
+        if (g_unichar_type (cs[i]) == G_UNICODE_SPACING_MARK)
         {
             /* Only allow as the first combining char. Stop processing in either case. */
             if (i == 1)
diff --git a/tests/lib/mc_realpath.c b/tests/lib/mc_realpath.c
index 17f7c2fff..31415ac85 100644
--- a/tests/lib/mc_realpath.c
+++ b/tests/lib/mc_realpath.c
@@ -43,7 +43,6 @@ static char resolved_path[PATH_MAX];
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
     vfs_init ();
     vfs_init_localfs ();
@@ -56,7 +55,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/mcconfig/config_string.c b/tests/lib/mcconfig/config_string.c
index b000f1954..da479de59 100644
--- a/tests/lib/mcconfig/config_string.c
+++ b/tests/lib/mcconfig/config_string.c
@@ -79,7 +79,6 @@ config_object__deinit (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings ("KOI8-R");
     vfs_init ();
     vfs_init_localfs ();
@@ -97,7 +96,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/mcconfig/user_configs_path.c b/tests/lib/mcconfig/user_configs_path.c
index b3e06ab17..75e483e7f 100644
--- a/tests/lib/mcconfig/user_configs_path.c
+++ b/tests/lib/mcconfig/user_configs_path.c
@@ -59,7 +59,6 @@ setup (void)
     g_setenv ("XDG_DATA_HOME", CONF_DATA, TRUE);
     g_setenv ("XDG_CACHE_HOME", CONF_CACHE, TRUE);
 #endif
-    mc_global.timer = mc_timer_new ();
     str_init_strings ("UTF-8");
     vfs_init ();
     vfs_init_localfs ();
@@ -73,7 +72,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/canonicalize_pathname.c b/tests/lib/vfs/canonicalize_pathname.c
index f070fa039..6364a404b 100644
--- a/tests/lib/vfs/canonicalize_pathname.c
+++ b/tests/lib/vfs/canonicalize_pathname.c
@@ -45,7 +45,6 @@ static struct vfs_class vfs_test_ops;
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -74,7 +73,6 @@ teardown (void)
     vfs_shut ();
 
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/current_dir.c b/tests/lib/vfs/current_dir.c
index 1cb8a710e..398fc5440 100644
--- a/tests/lib/vfs/current_dir.c
+++ b/tests/lib/vfs/current_dir.c
@@ -55,7 +55,6 @@ test_chdir (const vfs_path_t * vpath)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -75,7 +74,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/path_cmp.c b/tests/lib/vfs/path_cmp.c
index 76be13bc8..0e19566c7 100644
--- a/tests/lib/vfs/path_cmp.c
+++ b/tests/lib/vfs/path_cmp.c
@@ -42,7 +42,6 @@
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -67,7 +66,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/path_len.c b/tests/lib/vfs/path_len.c
index f9f40fa66..e68176dbc 100644
--- a/tests/lib/vfs/path_len.c
+++ b/tests/lib/vfs/path_len.c
@@ -42,7 +42,6 @@
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -67,7 +66,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/path_manipulations.c b/tests/lib/vfs/path_manipulations.c
index 9bbdd8ae6..45f31e1f2 100644
--- a/tests/lib/vfs/path_manipulations.c
+++ b/tests/lib/vfs/path_manipulations.c
@@ -60,7 +60,6 @@ init_test_classes (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -87,7 +86,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/path_recode.c b/tests/lib/vfs/path_recode.c
index 1a832e7b5..f53094a3b 100644
--- a/tests/lib/vfs/path_recode.c
+++ b/tests/lib/vfs/path_recode.c
@@ -65,7 +65,6 @@ teardown (void)
 static void
 test_init_vfs (const char *encoding)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (encoding);
 
     vfs_init ();
@@ -86,7 +85,6 @@ test_deinit_vfs (void)
     free_codepages_list ();
     str_uninit_strings ();
     vfs_shut ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/path_serialize.c b/tests/lib/vfs/path_serialize.c
index 0bd26f82a..8ae2c830b 100644
--- a/tests/lib/vfs/path_serialize.c
+++ b/tests/lib/vfs/path_serialize.c
@@ -45,7 +45,6 @@ static struct vfs_class vfs_test_ops1, vfs_test_ops2, vfs_test_ops3;
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -79,7 +78,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/relative_cd.c b/tests/lib/vfs/relative_cd.c
index dd131302f..bf5d62319 100644
--- a/tests/lib/vfs/relative_cd.c
+++ b/tests/lib/vfs/relative_cd.c
@@ -73,7 +73,6 @@ test_chdir__deinit (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -102,7 +101,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/tempdir.c b/tests/lib/vfs/tempdir.c
index eaefa5fd1..8c5f3b359 100644
--- a/tests/lib/vfs/tempdir.c
+++ b/tests/lib/vfs/tempdir.c
@@ -45,7 +45,6 @@
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -61,7 +60,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/vfs_parse_ls_lga.c b/tests/lib/vfs/vfs_parse_ls_lga.c
index 0847cc921..b1b203af5 100644
--- a/tests/lib/vfs/vfs_parse_ls_lga.c
+++ b/tests/lib/vfs/vfs_parse_ls_lga.c
@@ -55,7 +55,6 @@ setup (void)
 {
     static struct stat initstat;
 
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -81,7 +80,6 @@ teardown (void)
     vfs_s_free_entry (vfs_test_ops1, vfs_root_entry);
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/vfs_path_from_str_flags.c b/tests/lib/vfs/vfs_path_from_str_flags.c
index de1a16472..5700c7f03 100644
--- a/tests/lib/vfs/vfs_path_from_str_flags.c
+++ b/tests/lib/vfs/vfs_path_from_str_flags.c
@@ -46,7 +46,6 @@ mc_config_get_home_dir (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -62,7 +61,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/vfs_path_string_convert.c b/tests/lib/vfs/vfs_path_string_convert.c
index b081120c1..3c32471a5 100644
--- a/tests/lib/vfs/vfs_path_string_convert.c
+++ b/tests/lib/vfs/vfs_path_string_convert.c
@@ -48,7 +48,6 @@ static struct vfs_class vfs_test_ops1, vfs_test_ops2, vfs_test_ops3;
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -82,7 +81,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/vfs_prefix_to_class.c b/tests/lib/vfs/vfs_prefix_to_class.c
index 2a78a4171..5c7d79723 100644
--- a/tests/lib/vfs/vfs_prefix_to_class.c
+++ b/tests/lib/vfs/vfs_prefix_to_class.c
@@ -55,7 +55,6 @@ test_which (struct vfs_class *me, const char *path)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -81,7 +80,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/vfs_s_get_path.c b/tests/lib/vfs/vfs_s_get_path.c
index 44eea436c..0aa0037b2 100644
--- a/tests/lib/vfs/vfs_s_get_path.c
+++ b/tests/lib/vfs/vfs_s_get_path.c
@@ -82,7 +82,6 @@ test1_mock_archive_same (const vfs_path_element_t * vpath_element, struct vfs_s_
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -110,7 +109,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 
diff --git a/tests/lib/vfs/vfs_setup_cwd.c b/tests/lib/vfs/vfs_setup_cwd.c
index abbaf4372..3d408f028 100644
--- a/tests/lib/vfs/vfs_setup_cwd.c
+++ b/tests/lib/vfs/vfs_setup_cwd.c
@@ -76,7 +76,6 @@ mc_stat (const vfs_path_t * vpath, struct stat *my_stat)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -92,7 +91,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/lib/vfs/vfs_split.c b/tests/lib/vfs/vfs_split.c
index b0474e29a..289dbebf8 100644
--- a/tests/lib/vfs/vfs_split.c
+++ b/tests/lib/vfs/vfs_split.c
@@ -41,7 +41,6 @@ static struct vfs_class vfs_test_ops1, vfs_test_ops2, vfs_test_ops3;
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -66,7 +65,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/editor/editcmd__edit_complete_word_cmd.c b/tests/src/editor/editcmd__edit_complete_word_cmd.c
index 85f430cf8..37f933407 100644
--- a/tests/src/editor/editcmd__edit_complete_word_cmd.c
+++ b/tests/src/editor/editcmd__edit_complete_word_cmd.c
@@ -29,7 +29,6 @@
 
 #include <ctype.h>
 
-#include "lib/timer.h"
 #ifdef HAVE_CHARSET
 #include "lib/charsets.h"
 #endif
@@ -152,7 +151,6 @@ editcmd_dialog_completion_show__deinit (void)
 static void
 my_setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -187,7 +185,6 @@ my_teardown (void)
     vfs_shut ();
 
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/execute__common.c b/tests/src/execute__common.c
index 4920ed718..d0ffa83df 100644
--- a/tests/src/execute__common.c
+++ b/tests/src/execute__common.c
@@ -238,7 +238,6 @@ mc_ungetlocalcopy__deinit (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
     vfs_init ();
     vfs_init_localfs ();
@@ -267,7 +266,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/execute__execute_get_external_cmd_opts_from_config.c b/tests/src/execute__execute_get_external_cmd_opts_from_config.c
index 01fb3405d..379717d22 100644
--- a/tests/src/execute__execute_get_external_cmd_opts_from_config.c
+++ b/tests/src/execute__execute_get_external_cmd_opts_from_config.c
@@ -95,7 +95,6 @@ mc_config_get_string__deinit (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
     vfs_init ();
     vfs_init_localfs ();
@@ -114,7 +113,6 @@ teardown (void)
 
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/filemanager/do_cd_command.c b/tests/src/filemanager/do_cd_command.c
index a55380eb8..8cc36ce0b 100644
--- a/tests/src/filemanager/do_cd_command.c
+++ b/tests/src/filemanager/do_cd_command.c
@@ -80,7 +80,6 @@ mc_config_get_home_dir (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -98,7 +97,6 @@ teardown (void)
     vfs_path_free (do_cd__new_dir_vpath__captured);
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/filemanager/exec_get_export_variables_ext.c b/tests/src/filemanager/exec_get_export_variables_ext.c
index a7a9d98b5..b32b3bfcb 100644
--- a/tests/src/filemanager/exec_get_export_variables_ext.c
+++ b/tests/src/filemanager/exec_get_export_variables_ext.c
@@ -42,7 +42,6 @@
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -62,7 +61,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/filemanager/filegui_is_wildcarded.c b/tests/src/filemanager/filegui_is_wildcarded.c
index c26267355..b30734ff6 100644
--- a/tests/src/filemanager/filegui_is_wildcarded.c
+++ b/tests/src/filemanager/filegui_is_wildcarded.c
@@ -38,7 +38,6 @@
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     str_init_strings (NULL);
 
     vfs_init ();
@@ -54,7 +53,6 @@ teardown (void)
 {
     vfs_shut ();
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/filemanager/get_random_hint.c b/tests/src/filemanager/get_random_hint.c
index c9a953227..85721bcf1 100644
--- a/tests/src/filemanager/get_random_hint.c
+++ b/tests/src/filemanager/get_random_hint.c
@@ -30,7 +30,6 @@
 
 #include "lib/strutil.h"
 #include "lib/util.h"
-#include "lib/timer.h"
 
 #include "src/filemanager/midnight.h"
 
@@ -62,7 +61,6 @@ rand (void)
 static void
 setup (void)
 {
-    mc_global.timer = mc_timer_new ();
     mc_global.share_data_dir = (char *) TEST_SHARE_DIR;
     str_init_strings (NULL);
 }
@@ -71,7 +69,6 @@ static void
 teardown (void)
 {
     str_uninit_strings ();
-    mc_timer_destroy (mc_global.timer);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/tests/src/vfs/extfs/helpers-list/data/urar.v4,v3.output b/tests/src/vfs/extfs/helpers-list/data/urar.v4,v3.output
index 5a162621a..95685985c 100644
--- a/tests/src/vfs/extfs/helpers-list/data/urar.v4,v3.output
+++ b/tests/src/vfs/extfs/helpers-list/data/urar.v4,v3.output
@@ -1,9 +1,9 @@
-drwx------   1  <<uid>>  <<gid>>          0 2016-06-07 20:43:00 .dosbox
--rw-rw-r--   1  <<uid>>  <<gid>>      10730 2016-06-07 20:43:00 .dosbox/dosbox-0.74.conf
--rw-------   1  <<uid>>  <<gid>>      11032 2016-11-23 07:10:00 .viminfo
--rw-rw-r--   1  <<uid>>  <<gid>>        205 2016-10-26 13:14:00 .wget-hsts
--rw-rw-r--   1  <<uid>>  <<gid>>       7527 2016-04-17 01:21:00 .xboardrc
--rw-rw-r--   1  <<uid>>  <<gid>>        559 2016-09-29 01:08:00 .xchm
--rw-rw-r--   1  <<uid>>  <<gid>>        130 2015-12-27 17:08:00 .xinputrc
--rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:39:00 filename with spaces.txt
--rw-rw-r--   1  <<uid>>  <<gid>>    5869937 2016-11-23 07:43:00 log.txt
+drwx------   1  <<uid>>  <<gid>>          0 2016-06-07 20:43:00 ./.dosbox
+-rw-rw-r--   1  <<uid>>  <<gid>>      10730 2016-06-07 20:43:00 ./.dosbox/dosbox-0.74.conf
+-rw-------   1  <<uid>>  <<gid>>      11032 2016-11-23 07:10:00 ./.viminfo
+-rw-rw-r--   1  <<uid>>  <<gid>>        205 2016-10-26 13:14:00 ./.wget-hsts
+-rw-rw-r--   1  <<uid>>  <<gid>>       7527 2016-04-17 01:21:00 ./.xboardrc
+-rw-rw-r--   1  <<uid>>  <<gid>>        559 2016-09-29 01:08:00 ./.xchm
+-rw-rw-r--   1  <<uid>>  <<gid>>        130 2015-12-27 17:08:00 ./.xinputrc
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:39:00 ./filename with spaces.txt
+-rw-rw-r--   1  <<uid>>  <<gid>>    5869937 2016-11-23 07:43:00 ./log.txt
diff --git a/tests/src/vfs/extfs/helpers-list/data/urar.v5.output b/tests/src/vfs/extfs/helpers-list/data/urar.v5.output
index 5a162621a..95685985c 100644
--- a/tests/src/vfs/extfs/helpers-list/data/urar.v5.output
+++ b/tests/src/vfs/extfs/helpers-list/data/urar.v5.output
@@ -1,9 +1,9 @@
-drwx------   1  <<uid>>  <<gid>>          0 2016-06-07 20:43:00 .dosbox
--rw-rw-r--   1  <<uid>>  <<gid>>      10730 2016-06-07 20:43:00 .dosbox/dosbox-0.74.conf
--rw-------   1  <<uid>>  <<gid>>      11032 2016-11-23 07:10:00 .viminfo
--rw-rw-r--   1  <<uid>>  <<gid>>        205 2016-10-26 13:14:00 .wget-hsts
--rw-rw-r--   1  <<uid>>  <<gid>>       7527 2016-04-17 01:21:00 .xboardrc
--rw-rw-r--   1  <<uid>>  <<gid>>        559 2016-09-29 01:08:00 .xchm
--rw-rw-r--   1  <<uid>>  <<gid>>        130 2015-12-27 17:08:00 .xinputrc
--rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:39:00 filename with spaces.txt
--rw-rw-r--   1  <<uid>>  <<gid>>    5869937 2016-11-23 07:43:00 log.txt
+drwx------   1  <<uid>>  <<gid>>          0 2016-06-07 20:43:00 ./.dosbox
+-rw-rw-r--   1  <<uid>>  <<gid>>      10730 2016-06-07 20:43:00 ./.dosbox/dosbox-0.74.conf
+-rw-------   1  <<uid>>  <<gid>>      11032 2016-11-23 07:10:00 ./.viminfo
+-rw-rw-r--   1  <<uid>>  <<gid>>        205 2016-10-26 13:14:00 ./.wget-hsts
+-rw-rw-r--   1  <<uid>>  <<gid>>       7527 2016-04-17 01:21:00 ./.xboardrc
+-rw-rw-r--   1  <<uid>>  <<gid>>        559 2016-09-29 01:08:00 ./.xchm
+-rw-rw-r--   1  <<uid>>  <<gid>>        130 2015-12-27 17:08:00 ./.xinputrc
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:39:00 ./filename with spaces.txt
+-rw-rw-r--   1  <<uid>>  <<gid>>    5869937 2016-11-23 07:43:00 ./log.txt
diff --git a/tests/src/vfs/extfs/helpers-list/data/uzip.README b/tests/src/vfs/extfs/helpers-list/data/uzip.README
index 135ec232c..01a7c1cac 100644
--- a/tests/src/vfs/extfs/helpers-list/data/uzip.README
+++ b/tests/src/vfs/extfs/helpers-list/data/uzip.README
@@ -3,6 +3,8 @@ The input files were created thus:
 
     cd ~/.gimp-2.8
     echo hello > 'filename with spaces.txt'
+    echo hello > ' filename with leading space.txt'
+    echo hello > '-filename with leading dash.txt'
     zip a.zip *
     unzip -Z -l -T a.zip > uzip.with-zipinfo.input
     unzip -qq -v a.zip > uzip.without-zipinfo--ymd.input
diff --git a/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.input b/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.input
index bcdf94e0d..568f2243b 100644
--- a/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.input
+++ b/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.input
@@ -1,5 +1,7 @@
 Archive:  a.zip
-Zip file size: 75222 bytes, number of entries: 40
+Zip file size: 75234 bytes, number of entries: 42
+-rw-r--r--  3.0 unx        6 tx        6 stor 20161123.071336 -filename with leading dash.txt
+-rw-r--r--  3.0 unx        6 tx        6 stor 20161123.071336  filename with leading space.txt
 drwxr-xr-x  3.0 unx        0 bx        0 stor 20151225.001514 brushes/
 -rw-------  3.0 unx      739 tx      164 defN 20160918.164557 colorrc
 -rw-------  3.0 unx     1863 tx      441 defN 20160918.164558 controllerrc
diff --git a/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.output b/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.output
index 1c10891f9..dcf37d0a5 100644
--- a/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.output
+++ b/tests/src/vfs/extfs/helpers-list/data/uzip.with-zipinfo.output
@@ -1,40 +1,42 @@
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 brushes/
--rw-------   1  <<uid>>  <<gid>>        739 2016-09-18 16:45:57 colorrc
--rw-------   1  <<uid>>  <<gid>>       1863 2016-09-18 16:45:58 controllerrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 curves/
--rw-------   1  <<uid>>  <<gid>>       1982 2016-09-18 16:45:57 dockrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 dynamics/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 environ/
--rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:36 filename with spaces.txt
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 fonts/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 fractalexplorer/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 gfig/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 gflare/
--rw-------   1  <<uid>>  <<gid>>        355 2016-01-08 01:10:31 gimprc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 gimpressionist/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 gradients/
--rw-r--r--   1  <<uid>>  <<gid>>        430 2015-12-25 00:15:14 gtkrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 interpreters/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 levels/
--rw-r--r--   1  <<uid>>  <<gid>>      76873 2016-09-18 16:45:58 menurc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 modules/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 palettes/
--rw-------   1  <<uid>>  <<gid>>        102 2016-09-18 16:45:59 parasiterc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 patterns/
--rw-r--r--   1  <<uid>>  <<gid>>     277486 2015-12-25 00:15:26 pluginrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 plug-ins/
--rw-rw-r--   1  <<uid>>  <<gid>>        209 2016-09-18 16:44:37 print-page-setup
--rw-rw-r--   1  <<uid>>  <<gid>>        506 2016-09-18 16:44:37 print-settings
--rw-------   1  <<uid>>  <<gid>>         62 2016-01-08 01:08:13 profilerc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 scripts/
--rw-------   1  <<uid>>  <<gid>>       2370 2016-09-18 16:45:57 sessionrc
--rw-rw-r--   1  <<uid>>  <<gid>>      34747 2016-09-18 16:45:59 tags.xml
--rw-------   1  <<uid>>  <<gid>>       4817 2016-09-18 16:45:59 templaterc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 templates/
--rw-rw-r--   1  <<uid>>  <<gid>>        310 2016-09-18 16:42:04 themerc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 themes/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 tmp/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2016-04-03 00:07:39 tool-options/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 tool-presets/
--rw-------   1  <<uid>>  <<gid>>       3996 2016-09-18 16:45:58 toolrc
--rw-------   1  <<uid>>  <<gid>>       1178 2016-09-18 16:45:59 unitrc
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:36 ./-filename with leading dash.txt
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:36 ./ filename with leading space.txt
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./brushes/
+-rw-------   1  <<uid>>  <<gid>>        739 2016-09-18 16:45:57 ./colorrc
+-rw-------   1  <<uid>>  <<gid>>       1863 2016-09-18 16:45:58 ./controllerrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./curves/
+-rw-------   1  <<uid>>  <<gid>>       1982 2016-09-18 16:45:57 ./dockrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./dynamics/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./environ/
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:36 ./filename with spaces.txt
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./fonts/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./fractalexplorer/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./gfig/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./gflare/
+-rw-------   1  <<uid>>  <<gid>>        355 2016-01-08 01:10:31 ./gimprc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./gimpressionist/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./gradients/
+-rw-r--r--   1  <<uid>>  <<gid>>        430 2015-12-25 00:15:14 ./gtkrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./interpreters/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./levels/
+-rw-r--r--   1  <<uid>>  <<gid>>      76873 2016-09-18 16:45:58 ./menurc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./modules/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./palettes/
+-rw-------   1  <<uid>>  <<gid>>        102 2016-09-18 16:45:59 ./parasiterc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./patterns/
+-rw-r--r--   1  <<uid>>  <<gid>>     277486 2015-12-25 00:15:26 ./pluginrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./plug-ins/
+-rw-rw-r--   1  <<uid>>  <<gid>>        209 2016-09-18 16:44:37 ./print-page-setup
+-rw-rw-r--   1  <<uid>>  <<gid>>        506 2016-09-18 16:44:37 ./print-settings
+-rw-------   1  <<uid>>  <<gid>>         62 2016-01-08 01:08:13 ./profilerc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./scripts/
+-rw-------   1  <<uid>>  <<gid>>       2370 2016-09-18 16:45:57 ./sessionrc
+-rw-rw-r--   1  <<uid>>  <<gid>>      34747 2016-09-18 16:45:59 ./tags.xml
+-rw-------   1  <<uid>>  <<gid>>       4817 2016-09-18 16:45:59 ./templaterc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./templates/
+-rw-rw-r--   1  <<uid>>  <<gid>>        310 2016-09-18 16:42:04 ./themerc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./themes/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./tmp/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2016-04-03 00:07:39 ./tool-options/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:14 ./tool-presets/
+-rw-------   1  <<uid>>  <<gid>>       3996 2016-09-18 16:45:58 ./toolrc
+-rw-------   1  <<uid>>  <<gid>>       1178 2016-09-18 16:45:59 ./unitrc
diff --git a/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--mdy.output b/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--mdy.output
index a0912f739..18c113e59 100644
--- a/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--mdy.output
+++ b/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--mdy.output
@@ -1,2 +1,2 @@
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 brushes/
--rw-r--r--   1  <<uid>>  <<gid>>        739 1978-09-16 16:45:00 colorrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./brushes/
+-rw-r--r--   1  <<uid>>  <<gid>>        739 1978-09-16 16:45:00 ./colorrc
diff --git a/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.input b/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.input
index 068101f40..9e7e16af4 100644
--- a/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.input
+++ b/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.input
@@ -1,3 +1,5 @@
+       6  Stored        6   0% 2016-11-23 07:13 363a3020  -filename with leading dash.txt
+       6  Stored        6   0% 2016-11-23 07:13 363a3020   filename with leading space.txt
        0  Stored        0   0% 2015-12-25 00:15 00000000  brushes/
      739  Defl:N      164  78% 2016-09-18 16:45 2d7277eb  colorrc
     1863  Defl:N      441  76% 2016-09-18 16:45 4a229bae  controllerrc
diff --git a/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.output b/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.output
index 7a511639c..ef3c8fc36 100644
--- a/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.output
+++ b/tests/src/vfs/extfs/helpers-list/data/uzip.without-zipinfo--ymd.output
@@ -1,40 +1,42 @@
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 brushes/
--rw-r--r--   1  <<uid>>  <<gid>>        739 2016-09-18 16:45:00 colorrc
--rw-r--r--   1  <<uid>>  <<gid>>       1863 2016-09-18 16:45:00 controllerrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 curves/
--rw-r--r--   1  <<uid>>  <<gid>>       1982 2016-09-18 16:45:00 dockrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 dynamics/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 environ/
--rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:00 filename with spaces.txt
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 fonts/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 fractalexplorer/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 gfig/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 gflare/
--rw-r--r--   1  <<uid>>  <<gid>>        355 2016-01-08 01:10:00 gimprc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 gimpressionist/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 gradients/
--rw-r--r--   1  <<uid>>  <<gid>>        430 2015-12-25 00:15:00 gtkrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 interpreters/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 levels/
--rw-r--r--   1  <<uid>>  <<gid>>      76873 2016-09-18 16:45:00 menurc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 modules/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 palettes/
--rw-r--r--   1  <<uid>>  <<gid>>        102 2016-09-18 16:45:00 parasiterc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 patterns/
--rw-r--r--   1  <<uid>>  <<gid>>     277486 2015-12-25 00:15:00 pluginrc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 plug-ins/
--rw-r--r--   1  <<uid>>  <<gid>>        209 2016-09-18 16:44:00 print-page-setup
--rw-r--r--   1  <<uid>>  <<gid>>        506 2016-09-18 16:44:00 print-settings
--rw-r--r--   1  <<uid>>  <<gid>>         62 2016-01-08 01:08:00 profilerc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 scripts/
--rw-r--r--   1  <<uid>>  <<gid>>       2370 2016-09-18 16:45:00 sessionrc
--rw-r--r--   1  <<uid>>  <<gid>>      34747 2016-09-18 16:45:00 tags.xml
--rw-r--r--   1  <<uid>>  <<gid>>       4817 2016-09-18 16:45:00 templaterc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 templates/
--rw-r--r--   1  <<uid>>  <<gid>>        310 2016-09-18 16:42:00 themerc
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 themes/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 tmp/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2016-04-03 00:07:00 tool-options/
-drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 tool-presets/
--rw-r--r--   1  <<uid>>  <<gid>>       3996 2016-09-18 16:45:00 toolrc
--rw-r--r--   1  <<uid>>  <<gid>>       1178 2016-09-18 16:45:00 unitrc
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:00 ./-filename with leading dash.txt
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:00 ./ filename with leading space.txt
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./brushes/
+-rw-r--r--   1  <<uid>>  <<gid>>        739 2016-09-18 16:45:00 ./colorrc
+-rw-r--r--   1  <<uid>>  <<gid>>       1863 2016-09-18 16:45:00 ./controllerrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./curves/
+-rw-r--r--   1  <<uid>>  <<gid>>       1982 2016-09-18 16:45:00 ./dockrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./dynamics/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./environ/
+-rw-r--r--   1  <<uid>>  <<gid>>          6 2016-11-23 07:13:00 ./filename with spaces.txt
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./fonts/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./fractalexplorer/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./gfig/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./gflare/
+-rw-r--r--   1  <<uid>>  <<gid>>        355 2016-01-08 01:10:00 ./gimprc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./gimpressionist/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./gradients/
+-rw-r--r--   1  <<uid>>  <<gid>>        430 2015-12-25 00:15:00 ./gtkrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./interpreters/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./levels/
+-rw-r--r--   1  <<uid>>  <<gid>>      76873 2016-09-18 16:45:00 ./menurc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./modules/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./palettes/
+-rw-r--r--   1  <<uid>>  <<gid>>        102 2016-09-18 16:45:00 ./parasiterc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./patterns/
+-rw-r--r--   1  <<uid>>  <<gid>>     277486 2015-12-25 00:15:00 ./pluginrc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./plug-ins/
+-rw-r--r--   1  <<uid>>  <<gid>>        209 2016-09-18 16:44:00 ./print-page-setup
+-rw-r--r--   1  <<uid>>  <<gid>>        506 2016-09-18 16:44:00 ./print-settings
+-rw-r--r--   1  <<uid>>  <<gid>>         62 2016-01-08 01:08:00 ./profilerc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./scripts/
+-rw-r--r--   1  <<uid>>  <<gid>>       2370 2016-09-18 16:45:00 ./sessionrc
+-rw-r--r--   1  <<uid>>  <<gid>>      34747 2016-09-18 16:45:00 ./tags.xml
+-rw-r--r--   1  <<uid>>  <<gid>>       4817 2016-09-18 16:45:00 ./templaterc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./templates/
+-rw-r--r--   1  <<uid>>  <<gid>>        310 2016-09-18 16:42:00 ./themerc
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./themes/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./tmp/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2016-04-03 00:07:00 ./tool-options/
+drwxr-xr-x   1  <<uid>>  <<gid>>          0 2015-12-25 00:15:00 ./tool-presets/
+-rw-r--r--   1  <<uid>>  <<gid>>       3996 2016-09-18 16:45:00 ./toolrc
+-rw-r--r--   1  <<uid>>  <<gid>>       1178 2016-09-18 16:45:00 ./unitrc
