diff --git a/AUTHORS b/AUTHORS
index 85309db39..e6df1dcc8 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -43,6 +43,9 @@ Alexander Serkov <serkov@ukrpost.net>
 Alessandro Rubini <rubini@ipvvis.unipv.it>
 	Mouse support.
 
+Aleš Janda <ales.janda@kyblsoft.cz>
+	Shadows of dialog windows and menus.
+
 Alexander Dong <ado@software-ag.de>
 	OS/2 port.
 
diff --git a/doc/INSTALL b/doc/INSTALL
index fe694e310..564862c33 100644
--- a/doc/INSTALL
+++ b/doc/INSTALL
@@ -20,7 +20,7 @@ Build requirements for GNU Midnight Commander
 - gettext >= 0.18.1
 - libssh2 >= 1.2.5 is required only for sftp vfs (1.2.7 if you need ssh-agent support)
 - libaspell to support spell checking in the internal editor
-- ext2fs >= 1.42.4 to suport ext{2,3,4}fs extended attributes
+- ext2fs >= 1.42.4 to support ext{2,3,4}fs extended attributes
 
 
 Installation instructions for GNU Midnight Commander
diff --git a/doc/NEWS b/doc/NEWS
index c0d32cef0..f3d2bd9ff 100644
--- a/doc/NEWS
+++ b/doc/NEWS
@@ -2,61 +2,61 @@ Version 4.8.25
 
 - Core
 
-  * Minimal version of GLib is 2.30.0
-  * Avoid subshell warning for standalone mcedit/mcview/mcdiffview run from mc (#4056)
-  * Implement chattr command (change ext{2,3,4}fs extended attributes). Default shortcut is "C-x e" (#3847)
-  * Implement a WGroup widget -- a base class for widgets which contain other widgets (#2919, #4075)
-  * Implement key bindings for radiobuttons (#212)
+    * Minimal version of GLib is 2.30.0
+    * Avoid subshell warning for standalone mcedit/mcview/mcdiffview run from mc (#4056)
+    * Implement chattr command (change ext{2,3,4}fs extended attributes). Default shortcut is "C-x e" (#3847)
+    * Implement a WGroup widget -- a base class for widgets which contain other widgets (#2919, #4075)
+    * Implement key bindings for radiobuttons (#212)
 
 - VFS
 
-  * RPM VFS improvements:
-    * Support weak dependency tags: ENHANCES, SUGGESTS, RECOMMENDS, SUPPLEMENTS (#4091)
+    * RPM VFS improvements:
+        - Support weak dependency tags: ENHANCES, SUGGESTS, RECOMMENDS, SUPPLEMENTS (#4091)
 
 - Editor
 
-  * Improvements of syntax highlighting:
-    * php (#4060)
-    * tcl: add shebangs with wish and tclsh (#4062)
-    * Cobol (#1987)
-    * Verilog/SystemVerilog (#4087)
-  * New syntax highlighting:
-    * Kotlin (#4088)
-    * ino (Arduino IDE and a number of other IDEs) (#4098)
+    * Improvements of syntax highlighting:
+        - php (#4060)
+        - tcl: add shebangs with wish and tclsh (#4062)
+        - Cobol (#1987)
+        - Verilog/SystemVerilog (#4087)
+    * New syntax highlighting:
+        - Kotlin (#4088)
+        - ino (Arduino IDE and a number of other IDEs) (#4098)
 
 - Misc
 
-  * Code cleanup (#4050, #4085)
-  * Add support for opus audio (#4061)
-  * mc-wrapper: don't cd to the same directory (#3355)
-  * Improve archive support: more binaries to view archive content (#4086)
-    * lha: jlha, lhasa
-    * arj: 7za
-    * cab: 7za
-    * zip; 7z
-    * zipx: 7za
-    * iso: 7za
-  * Clean up in video.sh handler (#4045)
-    * RealPlayer is a proprietary application which can't be installed in most distros and has long been abandoned.
-    * gtv hasn't been developed since 2003.
-    * xanim barely plays anything.
-  * Various fixups and updates of man page
+    * Code cleanup (#4050, #4085)
+    * Add support for opus audio (#4061)
+    * mc-wrapper: don't cd to the same directory (#3355)
+    * Improve archive support: more binaries to view archive content (#4086)
+        - lha: jlha, lhasa
+        - arj: 7za
+        - cab: 7za
+        - zip; 7z
+        - zipx: 7za
+        - iso: 7za
+    * Clean up in video.sh handler (#4045)
+        - RealPlayer is a proprietary application which can't be installed in most distros and has long been abandoned.
+        - gtv hasn't been developed since 2003.
+        - xanim barely plays anything.
+    * Various fixups and updates of man page
 
 - Fixes
 
-  * FTBFS on OSes w/o O_CLOEXEC (#4052)
-  * FTBFS with glib2 >= 2.63.3 (#4053)
-  * Undefined "__linux__" macro on non-Linux systems (#4058)
-  * Mouse is not handled with ncurses-6 (#3964)
-  * Mouse is not handled with S-Lang on some old terminal emulators (#4063)
-  * Terminal size is always 80x24 in subshell on Solaris 11.4 SPARC (#4099)
-  * Double clicking on empty area of file panel executes last item (#3722)
-  * Garbage in input line history (#4064)
-  * Speed of file copy is not displayed for single file (#4081)
-  * mcedit: blank screen with invisible error (#4057)
-  * mcedit: broken syntax highlighting for shell scripts (#4054)
-  * VFS: broken browsing of .deb packages (#4055)
-  * mc.lib installed twice (#4070)
+    * FTBFS on OSes w/o O_CLOEXEC (#4052)
+    * FTBFS with glib2 >= 2.63.3 (#4053)
+    * Undefined "__linux__" macro on non-Linux systems (#4058)
+    * Mouse is not handled with ncurses-6 (#3964)
+    * Mouse is not handled with S-Lang on some old terminal emulators (#4063)
+    * Terminal size is always 80x24 in subshell on Solaris 11.4 SPARC (#4099)
+    * Double clicking on empty area of file panel executes last item (#3722)
+    * Garbage in input line history (#4064)
+    * Speed of file copy is not displayed for single file (#4081)
+    * mcedit: blank screen with invisible error (#4057)
+    * mcedit: broken syntax highlighting for shell scripts (#4054)
+    * VFS: broken browsing of .deb packages (#4055)
+    * mc.lib installed twice (#4070)
 
 
 Version 4.8.24
diff --git a/doc/man/mc.1.in b/doc/man/mc.1.in
index cc4c6c68b..cdd1f687b 100644
--- a/doc/man/mc.1.in
+++ b/doc/man/mc.1.in
@@ -2113,13 +2113,17 @@ overwriting files, execution by pressing enter, quitting the program,
 directory hotlist entries deletion and history cleanup.
 .\"NODE "    Appearance"
 .SH "    Appearance"
-In this dialog you can select the skin to be used.
+In this dialog you can select the skin to be used and enable shadow
+for dialogs and drop down menus.
 .PP
 See the
 .\"LINK2"
 Skins
 .\"Skins"
 section for technical details about the skin definition files.
+.PP
+.I Shadows.
+If this option is enabled, all dialogs and drop down menus will have a shadow.
 .\"NODE "    Display bits"
 .SH "    Display bits"
 This is used to configure the range of visible characters on the
diff --git a/doc/man/ru/mc.1.in b/doc/man/ru/mc.1.in
index ea9c898be..f029b5f3e 100644
--- a/doc/man/ru/mc.1.in
+++ b/doc/man/ru/mc.1.in
@@ -2411,12 +2411,17 @@ Commander, выделены цветом, определённым ключев
 на подтверждение.
 .\"NODE "    Appearance"
 .SH "    Оформление"
-Используя это диалоговое окно, вы можете выбрать скин.
+Используя это диалоговое окно, вы можете выбрать скин и разрещить отрисовку
+теней у диалоговых окон и выпадающих меню.
 .PP
 Для получения более подробной информации о скинах обратитесь к разделу
 .\"LINK2"
 Внешний вид\&.
 .\"Skins"
+.PP
+.I Тени.
+Если эта опция включена, все диалоговые окна и выпадающие меню будут иметь
+тени.
 .\"NODE "    Display bits"
 .SH "    Биты символов..."
 Этот пункт меню используется для задания диапазона отображаемых на
diff --git a/lib/global.c b/lib/global.c
index 137bfbdd3..50ba893ba 100644
--- a/lib/global.c
+++ b/lib/global.c
@@ -85,6 +85,7 @@ mc_global_t mc_global = {
     .tty =
     {
         .skin = NULL,
+        .shadows = TRUE,
         .setup_color_string = NULL,
         .term_color_string = NULL,
         .color_terminal_string = NULL,
diff --git a/lib/global.h b/lib/global.h
index 846c724c6..6bf55952c 100644
--- a/lib/global.h
+++ b/lib/global.h
@@ -230,6 +230,8 @@ typedef struct
     {
         /* Use the specified skin */
         char *skin;
+        /* Dialog window and frop down menu have a shadow */
+        gboolean shadows;
 
         char *setup_color_string;
         char *term_color_string;
diff --git a/lib/keybind.c b/lib/keybind.c
index cd4a35db4..abd44d3e2 100644
--- a/lib/keybind.c
+++ b/lib/keybind.c
@@ -7,7 +7,7 @@
    Written by:
    Vitja Makarov, 2005
    Ilia Maslakov <il.smind@gmail.com>, 2009, 2012
-   Andrew Borodin <aborodin@vmail.ru>, 2009, 2010, 2011, 2012
+   Andrew Borodin <aborodin@vmail.ru>, 2009-2020
 
    This file is part of the Midnight Commander.
 
@@ -40,333 +40,336 @@
 
 /*** file scope macro definitions ****************************************************************/
 
+#define ADD_KEYMAP_NAME(name) \
+    { #name, CK_##name }
+
 /*** file scope type declarations ****************************************************************/
 
 /*** file scope variables ************************************************************************/
 
 static name_keymap_t command_names[] = {
     /* common */
-    {"InsertChar", CK_InsertChar},
-    {"Enter", CK_Enter},
-    {"ChangePanel", CK_ChangePanel},
-    {"Up", CK_Up},
-    {"Down", CK_Down},
-    {"Left", CK_Left},
-    {"Right", CK_Right},
-    {"LeftQuick", CK_LeftQuick},
-    {"RightQuick", CK_RightQuick},
-    {"Home", CK_Home},
-    {"End", CK_End},
-    {"PageUp", CK_PageUp},
-    {"PageDown", CK_PageDown},
-    {"HalfPageUp", CK_HalfPageUp},
-    {"HalfPageDown", CK_HalfPageDown},
-    {"Top", CK_Top},
-    {"Bottom", CK_Bottom},
-    {"TopOnScreen", CK_TopOnScreen},
-    {"MiddleOnScreen", CK_MiddleOnScreen},
-    {"BottomOnScreen", CK_BottomOnScreen},
-    {"WordLeft", CK_WordLeft},
-    {"WordRight", CK_WordRight},
-    {"Copy", CK_Copy},
-    {"Move", CK_Move},
-    {"Delete", CK_Delete},
-    {"MakeDir", CK_MakeDir},
-    {"ChangeMode", CK_ChangeMode},
-    {"ChangeOwn", CK_ChangeOwn},
-    {"ChangeOwnAdvanced", CK_ChangeOwnAdvanced},
+    ADD_KEYMAP_NAME (InsertChar),
+    ADD_KEYMAP_NAME (Enter),
+    ADD_KEYMAP_NAME (ChangePanel),
+    ADD_KEYMAP_NAME (Up),
+    ADD_KEYMAP_NAME (Down),
+    ADD_KEYMAP_NAME (Left),
+    ADD_KEYMAP_NAME (Right),
+    ADD_KEYMAP_NAME (LeftQuick),
+    ADD_KEYMAP_NAME (RightQuick),
+    ADD_KEYMAP_NAME (Home),
+    ADD_KEYMAP_NAME (End),
+    ADD_KEYMAP_NAME (PageUp),
+    ADD_KEYMAP_NAME (PageDown),
+    ADD_KEYMAP_NAME (HalfPageUp),
+    ADD_KEYMAP_NAME (HalfPageDown),
+    ADD_KEYMAP_NAME (Top),
+    ADD_KEYMAP_NAME (Bottom),
+    ADD_KEYMAP_NAME (TopOnScreen),
+    ADD_KEYMAP_NAME (MiddleOnScreen),
+    ADD_KEYMAP_NAME (BottomOnScreen),
+    ADD_KEYMAP_NAME (WordLeft),
+    ADD_KEYMAP_NAME (WordRight),
+    ADD_KEYMAP_NAME (Copy),
+    ADD_KEYMAP_NAME (Move),
+    ADD_KEYMAP_NAME (Delete),
+    ADD_KEYMAP_NAME (MakeDir),
+    ADD_KEYMAP_NAME (ChangeMode),
+    ADD_KEYMAP_NAME (ChangeOwn),
+    ADD_KEYMAP_NAME (ChangeOwnAdvanced),
 #ifdef ENABLE_EXT2FS_ATTR
-    {"ChangeAttributes", CK_ChangeAttributes},
+    ADD_KEYMAP_NAME (ChangeAttributes),
 #endif
-    {"Remove", CK_Remove},
-    {"BackSpace", CK_BackSpace},
-    {"Redo", CK_Redo},
-    {"Clear", CK_Clear},
-    {"Menu", CK_Menu},
-    {"MenuLastSelected", CK_MenuLastSelected},
-    {"UserMenu", CK_UserMenu},
-    {"EditUserMenu", CK_EditUserMenu},
-    {"Search", CK_Search},
-    {"SearchContinue", CK_SearchContinue},
-    {"Replace", CK_Replace},
-    {"ReplaceContinue", CK_ReplaceContinue},
-    {"Help", CK_Help},
-    {"Shell", CK_Shell},
-    {"Edit", CK_Edit},
-    {"EditNew", CK_EditNew},
+    ADD_KEYMAP_NAME (Remove),
+    ADD_KEYMAP_NAME (BackSpace),
+    ADD_KEYMAP_NAME (Redo),
+    ADD_KEYMAP_NAME (Clear),
+    ADD_KEYMAP_NAME (Menu),
+    ADD_KEYMAP_NAME (MenuLastSelected),
+    ADD_KEYMAP_NAME (UserMenu),
+    ADD_KEYMAP_NAME (EditUserMenu),
+    ADD_KEYMAP_NAME (Search),
+    ADD_KEYMAP_NAME (SearchContinue),
+    ADD_KEYMAP_NAME (Replace),
+    ADD_KEYMAP_NAME (ReplaceContinue),
+    ADD_KEYMAP_NAME (Help),
+    ADD_KEYMAP_NAME (Shell),
+    ADD_KEYMAP_NAME (Edit),
+    ADD_KEYMAP_NAME (EditNew),
 #ifdef HAVE_CHARSET
-    {"SelectCodepage", CK_SelectCodepage},
+    ADD_KEYMAP_NAME (SelectCodepage),
 #endif
-    {"EditorViewerHistory", CK_EditorViewerHistory},
-    {"History", CK_History},
-    {"HistoryNext", CK_HistoryNext},
-    {"HistoryPrev", CK_HistoryPrev},
-    {"Complete", CK_Complete},
-    {"Save", CK_Save},
-    {"SaveAs", CK_SaveAs},
-    {"Goto", CK_Goto},
-    {"Reread", CK_Reread},
-    {"Refresh", CK_Refresh},
-    {"Suspend", CK_Suspend},
-    {"Swap", CK_Swap},
-    {"HotList", CK_HotList},
-    {"SelectInvert", CK_SelectInvert},
-    {"ScreenList", CK_ScreenList},
-    {"ScreenNext", CK_ScreenNext},
-    {"ScreenPrev", CK_ScreenPrev},
-    {"FileNext", CK_FileNext},
-    {"FilePrev", CK_FilePrev},
-    {"DeleteToHome", CK_DeleteToHome},
-    {"DeleteToEnd", CK_DeleteToEnd},
-    {"DeleteToWordBegin", CK_DeleteToWordBegin},
-    {"DeleteToWordEnd", CK_DeleteToWordEnd},
-    {"Cut", CK_Cut},
-    {"Store", CK_Store},
-    {"Paste", CK_Paste},
-    {"Mark", CK_Mark},
-    {"MarkLeft", CK_MarkLeft},
-    {"MarkRight", CK_MarkRight},
-    {"MarkUp", CK_MarkUp},
-    {"MarkDown", CK_MarkDown},
-    {"MarkToWordBegin", CK_MarkToWordBegin},
-    {"MarkToWordEnd", CK_MarkToWordEnd},
-    {"MarkToHome", CK_MarkToHome},
-    {"MarkToEnd", CK_MarkToEnd},
-    {"ToggleNavigation", CK_ToggleNavigation},
-    {"Sort", CK_Sort},
-    {"Options", CK_Options},
-    {"LearnKeys", CK_LearnKeys},
-    {"Bookmark", CK_Bookmark},
-    {"Quit", CK_Quit},
-    {"QuitQuiet", CK_QuitQuiet},
-    {"ExtendedKeyMap", CK_ExtendedKeyMap},
+    ADD_KEYMAP_NAME (EditorViewerHistory),
+    ADD_KEYMAP_NAME (History),
+    ADD_KEYMAP_NAME (HistoryNext),
+    ADD_KEYMAP_NAME (HistoryPrev),
+    ADD_KEYMAP_NAME (Complete),
+    ADD_KEYMAP_NAME (Save),
+    ADD_KEYMAP_NAME (SaveAs),
+    ADD_KEYMAP_NAME (Goto),
+    ADD_KEYMAP_NAME (Reread),
+    ADD_KEYMAP_NAME (Refresh),
+    ADD_KEYMAP_NAME (Suspend),
+    ADD_KEYMAP_NAME (Swap),
+    ADD_KEYMAP_NAME (HotList),
+    ADD_KEYMAP_NAME (SelectInvert),
+    ADD_KEYMAP_NAME (ScreenList),
+    ADD_KEYMAP_NAME (ScreenNext),
+    ADD_KEYMAP_NAME (ScreenPrev),
+    ADD_KEYMAP_NAME (FileNext),
+    ADD_KEYMAP_NAME (FilePrev),
+    ADD_KEYMAP_NAME (DeleteToHome),
+    ADD_KEYMAP_NAME (DeleteToEnd),
+    ADD_KEYMAP_NAME (DeleteToWordBegin),
+    ADD_KEYMAP_NAME (DeleteToWordEnd),
+    ADD_KEYMAP_NAME (Cut),
+    ADD_KEYMAP_NAME (Store),
+    ADD_KEYMAP_NAME (Paste),
+    ADD_KEYMAP_NAME (Mark),
+    ADD_KEYMAP_NAME (MarkLeft),
+    ADD_KEYMAP_NAME (MarkRight),
+    ADD_KEYMAP_NAME (MarkUp),
+    ADD_KEYMAP_NAME (MarkDown),
+    ADD_KEYMAP_NAME (MarkToWordBegin),
+    ADD_KEYMAP_NAME (MarkToWordEnd),
+    ADD_KEYMAP_NAME (MarkToHome),
+    ADD_KEYMAP_NAME (MarkToEnd),
+    ADD_KEYMAP_NAME (ToggleNavigation),
+    ADD_KEYMAP_NAME (Sort),
+    ADD_KEYMAP_NAME (Options),
+    ADD_KEYMAP_NAME (LearnKeys),
+    ADD_KEYMAP_NAME (Bookmark),
+    ADD_KEYMAP_NAME (Quit),
+    ADD_KEYMAP_NAME (QuitQuiet),
+    ADD_KEYMAP_NAME (ExtendedKeyMap),
 
     /* main commands */
 #ifdef USE_INTERNAL_EDIT
-    {"EditForceInternal", CK_EditForceInternal},
+    ADD_KEYMAP_NAME (EditForceInternal),
 #endif
-    {"View", CK_View},
-    {"ViewRaw", CK_ViewRaw},
-    {"ViewFile", CK_ViewFile},
-    {"ViewFiltered", CK_ViewFiltered},
-    {"Find", CK_Find},
-    {"DirSize", CK_DirSize},
-    {"CompareDirs", CK_CompareDirs},
+    ADD_KEYMAP_NAME (View),
+    ADD_KEYMAP_NAME (ViewRaw),
+    ADD_KEYMAP_NAME (ViewFile),
+    ADD_KEYMAP_NAME (ViewFiltered),
+    ADD_KEYMAP_NAME (Find),
+    ADD_KEYMAP_NAME (DirSize),
+    ADD_KEYMAP_NAME (CompareDirs),
 #ifdef USE_DIFF_VIEW
-    {"CompareFiles", CK_CompareFiles},
+    ADD_KEYMAP_NAME (CompareFiles),
 #endif
-    {"OptionsVfs", CK_OptionsVfs},
-    {"OptionsConfirm", CK_OptionsConfirm},
-    {"OptionsDisplayBits", CK_OptionsDisplayBits},
-    {"EditExtensionsFile", CK_EditExtensionsFile},
-    {"EditFileHighlightFile", CK_EditFileHighlightFile},
-    {"LinkSymbolicEdit", CK_LinkSymbolicEdit},
-    {"ExternalPanelize", CK_ExternalPanelize},
-    {"Filter", CK_Filter},
+    ADD_KEYMAP_NAME (OptionsVfs),
+    ADD_KEYMAP_NAME (OptionsConfirm),
+    ADD_KEYMAP_NAME (OptionsDisplayBits),
+    ADD_KEYMAP_NAME (EditExtensionsFile),
+    ADD_KEYMAP_NAME (EditFileHighlightFile),
+    ADD_KEYMAP_NAME (LinkSymbolicEdit),
+    ADD_KEYMAP_NAME (ExternalPanelize),
+    ADD_KEYMAP_NAME (Filter),
 #ifdef ENABLE_VFS_FISH
-    {"ConnectFish", CK_ConnectFish},
+    ADD_KEYMAP_NAME (ConnectFish),
 #endif
 #ifdef ENABLE_VFS_FTP
-    {"ConnectFtp", CK_ConnectFtp},
+    ADD_KEYMAP_NAME (ConnectFtp),
 #endif
 #ifdef ENABLE_VFS_SFTP
-    {"ConnectSftp", CK_ConnectSftp},
+    ADD_KEYMAP_NAME (ConnectSftp),
 #endif
 #ifdef ENABLE_VFS_SMB
-    {"ConnectSmb", CK_ConnectSmb},
+    ADD_KEYMAP_NAME (ConnectSmb),
 #endif
-    {"PanelInfo", CK_PanelInfo},
+    ADD_KEYMAP_NAME (PanelInfo),
 #ifdef ENABLE_BACKGROUND
-    {"Jobs", CK_Jobs},
+    ADD_KEYMAP_NAME (Jobs),
 #endif
-    {"OptionsLayout", CK_OptionsLayout},
-    {"OptionsAppearance", CK_OptionsAppearance},
-    {"Link", CK_Link},
-    {"SetupListingFormat", CK_SetupListingFormat},
-    {"PanelListing", CK_PanelListing},
+    ADD_KEYMAP_NAME (OptionsLayout),
+    ADD_KEYMAP_NAME (OptionsAppearance),
+    ADD_KEYMAP_NAME (Link),
+    ADD_KEYMAP_NAME (SetupListingFormat),
+    ADD_KEYMAP_NAME (PanelListing),
 #ifdef LISTMODE_EDITOR
-    {"ListMode", CK_ListMode}.
+    ADD_KEYMAP_NAME (ListMode),
 #endif
-    {"OptionsPanel", CK_OptionsPanel},
-    {"CdQuick", CK_CdQuick},
-    {"PanelQuickView", CK_PanelQuickView},
-    {"LinkSymbolicRelative", CK_LinkSymbolicRelative},
-    {"VfsList", CK_VfsList},
-    {"SaveSetup", CK_SaveSetup},
-    {"LinkSymbolic", CK_LinkSymbolic},
-    {"PanelTree", CK_PanelTree},
-    {"Tree", CK_Tree},
+    ADD_KEYMAP_NAME (OptionsPanel),
+    ADD_KEYMAP_NAME (CdQuick),
+    ADD_KEYMAP_NAME (PanelQuickView),
+    ADD_KEYMAP_NAME (LinkSymbolicRelative),
+    ADD_KEYMAP_NAME (VfsList),
+    ADD_KEYMAP_NAME (SaveSetup),
+    ADD_KEYMAP_NAME (LinkSymbolic),
+    ADD_KEYMAP_NAME (PanelTree),
+    ADD_KEYMAP_NAME (Tree),
 #ifdef ENABLE_VFS_UNDELFS
-    {"Undelete", CK_Undelete},
+    ADD_KEYMAP_NAME (Undelete),
 #endif
-    {"PutCurrentLink", CK_PutCurrentLink},
-    {"PutOtherLink", CK_PutOtherLink},
-    {"HotListAdd", CK_HotListAdd},
-    {"ShowHidden", CK_ShowHidden},
-    {"SplitVertHoriz", CK_SplitVertHoriz},
-    {"SplitEqual", CK_SplitEqual},
-    {"SplitMore", CK_SplitMore},
-    {"SplitLess", CK_SplitLess},
-    {"PutCurrentPath", CK_PutCurrentPath},
-    {"PutOtherPath", CK_PutOtherPath},
-    {"PutCurrentSelected", CK_PutCurrentSelected},
-    {"PutCurrentFullSelected", CK_PutCurrentFullSelected},
-    {"PutCurrentTagged", CK_PutCurrentTagged},
-    {"PutOtherTagged", CK_PutOtherTagged},
-    {"Select", CK_Select},
-    {"Unselect", CK_Unselect},
+    ADD_KEYMAP_NAME (PutCurrentLink),
+    ADD_KEYMAP_NAME (PutOtherLink),
+    ADD_KEYMAP_NAME (HotListAdd),
+    ADD_KEYMAP_NAME (ShowHidden),
+    ADD_KEYMAP_NAME (SplitVertHoriz),
+    ADD_KEYMAP_NAME (SplitEqual),
+    ADD_KEYMAP_NAME (SplitMore),
+    ADD_KEYMAP_NAME (SplitLess),
+    ADD_KEYMAP_NAME (PutCurrentPath),
+    ADD_KEYMAP_NAME (PutOtherPath),
+    ADD_KEYMAP_NAME (PutCurrentSelected),
+    ADD_KEYMAP_NAME (PutCurrentFullSelected),
+    ADD_KEYMAP_NAME (PutCurrentTagged),
+    ADD_KEYMAP_NAME (PutOtherTagged),
+    ADD_KEYMAP_NAME (Select),
+    ADD_KEYMAP_NAME (Unselect),
 
     /* panel */
-    {"SelectExt", CK_SelectExt},
-    {"ScrollLeft", CK_ScrollLeft},
-    {"ScrollRight", CK_ScrollRight},
-    {"PanelOtherCd", CK_PanelOtherCd},
-    {"PanelOtherCdLink", CK_PanelOtherCdLink},
-    {"CopySingle", CK_CopySingle},
-    {"MoveSingle", CK_MoveSingle},
-    {"DeleteSingle", CK_DeleteSingle},
-    {"CdParent", CK_CdParent},
-    {"CdChild", CK_CdChild},
-    {"Panelize", CK_Panelize},
-    {"PanelOtherSync", CK_PanelOtherSync},
-    {"SortNext", CK_SortNext},
-    {"SortPrev", CK_SortPrev},
-    {"SortReverse", CK_SortReverse},
-    {"SortByName", CK_SortByName},
-    {"SortByExt", CK_SortByExt},
-    {"SortBySize", CK_SortBySize},
-    {"SortByMTime", CK_SortByMTime},
-    {"CdParentSmart", CK_CdParentSmart},
-    {"CycleListingFormat", CK_CycleListingFormat},
+    ADD_KEYMAP_NAME (SelectExt),
+    ADD_KEYMAP_NAME (ScrollLeft),
+    ADD_KEYMAP_NAME (ScrollRight),
+    ADD_KEYMAP_NAME (PanelOtherCd),
+    ADD_KEYMAP_NAME (PanelOtherCdLink),
+    ADD_KEYMAP_NAME (CopySingle),
+    ADD_KEYMAP_NAME (MoveSingle),
+    ADD_KEYMAP_NAME (DeleteSingle),
+    ADD_KEYMAP_NAME (CdParent),
+    ADD_KEYMAP_NAME (CdChild),
+    ADD_KEYMAP_NAME (Panelize),
+    ADD_KEYMAP_NAME (PanelOtherSync),
+    ADD_KEYMAP_NAME (SortNext),
+    ADD_KEYMAP_NAME (SortPrev),
+    ADD_KEYMAP_NAME (SortReverse),
+    ADD_KEYMAP_NAME (SortByName),
+    ADD_KEYMAP_NAME (SortByExt),
+    ADD_KEYMAP_NAME (SortBySize),
+    ADD_KEYMAP_NAME (SortByMTime),
+    ADD_KEYMAP_NAME (CdParentSmart),
+    ADD_KEYMAP_NAME (CycleListingFormat),
 
     /* dialog */
-    {"Ok", CK_Ok},
-    {"Cancel", CK_Cancel},
+    ADD_KEYMAP_NAME (Ok),
+    ADD_KEYMAP_NAME (Cancel),
 
     /* input line */
-    {"Yank", CK_Yank},
+    ADD_KEYMAP_NAME (Yank),
 
     /* help */
-    {"Index", CK_Index},
-    {"Back", CK_Back},
-    {"LinkNext", CK_LinkNext},
-    {"LinkPrev", CK_LinkPrev},
-    {"NodeNext", CK_NodeNext},
-    {"NodePrev", CK_NodePrev},
+    ADD_KEYMAP_NAME (Index),
+    ADD_KEYMAP_NAME (Back),
+    ADD_KEYMAP_NAME (LinkNext),
+    ADD_KEYMAP_NAME (LinkPrev),
+    ADD_KEYMAP_NAME (NodeNext),
+    ADD_KEYMAP_NAME (NodePrev),
 
     /* tree */
-    {"Forget", CK_Forget},
+    ADD_KEYMAP_NAME (Forget),
 
 #if defined (USE_INTERNAL_EDIT) || defined (USE_DIFF_VIEW)
-    {"ShowNumbers", CK_ShowNumbers},
+    ADD_KEYMAP_NAME (ShowNumbers),
 #endif
 
     /* chattr dialog */
-    {"MarkAndDown", CK_MarkAndDown},
+    ADD_KEYMAP_NAME (MarkAndDown),
 
 #ifdef USE_INTERNAL_EDIT
-    {"Close", CK_Close},
-    {"Tab", CK_Tab},
-    {"Undo", CK_Undo},
-    {"ScrollUp", CK_ScrollUp},
-    {"ScrollDown", CK_ScrollDown},
-    {"Return", CK_Return},
-    {"ParagraphUp", CK_ParagraphUp},
-    {"ParagraphDown", CK_ParagraphDown},
-    {"EditFile", CK_EditFile},
-    {"MarkWord", CK_MarkWord},
-    {"MarkLine", CK_MarkLine},
-    {"MarkAll", CK_MarkAll},
-    {"Unmark", CK_Unmark},
-    {"MarkColumn", CK_MarkColumn},
-    {"BlockSave", CK_BlockSave},
-    {"InsertFile", CK_InsertFile},
-    {"InsertOverwrite", CK_InsertOverwrite},
-    {"Date", CK_Date},
-    {"DeleteLine", CK_DeleteLine},
-    {"EditMail", CK_Mail},
-    {"ParagraphFormat", CK_ParagraphFormat},
-    {"MatchBracket", CK_MatchBracket},
-    {"ExternalCommand", CK_ExternalCommand},
-    {"MacroStartRecord", CK_MacroStartRecord},
-    {"MacroStopRecord", CK_MacroStopRecord},
-    {"MacroStartStopRecord", CK_MacroStartStopRecord},
-    {"MacroDelete", CK_MacroDelete},
-    {"RepeatStartStopRecord", CK_RepeatStartStopRecord},
+    ADD_KEYMAP_NAME (Close),
+    ADD_KEYMAP_NAME (Tab),
+    ADD_KEYMAP_NAME (Undo),
+    ADD_KEYMAP_NAME (ScrollUp),
+    ADD_KEYMAP_NAME (ScrollDown),
+    ADD_KEYMAP_NAME (Return),
+    ADD_KEYMAP_NAME (ParagraphUp),
+    ADD_KEYMAP_NAME (ParagraphDown),
+    ADD_KEYMAP_NAME (EditFile),
+    ADD_KEYMAP_NAME (MarkWord),
+    ADD_KEYMAP_NAME (MarkLine),
+    ADD_KEYMAP_NAME (MarkAll),
+    ADD_KEYMAP_NAME (Unmark),
+    ADD_KEYMAP_NAME (MarkColumn),
+    ADD_KEYMAP_NAME (BlockSave),
+    ADD_KEYMAP_NAME (InsertFile),
+    ADD_KEYMAP_NAME (InsertOverwrite),
+    ADD_KEYMAP_NAME (Date),
+    ADD_KEYMAP_NAME (DeleteLine),
+    ADD_KEYMAP_NAME (EditMail),
+    ADD_KEYMAP_NAME (ParagraphFormat),
+    ADD_KEYMAP_NAME (MatchBracket),
+    ADD_KEYMAP_NAME (ExternalCommand),
+    ADD_KEYMAP_NAME (MacroStartRecord),
+    ADD_KEYMAP_NAME (MacroStopRecord),
+    ADD_KEYMAP_NAME (MacroStartStopRecord),
+    ADD_KEYMAP_NAME (MacroDelete),
+    ADD_KEYMAP_NAME (RepeatStartStopRecord),
 #ifdef HAVE_ASPELL
-    {"SpellCheck", CK_SpellCheck},
-    {"SpellCheckCurrentWord", CK_SpellCheckCurrentWord},
-    {"SpellCheckSelectLang", CK_SpellCheckSelectLang},
+    ADD_KEYMAP_NAME (SpellCheck),
+    ADD_KEYMAP_NAME (SpellCheckCurrentWord),
+    ADD_KEYMAP_NAME (SpellCheckSelectLang),
 #endif /* HAVE_ASPELL */
-    {"BookmarkFlush", CK_BookmarkFlush},
-    {"BookmarkNext", CK_BookmarkNext},
-    {"BookmarkPrev", CK_BookmarkPrev},
-    {"MarkPageUp", CK_MarkPageUp},
-    {"MarkPageDown", CK_MarkPageDown},
-    {"MarkToFileBegin", CK_MarkToFileBegin},
-    {"MarkToFileEnd", CK_MarkToFileEnd},
-    {"MarkToPageBegin", CK_MarkToPageBegin},
-    {"MarkToPageEnd", CK_MarkToPageEnd},
-    {"MarkScrollUp", CK_MarkScrollUp},
-    {"MarkScrollDown", CK_MarkScrollDown},
-    {"MarkParagraphUp", CK_MarkParagraphUp},
-    {"MarkParagraphDown", CK_MarkParagraphDown},
-    {"MarkColumnPageUp", CK_MarkColumnPageUp},
-    {"MarkColumnPageDown", CK_MarkColumnPageDown},
-    {"MarkColumnLeft", CK_MarkColumnLeft},
-    {"MarkColumnRight", CK_MarkColumnRight},
-    {"MarkColumnUp", CK_MarkColumnUp},
-    {"MarkColumnDown", CK_MarkColumnDown},
-    {"MarkColumnScrollUp", CK_MarkColumnScrollUp},
-    {"MarkColumnScrollDown", CK_MarkColumnScrollDown},
-    {"MarkColumnParagraphUp", CK_MarkColumnParagraphUp},
-    {"MarkColumnParagraphDown", CK_MarkColumnParagraphDown},
-    {"BlockShiftLeft", CK_BlockShiftLeft},
-    {"BlockShiftRight", CK_BlockShiftRight},
-    {"InsertLiteral", CK_InsertLiteral},
-    {"ShowTabTws", CK_ShowTabTws},
-    {"SyntaxOnOff", CK_SyntaxOnOff},
-    {"SyntaxChoose", CK_SyntaxChoose},
-    {"ShowMargin", CK_ShowMargin},
-    {"OptionsSaveMode", CK_OptionsSaveMode},
-    {"About", CK_About},
+    ADD_KEYMAP_NAME (BookmarkFlush),
+    ADD_KEYMAP_NAME (BookmarkNext),
+    ADD_KEYMAP_NAME (BookmarkPrev),
+    ADD_KEYMAP_NAME (MarkPageUp),
+    ADD_KEYMAP_NAME (MarkPageDown),
+    ADD_KEYMAP_NAME (MarkToFileBegin),
+    ADD_KEYMAP_NAME (MarkToFileEnd),
+    ADD_KEYMAP_NAME (MarkToPageBegin),
+    ADD_KEYMAP_NAME (MarkToPageEnd),
+    ADD_KEYMAP_NAME (MarkScrollUp),
+    ADD_KEYMAP_NAME (MarkScrollDown),
+    ADD_KEYMAP_NAME (MarkParagraphUp),
+    ADD_KEYMAP_NAME (MarkParagraphDown),
+    ADD_KEYMAP_NAME (MarkColumnPageUp),
+    ADD_KEYMAP_NAME (MarkColumnPageDown),
+    ADD_KEYMAP_NAME (MarkColumnLeft),
+    ADD_KEYMAP_NAME (MarkColumnRight),
+    ADD_KEYMAP_NAME (MarkColumnUp),
+    ADD_KEYMAP_NAME (MarkColumnDown),
+    ADD_KEYMAP_NAME (MarkColumnScrollUp),
+    ADD_KEYMAP_NAME (MarkColumnScrollDown),
+    ADD_KEYMAP_NAME (MarkColumnParagraphUp),
+    ADD_KEYMAP_NAME (MarkColumnParagraphDown),
+    ADD_KEYMAP_NAME (BlockShiftLeft),
+    ADD_KEYMAP_NAME (BlockShiftRight),
+    ADD_KEYMAP_NAME (InsertLiteral),
+    ADD_KEYMAP_NAME (ShowTabTws),
+    ADD_KEYMAP_NAME (SyntaxOnOff),
+    ADD_KEYMAP_NAME (SyntaxChoose),
+    ADD_KEYMAP_NAME (ShowMargin),
+    ADD_KEYMAP_NAME (OptionsSaveMode),
+    ADD_KEYMAP_NAME (About),
     /* An action to run external script from macro */
     {"ExecuteScript", CK_PipeBlock (0)},
-    {"WindowMove", CK_WindowMove},
-    {"WindowResize", CK_WindowResize},
-    {"WindowFullscreen", CK_WindowFullscreen},
-    {"WindowList", CK_WindowList},
-    {"WindowNext", CK_WindowNext},
-    {"WindowPrev", CK_WindowPrev},
+    ADD_KEYMAP_NAME (WindowMove),
+    ADD_KEYMAP_NAME (WindowResize),
+    ADD_KEYMAP_NAME (WindowFullscreen),
+    ADD_KEYMAP_NAME (WindowList),
+    ADD_KEYMAP_NAME (WindowNext),
+    ADD_KEYMAP_NAME (WindowPrev),
 #endif /* USE_INTERNAL_EDIT */
 
     /* viewer */
-    {"WrapMode", CK_WrapMode},
-    {"HexEditMode", CK_HexEditMode},
-    {"HexMode", CK_HexMode},
-    {"MagicMode", CK_MagicMode},
-    {"NroffMode", CK_NroffMode},
-    {"BookmarkGoto", CK_BookmarkGoto},
-    {"Ruler", CK_Ruler},
-    {"SearchForward", CK_SearchForward},
-    {"SearchBackward", CK_SearchBackward},
-    {"SearchForwardContinue", CK_SearchForwardContinue},
-    {"SearchBackwardContinue", CK_SearchBackwardContinue},
-    {"SearchOppositeContinue", CK_SearchOppositeContinue},
+    ADD_KEYMAP_NAME (WrapMode),
+    ADD_KEYMAP_NAME (HexEditMode),
+    ADD_KEYMAP_NAME (HexMode),
+    ADD_KEYMAP_NAME (MagicMode),
+    ADD_KEYMAP_NAME (NroffMode),
+    ADD_KEYMAP_NAME (BookmarkGoto),
+    ADD_KEYMAP_NAME (Ruler),
+    ADD_KEYMAP_NAME (SearchForward),
+    ADD_KEYMAP_NAME (SearchBackward),
+    ADD_KEYMAP_NAME (SearchForwardContinue),
+    ADD_KEYMAP_NAME (SearchBackwardContinue),
+    ADD_KEYMAP_NAME (SearchOppositeContinue),
 
 #ifdef USE_DIFF_VIEW
     /* diff viewer */
-    {"ShowSymbols", CK_ShowSymbols},
-    {"SplitFull", CK_SplitFull},
-    {"Tab2", CK_Tab2},
-    {"Tab3", CK_Tab3},
-    {"Tab4", CK_Tab4},
-    {"Tab8", CK_Tab8},
-    {"HunkNext", CK_HunkNext},
-    {"HunkPrev", CK_HunkPrev},
-    {"EditOther", CK_EditOther},
-    {"Merge", CK_Merge},
-    {"MergeOther", CK_MergeOther},
+    ADD_KEYMAP_NAME (ShowSymbols),
+    ADD_KEYMAP_NAME (SplitFull),
+    ADD_KEYMAP_NAME (Tab2),
+    ADD_KEYMAP_NAME (Tab3),
+    ADD_KEYMAP_NAME (Tab4),
+    ADD_KEYMAP_NAME (Tab8),
+    ADD_KEYMAP_NAME (HunkNext),
+    ADD_KEYMAP_NAME (HunkPrev),
+    ADD_KEYMAP_NAME (EditOther),
+    ADD_KEYMAP_NAME (Merge),
+    ADD_KEYMAP_NAME (MergeOther),
 #endif /* USE_DIFF_VIEW */
 
     {NULL, CK_IgnoreKey}
diff --git a/lib/keybind.h b/lib/keybind.h
index 53ad1c39f..9638bd651 100644
--- a/lib/keybind.h
+++ b/lib/keybind.h
@@ -316,7 +316,7 @@ enum
     CK_InsertLiteral,
     CK_ExternalCommand,
     CK_Date,
-    CK_Mail,
+    CK_EditMail,
 
     /* viewer */
     CK_WrapMode = 600L,
diff --git a/lib/skin.h b/lib/skin.h
index 747a504ec..155a8db9c 100644
--- a/lib/skin.h
+++ b/lib/skin.h
@@ -22,92 +22,93 @@
 #define REVERSE_COLOR             mc_skin_color__cache[6]
 #define COMMAND_MARK_COLOR        mc_skin_color__cache[7]
 #define HEADER_COLOR              mc_skin_color__cache[8]
+#define SHADOW_COLOR              mc_skin_color__cache[9]
 
 /* Dialog colors */
-#define COLOR_NORMAL              mc_skin_color__cache[9]
-#define COLOR_FOCUS               mc_skin_color__cache[10]
-#define COLOR_HOT_NORMAL          mc_skin_color__cache[11]
-#define COLOR_HOT_FOCUS           mc_skin_color__cache[12]
-#define COLOR_TITLE               mc_skin_color__cache[13]
+#define COLOR_NORMAL              mc_skin_color__cache[10]
+#define COLOR_FOCUS               mc_skin_color__cache[11]
+#define COLOR_HOT_NORMAL          mc_skin_color__cache[12]
+#define COLOR_HOT_FOCUS           mc_skin_color__cache[13]
+#define COLOR_TITLE               mc_skin_color__cache[14]
 
 /* Error dialog colors */
-#define ERROR_COLOR               mc_skin_color__cache[14]
-#define ERROR_FOCUS               mc_skin_color__cache[15]
-#define ERROR_HOT_NORMAL          mc_skin_color__cache[16]
-#define ERROR_HOT_FOCUS           mc_skin_color__cache[17]
-#define ERROR_TITLE               mc_skin_color__cache[18]
+#define ERROR_COLOR               mc_skin_color__cache[15]
+#define ERROR_FOCUS               mc_skin_color__cache[16]
+#define ERROR_HOT_NORMAL          mc_skin_color__cache[17]
+#define ERROR_HOT_FOCUS           mc_skin_color__cache[18]
+#define ERROR_TITLE               mc_skin_color__cache[19]
 
 /* Menu colors */
-#define MENU_ENTRY_COLOR          mc_skin_color__cache[19]
-#define MENU_SELECTED_COLOR       mc_skin_color__cache[20]
-#define MENU_HOT_COLOR            mc_skin_color__cache[21]
-#define MENU_HOTSEL_COLOR         mc_skin_color__cache[22]
-#define MENU_INACTIVE_COLOR       mc_skin_color__cache[23]
+#define MENU_ENTRY_COLOR          mc_skin_color__cache[20]
+#define MENU_SELECTED_COLOR       mc_skin_color__cache[21]
+#define MENU_HOT_COLOR            mc_skin_color__cache[22]
+#define MENU_HOTSEL_COLOR         mc_skin_color__cache[23]
+#define MENU_INACTIVE_COLOR       mc_skin_color__cache[24]
 
 /* Popup menu colors */
-#define PMENU_ENTRY_COLOR         mc_skin_color__cache[24]
-#define PMENU_SELECTED_COLOR      mc_skin_color__cache[25]
-#define PMENU_HOT_COLOR           mc_skin_color__cache[26]      /* unused: not implemented yet */
-#define PMENU_HOTSEL_COLOR        mc_skin_color__cache[27]      /* unused: not implemented yet */
-#define PMENU_TITLE_COLOR         mc_skin_color__cache[28]
+#define PMENU_ENTRY_COLOR         mc_skin_color__cache[25]
+#define PMENU_SELECTED_COLOR      mc_skin_color__cache[26]
+#define PMENU_HOT_COLOR           mc_skin_color__cache[27]      /* unused: not implemented yet */
+#define PMENU_HOTSEL_COLOR        mc_skin_color__cache[28]      /* unused: not implemented yet */
+#define PMENU_TITLE_COLOR         mc_skin_color__cache[29]
 
-#define BUTTONBAR_HOTKEY_COLOR    mc_skin_color__cache[29]
-#define BUTTONBAR_BUTTON_COLOR    mc_skin_color__cache[30]
+#define BUTTONBAR_HOTKEY_COLOR    mc_skin_color__cache[30]
+#define BUTTONBAR_BUTTON_COLOR    mc_skin_color__cache[31]
 
-#define STATUSBAR_COLOR           mc_skin_color__cache[31]
+#define STATUSBAR_COLOR           mc_skin_color__cache[32]
 
 /*
  * This should be selectable independently. Default has to be black background
  * foreground does not matter at all.
  */
-#define GAUGE_COLOR               mc_skin_color__cache[32]
-#define INPUT_COLOR               mc_skin_color__cache[33]
-#define INPUT_UNCHANGED_COLOR     mc_skin_color__cache[34]
-#define INPUT_MARK_COLOR          mc_skin_color__cache[35]
-#define INPUT_HISTORY_COLOR       mc_skin_color__cache[36]
-#define COMMAND_HISTORY_COLOR     mc_skin_color__cache[37]
-
-#define HELP_NORMAL_COLOR         mc_skin_color__cache[38]
-#define HELP_ITALIC_COLOR         mc_skin_color__cache[39]
-#define HELP_BOLD_COLOR           mc_skin_color__cache[40]
-#define HELP_LINK_COLOR           mc_skin_color__cache[41]
-#define HELP_SLINK_COLOR          mc_skin_color__cache[42]
-#define HELP_TITLE_COLOR          mc_skin_color__cache[43]
-
-
-#define VIEW_NORMAL_COLOR         mc_skin_color__cache[44]
-#define VIEW_BOLD_COLOR           mc_skin_color__cache[45]
-#define VIEW_UNDERLINED_COLOR     mc_skin_color__cache[46]
-#define VIEW_SELECTED_COLOR       mc_skin_color__cache[47]
+#define GAUGE_COLOR               mc_skin_color__cache[33]
+#define INPUT_COLOR               mc_skin_color__cache[34]
+#define INPUT_UNCHANGED_COLOR     mc_skin_color__cache[35]
+#define INPUT_MARK_COLOR          mc_skin_color__cache[36]
+#define INPUT_HISTORY_COLOR       mc_skin_color__cache[37]
+#define COMMAND_HISTORY_COLOR     mc_skin_color__cache[38]
+
+#define HELP_NORMAL_COLOR         mc_skin_color__cache[39]
+#define HELP_ITALIC_COLOR         mc_skin_color__cache[40]
+#define HELP_BOLD_COLOR           mc_skin_color__cache[41]
+#define HELP_LINK_COLOR           mc_skin_color__cache[42]
+#define HELP_SLINK_COLOR          mc_skin_color__cache[43]
+#define HELP_TITLE_COLOR          mc_skin_color__cache[44]
+
+
+#define VIEW_NORMAL_COLOR         mc_skin_color__cache[45]
+#define VIEW_BOLD_COLOR           mc_skin_color__cache[46]
+#define VIEW_UNDERLINED_COLOR     mc_skin_color__cache[47]
+#define VIEW_SELECTED_COLOR       mc_skin_color__cache[48]
 
 /*
  * editor colors - only 4 for normal, search->found, select, and whitespace
  * respectively
  * Last is defined to view color.
  */
-#define EDITOR_NORMAL_COLOR       mc_skin_color__cache[48]
-#define EDITOR_BOLD_COLOR         mc_skin_color__cache[49]
-#define EDITOR_MARKED_COLOR       mc_skin_color__cache[50]
-#define EDITOR_WHITESPACE_COLOR   mc_skin_color__cache[51]
-#define EDITOR_RIGHT_MARGIN_COLOR mc_skin_color__cache[52]
-#define EDITOR_BACKGROUND         mc_skin_color__cache[53]
-#define EDITOR_FRAME              mc_skin_color__cache[54]
-#define EDITOR_FRAME_ACTIVE       mc_skin_color__cache[55]
-#define EDITOR_FRAME_DRAG         mc_skin_color__cache[56]
+#define EDITOR_NORMAL_COLOR       mc_skin_color__cache[49]
+#define EDITOR_BOLD_COLOR         mc_skin_color__cache[50]
+#define EDITOR_MARKED_COLOR       mc_skin_color__cache[51]
+#define EDITOR_WHITESPACE_COLOR   mc_skin_color__cache[52]
+#define EDITOR_RIGHT_MARGIN_COLOR mc_skin_color__cache[53]
+#define EDITOR_BACKGROUND         mc_skin_color__cache[54]
+#define EDITOR_FRAME              mc_skin_color__cache[55]
+#define EDITOR_FRAME_ACTIVE       mc_skin_color__cache[56]
+#define EDITOR_FRAME_DRAG         mc_skin_color__cache[57]
 /* color of left 8 char status per line */
-#define LINE_STATE_COLOR          mc_skin_color__cache[57]
-#define BOOK_MARK_COLOR           mc_skin_color__cache[58]
-#define BOOK_MARK_FOUND_COLOR     mc_skin_color__cache[59]
+#define LINE_STATE_COLOR          mc_skin_color__cache[58]
+#define BOOK_MARK_COLOR           mc_skin_color__cache[59]
+#define BOOK_MARK_FOUND_COLOR     mc_skin_color__cache[60]
 
 /* Diff colors */
-#define DFF_ADD_COLOR             mc_skin_color__cache[60]
-#define DFF_CHG_COLOR             mc_skin_color__cache[61]
-#define DFF_CHH_COLOR             mc_skin_color__cache[62]
-#define DFF_CHD_COLOR             mc_skin_color__cache[63]
-#define DFF_DEL_COLOR             mc_skin_color__cache[64]
-#define DFF_ERROR_COLOR           mc_skin_color__cache[65]
-
-#define MC_SKIN_COLOR_CACHE_COUNT 66
+#define DFF_ADD_COLOR             mc_skin_color__cache[61]
+#define DFF_CHG_COLOR             mc_skin_color__cache[62]
+#define DFF_CHH_COLOR             mc_skin_color__cache[63]
+#define DFF_CHD_COLOR             mc_skin_color__cache[64]
+#define DFF_DEL_COLOR             mc_skin_color__cache[65]
+#define DFF_ERROR_COLOR           mc_skin_color__cache[66]
+
+#define MC_SKIN_COLOR_CACHE_COUNT 67
 
 /*** enums ***************************************************************************************/
 
diff --git a/lib/skin/colors.c b/lib/skin/colors.c
index b8d944a41..27e18bdda 100644
--- a/lib/skin/colors.c
+++ b/lib/skin/colors.c
@@ -249,6 +249,7 @@ mc_skin_color_cache_init (void)
     REVERSE_COLOR = mc_skin_color_get ("core", "reverse");
     HEADER_COLOR = mc_skin_color_get ("core", "header");
     COMMAND_MARK_COLOR = mc_skin_color_get ("core", "commandlinemark");
+    SHADOW_COLOR = mc_skin_color_get ("core", "shadow");
 
     COLOR_NORMAL = mc_skin_color_get ("dialog", "_default_");
     COLOR_FOCUS = mc_skin_color_get ("dialog", "dfocus");
diff --git a/lib/stat-size.h b/lib/stat-size.h
index 8930bb5c5..cc8ec121a 100644
--- a/lib/stat-size.h
+++ b/lib/stat-size.h
@@ -81,12 +81,6 @@
   /* HP-UX counts st_blocks in 1024-byte units.
      This loses when mixing HP-UX and BSD file systems with NFS.  */
 #define ST_NBLOCKSIZE 1024
-#else /* !hpux */
-#if defined _CRAY
-#define ST_NBLOCKS(statbuf) \
-  (S_ISREG ((statbuf).st_mode) || S_ISDIR ((statbuf).st_mode) \
-   ? (statbuf).st_blocks * ST_BLKSIZE (statbuf) / ST_NBLOCKSIZE : 0)
-#endif
 #endif
 #endif
 
diff --git a/lib/strutil/strutilutf8.c b/lib/strutil/strutilutf8.c
index efec6be54..5ac0015e6 100644
--- a/lib/strutil/strutilutf8.c
+++ b/lib/strutil/strutilutf8.c
@@ -70,7 +70,7 @@ str_unichar_iscombiningmark (gunichar uni)
     GUnicodeType type;
 
     type = g_unichar_type (uni);
-    return (type == G_UNICODE_COMBINING_MARK)
+    return (type == G_UNICODE_SPACING_MARK)
         || (type == G_UNICODE_ENCLOSING_MARK) || (type == G_UNICODE_NON_SPACING_MARK);
 }
 
diff --git a/lib/timer.c b/lib/timer.c
index 25e4af6ec..f05f00e78 100644
--- a/lib/timer.c
+++ b/lib/timer.c
@@ -29,8 +29,6 @@
 
 #include <config.h>
 
-#include <sys/time.h>
-
 #include "lib/global.h"
 #include "lib/timer.h"
 
@@ -69,11 +67,9 @@ mc_timer_t *
 mc_timer_new (void)
 {
     mc_timer_t *timer;
-    struct timeval tv;
 
     timer = g_new (mc_timer_t, 1);
-    gettimeofday (&tv, NULL);
-    timer->start = (guint64) tv.tv_sec * G_USEC_PER_SEC + (guint64) tv.tv_usec;
+    timer->start = (guint64) g_get_real_time ();
 
     return timer;
 }
@@ -104,11 +100,7 @@ mc_timer_destroy (mc_timer_t * timer)
 guint64
 mc_timer_elapsed (const mc_timer_t * timer)
 {
-    struct timeval tv;
-
-    gettimeofday (&tv, NULL);
-
-    return ((guint64) tv.tv_sec * G_USEC_PER_SEC + (guint64) tv.tv_usec - timer->start);
+    return ((guint64) g_get_real_time () - timer->start);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/lib/tty/tty-internal.h b/lib/tty/tty-internal.h
index 662b0bcaf..77546cd5f 100644
--- a/lib/tty/tty-internal.h
+++ b/lib/tty/tty-internal.h
@@ -42,6 +42,8 @@ char *mc_tty_normalize_from_utf8 (const char *);
 void tty_init_xterm_support (gboolean is_xterm);
 int tty_lowlevel_getch (void);
 
+void tty_colorize_area (int y, int x, int rows, int cols, int color);
+
 /*** inline functions ****************************************************************************/
 
 #endif /* MC_TTY_INTERNAL_H */
diff --git a/lib/tty/tty-ncurses.c b/lib/tty/tty-ncurses.c
index 4383d1e74..03235cd5b 100644
--- a/lib/tty/tty-ncurses.c
+++ b/lib/tty/tty-ncurses.c
@@ -48,6 +48,7 @@
 
 #include "tty-internal.h"       /* mc_tty_normalize_from_utf8() */
 #include "tty.h"
+#include "color.h"              /* tty_setcolor */
 #include "color-internal.h"
 #include "key.h"
 #include "mouse.h"
@@ -119,6 +120,44 @@ sigwinch_handler (int dummy)
     (void) n;
 }
 
+/* --------------------------------------------------------------------------------------------- */
+
+/**
+ * Get visible part of area.
+ *
+ * @returns TRUE if any part of area is in screen bounds, FALSE otherwise.
+ */
+static gboolean
+tty_clip (int *y, int *x, int *rows, int *cols)
+{
+    if (*y < 0)
+    {
+        *rows += *y;
+
+        if (*rows <= 0)
+            return FALSE;
+
+        *y = 0;
+    }
+
+    if (*x < 0)
+    {
+        *cols += *x;
+
+        if (*cols <= 0)
+            return FALSE;
+
+        *x = 0;
+    }
+
+    if (*y + *rows > LINES)
+        *rows = LINES - *y;
+    if (*x + *cols > COLS)
+        *cols = COLS - *x;
+
+    return TRUE;
+}
+
 /* --------------------------------------------------------------------------------------------- */
 /*** public functions ****************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -494,30 +533,8 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 {
     int i;
 
-    if (y < 0)
-    {
-        rows += y;
-
-        if (rows <= 0)
-            return;
-
-        y = 0;
-    }
-
-    if (x < 0)
-    {
-        cols += x;
-
-        if (cols <= 0)
-            return;
-
-        x = 0;
-    }
-
-    if (y + rows > LINES)
-        rows = LINES - y;
-    if (x + cols > COLS)
-        cols = COLS - x;
+    if (!tty_clip (&y, &x, &rows, &cols))
+        return;
 
     for (i = 0; i < rows; i++)
     {
@@ -533,6 +550,38 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_colorize_area (int y, int x, int rows, int cols, int color)
+{
+    cchar_t *ctext;
+    wchar_t wch[10];            /* TODO not sure if the length is correct */
+    attr_t attrs;
+    short color_pair;
+
+    if (!use_colors || !tty_clip (&y, &x, &rows, &cols))
+        return;
+
+    tty_setcolor (color);
+    ctext = g_malloc (sizeof (cchar_t) * (cols + 1));
+
+    for (int row = 0; row < rows; row++)
+    {
+        mvin_wchnstr (y + row, x, ctext, cols);
+
+        for (int col = 0; col < cols; col++)
+        {
+            getcchar (&ctext[col], wch, &attrs, &color_pair, NULL);
+            setcchar (&ctext[col], wch, attrs, color, NULL);
+        }
+
+        mvadd_wchnstr (y + row, x, ctext, cols);
+    }
+
+    g_free (ctext);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_set_alt_charset (gboolean alt_charset)
 {
diff --git a/lib/tty/tty-slang.c b/lib/tty/tty-slang.c
index 0d8e89ff7..6bf22a90d 100644
--- a/lib/tty/tty-slang.c
+++ b/lib/tty/tty-slang.c
@@ -622,6 +622,15 @@ tty_fill_region (int y, int x, int rows, int cols, unsigned char ch)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_colorize_area (int y, int x, int rows, int cols, int color)
+{
+    if (use_colors)
+        SLsmg_set_color_in_region (color, y, x, rows, cols);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 void
 tty_set_alt_charset (gboolean alt_charset)
 {
diff --git a/lib/tty/tty.c b/lib/tty/tty.c
index a3929b011..d4a731343 100644
--- a/lib/tty/tty.c
+++ b/lib/tty/tty.c
@@ -264,6 +264,17 @@ tty_draw_box (int y, int x, int ys, int xs, gboolean single)
 
 /* --------------------------------------------------------------------------------------------- */
 
+void
+tty_draw_box_shadow (int y, int x, int rows, int cols, int shadow_color)
+{
+    /* draw right shadow */
+    tty_colorize_area (y + 1, x + cols, rows - 1, 2, shadow_color);
+    /* draw bottom shadow */
+    tty_colorize_area (y + rows, x + 2, 1, cols, shadow_color);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 char *
 mc_tty_normalize_from_utf8 (const char *str)
 {
diff --git a/lib/tty/tty.h b/lib/tty/tty.h
index fb1d94da8..5b9bf684f 100644
--- a/lib/tty/tty.h
+++ b/lib/tty/tty.h
@@ -126,6 +126,7 @@ extern void tty_print_one_hline (gboolean single);
 extern void tty_draw_hline (int y, int x, int ch, int len);
 extern void tty_draw_vline (int y, int x, int ch, int len);
 extern void tty_draw_box (int y, int x, int rows, int cols, gboolean single);
+extern void tty_draw_box_shadow (int y, int x, int rows, int cols, int shadow_color);
 extern void tty_fill_region (int y, int x, int rows, int cols, unsigned char ch);
 
 extern int tty_resize (int fd);
diff --git a/lib/util.h b/lib/util.h
index 46ac1f0b4..5280793c6 100644
--- a/lib/util.h
+++ b/lib/util.h
@@ -38,6 +38,22 @@
 #define MC_PIPE_ERROR_CREATE_PIPE_STREAM -4
 #define MC_PIPE_ERROR_READ -5
 
+/* gnulib efa15594e17fc20827dba66414fb391e99905394
+
+ *_GL_CMP (n1, n2) performs a three-valued comparison on n1 vs. n2.
+ *  It returns
+ *    1  if n1 > n2
+ *    0  if n1 == n2
+ *    -1 if n1 < n2
+ *  The native code   (n1 > n2 ? 1 : n1 < n2 ? -1 : 0)  produces a conditional
+ *  jump with nearly all GCC versions up to GCC 10.
+ *  This variant      (n1 < n2 ? -1 : n1 > n2)  produces a conditional with many
+ *  GCC versions up to GCC 9.
+ *  The better code  (n1 > n2) - (n1 < n2)  from Hacker's Delight para 2-9
+ *  avoids conditional jumps in all GCC versions >= 3.4.
+ */
+#define _GL_CMP(n1, n2) (((n1) > (n2)) - ((n1) < (n2)))
+
 /*** enums ***************************************************************************************/
 
 /* Pathname canonicalization */
diff --git a/lib/widget/frame.c b/lib/widget/frame.c
index 1f4f14d8a..5d5a5acdf 100644
--- a/lib/widget/frame.c
+++ b/lib/widget/frame.c
@@ -76,6 +76,9 @@ frame_draw (const WFrame * f)
 
     colors = widget_get_colors (w);
 
+    if (mc_global.tty.shadows)
+        tty_draw_box_shadow (w->y, w->x, w->lines, w->cols, SHADOW_COLOR);
+
     tty_setcolor (colors[FRAME_COLOR_NORMAL]);
     tty_fill_region (w->y, w->x, w->lines, w->cols, ' ');
     tty_draw_box (w->y + d, w->x + d, w->lines - 2 * d, w->cols - 2 * d, f->single);
diff --git a/lib/widget/menu.c b/lib/widget/menu.c
index ca2ff472a..271832e9d 100644
--- a/lib/widget/menu.c
+++ b/lib/widget/menu.c
@@ -187,6 +187,10 @@ menubar_draw_drop (const WMenuBar * menubar)
     if (column + menu->max_entry_len + 5 > (gsize) w->cols)
         column = w->cols - menu->max_entry_len - 5;
 
+    if (mc_global.tty.shadows)
+        tty_draw_box_shadow (w->y + 1, w->x + column, count + 2, menu->max_entry_len + 5,
+                             SHADOW_COLOR);
+
     tty_setcolor (MENU_ENTRY_COLOR);
     tty_draw_box (w->y + 1, w->x + column, count + 2, menu->max_entry_len + 5, FALSE);
 
diff --git a/m4.include/gnulib/fsusage.m4 b/m4.include/gnulib/fsusage.m4
index 6c104fc5a..c15cfca4d 100644
--- a/m4.include/gnulib/fsusage.m4
+++ b/m4.include/gnulib/fsusage.m4
@@ -1,7 +1,7 @@
-# serial 34
+# serial 35
 # Obtaining file system usage information.
 
-# Copyright (C) 1997-1998, 2000-2001, 2003-2017 Free Software Foundation, Inc.
+# Copyright (C) 1997-1998, 2000-2001, 2003-2020 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -36,7 +36,6 @@ AC_DEFUN([gl_FILE_SYSTEM_USAGE],
   dnl Mac OS X >= 10.5 (32-bit mode).
   AC_REQUIRE([AC_SYS_LARGEFILE])
 
-  AC_MSG_CHECKING([how to get file system space usage])
   ac_fsusage_space=no
 
   # Perform only the link test since it seems there are no variants of the
diff --git a/m4.include/gnulib/mountlist.m4 b/m4.include/gnulib/mountlist.m4
index a95c1f4bd..2705c60a9 100644
--- a/m4.include/gnulib/mountlist.m4
+++ b/m4.include/gnulib/mountlist.m4
@@ -1,4 +1,4 @@
-# serial 13
+# serial 14
 dnl Copyright (C) 2002-2006, 2009-2019 Free Software Foundation, Inc.
 dnl This file is free software; the Free Software Foundation
 dnl gives unlimited permission to copy and/or distribute it,
@@ -244,7 +244,7 @@ extern
 "C"
 #endif
 int getmntinfo (struct statfs **, int);
-              ]], [])],
+              ]], [[]])],
            [fu_cv_sys_mounted_getmntinfo2=no],
            [fu_cv_sys_mounted_getmntinfo2=yes])
         ])
diff --git a/m4.include/gnulib/stat-size.m4 b/m4.include/gnulib/stat-size.m4
index 86d409864..95f482873 100644
--- a/m4.include/gnulib/stat-size.m4
+++ b/m4.include/gnulib/stat-size.m4
@@ -1,6 +1,6 @@
 #serial 1
 
-# Copyright (C) 2011-2016 Free Software Foundation, Inc.
+# Copyright (C) 2011-2020 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -9,6 +9,6 @@
 AC_DEFUN([gl_STAT_SIZE],
 [
   # Don't call AC_STRUCT_ST_BLOCKS because it causes bugs.  Details at
-  # http://lists.gnu.org/archive/html/bug-gnulib/2011-06/msg00051.html
+  # https://lists.gnu.org/r/bug-gnulib/2011-06/msg00051.html
   AC_CHECK_HEADERS_ONCE([sys/param.h])
 ])
diff --git a/misc/ext.d/doc.sh.in b/misc/ext.d/doc.sh.in
index 871773c3a..72deae7dd 100644
--- a/misc/ext.d/doc.sh.in
+++ b/misc/ext.d/doc.sh.in
@@ -25,9 +25,9 @@ staroffice_console() {
 }
 
 get_ooffice_executable() {
-    if loffice >/dev/null 2>&1; then
+    if which loffice >/dev/null 2>&1; then
         echo "loffice"
-    elif ooffice >/dev/null 2>&1; then
+    elif which ooffice >/dev/null 2>&1; then
         echo "ooffice"
     else
         echo -n
@@ -52,28 +52,28 @@ do_view_action() {
         fi
         ;;
     msdoc)
-        if wvHtml >/dev/null 2>&1; then
+        if which wvHtml >/dev/null 2>&1; then
             tmp=`mktemp -d ${TMPDIR:-/tmp}/%p.XXXXXX`
             wvHtml "${MC_EXT_FILENAME}" --targetdir="$tmp" page.html
             elinks -dump "$tmp/page.html"
             rm -rf "$tmp"
-        elif antiword >/dev/null 2>&1; then
+        elif which antiword >/dev/null 2>&1; then
             antiword -t "${MC_EXT_FILENAME}"
-        elif catdoc >/dev/null 2>&1; then
+        elif which catdoc >/dev/null 2>&1; then
             catdoc -w "${MC_EXT_FILENAME}"
-        elif word2x >/dev/null 2>&1; then
+        elif which word2x >/dev/null 2>&1; then
             word2x -f text "${MC_EXT_FILENAME}" -
         else
             strings "${MC_EXT_FILENAME}"
         fi
         ;;
     msxls)
-        if xlhtml >/dev/null 2>&1; then
+        if which xlhtml >/dev/null 2>&1; then
             tmp=`mktemp -d ${TMPDIR:-/tmp}/%p.XXXXXX`
             xlhtml -a "${MC_EXT_FILENAME}" > "$tmp/page.html"
             elinks -dump "$tmp/page.html"
             rm -rf "$tmp"
-        elif xls2csv >/dev/null 2>&1; then
+        elif which xls2csv >/dev/null 2>&1; then
             xls2csv "${MC_EXT_FILENAME}"
         else
             strings "${MC_EXT_FILENAME}"
diff --git a/misc/ext.d/image.sh b/misc/ext.d/image.sh
index 583c09ecf..04307e01b 100755
--- a/misc/ext.d/image.sh
+++ b/misc/ext.d/image.sh
@@ -45,7 +45,7 @@ do_open_action() {
             else
                 (gqview "${MC_EXT_FILENAME}" &)
             fi
-        elif see >/dev/null 2>&1; then
+        elif which see >/dev/null 2>&1; then
             (see "${MC_EXT_FILENAME}" &)
         else
             (zgv "${MC_EXT_FILENAME}" &)
diff --git a/misc/ext.d/misc.sh.in b/misc/ext.d/misc.sh.in
index f4b0bd47b..32a5f3f8d 100644
--- a/misc/ext.d/misc.sh.in
+++ b/misc/ext.d/misc.sh.in
@@ -71,7 +71,7 @@ do_open_action() {
         sqlite3 "${MC_EXT_FILENAME}"
         ;;
     glade)
-        if glade-3 --version >/dev/null 2>&1; then
+        if which glade-3 >/dev/null 2>&1; then
             (glade-3 "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             (glade-2 "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
diff --git a/misc/ext.d/sound.sh b/misc/ext.d/sound.sh
index 760aaf1dd..c92b868ab 100755
--- a/misc/ext.d/sound.sh
+++ b/misc/ext.d/sound.sh
@@ -38,7 +38,7 @@ do_open_action() {
     case "${filetype}" in
     common)
         if [ -n "$DISPLAY" ]; then
-            (xmms  "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious  "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             play "${MC_EXT_FILENAME}"
         fi
@@ -52,21 +52,21 @@ do_open_action() {
         ;;
     mp3)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             mpg123 "${MC_EXT_FILENAME}"
         fi
         ;;
     ogg)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             ogg123 "${MC_EXT_FILENAME}"
         fi
         ;;
     opus)
         if [ -n "$DISPLAY" ]; then
-            (xmms "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             play "${MC_EXT_FILENAME}"
         fi
@@ -79,7 +79,7 @@ do_open_action() {
         ;;
     playlist)
         if [ -n "$DISPLAY" ]; then
-            (xmms -p "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
+            (audacious -p "${MC_EXT_FILENAME}" >/dev/null 2>&1 &)
         else
             mplayer -vo null -playlist "${MC_EXT_FILENAME}"
         fi
diff --git a/misc/ext.d/video.sh b/misc/ext.d/video.sh
index 979a50acc..9cba21020 100755
--- a/misc/ext.d/video.sh
+++ b/misc/ext.d/video.sh
@@ -13,7 +13,7 @@ do_view_action() {
 
     case "${filetype}" in
     *)
-        if mplayer >/dev/null 2>&1; then
+        if which mplayer >/dev/null 2>&1; then
             mplayer -identify -vo null -ao null -frames 0 "${MC_EXT_FILENAME}" 2>&1 | \
                 sed -n 's/^ID_//p'
         elif which mpv_identify.sh >/dev/null 2>&1; then
@@ -28,9 +28,9 @@ do_view_action() {
 do_open_action() {
     filetype=$1
 
-    if mpv >/dev/null 2>&1; then
+    if which mpv >/dev/null 2>&1; then
         PLAYER=mpv
-    elif mplayer >/dev/null 2>&1; then
+    elif which mplayer >/dev/null 2>&1; then
         PLAYER=mplayer
     else
         echo "Please install either mplayer or mpv to play this file"
diff --git a/misc/mc.default.keymap b/misc/mc.default.keymap
index d05e97e65..1bf68b2df 100644
--- a/misc/mc.default.keymap
+++ b/misc/mc.default.keymap
@@ -1,5 +1,5 @@
 [main]
-ChangePanel = tab
+ChangePanel = tab; ctrl-i
 Help = f1
 UserMenu = f2
 View = f3
diff --git a/misc/mc.emacs.keymap b/misc/mc.emacs.keymap
index 70935cd47..022de7698 100644
--- a/misc/mc.emacs.keymap
+++ b/misc/mc.emacs.keymap
@@ -1,5 +1,5 @@
 [main]
-ChangePanel = tab
+ChangePanel = tab; ctrl-i
 Help = f1
 UserMenu = f2
 View = f3
diff --git a/misc/mc.ext.in b/misc/mc.ext.in
index c938d0504..0311baae1 100644
--- a/misc/mc.ext.in
+++ b/misc/mc.ext.in
@@ -361,16 +361,6 @@ shell/.info
 shell/i/.3gp
 	Include=video
 
-# Manual page
-regex/(([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])|\.man)$
-	Open=@EXTHELPERSDIR@/text.sh open man %var{PAGER:more}
-	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man %var{PAGER:more}
-
-# Perl pod page
-shell/.pod
-	Open=@EXTHELPERSDIR@/text.sh open pod %var{PAGER:more}
-	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view pod %var{PAGER:more}
-
 # Troff with me macros.
 # Exception - "read.me" is not a nroff file.
 shell/read.me
@@ -387,18 +377,28 @@ shell/.ms
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view nroff.ms %var{PAGER:more}
 
 # Manual page - compressed
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.g?[Zz]$
+type/^(ASCII )?troff.*gzip compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.gz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.gz %var{PAGER:more}
 
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.bz$
+type/^(ASCII )?troff.*bzip compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.bz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.bz %var{PAGER:more}
 
-regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.bz2$
+type/^(ASCII )?troff.*bzip2 compressed
 	Open=@EXTHELPERSDIR@/text.sh open man.bz2 %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.bz2 %var{PAGER:more}
 
+# Manual page
+type/^(ASCII )?troff
+	Open=@EXTHELPERSDIR@/text.sh open man %var{PAGER:more}
+	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man %var{PAGER:more}
+
+# Perl pod page
+shell/.pod
+	Open=@EXTHELPERSDIR@/text.sh open pod %var{PAGER:more}
+	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view pod %var{PAGER:more}
+
 regex/([^0-9]|^[^\.]*)\.([1-9][A-Za-z]*|[ln])\.lz$
 	Open=@EXTHELPERSDIR@/text.sh open man.lz %var{PAGER:more}
 	View=%view{ascii,nroff} @EXTHELPERSDIR@/text.sh view man.lz %var{PAGER:more}
@@ -671,10 +671,6 @@ regex/i/\.(epub|mobi)$
 shell/.class
 	View=%view{ascii} @EXTHELPERSDIR@/misc.sh view javaclass
 
-# Makefile
-regex/^[Mm]akefile$
-	Open=make -f %f %{Enter parameters}
-
 # Imakefile
 shell/Imakefile
 	Open=xmkmf -a
@@ -683,6 +679,10 @@ shell/Imakefile
 regex/^Makefile\.(PL|pl)$
 	Open=%var{PERL:perl} %f
 
+# Makefile
+regex/[Mm]akefile
+	Open=make -f %f %{Enter parameters}
+
 # sqlite3.db
 type/^SQLite 3.x database
 	Open=@EXTHELPERSDIR@/misc.sh open sqlite
@@ -761,38 +761,27 @@ shell/i/.zoo
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view zoo
 
 # gzip
-type/^gzip
+type/\(gzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view gz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
 
-regex/\.(gz|Z)$
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
-
 # bzip2
-type/^bzip2
+type/\(bzip2 compressed
 	Open=@EXTHELPERSDIR@/archive.sh view bzip2 %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bz2
 
-regex/\.bz2?$
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bz2
-
 # bzip
-type/^bzip
+type/\(bzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view bzip %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view bzip
 
 # compress
-type/^compress
+type/\(compress'd
 	Open=@EXTHELPERSDIR@/archive.sh view gz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view gz
 
 # lz
-regex/\.lz$
-	Open=@EXTHELPERSDIR@/archive.sh view lz %var{PAGER:more}
-	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz
-
-# lz
-type/^LZIP
+type/\(lzip compressed
 	Open=@EXTHELPERSDIR@/archive.sh view lz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz
 
@@ -802,17 +791,17 @@ regex/\.lz4$
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lz4
 
 # lzma
-regex/\.lzma$
+type/\(LZMA compressed
 	Open=@EXTHELPERSDIR@/archive.sh view lzma %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view lzma
 
 # xz
-regex/\.xz$
+type/\(XZ compressed
 	Open=@EXTHELPERSDIR@/archive.sh view xz %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view xz
 
 # zstd
-regex/\.zst$
+type/\(Zstandard compressed
 	Open=@EXTHELPERSDIR@/archive.sh view zst %var{PAGER:more}
 	View=%view{ascii} @EXTHELPERSDIR@/archive.sh view zst
 
diff --git a/misc/skins/dark.ini b/misc/skins/dark.ini
index 58d6f8351..0cfeb8ecf 100644
--- a/misc/skins/dark.ini
+++ b/misc/skins/dark.ini
@@ -39,6 +39,7 @@
     header = yellow;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/darkfar.ini b/misc/skins/darkfar.ini
index e0e1a5879..c6dcf68f2 100644
--- a/misc/skins/darkfar.ini
+++ b/misc/skins/darkfar.ini
@@ -39,6 +39,7 @@
     header = yellow;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/default.ini b/misc/skins/default.ini
index afc060ade..145eb998b 100644
--- a/misc/skins/default.ini
+++ b/misc/skins/default.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/double-lines.ini b/misc/skins/double-lines.ini
index cad1e2807..7f35df0bc 100644
--- a/misc/skins/double-lines.ini
+++ b/misc/skins/double-lines.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/featured-plus.ini b/misc/skins/featured-plus.ini
index be7dde7a6..a0dc07028 100644
--- a/misc/skins/featured-plus.ini
+++ b/misc/skins/featured-plus.ini
@@ -41,6 +41,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/featured.ini b/misc/skins/featured.ini
index b37671899..43ce2f293 100644
--- a/misc/skins/featured.ini
+++ b/misc/skins/featured.ini
@@ -41,6 +41,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/gotar.ini b/misc/skins/gotar.ini
index b9b8aa093..3b81867fc 100644
--- a/misc/skins/gotar.ini
+++ b/misc/skins/gotar.ini
@@ -36,6 +36,7 @@
     header = brightred;
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = brightcyan;blue
diff --git a/misc/skins/gray-green-purple256.ini b/misc/skins/gray-green-purple256.ini
index 4a15b798c..3ae534cae 100644
--- a/misc/skins/gray-green-purple256.ini
+++ b/misc/skins/gray-green-purple256.ini
@@ -45,6 +45,7 @@
     reverse =
     commandlinemark = ;main1
     header = main2
+    shadow = black;gray12
 
 [dialog]
     _default_ = black;bgdarker
diff --git a/misc/skins/gray-orange-blue256.ini b/misc/skins/gray-orange-blue256.ini
index cddd27b5f..fa491f014 100644
--- a/misc/skins/gray-orange-blue256.ini
+++ b/misc/skins/gray-orange-blue256.ini
@@ -45,6 +45,7 @@
     reverse =
     commandlinemark = ;main1
     header = main2
+    shadow = black;gray12
 
 [dialog]
     _default_ = black;bgdarker
diff --git a/misc/skins/julia256.ini b/misc/skins/julia256.ini
index bf04dd9e6..a61701cfd 100644
--- a/misc/skins/julia256.ini
+++ b/misc/skins/julia256.ini
@@ -42,6 +42,7 @@
     header = yellow;color237
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/mc46.ini b/misc/skins/mc46.ini
index 0b1f099d7..f971310ed 100644
--- a/misc/skins/mc46.ini
+++ b/misc/skins/mc46.ini
@@ -39,6 +39,7 @@
     header = yellow;blue
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = black;lightgray
diff --git a/misc/skins/modarcon16-defbg.ini b/misc/skins/modarcon16-defbg.ini
index 12391af2f..c004f6363 100644
--- a/misc/skins/modarcon16-defbg.ini
+++ b/misc/skins/modarcon16-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16.ini b/misc/skins/modarcon16.ini
index f0fe8d9e8..8cf81ab8b 100644
--- a/misc/skins/modarcon16.ini
+++ b/misc/skins/modarcon16.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16root-defbg.ini b/misc/skins/modarcon16root-defbg.ini
index f00351b36..b74700489 100644
--- a/misc/skins/modarcon16root-defbg.ini
+++ b/misc/skins/modarcon16root-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarcon16root.ini b/misc/skins/modarcon16root.ini
index f76c8d6c9..d9afd5a3d 100644
--- a/misc/skins/modarcon16root.ini
+++ b/misc/skins/modarcon16root.ini
@@ -81,6 +81,7 @@
     disabled = color8;color7
     #inputhistory =
     #commandhistory =
+    shadow = color7;color0
 
 [dialog]
     _default_ = color0;color7
diff --git a/misc/skins/modarin256-defbg.ini b/misc/skins/modarin256-defbg.ini
index dcc6f265a..f12d33623 100644
--- a/misc/skins/modarin256-defbg.ini
+++ b/misc/skins/modarin256-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256.ini b/misc/skins/modarin256.ini
index fa2bf2e93..8d1872aa7 100644
--- a/misc/skins/modarin256.ini
+++ b/misc/skins/modarin256.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256root-defbg.ini b/misc/skins/modarin256root-defbg.ini
index dcf7a29b4..48a4e9927 100644
--- a/misc/skins/modarin256root-defbg.ini
+++ b/misc/skins/modarin256root-defbg.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/modarin256root.ini b/misc/skins/modarin256root.ini
index 9bb4feefe..0a361ed24 100644
--- a/misc/skins/modarin256root.ini
+++ b/misc/skins/modarin256root.ini
@@ -81,6 +81,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color240;color0
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/nicedark.ini b/misc/skins/nicedark.ini
index fb2c076a5..0b5ee0107 100644
--- a/misc/skins/nicedark.ini
+++ b/misc/skins/nicedark.ini
@@ -39,6 +39,7 @@
     header = lightgray;black
     inputhistory =
     commandhistory =
+    shadow = gray;black
 
 [dialog]
     _default_ = lightgray;black
diff --git a/misc/skins/sand256.ini b/misc/skins/sand256.ini
index f60ad44ab..94b1b77ca 100644
--- a/misc/skins/sand256.ini
+++ b/misc/skins/sand256.ini
@@ -94,6 +94,7 @@
     reverse = ;rgb452
     commandlinemark = white;gray
     header = red;;italic
+    shadow = black;rgb221
 
 [dialog]
     _default_ = black;rgb553
diff --git a/misc/skins/seasons-autumn16M.ini b/misc/skins/seasons-autumn16M.ini
index 182e2219b..bc8dc65ea 100644
--- a/misc/skins/seasons-autumn16M.ini
+++ b/misc/skins/seasons-autumn16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #69880c
     Input = #b5c400
     PaleFg = #555
+    ShadowFg = #7f7f55
+    ShadowBg = #4c1002
     Error = #840000
     ErrorFocus = #b00
     Top = #ff9909
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-spring16M.ini b/misc/skins/seasons-spring16M.ini
index de5906e2b..2c44a243b 100644
--- a/misc/skins/seasons-spring16M.ini
+++ b/misc/skins/seasons-spring16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #b3de85
     Input = Main
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #797f73
     Error = #c62b41
     ErrorFocus = #e16d7e
     Top = #f699a6
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-summer16M.ini b/misc/skins/seasons-summer16M.ini
index a8a01caa3..e9c686dc1 100644
--- a/misc/skins/seasons-summer16M.ini
+++ b/misc/skins/seasons-summer16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #f864f6
     Input = #d7ffad
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #7f7659
     Error = #d40707
     ErrorFocus = #db7b7b
     Top = #46cef3
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/seasons-winter16M.ini b/misc/skins/seasons-winter16M.ini
index bebc50c79..2724b2f09 100644
--- a/misc/skins/seasons-winter16M.ini
+++ b/misc/skins/seasons-winter16M.ini
@@ -65,6 +65,8 @@
     DialogFocus = #afbad8
     Input = Main
     PaleFg = #777
+    ShadowFg = #000
+    ShadowBg = #727176
     Error = #3c4766
     ErrorFocus = #586896
     Top = #6b99d7
@@ -106,6 +108,7 @@
     reverse = #000;Bottom
     commandlinemark = #000;DialogFocus
     header = HeaderFg
+    shadow = ShadowFg;ShadowBg
 
 [dialog]
     _default_ = #000;Dialog
diff --git a/misc/skins/xoria256.ini b/misc/skins/xoria256.ini
index 771f39ca4..d0e6b8a9b 100644
--- a/misc/skins/xoria256.ini
+++ b/misc/skins/xoria256.ini
@@ -82,6 +82,8 @@
     #commandhistory =
     #commandlinemark = black;lightgray
 
+    shadow = color239;black
+
 [dialog]
     _default_ = black;color250
     dhotnormal = color88;;
diff --git a/misc/skins/yadt256-defbg.ini b/misc/skins/yadt256-defbg.ini
index 8eec14c14..5de0aef57 100644
--- a/misc/skins/yadt256-defbg.ini
+++ b/misc/skins/yadt256-defbg.ini
@@ -48,6 +48,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color239;black
 
 [dialog]
     _default_ = color252;color239
diff --git a/misc/skins/yadt256.ini b/misc/skins/yadt256.ini
index 639576214..8fd2c70b7 100644
--- a/misc/skins/yadt256.ini
+++ b/misc/skins/yadt256.ini
@@ -47,6 +47,7 @@
     disabled = color246;color239
     #inputhistory =
     #commandhistory =
+    shadow = color239;black
 
 [dialog]
     _default_ = color252;color239
diff --git a/src/editor/edit.c b/src/editor/edit.c
index c77608084..e13be389a 100644
--- a/src/editor/edit.c
+++ b/src/editor/edit.c
@@ -3910,7 +3910,7 @@ edit_execute_cmd (WEdit * edit, long command, int char_for_insertion)
     case CK_ExternalCommand:
         edit_ext_cmd (edit);
         break;
-    case CK_Mail:
+    case CK_EditMail:
         edit_mail_dialog (edit);
         break;
 #ifdef HAVE_CHARSET
diff --git a/src/editor/editmenu.c b/src/editor/editmenu.c
index ca42a74a4..489893849 100644
--- a/src/editor/editmenu.c
+++ b/src/editor/editmenu.c
@@ -190,7 +190,7 @@ create_command_menu (void)
         entries = g_list_prepend (entries, menu_separator_create ());
     }
 #endif /* HAVE_ASPELL */
-    entries = g_list_prepend (entries, menu_entry_create (_("&Mail..."), CK_Mail));
+    entries = g_list_prepend (entries, menu_entry_create (_("&Mail..."), CK_EditMail));
 
 
     return g_list_reverse (entries);
diff --git a/src/execute.c b/src/execute.c
index d9b306e67..f35c53d94 100644
--- a/src/execute.c
+++ b/src/execute.c
@@ -551,7 +551,6 @@ toggle_subshell (void)
     {
         if (mc_global.mc_run_mode == MC_RUN_FULL)
         {
-            do_load_prompt ();
             if (new_dir_vpath != NULL)
                 do_possible_cd (new_dir_vpath);
         }
diff --git a/src/filemanager/Makefile.am b/src/filemanager/Makefile.am
index 71f9fc2f2..ba4a1be96 100644
--- a/src/filemanager/Makefile.am
+++ b/src/filemanager/Makefile.am
@@ -2,10 +2,10 @@
 noinst_LTLIBRARIES = libmcfilemanager.la
 
 libmcfilemanager_la_SOURCES = \
-	achown.c achown.h \
+	achown.c \
 	boxes.c boxes.h \
-	chmod.c chmod.h \
-	chown.c chown.h \
+	chmod.c \
+	chown.c \
 	cmd.c cmd.h \
 	command.c command.h \
 	dir.c dir.h \
@@ -33,7 +33,7 @@ AM_CPPFLAGS = -I$(top_srcdir) $(GLIB_CFLAGS) $(PCRE_CPPFLAGS)
 
 if ENABLE_EXT2FS_ATTR
 libmcfilemanager_la_SOURCES += \
-	chattr.c chattr.h
+	chattr.c
 
 AM_CPPFLAGS += @EXT2FS_CFLAGS@ @E2P_CFLAGS@
 endif
diff --git a/src/filemanager/achown.c b/src/filemanager/achown.c
index 813c5dbd5..7a9ba7a97 100644
--- a/src/filemanager/achown.c
+++ b/src/filemanager/achown.c
@@ -47,7 +47,7 @@
 
 #include "midnight.h"           /* current_panel */
 
-#include "achown.h"
+#include "cmd.h"                /* advanced_chown_cmd() */
 
 /*** global variables ****************************************************************************/
 
diff --git a/src/filemanager/achown.h b/src/filemanager/achown.h
deleted file mode 100644
index 61def7b68..000000000
--- a/src/filemanager/achown.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file achown.h
- *  \brief Header: Contains functions for advanced chowning
- */
-
-#ifndef MC__ACHOWN_H
-#define MC__ACHOWN_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void advanced_chown_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__ACHOWN_H */
diff --git a/src/filemanager/boxes.c b/src/filemanager/boxes.c
index e6a9abe1a..5b4d8c527 100644
--- a/src/filemanager/boxes.c
+++ b/src/filemanager/boxes.c
@@ -42,6 +42,7 @@
 #include "lib/global.h"
 
 #include "lib/tty/tty.h"
+#include "lib/tty/color.h"      /* tty_use_colors() */
 #include "lib/tty/key.h"        /* XCTRL and ALT macros  */
 #include "lib/skin.h"           /* INPUT_COLOR */
 #include "lib/mcconfig.h"       /* Load/save user formats */
@@ -102,7 +103,7 @@ static const int panel_list_user_idx = 3;
 
 static char **status_format;
 static unsigned long panel_list_formats_id, panel_user_format_id, panel_brief_cols_id;
-static unsigned long mini_user_status_id, mini_user_format_id;
+static unsigned long user_mini_status_id, mini_user_format_id;
 
 #ifdef HAVE_CHARSET
 static int new_display_codepage;
@@ -119,6 +120,8 @@ static gchar *current_skin_name;
 static WListbox *bg_list = NULL;
 #endif /* ENABLE_BACKGROUND */
 
+static unsigned long shadows_id;
+
 /* --------------------------------------------------------------------------------------------- */
 /*** file scope functions ************************************************************************/
 /* --------------------------------------------------------------------------------------------- */
@@ -272,6 +275,38 @@ sel_skin_button (WButton * button, int action)
 
 /* --------------------------------------------------------------------------------------------- */
 
+static cb_ret_t
+appearance_box_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *data)
+{
+    switch (msg)
+    {
+    case MSG_INIT:
+        if (!tty_use_colors ())
+        {
+            Widget *shadow;
+
+            shadow = widget_find_by_id (w, shadows_id);
+            CHECK (shadow)->state = FALSE;
+            widget_disable (shadow, TRUE);
+        }
+        return MSG_HANDLED;
+
+    case MSG_NOTIFY:
+        if (sender != NULL && sender->id == shadows_id)
+        {
+            mc_global.tty.shadows = CHECK (sender)->state;
+            repaint_screen ();
+            return MSG_HANDLED;
+        }
+        return MSG_NOT_HANDLED;
+
+    default:
+        return dlg_default_callback (w, sender, msg, parm, data);
+    }
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
 static cb_ret_t
 panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *data)
 {
@@ -285,7 +320,7 @@ panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm,
 
             in1 = INPUT (widget_find_by_id (w, panel_user_format_id));
             in2 = INPUT (widget_find_by_id (w, panel_brief_cols_id));
-            ch = CHECK (widget_find_by_id (w, mini_user_status_id));
+            ch = CHECK (widget_find_by_id (w, user_mini_status_id));
             in3 = INPUT (widget_find_by_id (w, mini_user_format_id));
 
             if (!ch->state)
@@ -298,7 +333,7 @@ panel_listing_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm,
             return MSG_HANDLED;
         }
 
-        if (sender != NULL && sender->id == mini_user_status_id)
+        if (sender != NULL && sender->id == user_mini_status_id)
         {
             WInput *in;
 
@@ -590,6 +625,8 @@ configure_box (void)
 void
 appearance_box (void)
 {
+    gboolean shadows = mc_global.tty.shadows;
+
     current_skin_name = g_strdup (mc_skin__default.name);
     skin_names = mc_skin_list ();
 
@@ -602,6 +639,8 @@ appearance_box (void)
                 QUICK_BUTTON (str_fit_to_term (skin_name_to_label (current_skin_name), 20, J_LEFT_FIT),
                               B_USER, sel_skin_button, NULL),
             QUICK_STOP_COLUMNS,
+            QUICK_SEPARATOR (TRUE),
+            QUICK_CHECKBOX (N_("&Shadows"), &mc_global.tty.shadows, &shadows_id),
             QUICK_BUTTONS_OK_CANCEL,
             QUICK_END
             /* *INDENT-ON* */
@@ -610,14 +649,17 @@ appearance_box (void)
         quick_dialog_t qdlg = {
             -1, -1, 54,
             N_("Appearance"), "[Appearance]",
-            quick_widgets, dlg_default_callback, NULL
+            quick_widgets, appearance_box_callback, NULL
         };
 
         if (quick_dialog (&qdlg) == B_ENTER)
             mc_config_set_string (mc_global.main_config, CONFIG_APP_SECTION, "skin",
                                   current_skin_name);
         else
+        {
             skin_apply (NULL);
+            mc_global.tty.shadows = shadows;
+        }
     }
 
     g_free (current_skin_name);
@@ -725,7 +767,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
     }
 
     {
-        gboolean mini_user_status;
+        gboolean user_mini_status;
         char panel_brief_cols_in[BUF_TINY];
         char *panel_brief_cols_out = NULL;
         char *panel_user_format = NULL;
@@ -752,7 +794,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
             QUICK_INPUT (panel->user_format, "user-fmt-input", &panel_user_format,
                          &panel_user_format_id, FALSE, FALSE, INPUT_COMPLETE_NONE),
             QUICK_SEPARATOR (TRUE),
-            QUICK_CHECKBOX (N_("User &mini status"), &mini_user_status, &mini_user_status_id),
+            QUICK_CHECKBOX (N_("User &mini status"), &user_mini_status, &user_mini_status_id),
             QUICK_INPUT (panel->user_status_format[panel->list_format], "mini_input",
                          &mini_user_format, &mini_user_format_id, FALSE, FALSE, INPUT_COMPLETE_NONE),
             QUICK_BUTTONS_OK_CANCEL,
@@ -766,7 +808,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
             quick_widgets, panel_listing_callback, NULL
         };
 
-        mini_user_status = panel->user_mini_status;
+        user_mini_status = panel->user_mini_status;
         result = panel->list_format;
         status_format = panel->user_status_format;
 
@@ -778,7 +820,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
         if ((int) panel->list_format != panel_list_user_idx)
             quick_widgets[6].state = WST_DISABLED;
 
-        if (!mini_user_status)
+        if (!user_mini_status)
             quick_widgets[9].state = WST_DISABLED;
 
         if (quick_dialog (&qdlg) == B_CANCEL)
@@ -790,7 +832,7 @@ panel_listing_box (WPanel * panel, int num, char **userp, char **minip, gboolean
 
             *userp = panel_user_format;
             *minip = mini_user_format;
-            *use_msformat = mini_user_status;
+            *use_msformat = user_mini_status;
 
             cols = strtol (panel_brief_cols_out, &error, 10);
             if (*error == '\0')
diff --git a/src/filemanager/chattr.c b/src/filemanager/chattr.c
index d68612211..334015ba0 100644
--- a/src/filemanager/chattr.c
+++ b/src/filemanager/chattr.c
@@ -51,7 +51,7 @@
 #include "midnight.h"           /* current_panel */
 #include "panel.h"              /* do_file_mark() */
 
-#include "chattr.h"
+#include "cmd.h"                /* chattr_cmd(), chattr_get_as_str() */
 
 /*** global variables ****************************************************************************/
 
@@ -122,7 +122,7 @@ struct WChattrBoxes
  * EXT4_EOFBLOCKS_FL        0x00400000 was here, unused
  * FS_NOCOW_FL              0x00800000 -- Do not cow file
  * EXT4_SNAPFILE_FL         0x01000000 -- Inode is a snapshot
- *                          0x02000000 -- unused yet
+ * FS_DAX_FL                0x02000000 -- Inode is DAX
  * EXT4_SNAPFILE_DELETED_FL 0x04000000 -- Snapshot is being deleted
  * EXT4_SNAPFILE_SHRUNK_FL  0x08000000 -- Snapshot shrink has completed
  * EXT4_INLINE_DATA_FL      0x10000000 -- Inode has inline data
@@ -179,6 +179,12 @@ static struct
     { EXT4_HUGE_FILE_FL,    'h', N_("Huge_file"),                     FALSE, FALSE },
 #endif
     { FS_NOCOW_FL,          'C', N_("No COW"),                        FALSE, FALSE },
+#ifdef FS_DAX_FL
+    /* added in v1.45.7
+       TODO: clarify version after ext2fsprogs release
+       ext2fsprogs 1dd48bc23c3776df76459aff0c7723fff850ea45 2020-07-28 */
+    { FS_DAX_FL,            'x', N_("Direct access for files"),       FALSE, FALSE },
+#endif
 #ifdef EXT4_CASEFOLD_FL
     /* added in v1.45.0
        ext2fsprogs 1378bb6515e98a27f0f5c220381d49d20544204e 2018-12-01 */
@@ -865,6 +871,8 @@ chattrboxes_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
         break;
 
     default:
+        /* return MOU_UNHANDLED */
+        event->result.abort = TRUE;
         break;
     }
 }
diff --git a/src/filemanager/chattr.h b/src/filemanager/chattr.h
deleted file mode 100644
index b6eaa2374..000000000
--- a/src/filemanager/chattr.h
+++ /dev/null
@@ -1,23 +0,0 @@
-/** \file chattr.h
- *  \brief Header: chattr command
- */
-
-#ifndef MC__CHATTR_H
-#define MC__CHATTR_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chattr_cmd (void);
-const char *chattr_get_as_str (unsigned long attr);
-
-/*** inline functions ****************************************************************************/
-
-#endif /* MC__CHATTR_H */
diff --git a/src/filemanager/chmod.c b/src/filemanager/chmod.c
index 5a56563ec..26fb846cd 100644
--- a/src/filemanager/chmod.c
+++ b/src/filemanager/chmod.c
@@ -42,7 +42,7 @@
 
 #include "midnight.h"           /* current_panel */
 
-#include "chmod.h"
+#include "cmd.h"                /* chmod_cmd() */
 
 /*** global variables ****************************************************************************/
 
diff --git a/src/filemanager/chmod.h b/src/filemanager/chmod.h
deleted file mode 100644
index 7b6d833d5..000000000
--- a/src/filemanager/chmod.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file chmod.h
- *  \brief Header: chmod command
- */
-
-#ifndef MC__CHMOD_H
-#define MC__CHMOD_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chmod_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__CHMOD_H */
diff --git a/src/filemanager/chown.c b/src/filemanager/chown.c
index 6ea428cd5..e7b104a06 100644
--- a/src/filemanager/chown.c
+++ b/src/filemanager/chown.c
@@ -47,7 +47,7 @@
 #include "src/setup.h"          /* panels_options */
 #include "midnight.h"           /* current_panel */
 
-#include "chown.h"
+#include "cmd.h"                /* chown_cmd() */
 
 /*** global variables ****************************************************************************/
 
diff --git a/src/filemanager/chown.h b/src/filemanager/chown.h
deleted file mode 100644
index ba86ec4d6..000000000
--- a/src/filemanager/chown.h
+++ /dev/null
@@ -1,21 +0,0 @@
-/** \file chown.h
- *  \brief Header: chown command
- */
-
-#ifndef MC__CHOWN_H
-#define MC__CHOWN_H
-
-/*** typedefs(not structures) and defined constants **********************************************/
-
-/*** enums ***************************************************************************************/
-
-/*** structures declarations (and typedefs of structures)*****************************************/
-
-/*** global variables defined in .c file *********************************************************/
-
-/*** declarations of public functions ************************************************************/
-
-void chown_cmd (void);
-
-/*** inline functions ****************************************************************************/
-#endif /* MC__CHOWN_H */
diff --git a/src/filemanager/cmd.c b/src/filemanager/cmd.c
index 2b35f6783..7daf7b763 100644
--- a/src/filemanager/cmd.c
+++ b/src/filemanager/cmd.c
@@ -124,10 +124,10 @@ static const char *machine_str = N_("Enter machine name (F1 for details):");
 /* --------------------------------------------------------------------------------------------- */
 /**
  * Run viewer (internal or external) on the currently selected file.
- * If normal is TRUE, force internal viewer and raw mode (used for F13).
+ * If @plain_view is TRUE, force internal viewer and raw mode (used for F13).
  */
 static void
-do_view_cmd (gboolean normal)
+do_view_cmd (gboolean plain_view)
 {
     /* Directories are viewed by changing to them */
     if (S_ISDIR (selection (current_panel)->st.st_mode) || link_isdir (selection (current_panel)))
@@ -151,7 +151,7 @@ do_view_cmd (gboolean normal)
 
         file_idx = current_panel->selected;
         filename_vpath = vfs_path_from_str (current_panel->dir.list[file_idx].fname);
-        view_file (filename_vpath, normal, use_internal_view);
+        view_file (filename_vpath, plain_view, use_internal_view);
         vfs_path_free (filename_vpath);
     }
 
@@ -1275,7 +1275,7 @@ help_cmd (void)
 {
     ev_help_t event_data = { NULL, NULL };
 
-    if (current_panel->searching)
+    if (current_panel->quick_search.active)
         event_data.node = "[Quick search]";
     else
         event_data.node = "[main]";
@@ -1415,7 +1415,7 @@ single_dirsize_cmd (void)
         status_msg_init (STATUS_MSG (&dsm), _("Directory scanning"), 0, dirsize_status_init_cb,
                          dirsize_status_update_cb, dirsize_status_deinit_cb);
 
-        if (compute_dir_size (p, &dsm, &dir_count, &count, &total, TRUE) == FILE_CONT)
+        if (compute_dir_size (p, &dsm, &dir_count, &count, &total, FALSE) == FILE_CONT)
         {
             entry->st.st_size = (off_t) total;
             entry->f.dir_size_computed = 1;
@@ -1434,7 +1434,7 @@ single_dirsize_cmd (void)
     if (current_panel->sort_field->sort_routine == (GCompareFunc) sort_size)
         panel_re_sort (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1462,7 +1462,7 @@ dirsizes_cmd (void)
             gboolean ok;
 
             p = vfs_path_from_str (panel->dir.list[i].fname);
-            ok = compute_dir_size (p, &dsm, &dir_count, &count, &total, TRUE) != FILE_CONT;
+            ok = compute_dir_size (p, &dsm, &dir_count, &count, &total, FALSE) != FILE_CONT;
             vfs_path_free (p);
             if (ok)
                 break;
@@ -1478,7 +1478,7 @@ dirsizes_cmd (void)
     if (current_panel->sort_field->sort_routine == (GCompareFunc) sort_size)
         panel_re_sort (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/cmd.h b/src/filemanager/cmd.h
index 9c77084e0..becc4782d 100644
--- a/src/filemanager/cmd.h
+++ b/src/filemanager/cmd.h
@@ -46,7 +46,7 @@ void dirsizes_cmd (void);
 gboolean view_file_at_line (const vfs_path_t * filename_vpath, gboolean plain_view,
                             gboolean internal, long start_line, off_t search_start,
                             off_t search_end);
-gboolean view_file (const vfs_path_t * filename_vpath, gboolean normal, gboolean internal);
+gboolean view_file (const vfs_path_t * filename_vpath, gboolean plain_view, gboolean internal);
 void view_cmd (void);
 void view_file_cmd (void);
 void view_raw_cmd (void);
@@ -91,6 +91,17 @@ void quick_view_cmd (void);
 #ifdef HAVE_CHARSET
 void encoding_cmd (void);
 #endif
+/* achown.c */
+void advanced_chown_cmd (void);
+/* chmod.c */
+void chmod_cmd (void);
+/* chown.c */
+void chown_cmd (void);
+#ifdef ENABLE_EXT2FS_ATTR
+/* chattr.c */
+void chattr_cmd (void);
+const char *chattr_get_as_str (unsigned long attr);
+#endif
 /* find.c */
 void find_cmd (void);
 
diff --git a/src/filemanager/dir.c b/src/filemanager/dir.c
index 9eec072d9..92b616668 100644
--- a/src/filemanager/dir.c
+++ b/src/filemanager/dir.c
@@ -393,7 +393,7 @@ sort_time (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_mtime < b->st.st_mtime ? -1 : a->st.st_mtime > b->st.st_mtime;
+        int result = _GL_CMP (a->st.st_mtime, b->st.st_mtime);
 
         if (result != 0)
             return result * reverse;
@@ -414,7 +414,7 @@ sort_ctime (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_ctime < b->st.st_ctime ? -1 : a->st.st_ctime > b->st.st_ctime;
+        int result = _GL_CMP (a->st.st_ctime, b->st.st_ctime);
 
         if (result != 0)
             return result * reverse;
@@ -435,7 +435,7 @@ sort_atime (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_atime < b->st.st_atime ? -1 : a->st.st_atime > b->st.st_atime;
+        int result = _GL_CMP (a->st.st_atime, b->st.st_atime);
 
         if (result != 0)
             return result * reverse;
@@ -470,7 +470,7 @@ sort_size (file_entry_t * a, file_entry_t * b)
 
     if (ad == bd || panels_options.mix_all_files)
     {
-        int result = a->st.st_size < b->st.st_size ? -1 : a->st.st_size > b->st.st_size;
+        int result = _GL_CMP (a->st.st_size, b->st.st_size);
 
         if (result != 0)
             return result * reverse;
diff --git a/src/filemanager/ext.c b/src/filemanager/ext.c
index 8b00c0d9e..4e1520050 100644
--- a/src/filemanager/ext.c
+++ b/src/filemanager/ext.c
@@ -71,9 +71,9 @@
 /*** file scope macro definitions ****************************************************************/
 
 #ifdef FILE_L
-#define FILE_CMD "file -L "
+#define FILE_CMD "file -L -z "
 #else
-#define FILE_CMD "file "
+#define FILE_CMD "file -z "
 #endif
 
 /*** file scope type declarations ****************************************************************/
diff --git a/src/filemanager/file.c b/src/filemanager/file.c
index 4c4b20c38..b9833de1d 100644
--- a/src/filemanager/file.c
+++ b/src/filemanager/file.c
@@ -614,7 +614,7 @@ make_symlink (file_op_context_t * ctx, const char *src_path, const char *dst_pat
 static FileProgressStatus
 do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * dsm,
                      size_t * dir_count, size_t * ret_marked, uintmax_t * ret_total,
-                     gboolean compute_symlinks)
+                     mc_stat_fn stat_func)
 {
     static guint64 timestamp = 0;
     /* update with 25 FPS rate */
@@ -627,21 +627,6 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
     struct dirent *dirent;
     FileProgressStatus ret = FILE_CONT;
 
-    if (!compute_symlinks)
-    {
-        res = mc_lstat (dirname_vpath, &s);
-        if (res != 0)
-            return ret;
-
-        /* don't scan symlink to directory */
-        if (S_ISLNK (s.st_mode))
-        {
-            (*ret_marked)++;
-            *ret_total += (uintmax_t) s.st_size;
-            return ret;
-        }
-    }
-
     (*dir_count)++;
 
     dir = mc_opendir (dirname_vpath);
@@ -657,13 +642,13 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
 
         tmp_vpath = vfs_path_append_new (dirname_vpath, dirent->d_name, (char *) NULL);
 
-        res = mc_lstat (tmp_vpath, &s);
+        res = stat_func (tmp_vpath, &s);
         if (res == 0)
         {
             if (S_ISDIR (s.st_mode))
                 ret =
                     do_compute_dir_size (tmp_vpath, dsm, dir_count, ret_marked, ret_total,
-                                         compute_symlinks);
+                                         stat_func);
             else
             {
                 ret = FILE_CONT;
@@ -700,27 +685,29 @@ do_compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * ds
 
 static FileProgressStatus
 panel_compute_totals (const WPanel * panel, dirsize_status_msg_t * sm, size_t * ret_count,
-                      uintmax_t * ret_total, gboolean compute_symlinks)
+                      uintmax_t * ret_total, gboolean follow_symlinks)
 {
     int i;
     size_t dir_count = 0;
+    mc_stat_fn stat_func = follow_symlinks ? mc_stat : mc_lstat;
 
     for (i = 0; i < panel->dir.len; i++)
     {
-        struct stat *s;
+        const file_entry_t *fe = &panel->dir.list[i];
+        const struct stat *s;
 
-        if (!panel->dir.list[i].f.marked)
+        if (fe->f.marked == 0)
             continue;
 
-        s = &panel->dir.list[i].st;
+        s = &fe->st;
 
-        if (S_ISDIR (s->st_mode))
+        if (S_ISDIR (s->st_mode) || (follow_symlinks && link_isdir (fe) && fe->f.stale_link == 0))
         {
             vfs_path_t *p;
             FileProgressStatus status;
 
-            p = vfs_path_append_new (panel->cwd_vpath, panel->dir.list[i].fname, (char *) NULL);
-            status = compute_dir_size (p, sm, &dir_count, ret_count, ret_total, compute_symlinks);
+            p = vfs_path_append_new (panel->cwd_vpath, fe->fname, (char *) NULL);
+            status = do_compute_dir_size (p, sm, &dir_count, ret_count, ret_total, stat_func);
             vfs_path_free (p);
 
             if (status != FILE_CONT)
@@ -754,6 +741,7 @@ panel_operate_init_totals (const WPanel * panel, const vfs_path_t * source,
     if (verbose && compute_totals)
     {
         dirsize_status_msg_t dsm;
+        gboolean stale_link = FALSE;
 
         memset (&dsm, 0, sizeof (dsm));
         dsm.allow_skip = TRUE;
@@ -766,12 +754,15 @@ panel_operate_init_totals (const WPanel * panel, const vfs_path_t * source,
         if (source == NULL)
             status = panel_compute_totals (panel, &dsm, &ctx->progress_count, &ctx->progress_bytes,
                                            ctx->follow_links);
-        else if (S_ISDIR (source_stat->st_mode))
+        else if (S_ISDIR (source_stat->st_mode)
+                 || (ctx->follow_links
+                     && file_is_symlink_to_dir (source, (struct stat *) source_stat, &stale_link)
+                     && !stale_link))
         {
             size_t dir_count = 0;
 
-            status = compute_dir_size (source, &dsm, &dir_count, &ctx->progress_count,
-                                       &ctx->progress_bytes, ctx->follow_links);
+            status = do_compute_dir_size (source, &dsm, &dir_count, &ctx->progress_count,
+                                          &ctx->progress_bytes, ctx->stat_func);
         }
         else
         {
@@ -3183,7 +3174,7 @@ dirsize_status_deinit_cb (status_msg_t * sm)
 
     /* schedule to update passive panel */
     if (get_other_type () == view_listing)
-        other_panel->dirty = 1;
+        other_panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -3196,10 +3187,10 @@ dirsize_status_deinit_cb (status_msg_t * sm)
 FileProgressStatus
 compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * sm,
                   size_t * ret_dir_count, size_t * ret_marked_count, uintmax_t * ret_total,
-                  gboolean compute_symlinks)
+                  gboolean follow_symlinks)
 {
     return do_compute_dir_size (dirname_vpath, sm, ret_dir_count, ret_marked_count, ret_total,
-                                compute_symlinks);
+                                follow_symlinks ? mc_stat : mc_lstat);
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/file.h b/src/filemanager/file.h
index f54f5415c..ae12e1572 100644
--- a/src/filemanager/file.h
+++ b/src/filemanager/file.h
@@ -62,7 +62,7 @@ FileProgressStatus file_error (gboolean allow_retry, const char *format, const c
 /* return value is FILE_CONT or FILE_ABORT */
 FileProgressStatus compute_dir_size (const vfs_path_t * dirname_vpath, dirsize_status_msg_t * sm,
                                      size_t * ret_dir_count, size_t * ret_marked_count,
-                                     uintmax_t * ret_total, gboolean compute_symlinks);
+                                     uintmax_t * ret_total, gboolean follow_symlinks);
 
 void dirsize_status_init_cb (status_msg_t * sm);
 int dirsize_status_update_cb (status_msg_t * sm);
diff --git a/src/filemanager/find.c b/src/filemanager/find.c
index 490d8d2e2..b7506bf7d 100644
--- a/src/filemanager/find.c
+++ b/src/filemanager/find.c
@@ -36,7 +36,6 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/stat.h>
-#include <sys/time.h>
 
 #include "lib/global.h"
 
@@ -155,7 +154,7 @@ static unsigned long matches;   /* Number of matches */
 static gboolean is_start = FALSE;       /* Status of the start/stop toggle button */
 static char *old_dir = NULL;
 
-static struct timeval last_refresh;
+static gint64 last_refresh;
 
 /* Where did we stop */
 static gboolean resuming;
@@ -992,9 +991,7 @@ search_content (WDialog * h, const char *directory, const char *filename)
     int file_fd;
     gboolean ret_val = FALSE;
     vfs_path_t *vpath;
-    struct timeval tv;
-    time_t seconds;
-    suseconds_t useconds;
+    gint64 tv;
     gboolean status_updated = FALSE;
 
     vpath = vfs_path_build_filename (directory, filename, (char *) NULL);
@@ -1012,21 +1009,9 @@ search_content (WDialog * h, const char *directory, const char *filename)
         return FALSE;
 
     /* get time elapsed from last refresh */
-    if (gettimeofday (&tv, NULL) == -1)
-    {
-        tv.tv_sec = 0;
-        tv.tv_usec = 0;
-        last_refresh = tv;
-    }
-    seconds = tv.tv_sec - last_refresh.tv_sec;
-    useconds = tv.tv_usec - last_refresh.tv_usec;
-    if (useconds < 0)
-    {
-        seconds--;
-        useconds += G_USEC_PER_SEC;
-    }
+    tv = g_get_real_time ();
 
-    if (s.st_size >= MIN_REFRESH_FILE_SIZE || seconds > 0 || useconds > MAX_REFRESH_INTERVAL)
+    if (s.st_size >= MIN_REFRESH_FILE_SIZE || (tv - last_refresh) > MAX_REFRESH_INTERVAL)
     {
         g_snprintf (buffer, sizeof (buffer), _("Grepping in %s"), filename);
         status_update (str_trunc (buffer, WIDGET (h)->cols - 8));
@@ -1898,8 +1883,7 @@ find_cmd (void)
 
         if (find_pattern[0] != '\0')
         {
-            last_refresh.tv_sec = 0;
-            last_refresh.tv_usec = 0;
+            last_refresh = 0;
 
             is_start = FALSE;
 
diff --git a/src/filemanager/info.c b/src/filemanager/info.c
index be1c66817..b981b85d0 100644
--- a/src/filemanager/info.c
+++ b/src/filemanager/info.c
@@ -54,7 +54,7 @@
 #include "layout.h"
 #include "mountlist.h"
 #ifdef ENABLE_EXT2FS_ATTR
-#include "chattr.h"
+#include "cmd.h"                /* chattr_get_as_str() */
 #endif
 
 #include "info.h"
diff --git a/src/filemanager/layout.c b/src/filemanager/layout.c
index dfffa96f5..f5df9f7bf 100644
--- a/src/filemanager/layout.c
+++ b/src/filemanager/layout.c
@@ -1277,8 +1277,8 @@ swap_panels (void)
         panelswap (dir_stat);
 #undef panelswap
 
-        panel1->searching = FALSE;
-        panel2->searching = FALSE;
+        panel1->quick_search.active = FALSE;
+        panel2->quick_search.active = FALSE;
 
         if (current_panel == panel1)
             current_panel = panel2;
@@ -1309,18 +1309,18 @@ swap_panels (void)
 
         if (panels[0].type == view_listing)
         {
-            if (strcmp (panel1->panel_name, get_nth_panel_name (0)) == 0)
+            if (strcmp (panel1->name, get_nth_panel_name (0)) == 0)
             {
-                g_free (panel1->panel_name);
-                panel1->panel_name = g_strdup (get_nth_panel_name (1));
+                g_free (panel1->name);
+                panel1->name = g_strdup (get_nth_panel_name (1));
             }
         }
         if (panels[1].type == view_listing)
         {
-            if (strcmp (panel2->panel_name, get_nth_panel_name (1)) == 0)
+            if (strcmp (panel2->name, get_nth_panel_name (1)) == 0)
             {
-                g_free (panel2->panel_name);
-                panel2->panel_name = g_strdup (get_nth_panel_name (0));
+                g_free (panel2->name);
+                panel2->name = g_strdup (get_nth_panel_name (0));
             }
         }
 
@@ -1498,7 +1498,11 @@ load_prompt (int fd, void *unused)
     (void) fd;
     (void) unused;
 
-    do_load_prompt ();
+    if (should_read_new_subshell_prompt)
+        do_load_prompt ();
+    else
+        flush_subshell (0, QUIETLY);
+
     return 0;
 }
 #endif /* ENABLE_SUBSHELL */
diff --git a/src/filemanager/midnight.c b/src/filemanager/midnight.c
index 9d68c0206..36461b260 100644
--- a/src/filemanager/midnight.c
+++ b/src/filemanager/midnight.c
@@ -75,13 +75,6 @@
 #include "command.h"            /* cmdline */
 #include "dir.h"                /* dir_list_clean() */
 
-#include "chmod.h"
-#include "chown.h"
-#include "achown.h"
-#ifdef ENABLE_EXT2FS_ATTR
-#include "chattr.h"
-#endif
-
 #ifdef USE_INTERNAL_EDIT
 #include "src/editor/edit.h"
 #endif
@@ -390,7 +383,7 @@ menu_cmd (void)
 {
     int selected;
 
-    if ((get_current_index () == 0) == (current_panel->active != 0))
+    if ((get_current_index () == 0) == current_panel->active)
         selected = 0;
     else
         selected = g_list_length (the_menubar->menu) - 1;
@@ -1029,7 +1022,7 @@ show_editor_viewer_history (void)
 
         case CK_View:
             s_vpath = vfs_path_from_str (s);
-            view_file (s_vpath, use_internal_view, 0);
+            view_file (s_vpath, use_internal_view, FALSE);
             break;
 
         default:
@@ -1104,7 +1097,7 @@ quit_cmd (void)
 
 /**
  * Repaint the contents of the panels without frames.  To schedule panel
- * for repainting, set panel->dirty to 1.  There are many reasons why
+ * for repainting, set panel->dirty to TRUE.  There are many reasons why
  * the panels need to be repainted, and this is a costly operation, so
  * it's done once per event.
  */
@@ -1460,7 +1453,7 @@ is_cmdline_mute (void)
        it's activity. Thus, we can't use get_current_type() here.
        current_panel should point to actualy current active panel
        independently of it's type. */
-    return (current_panel->active == 0
+    return (!current_panel->active
             && (get_other_type () == view_quick || get_other_type () == view_tree));
 }
 
@@ -1558,7 +1551,7 @@ midnight_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
 
         if ((!mc_global.tty.alternate_plus_minus
              || !(mc_global.tty.console_flag != '\0' || mc_global.tty.xterm_flag)) && !quote
-            && !current_panel->searching)
+            && !current_panel->quick_search.active)
         {
             if (!only_leading_plus_minus)
             {
@@ -1594,9 +1587,9 @@ midnight_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void
         return MSG_NOT_HANDLED;
 
     case MSG_HOTKEY_HANDLED:
-        if ((get_current_type () == view_listing) && current_panel->searching)
+        if ((get_current_type () == view_listing) && current_panel->quick_search.active)
         {
-            current_panel->dirty = 1;   /* FIXME: unneeded? */
+            current_panel->dirty = TRUE;        /* FIXME: unneeded? */
             send_message (current_panel, NULL, MSG_ACTION, CK_SearchStop, NULL);
         }
         return MSG_HANDLED;
diff --git a/src/filemanager/mountlist.c b/src/filemanager/mountlist.c
index ae83b329f..cf0513070 100644
--- a/src/filemanager/mountlist.c
+++ b/src/filemanager/mountlist.c
@@ -1430,14 +1430,9 @@ get_fs_usage (char const *file, char const *disk, struct fs_usage *fsp)
         /* Empirically, the block counts on most SVR3 and SVR3-derived
            systems seem to always be in terms of 512-byte blocks,
            no matter what value f_bsize has.  */
-#if defined _CRAY
-        fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_bsize);
-#else
         fsp->fsu_blocksize = 512;
 #endif
 
-#endif
-
 #if (defined STAT_STATVFS64 || defined STAT_STATFS3_OSF1 \
      || defined STAT_STATFS2_FRSIZE || defined STAT_STATFS2_BSIZE \
      || defined STAT_STATFS2_FSIZE || defined STAT_STATFS4)
diff --git a/src/filemanager/panel.c b/src/filemanager/panel.c
index b4535e968..c74247aea 100644
--- a/src/filemanager/panel.c
+++ b/src/filemanager/panel.c
@@ -990,11 +990,11 @@ display_mini_info (WPanel * panel)
 
     widget_gotoyx (w, panel_lines (panel) + 3, 1);
 
-    if (panel->searching)
+    if (panel->quick_search.active)
     {
         tty_setcolor (INPUT_COLOR);
         tty_print_char ('/');
-        tty_print_string (str_fit_to_term (panel->search_buffer, w->cols - 3, J_LEFT));
+        tty_print_string (str_fit_to_term (panel->quick_search.buffer, w->cols - 3, J_LEFT));
         return;
     }
 
@@ -1399,9 +1399,9 @@ panel_save_name (WPanel * panel)
 {
     /* If the program is shuting down */
     if ((mc_global.midnight_shutdown && auto_save_setup) || saving_setup)
-        return g_strdup (panel->panel_name);
+        return g_strdup (panel->name);
 
-    return g_strconcat ("Temporal:", panel->panel_name, (char *) NULL);
+    return g_strconcat ("Temporal:", panel->name, (char *) NULL);
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1412,8 +1412,8 @@ directory_history_add (WPanel * panel, const vfs_path_t * vpath)
     char *tmp;
 
     tmp = vfs_path_to_str_flags (vpath, 0, VPF_STRIP_PASSWORD);
-    panel->dir_history = list_append_unique (panel->dir_history, tmp);
-    panel->dir_history_current = panel->dir_history;
+    panel->dir_history.list = list_append_unique (panel->dir_history.list, tmp);
+    panel->dir_history.current = panel->dir_history.list;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1432,9 +1432,9 @@ panel_load_history (const gchar * event_group_name, const gchar * event_name,
     if (ev->receiver == NULL || ev->receiver == WIDGET (p))
     {
         if (ev->cfg != NULL)
-            p->dir_history = mc_config_history_load (ev->cfg, p->hist_name);
+            p->dir_history.list = mc_config_history_load (ev->cfg, p->dir_history.name);
         else
-            p->dir_history = mc_config_history_get (p->hist_name);
+            p->dir_history.list = mc_config_history_get (p->dir_history.name);
 
         directory_history_add (p, p->cwd_vpath);
     }
@@ -1454,11 +1454,11 @@ panel_save_history (const gchar * event_group_name, const gchar * event_name,
     (void) event_group_name;
     (void) event_name;
 
-    if (p->dir_history != NULL)
+    if (p->dir_history.list != NULL)
     {
         ev_history_load_save_t *ev = (ev_history_load_save_t *) data;
 
-        mc_config_history_save (ev->cfg, p->hist_name, p->dir_history);
+        mc_config_history_save (ev->cfg, p->dir_history.name, p->dir_history.list);
     }
 
     return TRUE;
@@ -1483,13 +1483,13 @@ panel_destroy (WPanel * p)
     panel_clean_dir (p);
 
     /* clean history */
-    if (p->dir_history != NULL)
+    if (p->dir_history.list != NULL)
     {
         /* directory history is already saved before this moment */
-        p->dir_history = g_list_first (p->dir_history);
-        g_list_free_full (p->dir_history, g_free);
+        p->dir_history.list = g_list_first (p->dir_history.list);
+        g_list_free_full (p->dir_history.list, g_free);
     }
-    g_free (p->hist_name);
+    g_free (p->dir_history.name);
 
     g_slist_free_full (p->format, (GDestroyNotify) format_item_free);
     g_slist_free_full (p->status_format, (GDestroyNotify) format_item_free);
@@ -1499,7 +1499,7 @@ panel_destroy (WPanel * p)
         g_free (p->user_status_format[i]);
 
     g_free (p->dir.list);
-    g_free (p->panel_name);
+    g_free (p->name);
 
     vfs_path_free (p->lwd_vpath);
     vfs_path_free (p->cwd_vpath);
@@ -1834,7 +1834,7 @@ use_display_format (WPanel * panel, const char *format, char **error, gboolean i
     if (*error != NULL)
         return NULL;
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     usable_columns = WIDGET (panel)->cols - 2;
     /* Status needn't to be split */
@@ -2634,47 +2634,48 @@ do_search (WPanel * panel, int c_code)
     char *reg_exp, *esc_str;
     gboolean is_found = FALSE;
 
-    l = strlen (panel->search_buffer);
+    l = strlen (panel->quick_search.buffer);
     if (c_code == KEY_BACKSPACE)
     {
         if (l != 0)
         {
-            act = panel->search_buffer + l;
-            str_prev_noncomb_char (&act, panel->search_buffer);
+            act = panel->quick_search.buffer + l;
+            str_prev_noncomb_char (&act, panel->quick_search.buffer);
             act[0] = '\0';
         }
-        panel->search_chpoint = 0;
+        panel->quick_search.chpoint = 0;
     }
     else
     {
-        if (c_code != 0 && (gsize) panel->search_chpoint < sizeof (panel->search_char))
+        if (c_code != 0 && (gsize) panel->quick_search.chpoint < sizeof (panel->quick_search.ch))
         {
-            panel->search_char[panel->search_chpoint] = c_code;
-            panel->search_chpoint++;
+            panel->quick_search.ch[panel->quick_search.chpoint] = c_code;
+            panel->quick_search.chpoint++;
         }
 
-        if (panel->search_chpoint > 0)
+        if (panel->quick_search.chpoint > 0)
         {
-            switch (str_is_valid_char (panel->search_char, panel->search_chpoint))
+            switch (str_is_valid_char (panel->quick_search.ch, panel->quick_search.chpoint))
             {
             case -2:
                 return;
             case -1:
-                panel->search_chpoint = 0;
+                panel->quick_search.chpoint = 0;
                 return;
             default:
-                if (l + panel->search_chpoint < sizeof (panel->search_buffer))
+                if (l + panel->quick_search.chpoint < sizeof (panel->quick_search.buffer))
                 {
-                    memcpy (panel->search_buffer + l, panel->search_char, panel->search_chpoint);
-                    l += panel->search_chpoint;
-                    panel->search_buffer[l] = '\0';
-                    panel->search_chpoint = 0;
+                    memcpy (panel->quick_search.buffer + l, panel->quick_search.ch,
+                            panel->quick_search.chpoint);
+                    l += panel->quick_search.chpoint;
+                    panel->quick_search.buffer[l] = '\0';
+                    panel->quick_search.chpoint = 0;
                 }
             }
         }
     }
 
-    reg_exp = g_strdup_printf ("%s*", panel->search_buffer);
+    reg_exp = g_strdup_printf ("%s*", panel->quick_search.buffer);
     esc_str = strutils_escape (reg_exp, -1, ",|\\{}[]", TRUE);
     search = mc_search_new (esc_str, NULL);
     search->search_type = MC_SEARCH_T_GLOB;
@@ -2720,8 +2721,8 @@ do_search (WPanel * panel, int c_code)
     }
     else if (c_code != KEY_BACKSPACE)
     {
-        act = panel->search_buffer + l;
-        str_prev_noncomb_char (&act, panel->search_buffer);
+        act = panel->quick_search.buffer + l;
+        str_prev_noncomb_char (&act, panel->quick_search.buffer);
         act[0] = '\0';
     }
     mc_search_free (search);
@@ -2737,7 +2738,7 @@ do_search (WPanel * panel, int c_code)
 static void
 start_search (WPanel * panel)
 {
-    if (panel->searching)
+    if (panel->quick_search.active)
     {
         if (panel->selected == panel->dir.len - 1)
             panel->selected = 0;
@@ -2746,18 +2747,18 @@ start_search (WPanel * panel)
 
         /* in case if there was no search string we need to recall
            previous string, with which we ended previous searching */
-        if (panel->search_buffer[0] == '\0')
-            g_strlcpy (panel->search_buffer, panel->prev_search_buffer,
-                       sizeof (panel->search_buffer));
+        if (panel->quick_search.buffer[0] == '\0')
+            g_strlcpy (panel->quick_search.buffer, panel->quick_search.prev_buffer,
+                       sizeof (panel->quick_search.buffer));
 
         do_search (panel, 0);
     }
     else
     {
-        panel->searching = TRUE;
-        panel->search_buffer[0] = '\0';
-        panel->search_char[0] = '\0';
-        panel->search_chpoint = 0;
+        panel->quick_search.active = TRUE;
+        panel->quick_search.buffer[0] = '\0';
+        panel->quick_search.ch[0] = '\0';
+        panel->quick_search.chpoint = 0;
         display_mini_info (panel);
         mc_refresh ();
     }
@@ -2768,13 +2769,13 @@ start_search (WPanel * panel)
 static void
 stop_search (WPanel * panel)
 {
-    panel->searching = FALSE;
+    panel->quick_search.active = FALSE;
 
-    /* if user had overrdied search string, we need to store it
-       to the previous_search_buffer */
-    if (panel->search_buffer[0] != '\0')
-        g_strlcpy (panel->prev_search_buffer, panel->search_buffer,
-                   sizeof (panel->prev_search_buffer));
+    /* if user overrdied search string, we need to store it
+       to the quick_search.prev_buffer */
+    if (panel->quick_search.buffer[0] != '\0')
+        g_strlcpy (panel->quick_search.prev_buffer, panel->quick_search.buffer,
+                   sizeof (panel->quick_search.prev_buffer));
 
     display_mini_info (panel);
 }
@@ -3288,7 +3289,7 @@ _do_panel_cd (WPanel * panel, const vfs_path_t * new_dir_vpath, enum cd_enum cd_
     try_to_select (panel, get_parent_dir_name (panel->cwd_vpath, olddir_vpath));
 
     load_hint (FALSE);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     update_xterm_title_path ();
 
     vfs_path_free (olddir_vpath);
@@ -3308,7 +3309,7 @@ directory_history_next (WPanel * panel)
         GList *next;
 
         ok = TRUE;
-        next = g_list_next (panel->dir_history_current);
+        next = g_list_next (panel->dir_history.current);
         if (next != NULL)
         {
             vfs_path_t *data_vpath;
@@ -3316,7 +3317,7 @@ directory_history_next (WPanel * panel)
             data_vpath = vfs_path_from_str ((char *) next->data);
             ok = _do_panel_cd (panel, data_vpath, cd_exact);
             vfs_path_free (data_vpath);
-            panel->dir_history_current = next;
+            panel->dir_history.current = next;
         }
         /* skip directories that present in history but absent in file system */
     }
@@ -3335,7 +3336,7 @@ directory_history_prev (WPanel * panel)
         GList *prev;
 
         ok = TRUE;
-        prev = g_list_previous (panel->dir_history_current);
+        prev = g_list_previous (panel->dir_history.current);
         if (prev != NULL)
         {
             vfs_path_t *data_vpath;
@@ -3343,7 +3344,7 @@ directory_history_prev (WPanel * panel)
             data_vpath = vfs_path_from_str ((char *) prev->data);
             ok = _do_panel_cd (panel, data_vpath, cd_exact);
             vfs_path_free (data_vpath);
-            panel->dir_history_current = prev;
+            panel->dir_history.current = prev;
         }
         /* skip directories that present in history but absent in file system */
     }
@@ -3359,13 +3360,13 @@ directory_history_list (WPanel * panel)
     gboolean ok = FALSE;
     size_t pos;
 
-    pos = g_list_position (panel->dir_history_current, panel->dir_history);
+    pos = g_list_position (panel->dir_history.current, panel->dir_history.list);
 
-    history_descriptor_init (&hd, WIDGET (panel)->y, WIDGET (panel)->x, panel->dir_history,
+    history_descriptor_init (&hd, WIDGET (panel)->y, WIDGET (panel)->x, panel->dir_history.list,
                              (int) pos);
     history_show (&hd);
 
-    panel->dir_history = hd.list;
+    panel->dir_history.list = hd.list;
     if (hd.text != NULL)
     {
         vfs_path_t *s_vpath;
@@ -3387,17 +3388,17 @@ directory_history_list (WPanel * panel)
 
         size_t i;
 
-        panel->dir_history_current = panel->dir_history;
+        panel->dir_history.current = panel->dir_history.list;
 
         for (i = 0; i <= pos; i++)
         {
             GList *prev;
 
-            prev = g_list_previous (panel->dir_history_current);
+            prev = g_list_previous (panel->dir_history.current);
             if (prev == NULL)
                 break;
 
-            panel->dir_history_current = prev;
+            panel->dir_history.current = prev;
         }
     }
 }
@@ -3601,7 +3602,7 @@ panel_key (WPanel * panel, int key)
         return MSG_HANDLED;
     }
 
-    if (panel->searching && ((key >= ' ' && key <= 255) || key == KEY_BACKSPACE))
+    if (panel->quick_search.active && ((key >= ' ' && key <= 255) || key == KEY_BACKSPACE))
     {
         do_search (panel, key);
         return MSG_HANDLED;
@@ -3654,13 +3655,13 @@ panel_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
         paint_dir (panel);
         mini_info_separator (panel);
         display_mini_info (panel);
-        panel->dirty = 0;
+        panel->dirty = FALSE;
         return MSG_HANDLED;
 
     case MSG_FOCUS:
         state_mark = -1;
         current_panel = panel;
-        panel->active = 1;
+        panel->active = TRUE;
 
         if (mc_chdir (panel->cwd_vpath) != 0)
         {
@@ -3685,7 +3686,7 @@ panel_callback (Widget * w, Widget * sender, widget_msg_t msg, int parm, void *d
     case MSG_UNFOCUS:
         /* Janne: look at this for the multiple panel options */
         stop_search (panel);
-        panel->active = 0;
+        panel->active = FALSE;
         unselect_item (panel);
         return MSG_HANDLED;
 
@@ -3870,7 +3871,7 @@ panel_mouse_callback (Widget * w, mouse_msg_t msg, mouse_event_t * event)
                 /* no other events on 1st line, return MOU_UNHANDLED */
                 event->result.abort = TRUE;
                 /* avoid extra panel redraw */
-                panel->dirty = 0;
+                panel->dirty = FALSE;
             }
             break;
         }
@@ -4014,7 +4015,7 @@ update_one_panel_widget (WPanel * panel, panel_update_flags_t flags, const char
         panel_reload (panel);
 
     try_to_select (panel, current_file);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     if (free_pointer)
         g_free (my_current_file);
@@ -4043,7 +4044,7 @@ do_select (WPanel * panel, int i)
 {
     if (i != panel->selected)
     {
-        panel->dirty = 1;
+        panel->dirty = TRUE;
         panel->selected = i;
         panel->top_file = panel->selected - (WIDGET (panel)->lines - 2) / 2;
         if (panel->top_file < 0)
@@ -4235,9 +4236,9 @@ panel_clean_dir (WPanel * panel)
     panel->marked = 0;
     panel->dirs_marked = 0;
     panel->total = 0;
-    panel->searching = FALSE;
+    panel->quick_search.active = FALSE;
     panel->is_panelized = FALSE;
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     panel->content_shift = -1;
     panel->max_shift = -1;
 
@@ -4310,7 +4311,7 @@ panel_sized_empty_new (const char *panel_name, int y, int x, int lines, int cols
 
     panel->list_cols = 1;
     panel->brief_cols = 2;
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     panel->content_shift = -1;
     panel->max_shift = -1;
 
@@ -4326,15 +4327,15 @@ panel_sized_empty_new (const char *panel_name, int y, int x, int lines, int cols
 
     panel->frame_size = frame_half;
 
-    panel->panel_name = g_strdup (panel_name);
-    panel->hist_name = g_strconcat ("Dir Hist ", panel->panel_name, (char *) NULL);
+    panel->name = g_strdup (panel_name);
+    panel->dir_history.name = g_strconcat ("Dir Hist ", panel->name, (char *) NULL);
     /* directories history will be get later */
 
-    section = g_strconcat ("Temporal:", panel->panel_name, (char *) NULL);
+    section = g_strconcat ("Temporal:", panel->name, (char *) NULL);
     if (!mc_config_has_group (mc_global.main_config, section))
     {
         g_free (section);
-        section = g_strdup (panel->panel_name);
+        section = g_strdup (panel->name);
     }
     panel_load_setup (panel, section);
     g_free (section);
@@ -4455,7 +4456,7 @@ panel_reload (WPanel * panel)
                           &panel->sort_info, panel->filter))
         message (D_ERROR, MSG_ERROR, _("Cannot read directory contents"));
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
     if (panel->selected >= panel->dir.len)
         do_select (panel, panel->dir.len - 1);
 
@@ -4530,7 +4531,7 @@ select_item (WPanel * panel)
 {
     adjust_top_file (panel);
 
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 
     execute_hooks (select_file_hook);
 }
@@ -4645,7 +4646,7 @@ file_mark (WPanel * panel, int lc_index, int val)
     if (panel->dir.list[lc_index].f.marked != val)
     {
         panel->dir.list[lc_index].f.marked = val;
-        panel->dirty = 1;
+        panel->dirty = TRUE;
     }
 }
 
@@ -4675,7 +4676,7 @@ panel_re_sort (WPanel * panel)
     g_free (filename);
     panel->top_file = panel->selected - panel_items (panel) / 2;
     select_item (panel);
-    panel->dirty = 1;
+    panel->dirty = TRUE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
diff --git a/src/filemanager/panel.h b/src/filemanager/panel.h
index 1055ddf05..57f4d6284 100644
--- a/src/filemanager/panel.h
+++ b/src/filemanager/panel.h
@@ -90,51 +90,63 @@ typedef struct
 typedef struct
 {
     Widget widget;
+
+    char *name;                 /* The panel name */
+
+    panel_display_t frame_size; /* half or full frame */
+
+    gboolean active;            /* If panel is currently selected */
+    gboolean dirty;             /* Should we redisplay the panel? */
+    gboolean is_panelized;      /* Flag: special filelisting, can't reload */
+
+#ifdef HAVE_CHARSET
+    int codepage;               /* Panel codepage */
+#endif
+
     dir_list dir;               /* Directory contents */
+    struct stat dir_stat;       /* Stat of current dir: used by execute () */
 
-    list_format_t list_format;  /* listing type */
-    int active;                 /* If panel is currently selected */
     vfs_path_t *cwd_vpath;      /* Current Working Directory */
     vfs_path_t *lwd_vpath;      /* Last Working Directory */
-    GList *dir_history;         /* directory history */
-    GList *dir_history_current; /* pointer to the current history item */
-    char *hist_name;            /* directory history name for history file */
-    int marked;                 /* Count of marked files */
-    int dirs_marked;            /* Count of marked directories */
-    uintmax_t total;            /* Bytes in marked files */
-    int top_file;               /* The file showed on the top of the panel */
-    int selected;               /* Index to the selected file */
+
+    list_format_t list_format;  /* Listing type */
+    GSList *format;             /* Display format */
+    char *user_format;          /* User format */
     int list_cols;              /* Number of file list columns */
     int brief_cols;             /* Number of columns in case of list_brief format */
-    gboolean is_panelized;      /* Flag: special filelisting, can't reload */
-    panel_display_t frame_size; /* half or full frame */
-    char *filter;               /* File name filter */
-
     /* sort */
     dir_sort_options_t sort_info;
     const panel_field_t *sort_field;
 
-    int dirty;                  /* Should we redisplay the panel? */
+    int marked;                 /* Count of marked files */
+    int dirs_marked;            /* Count of marked directories */
+    uintmax_t total;            /* Bytes in marked files */
 
-    gboolean user_mini_status;  /* Is user_status_format used */
-    char *user_format;          /* User format */
-    char *user_status_format[LIST_FORMATS];     /* User format for status line */
+    int top_file;               /* The file showed on the top of the panel */
+    int selected;               /* Index to the selected file */
 
-    GSList *format;             /* Display format */
     GSList *status_format;      /* Mini status format */
+    gboolean user_mini_status;  /* Is user_status_format used */
+    char *user_status_format[LIST_FORMATS];     /* User format for status line */
 
-    char *panel_name;           /* The panel name */
-    struct stat dir_stat;       /* Stat of current dir: used by execute () */
+    char *filter;               /* File name filter */
 
-#ifdef HAVE_CHARSET
-    int codepage;               /* panel codepage */
-#endif
+    struct
+    {
+        char *name;             /* Directory history name for history file */
+        GList *list;            /* Directory history */
+        GList *current;         /* Pointer to the current history item */
+    } dir_history;
+
+    struct
+    {
+        gboolean active;
+        char buffer[MC_MAXFILENAMELEN];
+        char prev_buffer[MC_MAXFILENAMELEN];
+        char ch[MB_LEN_MAX];    /* Buffer for multi-byte character */
+        int chpoint;            /* Point after last characters in @ch */
+    } quick_search;
 
-    gboolean searching;
-    char search_buffer[MC_MAXFILENAMELEN];
-    char prev_search_buffer[MC_MAXFILENAMELEN];
-    char search_char[MB_LEN_MAX];       /*buffer for multibytes characters */
-    int search_chpoint;         /*point after last characters in search_char */
     int content_shift;          /* Number of characters of filename need to skip from left side. */
     int max_shift;              /* Max shift for visible part of current panel */
 } WPanel;
diff --git a/src/keybind-defaults.c b/src/keybind-defaults.c
index 713a400da..c423e6be4 100644
--- a/src/keybind-defaults.c
+++ b/src/keybind-defaults.c
@@ -90,7 +90,7 @@ typedef struct global_keymap_ini_t
 
 /* midnight */
 static const global_keymap_ini_t default_main_keymap[] = {
-    {"ChangePanel", "tab"},
+    {"ChangePanel", "tab; ctrl-i"},
     {"Help", "f1"},
     {"UserMenu", "f2"},
     {"View", "f3"},
diff --git a/src/setup.c b/src/setup.c
index 37618a9cd..97da20940 100644
--- a/src/setup.c
+++ b/src/setup.c
@@ -360,6 +360,7 @@ static const struct
 #endif /* USE_INTERNAL_EDIT */
     { "editor_ask_filename_before_edit", &editor_ask_filename_before_edit },
     { "nice_rotating_dash", &nice_rotating_dash },
+    { "shadows", &mc_global.tty.shadows },
     { "mcview_remember_file_position", &mcview_remember_file_position },
     { "auto_fill_mkdir_name", &auto_fill_mkdir_name },
     { "copymove_persistent_attr", &copymove_persistent_attr },
@@ -996,11 +997,11 @@ save_panel_types (void)
     type = get_panel_type (0);
     panel_save_type ("New Left Panel", type);
     if (type == view_listing)
-        panel_save_setup (left_panel, left_panel->panel_name);
+        panel_save_setup (left_panel, left_panel->name);
     type = get_panel_type (1);
     panel_save_type ("New Right Panel", type);
     if (type == view_listing)
-        panel_save_setup (right_panel, right_panel->panel_name);
+        panel_save_setup (right_panel, right_panel->name);
 
     {
         char *dirs;
diff --git a/src/setup.h b/src/setup.h
index 7de0fe393..5a430a6c8 100644
--- a/src/setup.h
+++ b/src/setup.h
@@ -73,7 +73,7 @@ struct mc_fhl_struct;
 
 /*** global variables defined in .c file *********************************************************/
 
-/* global paremeters */
+/* global parameters */
 extern char *global_profile_name;
 extern gboolean confirm_delete;
 extern gboolean confirm_directory_hotlist_delete;
diff --git a/src/subshell/common.c b/src/subshell/common.c
index 06699233c..02ae85211 100644
--- a/src/subshell/common.c
+++ b/src/subshell/common.c
@@ -9,25 +9,26 @@
    Aliaksey Kandratsenka <alk@tut.by>
    Andreas Mohr <and@gmx.li>
    Andrew Borodin <aborodin@vmail.ru>
-   Andrew Borodin <borodin@borodin.zarya>
    Andrew V. Samoilov <sav@bcs.zp.ua>
    Chris Owen <chris@candu.co.uk>
    Claes Nästén <me@pekdon.net>
    Egmont Koblinger <egmont@gmail.com>
    Enrico Weigelt, metux IT service <weigelt@metux.de>
+   Eric Roberts <ericmrobertsdeveloper@gmail.com>
    Igor Urazov <z0rc3r@gmail.com>
    Ilia Maslakov <il.smind@gmail.com>
    Leonard den Ottolander <leonard@den.ottolander.nl>
    Miguel de Icaza <miguel@novell.com>
    Mikhail S. Pobolovets <styx.mp@gmail.com>
    Norbert Warmuth <nwarmuth@privat.circular.de>
+   Oswald Buddenhagen <oswald.buddenhagen@gmx.de>
    Patrick Winnertz <winnie@debian.org>
    Pavel Machek <pavel@suse.cz>
    Pavel Roskin <proski@gnu.org>
    Pavel Tsekov <ptsekov@gmx.net>
    Roland Illig <roland.illig@gmx.de>
    Sergei Trofimovich <slyfox@inbox.ru>
-   Slava Zanko <slavazanko@gmail.com>, 2013,2015.
+   Slava Zanko <slavazanko@gmail.com>
    Timur Bakeyev <mc@bat.ru>
    Vit Rosin <vit_r@list.ru>
 
@@ -105,6 +106,9 @@
 #include "lib/util.h"
 #include "lib/widget.h"
 
+#include "src/filemanager/layout.h"     /* setup_cmdline() */
+#include "src/filemanager/command.h"    /* cmdline */
+
 #include "subshell.h"
 #include "internal.h"
 
@@ -123,6 +127,10 @@ GString *subshell_prompt = NULL;
 /* We need to paint it after CONSOLE_RESTORE, see: load_prompt */
 gboolean update_subshell_prompt = FALSE;
 
+/* If set, then a command has just finished executing, and we need */
+/* to be on the lookout for a new prompt string from the subshell. */
+gboolean should_read_new_subshell_prompt;
+
 /*** file scope macro definitions ****************************************************************/
 
 #ifndef WEXITSTATUS
@@ -151,6 +159,14 @@ enum
     WRITE = 1
 };
 
+/* This is the keybinding that is sent to the shell, to make the shell send us the contents of
+ * the current command buffer. */
+#define SHELL_BUFFER_KEYBINDING "_"
+
+/* This is the keybinding that is sent to the shell, to make the shell send us the location of
+ * the cursor. */
+#define SHELL_CURSOR_KEYBINDING "+"
+
 /*** file scope variables ************************************************************************/
 
 /* tcsh closes all non-standard file descriptors, so we have to use a pipe */
@@ -169,6 +185,9 @@ static char pty_buffer[PTY_BUFFER_SIZE] = "\0";
 /* To pass CWD info from the subshell to MC */
 static int subshell_pipe[2];
 
+/* To pass command buffer info from the subshell to MC */
+static int command_buffer_pipe[2];
+
 /* The subshell's process ID */
 static pid_t subshell_pid = 1;
 
@@ -178,6 +197,17 @@ static char subshell_cwd[MC_MAXPATHLEN + 1];
 /* Flag to indicate whether the subshell is ready for next command */
 static int subshell_ready;
 
+/* Flag to indicate if the subshell supports the persistent buffer feature. */
+static gboolean use_persistent_buffer = FALSE;
+
+/* Flag to indicate if the contents of the subshell command line need to be cleared before */
+/* executing a command. This should only end up set to true if there is some sort of error. */
+/* This allows us to recover gracefully from an error. */
+static gboolean subshell_should_clear_command_line = FALSE;
+
+/* This is the local variable where the subshell prompt is stored while we are working on it. */
+static GString *subshell_prompt_temp_buffer = NULL;
+
 /* The following two flags can be changed by the SIGCHLD handler. This is */
 /* OK, because the 'int' type is updated atomically on all known machines */
 static volatile int subshell_alive, subshell_stopped;
@@ -353,7 +383,7 @@ init_subshell_child (const char *pty_name)
 
     /* Attach all our standard file descriptors to the pty */
 
-    /* This is done just before the fork, because stderr must still      */
+    /* This is done just before the exec, because stderr must still      */
     /* be connected to the real tty during the above error messages; */
     /* otherwise the user will never see them.                   */
 
@@ -362,6 +392,10 @@ init_subshell_child (const char *pty_name)
     dup2 (subshell_pty_slave, STDERR_FILENO);
 
     close (subshell_pipe[READ]);
+
+    if (use_persistent_buffer)
+        close (command_buffer_pipe[READ]);
+
     close (subshell_pty_slave); /* These may be FD_CLOEXEC, but just in case... */
     /* Close master side of pty.  This is important; apart from */
     /* freeing up the descriptor for use in the subshell, it also       */
@@ -468,6 +502,232 @@ synchronize (void)
     /* We can't do any better without modifying the shell(s) */
 }
 
+/* --------------------------------------------------------------------------------------------- */
+/* Get the contents of the current subshell command line buffer, and */
+/* transfer the contents to the panel command prompt. */
+
+static gboolean
+read_command_line_buffer (gboolean test_mode)
+{
+    char subshell_command_buffer[BUF_LARGE];
+    char subshell_cursor_buffer[BUF_SMALL];
+
+    fd_set read_set;
+    int i;
+    ssize_t bytes;
+    struct timeval subshell_prompt_timer = { 0, 0 };
+    int command_buffer_length;
+    int command_buffer_char_length;
+    int bash_version;
+    int cursor_position;
+    int maxfdp;
+    int rc;
+
+    if (!use_persistent_buffer)
+        return TRUE;
+
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+    maxfdp = command_buffer_pipe[READ];
+
+    /* First, flush the command buffer pipe. This pipe shouldn't be written
+     * to under normal circumstances, but if it somehow does get written
+     * to, we need to make sure to discard whatever data is there before
+     * we try to use it. */
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 0)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 1)
+        {
+            bytes = read (command_buffer_pipe[READ], subshell_command_buffer,
+                          sizeof (subshell_command_buffer));
+            (void) bytes;
+        }
+    }
+
+    /* get contents of command line buffer */
+    write_all (mc_global.tty.subshell_pty, ESC_STR SHELL_BUFFER_KEYBINDING,
+               sizeof (ESC_STR SHELL_CURSOR_KEYBINDING) - 1);
+
+    subshell_prompt_timer.tv_sec = 1;
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 1)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 0)
+            return FALSE;
+    }
+
+    bytes =
+        read (command_buffer_pipe[READ], subshell_command_buffer, sizeof (subshell_command_buffer));
+    if (bytes == 0 || bytes == sizeof (subshell_command_buffer))
+        return FALSE;
+
+    command_buffer_char_length = bytes - 1;
+    subshell_command_buffer[command_buffer_char_length] = '\0';
+    command_buffer_length = str_length (subshell_command_buffer);
+
+    /* get cursor position */
+    write_all (mc_global.tty.subshell_pty, ESC_STR SHELL_CURSOR_KEYBINDING,
+               sizeof (ESC_STR SHELL_CURSOR_KEYBINDING) - 1);
+
+    subshell_prompt_timer.tv_sec = 1;
+    subshell_prompt_timer.tv_usec = 0;
+    FD_ZERO (&read_set);
+    FD_SET (command_buffer_pipe[READ], &read_set);
+
+    while ((rc = select (maxfdp + 1, &read_set, NULL, NULL, &subshell_prompt_timer)) != 1)
+    {
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+                continue;
+
+            return FALSE;
+        }
+
+        if (rc == 0)
+            return FALSE;
+    }
+
+    bytes =
+        read (command_buffer_pipe[READ], subshell_cursor_buffer, sizeof (subshell_cursor_buffer));
+    if (bytes == 0)
+        return FALSE;
+
+    subshell_cursor_buffer[bytes - 1] = '\0';
+    if (mc_global.shell->type == SHELL_BASH)
+    {
+        if (sscanf (subshell_cursor_buffer, "%d:%d", &bash_version, &cursor_position) != 2)
+            return FALSE;
+    }
+    else
+    {
+        if (sscanf (subshell_cursor_buffer, "%d", &cursor_position) != 1)
+            return FALSE;
+        bash_version = 1000;
+    }
+
+    if (test_mode)
+        return TRUE;
+
+    /* Substitute non-text characters in the command buffer, such as tab, or newline, as this
+     * could cause problems. */
+    for (i = 0; i < command_buffer_char_length; i++)
+        if ((unsigned char) subshell_command_buffer[i] < 32
+            || (unsigned char) subshell_command_buffer[i] == 127)
+            subshell_command_buffer[i] = ' ';
+
+    input_assign_text (cmdline, "");
+    input_insert (cmdline, subshell_command_buffer, FALSE);
+
+    if (bash_version < 5)       /* implies SHELL_BASH */
+    {
+        /* We need to do this because bash < v5 gives the cursor position in a utf-8 string based
+         * on the location in bytes, not in unicode characters. */
+        char *curr, *stop;
+
+        curr = subshell_command_buffer;
+        stop = curr + cursor_position;
+
+        for (cursor_position = 0; curr < stop; cursor_position++)
+            str_next_char_safe (&curr);
+    }
+    if (cursor_position > command_buffer_length)
+        cursor_position = command_buffer_length;
+    cmdline->point = cursor_position;
+    /* We send any remaining data to STDOUT before we finish. */
+    flush_subshell (0, VISIBLY);
+
+    /* Now we erase the current contents of the command line buffer */
+    if (mc_global.shell->type != SHELL_ZSH)
+    {
+        /* In zsh, we can just press c-u to clear the line, without needing to go to the end of
+         * the line first first. In all other shells, we must go to the end of the line first. */
+
+        /* If we are not at the end of the line, we go to the end. */
+        if (cursor_position != command_buffer_length)
+        {
+            write_all (mc_global.tty.subshell_pty, "\005", 1);
+            if (flush_subshell (1, VISIBLY) != 1)
+                return FALSE;
+        }
+    }
+
+    if (command_buffer_length > 0)
+    {
+        /* Now we clear the line. */
+        write_all (mc_global.tty.subshell_pty, "\025", 1);
+        if (flush_subshell (1, VISIBLY) != 1)
+            return FALSE;
+    }
+
+    return TRUE;
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+clear_subshell_prompt_string (void)
+{
+    if (subshell_prompt_temp_buffer != NULL)
+        g_string_set_size (subshell_prompt_temp_buffer, 0);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+parse_subshell_prompt_string (const char *buffer, int bytes)
+{
+    int i;
+
+    if (mc_global.mc_run_mode != MC_RUN_FULL)
+        return;
+
+    /* First time through */
+    if (subshell_prompt == NULL)
+        subshell_prompt = g_string_sized_new (INITIAL_PROMPT_SIZE);
+    if (subshell_prompt_temp_buffer == NULL)
+        subshell_prompt_temp_buffer = g_string_sized_new (INITIAL_PROMPT_SIZE);
+
+    /* Extract the prompt from the shell output */
+    for (i = 0; i < bytes; i++)
+        if (buffer[i] == '\n' || buffer[i] == '\r')
+            g_string_set_size (subshell_prompt_temp_buffer, 0);
+        else if (buffer[i] != '\0')
+            g_string_append_c (subshell_prompt_temp_buffer, buffer[i]);
+}
+
+/* --------------------------------------------------------------------------------------------- */
+
+static void
+set_prompt_string (void)
+{
+    if (mc_global.mc_run_mode != MC_RUN_FULL)
+        return;
+
+    if (subshell_prompt_temp_buffer->len != 0)
+        g_string_assign (subshell_prompt, subshell_prompt_temp_buffer->str);
+
+    setup_cmdline ();
+}
+
 /* --------------------------------------------------------------------------------------------- */
 /** Feed the subshell our keyboard input until it says it's finished */
 
@@ -481,6 +741,9 @@ feed_subshell (int how, gboolean fail_on_error)
     struct timeval wtime;       /* Maximum time we wait for the subshell */
     struct timeval *wptr;
 
+    should_read_new_subshell_prompt = FALSE;
+    subshell_should_clear_command_line = FALSE;
+
     /* we wait up to 10 seconds if fail_on_error, forever otherwise */
     wtime.tv_sec = 10;
     wtime.tv_usec = 0;
@@ -549,6 +812,9 @@ feed_subshell (int how, gboolean fail_on_error)
 
             if (how == VISIBLY)
                 write_all (STDOUT_FILENO, pty_buffer, bytes);
+
+            if (should_read_new_subshell_prompt)
+                parse_subshell_prompt_string (pty_buffer, bytes);
         }
 
         else if (FD_ISSET (subshell_pipe[READ], &read_set))
@@ -563,10 +829,12 @@ feed_subshell (int how, gboolean fail_on_error)
                 exit (EXIT_FAILURE);
             }
 
-            subshell_cwd[bytes - 1] = 0;        /* Squash the final '\n' */
+            subshell_cwd[bytes - 1] = '\0';     /* Squash the final '\n' */
 
             synchronize ();
 
+            clear_subshell_prompt_string ();
+            should_read_new_subshell_prompt = TRUE;
             subshell_ready = TRUE;
             if (subshell_state == RUNNING_COMMAND)
             {
@@ -578,6 +846,7 @@ feed_subshell (int how, gboolean fail_on_error)
         else if (FD_ISSET (STDIN_FILENO, &read_set))
             /* Read from stdin, write to the subshell */
         {
+            should_read_new_subshell_prompt = FALSE;
             bytes = read (STDIN_FILENO, pty_buffer, sizeof (pty_buffer));
             if (bytes <= 0)
             {
@@ -591,15 +860,33 @@ feed_subshell (int how, gboolean fail_on_error)
                 if (pty_buffer[i] == subshell_switch_key)
                 {
                     write_all (mc_global.tty.subshell_pty, pty_buffer, i);
+
                     if (subshell_ready)
+                    {
                         subshell_state = INACTIVE;
+                        set_prompt_string ();
+                        if (subshell_ready && !read_command_line_buffer (FALSE))
+                        {
+                            /* If we got here, some unforseen error must have occurred. */
+                            flush_subshell (0, VISIBLY);
+                            input_assign_text (cmdline, "");
+                            subshell_should_clear_command_line = TRUE;
+                        }
+                    }
+
                     return TRUE;
                 }
 
             write_all (mc_global.tty.subshell_pty, pty_buffer, bytes);
 
             if (pty_buffer[bytes - 1] == '\n' || pty_buffer[bytes - 1] == '\r')
+            {
+                /* We should only clear the command line if we are using a shell that works
+                 * with persistent command buffer, otherwise we get awkward results. */
+                if (use_persistent_buffer)
+                    input_assign_text (cmdline, "");
                 subshell_ready = FALSE;
+            }
         }
         else
             return FALSE;
@@ -784,8 +1071,13 @@ init_subshell_precmd (char *precmd, size_t buff_size)
     {
     case SHELL_BASH:
         g_snprintf (precmd, buff_size,
+                    " mc_print_command_buffer () { printf \"%%s\\\\n\" \"$READLINE_LINE\" >&%d; }\n"
+                    " bind -x '\"\\e" SHELL_BUFFER_KEYBINDING "\":\"mc_print_command_buffer\"'\n"
+                    " bind -x '\"\\e" SHELL_CURSOR_KEYBINDING
+                    "\":\"echo $BASH_VERSINFO:$READLINE_POINT >&%d\"'\n"
                     " PROMPT_COMMAND=${PROMPT_COMMAND:+$PROMPT_COMMAND\n}'pwd>&%d;kill -STOP $$'\n"
-                    "PS1='\\u@\\h:\\w\\$ '\n", subshell_pipe[WRITE]);
+                    "PS1='\\u@\\h:\\w\\$ '\n", command_buffer_pipe[WRITE],
+                    command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     case SHELL_ASH_BUSYBOX:
@@ -800,7 +1092,7 @@ init_subshell_precmd (char *precmd, size_t buff_size)
          *    "PS1='$(precmd)\\u@\\h:\\w\\$ '\n",
          *
          * C: This works if user calls "ash" command because in sub-subshell
-         *    PRECMD is unfedined, thus evaluated to empty string - no damage done.
+         *    PRECMD is undefined, thus evaluated to empty string - no damage done.
          *    Attention: BusyBox must be built with FEATURE_EDITING_FANCY_PROMPT to
          *    permit \u, \w, \h, \$ escape sequences. Unfortunately this cannot be guaranteed,
          *    especially on embedded systems where people try to save space, so let's use
@@ -844,25 +1136,33 @@ init_subshell_precmd (char *precmd, size_t buff_size)
 
     case SHELL_ZSH:
         g_snprintf (precmd, buff_size,
+                    " mc_print_command_buffer () { printf \"%%s\\\\n\" \"$BUFFER\" >&%d; }\n"
+                    " zle -N mc_print_command_buffer\n"
+                    " bindkey '^[" SHELL_BUFFER_KEYBINDING "' mc_print_command_buffer\n"
+                    " mc_print_cursor_position () { echo $CURSOR >&%d}\n"
+                    " zle -N mc_print_cursor_position\n"
+                    " bindkey '^[" SHELL_CURSOR_KEYBINDING "' mc_print_cursor_position\n"
                     " _mc_precmd(){ pwd>&%d;kill -STOP $$ }; precmd_functions+=(_mc_precmd)\n"
-                    "PS1='%%n@%%m:%%~%%# '\n", subshell_pipe[WRITE]);
+                    "PS1='%%n@%%m:%%~%%# '\n",
+                    command_buffer_pipe[WRITE], command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     case SHELL_TCSH:
         g_snprintf (precmd, buff_size,
                     "set echo_style=both; "
                     "set prompt='%%n@%%m:%%~%%# '; "
-                    "alias precmd 'echo $cwd:q >>%s; kill -STOP $$'\n", tcsh_fifo);
+                    "alias precmd 'echo -n;echo $cwd:q >>%s; kill -STOP $$'\n", tcsh_fifo);
         break;
-
     case SHELL_FISH:
         g_snprintf (precmd, buff_size,
-                    " if not functions -q fish_prompt_mc;"
+                    " bind \\e" SHELL_BUFFER_KEYBINDING " 'commandline >&%d';"
+                    "bind \\e" SHELL_CURSOR_KEYBINDING " 'commandline -C >&%d';"
+                    "if not functions -q fish_prompt_mc;"
                     "functions -e fish_right_prompt;"
                     "functions -c fish_prompt fish_prompt_mc; end;"
                     "function fish_prompt;"
                     "echo \"$PWD\">&%d; fish_prompt_mc; kill -STOP %%self; end\n",
-                    subshell_pipe[WRITE]);
+                    command_buffer_pipe[WRITE], command_buffer_pipe[WRITE], subshell_pipe[WRITE]);
         break;
 
     default:
@@ -1034,7 +1334,18 @@ init_subshell (void)
                 return;
             }
         }
-        else if (pipe (subshell_pipe))  /* subshell_type is BASH, ASH_BUSYBOX, DASH or ZSH */
+        else if (pipe (subshell_pipe) != 0)     /* subshell_type is BASH, ASH_BUSYBOX, DASH or ZSH */
+        {
+            perror (__FILE__ ": couldn't create pipe");
+            mc_global.tty.use_subshell = FALSE;
+            return;
+        }
+
+        if (mc_global.mc_run_mode == MC_RUN_FULL &&
+            (mc_global.shell->type == SHELL_BASH || mc_global.shell->type == SHELL_ZSH
+             || mc_global.shell->type == SHELL_FISH))
+            use_persistent_buffer = TRUE;
+        if (use_persistent_buffer && pipe (command_buffer_pipe) != 0)
         {
             perror (__FILE__ ": couldn't create pipe");
             mc_global.tty.use_subshell = FALSE;
@@ -1071,12 +1382,17 @@ init_subshell (void)
     subshell_state = RUNNING_COMMAND;
     tty_enable_interrupt_key ();
     if (!feed_subshell (QUIETLY, TRUE))
-    {
         mc_global.tty.use_subshell = FALSE;
-    }
     tty_disable_interrupt_key ();
     if (!subshell_alive)
         mc_global.tty.use_subshell = FALSE;     /* Subshell died instantly, so don't use it */
+
+    /* Try out the persistent command buffer feature. If it doesn't work the first time, we
+     * assume there must be something wrong with the shell, and we turn persistent buffer off
+     * for good. This will save the user the trouble of having to wait for the persistent
+     * buffer function to time out every time they try to close the subshell. */
+    if (use_persistent_buffer && !read_command_line_buffer (TRUE))
+        use_persistent_buffer = FALSE;
 }
 
 /* --------------------------------------------------------------------------------------------- */
@@ -1100,10 +1416,45 @@ invoke_subshell (const char *command, int how, vfs_path_t ** new_dir_vpath)
             /* FIXME: possibly take out this hack; the user can re-play it by hitting C-hyphen a few times! */
             if (subshell_ready && mc_global.mc_run_mode == MC_RUN_FULL)
                 write_all (mc_global.tty.subshell_pty, " \b", 2);       /* Hack to make prompt reappear */
+
+            if (use_persistent_buffer)
+            {
+                size_t i;
+                int pos;
+
+                /* Check to make sure there are no non text characters in the command buffer,
+                 * such as tab, or newline, as this could cause problems. */
+                for (i = 0; cmdline->buffer[i] != '\0'; i++)
+                    if ((unsigned char) cmdline->buffer[i] < 32
+                        || (unsigned char) cmdline->buffer[i] == 127)
+                        cmdline->buffer[i] = ' ';
+
+                /* Write the command buffer to the subshell. */
+                write_all (mc_global.tty.subshell_pty, cmdline->buffer, strlen (cmdline->buffer));
+
+                /* Put the cursor in the correct place in the subshell. */
+                pos = str_length (cmdline->buffer) - cmdline->point;
+                for (i = 0; i < (size_t) pos; i++)
+                    write_all (mc_global.tty.subshell_pty, ESC_STR "[D", 3);
+            }
         }
     }
     else                        /* MC has passed us a user command */
     {
+        /* Before we write to the command prompt, we need to clear whatever */
+        /* data is there, but only if we are using one of the shells that */
+        /* doesn't support keeping command buffer contents, OR if there was */
+        /* some sort of error. */
+        if (!use_persistent_buffer || subshell_should_clear_command_line)
+        {
+            write_all (mc_global.tty.subshell_pty, "\003", 1);
+            subshell_state = RUNNING_COMMAND;
+            /* We need to call feed_subshell here if we are using fish, because of a quirk
+             * in the behavioral of that particular shell. */
+            if (mc_global.shell->type != SHELL_FISH)
+                feed_subshell (QUIETLY, FALSE);
+        }
+
         if (how == QUIETLY)
             write_all (mc_global.tty.subshell_pty, " ", 1);
         /* FIXME: if command is long (>8KB ?) we go comma */
@@ -1131,6 +1482,50 @@ invoke_subshell (const char *command, int how, vfs_path_t ** new_dir_vpath)
     return subshell_get_mainloop_quit ();
 }
 
+/* --------------------------------------------------------------------------------------------- */
+
+gboolean
+flush_subshell (int max_wait_length, int how)
+{
+    int rc = 0;
+    ssize_t bytes = 0;
+    struct timeval timeleft = { 0, 0 };
+    gboolean return_value = FALSE;
+    fd_set tmp;
+
+    timeleft.tv_sec = max_wait_length;
+    FD_ZERO (&tmp);
+    FD_SET (mc_global.tty.subshell_pty, &tmp);
+
+    while (subshell_alive
+           && (rc = select (mc_global.tty.subshell_pty + 1, &tmp, NULL, NULL, &timeleft)) != 0)
+    {
+        /* Check for 'select' errors */
+        if (rc == -1)
+        {
+            if (errno == EINTR)
+            {
+                if (tty_got_winch ())
+                    tty_change_screen_size ();
+
+                continue;
+            }
+
+            fprintf (stderr, "select (FD_SETSIZE, &tmp...): %s\r\n", unix_error_string (errno));
+            exit (EXIT_FAILURE);
+        }
+
+        return_value = TRUE;
+        timeleft.tv_sec = 0;
+        timeleft.tv_usec = 0;
+
+        bytes = read (mc_global.tty.subshell_pty, pty_buffer, sizeof (pty_buffer));
+        if (how == VISIBLY)
+            write_all (STDOUT_FILENO, pty_buffer, bytes);
+    }
+
+    return return_value;
+}
 
 /* --------------------------------------------------------------------------------------------- */
 
@@ -1140,24 +1535,16 @@ read_subshell_prompt (void)
     int rc = 0;
     ssize_t bytes = 0;
     struct timeval timeleft = { 0, 0 };
-    GString *p;
-    gboolean prompt_was_reset = FALSE;
+    gboolean should_reset_prompt = TRUE;
+    gboolean got_new_prompt = FALSE;
 
     fd_set tmp;
     FD_ZERO (&tmp);
     FD_SET (mc_global.tty.subshell_pty, &tmp);
 
-    /* First time through */
-    if (subshell_prompt == NULL)
-        subshell_prompt = g_string_sized_new (INITIAL_PROMPT_SIZE);
-
-    p = g_string_sized_new (INITIAL_PROMPT_SIZE);
-
     while (subshell_alive
            && (rc = select (mc_global.tty.subshell_pty + 1, &tmp, NULL, NULL, &timeleft)) != 0)
     {
-        ssize_t i;
-
         /* Check for 'select' errors */
         if (rc == -1)
         {
@@ -1174,22 +1561,18 @@ read_subshell_prompt (void)
         }
 
         bytes = read (mc_global.tty.subshell_pty, pty_buffer, sizeof (pty_buffer));
+        if (should_reset_prompt)
+        {
+            should_reset_prompt = FALSE;
+            clear_subshell_prompt_string ();
+        }
 
-        /* Extract the prompt from the shell output */
-        for (i = 0; i < bytes; i++)
-            if (pty_buffer[i] == '\n' || pty_buffer[i] == '\r')
-            {
-                g_string_set_size (p, 0);
-                prompt_was_reset = TRUE;
-            }
-            else if (pty_buffer[i] != '\0')
-                g_string_append_c (p, pty_buffer[i]);
+        parse_subshell_prompt_string (pty_buffer, bytes);
+        got_new_prompt = TRUE;
     }
 
-    if (p->len != 0 || prompt_was_reset)
-        g_string_assign (subshell_prompt, p->str);
-
-    g_string_free (p, TRUE);
+    if (got_new_prompt)
+        set_prompt_string ();
 
     return (rc != 0 || bytes != 0);
 }
@@ -1229,8 +1612,18 @@ exit_subshell (void)
                          tcsh_fifo, unix_error_string (errno));
         }
 
-        g_string_free (subshell_prompt, TRUE);
-        subshell_prompt = NULL;
+        if (subshell_prompt != NULL)
+        {
+            g_string_free (subshell_prompt, TRUE);
+            subshell_prompt = NULL;
+        }
+
+        if (subshell_prompt_temp_buffer != NULL)
+        {
+            g_string_free (subshell_prompt_temp_buffer, TRUE);
+            subshell_prompt_temp_buffer = NULL;
+        }
+
         pty_buffer[0] = '\0';
     }
 
@@ -1259,6 +1652,15 @@ do_subshell_chdir (const vfs_path_t * vpath, gboolean update_prompt)
         return;
     }
 
+    /* If we are using a shell that doesn't support persistent command buffer, we need to clear
+     * the command prompt before we send the cd command. */
+    if (!use_persistent_buffer || subshell_should_clear_command_line)
+    {
+        write_all (mc_global.tty.subshell_pty, "\003", 1);
+        subshell_state = RUNNING_COMMAND;
+        if (mc_global.shell->type != SHELL_FISH)
+            feed_subshell (QUIETLY, FALSE);
+    }
     /* The initial space keeps this out of the command history (in bash
        because we set "HISTCONTROL=ignorespace") */
     write_all (mc_global.tty.subshell_pty, " cd ", 4);
diff --git a/src/subshell/subshell.h b/src/subshell/subshell.h
index e0fdfb13e..bde19c469 100644
--- a/src/subshell/subshell.h
+++ b/src/subshell/subshell.h
@@ -36,10 +36,13 @@ extern GString *subshell_prompt;
 
 extern gboolean update_subshell_prompt;
 
+extern gboolean should_read_new_subshell_prompt;
+
 /*** declarations of public functions ************************************************************/
 
 void init_subshell (void);
 int invoke_subshell (const char *command, int how, vfs_path_t ** new_dir);
+gboolean flush_subshell (int max_wait_length, int how);
 gboolean read_subshell_prompt (void);
 void do_update_prompt (void);
 gboolean exit_subshell (void);
diff --git a/src/vfs/extfs/helpers/iso9660.in b/src/vfs/extfs/helpers/iso9660.in
index f9c6e50ef..f1124a5a1 100644
--- a/src/vfs/extfs/helpers/iso9660.in
+++ b/src/vfs/extfs/helpers/iso9660.in
@@ -43,7 +43,7 @@ xorriso_list() {
     r=$?
     test $r -gt 0 && return $r
 
-    echo "$lsl" | @GREP@ "^[-d]" | \
+    echo "$lsl" | grep "^[-d]" | \
     while read attr ln usr gr sz dt1 dt2 dt3 nm ; do
         len=$((${#nm} - 1))
         name=$(printf -- "$nm" | cut -c2-$len)  # remove quotes
@@ -97,11 +97,11 @@ test_iso () {
 
     CHARSET=$(locale charmap 2>/dev/null)
     if test -z "$CHARSET"; then
-        CHARSET=$(locale 2>/dev/null | @GREP@ LC_CTYPE | sed -n -e 's/.*\.\(.*\)"$/\1/p')
+        CHARSET=$(locale 2>/dev/null | grep LC_CTYPE | sed -n -e 's/.*\.\(.*\)"$/\1/p')
     fi
     if test -n "$CHARSET"; then
         CHARSET=$(echo "$CHARSET" | tr '[A-Z]' '[a-z]' | sed -e 's/^iso-/iso/')
-        isoinfo -j $CHARSET -i /dev/null 2>&1 | @GREP@ "Iconv not yet supported\|Unknown charset" >/dev/null && CHARSET=
+        isoinfo -j $CHARSET -i /dev/null 2>&1 | grep "Iconv not yet supported\|Unknown charset" >/dev/null && CHARSET=
     fi
     if test -n "$CHARSET"; then
         JOLIET_OPT="-j $CHARSET -J"
@@ -112,10 +112,10 @@ test_iso () {
 
     ISOINFO_D_I="$(isoinfo -d -i "$1" 2>/dev/null)"
 
-    echo "$ISOINFO_D_I" | @GREP@ "UCS level 1\|NO Joliet" > /dev/null || ISOINFO="$ISOINFO $JOLIET_OPT"
+    echo "$ISOINFO_D_I" | grep "UCS level 1\|NO Joliet" > /dev/null || ISOINFO="$ISOINFO $JOLIET_OPT"
 
-    if [ $(echo "$ISOINFO_D_I" | @GREP@ "Joliet with UCS level 3 found" | wc -l) = 1 \
-        -a $(echo "$ISOINFO_D_I" | @GREP@ "NO Rock Ridge" | wc -l) = 1 ] ; then
+    if [ $(echo "$ISOINFO_D_I" | grep "Joliet with UCS level 3 found" | wc -l) = 1 \
+        -a $(echo "$ISOINFO_D_I" | grep "NO Rock Ridge" | wc -l) = 1 ] ; then
         SEMICOLON="YES"
     fi
 }
diff --git a/src/vfs/smbfs/helpers/include/includes.h b/src/vfs/smbfs/helpers/include/includes.h
index 9cce9309d..b7bb9bce6 100644
--- a/src/vfs/smbfs/helpers/include/includes.h
+++ b/src/vfs/smbfs/helpers/include/includes.h
@@ -189,7 +189,7 @@
 #include <sys/fs/s5param.h>
 #endif
 
-#if defined (HAVE_SYS_FILSYS_H) && !defined (_CRAY)
+#ifdef HAVE_SYS_FILSYS_H
 #include <sys/filsys.h>
 #endif
 
diff --git a/src/viewer/ascii.c b/src/viewer/ascii.c
index 67b653434..e2a3ce934 100644
--- a/src/viewer/ascii.c
+++ b/src/viewer/ascii.c
@@ -162,12 +162,6 @@
 
 /*** file scope macro definitions ****************************************************************/
 
-#if GLIB_CHECK_VERSION (2, 30, 0)
-#define SPACING_MARK G_UNICODE_SPACING_MARK
-#else
-#define SPACING_MARK G_UNICODE_COMBINING_MARK
-#endif
-
 /* The Unicode standard recommends that lonely combining characters are printed over a dotted
  * circle. If the terminal is not UTF-8, this will be replaced by a dot anyway. */
 #define BASE_CHARACTER_FOR_LONELY_COMBINING 0x25CC      /* dotted circle */
@@ -266,7 +260,7 @@ mcview_is_spacing_mark (const WView * view, int c)
 {
 #ifdef HAVE_CHARSET
     if (view->utf8)
-        return g_unichar_type (c) == SPACING_MARK;
+        return g_unichar_type (c) == G_UNICODE_SPACING_MARK;
 #else
     (void) view;
     (void) c;
@@ -535,7 +529,7 @@ mcview_next_combining_char_sequence (WView * view, mcview_state_machine_t * stat
             return i;
         if (!mcview_ismark (view, cs[i]) || !mcview_isprint (view, cs[i]))
             return i;
-        if (g_unichar_type (cs[i]) == SPACING_MARK)
+        if (g_unichar_type (cs[i]) == G_UNICODE_SPACING_MARK)
         {
             /* Only allow as the first combining char. Stop processing in either case. */
             if (i == 1)
