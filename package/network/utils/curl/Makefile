#
# Copyright (C) 2007-2016 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=curl
PKG_VERSION:=7.69.1
PKG_RELEASE:=2

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
PKG_SOURCE_URL:=https://dl.uxnr.de/mirror/curl/ \
	https://curl.mirror.anstey.ca/ \
	https://curl.askapache.com/download/ \
	https://curl.haxx.se/download/
PKG_HASH:=03c7d5e6697f7b7e40ada1b2256e565a555657398e6c1fcfa4cb251ccd819d4f

PKG_LICENSE:=MIT
PKG_LICENSE_FILES:=COPYING
PKG_CPE_ID:=cpe:/a:haxx:libcurl

PKG_CONFIG_DEPENDS:= \
  CONFIG_IPV6 \
  \
  CONFIG_LIBCURL_WOLFSSL \
  CONFIG_LIBCURL_GNUTLS \
  CONFIG_LIBCURL_OPENSSL \
  CONFIG_LIBCURL_MBEDTLS \
  CONFIG_LIBCURL_NOSSL \
  \
  CONFIG_LIBCURL_LIBIDN2 \
  CONFIG_LIBCURL_SSH2 \
  CONFIG_LIBCURL_ZLIB \
  \
  CONFIG_LIBCURL_DICT \
  CONFIG_LIBCURL_FILE \
  CONFIG_LIBCURL_FTP \
  CONFIG_LIBCURL_GOPHER \
  CONFIG_LIBCURL_HTTP \
  CONFIG_LIBCURL_IMAP \
  CONFIG_LIBCURL_LDAP \
  CONFIG_LIBCURL_LDAPS \
  CONFIG_LIBCURL_POP3 \
  CONFIG_LIBCURL_RTSP \
  CONFIG_LIBCURL_NO_RTSP \
  CONFIG_LIBCURL_SMB \
  CONFIG_LIBCURL_NO_SMB \
  CONFIG_LIBCURL_SMTP \
  CONFIG_LIBCURL_TELNET \
  CONFIG_LIBCURL_TFTP \
  CONFIG_LIBCURL_NGHTTP2 \
  \
  CONFIG_LIBCURL_COOKIES \
  CONFIG_LIBCURL_CRYPTO_AUTH \
  CONFIG_LIBCURL_LIBCURL_OPTION \
  CONFIG_LIBCURL_PROXY \
  CONFIG_LIBCURL_THREADED_RESOLVER \
  CONFIG_LIBCURL_TLS_SRP \
  CONFIG_LIBCURL_UNIX_SOCKETS \
  CONFIG_LIBCURL_VERBOSE \
  CONFIG_LIBCURL_NTLM \
  $(if $(CONFIG_LIBCURL_OPENSSL), \
	CONFIG_OPENSSL_ENGINE \
	CONFIG_OPENSSL_WITH_COMPRESSION \
	CONFIG_OPENSSL_WITH_NPN)

include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/cmake.mk

define Package/curl/Default
  SECTION:=net
  CATEGORY:=Network
  URL:=http://curl.haxx.se/
  MAINTAINER:=Imre Kaloz <kaloz@openwrt.org>
endef

define Package/curl
  $(call Package/curl/Default)
  SUBMENU:=File Transfer
  DEPENDS:=+libcurl
  TITLE:=A client-side URL transfer utility
endef

define Package/libcurl
  $(call Package/curl/Default)
  SECTION:=libs
  CATEGORY:=Libraries
  DEPENDS:= +LIBCURL_WOLFSSL:libwolfssl +LIBCURL_OPENSSL:libopenssl +LIBCURL_GNUTLS:libgnutls +LIBCURL_MBEDTLS:libmbedtls
  DEPENDS += +LIBCURL_ZLIB:zlib +LIBCURL_THREADED_RESOLVER:libpthread +LIBCURL_LDAP:libopenldap +LIBCURL_LIBIDN2:libidn2
  DEPENDS += +LIBCURL_SSH2:libssh2 +LIBCURL_NGHTTP2:libnghttp2 +ca-bundle
  TITLE:=A client-side URL transfer library
  MENU:=1
  ABI_VERSION:=4
endef

define Package/libcurl/config
  source "$(SOURCE)/Config.in"
endef

TARGET_CFLAGS += $(FPIC) -ffunction-sections -fdata-sections
TARGET_LDFLAGS += -Wl,--gc-sections

CMAKE_OPTIONS += \
	-DBUILD_CURL_EXE=ON \
	-DBUILD_SHARED_LIBS=ON \
	-DBUILD_TESTING=OFF \
	-DCMAKE_USE_BEARSSL=OFF \
	-DCMAKE_USE_GSSAPI=OFF \
	-DCMAKE_USE_NSS=OFF \
	-DCURL_BROTLI=OFF \
	-DCURL_LTO=ON \
	-DCURL_WERROR=OFF \
	-DENABLE_ARES=OFF \
	-DENABLE_CURLDEBUG=OFF \
	-DENABLE_DEBUG=OFF \
	-DENABLE_MANUAL=OFF \
	-DHAVE_POLL_FINE=ON \
	-DPICKY_COMPILER=OFF \
	-Duse_ntlm=OFF \
	\
	-DENABLE_IPV6=$(if $(CONFIG_LIBCURL_IPV6),ON,OFF) \
	\
	-DCMAKE_USE_WOLFSSL=$(if $(CONFIG_LIBCURL_WOLFSSL),ON,OFF) \
	-DCMAKE_USE_OPENSSL=$(if $(CONFIG_LIBCURL_OPENSSL),ON,OFF) \
	-DCMAKE_USE_MBEDTLS=$(if $(CONFIG_LIBCURL_MBEDTLS),ON,OFF) \
	\
	-DCMAKE_USE_LIBSSH2=$(if $(CONFIG_LIBCURL_LIBSSH2),ON,OFF) \
	-DCURL_ZLIB=$(if $(CONFIG_LIBCURL_ZLIB),ON,OFF) \
	-DUSE_NGHTTP2=$(if $(CONFIG_LIBCURL_NGHTTP2),ON,OFF) \
	\
	-DCURL_DISABLE_DICT=$(if $(CONFIG_LIBCURL_DICT),OFF,ON) \
	-DCURL_DISABLE_FILE=$(if $(CONFIG_LIBCURL_FILE),OFF,ON) \
	-DCURL_DISABLE_FTP=$(if $(CONFIG_LIBCURL_FTP),OFF,ON) \
	-DCURL_DISABLE_GOPHER=$(if $(CONFIG_LIBCURL_GOPHER),OFF,ON) \
	-DCURL_DISABLE_HTTP=$(if $(CONFIG_LIBCURL_HTTP),OFF,ON) \
	-DCURL_DISABLE_IMAP=$(if $(CONFIG_LIBCURL_IMAP),OFF,ON) \
	-DCURL_DISABLE_LDAP=$(if $(CONFIG_LIBCURL_LDAP),OFF,ON) \
	-DCURL_DISABLE_LDAPS=$(if $(CONFIG_LIBCURL_LDAPS),OFF,ON) \
	-DCURL_DISABLE_POP3=$(if $(CONFIG_LIBCURL_POP3),OFF,ON) \
	-DCURL_DISABLE_RTSP=$(if $(CONFIG_LIBCURL_RTSP),OFF,ON) \
	-DCURL_DISABLE_SMB=$(if $(CONFIG_LIBCURL_SMB),OFF,ON) \
	-DCURL_DISABLE_SMTP=$(if $(CONFIG_LIBCURL_SMTP),OFF,ON) \
	-DCURL_DISABLE_TELNET=$(if $(CONFIG_LIBCURL_TELNET),OFF,ON) \
	-DCURL_DISABLE_TFTP=$(if $(CONFIG_LIBCURL_TFTP),OFF,ON) \
	\
	-DCURL_DISABLE_COOKIES=$(if $(CONFIG_LIBCURL_COOKIES),OFF,ON) \
	-DCURL_DISABLE_CRYPTO_AUTH=$(if $(CONFIG_LIBCURL_CRYPTO_AUTH),OFF,ON) \
	-DCURL_DISABLE_PROXY=$(if $(CONFIG_LIBCURL_PROXY),OFF,ON) \
	-DENABLE_THREADED_RESOLVER=$(if $(CONFIG_LIBCURL_THREADED_RESOLVER),ON,OFF) \
	-DUSE_TLS_SRP=$(if $(CONFIG_LIBCURL_TLS_SRP),ON,OFF) \
	-DENABLE_UNIX_SOCKETS=$(if $(CONFIG_LIBCURL_UNIX_SOCKETS),ON,OFF) \
	-DCURL_DISABLE_VERBOSE_STRINGS=$(if $(CONFIG_LIBCURL_VERBOSE),OFF,ON)

define Build/InstallDev
	$(call Build/InstallDev/cmake,$(1))
	$(SED) 's,-L$$$${exec_prefix}/lib,,g' $(1)/usr/bin/curl-config
	[ -n "$(TARGET_LDFLAGS)" ] && $(SED) 's#$(TARGET_LDFLAGS)##g' $(1)/usr/lib/pkgconfig/libcurl.pc || true
endef

define Package/curl/install
	$(INSTALL_DIR) $(1)/usr/bin
	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/curl $(1)/usr/bin/
endef

define Package/libcurl/install
	$(INSTALL_DIR) $(1)/usr/lib
	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libcurl.so* $(1)/usr/lib/
endef

$(eval $(call BuildPackage,curl))
$(eval $(call BuildPackage,libcurl))
